package hudson import java io IOException public class AbortException extends IOException public AbortException public AbortException String message super message private static final long serialVersionUID 1Lpackage com kaku colorfulnews mvp ui activities import android text method LinkMovementMethod import android text util Linkify import android widget TextView import com kaku colorfulnews R import com kaku colorfulnews mvp ui activities base BaseActivity import butterknife BindView public class AboutActivity extends BaseActivity BindView R id msg tv TextView mMsgTv Override public int getLayoutId return R layout activity about Override public void initInjector Override public void initViews mMsgTv setAutoLinkMask Linkify ALL mMsgTv setMovementMethod LinkMovementMethod getInstancepackage hudson import hudson model ManagementLink import java net URL import org jenkinsci Symbol import org kohsuke accmod Restricted import org kohsuke accmod restrictions NoExternalUse Extension Symbol about public class AboutJenkins extends ManagementLink Override public String getIconFileName return help png Override public String getUrlName return about public String getDisplayName return Messages AboutJenkins DisplayName Override public String getDescription return Messages AboutJenkins Description Restricted NoExternalUse class public URL getLicensesURL return AboutJenkins class getResource META INF licenses xmlpackage hudson node monitors import hudson model Computer import hudson remoting Callable import hudson remoting VirtualChannel import jenkins model Jenkins import javax annotation CheckForNull import java io IOException import java util HashMap import java util Map import java util Map Entry import java util concurrent ExecutionException import java util concurrent Future import java util concurrent TimeoutException import java util logging Logger import static java util concurrent TimeUnit MILLISECONDS import static java util logging Level WARNING public abstract class AbstractAsyncNodeMonitorDescriptor T extends AbstractNodeMonitorDescriptor T protected AbstractAsyncNodeMonitorDescriptor protected AbstractAsyncNodeMonitorDescriptor long interval super interval protected AbstractAsyncNodeMonitorDescriptor Class extends NodeMonitor clazz super clazz protected AbstractAsyncNodeMonitorDescriptor Class extends NodeMonitor clazz long interval super clazz interval protected abstract CheckForNull Callable T IOException createCallable Computer c Override protected T monitor Computer c throws IOException InterruptedException VirtualChannel ch c getChannel if ch null Callable T IOException cc createCallable c if cc null return ch call cc return null Override protected Map Computer T monitor throws InterruptedException Map Computer Future T futures new HashMap Computer Future T for Computer c Jenkins getInstance getComputers try VirtualChannel ch c getChannel futures put c null sentinel value if ch null Callable T cc createCallable c if cc null futures put c ch callAsync cc catch RuntimeException e LOGGER log WARNING Failed to monitor c getDisplayName for getDisplayName e catch IOException e LOGGER log WARNING Failed to monitor c getDisplayName for getDisplayName e final long now System currentTimeMillis final long end now getMonitoringTimeOut final Map Computer T data new HashMap Computer T for Entry Computer Future T e futures entrySet Computer c e getKey Future T f futures get c data put c null sentinel value if f null try data put c f get Math max 0 end System currentTimeMillis MILLISECONDS catch RuntimeException x LOGGER log WARNING Failed to monitor c getDisplayName for getDisplayName x catch ExecutionException x LOGGER log WARNING Failed to monitor c getDisplayName for getDisplayName x catch TimeoutException x LOGGER log WARNING Failed to monitor c getDisplayName for getDisplayName x return data private static final Logger LOGGER Logger getLogger AbstractAsyncNodeMonitorDescriptor class getNamepackage hudson model import com google common collect ImmutableList import com google common collect ImmutableSortedSet import hudson AbortException import hudson EnvVars import hudson FilePath import hudson Functions import hudson Launcher import jenkins util SystemProperties import hudson console ModelHyperlinkNote import hudson model Fingerprint BuildPtr import hudson model Fingerprint RangeSet import hudson model labels LabelAtom import hudson model listeners RunListener import hudson model listeners SCMListener import hudson remoting ChannelClosedException import hudson remoting RequestAbortedException import hudson scm ChangeLogParser import hudson scm ChangeLogSet import hudson scm ChangeLogSet Entry import hudson scm NullChangeLogParser import hudson scm SCM import hudson scm SCMRevisionState import hudson slaves NodeProperty import hudson slaves WorkspaceList import hudson slaves WorkspaceList Lease import hudson slaves OfflineCause import hudson tasks BuildStep import hudson tasks BuildStepMonitor import hudson tasks BuildTrigger import hudson tasks BuildWrapper import hudson tasks Builder import hudson tasks Fingerprinter FingerprintAction import hudson tasks Publisher import hudson util import jenkins model Jenkins import org kohsuke stapler HttpResponse import org kohsuke stapler Stapler import org kohsuke stapler StaplerRequest import org kohsuke stapler StaplerResponse import org kohsuke stapler export Exported import org xml sax SAXException import javax servlet ServletException import java io File import java io IOException import java io InterruptedIOException import java lang ref WeakReference import java util AbstractSet import java util ArrayList import java util Calendar import java util Collection import java util Collections import java util HashMap import java util HashSet import java util Iterator import java util List import java util Map import java util Set import java util logging Level import java util logging Logger import javax annotation CheckForNull import javax annotation Nonnull import org kohsuke stapler interceptor RequirePOST import static java util logging Level WARNING import jenkins model lazy BuildReference import jenkins model lazy LazyBuildMixIn import org kohsuke accmod Restricted import org kohsuke accmod restrictions DoNotUse public abstract class AbstractBuild P extends AbstractProject P R R extends AbstractBuild P R extends Run P R implements Queue Executable LazyBuildMixIn LazyLoadingRun P R private static final boolean upstreamCulprits SystemProperties getBoolean hudson upstreamCulprits private String builtOn private String workspace private String hudsonVersion private ChangeLogParser scm private volatile transient WeakReference ChangeLogSet extends Entry changeSet private volatile Set String culprits protected transient List Environment buildEnvironments private transient final LazyBuildMixIn RunMixIn P R runMixIn new LazyBuildMixIn RunMixIn P R Override protected R asRun return this protected AbstractBuild P job throws IOException super job protected AbstractBuild P job Calendar timestamp super job timestamp protected AbstractBuild P project File buildDir throws IOException super project buildDir public final P getProject return getParent Override public final LazyBuildMixIn RunMixIn P R getRunMixIn return runMixIn Override protected final BuildReference R createReference return getRunMixIn createReference Override protected final void dropLinks getRunMixIn dropLinks Override public R getPreviousBuild return getRunMixIn getPreviousBuild Override public R getNextBuild return getRunMixIn getNextBuild public CheckForNull Node getBuiltOn if builtOn null builtOn equals return Jenkins getInstance else return Jenkins getInstance getNode builtOn Exported name builtOn public String getBuiltOnStr return builtOn protected void setBuiltOnStr String builtOn this builtOn builtOn public AbstractBuild getRootBuild return this public String getUpUrl return Functions getNearestAncestorUrl Stapler getCurrentRequest getParent public final CheckForNull FilePath getWorkspace if workspace null return null Node n getBuiltOn if n null return null return n createPath workspace protected void setWorkspace Nonnull FilePath ws this workspace ws getRemote public final FilePath getModuleRoot FilePath ws getWorkspace if ws null return null return getParent getScm getModuleRoot ws this public FilePath getModuleRoots FilePath ws getWorkspace if ws null return null return getParent getScm getModuleRoots ws this Exported public Set User getCulprits if culprits null Set User r new HashSet User R p getPreviousCompletedBuild if p null isBuilding Result pr p getResult if pr null pr isWorseThan Result SUCCESS we are still building so this is just the current latest information but we seems to be failing so far so inherit culprits from the previous build isBuilding check is to avoid recursion when loading data from old Hudson which doesn t record this information r addAll p getCulprits for Entry e getChangeSet r add e getAuthor if upstreamCulprits If we have dependencies since the last successful build add their authors to our list if getPreviousNotFailedBuild null Map AbstractProject DependencyChange depmap getDependencyChanges getPreviousSuccessfulBuild for DependencyChange dep depmap values for AbstractBuild b dep getBuilds for Entry entry b getChangeSet r add entry getAuthor return r return new AbstractSet User public Iterator User iterator return new AdaptedIterator String User culprits iterator protected User adapt String id return User get id public int size return culprits size public boolean hasParticipant User user for ChangeLogSet Entry e getChangeSet try if e getAuthor user return true catch RuntimeException re LOGGER log Level INFO Failed to determine author of changelog e getCommitId for getParent getDisplayName getDisplayName re return false public String getHudsonVersion return hudsonVersion Deprecated public abstract class AbstractRunner extends AbstractBuildExecution public abstract class AbstractBuildExecution extends Runner protected Launcher launcher protected BuildListener listener private Lease lease protected final Nonnull Node getCurrentNode throws IllegalStateException Executor exec Executor currentExecutor if exec null throw new IllegalStateException not being called from an executor thread Computer c exec getOwner Node node c getNode if node null throw new IllegalStateException no longer a configured node for c getName return node public Launcher getLauncher return launcher public BuildListener getListener return listener protected Lease decideWorkspace Nonnull Node n WorkspaceList wsl throws InterruptedException IOException String customWorkspace getProject getCustomWorkspace if customWorkspace null we allow custom workspaces to be concurrently used between jobs return Lease createDummyLease n getRootPath child getEnvironment listener expand customWorkspace TODO this cast is indicative of abstraction problem return wsl allocate n getWorkspaceFor TopLevelItem getProject getBuild public Result run Nonnull BuildListener listener throws Exception final Node node getCurrentNode assert builtOn null builtOn node getNodeName hudsonVersion Jenkins VERSION this listener listener launcher createLauncher listener if Jenkins getInstance getNodes isEmpty if node instanceof Jenkins listener getLogger print Messages AbstractBuild BuildingOnMaster else listener getLogger print Messages AbstractBuild BuildingRemotely ModelHyperlinkNote encodeTo computer builtOn builtOn Set LabelAtom assignedLabels new HashSet LabelAtom node getAssignedLabels assignedLabels remove node getSelfLabel if assignedLabels isEmpty boolean first true for LabelAtom label assignedLabels if first listener getLogger print first false else listener getLogger print listener getLogger print label getName listener getLogger print else listener getLogger print Messages AbstractBuild Building lease decideWorkspace node Computer currentComputer getWorkspaceList workspace lease path getRemote listener getLogger println Messages AbstractBuild BuildingInWorkspace workspace node getFileSystemProvisioner prepareWorkspace AbstractBuild this lease path listener for WorkspaceListener wl WorkspaceListener all wl beforeUse AbstractBuild this lease path listener getProject getScmCheckoutStrategy preCheckout AbstractBuild this launcher this listener getProject getScmCheckoutStrategy checkout this if preBuild listener project getProperties return Result FAILURE Result result doRun listener if node getChannel null kill run away processes that are left use multiple environment variables so that people can escape this massacre by overriding an environment variable for some processes launcher kill getCharacteristicEnvVars this is ugly but for historical reason if non null value is returned it should become the final result if result null result getResult if result null result Result SUCCESS return result Nonnull protected Launcher createLauncher Nonnull BuildListener listener throws IOException InterruptedException final Node currentNode getCurrentNode Launcher l currentNode createLauncher listener if project instanceof BuildableItemWithBuildWrappers BuildableItemWithBuildWrappers biwbw BuildableItemWithBuildWrappers project for BuildWrapper bw biwbw getBuildWrappersList l bw decorateLauncher AbstractBuild this l listener buildEnvironments new ArrayList Environment for RunListener rl RunListener all Environment environment rl setUpEnvironment AbstractBuild this l listener if environment null buildEnvironments add environment for NodeProperty nodeProperty Jenkins getInstance getGlobalNodeProperties Environment environment nodeProperty setUp AbstractBuild this l listener if environment null buildEnvironments add environment for NodeProperty nodeProperty currentNode getNodeProperties Environment environment nodeProperty setUp AbstractBuild this l listener if environment null buildEnvironments add environment return l public void defaultCheckout throws IOException InterruptedException AbstractBuild build AbstractBuild this AbstractProject project build getProject for int retryCount project getScmCheckoutRetryCount retryCount build scm NullChangeLogParser INSTANCE try File changeLogFile new File build getRootDir changelog xml if project checkout build launcher listener changeLogFile check out succeeded SCM scm project getScm for SCMListener l SCMListener all try l onCheckout build scm build getWorkspace listener changeLogFile build getAction SCMRevisionState class catch Exception e throw new IOException e build scm scm createChangeLogParser build changeSet new WeakReference ChangeLogSet extends Entry build calcChangeSet for SCMListener l SCMListener all try l onChangeLogParsed build listener build getChangeSet catch Exception e throw new IOException Failed to parse changelog e Get a chance to do something after checkout and changelog is done scm postCheckout build launcher build getWorkspace listener return catch AbortException e listener error e getMessage catch InterruptedIOException e throw InterruptedException new InterruptedException initCause e catch IOException e checkout error not yet reported e printStackTrace listener getLogger if retryCount 0 all attempts failed throw new RunnerAbortedException listener getLogger println Retrying after 10 seconds Thread sleep 10000 protected abstract Result doRun BuildListener listener throws Exception RunnerAbortedException protected abstract void post2 BuildListener listener throws Exception public final void post BuildListener listener throws Exception try post2 listener finally update the culprit list HashSet String r new HashSet String for User u getCulprits r add u getId culprits ImmutableSortedSet copyOf r CheckPoint CULPRITS DETERMINED report public void cleanUp BuildListener listener throws Exception if lease null lease release lease null BuildTrigger execute AbstractBuild this listener buildEnvironments null Deprecated protected final void performAllBuildStep BuildListener listener Map extends BuildStep buildSteps boolean phase throws InterruptedException IOException performAllBuildSteps listener buildSteps values phase protected final boolean performAllBuildSteps BuildListener listener Map extends BuildStep buildSteps boolean phase throws InterruptedException IOException return performAllBuildSteps listener buildSteps values phase Deprecated protected final void performAllBuildStep BuildListener listener Iterable extends BuildStep buildSteps boolean phase throws InterruptedException IOException performAllBuildSteps listener buildSteps phase protected final boolean performAllBuildSteps BuildListener listener Iterable extends BuildStep buildSteps boolean phase throws InterruptedException IOException boolean r true for BuildStep bs buildSteps if bs instanceof Publisher Publisher bs needsToRunAfterFinalized phase try if perform bs listener LOGGER log Level FINE 0 1 failed new Object AbstractBuild this bs r false if phase setResult Result FAILURE catch Exception e reportError bs e listener phase r false catch LinkageError e reportError bs e listener phase r false return r private void reportError BuildStep bs Throwable e BuildListener listener boolean phase final String buildStep if bs instanceof Describable buildStep Describable bs getDescriptor getDisplayName else buildStep bs getClass getName if e instanceof AbortException LOGGER log Level FINE 0 1 failed new Object AbstractBuild this buildStep listener error Step buildStep failed e getMessage else String msg Step buildStep aborted due to exception e printStackTrace listener error msg LOGGER log WARNING msg e if phase setResult Result FAILURE protected final boolean perform BuildStep bs BuildListener listener throws InterruptedException IOException BuildStepMonitor mon try mon bs getRequiredMonitorService catch AbstractMethodError e mon BuildStepMonitor BUILD Result oldResult AbstractBuild this getResult for BuildStepListener bsl BuildStepListener all bsl started AbstractBuild this bs listener boolean canContinue false try canContinue mon perform bs AbstractBuild this launcher listener catch RequestAbortedException ex Channel is closed do not continue reportBrokenChannel listener catch ChannelClosedException ex Channel is closed do not continue reportBrokenChannel listener catch RuntimeException ex ex printStackTrace listener error Build step failed with exception for BuildStepListener bsl BuildStepListener all bsl finished AbstractBuild this bs listener canContinue Result newResult AbstractBuild this getResult if newResult oldResult String buildStepName getBuildStepName bs listener getLogger format Build step s changed build result to s n buildStepName newResult if canContinue String buildStepName getBuildStepName bs listener getLogger format Build step s marked build as failure n buildStepName return canContinue private void reportBrokenChannel BuildListener listener throws IOException final Node node getCurrentNode listener hyperlink node toComputer getUrl log Agent went offline during the build listener getLogger println final OfflineCause offlineCause node toComputer getOfflineCause if offlineCause null listener error offlineCause toString private String getBuildStepName BuildStep bs if bs instanceof Describable return Describable bs getDescriptor getDisplayName else return bs getClass getSimpleName protected final boolean preBuild BuildListener listener Map extends BuildStep steps return preBuild listener steps values protected final boolean preBuild BuildListener listener Collection extends BuildStep steps return preBuild listener Iterable extends BuildStep steps protected final boolean preBuild BuildListener listener Iterable extends BuildStep steps for BuildStep bs steps if bs prebuild AbstractBuild this listener LOGGER log Level FINE 0 1 failed new Object AbstractBuild this bs return false return true Exported name fingerprint inline true visibility 1 public Collection Fingerprint getBuildFingerprints FingerprintAction fingerprintAction getAction FingerprintAction class if fingerprintAction null return fingerprintAction getFingerprints values return Collections Fingerprint emptyList private transient Object changeSetLock new Object Exported public ChangeLogSet extends Entry getChangeSet synchronized changeSetLock if scm null scm NullChangeLogParser INSTANCE ChangeLogSet extends Entry cs null if changeSet null cs changeSet get if cs null cs calcChangeSet defensive check if the calculation fails such as through an exception set a dummy value so that it ll work the next time the exception will be still reported giving the plugin developer an opportunity to fix it if cs null cs ChangeLogSet createEmpty this changeSet new WeakReference ChangeLogSet extends Entry cs return cs Restricted DoNotUse class for project changes jelly public List ChangeLogSet extends ChangeLogSet Entry getChangeSets ChangeLogSet extends Entry cs getChangeSet return cs isEmptySet Collections ChangeLogSet extends ChangeLogSet Entry emptyList Collections ChangeLogSet extends ChangeLogSet Entry singletonList cs public boolean hasChangeSetComputed File changelogFile new File getRootDir changelog xml return changelogFile exists private ChangeLogSet extends Entry calcChangeSet File changelogFile new File getRootDir changelog xml if changelogFile exists return ChangeLogSet createEmpty this try return scm parse this changelogFile catch IOException e LOGGER log WARNING Failed to parse changelogFile e catch SAXException e LOGGER log WARNING Failed to parse changelogFile e return ChangeLogSet createEmpty this Override public EnvVars getEnvironment TaskListener log throws IOException InterruptedException EnvVars env super getEnvironment log FilePath ws getWorkspace if ws null if this is done very early on in the build workspace may not be decided yet see HUDSON 3997 env put WORKSPACE ws getRemote project getScm buildEnvVars this env if buildEnvironments null for Environment e buildEnvironments e buildEnvVars env for EnvironmentContributingAction a getActions EnvironmentContributingAction class a buildEnvVars this env EnvVars resolve env return env public EnvironmentList getEnvironments Executor e Executor currentExecutor if e null e getCurrentExecutable this if buildEnvironments null buildEnvironments new ArrayList Environment return new EnvironmentList buildEnvironments return new EnvironmentList buildEnvironments null Collections Environment emptyList ImmutableList copyOf buildEnvironments public Calendar due return getTimestamp Override public void addAction Action a super addAction a SuppressWarnings deprecation public List Action getPersistentActions return super getActions public Set String getSensitiveBuildVariables Set String s new HashSet String ParametersAction parameters getAction ParametersAction class if parameters null for ParameterValue p parameters if p isSensitive s add p getName Allow BuildWrappers to determine if any of their data is sensitive if project instanceof BuildableItemWithBuildWrappers for BuildWrapper bw BuildableItemWithBuildWrappers project getBuildWrappersList bw makeSensitiveBuildVariables this s return s public Map String String getBuildVariables Map String String r new HashMap String String ParametersAction parameters getAction ParametersAction class if parameters null this is a rather round about way of doing this for ParameterValue p parameters String v p createVariableResolver this resolve p getName if v null r put p getName v allow the BuildWrappers to contribute additional build variables if project instanceof BuildableItemWithBuildWrappers for BuildWrapper bw BuildableItemWithBuildWrappers project getBuildWrappersList bw makeBuildVariables this r for BuildVariableContributor bvc BuildVariableContributor all bvc buildVariablesFor this r return r public final VariableResolver String getBuildVariableResolver return new VariableResolver ByMap String getBuildVariables Deprecated public Action getTestResultAction try return getAction Jenkins getInstance getPluginManager uberClassLoader loadClass hudson tasks test AbstractTestResultAction asSubclass Action class catch ClassNotFoundException x return null Deprecated public Action getAggregatedTestResultAction try return getAction Jenkins getInstance getPluginManager uberClassLoader loadClass hudson tasks test AggregatedTestResultAction asSubclass Action class catch ClassNotFoundException x return null public abstract void run fingerprint related stuff Override public String getWhyKeepLog if any of the downstream project is configured with keep dependency component we need to keep this log OUTER for AbstractProject p getParent getDownstreamProjects if p isKeepDependencies continue AbstractBuild fb p getFirstBuild if fb null continue no active record is there any active build that depends on us for int i getDownstreamRelationship p listNumbersReverse TODO this is essentially a find intersection between two sparse sequences and we should be able to do much better if i fb getNumber continue OUTER all the other records are younger than the first record so pointless to search AbstractBuild b p getBuildByNumber i if b null return Messages AbstractBuild KeptBecause b return super getWhyKeepLog public RangeSet getDownstreamRelationship AbstractProject that RangeSet rs new RangeSet FingerprintAction f getAction FingerprintAction class if f null return rs look for fingerprints that point to this build as the source and merge them all for Fingerprint e f getFingerprints values if upstreamCulprits With upstreamCulprits we allow downstream relationships from intermediate jobs rs add e getRangeSet that else BuildPtr o e getOriginal if o null o is this rs add e getRangeSet that return rs public Iterable AbstractBuild getDownstreamBuilds final AbstractProject that final Iterable Integer nums getDownstreamRelationship that listNumbers return new Iterable AbstractBuild public Iterator AbstractBuild iterator return Iterators removeNull new AdaptedIterator Integer AbstractBuild nums protected AbstractBuild adapt Integer item return that getBuildByNumber item public int getUpstreamRelationship AbstractProject that FingerprintAction f getAction FingerprintAction class if f null return 1 int n 1 look for fingerprints that point to the given project as the source and merge them all for Fingerprint e f getFingerprints values if upstreamCulprits With upstreamCulprits we allow upstream relationships from intermediate jobs Fingerprint RangeSet rangeset e getRangeSet that if rangeset isEmpty n Math max n rangeset listNumbersReverse iterator next else BuildPtr o e getOriginal if o null o belongsTo that n Math max n o getNumber return n public AbstractBuild getUpstreamRelationshipBuild AbstractProject that int n getUpstreamRelationship that if n 1 return null return that getBuildByNumber n public Map AbstractProject RangeSet getDownstreamBuilds Map AbstractProject RangeSet r new HashMap AbstractProject RangeSet for AbstractProject p getParent getDownstreamProjects if p isFingerprintConfigured r put p getDownstreamRelationship p return r public Map AbstractProject Integer getUpstreamBuilds return getUpstreamBuilds getParent getUpstreamProjects public Map AbstractProject Integer getTransitiveUpstreamBuilds return getUpstreamBuilds getParent getTransitiveUpstreamProjects private Map AbstractProject Integer getUpstreamBuilds Collection AbstractProject projects Map AbstractProject Integer r new HashMap AbstractProject Integer for AbstractProject p projects int n getUpstreamRelationship p if n 0 r put p n return r public Map AbstractProject DependencyChange getDependencyChanges AbstractBuild from if from null return Collections emptyMap make it easy to call this from views FingerprintAction n this getAction FingerprintAction class FingerprintAction o from getAction FingerprintAction class if n null o null return Collections emptyMap Map AbstractProject Integer ndep n getDependencies true Map AbstractProject Integer odep o getDependencies true Map AbstractProject DependencyChange r new HashMap AbstractProject DependencyChange for Map Entry AbstractProject Integer entry odep entrySet AbstractProject p entry getKey Integer oldNumber entry getValue Integer newNumber ndep get p if newNumber null oldNumber compareTo newNumber 0 r put p new DependencyChange p oldNumber newNumber return r public static final class DependencyChange public final AbstractProject project public final int fromId public final AbstractBuild from public final int toId public final AbstractBuild to public DependencyChange AbstractProject project int fromId int toId this project project this fromId fromId this toId toId this from project getBuildByNumber fromId this to project getBuildByNumber toId public List AbstractBuild getBuilds List AbstractBuild r new ArrayList AbstractBuild AbstractBuild b project getNearestBuild fromId if b null b getNumber fromId b b getNextBuild fromId exclusive while b null b getNumber toId r add b b b getNextBuild return r web methods Deprecated public void doStop StaplerRequest req StaplerResponse rsp throws IOException ServletException doStop generateResponse req rsp this RequirePOST public synchronized HttpResponse doStop throws IOException ServletException Executor e getExecutor if e null e getOneOffExecutor if e null return e doStop else nothing is building return HttpResponses forwardToPreviousPage private static final Logger LOGGER Logger getLogger AbstractBuild class getNamepackage hudson cli import hudson model AbstractBuild import hudson model AbstractProject import hudson model Fingerprint RangeSet import org kohsuke args4j Argument import java io IOException import java util List public abstract class AbstractBuildRangeCommand extends CLICommand Argument metaVar JOB usage Name of the job to build required true index 0 public AbstractProject job Argument metaVar RANGE usage Range of the build records to delete N M N M or N required true index 1 public String range protected int run throws Exception RangeSet rs RangeSet fromString range false return act List job getBuilds rs protected abstract int act List AbstractBuild builds throws IOExceptionpackage hudson model import hudson security AccessControlled import hudson slaves ComputerListener import hudson slaves RetentionStrategy import jenkins model Jenkins import org kohsuke stapler StaplerFallback import org kohsuke stapler StaplerProxy import java util import java util concurrent CopyOnWriteArraySet import java util logging Logger import javax annotation CheckForNull import jenkins model Configuration public abstract class AbstractCIBase extends Node implements ItemGroup TopLevelItem StaplerProxy StaplerFallback ViewGroup AccessControlled DescriptorByNameOwner public static boolean LOG STARTUP PERFORMANCE Configuration getBooleanConfigParameter logStartupPerformance false private static final Logger LOGGER Logger getLogger AbstractCIBase class getName Deprecated Override public String getNodeName return Deprecated public String getUrl return protected void resetLabel Label l l reset protected void setViewOwner View v v owner this protected void interruptReloadThread ViewJob interruptReloadThread protected void killComputer Computer c c kill final CopyOnWriteArraySet String disabledAdministrativeMonitors new CopyOnWriteArraySet String public abstract List Node getNodes public abstract Queue getQueue protected abstract Map Node Computer getComputerMap private void updateComputer Node n Map String Computer byNameMap Set Computer used boolean automaticSlaveLaunch Map Node Computer computers getComputerMap Computer c c byNameMap get n getNodeName if c null c setNode n reuse else we always need Computer for the master as a fallback in case there s no other Computer if n getNumExecutors 0 n Jenkins getInstance computers put n c n createComputer if n isHoldOffLaunchUntilSave automaticSlaveLaunch RetentionStrategy retentionStrategy c getRetentionStrategy if retentionStrategy null if there is a retention strategy it is responsible for deciding to start the computer retentionStrategy start c else we should never get here but just in case we ll fall back to the legacy behaviour c connect true used add c void removeComputer final Computer computer Queue withLock new Runnable Override public void run Map Node Computer computers getComputerMap for Map Entry Node Computer e computers entrySet if e getValue computer computers remove e getKey computer onRemoved return CheckForNull Computer getComputer Node n Map Node Computer computers getComputerMap return computers get n protected void updateComputerList final boolean automaticSlaveLaunch final Map Node Computer computers getComputerMap final Set Computer old new HashSet Computer computers size Queue withLock new Runnable Override public void run Map String Computer byName new HashMap String Computer for Computer c computers values old add c Node node c getNode if node null continue this computer is gone byName put node getNodeName c Set Computer used new HashSet Computer old size updateComputer AbstractCIBase this byName used automaticSlaveLaunch for Node s getNodes long start System currentTimeMillis updateComputer s byName used automaticSlaveLaunch if LOG STARTUP PERFORMANCE LOGGER info String format Took dms to update node s System currentTimeMillis start s getNodeName find out what computers are removed and kill off all executors when all executors exit it will be removed from the computers map so don t remove too quickly old removeAll used we need to start the process of reducing the executors on all computers as distinct from the killing action which should not excessively use the Queue lock for Computer c old c inflictMortalWound for Computer c old when we get to here the number of executors should be zero so this call should not need the Queue lock killComputer c getQueue scheduleMaintenance for ComputerListener cl ComputerListener all cl onConfigurationChangepackage hudson slaves import hudson model Computer import org kohsuke stapler HttpRedirect import org kohsuke stapler HttpResponse import org kohsuke stapler HttpResponses import java io IOException import javax annotation CheckForNull public class AbstractCloudComputer T extends AbstractCloudSlave extends SlaveComputer public AbstractCloudComputer T slave super slave CheckForNull Override public T getNode return T super getNode Override public HttpResponse doDoDelete throws IOException checkPermission DELETE try T node getNode if node null No need to terminate nodes again node terminate return new HttpRedirect catch InterruptedException e return HttpResponses error 500 epackage hudson slaves public abstract class AbstractCloudImpl extends Cloud private int instanceCap protected AbstractCloudImpl String name String instanceCapStr super name setInstanceCapStr instanceCapStr protected void setInstanceCapStr String value if value null value equals this instanceCap Integer MAX VALUE else this instanceCap Integer parseInt value public String getInstanceCapStr if instanceCap Integer MAX VALUE return else return String valueOf instanceCap public int getInstanceCap return instanceCap protected void setInstanceCap int v this instanceCap vpackage hudson slaves import hudson model Computer import hudson model Descriptor FormException import jenkins model Jenkins import hudson model Slave import hudson model TaskListener import hudson util StreamTaskListener import java io IOException import java nio charset Charset import java util List import java util logging Level import java util logging Logger public abstract class AbstractCloudSlave extends Slave public AbstractCloudSlave String name String nodeDescription String remoteFS String numExecutors Mode mode String labelString ComputerLauncher launcher RetentionStrategy retentionStrategy List extends NodeProperty nodeProperties throws FormException IOException super name nodeDescription remoteFS numExecutors mode labelString launcher retentionStrategy nodeProperties public AbstractCloudSlave String name String nodeDescription String remoteFS int numExecutors Mode mode String labelString ComputerLauncher launcher RetentionStrategy retentionStrategy List extends NodeProperty nodeProperties throws FormException IOException super name nodeDescription remoteFS numExecutors mode labelString launcher retentionStrategy nodeProperties Override public abstract AbstractCloudComputer createComputer public void terminate throws InterruptedException IOException final Computer computer toComputer if computer null computer recordTermination try TODO send the output to somewhere real terminate new StreamTaskListener System out Charset defaultCharset finally try Jenkins getInstance removeNode this catch IOException e LOGGER log Level WARNING Failed to remove name e protected abstract void terminate TaskListener listener throws IOException InterruptedException private static final Logger LOGGER Logger getLogger AbstractCloudSlave class getNamepackage hudson tools import hudson FilePath import hudson model Node import hudson model TaskListener import hudson util FormValidation import java io IOException import org kohsuke stapler QueryParameter public abstract class AbstractCommandInstaller extends ToolInstaller private final String command private final String toolHome public AbstractCommandInstaller String label String command String toolHome super label this command command this toolHome toolHome public String getCommand return command public String getToolHome return toolHome public abstract String getCommandFileExtension public abstract String getCommandCall FilePath script Override public FilePath performInstallation ToolInstallation tool Node node TaskListener log throws IOException InterruptedException FilePath dir preferredLocation tool node TODO support Unix scripts with interpreter line see Shell buildCommandLine FilePath script dir createTextTempFile hudson getCommandFileExtension command try String cmd getCommandCall script int r node createLauncher log launch cmds cmd stdout log pwd dir join if r 0 throw new IOException Command returned status r finally script delete return dir child getToolHome public static abstract class Descriptor TInstallerClass extends AbstractCommandInstaller extends ToolInstallerDescriptor TInstallerClass public FormValidation doCheckCommand QueryParameter String value if value length 0 return FormValidation ok else return FormValidation error Messages CommandInstaller no command public FormValidation doCheckToolHome QueryParameter String value if value length 0 return FormValidation ok else return FormValidation error Messages CommandInstaller no commandpackage hudson model import hudson Extension import jenkins model Jenkins public abstract class AbstractDescribableImpl T extends AbstractDescribableImpl T implements Describable T Override public Descriptor T getDescriptor return Jenkins getInstance getDescriptorOrDie getClasspackage hudson node monitors import hudson model Computer import hudson node monitors DiskSpaceMonitorDescriptor DiskSpace import org kohsuke accmod Restricted import org kohsuke accmod restrictions NoExternalUse import java text ParseException import java util logging Logger public abstract class AbstractDiskSpaceMonitor extends NodeMonitor public final String freeSpaceThreshold public AbstractDiskSpaceMonitor String threshold throws ParseException this freeSpaceThreshold threshold DiskSpace parse threshold make sure it parses public AbstractDiskSpaceMonitor this freeSpaceThreshold 1GB public long getThresholdBytes if freeSpaceThreshold null return DEFAULT THRESHOLD backward compatibility with the data format that didn t have freeSpaceThreshold try return DiskSpace parse freeSpaceThreshold size catch ParseException e return DEFAULT THRESHOLD Override public Object data Computer c DiskSpace size markNodeOfflineIfDiskspaceIsTooLow c mark online again if free space is over threshold if size null size size getThresholdBytes c isOffline c getOfflineCause instanceof DiskSpace if this getClass equals DiskSpace c getOfflineCause getTrigger if getDescriptor markOnline c LOGGER warning Messages DiskSpaceMonitor MarkedOnline c getName return size Restricted NoExternalUse class public DiskSpace markNodeOfflineIfDiskspaceIsTooLow Computer c DiskSpace size DiskSpace super data c if size null size size getThresholdBytes size setTriggered this getClass true if getDescriptor markOffline c size LOGGER warning Messages DiskSpaceMonitor MarkedOffline c getName return size private static final Logger LOGGER Logger getLogger AbstractDiskSpaceMonitor class getName private static final long DEFAULT THRESHOLD 1024L 1024 1024package hudson model import com infradna tool bridge method injector WithBridgeMethods import hudson AbortException import hudson XmlFile import hudson Util import hudson Functions import hudson BulkChange import hudson cli declarative CLIResolver import hudson model listeners ItemListener import hudson model listeners SaveableListener import hudson security AccessControlled import hudson security Permission import hudson security ACL import hudson util AlternativeUiTextProvider import hudson util AlternativeUiTextProvider Message import hudson util AtomicFileWriter import hudson util IOUtils import hudson util Secret import jenkins model DirectlyModifiableTopLevelItemGroup import jenkins model Jenkins import jenkins security NotReallyRoleSensitiveCallable import org acegisecurity Authentication import jenkins util xml XMLUtils import org apache tools ant taskdefs Copy import org apache tools ant types FileSet import org kohsuke stapler WebMethod import org kohsuke stapler export Exported import org kohsuke stapler export ExportedBean import java io File import java io IOException import java io OutputStream import java util Collection import java util List import java util ListIterator import java util logging Level import java util logging Logger import java util regex Matcher import java util regex Pattern import javax annotation Nonnull import org kohsuke stapler StaplerRequest import org kohsuke stapler StaplerResponse import org kohsuke stapler Stapler import org kohsuke stapler HttpDeletable import org kohsuke args4j Argument import org kohsuke args4j CmdLineException import org kohsuke stapler interceptor RequirePOST import org xml sax SAXException import javax servlet ServletException import javax servlet ServletOutputStream import javax xml transform Source import javax xml transform TransformerException import javax xml transform stream StreamResult import javax xml transform stream StreamSource import static javax servlet http HttpServletResponse SC BAD REQUEST import org apache commons io FileUtils import org kohsuke accmod Restricted import org kohsuke accmod restrictions NoExternalUse import org kohsuke stapler Ancestor Item doesn t necessarily have to be Actionable but Java doesn t let multiple inheritance ExportedBean public abstract class AbstractItem extends Actionable implements Item HttpDeletable AccessControlled DescriptorByNameOwner private static final Logger LOGGER Logger getLogger AbstractItem class getName protected transient String name protected volatile String description private transient ItemGroup parent protected String displayName protected AbstractItem ItemGroup parent String name this parent parent doSetName name public void onCreatedFromScratch noop Exported visibility 999 public String getName return name public String getPronoun return AlternativeUiTextProvider get PRONOUN this Messages AbstractItem Pronoun Exported public String getDisplayName if null displayName return displayName if the displayName is not set then return the name as we use to do return getName Exported public String getDisplayNameOrNull return displayName public void setDisplayNameOrNull String displayName throws IOException setDisplayName displayName public void setDisplayName String displayName throws IOException this displayName Util fixEmptyAndTrim displayName save public File getRootDir return getParent getRootDirFor this WithBridgeMethods value Jenkins class castRequired true Override public Nonnull ItemGroup getParent if parent null throw new IllegalStateException no parent set on getClass getName name return parent Exported public String getDescription return description public void setDescription String description throws IOException this description description save ItemListener fireOnUpdated this protected void doSetName String name this name name protected void renameTo final String newName throws IOException always synchronize from bigger objects first final ItemGroup parent getParent String oldName this name String oldFullName getFullName synchronized parent synchronized this sanity check if newName null throw new IllegalArgumentException New name is not given noop if this name equals newName return the test to see if the project already exists or not needs to be done in escalated privilege to avoid overwriting ACL impersonate ACL SYSTEM new NotReallyRoleSensitiveCallable Void IOException final Authentication user Jenkins getAuthentication Override public Void call throws IOException Item existing parent getItem newName if existing null existing AbstractItem this if existing getACL hasPermission user Item DISCOVER the look up is case insensitive so we need existing this to allow people to rename Foo to foo for example see http www nabble com error on renaming project tt18061629 html throw new IllegalArgumentException Job newName already exists else can t think of any real way to hide this but at least the error message could be vague throw new IOException Unable to rename to newName return null File oldRoot this getRootDir doSetName newName File newRoot this getRootDir boolean success false try rename data files boolean interrupted false boolean renamed false try to rename the job directory this may fail on Windows due to some other processes accessing a file so retry few times before we fall back to copy for int retry 0 retry 5 retry if oldRoot renameTo newRoot renamed true break succeeded try Thread sleep 500 catch InterruptedException e process the interruption later interrupted true if interrupted Thread currentThread interrupt if renamed failed to rename it must be that some lengthy process is going on to prevent a rename operation So do a copy Ideally we d like to later delete the old copy but we can t reliably do so as before the VM shuts down there might be a new job created under the old name Copy cp new Copy cp setProject new org apache tools ant Project cp setTodir newRoot FileSet src new FileSet src setDir oldRoot cp addFileset src cp setOverwrite true cp setPreserveLastModified true cp setFailOnError false keep going even if there s an error cp execute try to delete as much as possible try Util deleteRecursive oldRoot catch IOException e but ignore the error since we expect that e printStackTrace success true finally if failed back out the rename if success doSetName oldName try parent onRenamed this oldName newName catch AbstractMethodError ignore ItemListener fireLocationChange this oldFullName public void movedTo DirectlyModifiableTopLevelItemGroup destination AbstractItem newItem File destDir throws IOException newItem onLoad destination name public abstract Collection extends Job getAllJobs public final String getFullName String n getParent getFullName if n length 0 return getName else return n getName public final String getFullDisplayName String n getParent getFullDisplayName if n length 0 return getDisplayName else return n getDisplayName public String getRelativeDisplayNameFrom ItemGroup p return Functions getRelativeDisplayNameFrom this p public String getRelativeNameFromGroup ItemGroup p return getRelativeNameFrom p public String getRelativeNameFrom ItemGroup p return Functions getRelativeNameFrom this p public String getRelativeNameFrom Item item return getRelativeNameFrom item getParent public void onLoad ItemGroup extends Item parent String name throws IOException this parent parent doSetName name public void onCopiedFrom Item src public final String getUrl try to stick to the current view if possible StaplerRequest req Stapler getCurrentRequest String shortUrl getShortUrl String uri req null null req getRequestURI if req null String seed Functions getNearestAncestorUrl req this LOGGER log Level FINER seed 0 for 1 from 2 new Object seed this uri if seed null trim off the context path portion and leading but add trailing return seed substring req getContextPath length 1 List Ancestor ancestors req getAncestors if ancestors isEmpty Ancestor last ancestors get ancestors size 1 if last getObject instanceof View View view View last getObject if view getOwnerItemGroup getParent view isDefault Showing something inside a view so should use that as the base URL String base last getUrl substring req getContextPath length 1 LOGGER log Level FINER using 0 1 for 2 from 3 new Object base shortUrl this uri return base shortUrl else LOGGER log Level FINER irrelevant 0 for 1 from 2 new Object view getViewName this uri else LOGGER log Level FINER inapplicable 0 for 1 from 2 new Object last getObject this uri else LOGGER log Level FINER no ancestors for 0 from 1 new Object this uri else LOGGER log Level FINER no current request for 0 this otherwise compute the path normally String base getParent getUrl LOGGER log Level FINER falling back to 0 1 for 2 from 3 new Object base shortUrl this uri return base shortUrl public String getShortUrl String prefix getParent getUrlChildPrefix String subdir Util rawEncode getName return prefix equals subdir prefix subdir public String getSearchUrl return getShortUrl Exported visibility 999 name url public final String getAbsoluteUrl String r Jenkins getInstance getRootUrl if r null throw new IllegalStateException Root URL isn t configured yet Cannot compute absolute URL return Util encode r getUrl public final Api getApi return new Api this public ACL getACL return Jenkins getInstance getAuthorizationStrategy getACL this public void checkPermission Permission p getACL checkPermission p public boolean hasPermission Permission p return getACL hasPermission p public synchronized void save throws IOException if BulkChange contains this return getConfigFile write this SaveableListener fireOnChange this getConfigFile public final XmlFile getConfigFile return Items getConfigFile this public Descriptor getDescriptorByName String className return Jenkins getInstance getDescriptorByName className public synchronized void doSubmitDescription StaplerRequest req StaplerResponse rsp throws IOException ServletException checkPermission CONFIGURE setDescription req getParameter description rsp sendRedirect go to the top page RequirePOST public void doDoDelete StaplerRequest req StaplerResponse rsp throws IOException ServletException InterruptedException delete if req null rsp null CLI return List Ancestor ancestors req getAncestors ListIterator Ancestor it ancestors listIterator ancestors size String url getParent getUrl fallback but we ought to get to Jenkins instance at the root while it hasPrevious Object a it previous getObject if a instanceof View url View a getUrl break else if a instanceof ViewGroup a this url ViewGroup a getUrl break rsp sendRedirect2 req getContextPath url public void delete StaplerRequest req StaplerResponse rsp throws IOException ServletException try doDoDelete req rsp catch InterruptedException e TODO allow this in Stapler throw new ServletException e public void delete throws IOException InterruptedException checkPermission DELETE synchronized this could just make performDelete synchronized but overriders might not honor that performDelete JENKINS 19446 leave synch block but JENKINS 22001 still notify synchronously getParent onDeleted AbstractItem this Jenkins getInstance rebuildDependencyGraphAsync protected void performDelete throws IOException InterruptedException getConfigFile delete Util deleteRecursive getRootDir WebMethod name config xml public void doConfigDotXml StaplerRequest req StaplerResponse rsp throws IOException if req getMethod equals GET read rsp setContentType application xml writeConfigDotXml rsp getOutputStream return if req getMethod equals POST submission updateByXml Source new StreamSource req getReader return huh rsp sendError SC BAD REQUEST static final Pattern SECRET PATTERN Pattern compile Secret ENCRYPTED VALUE PATTERN Restricted NoExternalUse class public void writeConfigDotXml OutputStream os throws IOException checkPermission EXTENDED READ XmlFile configFile getConfigFile if hasPermission CONFIGURE IOUtils copy configFile getFile os else String encoding configFile sniffEncoding String xml FileUtils readFileToString configFile getFile encoding Matcher matcher SECRET PATTERN matcher xml StringBuffer cleanXml new StringBuffer while matcher find if Secret decrypt matcher group 1 null matcher appendReplacement cleanXml matcher appendTail cleanXml org apache commons io IOUtils write cleanXml toString os encoding Deprecated public void updateByXml StreamSource source throws IOException updateByXml Source source public void updateByXml Source source throws IOException checkPermission CONFIGURE XmlFile configXmlFile getConfigFile final AtomicFileWriter out new AtomicFileWriter configXmlFile getFile try try XMLUtils safeTransform source new StreamResult out out close catch TransformerException SAXException e throw new IOException Failed to persist config xml e try to reflect the changes by reloading Object o new XmlFile Items XSTREAM out getTemporaryFile unmarshal this if o this ensure that we ve got the same job type extending this code to support updating to different job type requires destroying creating a new job type throw new IOException Expecting this getClass but got o getClass instead Items whileUpdatingByXml new NotReallyRoleSensitiveCallable Void IOException Override public Void call throws IOException onLoad getParent getRootDir getName return null Jenkins getInstance rebuildDependencyGraphAsync if everything went well commit this new version out commit SaveableListener fireOnChange this getConfigFile finally out abort don t leave anything behind RequirePOST public void doReload throws IOException checkPermission CONFIGURE try to reflect the changes by reloading getConfigFile unmarshal this Items whileUpdatingByXml new NotReallyRoleSensitiveCallable Void IOException Override public Void call throws IOException onLoad getParent getRootDir getName return null Jenkins getInstance rebuildDependencyGraphAsync SaveableListener fireOnChange this getConfigFile Override public String getSearchName the search name of abstract items should be the name and not display name this will make suggestions use the names and not the display name so that the links will 302 directly to the thing the user was finding return getName Override public String toString return super toString parent null getFullName name CLIResolver public static AbstractItem resolveForCLI Argument required true metaVar NAME usage Job name String name throws CmdLineException TODO can this and its pseudo override in AbstractProject share code with GenericItemOptionHandler used for explicit CLICommand s rather than CLIMethod s AbstractItem item Jenkins getInstance getItemByFullName name AbstractItem class if item null AbstractProject project AbstractProject findNearest name throw new CmdLineException null project null Messages AbstractItem NoSuchJobExistsWithoutSuggestion name Messages AbstractItem NoSuchJobExists name project getFullName return item public static final Message AbstractItem PRONOUN new Message AbstractItempackage hudson cli handlers import hudson model AbstractItem import org kohsuke MetaInfServices import org kohsuke args4j CmdLineParser import org kohsuke args4j OptionDef import org kohsuke args4j spi OptionHandler import org kohsuke args4j spi Setter MetaInfServices OptionHandler class public class AbstractItemOptionHandler extends GenericItemOptionHandler AbstractItem public AbstractItemOptionHandler CmdLineParser parser OptionDef option Setter AbstractItem setter super parser option setter Override protected Class AbstractItem type return AbstractItem classpackage jenkins model lazy import hudson model Job import hudson model Run import hudson model RunMap import java io File import java io IOException import java util AbstractMap import java util ArrayList import java util Collections import java util Comparator import java util List import java util Map import java util NoSuchElementException import java util Set import java util SortedMap import java util TreeMap import java util logging Level import java util logging Logger import javax annotation CheckForNull import org kohsuke accmod Restricted import org kohsuke accmod restrictions NoExternalUse import static jenkins model lazy AbstractLazyLoadRunMap Direction ASC import static jenkins model lazy AbstractLazyLoadRunMap Direction DESC public abstract class AbstractLazyLoadRunMap R extends AbstractMap Integer R implements SortedMap Integer R private boolean fullyLoaded private volatile Index index new Index private LazyLoadRunMapEntrySet R entrySet new LazyLoadRunMapEntrySet R this private class Index private final TreeMap Integer BuildReference R byNumber private Index byNumber new TreeMap Integer BuildReference R Collections reverseOrder private Index Index rhs byNumber new TreeMap Integer BuildReference R rhs byNumber copy on write private volatile SortedIntList numberOnDisk new SortedIntList 0 protected File dir Restricted NoExternalUse class subclassing other than by RunMap does not guarantee compatibility protected AbstractLazyLoadRunMap File dir initBaseDir dir Restricted NoExternalUse class protected void initBaseDir File dir assert this dir null this dir dir if dir null loadNumberOnDisk Restricted NoExternalUse class public final boolean baseDirInitialized return dir null public final void updateBaseDir File dir this dir dir public synchronized void purgeCache index new Index fullyLoaded false loadNumberOnDisk private void loadNumberOnDisk String kids dir list if kids null the job may have just been created kids EMPTY STRING ARRAY SortedIntList list new SortedIntList kids length 2 for String s kids try list add Integer parseInt s catch NumberFormatException e this isn t a build dir list sort numberOnDisk list public Comparator super Integer comparator return Collections reverseOrder Override public boolean isEmpty return search Integer MAX VALUE DESC null Override public Set Entry Integer R entrySet assert baseDirInitialized return entrySet public SortedMap Integer R getLoadedBuilds return Collections unmodifiableSortedMap new BuildReferenceMapAdapter R this index byNumber public SortedMap Integer R subMap Integer fromKey Integer toKey TODO if this method can produce a lazy map that d be wonderful because due to the lack of floor ceil higher lower kind of methods to look up keys in SortedMap various places of Jenkins rely on subMap firstKey lastKey combo R start search fromKey DESC if start null return EMPTY SORTED MAP R end search toKey ASC if end null return EMPTY SORTED MAP for R i start i end i search getNumberOf i 1 DESC assert i null return Collections unmodifiableSortedMap new BuildReferenceMapAdapter R this index byNumber subMap fromKey toKey public SortedMap Integer R headMap Integer toKey return subMap Integer MAX VALUE toKey public SortedMap Integer R tailMap Integer fromKey return subMap fromKey Integer MIN VALUE public Integer firstKey R r newestBuild if r null throw new NoSuchElementException return getNumberOf r public Integer lastKey R r oldestBuild if r null throw new NoSuchElementException return getNumberOf r public R newestBuild return search Integer MAX VALUE DESC public R oldestBuild return search Integer MIN VALUE ASC Override public R get Object key if key instanceof Integer int n Integer key return get n return super get key public R get int n return getByNumber n public boolean runExists int number return numberOnDisk contains number public CheckForNull R search final int n final Direction d switch d case EXACT return getByNumber n case ASC for int m numberOnDisk if m n TODO could be made more efficient with numberOnDisk find continue R r getByNumber m if r null return r return null case DESC TODO again could be made more efficient List Integer reversed new ArrayList Integer numberOnDisk Collections reverse reversed for int m reversed if m n continue R r getByNumber m if r null return r return null default throw new AssertionError public R getById String id return getByNumber Integer parseInt id public R getByNumber int n Index snapshot index if snapshot byNumber containsKey n BuildReference R ref snapshot byNumber get n if ref null return null known failure R v unwrap ref if v null return v already in memory otherwise fall through to load synchronized this if index byNumber containsKey n JENKINS 22767 recheck inside lock BuildReference R ref index byNumber get n if ref null return null R v unwrap ref if v null return v return load n null Restricted NoExternalUse class public synchronized int maxNumberOnDisk return numberOnDisk max protected final synchronized void proposeNewNumber int number throws IllegalStateException if number maxNumberOnDisk throw new IllegalStateException JENKINS 27530 cannot create a build with number number since that or higher is already in use among numberOnDisk public R put R value return put value protected R put R value return put getNumberOf value value Override public synchronized R put Integer key R r int n getNumberOf r Index copy copy BuildReference R ref createReference r BuildReference R old copy byNumber put n ref index copy if numberOnDisk contains n SortedIntList a new SortedIntList numberOnDisk a add n a sort numberOnDisk a entrySet clearCache return unwrap old private R unwrap BuildReference R ref return ref null ref get null Override public synchronized void putAll Map extends Integer extends R rhs Index copy copy for R r rhs values BuildReference R ref createReference r copy byNumber put getNumberOf r ref index copy TreeMap Integer BuildReference R all if fullyLoaded synchronized this if fullyLoaded Index copy copy for Integer number numberOnDisk if copy byNumber containsKey number load number copy index copy fullyLoaded true return index byNumber private Index copy return new Index index private R load int n Index editInPlace assert Thread holdsLock this assert dir null R v load new File dir String valueOf n editInPlace if v null editInPlace null remember the failure if editInPlace null we can create a new copy for this but not sure if it s worth doing TODO should we also update numberOnDisk editInPlace byNumber put n null return v private R load File dataDir Index editInPlace assert Thread holdsLock this try R r retrieve dataDir if r null return null Index copy editInPlace null editInPlace new Index index BuildReference R ref createReference r BuildReference R old copy byNumber put getNumberOf r ref assert old null old get null tried to overwrite old with ref if editInPlace null index copy return r catch IOException e LOGGER log Level WARNING Failed to load dataDir e return null protected abstract int getNumberOf R r protected String getIdOf R r return String valueOf getNumberOf r protected BuildReference R createReference R r return new BuildReference R getIdOf r r protected abstract R retrieve File dir throws IOException public synchronized boolean removeValue R run Index copy copy int n getNumberOf run BuildReference R old copy byNumber remove n SortedIntList a new SortedIntList numberOnDisk a removeValue n numberOnDisk a this index copy entrySet clearCache return old null public synchronized void reset TreeMap Integer R builds Index index new Index for R r builds values BuildReference R ref createReference r index byNumber put getNumberOf r ref this index index Override public int hashCode return System identityHashCode this Override public boolean equals Object o return o this public enum Direction ASC DESC EXACT private static final String EMPTY STRING ARRAY new String 0 private static final SortedMap EMPTY SORTED MAP Collections unmodifiableSortedMap new TreeMap static final Logger LOGGER Logger getLogger AbstractLazyLoadRunMap class getNamepackage hudson import hudson MarkupText SubText import java util List import java util ArrayList import java util regex Pattern import java util regex Matcher public abstract class AbstractMarkupText AbstractMarkupText limit who can subclass this type public abstract String getText public char charAt int idx return getText charAt idx public final int length return getText length public abstract MarkupText SubText subText int start int end public abstract void addMarkup int startPos int endPos String startTag String endTag public void addHyperlink int startPos int endPos String url addMarkup startPos endPos a href url a public void addHyperlinkLowKey int startPos int endPos String url addMarkup startPos endPos a class lowkey href url a public void hide int startPos int endPos addMarkup startPos endPos span style display none span public final void wrapBy String startTag String endTag addMarkup 0 length startTag endTag public MarkupText SubText findToken Pattern pattern String text getText Matcher m pattern matcher text if m find return createSubText m return null public List MarkupText SubText findTokens Pattern pattern String text getText Matcher m pattern matcher text List SubText r new ArrayList SubText while m find int idx m start if idx 0 char ch text charAt idx 1 if Character isLetter ch Character isDigit ch continue not at a word boundary idx m end if idx text length char ch text charAt idx if Character isLetter ch Character isDigit ch continue not at a word boundary r add createSubText m return r protected abstract SubText createSubText Matcher mpackage hudson model import hudson search SearchFactory import org kohsuke stapler StaplerRequest import org kohsuke stapler StaplerResponse import org kohsuke stapler Stapler import javax servlet ServletException import java io IOException import hudson search SearchableModelObject import hudson search Search import hudson search SearchIndexBuilder import hudson search SearchIndex import org kohsuke stapler interceptor RequirePOST public abstract class AbstractModelObject implements SearchableModelObject protected final void sendError Exception e StaplerRequest req StaplerResponse rsp throws ServletException IOException req setAttribute exception e sendError e getMessage req rsp protected final void sendError Exception e throws ServletException IOException sendError e Stapler getCurrentRequest Stapler getCurrentResponse protected final void sendError String message StaplerRequest req StaplerResponse rsp throws ServletException IOException req setAttribute message message rsp forward this error req protected final void sendError String message StaplerRequest req StaplerResponse rsp boolean pre throws ServletException IOException req setAttribute message message if pre req setAttribute pre true rsp forward this error req protected final void sendError String message throws ServletException IOException sendError message Stapler getCurrentRequest Stapler getCurrentResponse Deprecated protected final void requirePOST throws ServletException StaplerRequest req Stapler getCurrentRequest if req null return invoked outside the context of servlet String method req getMethod if method equalsIgnoreCase POST throw new ServletException Must be POST Can t be method protected SearchIndexBuilder makeSearchIndex return new SearchIndexBuilder addAllAnnotations this public final SearchIndex getSearchIndex return makeSearchIndex make public Search getSearch for SearchFactory sf SearchFactory all Search s sf createFor this if s null return s return new Search public String getSearchName return getDisplayNamepackage hudson node monitors import hudson Util import hudson model Computer import hudson model Descriptor import jenkins model Jenkins import hudson model ComputerSet import hudson model AdministrativeMonitor import hudson triggers SafeTimerTask import hudson slaves OfflineCause import jenkins util Timer import javax annotation concurrent GuardedBy import java io IOException import java util Collections import java util Date import java util HashMap import java util Map import java util concurrent TimeUnit import java util logging Level import java util logging Logger public abstract class AbstractNodeMonitorDescriptor T extends Descriptor NodeMonitor Deprecated protected AbstractNodeMonitorDescriptor this HOUR Deprecated protected AbstractNodeMonitorDescriptor long interval schedule interval Deprecated protected AbstractNodeMonitorDescriptor Class extends NodeMonitor clazz this clazz HOUR Deprecated protected AbstractNodeMonitorDescriptor Class extends NodeMonitor clazz long interval super clazz schedule interval private void schedule long interval Timer get scheduleAtFixedRate new SafeTimerTask public void doRun triggerUpdate interval interval TimeUnit MILLISECONDS private transient volatile Record record null GuardedBy this private transient Record inProgress null GuardedBy this private transient long inProgressStarted Long MIN VALUE protected abstract T monitor Computer c throws IOException InterruptedException protected Map Computer T monitor throws InterruptedException Map Computer T data new HashMap Computer T for Computer c Jenkins getInstance getComputers try Thread currentThread setName Monitoring c getDisplayName for getDisplayName if c getChannel null data put c null else data put c monitor c catch RuntimeException e LOGGER log Level WARNING Failed to monitor c getDisplayName for getDisplayName e catch IOException e LOGGER log Level WARNING Failed to monitor c getDisplayName for getDisplayName e catch InterruptedException e throw InterruptedException new InterruptedException Node monitoring c getDisplayName for getDisplayName aborted initCause e return data public T get Computer c if record null record data containsKey c if we don t have the data schedule the check now triggerUpdate return null return record data get c private synchronized boolean isInProgress return inProgress null inProgress isAlive public long getTimestamp return record null 0L record timestamp public String getTimestampString if record null return Messages AbstractNodeMonitorDescriptor NoDataYet return Messages AbstractNodeMonitorDescriptor DataObtainedSometimeAgo Util getTimeSpanString System currentTimeMillis record timestamp return Util getPastTimeString System currentTimeMillis record timestamp public boolean isIgnored NodeMonitor m ComputerSet getMonitors get this return m null m isIgnored protected boolean markOnline Computer c if isIgnored c isOnline return false noop c setTemporarilyOffline false null return true protected boolean markOffline Computer c OfflineCause oc if isIgnored c isTemporarilyOffline return false noop c setTemporarilyOffline true oc notify the admin MonitorMarkedNodeOffline no AdministrativeMonitor all get MonitorMarkedNodeOffline class if no null no active true return true Deprecated protected boolean markOffline Computer c return markOffline c null synchronized Thread triggerUpdate if inProgress null if inProgress isAlive LOGGER log Level WARNING Previous 0 monitoring activity died without cleaning up after itself getDisplayName inProgress null else if System currentTimeMillis inProgressStarted getMonitoringTimeOut 1000 maybe it got stuck LOGGER log Level WARNING Previous 0 monitoring activity still in progress Interrupting getDisplayName inProgress interrupt inProgress null we interrupted the old one so it s now dead to us else return the in progress return inProgress final Record t new Record t start only store the new thread if we started it inProgress t inProgressStarted System currentTimeMillis return inProgress protected long getMonitoringTimeOut return TimeUnit SECONDS toMillis 30 private final class Record extends Thread private Map Computer T data Collections emptyMap private long timestamp public Record super Monitoring thread for getDisplayName started on new Date Override public void run try long startTime System currentTimeMillis String oldName getName data monitor setName oldName timestamp System currentTimeMillis record this LOGGER log Level FINE Node monitoring 0 completed in 1 ms new Object getDisplayName System currentTimeMillis startTime catch InterruptedException x interrupted by new one fine catch Throwable t LOGGER log Level WARNING Unexpected node monitoring termination getDisplayName t finally synchronized AbstractNodeMonitorDescriptor this if inProgress this inProgress null private static final Logger LOGGER Logger getLogger AbstractNodeMonitorDescriptor class getName private static final long HOUR 1000 60 60Lpackage hudson security import groovy lang Binding import hudson FilePath import hudson cli CLICommand import hudson util spring BeanBuilder import java io Console import java io IOException import jenkins model Jenkins import jenkins security ImpersonatingUserDetailsService import jenkins security SecurityListener import jenkins security MasterToSlaveCallable import org acegisecurity Authentication import org acegisecurity AuthenticationException import org acegisecurity AuthenticationManager import org acegisecurity BadCredentialsException import org acegisecurity providers UsernamePasswordAuthenticationToken import org acegisecurity providers dao AbstractUserDetailsAuthenticationProvider import org acegisecurity userdetails UserDetails import org acegisecurity userdetails UserDetailsService import org acegisecurity userdetails UsernameNotFoundException import org kohsuke args4j Option import org springframework dao DataAccessException import org springframework web context WebApplicationContext public abstract class AbstractPasswordBasedSecurityRealm extends SecurityRealm implements UserDetailsService Override public SecurityComponents createSecurityComponents Binding binding new Binding binding setVariable authenticator new Authenticator BeanBuilder builder new BeanBuilder builder parse Jenkins getInstance servletContext getResourceAsStream WEB INF security AbstractPasswordBasedSecurityRealm groovy binding WebApplicationContext context builder createApplicationContext return new SecurityComponents findBean AuthenticationManager class context new ImpersonatingUserDetailsService this Override public CliAuthenticator createCliAuthenticator final CLICommand command return new CliAuthenticator Option name username usage User name to authenticate yourself to Jenkins public String userName Option name password usage Password for authentication Note that passing a password in arguments is insecure public String password Option name password file usage File that contains the password public String passwordFile public Authentication authenticate throws AuthenticationException IOException InterruptedException if userName null return command getTransportAuthentication no authentication parameter fallback to the transport if passwordFile null try password new FilePath command channel passwordFile readToString trim catch IOException e throw new BadCredentialsException Failed to read passwordFile e if password null password command channel call new InteractivelyAskForPassword if password null throw new BadCredentialsException No password specified UserDetails d doAuthenticate userName password return new UsernamePasswordAuthenticationToken d password d getAuthorities protected abstract UserDetails authenticate String username String password throws AuthenticationException private UserDetails doAuthenticate String username String password throws AuthenticationException try UserDetails user authenticate username password SecurityListener fireAuthenticated user return user catch AuthenticationException x SecurityListener fireFailedToAuthenticate username throw x Override public abstract UserDetails loadUserByUsername String username throws UsernameNotFoundException DataAccessException Override public abstract GroupDetails loadGroupByGroupname String groupname throws UsernameNotFoundException DataAccessException class Authenticator extends AbstractUserDetailsAuthenticationProvider protected void additionalAuthenticationChecks UserDetails userDetails UsernamePasswordAuthenticationToken authentication throws AuthenticationException authentication is assumed to be done already in the retrieveUser method protected UserDetails retrieveUser String username UsernamePasswordAuthenticationToken authentication throws AuthenticationException return doAuthenticate username authentication getCredentials toString private static class InteractivelyAskForPassword extends MasterToSlaveCallable String IOException public String call throws IOException Console console System console if console null return null no terminal char w console readPassword Password if w null return null return new String w private static final long serialVersionUID 1Lpackage hudson model import antlr ANTLRException import com infradna tool bridge method injector WithBridgeMethods import hudson AbortException import hudson CopyOnWrite import hudson EnvVars import hudson ExtensionList import hudson ExtensionPoint import hudson FeedAdapter import hudson FilePath import hudson Functions import hudson Launcher import hudson Util import hudson cli declarative CLIMethod import hudson cli declarative CLIResolver import hudson model Cause LegacyCodeCause import hudson model Descriptor FormException import hudson model Fingerprint RangeSet import hudson model Node Mode import hudson model Queue Executable import hudson model Queue Task import hudson model labels LabelAtom import hudson model labels LabelExpression import hudson model listeners ItemListener import hudson model listeners SCMPollListener import hudson model queue CauseOfBlockage import hudson model queue QueueTaskFuture import hudson model queue SubTask import hudson model queue SubTaskContributor import hudson scm ChangeLogSet import hudson scm ChangeLogSet Entry import hudson scm NullSCM import hudson scm PollingResult import static hudson scm PollingResult import hudson scm SCM import hudson scm SCMRevisionState import hudson scm SCMS import hudson search SearchIndexBuilder import hudson security ACL import hudson security Permission import hudson slaves Cloud import hudson slaves WorkspaceList import hudson tasks BuildStep import hudson tasks BuildStepDescriptor import hudson tasks BuildTrigger import hudson tasks BuildWrapperDescriptor import hudson tasks Publisher import hudson triggers SCMTrigger import hudson triggers Trigger import hudson triggers TriggerDescriptor import hudson util AlternativeUiTextProvider import hudson util AlternativeUiTextProvider Message import hudson util DescribableList import hudson util FormValidation import hudson util TimeUnit2 import hudson widgets HistoryWidget import java io File import java io IOException import java util ArrayList import java util Arrays import java util Calendar import java util Collection import java util Collections import java util Comparator import java util Iterator import java util List import java util Map import java util Set import java util SortedMap import java util TreeMap import java util Vector import java util concurrent Future import java util concurrent atomic AtomicReferenceFieldUpdater import java util logging Level import java util logging Logger import javax annotation CheckForNull import javax annotation Nonnull import javax servlet ServletException import jenkins model BlockedBecauseOfBuildInProgress import jenkins model Jenkins import jenkins model JenkinsLocationConfiguration import jenkins model ParameterizedJobMixIn import jenkins model Uptime import jenkins model lazy LazyBuildMixIn import jenkins scm DefaultSCMCheckoutStrategyImpl import jenkins scm SCMCheckoutStrategy import jenkins scm SCMCheckoutStrategyDescriptor import jenkins scm SCMDecisionHandler import jenkins util TimeDuration import net sf json JSONObject import org acegisecurity Authentication import org jenkinsci bytecode AdaptField import org kohsuke accmod Restricted import org kohsuke accmod restrictions DoNotUse import org kohsuke accmod restrictions NoExternalUse import org kohsuke args4j Argument import org kohsuke args4j CmdLineException import org kohsuke stapler AncestorInPath import org kohsuke stapler ForwardToView import org kohsuke stapler HttpRedirect import org kohsuke stapler HttpResponse import org kohsuke stapler QueryParameter import org kohsuke stapler StaplerRequest import org kohsuke stapler StaplerResponse import org kohsuke stapler export Exported import org kohsuke stapler interceptor RequirePOST SuppressWarnings rawtypes public abstract class AbstractProject P extends AbstractProject P R R extends AbstractBuild P R extends Job P R implements BuildableItem LazyBuildMixIn LazyLoadingJob P R ParameterizedJobMixIn ParameterizedJob private volatile SCM scm new NullSCM private volatile SCMCheckoutStrategy scmCheckoutStrategy private volatile transient SCMRevisionState pollingBaseline null private transient LazyBuildMixIn P R buildMixIn Restricted NoExternalUse class protected transient RunMap R builds private volatile Integer quietPeriod null private volatile Integer scmCheckoutRetryCount null private String assignedNode private volatile boolean canRoam protected volatile boolean disabled protected volatile boolean blockBuildWhenDownstreamBuilding false protected volatile boolean blockBuildWhenUpstreamBuilding false private volatile String jdk private volatile BuildAuthorizationToken authToken null AdaptField was List class protected volatile DescribableList Trigger TriggerDescriptor triggers new DescribableList Trigger TriggerDescriptor this private static final AtomicReferenceFieldUpdater AbstractProject DescribableList triggersUpdater AtomicReferenceFieldUpdater newUpdater AbstractProject class DescribableList class triggers CopyOnWrite protected transient volatile List Action transientActions new Vector Action private boolean concurrentBuild private String customWorkspace protected AbstractProject ItemGroup parent String name super parent name buildMixIn createBuildMixIn builds buildMixIn getRunMap final Jenkins j Jenkins getInstance final List Node nodes j null j getNodes null if nodes null nodes isEmpty if a new job is configured with Hudson that already has agent nodes make it roamable by default canRoam true private LazyBuildMixIn P R createBuildMixIn return new LazyBuildMixIn P R SuppressWarnings unchecked untypable Override protected P asJob return P AbstractProject this Override protected Class R getBuildClass return AbstractProject this getBuildClass Override public LazyBuildMixIn P R getLazyBuildMixIn return buildMixIn private ParameterizedJobMixIn P R getParameterizedJobMixIn return new ParameterizedJobMixIn P R SuppressWarnings unchecked untypable Override protected P asJob return P AbstractProject this Override public synchronized void save throws IOException super save updateTransientActions Override public void onCreatedFromScratch super onCreatedFromScratch buildMixIn onCreatedFromScratch builds buildMixIn getRunMap solicit initial contributions especially from TransientProjectActionFactory updateTransientActions Override public void onLoad ItemGroup extends Item parent String name throws IOException super onLoad parent name if buildMixIn null buildMixIn createBuildMixIn buildMixIn onLoad parent name builds buildMixIn getRunMap triggers setOwner this for Trigger t triggers try t start this Items currentlyUpdatingByXml catch Throwable e LOGGER log Level WARNING could not start trigger while loading project getFullName e if scm null scm new NullSCM perhaps it was pointing to a plugin that no longer exists if transientActions null transientActions new Vector Action happens when loaded from disk updateTransientActions WithBridgeMethods List class protected DescribableList Trigger TriggerDescriptor triggers if triggers null triggersUpdater compareAndSet this null new DescribableList Trigger TriggerDescriptor this return triggers Override public EnvVars getEnvironment Node node TaskListener listener throws IOException InterruptedException EnvVars env super getEnvironment node listener JDK jdkTool getJDK if jdkTool null if node null just in case were not in a build jdkTool jdkTool forNode node listener jdkTool buildEnvVars env else if JDK isDefaultName jdk listener getLogger println No JDK named jdk found return env Override protected void performDelete throws IOException InterruptedException prevent a new build while a delete operation is in progress makeDisabled true FilePath ws getWorkspace if ws null Node on getLastBuiltOn getScm processWorkspaceBeforeDeletion this ws on if on null on getFileSystemProvisioner discardWorkspace this ws super performDelete Exported public boolean isConcurrentBuild return concurrentBuild public void setConcurrentBuild boolean b throws IOException concurrentBuild b save public CheckForNull Label getAssignedLabel if canRoam return null if assignedNode null return Jenkins getInstance getSelfLabel return Jenkins getInstance getLabel assignedNode public Set Label getRelevantLabels return Collections singleton getAssignedLabel public String getAssignedLabelString if canRoam assignedNode null return null try LabelExpression parseExpression assignedNode return assignedNode catch ANTLRException e must be old label or host name that includes whitespace or other unsafe chars return LabelAtom escape assignedNode public void setAssignedLabel Label l throws IOException if l null canRoam true assignedNode null else canRoam false if l Jenkins getInstance getSelfLabel assignedNode null else assignedNode l getExpression save public void setAssignedNode Node l throws IOException setAssignedLabel l getSelfLabel Override public String getPronoun return AlternativeUiTextProvider get PRONOUN this Messages AbstractProject Pronoun public String getBuildNowText For compatibility still use the deprecated replacer if specified return AlternativeUiTextProvider get BUILD NOW TEXT this getParameterizedJobMixIn getBuildNowText public AbstractProject getRootProject if this instanceof TopLevelItem return this else ItemGroup p this getParent if p instanceof AbstractProject return AbstractProject p getRootProject return this Deprecated public final FilePath getWorkspace AbstractBuild b getBuildForDeprecatedMethods return b null b getWorkspace null private AbstractBuild getBuildForDeprecatedMethods Executor e Executor currentExecutor if e null Executable exe e getCurrentExecutable if exe instanceof AbstractBuild AbstractBuild b AbstractBuild exe if b getProject this return b R lb getLastBuild if lb null return lb return null public final CheckForNull FilePath getSomeWorkspace R b getSomeBuildWithWorkspace if b null return b getWorkspace for WorkspaceBrowser browser ExtensionList lookup WorkspaceBrowser class FilePath f browser getWorkspace this if f null return f return null public final R getSomeBuildWithWorkspace int cnt 0 for R b getLastBuild cnt 5 b null b b getPreviousBuild FilePath ws b getWorkspace if ws null return b return null private R getSomeBuildWithExistingWorkspace throws IOException InterruptedException int cnt 0 for R b getLastBuild cnt 5 b null b b getPreviousBuild FilePath ws b getWorkspace if ws null ws exists return b return null Deprecated public FilePath getModuleRoot AbstractBuild b getBuildForDeprecatedMethods return b null b getModuleRoot null Deprecated public FilePath getModuleRoots AbstractBuild b getBuildForDeprecatedMethods return b null b getModuleRoots null public int getQuietPeriod return quietPeriod null quietPeriod Jenkins getInstance getQuietPeriod public SCMCheckoutStrategy getScmCheckoutStrategy return scmCheckoutStrategy null new DefaultSCMCheckoutStrategyImpl scmCheckoutStrategy public void setScmCheckoutStrategy SCMCheckoutStrategy scmCheckoutStrategy throws IOException this scmCheckoutStrategy scmCheckoutStrategy save public int getScmCheckoutRetryCount return scmCheckoutRetryCount null scmCheckoutRetryCount Jenkins getInstance getScmCheckoutRetryCount ugly name because of EL public boolean getHasCustomQuietPeriod return quietPeriod null public void setQuietPeriod Integer seconds throws IOException this quietPeriod seconds save public boolean hasCustomScmCheckoutRetryCount return scmCheckoutRetryCount null Override public boolean isBuildable return isDisabled isHoldOffBuildUntilSave public boolean isConfigurable return true public boolean blockBuildWhenDownstreamBuilding return blockBuildWhenDownstreamBuilding public void setBlockBuildWhenDownstreamBuilding boolean b throws IOException blockBuildWhenDownstreamBuilding b save public boolean blockBuildWhenUpstreamBuilding return blockBuildWhenUpstreamBuilding public void setBlockBuildWhenUpstreamBuilding boolean b throws IOException blockBuildWhenUpstreamBuilding b save public boolean isDisabled return disabled public FormValidation doCheckRetryCount QueryParameter String value throws IOException ServletException retry count is optional so this is ok if value null value trim equals return FormValidation ok if value matches 0 9 return FormValidation error Invalid retry count return FormValidation ok public void makeDisabled boolean b throws IOException if disabled b return noop if b supportsMakeDisabled return do nothing if the disabling is unsupported this disabled b if b Jenkins getInstance getQueue cancel this save ItemListener fireOnUpdated this public boolean supportsMakeDisabled return this instanceof TopLevelItem public void disable throws IOException makeDisabled true public void enable throws IOException makeDisabled false Override public BallColor getIconColor if isDisabled return isBuilding BallColor DISABLED ANIME BallColor DISABLED else return super getIconColor protected void updateTransientActions transientActions createTransientActions protected List Action createTransientActions Vector Action ta new Vector Action for JobProperty super P p Util fixNull properties ta addAll p getJobActions P this for TransientProjectActionFactory tpaf TransientProjectActionFactory all try ta addAll Util fixNull tpaf createFor this be defensive against null catch Exception e LOGGER log Level SEVERE Could not load actions from tpaf for this e return ta public abstract DescribableList Publisher Descriptor Publisher getPublishersList Override public void addProperty JobProperty super P jobProp throws IOException super addProperty jobProp updateTransientActions public List ProminentProjectAction getProminentActions return getActions ProminentProjectAction class Override public void doConfigSubmit StaplerRequest req StaplerResponse rsp throws IOException ServletException FormException super doConfigSubmit req rsp updateTransientActions notify the queue as the project might be now tied to different node Jenkins getInstance getQueue scheduleMaintenance this is to reflect the upstream build adjustments done above Jenkins getInstance rebuildDependencyGraphAsync Deprecated public boolean scheduleBuild return getParameterizedJobMixIn scheduleBuild Deprecated public boolean scheduleBuild int quietPeriod return getParameterizedJobMixIn scheduleBuild quietPeriod public boolean scheduleBuild Cause c return getParameterizedJobMixIn scheduleBuild c public boolean scheduleBuild int quietPeriod Cause c return getParameterizedJobMixIn scheduleBuild quietPeriod c public boolean scheduleBuild int quietPeriod Cause c Action actions return scheduleBuild2 quietPeriod c actions null WithBridgeMethods Future class public QueueTaskFuture R scheduleBuild2 int quietPeriod Cause c Action actions return scheduleBuild2 quietPeriod c Arrays asList actions SuppressWarnings unchecked WithBridgeMethods Future class public QueueTaskFuture R scheduleBuild2 int quietPeriod Cause c Collection extends Action actions List Action queueActions new ArrayList Action actions if c null queueActions add new CauseAction c return getParameterizedJobMixIn scheduleBuild2 quietPeriod queueActions toArray new Action queueActions size SuppressWarnings deprecation WithBridgeMethods Future class public QueueTaskFuture R scheduleBuild2 int quietPeriod return scheduleBuild2 quietPeriod new LegacyCodeCause WithBridgeMethods Future class public QueueTaskFuture R scheduleBuild2 int quietPeriod Cause c return scheduleBuild2 quietPeriod c new Action 0 public boolean schedulePolling if isDisabled return false SCMTrigger scmt getTrigger SCMTrigger class if scmt null return false scmt run return true Override public boolean isInQueue return Jenkins getInstance getQueue contains this Override public Queue Item getQueueItem return Jenkins getInstance getQueue getItem this public JDK getJDK return Jenkins getInstance getJDK jdk public void setJDK JDK jdk throws IOException this jdk jdk getName save public BuildAuthorizationToken getAuthToken return authToken Override public RunMap R getRuns return buildMixIn getRuns Override public void removeRun R run buildMixIn removeRun run Override public R getBuild String id return buildMixIn getBuild id Override public R getBuildByNumber int n return buildMixIn getBuildByNumber n Override public R getFirstBuild return buildMixIn getFirstBuild Override public CheckForNull R getLastBuild return buildMixIn getLastBuild Override public R getNearestBuild int n return buildMixIn getNearestBuild n Override public R getNearestOldBuild int n return buildMixIn getNearestOldBuild n protected abstract Class R getBuildClass protected synchronized R newBuild throws IOException return buildMixIn newBuild protected R loadBuild File dir throws IOException return buildMixIn loadBuild dir SuppressWarnings deprecation Override public List Action getActions add all the transient actions too List Action actions new Vector Action super getActions actions addAll transientActions return the read only list to cause a failure on plugins who try to add an action here return Collections unmodifiableList actions public Node getLastBuiltOn where was it built on AbstractBuild b getLastBuild if b null return null else return b getBuiltOn public Object getSameNodeConstraint return this in this way any member that wants to run with the main guy can nominate the project itself public final Task getOwnerTask return this Nonnull public Authentication getDefaultAuthentication backward compatible behaviour return ACL SYSTEM Nonnull Override public Authentication getDefaultAuthentication Queue Item item return getDefaultAuthentication Override public boolean isBuildBlocked return getCauseOfBlockage null public String getWhyBlocked CauseOfBlockage cb getCauseOfBlockage return cb null cb getShortDescription null Deprecated public static class BecauseOfBuildInProgress extends BlockedBecauseOfBuildInProgress public BecauseOfBuildInProgress Nonnull AbstractBuild build super build public static class BecauseOfDownstreamBuildInProgress extends CauseOfBlockage public final AbstractProject up public BecauseOfDownstreamBuildInProgress AbstractProject up this up up Override public String getShortDescription return Messages AbstractProject DownstreamBuildInProgress up getName public static class BecauseOfUpstreamBuildInProgress extends CauseOfBlockage public final AbstractProject up public BecauseOfUpstreamBuildInProgress AbstractProject up this up up Override public String getShortDescription return Messages AbstractProject UpstreamBuildInProgress up getName Override public CauseOfBlockage getCauseOfBlockage Block builds until they are done with post production if isLogUpdated isConcurrentBuild final R lastBuild getLastBuild if lastBuild null return new BlockedBecauseOfBuildInProgress lastBuild else The build has been likely deleted after the isLogUpdated call Another cause may be an API implemetation glit h in the implementation for AbstractProject Anyway we should let the code go then LOGGER log Level FINE The last build has been deleted during the non concurrent cause creation The build is not blocked anymore if blockBuildWhenDownstreamBuilding AbstractProject bup getBuildingDownstream if bup null return new BecauseOfDownstreamBuildInProgress bup if blockBuildWhenUpstreamBuilding AbstractProject bup getBuildingUpstream if bup null return new BecauseOfUpstreamBuildInProgress bup return null public AbstractProject getBuildingDownstream Set Task unblockedTasks Jenkins getInstance getQueue getUnblockedTasks for AbstractProject tup getTransitiveDownstreamProjects if tup this tup isBuilding unblockedTasks contains tup return tup return null public AbstractProject getBuildingUpstream Set Task unblockedTasks Jenkins getInstance getQueue getUnblockedTasks for AbstractProject tup getTransitiveUpstreamProjects if tup this tup isBuilding unblockedTasks contains tup return tup return null public List SubTask getSubTasks List SubTask r new ArrayList SubTask r add this for SubTaskContributor euc SubTaskContributor all r addAll euc forProject this for JobProperty super P p properties r addAll p getSubTasks return r public CheckForNull R createExecutable throws IOException if isDisabled return null return newBuild public void checkAbortPermission checkPermission CANCEL public boolean hasAbortPermission return hasPermission CANCEL Deprecated public Resource getWorkspaceResource return new Resource getFullDisplayName workspace public ResourceList getResourceList final Set ResourceActivity resourceActivities getResourceActivities final List ResourceList resourceLists new ArrayList ResourceList 1 resourceActivities size for ResourceActivity activity resourceActivities if activity this activity null defensive infinite recursion and null check resourceLists add activity getResourceList return ResourceList union resourceLists protected Set ResourceActivity getResourceActivities return Collections emptySet public boolean checkout AbstractBuild build Launcher launcher BuildListener listener File changelogFile throws IOException InterruptedException SCM scm getScm if scm null return true no SCM FilePath workspace build getWorkspace workspace mkdirs boolean r scm checkout build launcher workspace listener changelogFile if r Only calcRevisionsFromBuild if checkout was successful Note that modern SCM implementations won t reach this line anyway as they throw AbortExceptions on checkout failure calcPollingBaseline build launcher listener return r private void calcPollingBaseline AbstractBuild build Launcher launcher TaskListener listener throws IOException InterruptedException SCMRevisionState baseline build getAction SCMRevisionState class if baseline null try baseline getScm calcRevisionsFromBuild build launcher listener catch AbstractMethodError e baseline SCMRevisionState NONE pre 1 345 SCM implementations which doesn t use the baseline in polling if baseline null build addAction baseline pollingBaseline baseline Deprecated public boolean pollSCMChanges TaskListener listener return poll listener hasChanges public PollingResult poll TaskListener listener SCM scm getScm if scm null listener getLogger println Messages AbstractProject NoSCM return NO CHANGES if isBuildable listener getLogger println Messages AbstractProject Disabled return NO CHANGES SCMDecisionHandler veto SCMDecisionHandler firstShouldPollVeto this if veto null listener getLogger println Messages AbstractProject PollingVetoed veto return NO CHANGES R lb getLastBuild if lb null listener getLogger println Messages AbstractProject NoBuilds return isInQueue NO CHANGES BUILD NOW if pollingBaseline null R success getLastSuccessfulBuild if we have a persisted baseline we ll find it by this for R r lb r null r r getPreviousBuild SCMRevisionState s r getAction SCMRevisionState class if s null pollingBaseline s break if r success break searched far enough NOTE NO BASELINE if we don t have baseline yet it means the data is built by old Hudson that doesn t set the baseline as action so we need to compute it This happens later try SCMPollListener fireBeforePolling this listener PollingResult r poll listener scm SCMPollListener firePollingSuccess this listener r return r catch AbortException e listener getLogger println e getMessage listener fatalError Messages AbstractProject Aborted LOGGER log Level FINE Polling this aborted e SCMPollListener firePollingFailed this listener e return NO CHANGES catch IOException e e printStackTrace listener fatalError e getMessage SCMPollListener firePollingFailed this listener e return NO CHANGES catch InterruptedException e e printStackTrace listener fatalError Messages AbstractProject PollingABorted SCMPollListener firePollingFailed this listener e return NO CHANGES catch RuntimeException e SCMPollListener firePollingFailed this listener e throw e catch Error e SCMPollListener firePollingFailed this listener e throw e private PollingResult poll TaskListener listener SCM scm throws IOException InterruptedException if scm requiresWorkspaceForPolling R b getSomeBuildWithExistingWorkspace if b null b getLastBuild lock the workspace for the given build FilePath ws b getWorkspace WorkspaceOfflineReason workspaceOfflineReason workspaceOffline b if workspaceOfflineReason null workspace offline for WorkspaceBrowser browser ExtensionList lookup WorkspaceBrowser class ws browser getWorkspace this if ws null return pollWithWorkspace listener scm b ws browser getWorkspaceList At this point we start thinking about triggering a build just to get a workspace because otherwise there s no way we can detect changes However first there are some conditions in which we do not want to do so give time for agents to come online if we are right after reconnection JENKINS 8408 long running Jenkins getInstance getInjector getInstance Uptime class getUptime long remaining TimeUnit2 MINUTES toMillis 10 running if remaining 0 Functions getIsUnitTest listener getLogger print Messages AbstractProject AwaitingWorkspaceToComeOnline remaining 1000 listener getLogger println workspaceOfflineReason name return NO CHANGES Do not trigger build if no suitable agent is online if workspaceOfflineReason equals WorkspaceOfflineReason all suitable nodes are offline No suitable executor is online listener getLogger print Messages AbstractProject AwaitingWorkspaceToComeOnline running 1000 listener getLogger println workspaceOfflineReason name return NO CHANGES Label label getAssignedLabel if label null label isSelfLabel if the build is fixed on a node then attempting a build will do us no good We should just wait for the agent to come back listener getLogger print Messages AbstractProject NoWorkspace listener getLogger println workspaceOfflineReason name return NO CHANGES listener getLogger println ws null Messages AbstractProject WorkspaceOffline Messages AbstractProject NoWorkspace if isInQueue listener getLogger println Messages AbstractProject AwaitingBuildForWorkspace return NO CHANGES build now or nothing will ever be built listener getLogger print Messages AbstractProject NewBuildForWorkspace listener getLogger println workspaceOfflineReason name return BUILD NOW else WorkspaceList l b getBuiltOn toComputer getWorkspaceList return pollWithWorkspace listener scm b ws l else polling without workspace LOGGER fine Polling SCM changes of getName if pollingBaseline null see NOTE NO BASELINE above calcPollingBaseline getLastBuild null listener PollingResult r scm poll this null null listener pollingBaseline pollingBaseline r remote return r private PollingResult pollWithWorkspace TaskListener listener SCM scm R lb Nonnull FilePath ws WorkspaceList l throws InterruptedException IOException if doing non concurrent build acquire a workspace in a way that causes builds to block for this workspace this prevents multiple workspaces of the same job the behavior of Hudson 1 319 OTOH if a concurrent build is chosen the user is willing to create a multiple workspace so better throughput is achieved over time modulo the initial cost of creating that many workspaces by having multiple workspaces Node node lb getBuiltOn Launcher launcher ws createLauncher listener decorateByEnv getEnvironment node listener WorkspaceList Lease lease l acquire ws concurrentBuild try String nodeName node null node getSelfLabel getName node unavailable listener getLogger println Polling SCM changes on nodeName LOGGER fine Polling SCM changes of getName if pollingBaseline null see NOTE NO BASELINE above calcPollingBaseline lb launcher listener PollingResult r scm poll this launcher ws listener pollingBaseline pollingBaseline r remote return r finally lease release enum WorkspaceOfflineReason nonexisting workspace builton node gone builton node no executors all suitable nodes are offline use ondemand slave private boolean isAllSuitableNodesOffline R build Label label getAssignedLabel List Node allNodes Jenkins getInstance getNodes if label null Invalid label Put in queue to make administrator fix if label getNodes isEmpty return false Returns true if all suitable nodes are offline return label isOffline else if canRoam for Node n Jenkins getInstance getNodes Computer c n toComputer if c null c isOnline c isAcceptingTasks n getMode Mode NORMAL Some executor is online that is ready and this job can run anywhere return false We can roam check that the master is set to be used as much as possible and not tied jobs only if Jenkins getInstance getMode Mode EXCLUSIVE return true else return false return true private WorkspaceOfflineReason workspaceOffline R build throws IOException InterruptedException FilePath ws build getWorkspace Label label getAssignedLabel if isAllSuitableNodesOffline build Collection Cloud applicableClouds label null Jenkins getInstance clouds label getClouds return applicableClouds isEmpty WorkspaceOfflineReason all suitable nodes are offline WorkspaceOfflineReason use ondemand slave if ws null ws exists return WorkspaceOfflineReason nonexisting workspace Node builtOn build getBuiltOn if builtOn null node built on doesn t exist anymore return WorkspaceOfflineReason builton node gone if builtOn toComputer null node still exists but has 0 executors o s l t return WorkspaceOfflineReason builton node no executors return null public boolean hasParticipant User user for R build getLastBuild build null build build getPreviousBuild if build hasParticipant user return true return false Exported public SCM getScm return scm public void setScm SCM scm throws IOException this scm scm save public void addTrigger Trigger trigger throws IOException addToList trigger triggers public void removeTrigger TriggerDescriptor trigger throws IOException removeFromList trigger triggers protected final synchronized T extends Describable T void addToList T item List T collection throws IOException No support to replace item in position remove then add removeFromList item getDescriptor collection collection add item save updateTransientActions protected final synchronized T extends Describable T void removeFromList Descriptor T item List T collection throws IOException final Iterator T iCollection collection iterator while iCollection hasNext final T next iCollection next if next getDescriptor item found it iCollection remove save updateTransientActions return SuppressWarnings unchecked Override public Map TriggerDescriptor Trigger getTriggers return triggers toMap public T extends Trigger T getTrigger Class T clazz for Trigger p triggers if clazz isInstance p return clazz cast p return null fingerprint related public abstract boolean isFingerprintConfigured Exported public final List AbstractProject getDownstreamProjects return Jenkins getInstance getDependencyGraph getDownstream this Exported public final List AbstractProject getUpstreamProjects return Jenkins getInstance getDependencyGraph getUpstream this public final List AbstractProject getBuildTriggerUpstreamProjects ArrayList AbstractProject result new ArrayList AbstractProject for AbstractProject ap getUpstreamProjects BuildTrigger buildTrigger ap getPublishersList get BuildTrigger class if buildTrigger null if buildTrigger getChildProjects ap contains this result add ap return result public final Set AbstractProject getTransitiveUpstreamProjects return Jenkins getInstance getDependencyGraph getTransitiveUpstream this public final Set AbstractProject getTransitiveDownstreamProjects return Jenkins getInstance getDependencyGraph getTransitiveDownstream this public SortedMap Integer RangeSet getRelationship AbstractProject that TreeMap Integer RangeSet r new TreeMap Integer RangeSet REVERSE INTEGER COMPARATOR checkAndRecord that r this getBuilds checkAndRecord that r that getBuilds return r private void checkAndRecord AbstractProject that TreeMap Integer RangeSet r Collection R builds for R build builds RangeSet rs build getDownstreamRelationship that if rs null rs isEmpty continue int n build getNumber RangeSet value r get n if value null r put n rs else value add rs protected void buildDependencyGraph DependencyGraph graph triggers buildDependencyGraph this graph Override protected SearchIndexBuilder makeSearchIndex return getParameterizedJobMixIn extendSearchIndex super makeSearchIndex Override protected HistoryWidget createHistoryWidget return buildMixIn createHistoryWidget public boolean isParameterized return getParameterizedJobMixIn isParameterized actions public void doBuild StaplerRequest req StaplerResponse rsp QueryParameter TimeDuration delay throws IOException ServletException getParameterizedJobMixIn doBuild req rsp delay Deprecated public void doBuild StaplerRequest req StaplerResponse rsp throws IOException ServletException doBuild req rsp TimeDuration fromString req getParameter delay Deprecated public int getDelay StaplerRequest req throws ServletException String delay req getParameter delay if delay null return getQuietPeriod try TODO more unit handling if delay endsWith sec delay delay substring 0 delay length 3 if delay endsWith secs delay delay substring 0 delay length 4 return Integer parseInt delay catch NumberFormatException e throw new ServletException Invalid delay parameter value delay public void doBuildWithParameters StaplerRequest req StaplerResponse rsp QueryParameter TimeDuration delay throws IOException ServletException getParameterizedJobMixIn doBuildWithParameters req rsp delay Deprecated public void doBuildWithParameters StaplerRequest req StaplerResponse rsp throws IOException ServletException doBuildWithParameters req rsp TimeDuration fromString req getParameter delay public void doPolling StaplerRequest req StaplerResponse rsp throws IOException ServletException BuildAuthorizationToken checkPermission Job this authToken req rsp schedulePolling rsp sendRedirect RequirePOST public void doCancelQueue StaplerRequest req StaplerResponse rsp throws IOException ServletException getParameterizedJobMixIn doCancelQueue req rsp Override protected void submit StaplerRequest req StaplerResponse rsp throws IOException ServletException FormException super submit req rsp JSONObject json req getSubmittedForm makeDisabled json optBoolean disable jdk json optString jdk null if json optBoolean hasCustomQuietPeriod json has quiet period quietPeriod json optInt quiet period else quietPeriod null if json optBoolean hasCustomScmCheckoutRetryCount json has scmCheckoutRetryCount scmCheckoutRetryCount json optInt scmCheckoutRetryCount else scmCheckoutRetryCount null blockBuildWhenDownstreamBuilding json optBoolean blockBuildWhenDownstreamBuilding blockBuildWhenUpstreamBuilding json optBoolean blockBuildWhenUpstreamBuilding if req hasParameter customWorkspace directory Workaround for JENKINS 25221 while plugins are being updated LOGGER log Level WARNING label assignment is using legacy customWorkspace directory customWorkspace Util fixEmptyAndTrim req getParameter customWorkspace directory else if json optBoolean hasCustomWorkspace json has customWorkspace customWorkspace Util fixEmptyAndTrim json optString customWorkspace else customWorkspace null if json has scmCheckoutStrategy scmCheckoutStrategy req bindJSON SCMCheckoutStrategy class json getJSONObject scmCheckoutStrategy else scmCheckoutStrategy null if json optBoolean hasSlaveAffinity json has label assignedNode Util fixEmptyAndTrim json optString label else if req hasParameter assignedLabelString Workaround for JENKINS 25372 while plugin is being updated Keep this condition second for JENKINS 25533 LOGGER log Level WARNING label assignment is using legacy assignedLabelString assignedNode Util fixEmptyAndTrim req getParameter assignedLabelString else assignedNode null canRoam assignedNode null keepDependencies json has keepDependencies concurrentBuild json optBoolean concurrentBuild authToken BuildAuthorizationToken create req setScm SCMS parseSCM req this for Trigger t triggers t stop triggers replaceBy buildDescribable req Trigger for this for Trigger t triggers t start this true Deprecated protected final T extends Describable T List T buildDescribable StaplerRequest req List extends Descriptor T descriptors String prefix throws FormException ServletException return buildDescribable req descriptors protected final T extends Describable T List T buildDescribable StaplerRequest req List extends Descriptor T descriptors throws FormException ServletException JSONObject data req getSubmittedForm List T r new Vector T for Descriptor T d descriptors String safeName d getJsonSafeClassName if req getParameter safeName null T instance d newInstance req data getJSONObject safeName r add instance return r public DirectoryBrowserSupport doWs StaplerRequest req StaplerResponse rsp throws IOException ServletException InterruptedException checkPermission Item WORKSPACE FilePath ws getSomeWorkspace if ws null ws exists if there s no workspace report a nice error message Would be good if when asked for plain do something else E g return 404 or send empty doc Not critical client can just check if content type is not text plain which also serves to detect old versions of Hudson req getView this noWorkspace jelly forward req rsp return null else Computer c ws toComputer String title if c null title Messages AbstractProject WorkspaceTitle getDisplayName else title Messages AbstractProject WorkspaceTitleOnComputer getDisplayName c getDisplayName return new DirectoryBrowserSupport this ws title folder png true RequirePOST public HttpResponse doDoWipeOutWorkspace throws IOException ServletException InterruptedException checkPermission Functions isWipeOutPermissionEnabled WIPEOUT BUILD R b getSomeBuildWithWorkspace FilePath ws b null b getWorkspace null if ws null getScm processWorkspaceBeforeDeletion this ws b getBuiltOn ws deleteRecursive for WorkspaceListener wl WorkspaceListener all wl afterDelete this return new HttpRedirect else If we get here that means the SCM blocked the workspace deletion return new ForwardToView this wipeOutWorkspaceBlocked jelly CLIMethod name disable job RequirePOST public HttpResponse doDisable throws IOException ServletException checkPermission CONFIGURE makeDisabled true return new HttpRedirect CLIMethod name enable job RequirePOST public HttpResponse doEnable throws IOException ServletException checkPermission CONFIGURE makeDisabled false return new HttpRedirect public void doRssChangelog StaplerRequest req StaplerResponse rsp throws IOException ServletException class FeedItem ChangeLogSet Entry e int idx public FeedItem Entry e int idx this e e this idx idx AbstractBuild getBuild return e getParent build List FeedItem entries new ArrayList FeedItem for R r getLastBuild r null r r getPreviousBuild int idx 0 for ChangeLogSet Entry e r getChangeSet entries add new FeedItem e idx RSS forwardToRss getDisplayName getScm getDescriptor getDisplayName changes getUrl changes entries new FeedAdapter FeedItem public String getEntryTitle FeedItem item return item getBuild number item e getMsg item e getAuthor public String getEntryUrl FeedItem item return item getBuild getUrl changes detail item idx public String getEntryID FeedItem item return getEntryUrl item public String getEntryDescription FeedItem item StringBuilder buf new StringBuilder for String path item e getAffectedPaths buf append path append n return buf toString public Calendar getEntryTimestamp FeedItem item return item getBuild getTimestamp public String getEntryAuthor FeedItem entry return JenkinsLocationConfiguration get getAdminAddress req rsp public static abstract class AbstractProjectDescriptor extends TopLevelItemDescriptor Override public boolean isApplicable Descriptor descriptor return true Restricted DoNotUse class public FormValidation doCheckAssignedLabelString AncestorInPath AbstractProject project QueryParameter String value Provide a legacy interface in case plugins are not going through p config assignedLabel see JENKINS 25372 LOGGER log Level WARNING checking label via legacy assignedLabelString return doCheckLabel project value public FormValidation doCheckLabel AncestorInPath AbstractProject project QueryParameter String value return validateLabelExpression value project public static Nonnull FormValidation validateLabelExpression String value CheckForNull AbstractProject project if Util fixEmpty value null return FormValidation ok nothing typed yet try Label parseExpression value catch ANTLRException e return FormValidation error e Messages AbstractProject AssignedLabelString InvalidBooleanExpression e getMessage Jenkins j Jenkins getInstance Label l j getLabel value if l isEmpty for LabelAtom a l listAtoms if a isEmpty LabelAtom nearest LabelAtom findNearest a getName return FormValidation warning Messages AbstractProject AssignedLabelString NoMatch DidYouMean a getName nearest getDisplayName return FormValidation warning Messages AbstractProject AssignedLabelString NoMatch if project null for AbstractProject LabelValidator v j getExtensionList AbstractProject LabelValidator class FormValidation result v check project l if FormValidation Kind OK equals result kind return result return FormValidation okWithMarkup Messages AbstractProject LabelLink j getRootUrl Util escape l getName l getUrl l getNodes size l getClouds size public FormValidation doCheckCustomWorkspace QueryParameter String customWorkspace if Util fixEmptyAndTrim customWorkspace null return FormValidation error Messages AbstractProject CustomWorkspaceEmpty else return FormValidation ok public AutoCompletionCandidates doAutoCompleteUpstreamProjects QueryParameter String value AutoCompletionCandidates candidates new AutoCompletionCandidates List Job jobs Jenkins getInstance getItems Job class for Job job jobs if job getFullName startsWith value if job hasPermission Item READ candidates add job getFullName return candidates Restricted DoNotUse class public AutoCompletionCandidates doAutoCompleteAssignedLabelString QueryParameter String value Provide a legacy interface in case plugins are not going through p config assignedLabel see JENKINS 25372 LOGGER log Level WARNING autocompleting label via legacy assignedLabelString return doAutoCompleteLabel value public AutoCompletionCandidates doAutoCompleteLabel QueryParameter String value AutoCompletionCandidates c new AutoCompletionCandidates Set Label labels Jenkins getInstance getLabels List String queries new AutoCompleteSeeder value getSeeds for String term queries for Label l labels if l getName startsWith term c add l getName return c public List SCMCheckoutStrategyDescriptor getApplicableSCMCheckoutStrategyDescriptors AbstractProject p return SCMCheckoutStrategyDescriptor for p static class AutoCompleteSeeder private String source AutoCompleteSeeder String source this source source List String getSeeds ArrayList String terms new ArrayList String boolean trailingQuote source endsWith boolean leadingQuote source startsWith boolean trailingSpace source endsWith if trailingQuote trailingSpace leadingQuote terms add else if leadingQuote int quote source lastIndexOf if quote 0 terms add source substring 1 else terms add else int space source lastIndexOf if space 1 terms add source substring space 1 else terms add source return terms public static CheckForNull AbstractProject findNearest String name return findNearest name Jenkins getInstance public static CheckForNull AbstractProject findNearest String name ItemGroup context return Items findNearest AbstractProject class name context private static final Comparator Integer REVERSE INTEGER COMPARATOR new Comparator Integer public int compare Integer o1 Integer o2 return o2 o1 private static final Logger LOGGER Logger getLogger AbstractProject class getName Deprecated public static final Permission ABORT CANCEL Deprecated public static final Message AbstractProject BUILD NOW TEXT new Message AbstractProject CLIResolver public static AbstractProject resolveForCLI Argument required true metaVar NAME usage Job name String name throws CmdLineException AbstractProject item Jenkins getInstance getItemByFullName name AbstractProject class if item null AbstractProject project AbstractProject findNearest name throw new CmdLineException null project null Messages AbstractItem NoSuchJobExistsWithoutSuggestion name Messages AbstractItem NoSuchJobExists name project getFullName return item public String getCustomWorkspace return customWorkspace public void setCustomWorkspace String customWorkspace throws IOException this customWorkspace Util fixEmptyAndTrim customWorkspace save public static abstract class LabelValidator implements ExtensionPoint Nonnull public abstract FormValidation check Nonnull AbstractProject project Nonnull Label labelpackage hudson cli handlers import hudson model AbstractProject import org kohsuke args4j CmdLineParser import org kohsuke args4j OptionDef import org kohsuke args4j spi Setter import org kohsuke MetaInfServices import org kohsuke args4j spi OptionHandler MetaInfServices OptionHandler class SuppressWarnings rawtypes public class AbstractProjectOptionHandler extends GenericItemOptionHandler AbstractProject public AbstractProjectOptionHandler CmdLineParser parser OptionDef option Setter AbstractProject setter super parser option setter Override protected Class AbstractProject type return AbstractProject class Override public String getDefaultMetaVariable return JOBpackage hudson model queue import hudson model Queue BuildableItem import java util Collections import java util Comparator import java util List public abstract class AbstractQueueSorterImpl extends QueueSorter implements Comparator BuildableItem Override public void sortBuildableItems List BuildableItem buildables Collections sort buildables this sort is ascending order public int compare BuildableItem lhs BuildableItem rhs return compare lhs buildableStartMilliseconds rhs buildableStartMilliseconds protected static int compare long a long b if a b return 1 if a b return 1 return 0 protected static int compare int a int b if a b return 1 if a b return 1 return 0package hudson model queue import hudson model Queue import hudson model Queue Task import hudson security ACL import hudson security AccessControlled import org acegisecurity Authentication import javax annotation Nonnull import java util Collection import java util Collections public abstract class AbstractQueueTask implements Queue Task public Collection extends SubTask getSubTasks return Collections singleton this public final Task getOwnerTask return this public boolean isConcurrentBuild return false public CauseOfBlockage getCauseOfBlockage return null public Object getSameNodeConstraint return null Nonnull public Authentication getDefaultAuthentication return ACL SYSTEM Nonnull Override public Authentication getDefaultAuthentication Queue Item item return getDefaultAuthenticationpackage hudson scm import hudson model AbstractBuild import hudson model TaskAction import hudson model BuildBadgeAction import hudson model Run import hudson security Permission import hudson security ACL import org kohsuke stapler StaplerRequest import org kohsuke stapler StaplerResponse import javax servlet ServletException import java io IOException import jenkins model RunAction2 public abstract class AbstractScmTagAction extends TaskAction implements BuildBadgeAction RunAction2 private transient Run run Deprecated protected transient AbstractBuild build protected AbstractScmTagAction Run run this run run this build run instanceof AbstractBuild AbstractBuild run null Deprecated protected AbstractScmTagAction AbstractBuild build this Run build public final String getUrlName to make this consistent with CVSSCM even though the name is bit off return tagBuild protected Permission getPermission return SCM TAG public Run getRun return run Deprecated public AbstractBuild getBuild return build public String getTooltip return null public abstract boolean isTagged protected ACL getACL return run getACL public void doIndex StaplerRequest req StaplerResponse rsp throws IOException ServletException req getView this chooseAction forward req rsp protected synchronized String chooseAction if workerThread null return inProgress jelly return tagForm jelly Override public void onAttached Run r unnecessary constructor already does this Override public void onLoad Run r run r build run instanceof AbstractBuild AbstractBuild run nullpackage hudson model public abstract class AbstractStatusIcon implements StatusIconpackage hudson model queue import hudson model Label import hudson model Node import hudson model ResourceList public abstract class AbstractSubTask implements SubTask public Label getAssignedLabel return null public Node getLastBuiltOn return null public long getEstimatedDuration return 1 public Object getSameNodeConstraint return null public ResourceList getResourceList return ResourceList EMPTYpackage hudson util import hudson console HyperlinkNote import hudson model TaskListener import java io IOException public abstract class AbstractTaskListener implements TaskListener public void hyperlink String url String text throws IOException annotate new HyperlinkNote url text length getLogger print textpackage jenkins model import hudson model AbstractItem import hudson model ItemGroup import hudson model Job import hudson model TopLevelItem import hudson model TopLevelItemDescriptor import java util Collection import java util Collections public abstract class AbstractTopLevelItem extends AbstractItem implements TopLevelItem protected AbstractTopLevelItem ItemGroup parent String name super parent name Override public Collection extends Job getAllJobs return Collections emptySet public TopLevelItemDescriptor getDescriptor return TopLevelItemDescriptor Jenkins getInstance getDescriptorOrDie getClasspackage hudson security import javax annotation Nonnull import org acegisecurity AccessDeniedException public interface AccessControlled Nonnull ACL getACL void checkPermission Nonnull Permission permission throws AccessDeniedException boolean hasPermission Nonnull Permission permissionpackage hudson security import org acegisecurity AccessDeniedException import org acegisecurity Authentication import org acegisecurity GrantedAuthority import javax servlet http HttpServletResponse import java io PrintWriter public class AccessDeniedException2 extends AccessDeniedException public final Authentication authentication public final Permission permission public AccessDeniedException2 Authentication authentication Permission permission this null authentication permission public AccessDeniedException2 Throwable t Authentication authentication Permission permission super Messages AccessDeniedException2 MissingPermission authentication getName permission group title permission name t this authentication authentication this permission permission public void reportAsHeaders HttpServletResponse rsp rsp addHeader X You Are Authenticated As authentication getName for GrantedAuthority auth authentication getAuthorities rsp addHeader X You Are In Group auth getAuthority rsp addHeader X Required Permission permission getId for Permission p permission impliedBy p null p p impliedBy rsp addHeader X Permission Implied By p getId public void report PrintWriter w w println You are authenticated as authentication getName w println Groups that you are in for GrantedAuthority auth authentication getAuthorities w println auth getAuthority w println Permission you need to have but didn t permission getId for Permission p permission impliedBy p null p p impliedBy w println which is implied by p getIdpackage hudson security import jenkins model Jenkins import org acegisecurity AccessDeniedException import org acegisecurity ui AccessDeniedHandler import org kohsuke stapler WebApp import javax servlet ServletException import javax servlet ServletRequest import javax servlet ServletResponse import javax servlet http HttpServletRequest import javax servlet http HttpServletResponse import java io IOException public class AccessDeniedHandlerImpl implements AccessDeniedHandler public void handle ServletRequest request ServletResponse response AccessDeniedException cause throws IOException ServletException HttpServletRequest req HttpServletRequest request HttpServletResponse rsp HttpServletResponse response rsp setStatus HttpServletResponse SC FORBIDDEN req setAttribute exception cause if cause instanceof AccessDeniedException2 AccessDeniedException2 cause reportAsHeaders rsp WebApp get Jenkins getInstance servletContext getSomeStapler invoke req rsp Jenkins getInstance accessDeniedpackage com twitter sdk android core services import com twitter sdk android core models User import retrofit2 Call import retrofit2 http GET import retrofit2 http Query public interface AccountService GET 1 1 account verify credentials json Call User verifyCredentials Query include entities Boolean includeEntities Query skip status Boolean skipStatuspackage hudson security import hudson model User import javax annotation CheckForNull import javax annotation Nonnull import hudson model Item import hudson remoting Callable import hudson model ItemGroup import hudson model TopLevelItemDescriptor import jenkins security NonSerializableSecurityContext import jenkins model Jenkins import jenkins security NotReallyRoleSensitiveCallable import org acegisecurity AccessDeniedException import org acegisecurity Authentication import org acegisecurity context SecurityContext import org acegisecurity context SecurityContextHolder import org acegisecurity providers UsernamePasswordAuthenticationToken import org acegisecurity acls sid PrincipalSid import org acegisecurity acls sid Sid import org kohsuke accmod Restricted import org kohsuke accmod restrictions NoExternalUse public abstract class ACL public final void checkPermission Nonnull Permission p Authentication a Jenkins getAuthentication if hasPermission a p throw new AccessDeniedException2 a p public final boolean hasPermission Nonnull Permission p return hasPermission Jenkins getAuthentication p public abstract boolean hasPermission Nonnull Authentication a Nonnull Permission permission public final void checkCreatePermission Nonnull ItemGroup c Nonnull TopLevelItemDescriptor d Authentication a Jenkins getAuthentication if hasCreatePermission a c d throw new AccessDeniedException Messages AccessDeniedException2 MissingPermission a getName Item CREATE group title Item CREATE name Item CREATE d getDisplayName public boolean hasCreatePermission Nonnull Authentication a Nonnull ItemGroup c Nonnull TopLevelItemDescriptor d return true Sid constants public static final Sid EVERYONE new Sid Override public String toString return EVERYONE Restricted NoExternalUse class public static final String ANONYMOUS USERNAME anonymous public static final Sid ANONYMOUS new PrincipalSid ANONYMOUS USERNAME protected static final Sid AUTOMATIC SIDS new Sid EVERYONE ANONYMOUS Restricted NoExternalUse class public static final String SYSTEM USERNAME SYSTEM public static final Authentication SYSTEM new UsernamePasswordAuthenticationToken SYSTEM USERNAME SYSTEM Deprecated public static Nonnull SecurityContext impersonate Nonnull Authentication auth SecurityContext old SecurityContextHolder getContext SecurityContextHolder setContext new NonSerializableSecurityContext auth return old Deprecated public static void impersonate Nonnull Authentication auth Nonnull Runnable body SecurityContext old impersonate auth try body run finally SecurityContextHolder setContext old Deprecated public static V T extends Exception V impersonate Authentication auth Callable V T body throws T SecurityContext old impersonate auth try return body call finally SecurityContextHolder setContext old Nonnull public static ACLContext as Nonnull Authentication auth final ACLContext context new ACLContext SecurityContextHolder getContext SecurityContextHolder setContext new NonSerializableSecurityContext auth return context Nonnull public static ACLContext as CheckForNull User user return as user null Jenkins ANONYMOUS user impersonatepackage hudson security import javax annotation CheckForNull import javax annotation Nonnull import org acegisecurity Authentication import org acegisecurity context SecurityContext import org acegisecurity context SecurityContextHolder public class ACLContext implements AutoCloseable Nonnull private final SecurityContext previousContext ACLContext Nonnull SecurityContext previousContext this previousContext previousContext Nonnull public SecurityContext getPreviousContext return previousContext Override public void close SecurityContextHolder setContext previousContextpackage hudson model import hudson Functions import javax annotation CheckForNull public interface Action extends ModelObject CheckForNull String getIconFileName CheckForNull String getDisplayName CheckForNull String getUrlNamepackage hudson model import hudson ExtensionList import hudson Util import java util ArrayList import java util Collection import java util Collections import java util List import java util concurrent CopyOnWriteArrayList import java util logging Level import java util logging Logger import jenkins model ModelObjectWithContextMenu import jenkins model TransientActionFactory import org kohsuke stapler StaplerRequest import org kohsuke stapler StaplerResponse import org kohsuke stapler export Exported import org kohsuke stapler export ExportedBean ExportedBean public abstract class Actionable extends AbstractModelObject implements ModelObjectWithContextMenu private volatile CopyOnWriteArrayList Action actions Deprecated public List Action getActions if actions null synchronized this if actions null actions new CopyOnWriteArrayList Action return actions Exported name actions public final List extends Action getAllActions List Action actions new ArrayList Action getActions for TransientActionFactory taf ExtensionList lookup TransientActionFactory class if taf type isInstance this try actions addAll createFor taf catch Exception e LOGGER log Level SEVERE Could not load actions from taf for this e return Collections unmodifiableList actions private T Collection extends Action createFor TransientActionFactory T taf return taf createFor taf type cast this public T extends Action List T getActions Class T type return Util filter getAllActions type public void addAction Action a if a null throw new IllegalArgumentException getActions add a public void replaceAction Action a CopyOnWriteArrayList does not support Iterator remove so need to do it this way List Action old new ArrayList Action 1 List Action current getActions for Action a2 current if a2 getClass a getClass old add a2 current removeAll old addAction a Deprecated public Action getAction int index if actions null return null return actions get index public T extends Action T getAction Class T type for Action a getAllActions if type isInstance a return type cast a return null public Object getDynamic String token StaplerRequest req StaplerResponse rsp for Action a getAllActions if a null continue be defensive String urlName a getUrlName if urlName null continue if urlName equals token return a return null Override public ContextMenu doContextMenu StaplerRequest request StaplerResponse response throws Exception return new ContextMenu from this request response private static final Logger LOGGER Logger getLogger Actionable class getNamepackage com kaku colorfulnews di component import android app Activity import android content Context import com kaku colorfulnews di module ActivityModule import com kaku colorfulnews di scope ContextLife import com kaku colorfulnews di scope PerActivity import com kaku colorfulnews mvp ui activities NewsActivity import com kaku colorfulnews mvp ui activities NewsChannelActivity import com kaku colorfulnews mvp ui activities NewsDetailActivity import com kaku colorfulnews mvp ui activities NewsPhotoDetailActivity import com kaku colorfulnews mvp ui activities PhotoActivity import com kaku colorfulnews mvp ui activities PhotoDetailActivity import dagger Component PerActivity Component dependencies ApplicationComponent class modules ActivityModule class public interface ActivityComponent ContextLife Activity Context getActivityContext ContextLife Application Context getApplicationContext Activity getActivity void inject NewsActivity newsActivity void inject NewsDetailActivity newsDetailActivity void inject NewsChannelActivity newsChannelActivity void inject NewsPhotoDetailActivity newsPhotoDetailActivity void inject PhotoActivity photoActivity void inject PhotoDetailActivity photoDetailActivitypackage com zxy recovery core import android app Activity import android content Intent import android text TextUtils import com zxy recovery tools RecoveryLog import com zxy recovery tools RecoveryUtil import java lang reflect InvocationHandler import java lang reflect Method class ActivityManagerDelegate implements InvocationHandler private Object mBaseActivityManagerProxy ActivityManagerDelegate Object o this mBaseActivityManagerProxy o Override public Object invoke Object proxy Method method Object args throws Throwable String methodName method getName switch methodName case finishActivity case finishActivityAffinity Class extends Activity clazz Recovery getInstance getMainPageClass if clazz null break int count ActivityStackCompat getActivityCount Recovery getInstance getContext String baseActivityName ActivityStackCompat getBaseActivityName Recovery getInstance getContext if TextUtils isEmpty baseActivityName break RecoveryLog e currentActivityCount count RecoveryLog e baseActivityName baseActivityName if count 1 clazz getName equals baseActivityName Intent intent new Intent Recovery getInstance getContext clazz intent addFlags Intent FLAG ACTIVITY NEW TASK Intent FLAG ACTIVITY CLEAR TASK if RecoveryUtil isIntentAvailable Recovery getInstance getContext intent Recovery getInstance getContext startActivity intent break default break return method invoke mBaseActivityManagerProxy argspackage com kaku colorfulnews di module import android app Activity import android content Context import com kaku colorfulnews di scope ContextLife import com kaku colorfulnews di scope PerActivity import dagger Module import dagger Provides Module public class ActivityModule private Activity mActivity public ActivityModule Activity activity mActivity activity Provides PerActivity ContextLife Activity public Context ProvideActivityContext return mActivity Provides PerActivity public Activity ProvideActivity return mActivitypackage com zxy recovery core import android app ActivityManager import android content ComponentName import android content Context import android os Build import java util List public class ActivityStackCompat private static ActivityManager AppTask getTopTaskAfterL Context context ActivityManager activityManager ActivityManager context getSystemService Context ACTIVITY SERVICE if Build VERSION SDK INT Build VERSION CODES LOLLIPOP return activityManager getAppTasks get 0 return null private static ActivityManager RunningTaskInfo getTopTaskBeforeL Context context ActivityManager activityManager ActivityManager context getSystemService Context ACTIVITY SERVICE List ActivityManager RunningTaskInfo tasks null try if Build VERSION SDK INT Build VERSION CODES LOLLIPOP tasks activityManager getRunningTasks 1 catch Exception e return null if tasks null tasks size 0 return null return tasks get 0 public static int getActivityCount Context context if Build VERSION SDK INT Build VERSION CODES LOLLIPOP ActivityManager AppTask appTask getTopTaskAfterL context if appTask null return 0 if Build VERSION SDK INT Build VERSION CODES M return appTask getTaskInfo numActivities else or mActivities return RecoveryStore getInstance getRunningActivityCount else ActivityManager RunningTaskInfo taskInfo getTopTaskBeforeL context if taskInfo null return 0 return taskInfo numActivities public static String getBaseActivityName Context context if Build VERSION SDK INT Build VERSION CODES LOLLIPOP ActivityManager AppTask appTask getTopTaskAfterL context if appTask null return null if Build VERSION SDK INT Build VERSION CODES M return appTask getTaskInfo baseActivity getClassName else ComponentName componentName RecoveryStore getInstance getBaseActivity return componentName null null componentName getClassName else ActivityManager RunningTaskInfo taskInfo getTopTaskBeforeL context if taskInfo null return null return taskInfo baseActivity getClassNamepackage hudson util import java util Iterator public abstract class AdaptedIterator T U implements Iterator U private final Iterator extends T core protected AdaptedIterator Iterator extends T core this core core protected AdaptedIterator Iterable extends T core this core iterator public boolean hasNext return core hasNext public U next return adapt core next protected abstract U adapt T item public void remove core removepackage hudson cli import java util List import hudson Extension import hudson model TopLevelItem import hudson model DirectlyModifiableView import hudson model View import org kohsuke args4j Argument Extension public class AddJobToViewCommand extends CLICommand Argument usage Name of the view required true index 0 private View view Argument usage Job names required true index 1 private List TopLevelItem jobs Override public String getShortDescription return Messages AddJobToViewCommand ShortDescription Override protected int run throws Exception view checkPermission View CONFIGURE if view instanceof DirectlyModifiableView throw new IllegalStateException view getDisplayName view can not be modified directly for TopLevelItem job jobs DirectlyModifiableView view add job return 0package jenkins security s2m import hudson Extension import hudson FilePath import hudson model AdministrativeMonitor import hudson remoting Callable import jenkins model Jenkins import org jenkinsci Symbol import org kohsuke stapler HttpResponse import org kohsuke stapler HttpResponses import org kohsuke stapler QueryParameter import javax inject Inject import java io IOException Extension Symbol slaveToMasterAccessControl public class AdminCallableMonitor extends AdministrativeMonitor Inject Jenkins jenkins Inject AdminWhitelistRule rule public AdminCallableMonitor super slaveToMasterAccessControl Override public boolean isActivated return rule rejected describe isEmpty Override public String getDisplayName return Messages AdminCallableMonitor DisplayName bind this to URL public AdminWhitelistRule getRule return rule public HttpResponse doAct QueryParameter String dismiss throws IOException if dismiss null disable true return HttpResponses redirectViaContextPath manage else return HttpResponses redirectTo rule public HttpResponse doIndex return HttpResponses redirectTo rulepackage jenkins security s2m import hudson Extension import hudson remoting Callable import org jenkinsci Symbol import org jenkinsci remoting Role import org jenkinsci remoting RoleSensitive import javax inject Inject import java util Collection Extension ordinal 100 Symbol admin public class AdminCallableWhitelist extends CallableWhitelist Inject AdminWhitelistRule rule Override public boolean isWhitelisted RoleSensitive subject Collection Role expected Object context return rule isWhitelisted subject expected contextpackage jenkins security s2m import hudson Extension import hudson remoting ChannelBuilder import jenkins FilePathFilter import jenkins ReflectiveFilePathFilter import jenkins security ChannelConfigurator import javax annotation Nullable import javax inject Inject import java io File public class AdminFilePathFilter extends ReflectiveFilePathFilter private final AdminWhitelistRule rule public AdminFilePathFilter AdminWhitelistRule rule this rule rule Override protected boolean op String op File path throws SecurityException return rule checkFileAccess op path Extension public static class ChannelConfiguratorImpl extends ChannelConfigurator Inject AdminWhitelistRule rule Override public void onChannelBuilding ChannelBuilder builder Nullable Object context new AdminFilePathFilter rule installTo builder ORDINAL public static final double ORDINAL 100package hudson util import hudson model AdministrativeMonitor import hudson Extension public class AdministrativeError extends AdministrativeMonitor public final String message public final String title public final Throwable details public AdministrativeError String id String title String message Throwable details super id this message message this title title this details details all add this public boolean isActivated return truepackage hudson model import hudson ExtensionPoint import hudson ExtensionList import hudson Extension import hudson ExtensionPoint LegacyInstancesAreScopedToHudson import hudson triggers SCMTrigger import java util Set import java io IOException import jenkins model Jenkins import org kohsuke stapler StaplerRequest import org kohsuke stapler StaplerResponse LegacyInstancesAreScopedToHudson public abstract class AdministrativeMonitor extends AbstractModelObject implements ExtensionPoint public final String id protected AdministrativeMonitor String id this id id protected AdministrativeMonitor this id this getClass getName public String getUrl return administrativeMonitor id public String getDisplayName return id public final String getSearchUrl return getUrl public void disable boolean value throws IOException AbstractCIBase hudson Jenkins getInstance Set String set hudson disabledAdministrativeMonitors if value set add id else set remove id hudson save public boolean isEnabled return AbstractCIBase Jenkins getInstance disabledAdministrativeMonitors contains id public abstract boolean isActivated public void doDisable StaplerRequest req StaplerResponse rsp throws IOException Jenkins getInstance checkPermission Jenkins ADMINISTER disable true rsp sendRedirect2 req getContextPath manage public static ExtensionList AdministrativeMonitor all return ExtensionList lookup AdministrativeMonitor classpackage jenkins management import hudson Extension import hudson model AdministrativeMonitor import jenkins model GlobalConfiguration import net sf json JSONObject import org kohsuke accmod Restricted import org kohsuke accmod restrictions NoExternalUse import org kohsuke stapler StaplerRequest import java io IOException import java util logging Level import java util logging Logger Extension Restricted NoExternalUse class public class AdministrativeMonitorsConfiguration extends GlobalConfiguration Override public boolean configure StaplerRequest req JSONObject json throws FormException for AdministrativeMonitor am AdministrativeMonitor all try boolean disable json getJSONArray administrativeMonitor contains am id am disable disable catch IOException e LOGGER log Level WARNING Failed to process form submission for am id e return true private static Logger LOGGER Logger getLogger AdministrativeMonitorsConfiguration class getNamepackage jenkins management import hudson Extension import hudson Functions import hudson diagnosis ReverseProxySetupMonitor import hudson model AdministrativeMonitor import hudson model PageDecorator import hudson util HttpResponses import hudson util HudsonIsLoading import hudson util HudsonIsRestarting import jenkins model Jenkins import net sf json JSON import net sf json JSONObject import org kohsuke accmod Restricted import org kohsuke accmod restrictions NoExternalUse import org kohsuke stapler Ancestor import org kohsuke stapler HttpResponse import org kohsuke stapler Stapler import org kohsuke stapler StaplerRequest import javax servlet ServletException import java io IOException import java util ArrayList import java util Collection import java util List Extension Restricted NoExternalUse class public class AdministrativeMonitorsDecorator extends PageDecorator private final Collection String ignoredJenkinsRestOfUrls new ArrayList public AdministrativeMonitorsDecorator redundant ignoredJenkinsRestOfUrls add manage otherwise this would be added to every internal context menu building request ignoredJenkinsRestOfUrls add contextMenu don t show here to allow admins to disable malfunctioning monitors via AdministrativeMonitorsDecorator ignoredJenkinsRestOfUrls add configure Override public String getDisplayName return Messages AdministrativeMonitorsDecorator DisplayName public int getActiveAdministrativeMonitorsCount return getActiveAdministrativeMonitors size public Collection AdministrativeMonitor getActiveAdministrativeMonitors Collection AdministrativeMonitor active new ArrayList Collection AdministrativeMonitor ams new ArrayList Jenkins getInstance administrativeMonitors for AdministrativeMonitor am ams if am instanceof ReverseProxySetupMonitor TODO make reverse proxy monitor work when shown on any URL continue if am isEnabled am isActivated active add am return active public boolean shouldDisplay throws IOException ServletException if Functions hasPermission Jenkins ADMINISTER return false StaplerRequest req Stapler getCurrentRequest if req null return false List Ancestor ancestors req getAncestors if ancestors null ancestors size 0 return false Ancestor a ancestors get ancestors size 1 Object o a getObject don t show while Jenkins is loading if o instanceof HudsonIsLoading return false or restarting if o instanceof HudsonIsRestarting return false don t show for some URLs served directly by Jenkins if o instanceof Jenkins String url a getRestOfUrl if ignoredJenkinsRestOfUrls contains url return false if getActiveAdministrativeMonitorsCount 0 return false return truepackage jenkins security s2m import hudson Extension import hudson FilePath import hudson Functions import hudson Util import hudson util HttpResponses import jenkins model Jenkins import jenkins util io FileBoolean import org apache commons io FileUtils import org jenkinsci remoting Role import org jenkinsci remoting RoleSensitive import org kohsuke stapler HttpResponse import org kohsuke stapler QueryParameter import org kohsuke stapler StaplerProxy import org kohsuke stapler StaplerRequest import org kohsuke stapler interceptor RequirePOST import java io BufferedReader import java io ByteArrayInputStream import java io ByteArrayOutputStream import java io File import java io IOException import java io InputStream import java io InputStreamReader import java io PrintStream import java util Collection import java util Enumeration import java util logging Logger import static java util logging Level Extension public class AdminWhitelistRule implements StaplerProxy public final CallableRejectionConfig rejected public final CallableWhitelistConfig whitelisted public final FilePathRuleConfig filePathRules private final Jenkins jenkins private boolean masterKillSwitch public AdminWhitelistRule throws IOException InterruptedException this jenkins Jenkins getInstance while this file is not a secret write access to this file is dangerous so put this in the better protected part of JENKINS HOME which is in secrets overwrite 30 default conf with what we think is the best from the core this file shouldn t be touched by anyone For local customization use other files in the conf dir 0 byte file is used as a signal from the admin to prevent this overwriting placeDefaultRule new File jenkins getRootDir secrets whitelisted callables d default conf getClass getResourceAsStream callable conf placeDefaultRule new File jenkins getRootDir secrets filepath filters d 30 default conf transformForWindows getClass getResourceAsStream filepath filter conf this whitelisted new CallableWhitelistConfig new File jenkins getRootDir secrets whitelisted callables d gui conf this rejected new CallableRejectionConfig new File jenkins getRootDir secrets rejected callables txt whitelisted this filePathRules new FilePathRuleConfig new File jenkins getRootDir secrets filepath filters d 50 gui conf this masterKillSwitch loadMasterKillSwitchFile private boolean loadMasterKillSwitchFile File f getMasterKillSwitchFile try if f exists return true return Boolean parseBoolean FileUtils readFileToString f trim catch IOException e LOGGER log WARNING Failed to read f e return false private File getMasterKillSwitchFile return new File jenkins getRootDir secrets slave to master security kill switch private InputStream transformForWindows InputStream src throws IOException BufferedReader r new BufferedReader new InputStreamReader src ByteArrayOutputStream out new ByteArrayOutputStream try PrintStream p new PrintStream out String line while line r readLine null if line startsWith Functions isWindows line line replace p println line return new ByteArrayInputStream out toByteArray private void placeDefaultRule File f InputStream src throws IOException InterruptedException try new FilePath f copyFrom src catch IOException e we allow admins to create a read only file here to block overwrite so this can fail legitimately if f canWrite return LOGGER log WARNING Failed to generate f e public boolean isWhitelisted RoleSensitive subject Collection Role expected Object context if masterKillSwitch return true master kill switch is on subsystem deactivated String name subject getClass getName if whitelisted contains name return true whitelisted by admin otherwise record the problem and refuse to execute that rejected report subject getClass return false public boolean checkFileAccess String op File f if the master kill switch is off we allow everything if masterKillSwitch return true return filePathRules checkFileAccess op f RequirePOST public HttpResponse doSubmit StaplerRequest req throws IOException jenkins checkPermission Jenkins RUN SCRIPTS String whitelist Util fixNull req getParameter whitelist if whitelist endsWith n whitelist n Enumeration e req getParameterNames while e hasMoreElements String name String e nextElement if name startsWith class whitelist name substring 6 n whitelisted set whitelist String newRules Util fixNull req getParameter filePathRules filePathRules parseTest newRules test first before writing a potentially broken rules filePathRules set newRules return HttpResponses redirectToDot RequirePOST public HttpResponse doApproveAll throws IOException StringBuilder buf new StringBuilder for Class c rejected get buf append c getName append n whitelisted append buf toString return HttpResponses ok RequirePOST public HttpResponse doApprove QueryParameter String value throws IOException whitelisted append value return HttpResponses ok public boolean getMasterKillSwitch return masterKillSwitch public void setMasterKillSwitch boolean state try jenkins checkPermission Jenkins RUN SCRIPTS FileUtils writeStringToFile getMasterKillSwitchFile Boolean toString state treat the file as the canonical source of information in case write fails masterKillSwitch loadMasterKillSwitchFile catch IOException e LOGGER log WARNING Failed to write master kill switch e Override public Object getTarget jenkins checkPermission Jenkins RUN SCRIPTS return this private static final Logger LOGGER Logger getLogger AdminWhitelistRule class getNamepackage hudson util jna import com sun jna Structure import com sun jna Native import com sun jna WString import com sun jna Pointer import com sun jna win32 StdCallLibrary import com sun jna ptr PointerByReference import com sun jna ptr IntByReference import java util Arrays import java util List public interface Advapi32 extends StdCallLibrary Advapi32 INSTANCE Advapi32 Native loadLibrary Advapi32 Advapi32 class Options UNICODE OPTIONS boolean GetUserName char buffer IntByReference lpnSize boolean LookupAccountName String lpSystemName String lpAccountName byte Sid IntByReference cbSid char ReferencedDomainName IntByReference cchReferencedDomainName PointerByReference peUse boolean LookupAccountSid String lpSystemName byte Sid char lpName IntByReference cchName char ReferencedDomainName IntByReference cchReferencedDomainName PointerByReference peUse boolean ConvertSidToStringSid byte Sid PointerByReference StringSid boolean ConvertStringSidToSid String StringSid PointerByReference Sid Pointer OpenSCManager String lpMachineName WString lpDatabaseName int dwDesiredAccess boolean CloseServiceHandle Pointer hSCObject Pointer OpenService Pointer hSCManager String lpServiceName int dwDesiredAccess boolean StartService Pointer hService int dwNumServiceArgs char lpServiceArgVectors boolean ControlService Pointer hService int dwControl SERVICE STATUS lpServiceStatus boolean StartServiceCtrlDispatcher Structure lpServiceTable Pointer RegisterServiceCtrlHandler String lpServiceName Handler lpHandlerProc Pointer RegisterServiceCtrlHandlerEx String lpServiceName HandlerEx lpHandlerProc Pointer lpContext boolean SetServiceStatus Pointer hServiceStatus SERVICE STATUS lpServiceStatus Pointer CreateService Pointer hSCManager String lpServiceName String lpDisplayName int dwDesiredAccess int dwServiceType int dwStartType int dwErrorControl String lpBinaryPathName String lpLoadOrderGroup IntByReference lpdwTagId String lpDependencies String lpServiceStartName String lpPassword boolean DeleteService Pointer hService boolean ChangeServiceConfig2 Pointer hService int dwInfoLevel ChangeServiceConfig2Info lpInfo int RegOpenKeyEx int hKey String lpSubKey int ulOptions int samDesired IntByReference phkResult int RegQueryValueEx int hKey String lpValueName IntByReference lpReserved IntByReference lpType byte lpData IntByReference lpcbData int RegCloseKey int hKey int RegDeleteValue int hKey String lpValueName int RegSetValueEx int hKey String lpValueName int Reserved int dwType byte lpData int cbData int RegCreateKeyEx int hKey String lpSubKey int Reserved String lpClass int dwOptions int samDesired WINBASE SECURITY ATTRIBUTES lpSecurityAttributes IntByReference phkResult IntByReference lpdwDisposition int RegDeleteKey int hKey String name int RegEnumKeyEx int hKey int dwIndex char lpName IntByReference lpcName IntByReference reserved char lpClass IntByReference lpcClass WINBASE FILETIME lpftLastWriteTime int RegEnumValue int hKey int dwIndex char lpValueName IntByReference lpcchValueName IntByReference reserved IntByReference lpType byte lpData IntByReference lpcbData interface SERVICE MAIN FUNCTION extends StdCallCallback void callback int dwArgc Pointer lpszArgv interface Handler extends StdCallCallback void callback int fdwControl interface HandlerEx extends StdCallCallback int callback int dwControl int dwEventType Pointer lpEventData Pointer lpContext class SERVICE STATUS extends Structure public int dwServiceType public int dwCurrentState public int dwControlsAccepted public int dwWin32ExitCode public int dwServiceSpecificExitCode public int dwCheckPoint public int dwWaitHint Override protected List getFieldOrder return Arrays asList dwServiceType dwCurrentState dwControlsAccepted dwWin32ExitCode dwServiceSpecificExitCode dwCheckPoint dwWaitHint class SERVICE TABLE ENTRY extends Structure public String lpServiceName public SERVICE MAIN FUNCTION lpServiceProc Override protected List getFieldOrder return Arrays asList new String lpServiceName lpServiceProc class ChangeServiceConfig2Info extends Structure Override protected List getFieldOrder return Arrays asList new String class SERVICE DESCRIPTION extends ChangeServiceConfig2Info public String lpDescriptionpackage jenkins import hudson Extension import hudson ExtensionList import hudson ExtensionPoint import hudson TcpSlaveAgentListener import java io IOException import java net Socket import java util Set import jenkins model Jenkins public abstract class AgentProtocol implements ExtensionPoint public boolean isOptIn return false public boolean isRequired return false public abstract String getName public String getDisplayName return getName public abstract void handle Socket socket throws IOException InterruptedException public static ExtensionList AgentProtocol all return ExtensionList lookup AgentProtocol class public static AgentProtocol of String protocolName for AgentProtocol p all String n p getName if n null n equals protocolName return p return nullpackage hudson model import org jenkinsci Symbol import org kohsuke stapler DataBoundConstructor import org kohsuke stapler Stapler import org kohsuke stapler StaplerRequest import org kohsuke stapler StaplerResponse import javax servlet ServletException import java io IOException import java util Collection import hudson model Descriptor FormException import hudson Extension import org kohsuke stapler interceptor RequirePOST public class AllView extends View DataBoundConstructor public AllView String name super name public AllView String name ViewGroup owner this name this owner owner Override public boolean isEditable return false Override public boolean contains TopLevelItem item return true RequirePOST Override public Item doCreateItem StaplerRequest req StaplerResponse rsp throws IOException ServletException ItemGroup extends TopLevelItem ig getOwnerItemGroup if ig instanceof ModifiableItemGroup return ModifiableItemGroup extends TopLevelItem ig doCreateItem req rsp return null Override public Collection TopLevelItem getItems return Collection getOwnerItemGroup getItems Override public String getPostConstructLandingPage return there s no configuration page Override protected void submit StaplerRequest req throws IOException ServletException FormException noop Extension Symbol all public static final class DescriptorImpl extends ViewDescriptor Override public boolean isInstantiable for View v Stapler getCurrentRequest findAncestorObject ViewGroup class getViews if v instanceof AllView return false return true public String getDisplayName return Messages Hudson ViewNamepackage hudson util import hudson Extension import hudson ExtensionList import hudson ExtensionPoint import hudson model AbstractProject public abstract class AlternativeUiTextProvider implements ExtensionPoint public abstract T String getText Message T text T context public static ExtensionList AlternativeUiTextProvider all return ExtensionList lookup AlternativeUiTextProvider class public static T String get Message T text T context String defaultValue String s get text context return s null s defaultValue public static T String get Message T text T context for AlternativeUiTextProvider p all String s p getText text context if s null return s return null public static final class Message T decided not to retain T as Class so that we can have Message List Foo for example SuppressWarnings unchecked public T cast Object context return T contextpackage com twitter sdk android tweetui internal import android animation Animator import android animation AnimatorListenerAdapter import android view View import android view ViewPropertyAnimator class AnimationUtils public static ViewPropertyAnimator fadeOut final View from int duration if from getVisibility View VISIBLE from clearAnimation final ViewPropertyAnimator animator from animate animator alpha 0f setDuration duration setListener new AnimatorListenerAdapter Override public void onAnimationEnd Animator animation from setVisibility View INVISIBLE from setAlpha 1f return animator return null public static ViewPropertyAnimator fadeIn View to int duration if to getVisibility View VISIBLE to setAlpha 0f to setVisibility View VISIBLE to clearAnimation final ViewPropertyAnimator animator to animate animator alpha 1f setDuration duration setListener null return animatorpackage hudson console import com trilead ssh2 crypto Base64 import jenkins model Jenkins import hudson remoting ObjectInputStreamEx import hudson util TimeUnit2 import jenkins security CryptoConfidentialKey import org apache commons io output ByteArrayOutputStream import org kohsuke stapler Stapler import org kohsuke stapler StaplerRequest import org kohsuke stapler StaplerResponse import org kohsuke stapler framework io ByteBuffer import org kohsuke stapler framework io LargeText import javax crypto Cipher import javax crypto CipherInputStream import javax crypto CipherOutputStream import java io ByteArrayInputStream import java io File import java io IOException import java io ObjectInputStream import java io ObjectOutputStream import java io OutputStream import java io Writer import java nio charset Charset import com jcraft jzlib GZIPInputStream import com jcraft jzlib GZIPOutputStream import static java lang Math abs public class AnnotatedLargeText T extends LargeText private T context public AnnotatedLargeText File file Charset charset boolean completed T context super file charset completed true this context context public AnnotatedLargeText ByteBuffer memory Charset charset boolean completed T context super memory charset completed this context context public void doProgressiveHtml StaplerRequest req StaplerResponse rsp throws IOException req setAttribute html true doProgressText req rsp public void doProgressiveText StaplerRequest req StaplerResponse rsp throws IOException doProgressText req rsp private boolean isHtml StaplerRequest req Stapler getCurrentRequest return req null req getAttribute html null Override protected void setContentType StaplerResponse rsp rsp setContentType isHtml text html charset UTF 8 text plain charset UTF 8 private ConsoleAnnotator createAnnotator StaplerRequest req throws IOException try String base64 req null req getHeader X ConsoleAnnotator null if base64 null Cipher sym PASSING ANNOTATOR decrypt ObjectInputStream ois new ObjectInputStreamEx new GZIPInputStream new CipherInputStream new ByteArrayInputStream Base64 decode base64 toCharArray sym Jenkins getInstance pluginManager uberClassLoader try long timestamp ois readLong if TimeUnit2 HOURS toMillis 1 abs System currentTimeMillis timestamp don t deserialize something too old to prevent a replay attack return ConsoleAnnotator ois readObject finally ois close catch ClassNotFoundException e throw new IOException e start from scratch return ConsoleAnnotator initial context null null context getClass Override public long writeLogTo long start Writer w throws IOException if isHtml return writeHtmlTo start w else return super writeLogTo start w Override public long writeLogTo long start OutputStream out throws IOException return super writeLogTo start new PlainTextConsoleOutputStream out public long writeRawLogTo long start OutputStream out throws IOException return super writeLogTo start out public long writeHtmlTo long start Writer w throws IOException ConsoleAnnotationOutputStream caw new ConsoleAnnotationOutputStream w createAnnotator Stapler getCurrentRequest context charset long r super writeLogTo start caw ByteArrayOutputStream baos new ByteArrayOutputStream Cipher sym PASSING ANNOTATOR encrypt ObjectOutputStream oos new ObjectOutputStream new GZIPOutputStream new CipherOutputStream baos sym oos writeLong System currentTimeMillis send timestamp to prevent a replay attack oos writeObject caw getConsoleAnnotator oos close StaplerResponse rsp Stapler getCurrentResponse if rsp null rsp setHeader X ConsoleAnnotator new String Base64 encode baos toByteArray return r private static final CryptoConfidentialKey PASSING ANNOTATOR new CryptoConfidentialKey AnnotatedLargeText class consoleAnnotatorpackage jenkins util import org apache tools ant BuildEvent import org apache tools ant BuildException import org apache tools ant Project import org apache tools ant SubBuildListener import org apache tools ant launch Locator import org apache tools ant types Path import org apache tools ant util CollectionUtils import org apache tools ant util FileUtils import org apache tools ant util JavaEnvUtils import org apache tools ant util LoaderUtils import org apache tools ant util ReflectUtil import org apache tools ant util VectorSet import org kohsuke accmod Restricted import org kohsuke accmod restrictions NoExternalUse import java io ByteArrayOutputStream import java io File import java io FileInputStream import java io IOException import java io InputStream import java lang reflect Constructor import java net MalformedURLException import java net URL import java security CodeSource import java security ProtectionDomain import java security cert Certificate import java util Collections import java util Enumeration import java util HashMap import java util Hashtable import java util Map import java util NoSuchElementException import java util StringTokenizer import java util Vector import java util jar Attributes import java util jar Attributes Name import java util jar JarEntry import java util jar JarFile import java util jar Manifest Restricted NoExternalUse class public class AntClassLoader extends ClassLoader implements SubBuildListener private static final FileUtils FILE UTILS FileUtils getFileUtils private class ResourceEnumeration implements Enumeration private String resourceName private int pathElementsIndex private URL nextResource ResourceEnumeration String name this resourceName name this pathElementsIndex 0 findNextResource public boolean hasMoreElements return this nextResource null public Object nextElement URL ret this nextResource if ret null throw new NoSuchElementException findNextResource return ret private void findNextResource URL url null while pathElementsIndex pathComponents size url null try File pathComponent File pathComponents elementAt pathElementsIndex url getResourceURL pathComponent this resourceName pathElementsIndex catch BuildException e ignore path elements which are not valid relative to the project this nextResource url private static final int BUFFER SIZE 8192 private static final int NUMBER OF STRINGS 256 private Vector pathComponents new VectorSet private Project project private boolean parentFirst true private Vector systemPackages new Vector private Vector loaderPackages new Vector private boolean ignoreBase false private ClassLoader parent null private Hashtable jarFiles new Hashtable private static Map pathMap Collections synchronizedMap new HashMap private ClassLoader savedContextLoader null private boolean isContextLoaderSaved false public AntClassLoader ClassLoader parent Project project Path classpath super parent KK patch for JENKINS 21579 setParent parent setClassPath classpath setProject project public AntClassLoader setParent null public AntClassLoader Project project Path classpath setParent null setProject project setClassPath classpath public AntClassLoader ClassLoader parent Project project Path classpath boolean parentFirst this project classpath if parent null setParent parent setParentFirst parentFirst addJavaLibraries public AntClassLoader Project project Path classpath boolean parentFirst this null project classpath parentFirst public AntClassLoader ClassLoader parent boolean parentFirst super parent KK patch for JENKINS 21579 setParent parent project null this parentFirst parentFirst public void setProject Project project this project project if project null project addBuildListener this public void setClassPath Path classpath pathComponents removeAllElements if classpath null Path actualClasspath classpath concatSystemClasspath ignore String pathElements actualClasspath list for int i 0 i pathElements length i try addPathElement pathElements i catch BuildException e ignore path elements which are invalid relative to the project public void setParent ClassLoader parent this parent parent null AntClassLoader class getClassLoader parent public void setParentFirst boolean parentFirst this parentFirst parentFirst protected void log String message int priority if project null project log message priority public void setThreadContextLoader if isContextLoaderSaved throw new BuildException Context loader has not been reset if LoaderUtils isContextLoaderAvailable savedContextLoader LoaderUtils getContextClassLoader ClassLoader loader this if project null only equals project getProperty build sysclasspath loader this getClass getClassLoader LoaderUtils setContextClassLoader loader isContextLoaderSaved true public void resetThreadContextLoader if LoaderUtils isContextLoaderAvailable isContextLoaderSaved LoaderUtils setContextClassLoader savedContextLoader savedContextLoader null isContextLoaderSaved false public void addPathElement String pathElement throws BuildException File pathComponent project null project resolveFile pathElement new File pathElement try addPathFile pathComponent catch IOException e throw new BuildException e public void addPathComponent File file if pathComponents contains file return pathComponents addElement file protected void addPathFile File pathComponent throws IOException if pathComponents contains pathComponent pathComponents addElement pathComponent if pathComponent isDirectory return String absPathPlusTimeAndLength pathComponent getAbsolutePath pathComponent lastModified pathComponent length String classpath String pathMap get absPathPlusTimeAndLength if classpath null JarFile jarFile null try jarFile new JarFile pathComponent Manifest manifest jarFile getManifest if manifest null return classpath manifest getMainAttributes getValue Attributes Name CLASS PATH finally if jarFile null jarFile close if classpath null classpath pathMap put absPathPlusTimeAndLength classpath if equals classpath URL baseURL FILE UTILS getFileURL pathComponent StringTokenizer st new StringTokenizer classpath while st hasMoreTokens String classpathElement st nextToken URL libraryURL new URL baseURL classpathElement if libraryURL getProtocol equals file log Skipping jar library classpathElement since only relative URLs are supported by this loader Project MSG VERBOSE continue String decodedPath Locator decodeUri libraryURL getFile File libraryFile new File decodedPath if libraryFile exists isInPath libraryFile addPathFile libraryFile public String getClasspath StringBuffer sb new StringBuffer boolean firstPass true Enumeration componentEnum pathComponents elements while componentEnum hasMoreElements if firstPass sb append System getProperty path separator else firstPass false sb append File componentEnum nextElement getAbsolutePath return sb toString public synchronized void setIsolated boolean isolated ignoreBase isolated Deprecated public static void initializeClass Class theClass HACK We ask the VM to create an instance by voluntarily providing illegal arguments to force the VM to run the class static initializer while at the same time not running a valid constructor final Constructor cons theClass getDeclaredConstructors At least one constructor is guaranteed to be there but check anyway if cons null if cons length 0 cons 0 null final String strs new String NUMBER OF STRINGS try cons 0 newInstance Object strs Expecting an exception to be thrown by this call IllegalArgumentException wrong number of Arguments catch Exception e Ignore we are interested only in the side effect that of getting the static initializers invoked As we do not want to call a valid constructor to get this side effect an attempt is made to call a hopefully invalid constructor come on nobody would have a constructor that takes in 256 String arguments In fact they can t according to JVM spec section 4 10 the number of method parameters is limited to 255 by the definition of a method descriptor Constructors count as methods here public void addSystemPackageRoot String packageRoot systemPackages addElement packageRoot packageRoot endsWith public void addLoaderPackageRoot String packageRoot loaderPackages addElement packageRoot packageRoot endsWith public Class forceLoadClass String classname throws ClassNotFoundException log force loading classname Project MSG DEBUG Class theClass findLoadedClass classname if theClass null theClass findClass classname return theClass public Class forceLoadSystemClass String classname throws ClassNotFoundException log force system loading classname Project MSG DEBUG Class theClass findLoadedClass classname if theClass null theClass findBaseClass classname return theClass public InputStream getResourceAsStream String name InputStream resourceStream null if isParentFirst name resourceStream loadBaseResource name if resourceStream null log ResourceStream for name loaded from parent loader Project MSG DEBUG else resourceStream loadResource name if resourceStream null log ResourceStream for name loaded from ant loader Project MSG DEBUG if resourceStream null isParentFirst name if ignoreBase resourceStream getRootLoader null null getRootLoader getResourceAsStream name else resourceStream loadBaseResource name if resourceStream null log ResourceStream for name loaded from parent loader Project MSG DEBUG if resourceStream null log Couldn t load ResourceStream for name Project MSG DEBUG return resourceStream private InputStream loadResource String name we need to search the components of the path to see if we can find the class we want InputStream stream null Enumeration e pathComponents elements while e hasMoreElements stream null File pathComponent File e nextElement stream getResourceStream pathComponent name return stream private InputStream loadBaseResource String name return parent null super getResourceAsStream name parent getResourceAsStream name private InputStream getResourceStream File file String resourceName try JarFile jarFile JarFile jarFiles get file if jarFile null file isDirectory File resource new File file resourceName if resource exists return new FileInputStream resource else if jarFile null if file exists jarFile new JarFile file jarFiles put file jarFile else return null to eliminate a race condition retrieve the entry that is in the hash table under that filename jarFile JarFile jarFiles get file JarEntry entry jarFile getJarEntry resourceName if entry null return jarFile getInputStream entry catch Exception e log Ignoring Exception e getClass getName e getMessage reading resource resourceName from file Project MSG VERBOSE return null private boolean isParentFirst String resourceName default to the global setting and then see if this class belongs to a package which has been designated to use a specific loader first this one or the parent one TODO shouldn t this always return false in isolated mode boolean useParentFirst parentFirst for Enumeration e systemPackages elements e hasMoreElements String packageName String e nextElement if resourceName startsWith packageName useParentFirst true break for Enumeration e loaderPackages elements e hasMoreElements String packageName String e nextElement if resourceName startsWith packageName useParentFirst false break return useParentFirst private ClassLoader getRootLoader ClassLoader ret getClass getClassLoader while ret null ret getParent null ret ret getParent return ret public URL getResource String name we need to search the components of the path to see if we can find the class we want URL url null if isParentFirst name url parent null super getResource name parent getResource name if url null log Resource name loaded from parent loader Project MSG DEBUG else try and load from this loader if the parent either didn t find it or wasn t consulted Enumeration e pathComponents elements while e hasMoreElements url null File pathComponent File e nextElement url getResourceURL pathComponent name if url null log Resource name loaded from ant loader Project MSG DEBUG if url null isParentFirst name this loader was first but it didn t find it try the parent if ignoreBase url getRootLoader null null getRootLoader getResource name else url parent null super getResource name parent getResource name if url null log Resource name loaded from parent loader Project MSG DEBUG if url null log Couldn t load Resource name Project MSG DEBUG return url public Enumeration getNamedResources String name throws IOException return findResources name false protected Enumeration findResources String name throws IOException return findResources name true protected Enumeration findResources String name boolean parentHasBeenSearched throws IOException Enumeration mine new ResourceEnumeration name Enumeration base if parent null parentHasBeenSearched parent getParent Delegate to the parent base parent getResources name Note could cause overlaps in case ClassLoader this parent has matches and parentHasBeenSearched is true else ClassLoader this parent is already delegated to for example from ClassLoader getResources no need base new CollectionUtils EmptyEnumeration if isParentFirst name Normal case return CollectionUtils append base mine if ignoreBase return getRootLoader null mine CollectionUtils append mine getRootLoader getResources name parent last return CollectionUtils append mine base protected URL getResourceURL File file String resourceName try JarFile jarFile JarFile jarFiles get file if jarFile null file isDirectory File resource new File file resourceName if resource exists try return FILE UTILS getFileURL resource catch MalformedURLException ex return null else if jarFile null if file exists jarFile new JarFile file jarFiles put file jarFile else return null potential race condition jarFile JarFile jarFiles get file JarEntry entry jarFile getJarEntry resourceName if entry null try return new URL jar FILE UTILS getFileURL file entry catch MalformedURLException ex return null catch Exception e String msg Unable to obtain resource from file log msg e Project MSG WARN System err println msg e printStackTrace return null protected synchronized Class loadClass String classname boolean resolve throws ClassNotFoundException sync is needed otherwise 2 threads can load the same class twice resulting in LinkageError duplicated class definition findLoadedClass avoids that but without sync it won t work Class theClass findLoadedClass classname if theClass null return theClass if isParentFirst classname try theClass findBaseClass classname log Class classname loaded from parent loader parentFirst Project MSG DEBUG catch ClassNotFoundException cnfe theClass findClass classname log Class classname loaded from ant loader parentFirst Project MSG DEBUG else try theClass findClass classname log Class classname loaded from ant loader Project MSG DEBUG catch ClassNotFoundException cnfe if ignoreBase throw cnfe theClass findBaseClass classname log Class classname loaded from parent loader Project MSG DEBUG if resolve resolveClass theClass return theClass private String getClassFilename String classname return classname replace class protected Class defineClassFromData File container byte classData String classname throws IOException definePackage container classname ProtectionDomain currentPd Project class getProtectionDomain String classResource getClassFilename classname CodeSource src new CodeSource FILE UTILS getFileURL container getCertificates container classResource ProtectionDomain classesPd new ProtectionDomain src currentPd getPermissions this currentPd getPrincipals return defineClass classname classData 0 classData length classesPd protected void definePackage File container String className throws IOException int classIndex className lastIndexOf if classIndex 1 return String packageName className substring 0 classIndex if getPackage packageName null already defined return define the package now Manifest manifest getJarManifest container if manifest null definePackage packageName null null null null null null null else definePackage container packageName manifest private Manifest getJarManifest File container throws IOException if container isDirectory return null JarFile jarFile JarFile jarFiles get container if jarFile null return null return jarFile getManifest private Certificate getCertificates File container String entry throws IOException if container isDirectory return null JarFile jarFile JarFile jarFiles get container if jarFile null return null JarEntry ent jarFile getJarEntry entry return ent null null ent getCertificates protected void definePackage File container String packageName Manifest manifest String sectionName packageName replace String specificationTitle null String specificationVendor null String specificationVersion null String implementationTitle null String implementationVendor null String implementationVersion null String sealedString null URL sealBase null Attributes sectionAttributes manifest getAttributes sectionName if sectionAttributes null specificationTitle sectionAttributes getValue Name SPECIFICATION TITLE specificationVendor sectionAttributes getValue Name SPECIFICATION VENDOR specificationVersion sectionAttributes getValue Name SPECIFICATION VERSION implementationTitle sectionAttributes getValue Name IMPLEMENTATION TITLE implementationVendor sectionAttributes getValue Name IMPLEMENTATION VENDOR implementationVersion sectionAttributes getValue Name IMPLEMENTATION VERSION sealedString sectionAttributes getValue Name SEALED Attributes mainAttributes manifest getMainAttributes if mainAttributes null if specificationTitle null specificationTitle mainAttributes getValue Name SPECIFICATION TITLE if specificationVendor null specificationVendor mainAttributes getValue Name SPECIFICATION VENDOR if specificationVersion null specificationVersion mainAttributes getValue Name SPECIFICATION VERSION if implementationTitle null implementationTitle mainAttributes getValue Name IMPLEMENTATION TITLE if implementationVendor null implementationVendor mainAttributes getValue Name IMPLEMENTATION VENDOR if implementationVersion null implementationVersion mainAttributes getValue Name IMPLEMENTATION VERSION if sealedString null sealedString mainAttributes getValue Name SEALED if sealedString null sealedString equalsIgnoreCase true try sealBase new URL FileUtils getFileUtils toURI container getAbsolutePath catch MalformedURLException e ignore definePackage packageName specificationTitle specificationVersion specificationVendor implementationTitle implementationVersion implementationVendor sealBase private Class getClassFromStream InputStream stream String classname File container throws IOException SecurityException ByteArrayOutputStream baos new ByteArrayOutputStream int bytesRead 1 byte buffer new byte BUFFER SIZE while bytesRead stream read buffer 0 BUFFER SIZE 1 baos write buffer 0 bytesRead byte classData baos toByteArray return defineClassFromData container classData classname public Class findClass String name throws ClassNotFoundException log Finding class name Project MSG DEBUG return findClassInComponents name protected boolean isInPath File component return pathComponents contains component private Class findClassInComponents String name throws ClassNotFoundException we need to search the components of the path to see if we can find the class we want String classFilename getClassFilename name Enumeration e pathComponents elements while e hasMoreElements File pathComponent File e nextElement try final InputStream stream getResourceStream pathComponent classFilename if stream null log Loaded from pathComponent classFilename Project MSG DEBUG return getClassFromStream stream name pathComponent catch SecurityException se throw se catch IOException ioe ioe printStackTrace log Exception reading component pathComponent reason ioe getMessage Project MSG VERBOSE throw new ClassNotFoundException name private Class findBaseClass String name throws ClassNotFoundException return parent null findSystemClass name parent loadClass name public synchronized void cleanup for Enumeration e jarFiles elements e hasMoreElements JarFile jarFile JarFile e nextElement try jarFile close catch IOException ioe ignore jarFiles new Hashtable if project null project removeBuildListener this project null public ClassLoader getConfiguredParent return parent public void buildStarted BuildEvent event Not significant for the class loader public void buildFinished BuildEvent event cleanup public void subBuildFinished BuildEvent event if event getProject project cleanup public void subBuildStarted BuildEvent event Not significant for the class loader public void targetStarted BuildEvent event Not significant for the class loader public void targetFinished BuildEvent event Not significant for the class loader public void taskStarted BuildEvent event Not significant for the class loader public void taskFinished BuildEvent event Not significant for the class loader public void messageLogged BuildEvent event Not significant for the class loader public void addJavaLibraries Vector packages JavaEnvUtils getJrePackages Enumeration e packages elements while e hasMoreElements String packageName String e nextElement addSystemPackageRoot packageName public String toString return AntClassLoader getClasspath private static Class subClassToLoad null private static final Class CONSTRUCTOR ARGS new Class ClassLoader class Project class Path class Boolean TYPE static if JavaEnvUtils isAtLeastJavaVersion JavaEnvUtils JAVA 1 5 try subClassToLoad Class forName org apache tools ant loader AntClassLoader5 catch ClassNotFoundException e this is Java5 but the installation is lacking our subclass public static AntClassLoader newAntClassLoader ClassLoader parent Project project Path path boolean parentFirst if subClassToLoad null return AntClassLoader ReflectUtil newInstance subClassToLoad CONSTRUCTOR ARGS new Object parent project path Boolean valueOf parentFirst return new AntClassLoader parent project path parentFirstpackage hudson model import hudson ExtensionList import hudson ExtensionPoint import hudson init Initializer import hudson triggers SafeTimerTask import jenkins util Timer import java util Random import java util concurrent TimeUnit import java util logging Logger import static hudson init InitMilestone JOB LOADED public abstract class AperiodicWork extends SafeTimerTask implements ExtensionPoint protected final Logger logger Logger getLogger getClass getName public abstract long getRecurrencePeriod public abstract AperiodicWork getNewInstance public long getInitialDelay long l RANDOM nextLong Math abs Long MIN VALUE Long MIN VALUE if l Long MIN VALUE l return Math abs l getRecurrencePeriod Override public final void doRun throws Exception doAperiodicRun Timer get schedule getNewInstance getRecurrencePeriod TimeUnit MILLISECONDS Initializer after JOB LOADED public static void init start all AperidocWorks for AperiodicWork p AperiodicWork all Timer get schedule p p getInitialDelay TimeUnit MILLISECONDS protected abstract void doAperiodicRun public static ExtensionList AperiodicWork all return ExtensionList lookup AperiodicWork class private static final Random RANDOM new Randompackage hudson model import hudson ExtensionList import jenkins util xml FilteredFunctionContext import jenkins model Jenkins import jenkins security SecureRequester import org dom4j CharacterData import org dom4j Document import org dom4j DocumentException import org dom4j DocumentFactory import org dom4j Element import org dom4j XPath import org dom4j io SAXReader import org dom4j io XMLWriter import org kohsuke stapler QueryParameter import org kohsuke stapler StaplerRequest import org kohsuke stapler StaplerResponse import org kohsuke stapler export import org kohsuke stapler export TreePruner ByDepth import javax servlet ServletException import javax servlet http HttpServletResponse import javax xml transform stream StreamResult import java io IOException import java io OutputStream import java io StringReader import java io StringWriter import java net HttpURLConnection import java util List import java util logging Level import java util logging Logger public class Api extends AbstractModelObject public final Object bean public Api Object bean this bean bean public String getDisplayName return API public String getSearchUrl return api public void doXml StaplerRequest req StaplerResponse rsp QueryParameter String xpath QueryParameter String wrapper QueryParameter String tree QueryParameter int depth throws IOException ServletException setHeaders rsp String excludes req getParameterValues exclude if xpath null excludes null serve the whole thing rsp serveExposedBean req bean Flavor XML return StringWriter sw new StringWriter first write to String Model p MODEL BUILDER get bean getClass TreePruner pruner tree null new NamedPathPruner tree new ByDepth 1 depth p writeTo bean pruner Flavor XML createDataWriter bean sw apply XPath FilteredFunctionContext functionContext new FilteredFunctionContext Object result try Document dom new SAXReader read new StringReader sw toString apply exclusions if excludes null for String exclude excludes XPath xExclude dom createXPath exclude xExclude setFunctionContext functionContext List org dom4j Node list List org dom4j Node xExclude selectNodes dom for org dom4j Node n list Element parent n getParent if parent null parent remove n if xpath null result dom else XPath comp dom createXPath xpath comp setFunctionContext functionContext List list comp selectNodes dom if wrapper null Element root DocumentFactory getInstance createElement wrapper for Object o list if o instanceof String root addText o toString else root add org dom4j Node o detach result root else if list isEmpty rsp setStatus HttpServletResponse SC NOT FOUND rsp getWriter print Messages Api NoXPathMatch xpath return else if list size 1 rsp setStatus HttpServletResponse SC INTERNAL SERVER ERROR rsp getWriter print Messages Api MultipleMatch xpath list size return else result list get 0 catch DocumentException e LOGGER log Level FINER Failed to do XPath wrapper handling XML is as follows sw e throw new IOException Failed to do XPath wrapper handling Turn on FINER logging to view XML e if isSimpleOutput result permit req simple output prohibited rsp sendError HttpURLConnection HTTP FORBIDDEN primitive XPath result sets forbidden implement jenkins security SecureRequester return switch to gzipped output try OutputStream o rsp getCompressedOutputStream req if isSimpleOutput result simple output allowed rsp setContentType text plain charset UTF 8 String text result instanceof CharacterData CharacterData result getText result toString o write text getBytes UTF 8 return otherwise XML rsp setContentType application xml charset UTF 8 new XMLWriter o write result private boolean isSimpleOutput Object result return result instanceof CharacterData result instanceof String result instanceof Number result instanceof Boolean public void doSchema StaplerRequest req StaplerResponse rsp throws IOException ServletException setHeaders rsp rsp setContentType application xml StreamResult r new StreamResult rsp getOutputStream new SchemaGenerator new ModelBuilder get bean getClass generateSchema r r getOutputStream close public void doJson StaplerRequest req StaplerResponse rsp throws IOException ServletException if req getParameter jsonp null permit req setHeaders rsp rsp serveExposedBean req bean req getParameter jsonp null Flavor JSON Flavor JSONP else rsp sendError HttpURLConnection HTTP FORBIDDEN jsonp forbidden implement jenkins security SecureRequester public void doPython StaplerRequest req StaplerResponse rsp throws IOException ServletException setHeaders rsp rsp serveExposedBean req bean Flavor PYTHON private boolean permit StaplerRequest req for SecureRequester r ExtensionList lookup SecureRequester class if r permit req bean return true return false private void setHeaders StaplerResponse rsp rsp setHeader X Jenkins Jenkins VERSION rsp setHeader X Jenkins Session Jenkins SESSION HASH private static final Logger LOGGER Logger getLogger Api class getName private static final ModelBuilder MODEL BUILDER new ModelBuilderpackage com kaku colorfulnews common public class ApiConstants public static final String NETEAST HOST http c m 163 com public static final String END URL 20 html public static final String ENDDETAIL URL full html public static final String NEWS DETAIL NETEAST HOST nc article TYPE public static final String HEADLINE TYPE headline TYPE public static final String HOUSE TYPE house TYPE public static final String OTHER TYPE list public static final String LOCAL TYPE local Id public static final String BEIJING ID 5YyX5Lqs id public static final String HEADLINE ID T1348647909107 id public static final String HOUSE ID 5YyX5Lqs public static final String FOOTBALL ID T1399700447917 public static final String ENTERTAINMENT ID T1348648517839 public static final String SPORTS ID T1348649079062 public static final String FINANCE ID T1348648756099 public static final String TECH ID T1348649580692 public static final String MOVIE ID T1348648650048 public static final String CAR ID T1348654060988 public static final String JOKE ID T1350383429665 public static final String GAME ID T1348654151579 public static final String FASHION ID T1348650593803 public static final String EMOTION ID T1348650839000 public static final String CHOICE ID T1370583240249 public static final String RADIO ID T1379038288239 nba public static final String NBA ID T1348649145984 public static final String DIGITAL ID T1348649776727 public static final String MOBILE ID T1351233117091 public static final String LOTTERY ID T1356600029035 public static final String EDUCATION ID T1348654225495 public static final String FORUM ID T1349837670307 public static final String TOUR ID T1348654204705 public static final String PHONE ID T1348649654285 public static final String BLOG ID T1349837698345 public static final String SOCIETY ID T1348648037603 public static final String FURNISHING ID T1348654105308 public static final String BLIZZARD ID T1397016069906 public static final String PATERNITY ID T1397116135282 CBA public static final String CBA ID T1348649475931 public static final String MSG ID T1371543208049 public static final String MILITARY ID T1348648141035 public static final String Video nc video list public static final String VIDEO CENTER n public static final String VIDEO END URL 10 html public static final String VIDEO HOT ID V9LG4B3A0 public static final String VIDEO ENTERTAINMENT ID V9LG4CHOR public static final String VIDEO FUN ID V9LG4E6VR public static final String VIDEO CHOICE ID 00850FRB public static final String WEATHER HOST http wthrcdn etouch cn public static final String SINA PHOTO HOST http gank io api public static final String SINA PHOTO CHOICE ID hdpic toutiao public static final String SINA PHOTO FUN ID hdpic funny public static final String SINA PHOTO PRETTY ID hdpic pretty public static final String SINA PHOTO STORY ID hdpic story public static final String SINA PHOTO DETAIL ID hdpic hdpic toutiao 4 public static String getType String id switch id case HEADLINE ID return HEADLINE TYPE case HOUSE ID return HOUSE TYPE default break return OTHER TYPE public static String getHost int hostType String host switch hostType case HostType NETEASE NEWS VIDEO host NETEAST HOST break case HostType GANK GIRL PHOTO host SINA PHOTO HOST break case HostType NEWS DETAIL HTML PHOTO host http kaku com break default host break return hostpackage com twitter sdk android core models import com google gson annotations SerializedName public class ApiError SerializedName message public final String message SerializedName code public final int code public ApiError String message int code this message message this code codepackage com twitter sdk android core models import com google gson annotations SerializedName import java util List public class ApiErrors SerializedName errors public final List ApiError errors public ApiErrors List ApiError errors this errors errorspackage jenkins security import javax servlet Filter import java util Collections import java util List Deprecated public class ApiTokenFilter extends BasicHeaderProcessor Override protected List extends BasicHeaderAuthenticator all return Collections singletonList new BasicHeaderApiTokenAuthenticatorpackage jenkins security import hudson Extension import jenkins util SystemProperties import hudson Util import hudson model Descriptor FormException import hudson model User import hudson model UserProperty import hudson model UserPropertyDescriptor import hudson security ACL import hudson util HttpResponses import hudson util Secret import jenkins model Jenkins import net sf json JSONObject import org jenkinsci Symbol import org kohsuke stapler AncestorInPath import org kohsuke stapler DataBoundConstructor import org kohsuke stapler HttpResponse import org kohsuke stapler StaplerRequest import org kohsuke stapler StaplerResponse import java io IOException import java nio charset Charset import java security MessageDigest import java security SecureRandom import javax annotation Nonnull import org apache commons lang StringUtils import org kohsuke accmod Restricted import org kohsuke accmod restrictions NoExternalUse public class ApiTokenProperty extends UserProperty private volatile Secret apiToken private static final boolean SHOW TOKEN TO ADMINS SystemProperties getBoolean ApiTokenProperty class getName showTokenToAdmins DataBoundConstructor public ApiTokenProperty changeApiToken ApiTokenProperty String seed apiToken Secret fromString seed Nonnull public String getApiToken return hasPermissionToSeeToken getApiTokenInsecure Messages ApiTokenProperty ChangeToken TokenIsHidden Nonnull Restricted NoExternalUse class String getApiTokenInsecure String p apiToken getPlainText if p equals Util getDigestOf Jenkins getInstance getSecretKey user getId if the current token is the initial value created by pre SECURITY 49 Jenkins we can t use that force using the newer value apiToken Secret fromString p API KEY SEED mac user getId return Util getDigestOf p public boolean matchesPassword String password String token getApiTokenInsecure String equals isn t constant time but this is return MessageDigest isEqual password getBytes Charset forName US ASCII token getBytes Charset forName US ASCII private boolean hasPermissionToSeeToken final Jenkins jenkins Jenkins getInstance Administrators can do whatever they want if SHOW TOKEN TO ADMINS jenkins hasPermission Jenkins ADMINISTER return true final User current User current if current null Anonymous return false SYSTEM user is always eligible to see tokens if Jenkins getAuthentication ACL SYSTEM return true TODO replace by IdStrategy in newer Jenkins versions return User idStrategy equals user getId current getId return StringUtils equals user getId current getId public void changeApiToken throws IOException user checkPermission Jenkins ADMINISTER changeApiToken user save private void changeApiToken byte random new byte 16 16x8 128bit worth of randomness since we use md5 digest as the API token RANDOM nextBytes random apiToken Secret fromString Util toHexString random Override public UserProperty reconfigure StaplerRequest req JSONObject form throws FormException return this Extension Symbol apiToken public static final class DescriptorImpl extends UserPropertyDescriptor public String getDisplayName return Messages ApiTokenProperty DisplayName public ApiTokenProperty newInstance User user return new ApiTokenProperty API KEY SEED mac user getId public HttpResponse doChangeToken AncestorInPath User u StaplerResponse rsp throws IOException ApiTokenProperty p u getProperty ApiTokenProperty class if p null p newInstance u u addProperty p else p changeApiToken rsp setHeader script document getElementById apiToken value p getApiToken return HttpResponses html p hasPermissionToSeeToken Messages ApiTokenProperty ChangeToken Success Messages ApiTokenProperty ChangeToken SuccessHidden private static final SecureRandom RANDOM new SecureRandom private static final HMACConfidentialKey API KEY SEED new HMACConfidentialKey ApiTokenProperty class seed 16package com zxy recovery test import android app Application import android util Log import com zxy recovery callback RecoveryCallback import com zxy recovery core Recovery public class App extends Application Override public void onCreate super onCreate Recovery getInstance debug true recoverInBackground false recoverStack true mainPage MainActivity class callback new MyCrashCallback init this static final class MyCrashCallback implements RecoveryCallback Override public void stackTrace String exceptionMessage Log e zxy exceptionMessage exceptionMessage Override public void cause String cause Log e zxy cause cause Override public void exception String exceptionType String throwClassName String throwMethodName int throwLineNumber Log e zxy exceptionClassName exceptionType Log e zxy throwClassName throwClassName Log e zxy throwMethodName throwMethodName Log e zxy throwLineNumber throwLineNumberpackage com twitter sdk android tweetcomposer import android content Context import android net Uri import android util AttributeSet import android view ViewGroup import android widget ImageView import android widget LinearLayout import android widget TextView import com squareup picasso Picasso import com squareup picasso Transformation public class AppCardView extends LinearLayout ImageView appImageView ViewGroup appInfoLayout TextView appInstallButton TextView appNameView TextView appStoreNameView public AppCardView Context context this context null public AppCardView Context context AttributeSet attrs super context attrs init context public AppCardView Context context AttributeSet attrs int defStyle super context attrs defStyle init context void init Context context setOrientation LinearLayout VERTICAL inflate context R layout tw app card this findSubviews setButtonColor void findSubviews appImageView ImageView findViewById R id tw app image appNameView TextView findViewById R id tw app name appStoreNameView TextView findViewById R id tw app store name appInstallButton TextView findViewById R id tw app install button appInfoLayout ViewGroup findViewById R id tw app info layout void setCard Card card setImage Uri parse card imageUri setAppName card appName void setImage Uri uri final int radius getResources getDimensionPixelSize R dimen tw card radius medium final Transformation transformation new RoundedCornerTransformation Builder setRadii radius radius 0 0 build Picasso with getContext load uri transform transformation fit centerCrop into appImageView void setAppName String name appNameView setText name Override protected void onMeasure int widthMeasureSpec int heightMeasureSpec final int maxWidth getResources getDimensionPixelSize R dimen tw card maximum width Adjust width if required final int measuredWidth MeasureSpec getSize widthMeasureSpec if maxWidth 0 maxWidth measuredWidth final int measureMode MeasureSpec getMode widthMeasureSpec widthMeasureSpec MeasureSpec makeMeasureSpec maxWidth measureMode super onMeasure widthMeasureSpec heightMeasureSpec void setButtonColor final int buttonTextColor getResources getColor R color tw composer blue text appInstallButton setTextColor buttonTextColorpackage com kaku colorfulnews di component import android content Context import com kaku colorfulnews di module ApplicationModule import com kaku colorfulnews di scope ContextLife import com kaku colorfulnews di scope PerApp import dagger Component PerApp Component modules ApplicationModule class public interface ApplicationComponent ContextLife Application Context getApplicationpackage com kaku colorfulnews di module import android content Context import com kaku colorfulnews App import com kaku colorfulnews di scope ContextLife import com kaku colorfulnews di scope PerApp import dagger Module import dagger Provides Module public class ApplicationModule private App mApplication public ApplicationModule App application mApplication application Provides PerApp ContextLife Application public Context provideApplicationContext return mApplication getApplicationContextpackage hudson node monitors import hudson model Computer import hudson remoting Callable import hudson Extension import jenkins security MasterToSlaveCallable import net sf json JSONObject import org jenkinsci Symbol import org kohsuke stapler StaplerRequest import java io IOException public class ArchitectureMonitor extends NodeMonitor Extension Symbol architecture public static final class DescriptorImpl extends AbstractAsyncNodeMonitorDescriptor String Override protected Callable String IOException createCallable Computer c return new GetArchTask public String getDisplayName return Messages ArchitectureMonitor DisplayName public NodeMonitor newInstance StaplerRequest req JSONObject formData throws FormException return new ArchitectureMonitor private static class GetArchTask extends MasterToSlaveCallable String IOException public String call String os System getProperty os name String arch System getProperty os arch return os arch private static final long serialVersionUID 1Lpackage hudson util io import hudson util FileVisitor import java io Closeable public abstract class Archiver extends FileVisitor implements Closeable protected int entriesWritten 0 public int countEntries return entriesWrittenpackage hudson util io import hudson FilePath TarCompression import java io IOException import java io OutputStream import java io Serializable public abstract class ArchiverFactory implements Serializable public abstract Archiver create OutputStream out throws IOException public static ArchiverFactory TAR new TarArchiverFactory TarCompression NONE public static ArchiverFactory TARGZ new TarArchiverFactory TarCompression GZIP public static ArchiverFactory ZIP new ZipArchiverFactory private static final class TarArchiverFactory extends ArchiverFactory private final TarCompression method private TarArchiverFactory TarCompression method this method method public Archiver create OutputStream out throws IOException return new TarArchiver method compress out private static final long serialVersionUID 1L private static final class ZipArchiverFactory extends ArchiverFactory public Archiver create OutputStream out return new ZipArchiver out private static final long serialVersionUID 1L private static final long serialVersionUID 1Lpackage hudson util import java util regex Matcher import java util regex Pattern public final class Area public final int width public final int height public Area int width int height this width width this height height public static Area parse String s Matcher m PATTERN matcher s if m matches return new Area Integer parseInt m group 1 Integer parseInt m group 2 return null public int area return width height Override public String toString return width x height private static final Pattern PATTERN Pattern compile d x dpackage hudson util import hudson Launcher import hudson Util import java util ArrayList import java util List import java util Arrays import java util Map import java util BitSet import java util Properties import java util Map Entry import java io Serializable import java io File import java io IOException import java util Set public class ArgumentListBuilder implements Serializable Cloneable private final List String args new ArrayList String private BitSet mask new BitSet public ArgumentListBuilder public ArgumentListBuilder String args add args public ArgumentListBuilder add Object a return add a toString false public ArgumentListBuilder add Object a boolean mask return add a toString mask public ArgumentListBuilder add File f return add f getAbsolutePath false public ArgumentListBuilder add String a return add a false public ArgumentListBuilder add String a boolean mask if a null if mask this mask set args size args add a return this public ArgumentListBuilder prepend String args left shift the mask BitSet nm new BitSet this args size args length for int i 0 i this args size i nm set i args length mask get i mask nm this args addAll 0 Arrays asList args return this public ArgumentListBuilder addQuoted String a return add a false public ArgumentListBuilder addQuoted String a boolean mask return add a mask public ArgumentListBuilder add String args for String arg args add arg return this public ArgumentListBuilder addTokenized String s if s null return this add Util tokenize s return this public ArgumentListBuilder addKeyValuePair String prefix String key String value boolean mask if key null return this add prefix null D prefix key value mask return this public ArgumentListBuilder addKeyValuePairs String prefix Map String String props for Entry String String e props entrySet addKeyValuePair prefix e getKey e getValue false return this public ArgumentListBuilder addKeyValuePairs String prefix Map String String props Set String propsToMask for Entry String String e props entrySet addKeyValuePair prefix e getKey e getValue propsToMask null false propsToMask contains e getKey return this public ArgumentListBuilder addKeyValuePairsFromPropertyString String prefix String properties VariableResolver String vr throws IOException return addKeyValuePairsFromPropertyString prefix properties vr null public ArgumentListBuilder addKeyValuePairsFromPropertyString String prefix String properties VariableResolver String vr Set String propsToMask throws IOException if properties null return this properties Util replaceMacro properties propertiesGeneratingResolver vr for Entry Object Object entry Util loadProperties properties entrySet addKeyValuePair prefix String entry getKey entry getValue toString propsToMask null false propsToMask contains entry getKey return this private static VariableResolver String propertiesGeneratingResolver final VariableResolver String original return new VariableResolver String public String resolve String name final String value original resolve name if value null return null Substitute one backslash with two return value replaceAll public String toCommandArray return args toArray new String args size Override public ArgumentListBuilder clone ArgumentListBuilder r new ArgumentListBuilder r args addAll this args r mask BitSet this mask clone return r public void clear args clear mask clear public List String toList return args public String toStringWithQuote StringBuilder buf new StringBuilder for String arg args if buf length 0 buf append if arg indexOf 0 arg length 0 buf append append arg append else buf append arg return buf toString public ArgumentListBuilder toWindowsCommand boolean escapeVars ArgumentListBuilder windowsCommand new ArgumentListBuilder add cmd exe C boolean quoted percent for int i 0 i args size i StringBuilder quotedArgs new StringBuilder String arg args get i quoted percent false for int j 0 j arg length j char c arg charAt j if quoted c c c c c quoted startQuoting quotedArgs arg j else if c c c c c if quoted quoted startQuoting quotedArgs arg j quotedArgs append See note in javadoc above else if c if quoted quoted startQuoting quotedArgs arg j quotedArgs append else if percent escapeVars c A c Z c a c z if quoted quoted startQuoting quotedArgs arg j quotedArgs append append c c percent c if quoted quotedArgs append c if i 0 quoted quotedArgs insert 0 else if i 0 quoted quotedArgs append if quoted quotedArgs append else quotedArgs append arg windowsCommand add quotedArgs mask get i comment copied from old code in hudson tasks Ant on Windows executing batch file can t return the correct error code so we need to wrap it into cmd exe double is needed because we want ERRORLEVEL to be expanded after batch file executed not before This alone shows how broken Windows is windowsCommand add add exit add ERRORLEVEL return windowsCommand public ArgumentListBuilder toWindowsCommand return toWindowsCommand false private static boolean startQuoting StringBuilder buf String arg int atIndex buf append append arg substring 0 atIndex return true public boolean hasMaskedArguments return mask length 0 public boolean toMaskArray boolean mask new boolean args size for int i 0 i mask length i mask i this mask get i return mask public void addMasked String string add string true public ArgumentListBuilder addMasked Secret s return add Secret toString s true public String toString StringBuilder buf new StringBuilder for int i 0 i args size i String arg args get i if mask get i arg if buf length 0 buf append if arg indexOf 0 arg length 0 buf append append arg append else buf append arg return buf toString private static final long serialVersionUID 1Lpackage hudson tasks import hudson FilePath import jenkins MasterToSlaveFileCallable import hudson Launcher import hudson Util import hudson Extension import jenkins util SystemProperties import hudson model AbstractProject import hudson model Result import hudson model Run import hudson model TaskListener import hudson model listeners ItemListener import hudson remoting VirtualChannel import hudson util FormValidation import java io File import org apache tools ant types FileSet import org jenkinsci Symbol import org kohsuke stapler StaplerRequest import org kohsuke stapler DataBoundConstructor import org kohsuke stapler AncestorInPath import org kohsuke stapler QueryParameter import java io IOException import java util HashMap import java util Map import java util logging Level import java util logging Logger import javax annotation CheckForNull import net sf json JSONObject import javax annotation Nonnull import jenkins model BuildDiscarder import jenkins model Jenkins import jenkins tasks SimpleBuildStep import jenkins util BuildListenerAdapter import org kohsuke stapler DataBoundSetter public class ArtifactArchiver extends Recorder implements SimpleBuildStep private static final Logger LOG Logger getLogger ArtifactArchiver class getName private String artifacts private String excludes Deprecated private Boolean latestOnly Nonnull private Boolean allowEmptyArchive private boolean onlyIfSuccessful private boolean fingerprint Nonnull private Boolean defaultExcludes true Nonnull private Boolean caseSensitive true DataBoundConstructor public ArtifactArchiver String artifacts this artifacts artifacts trim allowEmptyArchive false Deprecated public ArtifactArchiver String artifacts String excludes boolean latestOnly this artifacts excludes latestOnly false false Deprecated public ArtifactArchiver String artifacts String excludes boolean latestOnly boolean allowEmptyArchive this artifacts excludes latestOnly allowEmptyArchive false Deprecated public ArtifactArchiver String artifacts String excludes boolean latestOnly boolean allowEmptyArchive boolean onlyIfSuccessful this artifacts excludes latestOnly allowEmptyArchive onlyIfSuccessful true Deprecated public ArtifactArchiver String artifacts String excludes boolean latestOnly boolean allowEmptyArchive boolean onlyIfSuccessful Boolean defaultExcludes this artifacts setExcludes excludes this latestOnly latestOnly setAllowEmptyArchive allowEmptyArchive setOnlyIfSuccessful onlyIfSuccessful setDefaultExcludes defaultExcludes Backwards compatibility for older builds public Object readResolve if allowEmptyArchive null this allowEmptyArchive SystemProperties getBoolean ArtifactArchiver class getName warnOnEmpty if defaultExcludes null defaultExcludes true if caseSensitive null caseSensitive true return this public String getArtifacts return artifacts public CheckForNull String getExcludes return excludes DataBoundSetter public final void setExcludes CheckForNull String excludes this excludes Util fixEmptyAndTrim excludes Deprecated public boolean isLatestOnly return latestOnly null latestOnly false public boolean isOnlyIfSuccessful return onlyIfSuccessful DataBoundSetter public final void setOnlyIfSuccessful boolean onlyIfSuccessful this onlyIfSuccessful onlyIfSuccessful public boolean isFingerprint return fingerprint DataBoundSetter public void setFingerprint boolean fingerprint this fingerprint fingerprint public boolean getAllowEmptyArchive return allowEmptyArchive DataBoundSetter public final void setAllowEmptyArchive boolean allowEmptyArchive this allowEmptyArchive allowEmptyArchive public boolean isDefaultExcludes return defaultExcludes DataBoundSetter public final void setDefaultExcludes boolean defaultExcludes this defaultExcludes defaultExcludes public boolean isCaseSensitive return caseSensitive DataBoundSetter public final void setCaseSensitive boolean caseSensitive this caseSensitive caseSensitive private void listenerWarnOrError TaskListener listener String message if allowEmptyArchive listener getLogger println String format WARN s message else listener error message Override public void perform Run build FilePath ws Launcher launcher TaskListener listener throws InterruptedException if artifacts length 0 listener error Messages ArtifactArchiver NoIncludes build setResult Result FAILURE return if onlyIfSuccessful build getResult null build getResult isWorseThan Result UNSTABLE listener getLogger println Messages ArtifactArchiver SkipBecauseOnlyIfSuccessful return listener getLogger println Messages ArtifactArchiver ARCHIVING ARTIFACTS try String artifacts build getEnvironment listener expand this artifacts Map String String files ws act new ListFiles artifacts excludes defaultExcludes caseSensitive if files isEmpty build pickArtifactManager archive ws launcher BuildListenerAdapter wrap listener files if fingerprint new Fingerprinter artifacts perform build ws launcher listener else Result result build getResult if result null result isBetterOrEqualTo Result UNSTABLE If the build failed don t complain that there was no matching artifact The build probably didn t even get to the point where it produces artifacts listenerWarnOrError listener Messages ArtifactArchiver NoMatchFound artifacts String msg null try msg ws validateAntFileMask artifacts FilePath VALIDATE ANT FILE MASK BOUND caseSensitive catch Exception e listenerWarnOrError listener e getMessage if msg null listenerWarnOrError listener msg if allowEmptyArchive build setResult Result FAILURE return catch IOException e Util displayIOException e listener e printStackTrace listener error Messages ArtifactArchiver FailedToArchive artifacts build setResult Result FAILURE return private static final class ListFiles extends MasterToSlaveFileCallable Map String String private static final long serialVersionUID 1 private final String includes excludes private final boolean defaultExcludes private final boolean caseSensitive ListFiles String includes String excludes boolean defaultExcludes boolean caseSensitive this includes includes this excludes excludes this defaultExcludes defaultExcludes this caseSensitive caseSensitive Override public Map String String invoke File basedir VirtualChannel channel throws IOException InterruptedException Map String String r new HashMap String String FileSet fileSet Util createFileSet basedir includes excludes fileSet setDefaultexcludes defaultExcludes fileSet setCaseSensitive caseSensitive for String f fileSet getDirectoryScanner getIncludedFiles f f replace File separatorChar r put f f return r public BuildStepMonitor getRequiredMonitorService return BuildStepMonitor NONE Deprecated public static volatile DescriptorImpl DESCRIPTOR Extension Symbol archiveArtifacts public static class DescriptorImpl extends BuildStepDescriptor Publisher public DescriptorImpl DESCRIPTOR this backward compatibility public String getDisplayName return Messages ArtifactArchiver DisplayName public FormValidation doCheckArtifacts AncestorInPath AbstractProject project QueryParameter String value QueryParameter value caseSensitive String caseSensitive throws IOException if project null return FormValidation ok defensive approach to remain case sensitive in doubtful situations boolean bCaseSensitive caseSensitive null false equals caseSensitive return FilePath validateFileMask project getSomeWorkspace value bCaseSensitive Override public ArtifactArchiver newInstance StaplerRequest req JSONObject formData throws FormException return req bindJSON ArtifactArchiver class formData public boolean isApplicable Class extends AbstractProject jobType return true Extension public static final class Migrator extends ItemListener SuppressWarnings deprecation Override public void onLoaded for AbstractProject p Jenkins getInstance getAllItems AbstractProject class try ArtifactArchiver aa p getPublishersList get ArtifactArchiver class if aa null aa latestOnly null if aa latestOnly BuildDiscarder bd p getBuildDiscarder if bd instanceof LogRotator LogRotator lr LogRotator bd if lr getArtifactNumToKeep 1 p setBuildDiscarder new LogRotator lr getDaysToKeep lr getNumToKeep lr getArtifactDaysToKeep 1 else LOG log Level WARNING will not clobber artifactNumToKeep 0 in 1 new Object lr getArtifactNumToKeep p else if bd null p setBuildDiscarder new LogRotator 1 1 1 1 else LOG log Level WARNING unrecognized BuildDiscarder 0 in 1 new Object bd p aa latestOnly null p save Fingerprinter f p getPublishersList get Fingerprinter class if f null f getRecordBuildArtifacts f recordBuildArtifacts null if aa null aa setFingerprint true if f getTargets isEmpty no other reason to be here p getPublishersList remove f p save catch IOException x LOG log Level WARNING could not migrate p xpackage jenkins model import hudson FilePath import hudson Launcher import hudson model BuildListener import hudson model Run import hudson model TaskListener import hudson tasks ArtifactArchiver import java io IOException import java util Map import jenkins util VirtualFile public abstract class ArtifactManager public abstract void onLoad Run build public abstract void archive FilePath workspace Launcher launcher BuildListener listener Map String String artifacts throws IOException InterruptedException public abstract boolean delete throws IOException InterruptedException public abstract VirtualFile rootpackage jenkins model import hudson Extension import hudson util DescribableList import java io IOException import net sf json JSONObject import org jenkinsci Symbol import org kohsuke stapler StaplerRequest Extension Symbol artifactManager public class ArtifactManagerConfiguration extends GlobalConfiguration public static ArtifactManagerConfiguration get return Jenkins getInstance getInjector getInstance ArtifactManagerConfiguration class private final DescribableList ArtifactManagerFactory ArtifactManagerFactoryDescriptor artifactManagerFactories new DescribableList ArtifactManagerFactory ArtifactManagerFactoryDescriptor this public ArtifactManagerConfiguration load private Object readResolve artifactManagerFactories setOwner this return this public DescribableList ArtifactManagerFactory ArtifactManagerFactoryDescriptor getArtifactManagerFactories return artifactManagerFactories Override public boolean configure StaplerRequest req JSONObject json throws FormException try artifactManagerFactories rebuildHetero req json ArtifactManagerFactoryDescriptor all artifactManagerFactories return true catch IOException x throw new FormException x artifactManagerFactoriespackage jenkins model import hudson ExtensionPoint import hudson model AbstractDescribableImpl import hudson model Run import javax annotation CheckForNull import org kohsuke stapler DataBoundConstructor public abstract class ArtifactManagerFactory extends AbstractDescribableImpl ArtifactManagerFactory implements ExtensionPoint public abstract CheckForNull ArtifactManager managerFor Run build Override public ArtifactManagerFactoryDescriptor getDescriptor return ArtifactManagerFactoryDescriptor super getDescriptorpackage jenkins model import hudson DescriptorExtensionList import hudson model Descriptor public abstract class ArtifactManagerFactoryDescriptor extends Descriptor ArtifactManagerFactory public static DescriptorExtensionList ArtifactManagerFactory ArtifactManagerFactoryDescriptor all return Jenkins getInstance getDescriptorList ArtifactManagerFactory classpackage com twitter sdk android core internal util import android content Context import android content res TypedArray import android util AttributeSet import android widget ImageView import com twitter sdk android core R public class AspectRatioImageView extends ImageView private static final float DEFAULT ASPECT RATIO 1 0f private static final int DEFAULT ADJUST DIMENSION 0 defined by attrs xml enum static final int ADJUST DIMENSION HEIGHT 0 static final int ADJUST DIMENSION WIDTH 1 private double aspectRatio width to height ratio private int dimensionToAdjust ADJUST DIMENSION HEIGHT or ADJUST DIMENSION WIDTH public AspectRatioImageView Context context this context null public AspectRatioImageView Context context AttributeSet attrs super context attrs final TypedArray a context obtainStyledAttributes attrs R styleable tw AspectRatioImageView try aspectRatio a getFloat R styleable tw AspectRatioImageView tw image aspect ratio DEFAULT ASPECT RATIO dimensionToAdjust a getInt R styleable tw AspectRatioImageView tw image dimension to adjust DEFAULT ADJUST DIMENSION finally a recycle public double getAspectRatio return aspectRatio public int getDimensionToAdjust return dimensionToAdjust public void setAspectRatio final double aspectRatio this aspectRatio aspectRatio public void resetSize if getMeasuredWidth 0 getMeasuredHeight 0 return measure MeasureSpec makeMeasureSpec 0 MeasureSpec EXACTLY MeasureSpec makeMeasureSpec 0 MeasureSpec EXACTLY layout 0 0 0 0 Override protected void onMeasure int widthMeasureSpec int heightMeasureSpec super onMeasure widthMeasureSpec heightMeasureSpec int width getMeasuredWidth int height getMeasuredHeight if dimensionToAdjust ADJUST DIMENSION HEIGHT height calculateHeight width aspectRatio else width calculateWidth height aspectRatio setMeasuredDimension width height int calculateHeight int width double ratio if ratio 0 return 0 return int Math round width ratio int calculateWidth int height double ratio return int Math round height ratiopackage com twitter sdk android core internal util import android test AndroidTestCase import android view LayoutInflater import android view View import android view ViewGroup import android widget LinearLayout import com twitter sdk android core R public class AspectRatioImageViewTest extends AndroidTestCase private static final double TEST ASPECT RATIO 2 0 private static final float DELTA 0 001f private AspectRatioImageView getHeightAdjustedView return AspectRatioImageView getInflatedLayout findViewById R id height adjusted view private AspectRatioImageView getWidthAdjustedView return AspectRatioImageView getInflatedLayout findViewById R id width adjusted view public void testHeightAdjusted final AspectRatioImageView imageView getHeightAdjustedView assertEquals 1 6 imageView getAspectRatio DELTA assertEquals AspectRatioImageView ADJUST DIMENSION HEIGHT imageView getDimensionToAdjust public void testWidthAdjusted final AspectRatioImageView imageView getWidthAdjustedView assertEquals 1 2 imageView getAspectRatio DELTA assertEquals AspectRatioImageView ADJUST DIMENSION WIDTH imageView getDimensionToAdjust private View getInflatedLayout final ViewGroup group new LinearLayout getContext return LayoutInflater from getContext inflate R layout activity aspect ratio image view test group true public void testSetAspectRatio final AspectRatioImageView av new AspectRatioImageView getContext av setAspectRatio TEST ASPECT RATIO assertEquals TEST ASPECT RATIO av getAspectRatio public void testSetAspectRatio xml final AspectRatioImageView av getHeightAdjustedView av setAspectRatio TEST ASPECT RATIO assertEquals TEST ASPECT RATIO av getAspectRatio public void testCalculateHeight final AspectRatioImageView av new AspectRatioImageView getContext assertEquals 400 av calculateHeight 600 1 5 assertEquals 600 av calculateHeight 300 0 5 assertEquals 300 av calculateHeight 300 1 0 assertEquals 0 av calculateHeight 0 1 3 assertEquals 0 av calculateHeight 100 0 sub pixel space for images mean aspect ratios cannot be respected assertEquals 1 av calculateHeight 10 15 0 public void testCalculateWidth final AspectRatioImageView av new AspectRatioImageView getContext assertEquals 300 av calculateWidth 200 1 5 assertEquals 201 av calculateWidth 401 0 5 assertEquals 200 av calculateWidth 200 1 0 assertEquals 0 av calculateWidth 0 1 3 assertEquals 0 av calculateWidth 100 0 sub pixel space for images mean aspect ratios cannot be respected assertEquals 1 av calculateWidth 10 0 05package jenkins model import hudson Extension import hudson model UnprotectedRootAction import hudson util TimeUnit2 import org jenkinsci Symbol import org kohsuke stapler StaplerRequest import org kohsuke stapler StaplerResponse import javax servlet ServletException import javax servlet http HttpServletResponse import java io IOException import java lang reflect InvocationTargetException import java lang reflect Method import java net URL import java util Enumeration Extension Symbol assetManager public class AssetManager implements UnprotectedRootAction not shown in the UI Override public String getIconFileName return null Override public String getDisplayName return null Override public String getUrlName return assets public void doDynamic StaplerRequest req StaplerResponse rsp throws IOException ServletException String path req getRestOfPath URL resource findResource path if resource null rsp setStatus HttpServletResponse SC NOT FOUND return Stapler routes requests like the static foo bar zot to be treated like foo bar zot and this is used to serve long expiration header by using Jenkins VERSION HASH as to create unique URLs Recognize that and set a long expiration header String requestPath req getRequestURI substring req getContextPath length boolean staticLink requestPath startsWith static long expires staticLink TimeUnit2 DAYS toMillis 365 1 use serveLocalizedFile to support automatic locale selection rsp serveLocalizedFile req resource expires private URL findResource String path throws IOException try if path contains crude avoidance of directory traversal attack throw new IllegalArgumentException path String name if path charAt 0 name assets path else name assets path ClassLoader cl Jenkins class getClassLoader URL url URL findResource invoke cl name if url null pick the last one which is the one closest to the leaf of the classloader tree Enumeration URL e cl getResources name while e hasMoreElements url e nextElement return url catch InvocationTargetException IllegalAccessException e throw new Error e private static final Method findResource init private static Method init try Method m ClassLoader class getDeclaredMethod findResource String class m setAccessible true return m catch NoSuchMethodException e throw Error new NoSuchMethodError initCause epackage hudson model import hudson security ACL import hudson util StreamTaskListener import java io File import java io IOException import java util Date import java util concurrent TimeUnit import java util logging Level import jenkins model Jenkins import jenkins util SystemProperties public abstract class AsyncAperiodicWork extends AperiodicWork private static final long LOG ROTATE MINUTES SystemProperties getLong AsyncAperiodicWork class getName logRotateMinutes TimeUnit DAYS toMinutes 1 private static final long LOG ROTATE SIZE SystemProperties getLong AsyncAperiodicWork class getName logRotateSize 1L private final long logRotateMillis private final long logRotateSize private long lastRotateMillis Long MIN VALUE public final String name private Thread thread protected AsyncAperiodicWork String name this name name this logRotateMillis TimeUnit MINUTES toMillis SystemProperties getLong getClass getName logRotateMinutes LOG ROTATE MINUTES this logRotateSize SystemProperties getLong getClass getName logRotateSize LOG ROTATE SIZE Override public final void doAperiodicRun try if thread null thread isAlive logger log getSlowLoggingLevel 0 thread is still running Execution aborted name return thread new Thread new Runnable public void run logger log getNormalLoggingLevel Started 0 name long startTime System currentTimeMillis long stopTime StreamTaskListener l createListener try l getLogger printf Started at tc n new Date startTime ACL impersonate ACL SYSTEM execute l catch IOException e e printStackTrace l fatalError e getMessage catch InterruptedException e e printStackTrace l fatalError aborted finally stopTime System currentTimeMillis try l getLogger printf Finished at tc dms n new Date stopTime stopTime startTime finally l closeQuietly logger log getNormalLoggingLevel Finished 0 1 number ms new Object name stopTime startTime name thread thread start catch Throwable t logger log Level SEVERE name thread failed with error t protected StreamTaskListener createListener File f getLogFile if f getParentFile isDirectory if f getParentFile mkdirs logger log getErrorLoggingLevel Could not create directory 0 f getParentFile if f isFile if lastRotateMillis logRotateMillis System currentTimeMillis logRotateSize 0 f length logRotateSize lastRotateMillis System currentTimeMillis File prev null for int i 5 i 0 i File curr i 0 f new File f getParentFile f getName i if curr isFile if prev null prev exists if curr renameTo prev logger log getErrorLoggingLevel Could not rotate log files 0 to 1 new Object curr prev else if curr delete logger log getErrorLoggingLevel Could not delete log file 0 to enable rotation curr prev curr else lastRotateMillis System currentTimeMillis migrate old log files the first time we start up File oldFile new File Jenkins getActiveInstance getRootDir f getName if oldFile isFile File newFile new File f getParentFile f getName 1 if newFile isFile if there has never been rotation then this is the first time if oldFile renameTo newFile logger log getNormalLoggingLevel Moved 0 to 1 new Object oldFile newFile else logger log getErrorLoggingLevel Could not move 0 to 1 new Object oldFile newFile try return new StreamTaskListener f true null catch IOException e throw new Error e protected File getLogFile return new File Jenkins getActiveInstance getRootDir logs tasks name log protected Level getNormalLoggingLevel return Level INFO protected Level getSlowLoggingLevel return getNormalLoggingLevel protected Level getErrorLoggingLevel return Level SEVERE protected abstract void execute TaskListener listener throws IOException InterruptedExceptionpackage jenkins management import hudson AbortException import hudson console AnnotatedLargeText import hudson model AdministrativeMonitor import hudson model TaskListener import hudson security ACL import hudson util StreamTaskListener import jenkins model Jenkins import jenkins security RekeySecretAdminMonitor import java io File import java io IOException import java nio charset Charset import java util logging Level import java util logging Logger import javax annotation Nonnull public abstract class AsynchronousAdministrativeMonitor extends AdministrativeMonitor private volatile FixThread fixThread public boolean isFixingActive return fixThread null fixThread isAlive public AnnotatedLargeText getLogText return new AnnotatedLargeText AsynchronousAdministrativeMonitor getLogFile Charset defaultCharset isFixingActive this protected File getLogFile File base getBaseDir base mkdirs return new File base log protected File getBaseDir return new File Jenkins getInstance getRootDir getClass getName public abstract String getDisplayName protected synchronized Thread start boolean forceRestart if forceRestart isFixingActive fixThread interrupt if forceRestart isFixingActive fixThread new FixThread fixThread start return fixThread protected abstract void fix TaskListener listener throws Exception protected class FixThread extends Thread FixThread super getDisplayName Override public void run ACL impersonate ACL SYSTEM StreamTaskListener listener null try listener new StreamTaskListener getLogFile try doRun listener finally listener close catch IOException ex if listener null LOGGER log Level SEVERE Cannot create listener for getName ex TODO throw IllegalStateException else LOGGER log Level WARNING Cannot close listener for getName ex private void doRun Nonnull TaskListener listener try fix listener catch AbortException e listener error e getMessage catch Throwable e e printStackTrace listener error getName failed LOGGER log Level WARNING getName failed e private static final Logger LOGGER Logger getLogger AsynchronousAdministrativeMonitor class getNamepackage jenkins model queue import hudson model Executor import hudson model OneOffExecutor import hudson model Queue FlyweightTask import hudson model Resource import hudson model ResourceActivity import hudson model ResourceController import hudson model ResourceList import javax annotation CheckForNull import javax annotation Nonnull import javax annotation concurrent GuardedBy import org kohsuke accmod Restricted import org kohsuke accmod restrictions NoExternalUse public abstract class AsynchronousExecution extends RuntimeException GuardedBy this private Executor executor GuardedBy this private CheckForNull Throwable result protected AsynchronousExecution public abstract void interrupt boolean forShutdown public abstract boolean blocksRestart public abstract boolean displayCell CheckForNull public synchronized final Executor getExecutor return executor Restricted NoExternalUse class public synchronized final void setExecutor Nonnull Executor executor assert this executor null this executor executor if result null executor completedAsynchronous result NULL result null result null public synchronized final void completed CheckForNull Throwable error if executor null executor completedAsynchronous error else result error null NULL error private static final Throwable NULL new Throwable NULLpackage hudson model import hudson security ACL import hudson util StreamTaskListener import java io File import java io IOException import java util Date import java util concurrent TimeUnit import java util logging Level import java util logging LogRecord import jenkins model Jenkins import jenkins util SystemProperties public abstract class AsyncPeriodicWork extends PeriodicWork private static final long LOG ROTATE MINUTES SystemProperties getLong AsyncPeriodicWork class getName logRotateMinutes TimeUnit DAYS toMinutes 1 private static final long LOG ROTATE SIZE SystemProperties getLong AsyncPeriodicWork class getName logRotateSize 1L private final long logRotateMillis private final long logRotateSize private long lastRotateMillis Long MIN VALUE public final String name private Thread thread protected AsyncPeriodicWork String name this name name this logRotateMillis TimeUnit MINUTES toMillis SystemProperties getLong getClass getName logRotateMinutes LOG ROTATE MINUTES this logRotateSize SystemProperties getLong getClass getName logRotateSize LOG ROTATE SIZE SuppressWarnings deprecation in this case we really want to use PeriodicWork logger since it reports the impl class public final void doRun try if thread null thread isAlive logger log this getSlowLoggingLevel 0 thread is still running Execution aborted name return thread new Thread new Runnable public void run logger log getNormalLoggingLevel Started 0 name long startTime System currentTimeMillis long stopTime StreamTaskListener l createListener try l getLogger printf Started at tc n new Date startTime ACL impersonate ACL SYSTEM execute l catch IOException e e printStackTrace l fatalError e getMessage catch InterruptedException e e printStackTrace l fatalError aborted finally stopTime System currentTimeMillis try l getLogger printf Finished at tc dms n new Date stopTime stopTime startTime finally l closeQuietly logger log getNormalLoggingLevel Finished 0 1 number ms new Object name stopTime startTime name thread thread start catch Throwable t LogRecord lr new LogRecord this getErrorLoggingLevel 0 thread failed with error lr setThrown t lr setParameters new Object name logger log lr protected StreamTaskListener createListener File f getLogFile if f getParentFile isDirectory if f getParentFile mkdirs logger log getErrorLoggingLevel Could not create directory 0 f getParentFile if f isFile if lastRotateMillis logRotateMillis System currentTimeMillis logRotateSize 0 f length logRotateSize lastRotateMillis System currentTimeMillis File prev null for int i 5 i 0 i File curr i 0 f new File f getParentFile f getName i if curr isFile if prev null prev exists if curr renameTo prev logger log getErrorLoggingLevel Could not rotate log files 0 to 1 new Object curr prev else if curr delete logger log getErrorLoggingLevel Could not delete log file 0 to enable rotation curr prev curr else lastRotateMillis System currentTimeMillis migrate old log files the first time we start up File oldFile new File Jenkins getActiveInstance getRootDir f getName if oldFile isFile File newFile new File f getParentFile f getName 1 if newFile isFile if there has never been rotation then this is the first time if oldFile renameTo newFile logger log getNormalLoggingLevel Moved 0 to 1 new Object oldFile newFile else logger log getErrorLoggingLevel Could not move 0 to 1 new Object oldFile newFile try return new StreamTaskListener f true null catch IOException e throw new Error e protected File getLogFile return new File Jenkins getActiveInstance getRootDir logs tasks name log protected Level getNormalLoggingLevel return Level INFO protected Level getSlowLoggingLevel return getNormalLoggingLevel protected Level getErrorLoggingLevel return Level SEVERE protected abstract void execute TaskListener listener throws IOException InterruptedExceptionpackage jenkins util import com google common util concurrent SettableFuture import hudson remoting AtmostOneThreadExecutor import hudson util DaemonThreadFactory import hudson util NamingThreadFactory import java util concurrent Callable import java util concurrent Executor import java util concurrent ExecutorService import java util concurrent Future public class AtmostOneTaskExecutor V private final ExecutorService base private final Callable V task private SettableFuture V pending private SettableFuture V inprogress public AtmostOneTaskExecutor ExecutorService base Callable V task this base base this task task public AtmostOneTaskExecutor Callable V task this new AtmostOneThreadExecutor new NamingThreadFactory new DaemonThreadFactory String format AtmostOneTaskExecutor s task task public synchronized Future V submit if pending null pending SettableFuture create maybeRun return pending private synchronized void maybeRun if inprogress null pending null base submit new Callable Void Override public Void call throws Exception synchronized AtmostOneTaskExecutor this everyone who submits after this should form a next batch inprogress pending pending null try inprogress set task call catch Throwable t inprogress setException t finally synchronized AtmostOneTaskExecutor this if next one is pending get that scheduled inprogress null maybeRun return nullpackage hudson util import hudson Util import java io BufferedWriter import java io File import java io FileOutputStream import java io FileWriter import java io IOException import java io OutputStreamWriter import java io Writer import java nio charset Charset public class AtomicFileWriter extends Writer private final Writer core private final File tmpFile private final File destFile public AtomicFileWriter File f throws IOException this f UTF 8 public AtomicFileWriter File f String encoding throws IOException File dir f getParentFile try dir mkdirs tmpFile File createTempFile atomic null dir catch IOException e throw new IOException Failed to create a temporary file in dir e destFile f if encoding null encoding Charset defaultCharset name core new BufferedWriter new OutputStreamWriter new FileOutputStream tmpFile encoding Override public void write int c throws IOException core write c Override public void write String str int off int len throws IOException core write str off len public void write char cbuf int off int len throws IOException core write cbuf off len public void flush throws IOException core flush public void close throws IOException core close public void abort throws IOException close tmpFile delete public void commit throws IOException close if destFile exists try Util deleteFile destFile catch IOException x tmpFile delete throw x tmpFile renameTo destFile Override protected void finalize throws Throwable one way or the other temporary file should be deleted close tmpFile delete public File getTemporaryFile return tmpFilepackage hudson security import org acegisecurity AuthenticationManager import org acegisecurity Authentication import org acegisecurity AuthenticationException import org acegisecurity DisabledException public class AuthenticationManagerProxy implements AuthenticationManager private volatile AuthenticationManager delegate public Authentication authenticate Authentication authentication throws AuthenticationException AuthenticationManager m delegate fix the reference we are working with if m null throw new DisabledException Authentication service is still not ready yet else return m authenticate authentication public void setDelegate AuthenticationManager manager this delegate managerpackage hudson security import java util Properties import java util logging Logger import java util logging Level import java io IOException import javax servlet http HttpServletRequest import javax servlet http HttpServletResponse import hudson Util import jenkins security SecurityListener import org acegisecurity Authentication import org acegisecurity AuthenticationException import org acegisecurity ui webapp AuthenticationProcessingFilter public class AuthenticationProcessingFilter2 extends AuthenticationProcessingFilter Override protected String determineTargetUrl HttpServletRequest request String targetUrl request getParameter from request getSession setAttribute from targetUrl if targetUrl null return getDefaultTargetUrl if Util isSafeToRedirectTo targetUrl return avoid open redirect URL returned from determineTargetUrl is resolved against the context path whereas the from URL is resolved against the top of the website so adjust this if targetUrl startsWith request getContextPath return targetUrl substring request getContextPath length not sure when this happens but apparently this happens in some case see 1274 return targetUrl Override protected String determineFailureUrl HttpServletRequest request AuthenticationException failed Properties excMap getExceptionMappings String failedClassName failed getClass getName String whereFrom request getParameter from request getSession setAttribute from whereFrom return excMap getProperty failedClassName getAuthenticationFailureUrl Override protected void onSuccessfulAuthentication HttpServletRequest request HttpServletResponse response Authentication authResult throws IOException super onSuccessfulAuthentication request response authResult make sure we have a session to store this successful authentication given that we no longer let HttpSessionContextIntegrationFilter2 to create sessions HttpSessionContextIntegrationFilter stores the updated SecurityContext object into this session later either when a redirect is issued via its HttpResponseWrapper or when the execution returns to its doFilter method request getSession invalidate request getSession SecurityListener fireLoggedIn authResult getName Override protected void onUnsuccessfulAuthentication HttpServletRequest request HttpServletResponse response AuthenticationException failed throws IOException super onUnsuccessfulAuthentication request response failed LOGGER log Level FINE Login attempt failed failed Authentication auth failed getAuthentication if auth null SecurityListener fireFailedToLogIn auth getName private static final Logger LOGGER Logger getLogger AuthenticationProcessingFilter2 class getNamepackage com twitter sdk android core identity import android app Activity import android content Intent import com twitter sdk android core Callback import com twitter sdk android core Result import com twitter sdk android core TwitterAuthConfig import com twitter sdk android core TwitterAuthException import com twitter sdk android core TwitterAuthToken import com twitter sdk android core TwitterSession public abstract class AuthHandler static final String EXTRA TOKEN tk static final String EXTRA TOKEN SECRET ts static final String EXTRA SCREEN NAME screen name static final String EXTRA USER ID user id static final String EXTRA AUTH ERROR auth error static final int RESULT CODE ERROR Activity RESULT FIRST USER protected final int requestCode private final TwitterAuthConfig config private final Callback TwitterSession callback AuthHandler TwitterAuthConfig authConfig Callback TwitterSession callback int requestCode config authConfig this callback callback this requestCode requestCode TwitterAuthConfig getAuthConfig return config Callback TwitterSession getCallback return callback public abstract boolean authorize Activity activity public boolean handleOnActivityResult int requestCode int resultCode Intent data if this requestCode requestCode return false final Callback TwitterSession callback getCallback if callback null if resultCode Activity RESULT OK final String token data getStringExtra EXTRA TOKEN final String tokenSecret data getStringExtra EXTRA TOKEN SECRET final String screenName data getStringExtra EXTRA SCREEN NAME final long userId data getLongExtra EXTRA USER ID 0L callback success new Result new TwitterSession new TwitterAuthToken token tokenSecret userId screenName null else if data null data hasExtra EXTRA AUTH ERROR callback failure TwitterAuthException data getSerializableExtra EXTRA AUTH ERROR else callback failure new TwitterAuthException Authorize failed return truepackage hudson security import hudson DescriptorExtensionList import hudson Extension import hudson ExtensionPoint import hudson model import hudson slaves Cloud import hudson util DescriptorList import java io Serializable import java util Collection import java util Collections import javax annotation Nonnull import jenkins model Jenkins import net sf json JSONObject import org acegisecurity Authentication import org jenkinsci Symbol import org kohsuke stapler StaplerRequest public abstract class AuthorizationStrategy extends AbstractDescribableImpl AuthorizationStrategy implements ExtensionPoint public abstract Nonnull ACL getRootACL Deprecated public Nonnull ACL getACL Nonnull AbstractProject project return getACL Job project public Nonnull ACL getACL Nonnull Job project return getRootACL public Nonnull ACL getACL final Nonnull View item return new ACL Override public boolean hasPermission Authentication a Permission permission ACL base item getOwner getACL boolean hasPermission base hasPermission a permission if hasPermission permission View READ return base hasPermission a View CONFIGURE item getItems isEmpty return hasPermission public Nonnull ACL getACL Nonnull AbstractItem item return getRootACL public Nonnull ACL getACL Nonnull User user return getRootACL public Nonnull ACL getACL Nonnull Computer computer return getACL computer getNode public Nonnull ACL getACL Nonnull Cloud cloud return getRootACL public Nonnull ACL getACL Nonnull Node node return getRootACL public abstract Nonnull Collection String getGroups public static Nonnull DescriptorExtensionList AuthorizationStrategy Descriptor AuthorizationStrategy all return Jenkins getInstance AuthorizationStrategy Descriptor AuthorizationStrategy getDescriptorList AuthorizationStrategy class Deprecated public static final DescriptorList AuthorizationStrategy LIST new DescriptorList AuthorizationStrategy AuthorizationStrategy class public static final AuthorizationStrategy UNSECURED new Unsecured public static final class Unsecured extends AuthorizationStrategy implements Serializable private Object readResolve return UNSECURED Override public Nonnull ACL getRootACL return UNSECURED ACL Override public Nonnull Collection String getGroups return Collections emptySet private static final ACL UNSECURED ACL new ACL Override public boolean hasPermission Authentication a Permission permission return true Extension Symbol unsecured public static final class DescriptorImpl extends Descriptor AuthorizationStrategy Override public String getDisplayName return Messages AuthorizationStrategy DisplayName Override public Nonnull AuthorizationStrategy newInstance StaplerRequest req JSONObject formData throws FormException return UNSECUREDpackage com twitter sdk android core identity import android app Activity import com twitter sdk android core TwitterCore import java util concurrent atomic AtomicReference import io fabric sdk android Fabric class AuthState final AtomicReference AuthHandler authHandlerRef new AtomicReference null public boolean beginAuthorize Activity activity AuthHandler authHandler boolean result false if isAuthorizeInProgress Fabric getLogger w TwitterCore TAG Authorize already in progress else if authHandler authorize activity result authHandlerRef compareAndSet null authHandler if result Fabric getLogger w TwitterCore TAG Failed to update authHandler authorize already in progress return result public void endAuthorize authHandlerRef set null public boolean isAuthorizeInProgress return authHandlerRef get null public AuthHandler getAuthHandler return authHandlerRef getpackage com twitter sdk android core import com google gson annotations SerializedName public abstract class AuthToken SerializedName created at protected final long createdAt public AuthToken createdAt System currentTimeMillis protected AuthToken long createdAt this createdAt createdAt public abstract boolean isExpiredpackage com twitter sdk android core import com google gson Gson import com google gson JsonDeserializationContext import com google gson JsonDeserializer import com google gson JsonElement import com google gson JsonObject import com google gson JsonParseException import com google gson JsonPrimitive import com google gson JsonSerializationContext import com google gson JsonSerializer import com twitter sdk android core internal oauth GuestAuthToken import com twitter sdk android core internal oauth OAuth2Token import java lang reflect Type import java util HashMap import java util Map public class AuthTokenAdapter implements JsonSerializer AuthToken JsonDeserializer AuthToken private static final String AUTH TYPE auth type private static final String AUTH TOKEN auth token static final Map String Class extends AuthToken authTypeRegistry new HashMap static authTypeRegistry put oauth1a TwitterAuthToken class authTypeRegistry put oauth2 OAuth2Token class authTypeRegistry put guest GuestAuthToken class private final Gson gson public AuthTokenAdapter this gson new Gson Override public JsonElement serialize AuthToken src Type typeOfSrc JsonSerializationContext context final JsonObject jsonObject new JsonObject jsonObject addProperty AUTH TYPE getAuthTypeString src getClass jsonObject add AUTH TOKEN gson toJsonTree src return jsonObject Override public AuthToken deserialize JsonElement json Type typeOfT JsonDeserializationContext context throws JsonParseException final JsonObject jsonObject json getAsJsonObject final JsonPrimitive jsonAuthType jsonObject getAsJsonPrimitive AUTH TYPE final String authType jsonAuthType getAsString final JsonElement jsonAuthToken jsonObject get AUTH TOKEN return gson fromJson jsonAuthToken authTypeRegistry get authType static String getAuthTypeString Class extends AuthToken authTokenClass for Map Entry String Class extends AuthToken entry authTypeRegistry entrySet if entry getValue equals authTokenClass return entry getKey returnpackage hudson scm import hudson model AbstractProject import jenkins model Jenkins Deprecated final class AutoBrowserHolder private int cacheGeneration private RepositoryBrowser cache private SCM owner public AutoBrowserHolder SCM owner this owner owner public RepositoryBrowser get if cacheGeneration 1 return cache SCMDescriptor d owner getDescriptor RepositoryBrowser dflt owner guessBrowser if dflt null cache dflt cacheGeneration 1 return cache int g d generation if g cacheGeneration cacheGeneration g cache infer return cache private RepositoryBrowser infer for AbstractProject p Jenkins getInstance getAllItems AbstractProject class SCM scm p getScm if scm null scm getClass owner getClass scm getBrowser null SCMDescriptor scm getDescriptor isBrowserReusable scm owner return scm getBrowser return nullpackage hudson model import hudson search Search import jenkins model Jenkins import org kohsuke stapler HttpResponse import org kohsuke stapler StaplerRequest import org kohsuke stapler StaplerResponse import org kohsuke stapler export Flavor import javax servlet ServletException import java io IOException import java util ArrayList import java util Arrays import java util List import javax annotation CheckForNull public class AutoCompletionCandidates implements HttpResponse private final List String values new ArrayList String public AutoCompletionCandidates add String v values add v return this public AutoCompletionCandidates add String v values addAll Arrays asList v return this public List String getValues return values public void generateResponse StaplerRequest req StaplerResponse rsp Object o throws IOException ServletException Search Result r new Search Result for String value values r suggestions add new hudson search Search Item value rsp serveExposedBean req r Flavor JSON public static T extends Item AutoCompletionCandidates ofJobNames final Class T type final String value CheckForNull Item self ItemGroup container if self container container self getParent return ofJobNames type value container public static T extends Item AutoCompletionCandidates ofJobNames final Class T type final String value ItemGroup container final AutoCompletionCandidates candidates new AutoCompletionCandidates class Visitor extends ItemVisitor String prefix Visitor String prefix this prefix prefix Override public void onItem Item i String n contextualNameOf i if n startsWith value value startsWith n foobar is a valid candidate if the current value is foo Also we need to visit foo if the current value is foo bar value length n length n substring value length contains but foobar zot isn t if the current value is foo we ll first show foobar and then wait for the user to type to show the rest i hasPermission Item READ and read permission required if type isInstance i n startsWith value candidates add n recurse String oldPrefix prefix prefix n super onItem i prefix oldPrefix private String contextualNameOf Item i if prefix endsWith prefix length 0 return prefix i getName else return prefix i getName if container null container Jenkins getInstance new Visitor onItemGroup Jenkins getInstance else new Visitor onItemGroup container if value startsWith new Visitor onItemGroup Jenkins getInstance for String p value startsWith p p container Item container getParent new Visitor p onItemGroup container return candidatespackage hudson util import org kohsuke accmod Restricted import org kohsuke accmod restrictions NoExternalUse public class AWTProblem extends BootFailure Restricted NoExternalUse class Deprecated public final Throwable cause public AWTProblem Throwable cause super cause this cause causepackage hudson model queue import com google common collect Iterables import hudson Extension import jenkins util SystemProperties import hudson model Computer import hudson model Executor import jenkins model Jenkins import hudson model InvisibleAction import hudson model Queue BuildableItem import hudson model queue MappingWorksheet ExecutorChunk import hudson model queue MappingWorksheet ExecutorSlot import hudson model queue MappingWorksheet Mapping import hudson model queue MappingWorksheet WorkChunk import hudson util TimeUnit2 import java util ArrayList import java util Collections import java util HashMap import java util List import java util Map import java util Map Entry public class BackFiller extends LoadPredictor private boolean recursion false Override public Iterable FutureLoad predict MappingWorksheet plan Computer computer long start long end TimeRange timeRange new TimeRange start end start List FutureLoad loads new ArrayList FutureLoad for BuildableItem bi Jenkins getInstance getQueue getBuildableItems TentativePlan tp bi getAction TentativePlan class if tp null do this even for bi plan item ensures that we have FIFO semantics in tentative plans tp makeTentativePlan bi if tp null continue no viable plan if tp isStale if the tentative plan is stale just keep on pushing it to the current time if we recreate the plan it ll be put at the end of the queue whereas this job should actually get priority over others tp range shiftTo System currentTimeMillis don t let its own tentative plan count when considering a scheduling for a job if plan item bi continue no overlap in the time span meaning this plan is for a distant future if timeRange overlapsWith tp range continue if this tentative plan has no baring on this computer that s ignorable Integer i tp footprint get computer if i null continue return Collections singleton tp range toFutureLoad i return loads private static final class PseudoExecutorSlot extends ExecutorSlot private Executor executor private PseudoExecutorSlot Executor executor this executor executor Override public Executor getExecutor return executor Override public boolean isAvailable return true this slot isn t executable Override protected void set WorkUnit p throw new UnsupportedOperationException private TentativePlan makeTentativePlan BuildableItem bi if recursion return null recursion true try pretend for now that all executors are available and decide some assignment that s executable List PseudoExecutorSlot slots new ArrayList PseudoExecutorSlot for Computer c Jenkins getInstance getComputers if c isOffline continue for Executor e c getExecutors slots add new PseudoExecutorSlot e also ignore all load predictions as we just want to figure out some executable assignment and we are not trying to figure out if this task is executable right now MappingWorksheet worksheet new MappingWorksheet bi slots Collections LoadPredictor emptyList Mapping m Jenkins getInstance getQueue getLoadBalancer map bi task worksheet if m null return null figure out how many executors we need on each computer Map Computer Integer footprint new HashMap Computer Integer for Entry WorkChunk ExecutorChunk e m toMap entrySet Computer c e getValue computer Integer v footprint get c if v null v 0 v e getKey size footprint put c v the point of a tentative plan is to displace other jobs to create a point in time where this task can start executing An incorrectly estimated duration is not a problem in this regard as we just need enough idle executors in the right moment The downside of guessing the duration wrong is that we can end up creating tentative plans afterward that may be incorrect but those plans will be rebuilt long d bi task getEstimatedDuration if d 0 d TimeUnit2 MINUTES toMillis 5 TimeRange slot new TimeRange System currentTimeMillis d now based on the real predicted loads figure out the approximation of when we can start executing this guy for Entry Computer Integer e footprint entrySet Computer computer e getKey Timeline timeline new Timeline for LoadPredictor lp LoadPredictor all for FutureLoad fl Iterables limit lp predict worksheet computer slot start slot end 100 timeline insert fl startTime fl startTime fl duration fl numExecutors Long x timeline fit slot start slot duration computer countExecutors e getValue if no suitable range was found in slot start slot end slot end would be a good approximation if x null x slot end slot slot shiftTo x TentativePlan tp new TentativePlan footprint slot bi addAction tp return tp finally recursion false private static final class TimeRange public final long start public final long duration public final long end private TimeRange long start long duration this start start this duration duration this end start duration public boolean overlapsWith TimeRange that return this start that start that start this end that start this start this start that end public FutureLoad toFutureLoad int size return new FutureLoad start duration size public TimeRange shiftTo long newStart if newStart start return this return new TimeRange newStart duration public static final class TentativePlan extends InvisibleAction private final Map Computer Integer footprint public final TimeRange range public TentativePlan Map Computer Integer footprint TimeRange range this footprint footprint this range range public Object writeReplace don t persist return null public boolean isStale return range end System currentTimeMillis Extension public static BackFiller newInstance if SystemProperties getBoolean BackFiller class getName return new BackFiller return nullpackage hudson model import hudson util ColorPalette import jenkins model Jenkins import org jenkins ui icon Icon import org jvnet localizer LocaleProvider import org jvnet localizer Localizable import org kohsuke stapler Stapler import java awt import java util Locale public enum BallColor implements StatusIcon RED red Messages BallColor Failed ColorPalette RED RED ANIME red anime Messages BallColor InProgress ColorPalette RED YELLOW yellow Messages BallColor Unstable ColorPalette YELLOW YELLOW ANIME yellow anime Messages BallColor InProgress ColorPalette YELLOW BLUE blue Messages BallColor Success ColorPalette BLUE BLUE ANIME blue anime Messages BallColor InProgress ColorPalette BLUE for historical reasons they are called grey GREY grey Messages BallColor Pending ColorPalette GREY GREY ANIME grey anime Messages BallColor InProgress ColorPalette GREY DISABLED disabled Messages BallColor Disabled ColorPalette GREY DISABLED ANIME disabled anime Messages BallColor InProgress ColorPalette GREY ABORTED aborted Messages BallColor Aborted ColorPalette GREY ABORTED ANIME aborted anime Messages BallColor InProgress ColorPalette GREY NOTBUILT nobuilt Messages BallColor NotBuilt ColorPalette GREY NOTBUILT ANIME nobuilt anime Messages BallColor InProgress ColorPalette GREY private final Localizable description private final String iconName private final String iconClassName private final String image private final Color baseColor BallColor String image Localizable description Color baseColor this iconName Icon toNormalizedIconName image this iconClassName Icon toNormalizedIconNameClass image this baseColor baseColor name is not usable in the constructor so I have to repeat the name twice in the constants definition this image image image endsWith anime gif png this description description public String getIconName return iconName public String getIconClassName return iconClassName public String getImage return image public String getImageOf String size return Stapler getCurrentRequest getContextPath Jenkins RESOURCE PATH images size image public String getDescription return description toString LocaleProvider getLocale public Color getBaseColor return baseColor public String getHtmlBaseColor return String format 06X baseColor getRGB 0xFFFFFF Override public String toString return name toLowerCase Locale ENGLISH public BallColor anime if isAnimated return this else return valueOf name ANIME public BallColor noAnime if isAnimated return valueOf name substring 0 name length ANIME length else return this public boolean isAnimated return name endsWith ANIMEpackage com zxy recovery test import android os Bundle import android support annotation Nullable import android support v7 app AppCompatActivity import android util Log import com zxy recovery core ActivityStackCompat import com zxy recovery core Recovery public class BaseActivity extends AppCompatActivity Override protected void onCreate Nullable Bundle savedInstanceState super onCreate savedInstanceState Override protected void onStart super onStart getWindow getDecorView post new Runnable Override public void run int count ActivityStackCompat getActivityCount Recovery getInstance getContext Log e zxy realCount count String baseActivity ActivityStackCompat getBaseActivityName Recovery getInstance getContext Log e zxy realBaseActivityName baseActivitypackage com kaku colorfulnews mvp ui fragment base import android os Bundle import android support annotation Nullable import android support v4 app Fragment import android view LayoutInflater import android view View import android view ViewGroup import com kaku colorfulnews App import com kaku colorfulnews di component DaggerFragmentComponent import com kaku colorfulnews di component FragmentComponent import com kaku colorfulnews di module FragmentModule import com kaku colorfulnews mvp presenter base BasePresenter import com kaku colorfulnews utils MyUtils import com squareup leakcanary RefWatcher import butterknife ButterKnife import rx Subscription public abstract class BaseFragment T extends BasePresenter extends Fragment public FragmentComponent getFragmentComponent return mFragmentComponent protected FragmentComponent mFragmentComponent protected T mPresenter private View mFragmentView public abstract void initInjector public abstract void initViews View view public abstract int getLayoutId protected Subscription mSubscription Override public void onCreate Nullable Bundle savedInstanceState super onCreate savedInstanceState mFragmentComponent DaggerFragmentComponent builder applicationComponent App getActivity getApplication getApplicationComponent fragmentModule new FragmentModule this build initInjector Nullable Override public View onCreateView LayoutInflater inflater Nullable ViewGroup container Nullable Bundle savedInstanceState if mFragmentView null mFragmentView inflater inflate getLayoutId container false ButterKnife bind this mFragmentView initViews mFragmentView return mFragmentView Override public void onDestroy super onDestroy RefWatcher refWatcher App getRefWatcher getActivity refWatcher watch this if mPresenter null mPresenter onDestroy MyUtils cancelSubscription mSubscriptionpackage hudson scheduler import antlr ANTLRException import antlr LLkParser import antlr ParserSharedInputState import antlr SemanticException import antlr Token import antlr TokenBuffer import antlr TokenStream import antlr TokenStreamException import jenkins util SystemProperties abstract class BaseParser extends LLkParser lower uppser bounds of fields inclusive static final int LOWER BOUNDS new int 0 0 1 1 0 static final int UPPER BOUNDS new int 59 23 31 12 7 protected Hash hash Hash zero protected BaseParser int i super i protected BaseParser ParserSharedInputState parserSharedInputState int i super parserSharedInputState i protected BaseParser TokenBuffer tokenBuffer int i super tokenBuffer i protected BaseParser TokenStream tokenStream int i super tokenStream i public void setHash Hash hash if hash null hash Hash zero this hash hash protected long doRange int start int end int step int field throws ANTLRException rangeCheck start field rangeCheck end field if step 0 error Messages BaseParser MustBePositive step if start end error Messages BaseParser StartEndReversed end start long bits 0 for int i start i end i step bits 1L i return bits protected long doRange int step int field throws ANTLRException return doRange LOWER BOUNDS field UPPER BOUNDS field step field protected long doHash int step int field throws ANTLRException int u UPPER BOUNDS field if field 2 u 28 day of month can vary depending on month so to make life simpler just use 1 28 that s always safe if field 4 u 6 Both 0 and 7 of day of week are Sunday For better distribution limit upper bound to 6 return doHash LOWER BOUNDS field u step field protected long doHash int s int e int step int field throws ANTLRException rangeCheck s field rangeCheck e field if step e s 1 error Messages BaseParser OutOfRange step 1 e s 1 throw new AssertionError else if step 1 long bits 0 for int i hash next step s i e i step bits 1L i assert bits 0 return bits else if step 0 error Messages BaseParser MustBePositive step throw new AssertionError else assert step NO STEP step 1 i e omitted in the case of hash is actually special means pick one value not step by 1 return 1L s hash next e 1 s protected void rangeCheck int value int field throws ANTLRException if value LOWER BOUNDS field UPPER BOUNDS field value error Messages BaseParser OutOfRange value LOWER BOUNDS field UPPER BOUNDS field private void error String msg throws TokenStreamException SemanticException Token token LT 0 throw new SemanticException msg token getFilename token getLine token getColumn protected Hash getHashForTokens return HASH TOKENS hash Hash zero public static boolean HASH TOKENS false equals SystemProperties getString BaseParser class getName hash public static final int NO STEP 1package com kaku colorfulnews mvp presenter base import android support annotation NonNull import com kaku colorfulnews mvp view base BaseView public interface BasePresenter void onResume void onCreate void attachView NonNull BaseView view void onDestroypackage com kaku colorfulnews mvp presenter base import android support annotation NonNull import com kaku colorfulnews listener RequestCallBack import com kaku colorfulnews mvp view base BaseView import com kaku colorfulnews utils MyUtils import rx Subscription public class BasePresenterImpl T extends BaseView E implements BasePresenter RequestCallBack E protected T mView protected Subscription mSubscription Override public void onCreate Override public void onDestroy MyUtils cancelSubscription mSubscription Override public void attachView NonNull BaseView view TODO mView T view Override public void beforeRequest mView showProgress Override public void success E data mView hideProgress Override public void onError String errorMsg mView hideProgress mView showMsg errorMsgpackage com kaku colorfulnews mvp ui adapter base import android support annotation AnimRes import android support v7 widget RecyclerView import android support v7 widget StaggeredGridLayoutManager import android view LayoutInflater import android view View import android view ViewGroup import android view animation Animation import android view animation AnimationUtils import com kaku colorfulnews listener OnItemClickListener import java util List public class BaseRecyclerViewAdapter T extends RecyclerView Adapter RecyclerView ViewHolder public static final int TYPE ITEM 0 public static final int TYPE FOOTER 1 protected int mLastPosition 1 protected boolean mIsShowFooter protected List T mList protected OnItemClickListener mOnItemClickListener public BaseRecyclerViewAdapter List T list mList list public void setOnItemClickListener OnItemClickListener onItemClickListener mOnItemClickListener onItemClickListener Override public RecyclerView ViewHolder onCreateViewHolder ViewGroup parent int viewType return null Override public void onBindViewHolder RecyclerView ViewHolder holder int position ViewGroup LayoutParams layoutParams holder itemView getLayoutParams if getItemViewType position TYPE FOOTER if layoutParams null if layoutParams instanceof StaggeredGridLayoutManager LayoutParams StaggeredGridLayoutManager LayoutParams params StaggeredGridLayoutManager LayoutParams holder itemView getLayoutParams params setFullSpan true protected View getView ViewGroup parent int layoutId return LayoutInflater from parent getContext inflate layoutId parent false Override public int getItemCount if mList null return 0 int itemSize mList size if mIsShowFooter itemSize 1 return itemSize protected void setItemAppearAnimation RecyclerView ViewHolder holder int position AnimRes int type if position mLastPosition Animation animation AnimationUtils loadAnimation holder itemView getContext type holder itemView startAnimation animation mLastPosition position protected boolean isFooterPosition int position return getItemCount 1 position public void add int position T item mList add position item notifyItemInserted position public void addMore List T data int startPosition mList size mList addAll data notifyItemRangeInserted startPosition mList size public void delete int position mList remove position notifyItemRemoved position public List T getList return mList public void setList List T items mList items public void showFooter mIsShowFooter true notifyItemInserted getItemCount public void hideFooter mIsShowFooter false notifyItemRemoved getItemCount protected class FooterViewHolder extends RecyclerView ViewHolder public FooterViewHolder View itemView super itemViewpackage com twitter sdk android tweetui import com twitter sdk android core Callback import com twitter sdk android core Result import com twitter sdk android core TwitterException import com twitter sdk android core models Tweet import java util List abstract class BaseTimeline protected final TweetUi tweetUi BaseTimeline TweetUi tweetUi if tweetUi null throw new IllegalArgumentException TweetUi instance must not be null this tweetUi tweetUi scribeImpression abstract String getTimelineType private void scribeImpression tweetUi scribe ScribeConstants getSyndicatedSdkTimelineNamespace getTimelineType ScribeConstants getTfwClientTimelineNamespace getTimelineType static Long decrementMaxId Long maxId return maxId null null maxId 1 static class TweetsCallback extends Callback List Tweet final Callback TimelineResult Tweet cb TweetsCallback Callback TimelineResult Tweet cb this cb cb Override public void success Result List Tweet result final List Tweet tweets result data final TimelineResult Tweet timelineResult new TimelineResult new TimelineCursor tweets tweets if cb null cb success new Result timelineResult result response Override public void failure TwitterException exception if cb null cb failure exceptionpackage com twitter sdk android tweetui import com twitter sdk android core Callback import com twitter sdk android core models Tweet class BaseTweetAction protected Callback Tweet actionCallback BaseTweetAction Callback Tweet actionCallback this actionCallback actionCallback Callback Tweet getActionCallback return actionCallbackpackage com twitter sdk android tweetui import android annotation TargetApi import android content Context import android content Intent import android content res TypedArray import android graphics Color import android graphics drawable ColorDrawable import android net Uri import android os Build import android text TextUtils import android util AttributeSet import android view LayoutInflater import android view View import android widget FrameLayout import android widget ImageView import android widget LinearLayout import android widget RelativeLayout import android widget TextView import com squareup picasso Picasso import io fabric sdk android Fabric import com twitter sdk android core Callback import com twitter sdk android core IntentUtils import com twitter sdk android core Result import com twitter sdk android core TwitterException import com twitter sdk android core internal VineCardUtils import com twitter sdk android core internal scribe ScribeItem import com twitter sdk android core models Card import com twitter sdk android core models ImageValue import com twitter sdk android core models MediaEntity import com twitter sdk android core models Tweet import com twitter sdk android core models TweetBuilder import com twitter sdk android core internal UserUtils import com twitter sdk android core models VideoInfo import com twitter sdk android tweetui internal MediaBadgeView import com twitter sdk android tweetui internal SpanClickHandler import com twitter sdk android tweetui internal TweetMediaUtils import com twitter sdk android tweetui internal TweetMediaView import java text DateFormat import java util Date import java util Locale SuppressWarnings TooManyMethods TooManyFields public abstract class BaseTweetView extends LinearLayout private static final String TAG TweetUi LOGTAG private static final int DEFAULT STYLE R style tw TweetLightStyle private static final String EMPTY STRING static final double DEFAULT ASPECT RATIO 16 0 9 0 static final double SECONDARY TEXT COLOR LIGHT OPACITY 0 4 static final double SECONDARY TEXT COLOR DARK OPACITY 0 35 static final double MEDIA BG LIGHT OPACITY 0 08 static final double MEDIA BG DARK OPACITY 0 12 static final long INVALID ID 1L Dependency Provider final DependencyProvider dependencyProvider attributes private LinkClickListener linkClickListener TweetLinkClickListener tweetLinkClickListener TweetMediaClickListener tweetMediaClickListener private Uri permalinkUri Tweet tweet for testing int styleResId layout views RelativeLayout containerView ImageView avatarView TextView fullNameView TextView screenNameView ImageView verifiedCheckView FrameLayout mediaContainerView TweetMediaView mediaView TextView contentView TextView timestampView ImageView twitterLogoView TextView retweetedByView TweetActionBarView tweetActionBarView MediaBadgeView mediaBadgeView View bottomSeparator color values int containerBgColor int primaryTextColor int secondaryTextColor int actionColor int actionHighlightColor int mediaBgColor resource id s int photoErrorResId int birdLogoResId int retweetIconResId boolean tweetActionsEnabled styled drawables for images ColorDrawable mediaBg BaseTweetView Context context Tweet tweet this context tweet DEFAULT STYLE BaseTweetView Context context Tweet tweet int styleResId this context tweet styleResId new DependencyProvider BaseTweetView Context context Tweet tweet int styleResId DependencyProvider dependencyProvider super context null this dependencyProvider dependencyProvider initAttributes styleResId inflateView context findSubviews applyStyles if isTweetUiEnabled return initTweetActions setTweet tweet public BaseTweetView Context context AttributeSet attrs this context attrs new DependencyProvider BaseTweetView Context context AttributeSet attrs DependencyProvider dependencyProvider super context attrs this dependencyProvider dependencyProvider initXmlAttributes context attrs inflateView context public BaseTweetView Context context AttributeSet attrs int defStyle this context attrs defStyle new DependencyProvider BaseTweetView Context context AttributeSet attrs int defStyle DependencyProvider dependencyProvider super context attrs defStyle this dependencyProvider dependencyProvider initXmlAttributes context attrs inflateView context private void initAttributes int styleResId this styleResId styleResId final TypedArray a getContext getTheme obtainStyledAttributes styleResId R styleable tw TweetView try setStyleAttributes a finally a recycle private void initXmlAttributes Context context AttributeSet attrs if attrs null return parse the xml attributes by resolving resource references final TypedArray a context getTheme obtainStyledAttributes attrs R styleable tw TweetView 0 0 try setXmlDataAttributes a setStyleAttributes a finally a recycle private void setXmlDataAttributes TypedArray a final long tweetId Utils numberOrDefault a getString R styleable tw TweetView tw tweet id INVALID ID if tweetId 0 throw new IllegalArgumentException Invalid tw tweet id XML special case The screen name is not known yet A permalink can be constructed and followed Permalink should be updated once the loadTweet call receives the Tweet setPermalinkUri null tweetId this tweet new TweetBuilder setId tweetId build private void setStyleAttributes TypedArray a Styled via attributes containerBgColor a getColor R styleable tw TweetView tw container bg color getResources getColor R color tw tweet light container bg color primaryTextColor a getColor R styleable tw TweetView tw primary text color getResources getColor R color tw tweet light primary text color actionColor a getColor R styleable tw TweetView tw action color getResources getColor R color tw tweet action color actionHighlightColor a getColor R styleable tw TweetView tw action highlight color getResources getColor R color tw tweet action light highlight color tweetActionsEnabled a getBoolean R styleable tw TweetView tw tweet actions enabled false Calculated colors final boolean isLightBg ColorUtils isLightColor containerBgColor if isLightBg photoErrorResId R drawable tw ic tweet photo error light birdLogoResId R drawable tw ic logo blue retweetIconResId R drawable tw ic retweet light else photoErrorResId R drawable tw ic tweet photo error dark birdLogoResId R drawable tw ic logo white retweetIconResId R drawable tw ic retweet dark offset from white when background is light secondaryTextColor ColorUtils calculateOpacityTransform isLightBg SECONDARY TEXT COLOR LIGHT OPACITY SECONDARY TEXT COLOR DARK OPACITY isLightBg Color WHITE Color BLACK primaryTextColor offset from black when background is light mediaBgColor ColorUtils calculateOpacityTransform isLightBg MEDIA BG LIGHT OPACITY MEDIA BG DARK OPACITY isLightBg Color BLACK Color WHITE containerBgColor mediaBg new ColorDrawable mediaBgColor private void inflateView Context context final LayoutInflater localInflater LayoutInflater from context final View v localInflater inflate getLayout null false work around a bug in Android that makes it so that our inflated view doesn t pick up layout params correctly from its style final LayoutParams layoutParams new LayoutParams LayoutParams MATCH PARENT LayoutParams WRAP CONTENT v setLayoutParams layoutParams this addView v Override protected void onFinishInflate super onFinishInflate if isTweetUiEnabled return findSubviews applyStyles initTweetActions loadTweet private void initTweetActions setTweetActionsEnabled tweetActionsEnabled Tweet actions buttons setTweet and clear cache after successful actions tweetActionBarView setOnActionCallback new ResetTweetCallback this dependencyProvider getTweetUi getTweetRepository null boolean isTweetUiEnabled in edit mode halt view creation if isInEditMode return false try dependencyProvider getTweetUi catch IllegalStateException e Fabric getLogger e TAG e getMessage TweetUi kit instance not available halt view creation and disable setEnabled false return false return true void findSubviews Tweet attribution avatar name screen name etc containerView RelativeLayout findViewById R id tw tweet view avatarView ImageView findViewById R id tw tweet author avatar fullNameView TextView findViewById R id tw tweet author full name screenNameView TextView findViewById R id tw tweet author screen name verifiedCheckView ImageView findViewById R id tw tweet author verified mediaContainerView FrameLayout findViewById R id tw tweet media container mediaView TweetMediaView findViewById R id tw tweet media contentView TextView findViewById R id tw tweet text timestampView TextView findViewById R id tw tweet timestamp twitterLogoView ImageView findViewById R id tw twitter logo retweetedByView TextView findViewById R id tw tweet retweeted by tweetActionBarView TweetActionBarView findViewById R id tw tweet action bar mediaBadgeView MediaBadgeView findViewById R id tw tweet media badge bottomSeparator findViewById R id bottom separator abstract int getLayout abstract String getViewTypeName public long getTweetId if tweet null return INVALID ID return tweet id public void setTweet Tweet tweet this tweet tweet render public Tweet getTweet return tweet public void setOnActionCallback Callback Tweet actionCallback tweetActionBarView setOnActionCallback new ResetTweetCallback this dependencyProvider getTweetUi getTweetRepository actionCallback tweetActionBarView setTweet tweet public void setTweetMediaClickListener TweetMediaClickListener tweetMediaClickListener this tweetMediaClickListener tweetMediaClickListener public void setTweetLinkClickListener TweetLinkClickListener tweetLinkClickListener this tweetLinkClickListener tweetLinkClickListener void render final Tweet displayTweet TweetUtils getDisplayTweet tweet setProfilePhotoView displayTweet setName displayTweet setScreenName displayTweet setTimestamp displayTweet setTweetMedia displayTweet setText displayTweet setContentDescription displayTweet setTweetActions tweet showRetweetedBy tweet set permalink if tweet id and screen name are available if TweetUtils isTweetResolvable tweet setPermalinkUri tweet user screenName getTweetId else permalinkUri null set or update the permalink launcher with the current permalinkUri setPermalinkLauncher scribeImpression private void loadTweet final long tweetId getTweetId create a callback to setTweet on the view or log a failure to load the Tweet final Callback Tweet repoCb new Callback Tweet Override public void success Result Tweet result setTweet result data Override public void failure TwitterException exception Fabric getLogger d TAG String format Locale ENGLISH TweetUtils LOAD TWEET DEBUG tweetId dependencyProvider getTweetUi getTweetRepository loadTweet getTweetId repoCb Uri getPermalinkUri return permalinkUri void setPermalinkUri String screenName Long tweetId if tweetId 0 return permalinkUri TweetUtils getPermalink screenName tweetId private void setPermalinkLauncher final OnClickListener listener new PermalinkClickListener this setOnClickListener listener void showRetweetedBy Tweet tweet if tweet null tweet retweetedStatus null retweetedByView setVisibility GONE else retweetedByView setText getResources getString R string tw retweeted by format tweet user name retweetedByView setVisibility VISIBLE void launchPermalink final Intent intent new Intent Intent ACTION VIEW getPermalinkUri if IntentUtils safeStartActivity getContext intent Fabric getLogger e TweetUi LOGTAG Activity cannot be found to open permalink URI void scribeImpression if tweet null dependencyProvider getTweetScribeClient impression tweet getViewTypeName tweetActionsEnabled void scribePermalinkClick if tweet null dependencyProvider getTweetScribeClient click tweet getViewTypeName void scribeCardImpression Long tweetId Card card final ScribeItem scribeItem ScribeItem fromTweetCard tweetId card dependencyProvider getVideoScribeClient impression scribeItem void scribeMediaEntityImpression long tweetId MediaEntity mediaEntity final ScribeItem scribeItem ScribeItem fromMediaEntity tweetId mediaEntity dependencyProvider getVideoScribeClient impression scribeItem protected void applyStyles containerView setBackgroundColor containerBgColor avatarView setImageDrawable mediaBg mediaView setImageDrawable mediaBg fullNameView setTextColor primaryTextColor screenNameView setTextColor secondaryTextColor contentView setTextColor primaryTextColor timestampView setTextColor secondaryTextColor twitterLogoView setImageResource birdLogoResId retweetedByView setTextColor secondaryTextColor private void setName Tweet displayTweet if displayTweet null displayTweet user null fullNameView setText Utils stringOrEmpty displayTweet user name else fullNameView setText EMPTY STRING private void setScreenName Tweet displayTweet if displayTweet null displayTweet user null screenNameView setText UserUtils formatScreenName Utils stringOrEmpty displayTweet user screenName else screenNameView setText EMPTY STRING TargetApi Build VERSION CODES JELLY BEAN private void setText Tweet displayTweet if Build VERSION SDK INT Build VERSION CODES JELLY BEAN contentView setImportantForAccessibility IMPORTANT FOR ACCESSIBILITY NO final CharSequence tweetText Utils charSeqOrEmpty getLinkifiedText displayTweet SpanClickHandler enableClicksOnSpans contentView if TextUtils isEmpty tweetText contentView setText tweetText contentView setVisibility VISIBLE else contentView setText EMPTY STRING contentView setVisibility GONE private void setTimestamp Tweet displayTweet final String formattedTimestamp if displayTweet null displayTweet createdAt null TweetDateUtils isValidTimestamp displayTweet createdAt final Long createdAtTimestamp TweetDateUtils apiTimeToLong displayTweet createdAt final String timestamp TweetDateUtils getRelativeTimeString getResources System currentTimeMillis createdAtTimestamp formattedTimestamp TweetDateUtils dotPrefix timestamp else formattedTimestamp EMPTY STRING timestampView setText formattedTimestamp void setProfilePhotoView Tweet displayTweet final Picasso imageLoader dependencyProvider getImageLoader if imageLoader null return final String url if displayTweet null displayTweet user null url null else url UserUtils getProfileImageUrlHttps displayTweet user UserUtils AvatarSize REASONABLY SMALL imageLoader load url placeholder mediaBg into avatarView final void setTweetMedia Tweet displayTweet clearMediaView if displayTweet null mediaContainerView setVisibility ImageView GONE return if displayTweet card null VineCardUtils isVine displayTweet card final Card vineCard displayTweet card mediaContainerView setVisibility ImageView VISIBLE mediaView setOverlayDrawable getContext getResources getDrawable R drawable tw player overlay mediaBadgeView setCard vineCard setVineCardLauncher displayTweet id vineCard final ImageValue imageValue VineCardUtils getImageValue vineCard if imageValue null setMediaImage imageValue url getAspectRatio imageValue scribeCardImpression displayTweet id vineCard else if TweetMediaUtils hasSupportedVideo displayTweet final MediaEntity mediaEntity TweetMediaUtils getVideoEntity displayTweet set the image view to visible before setting via picasso placeholders into so measurements are done correctly fixes a bug where the placeholder was a small square in the corner of the view mediaContainerView setVisibility ImageView VISIBLE mediaView setOverlayDrawable getContext getResources getDrawable R drawable tw player overlay mediaBadgeView setMediaEntity mediaEntity setAltText mediaEntity altText setMediaLauncher displayTweet mediaEntity setMediaImage mediaEntity mediaUrlHttps getAspectRatio mediaEntity scribeMediaEntityImpression displayTweet id mediaEntity else if TweetMediaUtils hasPhoto displayTweet final MediaEntity mediaEntity TweetMediaUtils getPhotoEntity displayTweet set the image view to visible before setting via picasso placeholders into so measurements are done correctly fixes a bug where the placeholder was a small square in the corner of the view mediaContainerView setVisibility ImageView VISIBLE mediaBadgeView setMediaEntity mediaEntity setAltText mediaEntity altText setPhotoLauncher displayTweet mediaEntity setMediaImage mediaEntity mediaUrlHttps getAspectRatio mediaEntity else mediaContainerView setVisibility ImageView GONE void setAltText String description if TextUtils isEmpty description mediaView setContentDescription description private void setMediaLauncher final Tweet displayTweet final MediaEntity entity mediaView setOnClickListener new OnClickListener Override public void onClick View view if tweetMediaClickListener null tweetMediaClickListener onMediaEntityClick tweet entity else final VideoInfo Variant variant TweetMediaUtils getSupportedVariant entity if variant null final Intent intent new Intent getContext PlayerActivity class final boolean looping TweetMediaUtils isLooping entity final String url TweetMediaUtils getSupportedVariant entity url final PlayerActivity PlayerItem item new PlayerActivity PlayerItem url looping intent putExtra PlayerActivity PLAYER ITEM item IntentUtils safeStartActivity getContext intent private void setPhotoLauncher final Tweet displayTweet final MediaEntity entity mediaView setOnClickListener new OnClickListener Override public void onClick View view if tweetMediaClickListener null tweetMediaClickListener onMediaEntityClick tweet entity else final Intent intent new Intent getContext GalleryActivity class intent putExtra GalleryActivity MEDIA ENTITY entity intent putExtra GalleryActivity TWEET ID displayTweet id IntentUtils safeStartActivity getContext intent private void setVineCardLauncher final Long tweetId final Card vineCard mediaView setOnClickListener new OnClickListener Override public void onClick View view final Intent intent new Intent getContext PlayerActivity class final String playerStreamUrl VineCardUtils getStreamUrl vineCard final String callToActionUrl VineCardUtils getCallToActionUrl vineCard final String callToActionText getContext getResources getString R string tw cta text final PlayerActivity PlayerItem playerItem new PlayerActivity PlayerItem playerStreamUrl true callToActionText callToActionUrl intent putExtra PlayerActivity PLAYER ITEM playerItem final ScribeItem scribeItem ScribeItem fromTweetCard tweetId vineCard intent putExtra PlayerActivity SCRIBE ITEM scribeItem IntentUtils safeStartActivity getContext intent void setMediaImage String imagePath double aspectRatio final Picasso imageLoader dependencyProvider getImageLoader if imageLoader null return Picasso fit is a deferred call to resize w h which waits until the target has a non zero width or height and resizes the bitmap to the target s width and height For recycled targets which already have a width and stale height reset the size target to zero so Picasso fit works correctly mediaView resetSize mediaView setAspectRatio aspectRatio imageLoader load imagePath placeholder mediaBg fit centerCrop into mediaView new PicassoCallback protected double getAspectRatio MediaEntity photoEntity if photoEntity null photoEntity sizes null photoEntity sizes medium null photoEntity sizes medium w 0 photoEntity sizes medium h 0 return DEFAULT ASPECT RATIO return double photoEntity sizes medium w photoEntity sizes medium h protected double getAspectRatio ImageValue imageValue if imageValue null imageValue width 0 imageValue height 0 return DEFAULT ASPECT RATIO return double imageValue width imageValue height TargetApi Build VERSION CODES JELLY BEAN protected void clearMediaView Clear out the background behind any potential error images that we had if Build VERSION SDK INT Build VERSION CODES JELLY BEAN mediaView setBackground null else mediaView setBackgroundDrawable null mediaView setOverlayDrawable null mediaView setOnClickListener null mediaView setClickable false mediaView setContentDescription getResources getString R string tw tweet media class PicassoCallback implements com squareup picasso Callback Override public void onSuccess Override public void onError setErrorImage protected void setErrorImage async load the error image and set the proper background color behind it once it s loaded this does incur the necessity of clearing the background on each load of an image however final Picasso imageLoader dependencyProvider getImageLoader if imageLoader null return imageLoader load photoErrorResId into mediaView new com squareup picasso Callback Override public void onSuccess mediaView setBackgroundColor mediaBgColor Override public void onError protected CharSequence getLinkifiedText Tweet displayTweet final FormattedTweetText formattedText dependencyProvider getTweetUi getTweetRepository formatTweetText displayTweet if formattedText null return null final boolean stripPhotoEntity TweetMediaUtils hasPhoto displayTweet return TweetTextLinkifier linkifyUrls formattedText getLinkClickListener stripPhotoEntity actionColor actionHighlightColor void setContentDescription Tweet displayTweet if TweetUtils isTweetResolvable displayTweet setContentDescription getResources getString R string tw loading tweet return final FormattedTweetText formattedTweetText dependencyProvider getTweetUi getTweetRepository formatTweetText displayTweet String tweetText null if formattedTweetText null tweetText formattedTweetText text final long createdAt TweetDateUtils apiTimeToLong displayTweet createdAt String timestamp null if createdAt TweetDateUtils INVALID DATE timestamp DateFormat getDateInstance format new Date createdAt setContentDescription getResources getString R string tw tweet content description Utils stringOrEmpty displayTweet user name Utils stringOrEmpty tweetText Utils stringOrEmpty timestamp void setTweetActions Tweet tweet tweetActionBarView setTweet tweet public void setTweetActionsEnabled boolean enabled tweetActionsEnabled enabled if tweetActionsEnabled tweetActionBarView setVisibility View VISIBLE bottomSeparator setVisibility View GONE else tweetActionBarView setVisibility View GONE bottomSeparator setVisibility View VISIBLE protected LinkClickListener getLinkClickListener if linkClickListener null linkClickListener new LinkClickListener Override public void onUrlClicked String url if TextUtils isEmpty url return if tweetLinkClickListener null tweetLinkClickListener onLinkClick tweet url else final Intent intent new Intent Intent ACTION VIEW Uri parse url if IntentUtils safeStartActivity getContext intent Fabric getLogger e TweetUi LOGTAG Activity cannot be found to open URL Override public void onPhotoClicked MediaEntity mediaEntity Does nothing return linkClickListener class PermalinkClickListener implements OnClickListener Override public void onClick View v if getPermalinkUri null return scribePermalinkClick launchPermalink static class DependencyProvider TweetScribeClient tweetScribeClient VideoScribeClient videoScribeClient TweetUi getTweetUi return TweetUi getInstance TweetScribeClient getTweetScribeClient if tweetScribeClient null tweetScribeClient new TweetScribeClientImpl getTweetUi return tweetScribeClient VideoScribeClient getVideoScribeClient if videoScribeClient null videoScribeClient new VideoScribeClientImpl getTweetUi return videoScribeClient Picasso getImageLoader return TweetUi getInstance getImageLoaderpackage com kaku colorfulnews mvp view base public interface BaseView void showProgress void hideProgress void showMsg String messagepackage hudson security import hudson model User import jenkins model Jenkins import hudson util Scrambler import jenkins security ApiTokenProperty import org acegisecurity context SecurityContextHolder import javax servlet Filter import javax servlet FilterChain import javax servlet FilterConfig import javax servlet RequestDispatcher import javax servlet ServletContext import javax servlet ServletException import javax servlet ServletRequest import javax servlet ServletResponse import javax servlet http HttpServletRequest import javax servlet http HttpServletResponse import java io IOException import java net URLEncoder public class BasicAuthenticationFilter implements Filter private ServletContext servletContext public void init FilterConfig filterConfig throws ServletException servletContext filterConfig getServletContext SuppressWarnings ACL impersonate public void doFilter ServletRequest request ServletResponse response FilterChain chain throws IOException ServletException HttpServletRequest req HttpServletRequest request HttpServletResponse rsp HttpServletResponse response String authorization req getHeader Authorization String path req getServletPath if authorization null req getUserPrincipal null path startsWith secured Jenkins getInstance isUseSecurity normal requests or security not enabled if req getUserPrincipal null before we route this request integrate the container authentication to Acegi For anonymous users that doesn t have user principal AnonymousProcessingFilter that follows this should create an Authentication object SecurityContextHolder getContext setAuthentication new ContainerAuthentication req try chain doFilter request response finally SecurityContextHolder clearContext return authenticate the user String username null String password null String uidpassword Scrambler descramble authorization substring 6 int idx uidpassword indexOf if idx 0 username uidpassword substring 0 idx password uidpassword substring idx 1 if username null rsp setStatus HttpServletResponse SC UNAUTHORIZED rsp setHeader WWW Authenticate Basic realm Jenkins user return attempt to authenticate as API token create is true as the user may not have been saved and the default api token may be in use validation of the user will be performed against the underlying realm in impersonate User u User getById username true ApiTokenProperty t u getProperty ApiTokenProperty class if t null t matchesPassword password SecurityContextHolder getContext setAuthentication u impersonate try chain doFilter request response finally SecurityContextHolder clearContext return path req getContextPath secured path String q req getQueryString if q null path q prepare a redirect rsp setStatus HttpServletResponse SC MOVED TEMPORARILY rsp setHeader Location path but first let the container authenticate this request RequestDispatcher d servletContext getRequestDispatcher j security check j username URLEncoder encode username UTF 8 j password URLEncoder encode password UTF 8 d include req rsp public void doFilter ServletRequest request ServletResponse response FilterChain chain throws IOException ServletException HttpServletRequest req HttpServletRequest request String authorization req getHeader Authorization String path req getServletPath if authorization null req getUserPrincipal null path startsWith secured chain doFilter request response else if req getQueryString null path req getQueryString HttpServletResponse response sendRedirect req getContextPath secured path public void destroypackage jenkins security import hudson Extension import hudson model User import org acegisecurity Authentication import org acegisecurity userdetails UsernameNotFoundException import org springframework dao DataAccessException import javax servlet ServletException import javax servlet http HttpServletRequest import javax servlet http HttpServletResponse import java util logging Logger import static java util logging Level Extension public class BasicHeaderApiTokenAuthenticator extends BasicHeaderAuthenticator Override public Authentication authenticate HttpServletRequest req HttpServletResponse rsp String username String password throws ServletException attempt to authenticate as API token User u User getById username true ApiTokenProperty t u getProperty ApiTokenProperty class if t null t matchesPassword password try return u impersonate catch UsernameNotFoundException x The token was valid but the impersonation failed This token is clearly not his real password so there s no point in continuing the request processing Report this error and abort LOGGER log WARNING API token matched for user username but the impersonation failed x throw new ServletException x catch DataAccessException x throw new ServletException x return null private static final Logger LOGGER Logger getLogger BasicHeaderApiTokenAuthenticator class getNamepackage jenkins security import hudson ExtensionList import hudson ExtensionPoint import org acegisecurity Authentication import javax servlet ServletException import javax servlet http HttpServletRequest import javax servlet http HttpServletResponse import java io IOException public abstract class BasicHeaderAuthenticator implements ExtensionPoint public abstract Authentication authenticate HttpServletRequest req HttpServletResponse rsp String username String password throws IOException ServletException public static ExtensionList BasicHeaderAuthenticator all return ExtensionList lookup BasicHeaderAuthenticator classpackage jenkins security import hudson security ACL import hudson security SecurityRealm import hudson util Scrambler import org acegisecurity Authentication import org acegisecurity BadCredentialsException import org acegisecurity context SecurityContext import org acegisecurity context SecurityContextHolder import org acegisecurity providers UsernamePasswordAuthenticationToken import org acegisecurity providers anonymous AnonymousAuthenticationToken import org acegisecurity ui AuthenticationEntryPoint import org acegisecurity ui rememberme NullRememberMeServices import org acegisecurity ui rememberme RememberMeServices import javax servlet Filter import javax servlet FilterChain import javax servlet FilterConfig import javax servlet ServletException import javax servlet ServletRequest import javax servlet ServletResponse import javax servlet http HttpServletRequest import javax servlet http HttpServletResponse import java io IOException import java util List import java util logging Logger import static java util logging Level public class BasicHeaderProcessor implements Filter these fields are supposed to be injected by Spring private AuthenticationEntryPoint authenticationEntryPoint private RememberMeServices rememberMeServices new NullRememberMeServices public void init FilterConfig filterConfig throws ServletException public void setAuthenticationEntryPoint AuthenticationEntryPoint authenticationEntryPoint this authenticationEntryPoint authenticationEntryPoint public void setRememberMeServices RememberMeServices rememberMeServices this rememberMeServices rememberMeServices public void doFilter ServletRequest request ServletResponse response FilterChain chain throws IOException ServletException HttpServletRequest req HttpServletRequest request HttpServletResponse rsp HttpServletResponse response String authorization req getHeader Authorization if authorization null authorization startsWith Basic authenticate the user String uidpassword Scrambler descramble authorization substring 6 int idx uidpassword indexOf if idx 0 String username uidpassword substring 0 idx String password uidpassword substring idx 1 if authenticationIsRequired username chain doFilter request response return for BasicHeaderAuthenticator a all LOGGER log FINER Attempting to authenticate with 0 a Authentication auth a authenticate req rsp username password if auth null LOGGER log FINE Request authenticated as 0 by 1 new Object auth a success req rsp chain auth return fail req rsp new BadCredentialsException Invalid password token for user username else fail req rsp new BadCredentialsException Malformed HTTP basic Authorization header else not something we care chain doFilter request response taken from BasicProcessingFilter java protected boolean authenticationIsRequired String username Only reauthenticate if username doesn t match SecurityContextHolder and user isn t authenticated see SEC 53 Authentication existingAuth SecurityContextHolder getContext getAuthentication if existingAuth null existingAuth isAuthenticated return true Limit username comparison to providers which use usernames ie UsernamePasswordAuthenticationToken see SEC 348 if existingAuth instanceof UsernamePasswordAuthenticationToken existingAuth getName equals username return true Handle unusual condition where an AnonymousAuthenticationToken is already present This shouldn t happen very often as BasicProcessingFitler is meant to be earlier in the filter chain than AnonymousProcessingFilter Nevertheless presence of both an AnonymousAuthenticationToken together with a BASIC authentication request header should indicate reauthentication using the BASIC protocol is desirable This behaviour is also consistent with that provided by form and digest both of which force re authentication if the respective header is detected and in doing so replace any existing AnonymousAuthenticationToken See SEC 610 if existingAuth instanceof AnonymousAuthenticationToken return true return false protected void success HttpServletRequest req HttpServletResponse rsp FilterChain chain Authentication auth throws IOException ServletException rememberMeServices loginSuccess req rsp auth SecurityContext old ACL impersonate auth try chain doFilter req rsp finally SecurityContextHolder setContext old protected void fail HttpServletRequest req HttpServletResponse rsp BadCredentialsException failure throws IOException ServletException LOGGER log FINE Authentication of BASIC header failed rememberMeServices loginFail req rsp authenticationEntryPoint commence req rsp failure protected List extends BasicHeaderAuthenticator all return BasicHeaderAuthenticator all public void destroy private static final Logger LOGGER Logger getLogger BasicHeaderProcessor class getNamepackage jenkins security import hudson Extension import jenkins util SystemProperties import jenkins ExtensionFilter import jenkins model Jenkins import org acegisecurity Authentication import org acegisecurity AuthenticationException import org acegisecurity providers UsernamePasswordAuthenticationToken import org acegisecurity ui AuthenticationDetailsSource import org acegisecurity ui AuthenticationDetailsSourceImpl import javax servlet ServletException import javax servlet http HttpServletRequest import javax servlet http HttpServletResponse import java io IOException import java util logging Logger import static java util logging Level Extension public class BasicHeaderRealPasswordAuthenticator extends BasicHeaderAuthenticator private AuthenticationDetailsSource authenticationDetailsSource new AuthenticationDetailsSourceImpl Override public Authentication authenticate HttpServletRequest req HttpServletResponse rsp String username String password throws IOException ServletException if DISABLE return null UsernamePasswordAuthenticationToken authRequest new UsernamePasswordAuthenticationToken username password authRequest setDetails authenticationDetailsSource buildDetails req try Authentication a Jenkins getInstance getSecurityRealm getSecurityComponents manager authenticate authRequest Authentication success LOGGER log FINER Authentication success 0 a return a catch AuthenticationException failed Authentication failed LOGGER log FINER Authentication request for user 0 failed 1 new Object username failed return null private static final Logger LOGGER Logger getLogger BasicHeaderRealPasswordAuthenticator class getName public static boolean DISABLE SystemProperties getBoolean jenkins security ignoreBasicAuthpackage hudson tools import hudson Extension import hudson FilePath import hudson util LineEndingConversion import org jenkinsci Symbol import org kohsuke stapler DataBoundConstructor import java io ObjectStreamException public class BatchCommandInstaller extends AbstractCommandInstaller DataBoundConstructor public BatchCommandInstaller String label String command String toolHome super label LineEndingConversion convertEOL command LineEndingConversion EOLType Windows toolHome Override public String getCommandFileExtension return bat Override public String getCommandCall FilePath script String cmd cmd c call script getRemote return cmd private Object readResolve throws ObjectStreamException return new BatchCommandInstaller getLabel getCommand getToolHome Extension Symbol batchFile public static class DescriptorImpl extends Descriptor BatchCommandInstaller Override public String getDisplayName return Messages BatchCommandInstaller DescriptorImpl displayNamepackage hudson tasks import hudson FilePath import hudson Extension import hudson Util import hudson model AbstractProject import hudson util FormValidation import hudson util LineEndingConversion import org jenkinsci Symbol import org kohsuke accmod Restricted import org kohsuke accmod restrictions DoNotUse import org kohsuke stapler DataBoundConstructor import org kohsuke stapler DataBoundSetter import org kohsuke stapler QueryParameter import java io ObjectStreamException import javax annotation CheckForNull public class BatchFile extends CommandInterpreter DataBoundConstructor public BatchFile String command super LineEndingConversion convertEOL command LineEndingConversion EOLType Windows private Integer unstableReturn public String buildCommandLine FilePath script return new String cmd c call script getRemote protected String getContents return LineEndingConversion convertEOL command r nexit ERRORLEVEL LineEndingConversion EOLType Windows protected String getFileExtension return bat CheckForNull public final Integer getUnstableReturn return new Integer 0 equals unstableReturn null unstableReturn DataBoundSetter public void setUnstableReturn Integer unstableReturn this unstableReturn unstableReturn Override protected boolean isErrorlevelForUnstableBuild int exitCode return this unstableReturn null exitCode 0 this unstableReturn equals exitCode private Object readResolve throws ObjectStreamException return new BatchFile command Extension Symbol batchFile public static final class DescriptorImpl extends BuildStepDescriptor Builder Override public String getHelpFile return help project config batch html public String getDisplayName return Messages BatchFile DisplayName Restricted DoNotUse class public FormValidation doCheckUnstableReturn QueryParameter String value value Util fixEmptyAndTrim value if value null return FormValidation ok long unstableReturn try unstableReturn Long parseLong value catch NumberFormatException e return FormValidation error hudson model Messages Hudson NotANumber if unstableReturn 0 return FormValidation warning hudson tasks Messages BatchFile invalid exit code zero if unstableReturn Integer MIN VALUE unstableReturn Integer MAX VALUE return FormValidation error hudson tasks Messages BatchFile invalid exit code range unstableReturn return FormValidation ok public boolean isApplicable Class extends AbstractProject jobType return truepackage hudson util spring import groovy lang Binding import groovy lang Closure import groovy lang GString import groovy lang GroovyObject import groovy lang GroovyObjectSupport import groovy lang GroovyShell import groovy lang MetaClass import groovy lang MissingMethodException import org apache commons lang ArrayUtils import org codehaus groovy control CompilerConfiguration import org codehaus groovy runtime DefaultGroovyMethods import org codehaus groovy runtime InvokerHelper import org springframework beans factory config BeanDefinition import org springframework beans factory config RuntimeBeanReference import org springframework beans factory support ManagedList import org springframework beans factory support ManagedMap import org springframework context ApplicationContext import org springframework context support StaticApplicationContext import org springframework core io Resource import org springframework core io support PathMatchingResourcePatternResolver import org springframework web context WebApplicationContext import java io IOException import java io InputStream import java io InputStreamReader import java util Arrays import java util HashMap import java util List import java util ListIterator import java util Map import java util Map Entry public class BeanBuilder extends GroovyObjectSupport private static final String ANONYMOUS BEAN bean private RuntimeSpringConfiguration springConfig new DefaultRuntimeSpringConfiguration private BeanConfiguration currentBeanConfig private Map String DeferredProperty deferredProperties new HashMap String DeferredProperty private ApplicationContext parentCtx private Map binding new HashMap private ClassLoader classLoader null public BeanBuilder super public BeanBuilder ClassLoader classLoader super this classLoader classLoader public BeanBuilder ApplicationContext parent super this parentCtx parent this springConfig new DefaultRuntimeSpringConfiguration parent public BeanBuilder ApplicationContext parent ClassLoader classLoader super this parentCtx parent this springConfig new DefaultRuntimeSpringConfiguration parent this classLoader classLoader public void parse InputStream script parse script new Binding public void parse InputStream script Binding binding if script null throw new IllegalArgumentException No script is provided setBinding binding CompilerConfiguration cc new CompilerConfiguration cc setScriptBaseClass ClosureScript class getName GroovyShell shell new GroovyShell classLoader binding cc ClosureScript s ClosureScript shell parse new InputStreamReader script s setDelegate this s run public ApplicationContext getParentCtx return parentCtx public RuntimeSpringConfiguration getSpringConfig return springConfig public BeanDefinition getBeanDefinition String name if getSpringConfig containsBean name return null return getSpringConfig getBeanConfig name getBeanDefinition public Map String BeanDefinition getBeanDefinitions Map String BeanDefinition beanDefinitions new HashMap String BeanDefinition for String beanName getSpringConfig getBeanNames BeanDefinition bd getSpringConfig getBeanConfig beanName getBeanDefinition beanDefinitions put beanName bd return beanDefinitions public void setSpringConfig RuntimeSpringConfiguration springConfig this springConfig springConfig private static class DeferredProperty private BeanConfiguration config private String name private Object value DeferredProperty BeanConfiguration config String name Object value this config config this name name this value value public void setInBeanConfig this config addProperty name value private class ConfigurableRuntimeBeanReference extends RuntimeBeanReference implements GroovyObject private MetaClass metaClass private BeanConfiguration beanConfig public ConfigurableRuntimeBeanReference String beanName BeanConfiguration beanConfig this beanName beanConfig false public ConfigurableRuntimeBeanReference String beanName BeanConfiguration beanConfig boolean toParent super beanName toParent this beanConfig beanConfig if beanConfig null throw new IllegalArgumentException Argument beanConfig cannot be null this metaClass InvokerHelper getMetaClass this public MetaClass getMetaClass return this metaClass public Object getProperty String property if property equals beanName return getBeanName else if property equals source return getSource else if this beanConfig null return new WrappedPropertyValue property beanConfig getPropertyValue property else return this metaClass getProperty this property private class WrappedPropertyValue extends GroovyObjectSupport private Object propertyValue private String propertyName public WrappedPropertyValue String propertyName Object propertyValue this propertyValue propertyValue this propertyName propertyName public void leftShift Object value InvokerHelper invokeMethod propertyValue leftShift value if value instanceof RuntimeBeanReference deferredProperties put beanConfig getName new DeferredProperty beanConfig propertyName propertyValue public Object invokeMethod String name Object args return this metaClass invokeMethod this name args public void setMetaClass MetaClass metaClass this metaClass metaClass public void setProperty String property Object newValue if addToDeferred beanConfig property newValue beanConfig setPropertyValue property newValue public void loadBeans String resourcePattern throws IOException loadBeans new PathMatchingResourcePatternResolver getResources resourcePattern public void loadBeans Resource resource throws IOException loadBeans new Resource resource public void loadBeans Resource resources throws IOException Closure beans new Closure this Override public Object call Object args return beans Closure args 0 Binding b new Binding b setVariable beans beans GroovyShell shell classLoader null new GroovyShell classLoader b new GroovyShell b for Resource resource resources shell evaluate new InputStreamReader resource getInputStream public void registerBeans StaticApplicationContext ctx finalizeDeferredProperties springConfig registerBeansWithContext ctx public RuntimeBeanReference ref String refName return ref refName false public RuntimeBeanReference parentRef String refName return ref refName true public RuntimeBeanReference ref String refName boolean parentRef return new RuntimeBeanReference refName parentRef public Object methodMissing String name Object arg Object args Object arg if args length 0 throw new MissingMethodException name getClass args if args 0 instanceof Closure abstract bean definition return invokeBeanDefiningMethod name args else if args 0 instanceof Class args 0 instanceof RuntimeBeanReference args 0 instanceof Map return invokeBeanDefiningMethod name args else if args length 1 args args length 1 instanceof Closure return invokeBeanDefiningMethod name args WebApplicationContext ctx springConfig getUnrefreshedApplicationContext MetaClass mc DefaultGroovyMethods getMetaClass ctx if mc respondsTo ctx name args isEmpty return mc invokeMethod ctx name args return this public WebApplicationContext createApplicationContext finalizeDeferredProperties return springConfig getApplicationContext private void finalizeDeferredProperties for DeferredProperty dp deferredProperties values if dp value instanceof List dp value manageListIfNecessary List dp value else if dp value instanceof Map dp value manageMapIfNecessary Map dp value dp setInBeanConfig deferredProperties clear private boolean addToDeferred BeanConfiguration beanConfig String property Object newValue if newValue instanceof List deferredProperties put currentBeanConfig getName property new DeferredProperty currentBeanConfig property newValue return true else if newValue instanceof Map deferredProperties put currentBeanConfig getName property new DeferredProperty currentBeanConfig property newValue return true return false private BeanConfiguration invokeBeanDefiningMethod String name Object args BeanConfiguration old currentBeanConfig try if args 0 instanceof Class Class beanClass args 0 instanceof Class Class args 0 args 0 getClass if args length 1 if args args length 1 instanceof Closure if args length 1 1 Object constructorArgs ArrayUtils subarray args 1 args length 1 filterGStringReferences constructorArgs if name equals ANONYMOUS BEAN currentBeanConfig springConfig createSingletonBean beanClass Arrays asList constructorArgs else currentBeanConfig springConfig addSingletonBean name beanClass Arrays asList constructorArgs else if name equals ANONYMOUS BEAN currentBeanConfig springConfig createSingletonBean beanClass else currentBeanConfig springConfig addSingletonBean name beanClass else Object constructorArgs ArrayUtils subarray args 1 args length filterGStringReferences constructorArgs if name equals ANONYMOUS BEAN currentBeanConfig springConfig createSingletonBean beanClass Arrays asList constructorArgs else currentBeanConfig springConfig addSingletonBean name beanClass Arrays asList constructorArgs else if args 0 instanceof RuntimeBeanReference currentBeanConfig springConfig addSingletonBean name currentBeanConfig setFactoryBean RuntimeBeanReference args 0 getBeanName else if args 0 instanceof Map currentBeanConfig springConfig addSingletonBean name Map Entry factoryBeanEntry Map Entry Map args 0 entrySet iterator next currentBeanConfig setFactoryBean factoryBeanEntry getKey toString currentBeanConfig setFactoryMethod factoryBeanEntry getValue toString else if args 0 instanceof Closure currentBeanConfig springConfig addAbstractBean name else Object constructorArgs if args args length 1 instanceof Closure constructorArgs ArrayUtils subarray args 0 args length 1 else constructorArgs ArrayUtils subarray args 0 args length filterGStringReferences constructorArgs currentBeanConfig new DefaultBeanConfiguration name null Arrays asList constructorArgs springConfig addBeanConfiguration name currentBeanConfig if args args length 1 instanceof Closure Closure callable Closure args args length 1 callable setDelegate this callable setResolveStrategy Closure DELEGATE FIRST callable call new Object currentBeanConfig return currentBeanConfig finally currentBeanConfig old private void filterGStringReferences Object constructorArgs for int i 0 i constructorArgs length i Object constructorArg constructorArgs i if constructorArg instanceof GString constructorArgs i constructorArg toString public BeanBuilder beans Closure callable callable setDelegate this callable setResolveStrategy Closure DELEGATE FIRST callable call finalizeDeferredProperties return this Override public void setProperty String name Object value if currentBeanConfig null if value instanceof GString value value toString if addToDeferred currentBeanConfig name value return else if value instanceof Closure BeanConfiguration current currentBeanConfig try Closure callable Closure value Class parameterType callable getParameterTypes 0 if parameterType equals Object class currentBeanConfig springConfig createSingletonBean callable call new Object currentBeanConfig else currentBeanConfig springConfig createSingletonBean parameterType callable call null value currentBeanConfig getBeanDefinition finally currentBeanConfig current currentBeanConfig addProperty name value else binding put name value private Object manageMapIfNecessary Map Object Object value boolean containsRuntimeRefs false for Entry Object Object e value entrySet Object v e getValue if v instanceof RuntimeBeanReference containsRuntimeRefs true if v instanceof BeanConfiguration BeanConfiguration c BeanConfiguration v e setValue c getBeanDefinition containsRuntimeRefs true if containsRuntimeRefs return new ManagedMap map ManagedMap m new ManagedMap m putAll value return m return value private Object manageListIfNecessary List Object value boolean containsRuntimeRefs false for ListIterator Object i value listIterator i hasNext Object e i next if e instanceof RuntimeBeanReference containsRuntimeRefs true if e instanceof BeanConfiguration BeanConfiguration c BeanConfiguration e i set c getBeanDefinition containsRuntimeRefs true if containsRuntimeRefs List tmp new ManagedList tmp addAll value value tmp return value Override public Object getProperty String name if binding containsKey name return binding get name else if springConfig containsBean name BeanConfiguration beanConfig springConfig getBeanConfig name if beanConfig null return new ConfigurableRuntimeBeanReference name springConfig getBeanConfig name false else return new RuntimeBeanReference name false this is to deal with the case where the property setter is the last statement in a closure hence the return value else if currentBeanConfig null if currentBeanConfig hasProperty name return currentBeanConfig getPropertyValue name else DeferredProperty dp deferredProperties get currentBeanConfig getName name if dp null return dp value else return super getProperty name else return super getProperty name public void setBinding Binding b this binding b getVariablespackage hudson util spring import org springframework beans factory support AbstractBeanDefinition public interface BeanConfiguration String AUTOWIRE BY TYPE byType String AUTOWIRE BY NAME byName String getName boolean isSingleton AbstractBeanDefinition getBeanDefinition BeanConfiguration addProperty String propertyName Object propertyValue BeanConfiguration setDestroyMethod String methodName BeanConfiguration setDependsOn String dependsOn BeanConfiguration setFactoryBean String beanName BeanConfiguration setFactoryMethod String methodName BeanConfiguration setAutowire String type void setName String beanName boolean hasProperty String name Object getPropertyValue String name void setPropertyValue String property Object newValue BeanConfiguration setAbstract boolean isAbstract void setParent Object namepackage org acegisecurity providers ldap authenticator import org acegisecurity ldap InitialDirContextFactory import org acegisecurity userdetails ldap LdapUserDetails import java util logging Logger import java util logging Level public class BindAuthenticator2 extends BindAuthenticator private boolean hadSuccessfulAuthentication public BindAuthenticator2 InitialDirContextFactory initialDirContextFactory super initialDirContextFactory Override public LdapUserDetails authenticate String username String password LdapUserDetails user super authenticate username password hadSuccessfulAuthentication true return user Override void handleBindException String userDn String username Throwable cause LOGGER log hadSuccessfulAuthentication Level FINE Level WARNING Failed to bind to LDAP userDn userDn username username cause super handleBindException userDn username cause private static final Logger LOGGER Logger getLogger BindAuthenticator2 class getNamepackage com twitter sdk android core models import java util Collections import java util Map public class BindingValues private final Map String Object bindingValues public BindingValues this Collections EMPTY MAP public BindingValues Map String Object bindingValues this bindingValues Collections unmodifiableMap bindingValues public boolean containsKey String key return bindingValues containsKey key public T T get String key try return T bindingValues get key catch ClassCastException ex return nullpackage com twitter sdk android core models import com google gson JsonDeserializationContext import com google gson JsonDeserializer import com google gson JsonElement import com google gson JsonObject import com google gson JsonParseException import com google gson JsonSerializationContext import com google gson JsonSerializer import java lang reflect Type import java util HashMap import java util Map import java util Set public class BindingValuesAdapter implements JsonSerializer BindingValues JsonDeserializer BindingValues private static final String STRING TYPE STRING private static final String IMAGE TYPE IMAGE private static final String USER TYPE USER private static final String BOOLEAN TYPE BOOLEAN private static final String TYPE MEMBER type private static final String TYPE VALUE MEMBER string value private static final String IMAGE VALUE MEMBER image value private static final String USER VALUE MEMBER user value private static final String BOOLEAN MEMBER boolean value Override public JsonElement serialize BindingValues src Type typeOfSrc JsonSerializationContext context return null Override public BindingValues deserialize JsonElement json Type typeOfT JsonDeserializationContext context throws JsonParseException if json isJsonObject return new BindingValues final JsonObject obj json getAsJsonObject final Set Map Entry String JsonElement members obj entrySet final Map String Object bindingHash new HashMap 32 for Map Entry String JsonElement member members final String key member getKey final JsonObject memberObj member getValue getAsJsonObject final Object value getValue memberObj context bindingHash put key value return new BindingValues bindingHash Object getValue JsonObject obj JsonDeserializationContext context final JsonElement typeObj obj get TYPE MEMBER if typeObj null typeObj isJsonPrimitive return null switch typeObj getAsString case STRING TYPE return context deserialize obj get TYPE VALUE MEMBER String class case IMAGE TYPE return context deserialize obj get IMAGE VALUE MEMBER ImageValue class case USER TYPE return context deserialize obj get USER VALUE MEMBER UserValue class case BOOLEAN TYPE return context deserialize obj get BOOLEAN MEMBER Boolean class default return nullpackage jenkins model import hudson model Executor import hudson model Job import hudson model Run import hudson model queue CauseOfBlockage import javax annotation Nonnull public class BlockedBecauseOfBuildInProgress extends CauseOfBlockage Nonnull private final Run build public BlockedBecauseOfBuildInProgress Nonnull Run build this build build Override public String getShortDescription Executor e build getExecutor String eta if e null eta Messages BlockedBecauseOfBuildInProgress ETA e getEstimatedRemainingTime int lbn build getNumber return Messages BlockedBecauseOfBuildInProgress shortDescription lbn etapackage hudson model import org jenkinsci Symbol import org kohsuke stapler StaplerRequest import org kohsuke stapler DataBoundConstructor import net sf json JSONObject import hudson Extension public class BooleanParameterDefinition extends SimpleParameterDefinition private final boolean defaultValue DataBoundConstructor public BooleanParameterDefinition String name boolean defaultValue String description super name description this defaultValue defaultValue Override public ParameterDefinition copyWithDefaultValue ParameterValue defaultValue if defaultValue instanceof BooleanParameterValue BooleanParameterValue value BooleanParameterValue defaultValue return new BooleanParameterDefinition getName value value getDescription else return this public boolean isDefaultValue return defaultValue Override public ParameterValue createValue StaplerRequest req JSONObject jo BooleanParameterValue value req bindJSON BooleanParameterValue class jo value setDescription getDescription return value public ParameterValue createValue String value return new BooleanParameterValue getName Boolean valueOf value getDescription Override public BooleanParameterValue getDefaultParameterValue return new BooleanParameterValue getName defaultValue getDescription unlike all the other ParameterDescriptors using booleanParam as the primary to avoid picking the Java reserved word boolean as the primary identifier Extension Symbol booleanParam public static class DescriptorImpl extends ParameterDescriptor Override public String getDisplayName return Messages BooleanParameterDefinition DisplayName Override public String getHelpFile return help parameter boolean htmlpackage hudson model import hudson EnvVars import org kohsuke stapler DataBoundConstructor import org kohsuke stapler export Exported import java util Locale import hudson util VariableResolver public class BooleanParameterValue extends ParameterValue Exported visibility 4 public final boolean value DataBoundConstructor public BooleanParameterValue String name boolean value this name value null public BooleanParameterValue String name boolean value String description super name description this value value Override public Boolean getValue return value Override public void buildEnvironment Run build EnvVars env env put name Boolean toString value env put name toUpperCase Locale ENGLISH Boolean toString value backward compatibility pre 1 345 Override public VariableResolver String createVariableResolver AbstractBuild build return new VariableResolver String public String resolve String name return BooleanParameterValue this name equals name Boolean toString value null Override public boolean equals Object o if this o return true if o null getClass o getClass return false if super equals o return false BooleanParameterValue that BooleanParameterValue o if value that value return false return true Override public int hashCode int result super hashCode result 31 result value 1 0 return result Override public String toString return BooleanParameterValue getName value Override public String getShortDescription return name valuepackage hudson util import hudson WebAppMain import jenkins util groovy GroovyHookScript import org kohsuke stapler WebApp import javax annotation CheckForNull import javax servlet ServletContext import java io BufferedReader import java io File import java io FileReader import java io IOException import java util ArrayList import java util Date import java util List import java util logging Level import java util logging Logger public abstract class BootFailure extends ErrorObject protected BootFailure protected BootFailure Throwable cause super cause public void publish ServletContext context CheckForNull File home LOGGER log Level SEVERE Failed to initialize Jenkins this WebApp get context setApp this if home null return new GroovyHookScript boot failure context home BootFailure class getClassLoader bind exception this bind home home bind servletContext context bind attempts loadAttempts home run protected List Date loadAttempts File home List Date dates new ArrayList Date if home null File f getBootFailureFile home try if f exists try BufferedReader failureFileReader new BufferedReader new FileReader f String line while line failureFileReader readLine null try dates add new Date line catch Exception e ignore any parse error catch IOException e LOGGER log Level WARNING Failed to parse f e return dates private static final Logger LOGGER Logger getLogger BootFailure class getName public static File getBootFailureFile File home return new File home failed boot attempts txtpackage jenkins model lazy enum Boundary LOWER 1 1 HIGHER 1 0 FLOOR 0 1 CEIL 0 0 private final int offsetOfExactMatch offsetOfInsertionPoint private Boundary int offsetOfExactMatch int offsetOfInsertionPoint this offsetOfExactMatch offsetOfExactMatch this offsetOfInsertionPoint offsetOfInsertionPoint public int apply int binarySearchOutput int r binarySearchOutput if r 0 return r offsetOfExactMatch if we had some x i p int ip r 1 return ip offsetOfInsertionPointpackage hudson model import hudson Launcher import hudson tasks BuildStep import hudson tasks BuildWrapper import hudson tasks Builder import hudson tasks Recorder import hudson tasks Notifier import org kohsuke accmod Restricted import org kohsuke accmod restrictions NoExternalUse import java io File import java io IOException import java util ArrayList import java util Calendar import java util Collection import java util List import java util logging Logger import java util logging Level import static hudson model Result FAILURE import javax annotation Nonnull public abstract class Build P extends Project P B B extends Build P B extends AbstractBuild P B protected Build P project throws IOException super project protected Build P job Calendar timestamp super job timestamp protected Build P project File buildDir throws IOException super project buildDir actions Override public void run execute createRunner Restricted NoExternalUse class Deprecated protected Runner createRunner return new BuildExecution Deprecated protected class RunnerImpl extends BuildExecution protected class BuildExecution extends AbstractRunner protected Result doRun Nonnull BuildListener listener throws Exception if preBuild listener project getBuilders return FAILURE if preBuild listener project getPublishersList return FAILURE Result r null try List BuildWrapper wrappers new ArrayList BuildWrapper project getBuildWrappers values ParametersAction parameters getAction ParametersAction class if parameters null parameters createBuildWrappers Build this wrappers for BuildWrapper w wrappers Environment e w setUp AbstractBuild Build this launcher listener if e null return r FAILURE buildEnvironments add e if build listener project getBuilders r FAILURE catch InterruptedException e r Executor currentExecutor abortResult not calling Executor recordCauseOfInterruption here We do that where this exception is consumed throw e finally if r null setResult r tear down in reverse order boolean failed false for int i buildEnvironments size 1 i 0 i if buildEnvironments get i tearDown Build this listener failed true WARNING The return in the finally clause will trump any return before if failed return FAILURE return r public void post2 Nonnull BuildListener listener throws IOException InterruptedException if performAllBuildSteps listener project getPublishersList true setResult FAILURE if performAllBuildSteps listener project getProperties true setResult FAILURE Override public void cleanUp Nonnull BuildListener listener throws Exception at this point it s too late to mark the build as a failure so ignore return value try performAllBuildSteps listener project getPublishersList false performAllBuildSteps listener project getProperties false catch Exception x x printStackTrace listener error Messages Build post build steps failed super cleanUp listener private boolean build Nonnull BuildListener listener Nonnull Collection Builder steps throws IOException InterruptedException for BuildStep bs steps if perform bs listener LOGGER log Level FINE 0 1 failed new Object Build this bs return false Executor executor getExecutor if executor null executor isInterrupted someone asked build interruption let stop the build before trying to run another build step throw new InterruptedException return true private static final Logger LOGGER Logger getLogger Build class getNamepackage hudson model import hudson model Queue Task public interface BuildableItem extends Item Task Deprecated boolean scheduleBuild boolean scheduleBuild Cause c Deprecated boolean scheduleBuild int quietPeriod boolean scheduleBuild int quietPeriod Cause cpackage hudson model import hudson tasks BuildWrapper import hudson util DescribableList public interface BuildableItemWithBuildWrappers extends BuildableItem AbstractProject asProject DescribableList BuildWrapper Descriptor BuildWrapper getBuildWrappersListpackage hudson model import com thoughtworks xstream converters basic AbstractSingleValueConverter import hudson Util import hudson security ACL import jenkins model Jenkins import org kohsuke stapler StaplerRequest import org kohsuke stapler StaplerResponse import java io IOException import javax servlet http HttpServletResponse import jenkins security ApiTokenProperty import org acegisecurity AccessDeniedException import org kohsuke stapler HttpResponses Deprecated public final class BuildAuthorizationToken private final String token public BuildAuthorizationToken String token this token token public static BuildAuthorizationToken create StaplerRequest req if req getParameter pseudoRemoteTrigger null String token Util fixEmpty req getParameter authToken if token null return new BuildAuthorizationToken token return null Deprecated public static void checkPermission AbstractProject project BuildAuthorizationToken token StaplerRequest req StaplerResponse rsp throws IOException Job j project checkPermission j token req rsp public static void checkPermission Job project BuildAuthorizationToken token StaplerRequest req StaplerResponse rsp throws IOException if Jenkins getInstance isUseSecurity return everyone is authorized if token null token token null check the provided token String providedToken req getParameter token if providedToken null providedToken equals token token return if providedToken null throw new AccessDeniedException Messages BuildAuthorizationToken InvalidTokenProvided project checkPermission Item BUILD if req getMethod equals POST return if req getAttribute ApiTokenProperty class getName instanceof User return rsp setStatus HttpServletResponse SC METHOD NOT ALLOWED rsp addHeader Allow POST throw HttpResponses forwardToView project requirePOST jelly public String getToken return token public static final class ConverterImpl extends AbstractSingleValueConverter public boolean canConvert Class type return type BuildAuthorizationToken class public Object fromString String str return new BuildAuthorizationToken str Override public String toString Object obj return BuildAuthorizationToken obj tokenpackage hudson model public interface BuildBadgeAction extends Actionpackage hudson views import hudson Extension import org jenkinsci Symbol import org kohsuke stapler DataBoundConstructor public class BuildButtonColumn extends ListViewColumn DataBoundConstructor public BuildButtonColumn Extension ordinal DEFAULT COLUMNS ORDINAL ACTIONS START 1 Symbol buildButton public static class DescriptorImpl extends ListViewColumnDescriptor Override public String getDisplayName return Messages BuildButtonColumn DisplayNamepackage hudson cli import hudson Util import hudson console ModelHyperlinkNote import hudson model AbstractProject import hudson model Cause UserIdCause import hudson model CauseAction import hudson model Job import hudson model Run import hudson model ParametersAction import hudson model ParameterValue import hudson model ParametersDefinitionProperty import hudson model ParameterDefinition import hudson Extension import hudson AbortException import hudson model Queue import hudson model Item import hudson model TaskListener import hudson model User import hudson model queue QueueTaskFuture import hudson util EditDistance import hudson util StreamTaskListener import jenkins scm SCMDecisionHandler import org kohsuke args4j Argument import org kohsuke args4j CmdLineException import org kohsuke args4j Option import java util Map import java util HashMap import java util List import java util ArrayList import java util Map Entry import java io FileNotFoundException import java io PrintStream import jenkins model Jenkins import jenkins model ParameterizedJobMixIn import jenkins triggers SCMTriggerItem Extension public class BuildCommand extends CLICommand Override public String getShortDescription return Messages BuildCommand ShortDescription Argument metaVar JOB usage Name of the job to build required true public Job job Option name f usage Follow the build progress Like s only interrupts are not passed through to the build public boolean follow false Option name s usage Wait until the completion abortion of the command Interrupts are passed through to the build public boolean sync false Option name w usage Wait until the start of the command public boolean wait false Option name c usage Check for SCM changes before starting the build and if there s no change exit without doing a build public boolean checkSCM false Option name p usage Specify the build parameters in the key value format public Map String String parameters new HashMap String String Option name v usage Prints out the console output of the build Use with s public boolean consoleOutput false Option name r Deprecated public int retryCnt 10 protected static final String BUILD SCHEDULING REFUSED Build scheduling Refused by an extension hence not in Queue protected int run throws Exception job checkPermission Item BUILD ParametersAction a null if parameters isEmpty ParametersDefinitionProperty pdp job getProperty ParametersDefinitionProperty class if pdp null throw new IllegalStateException job getFullDisplayName is not parameterized but the p option was specified TODO switch to type annotations after the migration to Java 1 8 List ParameterValue values new ArrayList ParameterValue for Entry String String e parameters entrySet String name e getKey ParameterDefinition pd pdp getParameterDefinition name if pd null String nearest EditDistance findNearest name pdp getParameterDefinitionNames throw new CmdLineException null nearest null String format s is not a valid parameter name String format s is not a valid parameter Did you mean s name nearest ParameterValue val pd createValue this Util fixNull e getValue if val null throw new CmdLineException null String format Cannot resolve the value for the parameter s name values add val handle missing parameters by adding as default values ISSUE JENKINS 7162 for ParameterDefinition pd pdp getParameterDefinitions if parameters containsKey pd getName continue not passed in use default ParameterValue defaultValue pd getDefaultParameterValue if defaultValue null throw new CmdLineException null String format No default value for the parameter s pd getName values add defaultValue a new ParametersAction values if checkSCM SCMTriggerItem item SCMTriggerItem SCMTriggerItems asSCMTriggerItem job if item null throw new AbortException job getFullDisplayName has no SCM trigger but checkSCM was specified pre emtively check for a polling veto if SCMDecisionHandler firstShouldPollVeto job null return 0 if item poll new StreamTaskListener stdout getClientCharset hasChanges return 0 if job isBuildable String msg Messages BuildCommand CLICause CannotBuildUnknownReasons job getFullDisplayName if job instanceof AbstractProject AbstractProject job isDisabled msg Messages BuildCommand CLICause CannotBuildDisabled job getFullDisplayName else if job isHoldOffBuildUntilSave msg Messages BuildCommand CLICause CannotBuildConfigNotSaved job getFullDisplayName throw new IllegalStateException msg Queue Item item ParameterizedJobMixIn scheduleBuild2 job 0 new CauseAction new CLICause Jenkins getAuthentication getName a QueueTaskFuture extends Run f item null QueueTaskFuture item getFuture null if wait sync follow if f null throw new IllegalStateException BUILD SCHEDULING REFUSED Run b f waitForStart wait for the start stdout println Started b getFullDisplayName stdout flush if sync follow try if consoleOutput read output in a retry loop by default try only once writeWholeLogTo may fail with FileNotFound exception on a slow busy machine if it takes longish to create the log file int retryInterval 100 for int i 0 i retryCnt try b writeWholeLogTo stdout break catch FileNotFoundException e if i retryCnt Exception myException new AbortException myException initCause e throw myException i Thread sleep retryInterval f get wait for the completion stdout println Completed b getFullDisplayName b getResult return b getResult ordinal catch InterruptedException e if follow return 125 else if the CLI is aborted try to abort the build as well f cancel true Exception myException new AbortException myException initCause e throw myException return 0 Override protected void printUsageSummary PrintStream stderr stderr println Starts a build and optionally waits for a completion n Aside from general scripting use this command can be n used to invoke another job from within a build of one job n With the s option this command changes the exit code based on n the outcome of the build exit code 0 indicates a success n and interrupting the command will interrupt the job n With the f option this command changes the exit code based on n the outcome of the build exit code 0 indicates a success n however unlike s interrupting the command will not interrupt n the job exit code 125 indicates the command was interrupted n With the c option a build will only run if there has been n an SCM change public static class CLICause extends UserIdCause private String startedBy public CLICause startedBy unknown public CLICause String startedBy this startedBy startedBy Override public String getShortDescription User user User get startedBy false String userName user null user getDisplayName startedBy return Messages BuildCommand CLICause ShortDescription userName Override public void print TaskListener listener listener getLogger println Messages BuildCommand CLICause ShortDescription ModelHyperlinkNote encodeTo user startedBy startedBy Override public boolean equals Object o return o instanceof CLICause Override public int hashCode return 7package jenkins model import com thoughtworks xstream converters Converter import com thoughtworks xstream converters MarshallingContext import com thoughtworks xstream converters UnmarshallingContext import com thoughtworks xstream core JVM import com thoughtworks xstream io HierarchicalStreamReader import com thoughtworks xstream io HierarchicalStreamWriter import com thoughtworks xstream mapper Mapper import hudson ExtensionPoint import hudson model AbstractDescribableImpl import hudson model Job import hudson model Run import hudson tasks LogRotator import hudson util RobustReflectionConverter import java io IOException public abstract class BuildDiscarder extends AbstractDescribableImpl BuildDiscarder implements ExtensionPoint public abstract void perform Job job throws IOException InterruptedException Override public BuildDiscarderDescriptor getDescriptor return BuildDiscarderDescriptor super getDescriptor public static class ConverterImpl implements Converter private RobustReflectionConverter ref public ConverterImpl Mapper m ref new RobustReflectionConverter m new JVM bestReflectionProvider Override protected Object instantiateNewInstance HierarchicalStreamReader reader UnmarshallingContext context return reflectionProvider newInstance LogRotator class public void marshal Object source HierarchicalStreamWriter writer MarshallingContext context abstract class so there shouldn t be any instance throw new UnsupportedOperationException public Object unmarshal HierarchicalStreamReader reader UnmarshallingContext context force unmarshal as LogRotator return ref unmarshal reader context public boolean canConvert Class type return type BuildDiscarder classpackage jenkins model import hudson DescriptorExtensionList import hudson model Descriptor public abstract class BuildDiscarderDescriptor extends Descriptor BuildDiscarder protected BuildDiscarderDescriptor Class clazz super clazz protected BuildDiscarderDescriptor public static DescriptorExtensionList BuildDiscarder BuildDiscarderDescriptor all return Jenkins getInstance BuildDiscarder BuildDiscarderDescriptor getDescriptorList BuildDiscarder classpackage jenkins model import hudson Extension import hudson model Descriptor import hudson model DescriptorVisibilityFilter import hudson model Items import hudson model Job import org jenkinsci Symbol import org kohsuke stapler DataBoundConstructor public class BuildDiscarderProperty extends OptionalJobProperty Job private final BuildDiscarder strategy DataBoundConstructor public BuildDiscarderProperty BuildDiscarder strategy this strategy strategy public BuildDiscarder getStrategy return strategy Extension Symbol buildDiscarder public static class DescriptorImpl extends OptionalJobPropertyDescriptor Override public String getDisplayName return Messages BuildDiscarderProperty displayName static Items XSTREAM2 addCompatibilityAlias org jenkinsci plugins workflow job properties BuildDiscarderProperty BuildDiscarderProperty class Extension public static class ConditionallyHidden extends DescriptorVisibilityFilter SuppressWarnings rawtypes Override public boolean filter Object context Descriptor descriptor if descriptor instanceof DescriptorImpl context instanceof Job return Job context supportsLogRotator return truepackage hudson tasks import hudson ExtensionPoint import hudson Extension import hudson DescriptorExtensionList import hudson model Build import hudson model BuildListener import hudson model Describable import hudson model Descriptor import jenkins model Jenkins public abstract class Builder extends BuildStepCompatibilityLayer implements Describable Builder ExtensionPoint these two methods need to remain to keep binary compatibility with plugins built with Hudson 1 150 public boolean prebuild Build build BuildListener listener return true public BuildStepMonitor getRequiredMonitorService return BuildStepMonitor NONE public Descriptor Builder getDescriptor return Jenkins getInstance getDescriptorOrDie getClass for backward compatibility the signature is not BuildStepDescriptor public static DescriptorExtensionList Builder Descriptor Builder all return Jenkins getInstance Builder Descriptor Builder getDescriptorList Builder classpackage hudson widgets import jenkins model Jenkins import hudson model Queue Item import hudson model Queue Task import jenkins widgets HistoryPageFilter import java util Collection import java util LinkedList import java util List public class BuildHistoryWidget T extends HistoryWidget Task T public BuildHistoryWidget Task owner Iterable T baseList Adapter super T adapter super owner baseList adapter public Item getQueuedItem return Jenkins getInstance getQueue getItem owner public List Item getQueuedItems LinkedList Item list new LinkedList Item for Item item Jenkins getInstance getQueue getItems if item task owner list addFirst item return list Override public HistoryPageFilter getHistoryPageFilter final HistoryPageFilter T historyPageFilter newPageFilter historyPageFilter add baseList getQueuedItems historyPageFilter widget this return updateFirstTransientBuildKey historyPageFilterpackage hudson model import java util List public interface BuildListener extends TaskListener void started List Cause causes void finished Result resultpackage jenkins util import hudson console ConsoleNote import hudson model BuildListener import hudson model Cause import hudson model Result import hudson model TaskListener import java io IOException import java io PrintStream import java io PrintWriter import java util List public final class BuildListenerAdapter implements BuildListener private final TaskListener delegate public BuildListenerAdapter TaskListener delegate this delegate delegate Override public void started List Cause causes throw new UnsupportedOperationException Override public void finished Result result throw new UnsupportedOperationException Override public PrintStream getLogger return delegate getLogger SuppressWarnings rawtypes Override public void annotate ConsoleNote ann throws IOException delegate annotate ann Override public void hyperlink String url String text throws IOException delegate hyperlink url text Override public PrintWriter error String msg return delegate error msg Override public PrintWriter error String format Object args return delegate error format args Override public PrintWriter fatalError String msg return delegate fatalError msg Override public PrintWriter fatalError String format Object args return delegate fatalError format args public static BuildListener wrap TaskListener l if l instanceof BuildListener return BuildListener l else return new BuildListenerAdapter lpackage jenkins widgets import hudson Functions import hudson Util import hudson model BallColor import hudson model Run import net sf json JSONObject import java util Date import org kohsuke accmod Restricted import org kohsuke accmod restrictions DoNotUse Restricted DoNotUse class only for buildListTable jelly public class BuildListTable extends RunListProgressiveRendering Override protected void calculate Run build JSONObject element BallColor iconColor build getIconColor element put iconColorOrdinal iconColor ordinal element put iconColorDescription iconColor getDescription element put url build getUrl element put buildStatusUrl build getBuildStatusUrl element put parentUrl build getParent getUrl element put parentFullDisplayName Functions breakableString Functions escape build getParent getFullDisplayName element put displayName build getDisplayName element put timestampString build getTimestampString element put timestampString2 build getTimestampString2 element put timestampString3 Util XS DATETIME FORMATTER format new Date build getStartTimeInMillis Run Summary buildStatusSummary build getBuildStatusSummary element put buildStatusSummaryWorse buildStatusSummary isWorse element put buildStatusSummaryMessage buildStatusSummary messagepackage jenkins widgets import hudson Extension import hudson widgets Widget import jenkins model Jenkins import org jenkinsci Symbol Extension ordinal 200 Symbol buildQueue historically this was the top most widget public class BuildQueueWidget extends Widgetpackage jenkins model lazy import hudson Extension import hudson ExtensionList import hudson ExtensionPoint import jenkins util SystemProperties import hudson model Run import java lang ref Reference import java lang ref SoftReference import java lang ref WeakReference import java util logging Level import java util logging Logger import javax annotation CheckForNull import javax annotation Nonnull import jenkins model lazy LazyBuildMixIn RunMixIn import org kohsuke accmod Restricted import org kohsuke accmod restrictions NoExternalUse public final class BuildReference R private static final Logger LOGGER Logger getLogger BuildReference class getName final String id private volatile Holder R holder public BuildReference String id R referent this id id this holder findHolder referent public CheckForNull R get Holder R h holder capture return h null h get null void clear holder null Override public boolean equals Object o if this o return true if o null getClass o getClass return false BuildReference that BuildReference o return id equals that id Override public int hashCode return id hashCode Override public String toString R r get return r null r toString id public interface Holder R CheckForNull R get public interface HolderFactory extends ExtensionPoint CheckForNull R Holder R make Nonnull R referent private static R Holder R findHolder R referent if referent null AbstractBuild NONE return new DefaultHolderFactory NoHolder R for HolderFactory f ExtensionList lookup HolderFactory class Holder R h f make referent if h null LOGGER log Level FINE created build reference for 0 using 1 new Object referent f return h return new DefaultHolderFactory make referent Restricted NoExternalUse class Extension ordinal Double NEGATIVE INFINITY public static final class DefaultHolderFactory implements HolderFactory public static final String MODE PROPERTY jenkins model lazy BuildReference MODE private static final String mode SystemProperties getString MODE PROPERTY Override public R Holder R make R referent if mode null mode equals soft return new SoftHolder R referent else if mode equals weak return new WeakHolder R referent else if mode equals strong return new StrongHolder R referent else if mode equals none return new NoHolder R else throw new IllegalStateException unrecognized value of MODE PROPERTY mode private static final class SoftHolder R extends SoftReference R implements Holder R SoftHolder R referent super referent private static final class WeakHolder R extends WeakReference R implements Holder R WeakHolder R referent super referent private static final class StrongHolder R implements Holder R private final R referent StrongHolder R referent this referent referent Override public R get return referent private static final class NoHolder R implements Holder R Override public R get return nullpackage jenkins model lazy import groovy util MapEntry import hudson util AdaptedIterator import hudson util Iterators import javax annotation Nullable import java lang reflect Array import java util ArrayList import java util Collection import java util Comparator import java util Iterator import java util LinkedHashMap import java util List import java util Map import java util Set import java util SortedMap class BuildReferenceMapAdapter R implements SortedMap Integer R private final AbstractLazyLoadRunMap R loader private final SortedMap Integer BuildReference R core BuildReferenceMapAdapter AbstractLazyLoadRunMap R loader SortedMap Integer BuildReference R core this loader loader this core core private R unwrap Nullable BuildReference R ref if ref null return null R v ref get if v null v loader getById ref id return v private BuildReference R wrap Nullable R value if value null return null return loader createReference value public Comparator super Integer comparator return core comparator public SortedMap Integer R subMap Integer fromKey Integer toKey return new BuildReferenceMapAdapter R loader core subMap fromKey toKey public SortedMap Integer R headMap Integer toKey return new BuildReferenceMapAdapter R loader core headMap toKey public SortedMap Integer R tailMap Integer fromKey return new BuildReferenceMapAdapter R loader core tailMap fromKey public Integer firstKey return core firstKey public Integer lastKey return core lastKey public Set Integer keySet return core keySet public Collection R values return new CollectionAdapter core values public Set Entry Integer R entrySet return new SetAdapter core entrySet public int size return core size public boolean isEmpty return core isEmpty public boolean containsKey Object key return core containsKey key public boolean containsValue Object value return core containsValue value TODO should this be core containsValue wrap value public R get Object key return unwrap core get key public R put Integer key R value return unwrap core put key wrap value public R remove Object key return unwrap core remove key public void putAll Map extends Integer extends R m for Entry extends Integer extends R e m entrySet put e getKey e getValue public void clear core clear Override public boolean equals Object o return core equals o TODO this is wrong Override public int hashCode return core hashCode Override public String toString return new LinkedHashMap Integer R this toString private class CollectionAdapter implements Collection R private final Collection BuildReference R core private CollectionAdapter Collection BuildReference R core this core core public int size return core size public boolean isEmpty return core isEmpty public boolean contains Object o TODO to properly pass this onto core we need to wrap o into BuildReference but also needs to figure out ID throw new UnsupportedOperationException public Iterator R iterator silently drop null as if we didn t have them in this collection in the first place this shouldn t be indistinguishable from concurrent modifications to the collection return Iterators removeNull new AdaptedIterator BuildReference R R core iterator protected R adapt BuildReference R ref return unwrap ref public Object toArray List Object list new ArrayList Object for R r this list add r return list toArray public T T toArray T a int size size T r a if r length size r T Array newInstance a getClass getComponentType size Iterator R itr iterator int i 0 while itr hasNext r i T itr next return r public boolean add R value return core add wrap value public boolean remove Object o return core remove o TODO to properly pass this onto core we need to wrap o into BuildReference but also needs to figure out ID throw new UnsupportedOperationException public boolean containsAll Collection c for Object o c if contains o return false return true public boolean addAll Collection extends R c boolean b false for R r c b add r return b public boolean removeAll Collection c boolean b false for Object o c b remove o return b public boolean retainAll Collection c TODO to properly pass this onto core we need to wrap o into BuildReference but also needs to figure out ID throw new UnsupportedOperationException public void clear core clear Override public boolean equals Object o return core equals o Override public int hashCode return core hashCode private class SetAdapter implements Set Entry Integer R private final Set Entry Integer BuildReference R core private SetAdapter Set Entry Integer BuildReference R core this core core public int size return core size public boolean isEmpty return core isEmpty public boolean contains Object o TODO to properly pass this onto core we need to wrap o into BuildReference but also needs to figure out ID throw new UnsupportedOperationException public Iterator Entry Integer R iterator return Iterators removeNull new AdaptedIterator Entry Integer BuildReference R Entry Integer R core iterator protected Entry Integer R adapt Entry Integer BuildReference R e return unwrap e public Object toArray List Object list new ArrayList Object for Entry Integer R r this list add r return list toArray public T T toArray T a int size size T r a if r length size r T Array newInstance a getClass getComponentType size Iterator Entry Integer R itr iterator int i 0 while itr hasNext r i T itr next return r public boolean add Entry Integer R value return core add wrap value public boolean remove Object o return core remove o TODO to properly pass this onto core we need to wrap o into BuildReference but also needs to figure out ID throw new UnsupportedOperationException public boolean containsAll Collection c for Object o c if contains o return false return true public boolean addAll Collection extends Entry Integer R c boolean b false for Entry Integer R r c b add r return b public boolean removeAll Collection c boolean b false for Object o c b remove o return b public boolean retainAll Collection c TODO to properly pass this onto core we need to wrap o into BuildReference but also needs to figure out ID throw new UnsupportedOperationException public void clear core clear Override public boolean equals Object o return core equals o Override public int hashCode return core hashCode private Entry Integer BuildReference R wrap Entry Integer R e return new MapEntry e getKey wrap e getValue private Entry Integer R unwrap Entry Integer BuildReference R e R v unwrap e getValue if v null return null return new MapEntry e getKey vpackage hudson tasks import hudson AbortException import hudson Launcher import hudson Extension import hudson ExtensionList import hudson util DescriptorList import hudson model AbstractBuild import hudson model AbstractProject import hudson model Action import hudson model Build import hudson model BuildListener import hudson model Descriptor import hudson model Project import hudson model CheckPoint import hudson model Run import hudson security ACL import hudson security Permission import java io IOException import java util Collection import java util List import java util AbstractList import java util Iterator import java util WeakHashMap import jenkins security QueueItemAuthenticator import org acegisecurity Authentication import javax annotation Nonnull public interface BuildStep boolean prebuild AbstractBuild build BuildListener listener boolean perform AbstractBuild build Launcher launcher BuildListener listener throws InterruptedException IOException Deprecated Action getProjectAction AbstractProject project Nonnull Collection extends Action getProjectActions AbstractProject project BuildStepMonitor getRequiredMonitorService Deprecated List Descriptor Builder BUILDERS new DescriptorList Builder Builder class Deprecated PublisherList PUBLISHERS new PublisherList final class PublisherList extends AbstractList Descriptor Publisher private final DescriptorList Publisher core new DescriptorList Publisher Publisher class static final WeakHashMap Descriptor Publisher Class extends Publisher KIND new WeakHashMap Descriptor Publisher Class extends Publisher private PublisherList public void addNotifier Descriptor Publisher d KIND put d Notifier class core add d public void addRecorder Descriptor Publisher d KIND put d Recorder class core add d Override public boolean add Descriptor Publisher d return contains d core add d Override public void add int index Descriptor Publisher d if contains d core add d public Descriptor Publisher get int index return core get index public int size return core size Override public Iterator Descriptor Publisher iterator return core iterator Override public boolean remove Object o return core remove opackage hudson tasks import hudson AbortException import hudson FilePath import hudson model Build import hudson model BuildListener import hudson model Action import hudson model Project import hudson model AbstractBuild import hudson model AbstractProject import hudson Launcher import java io IOException import java util Collection import java util Collections import hudson model Run import hudson model TaskListener import jenkins tasks SimpleBuildStep import javax annotation Nonnull Deprecated public abstract class BuildStepCompatibilityLayer implements BuildStep new definitions 1 150 public boolean prebuild AbstractBuild build BuildListener listener if build instanceof Build return prebuild Build build listener else return true Override public boolean perform AbstractBuild build Launcher launcher BuildListener listener throws InterruptedException IOException if this instanceof SimpleBuildStep delegate to the overloaded version defined in SimpleBuildStep FilePath workspace build getWorkspace if workspace null throw new AbortException no workspace for build SimpleBuildStep this perform build workspace launcher listener return true else if build instanceof Build delegate to the legacy signature deprecated in 1 312 return perform Build build launcher listener else return true public Action getProjectAction AbstractProject project if project instanceof Project return getProjectAction Project project else return null Nonnull public Collection extends Action getProjectActions AbstractProject project delegate to getJobAction singular for backward compatible behavior Action a getProjectAction project if a null return Collections emptyList return Collections singletonList a old definitions 1 150 Deprecated public boolean prebuild Build build BuildListener listener return true Deprecated public boolean perform Build build Launcher launcher BuildListener listener throws InterruptedException IOException throw new UnsupportedOperationException Deprecated public Action getProjectAction Project project return nullpackage hudson tasks import hudson model Describable import hudson model Descriptor import hudson model AbstractProject import jenkins model Jenkins import hudson model AbstractProject AbstractProjectDescriptor import java util List import java util ArrayList public abstract class BuildStepDescriptor T extends BuildStep Describable T extends Descriptor T protected BuildStepDescriptor Class extends T clazz super clazz protected BuildStepDescriptor public abstract boolean isApplicable Class extends AbstractProject jobType public static T extends BuildStep Describable T List Descriptor T filter List Descriptor T base Class extends AbstractProject type descriptor of the project Descriptor pd Jenkins getInstance getDescriptor Class type List Descriptor T r new ArrayList Descriptor T base size for Descriptor T d base if pd instanceof AbstractProjectDescriptor AbstractProjectDescriptor pd isApplicable d continue if d instanceof BuildStepDescriptor BuildStepDescriptor T bd BuildStepDescriptor T d if bd isApplicable type continue r add bd else old plugins built before 1 150 may not implement BuildStepDescriptor r add d return rpackage hudson model import hudson ExtensionList import hudson ExtensionPoint import hudson tasks BuildStep public abstract class BuildStepListener implements ExtensionPoint public abstract void started AbstractBuild build BuildStep bs BuildListener listener public abstract void finished AbstractBuild build BuildStep bs BuildListener listener boolean canContinue public static ExtensionList BuildStepListener all TODO should have a null safe version when Jenkins getInstance is null would require changes in ExtensionList return ExtensionList lookup BuildStepListener classpackage hudson tasks import hudson model AbstractBuild import hudson model BuildListener import hudson model CheckPoint import hudson Launcher import hudson model Describable import java io IOException public enum BuildStepMonitor NONE public boolean perform BuildStep bs AbstractBuild build Launcher launcher BuildListener listener throws IOException InterruptedException return bs perform build launcher listener STEP public boolean perform BuildStep bs AbstractBuild build Launcher launcher BuildListener listener throws InterruptedException IOException CheckPoint cp new CheckPoint bs getClass getName bs getClass if bs instanceof Describable cp block listener Describable bs getDescriptor getDisplayName else cp block try return bs perform build launcher listener finally cp report BUILD public boolean perform BuildStep bs AbstractBuild build Launcher launcher BuildListener listener throws IOException InterruptedException if bs instanceof Describable CheckPoint COMPLETED block listener Describable bs getDescriptor getDisplayName else CheckPoint COMPLETED block return bs perform build launcher listener public abstract boolean perform BuildStep bs AbstractBuild build Launcher launcher BuildListener listener throws IOException InterruptedExceptionpackage hudson model import hudson util RunList import org kohsuke stapler QueryParameter import org kohsuke stapler StaplerRequest import org koshuke stapler simile timeline Event import org koshuke stapler simile timeline TimelineEventList import java io IOException import java util Date public class BuildTimelineWidget protected final RunList builds public BuildTimelineWidget RunList builds this builds builds limit 20 TODO instead render lazily Deprecated public Run getFirstBuild return builds getFirstBuild Deprecated public Run getLastBuild return builds getLastBuild public TimelineEventList doData StaplerRequest req QueryParameter long min QueryParameter long max throws IOException TimelineEventList result new TimelineEventList for Run r builds byTimestamp min max Event e new Event e start new Date r getStartTimeInMillis e end new Date r getStartTimeInMillis r getDuration e title r getFullDisplayName what to put in the description e description Longish description of event r getFullDisplayName e durationEvent true e link req getContextPath r getUrl BallColor c r getIconColor e color String format 06X c getBaseColor darker getRGB 0xFFFFFF e classname event c noAnime toString c isAnimated animated result add e return resultpackage jenkins widgets import hudson model AbstractBuild import hudson model BallColor import hudson model Node import hudson model Run import jenkins model Jenkins import net sf json JSONObject import org kohsuke accmod Restricted import org kohsuke accmod restrictions DoNotUse Restricted DoNotUse class only for buildTimeTrend jelly public class BuildTimeTrend extends RunListProgressiveRendering Override protected void calculate Run build JSONObject element BallColor iconColor build getIconColor element put iconColorOrdinal iconColor ordinal element put iconColorDescription iconColor getDescription element put buildStatusUrl build getBuildStatusUrl element put number build getNumber element put displayName build getDisplayName element put duration build getDuration element put durationString build getDurationString if build instanceof AbstractBuild AbstractBuild b AbstractBuild build Node n b getBuiltOn if n null String ns b getBuiltOnStr if ns null ns isEmpty element put builtOnStr ns else if n Jenkins getInstance element put builtOn n getNodeName element put builtOnStr n getDisplayName else element put builtOnStr hudson model Messages Hudson Computer DisplayNamepackage hudson tasks import hudson Extension import hudson Launcher import hudson Util import hudson console ModelHyperlinkNote import hudson model AbstractBuild import hudson model AbstractProject import hudson model Action import hudson model AutoCompletionCandidates import hudson model BuildListener import hudson model Cause UpstreamCause import hudson model DependencyGraph import hudson model DependencyGraph Dependency import hudson model Item import hudson model ItemGroup import hudson model Items import hudson model Job import hudson model Project import hudson model Result import hudson model Run import hudson model TaskListener import hudson model listeners ItemListener import hudson model queue Tasks import hudson security ACL import hudson security ACLContext import hudson util FormValidation import java io IOException import java io PrintStream import java util ArrayList import java util Collection import java util Collections import java util Comparator import java util List import java util StringTokenizer import java util logging Level import java util logging Logger import javax annotation CheckForNull import jenkins model DependencyDeclarer import jenkins model Jenkins import jenkins security QueueItemAuthenticatorConfiguration import jenkins security QueueItemAuthenticatorDescriptor import jenkins triggers ReverseBuildTrigger import net sf json JSONObject import org acegisecurity Authentication import org acegisecurity context SecurityContext import org acegisecurity context SecurityContextHolder import org apache commons lang StringUtils import org jenkinsci Symbol import org kohsuke stapler AncestorInPath import org kohsuke stapler DataBoundConstructor import org kohsuke stapler QueryParameter import org kohsuke stapler StaplerRequest public class BuildTrigger extends Recorder implements DependencyDeclarer private String childProjects private final Result threshold public BuildTrigger String childProjects boolean evenIfUnstable this childProjects evenIfUnstable Result UNSTABLE Result SUCCESS DataBoundConstructor public BuildTrigger String childProjects String threshold this childProjects Result fromString StringUtils defaultString threshold Result SUCCESS toString public BuildTrigger String childProjects Result threshold if childProjects null throw new IllegalArgumentException this childProjects childProjects this threshold threshold public BuildTrigger List AbstractProject childProjects Result threshold this Collection AbstractProject childProjects threshold public BuildTrigger Collection extends AbstractProject childProjects Result threshold this Items toNameList childProjects threshold public String getChildProjectsValue return childProjects public Result getThreshold if threshold null return Result SUCCESS else return threshold Deprecated public List AbstractProject getChildProjects return getChildProjects Jenkins getInstance public List AbstractProject getChildProjects AbstractProject owner return getChildProjects owner null null owner getParent public List AbstractProject getChildProjects ItemGroup base return Items fromNameList base childProjects AbstractProject class public BuildStepMonitor getRequiredMonitorService return BuildStepMonitor NONE public boolean hasSame AbstractProject owner Collection extends AbstractProject projects List AbstractProject children getChildProjects owner return children size projects size children containsAll projects Deprecated public boolean hasSame Collection extends AbstractProject projects return hasSame null projects Override public boolean perform AbstractBuild build Launcher launcher BuildListener listener return true Deprecated public static boolean execute AbstractBuild build BuildListener listener BuildTrigger trigger return execute build listener public static boolean execute AbstractBuild build BuildListener listener PrintStream logger listener getLogger Check all downstream Project of the project not just those defined by BuildTrigger TODO this may not yet be up to date if rebuildDependencyGraphAsync has been used need a method to wait for the last call made before now to finish final DependencyGraph graph Jenkins getInstance getDependencyGraph List Dependency downstreamProjects new ArrayList Dependency graph getDownstreamDependencies build getProject Sort topologically Collections sort downstreamProjects new Comparator Dependency public int compare Dependency lhs Dependency rhs Swapping lhs rhs to get reverse sort return graph compare rhs getDownstreamProject lhs getDownstreamProject Authentication auth Jenkins getAuthentication from build if auth equals ACL SYSTEM i e unspecified if QueueItemAuthenticatorDescriptor all isEmpty if downstreamProjects isEmpty return true logger println Messages BuildTrigger warning you have no plugins providing ac else if QueueItemAuthenticatorConfiguration get getAuthenticators isEmpty if downstreamProjects isEmpty return true logger println Messages BuildTrigger warning access control for builds in glo else This warning must be printed even if downstreamProjects is empty Otherwise you could effectively escalate DISCOVER to READ just by trying different project names and checking whether a warning was printed or not If there were an API to determine whether any DependencyDeclarer s in this project requested downstream project names then we could suppress the warnings in case none did but if any do yet Items fromNameList etc ignore unknown projects that has to be treated the same as if there really are downstream projects but the anonymous user cannot see them For the above two cases it is OK to suppress the warning when there are no downstream projects since running as SYSTEM we would be able to see them anyway logger println Messages BuildTrigger warning this build has no associated aut auth Jenkins ANONYMOUS for Dependency dep downstreamProjects List Action buildActions new ArrayList Action SecurityContext orig ACL impersonate auth try if dep shouldTriggerBuild build listener buildActions AbstractProject p dep getDownstreamProject Allow shouldTriggerBuild to return false first in case it is skipping because of a lack of Item READ DISCOVER permission if p isDisabled logger println Messages BuildTrigger Disabled ModelHyperlinkNote encodeTo p continue boolean scheduled p scheduleBuild p getQuietPeriod new UpstreamCause Run build buildActions toArray new Action buildActions size if Jenkins getInstance getItemByFullName p getFullName p String name ModelHyperlinkNote encodeTo p if scheduled logger println Messages BuildTrigger Triggering name else logger println Messages BuildTrigger InQueue name otherwise upstream users should not know that it happened finally SecurityContextHolder setContext orig return true public void buildDependencyGraph AbstractProject owner DependencyGraph graph for AbstractProject p getChildProjects owner graph addDependency new Dependency owner p Override public boolean shouldTriggerBuild AbstractBuild build TaskListener listener List Action actions AbstractProject downstream getDownstreamProject if Jenkins getInstance getItemByFullName downstream getFullName downstream this checks Item READ also on parent folders LOGGER log Level WARNING Running as 0 cannot even see 1 for trigger from 2 new Object Jenkins getAuthentication getName downstream getUpstreamProject return false do not even issue a warning to build log if downstream hasPermission Item BUILD listener getLogger println Messages BuildTrigger you have no permission to build ModelHyperlinkNote encodeTo downstream return false return build getResult isBetterOrEqualTo threshold Override public boolean needsToRunAfterFinalized return true Deprecated public boolean onJobRenamed String oldName String newName quick test if childProjects contains oldName return false boolean changed false we need to do this per string since old Project object is already gone String projects childProjects split for int i 0 i projects length i if projects i trim equals oldName projects i newName changed true if changed StringBuilder b new StringBuilder for String p projects if b length 0 b append b append p childProjects b toString return changed private Object readResolve if childProjects null return childProjects return this Extension Symbol downstream public static class DescriptorImpl extends BuildStepDescriptor Publisher public String getDisplayName return Messages BuildTrigger DisplayName Override public String getHelpFile return help project config downstream html Override public BuildTrigger newInstance StaplerRequest req JSONObject formData throws FormException String childProjectsString formData getString childProjects trim if childProjectsString endsWith childProjectsString childProjectsString substring 0 childProjectsString length 1 trim return new BuildTrigger childProjectsString formData optString threshold Result SUCCESS toString Override public boolean isApplicable Class extends AbstractProject jobType return true public boolean showEvenIfUnstableOption CheckForNull Class extends AbstractProject jobType UGLY for promotion process this option doesn t make sense return jobType null jobType getName contains PromotionProcess public FormValidation doCheck AncestorInPath AbstractProject project QueryParameter String value JENKINS 32525 Check that it behaves gracefully for an unknown context if project null return FormValidation ok Messages BuildTrigger ok ancestor is null Require CONFIGURE permission on this project if project hasPermission Item CONFIGURE return FormValidation ok StringTokenizer tokens new StringTokenizer Util fixNull value boolean hasProjects false while tokens hasMoreTokens String projectName tokens nextToken trim if StringUtils isNotBlank projectName Item item Jenkins getInstance getItem projectName project Item class if item null AbstractProject nearest AbstractProject findNearest projectName project getParent String alternative nearest null nearest getRelativeNameFrom project return FormValidation error Messages BuildTrigger NoSuchProject projectName alternative if item instanceof AbstractProject return FormValidation error Messages BuildTrigger NotBuildable projectName check whether the supposed user is expected to be able to build Authentication auth Tasks getAuthenticationOf project if auth equals ACL SYSTEM QueueItemAuthenticatorConfiguration get getAuthenticators isEmpty auth Jenkins ANONYMOUS compare behavior in execute above if item getACL hasPermission auth Item BUILD return FormValidation error Messages BuildTrigger you have no permission to build projectName hasProjects true if hasProjects return FormValidation error Messages BuildTrigger NoProjectSpecified return FormValidation ok public AutoCompletionCandidates doAutoCompleteChildProjects QueryParameter String value AncestorInPath Item self AncestorInPath ItemGroup container return AutoCompletionCandidates ofJobNames Job class value self container Extension public static class ItemListenerImpl extends ItemListener Override public void onLocationChanged final Item item final String oldFullName final String newFullName try ACLContext ACL as ACL SYSTEM locationChanged item oldFullName newFullName private void locationChanged Item item String oldFullName String newFullName update BuildTrigger of other projects that point to this object can t we generalize this for Project p Jenkins getInstance getAllItems Project class BuildTrigger t p getPublishersList get BuildTrigger class if t null String cp2 Items computeRelativeNamesAfterRenaming oldFullName newFullName t childProjects p getParent if cp2 equals t childProjects t childProjects cp2 try p save catch IOException e LOGGER log Level WARNING Failed to persist project setting during rename from oldFullName to newFullName e private static final Logger LOGGER Logger getLogger BuildTrigger class getNamepackage hudson model import hudson ExtensionList import hudson ExtensionPoint import hudson tasks Builder import hudson tasks Publisher import java util Map public abstract class BuildVariableContributor implements ExtensionPoint public abstract void buildVariablesFor AbstractBuild build Map String String variables public static ExtensionList BuildVariableContributor all return ExtensionList lookup BuildVariableContributor classpackage hudson tasks import hudson ExtensionPoint import hudson Launcher import hudson DescriptorExtensionList import hudson LauncherDecorator import hudson console ConsoleLogFilter import hudson model import hudson model Run RunnerAbortedException import hudson util ArgumentListBuilder import jenkins model Jenkins import java io IOException import java io OutputStream import java util Collection import java util Collections import java util Map import java util Set public abstract class BuildWrapper extends AbstractDescribableImpl BuildWrapper implements ExtensionPoint public abstract class Environment extends hudson model Environment public boolean tearDown AbstractBuild build BuildListener listener throws IOException InterruptedException if build instanceof Build return tearDown Build build listener else return true Deprecated public boolean tearDown Build build BuildListener listener throws IOException InterruptedException return true public Environment setUp AbstractBuild build Launcher launcher BuildListener listener throws IOException InterruptedException if build instanceof Build return setUp Build build launcher listener else throw new AssertionError The plugin this getClass getName still uses deprecated setUp Build Launcher BuildListener method Update the plugin to use setUp AbstractBuild Launcher BuildListener instead Deprecated public Environment setUp Build build Launcher launcher BuildListener listener throws IOException InterruptedException throw new UnsupportedOperationException getClass needs to implement the setUp method public Launcher decorateLauncher AbstractBuild build Launcher launcher BuildListener listener throws IOException InterruptedException RunnerAbortedException return launcher public OutputStream decorateLogger AbstractBuild build OutputStream logger throws IOException InterruptedException RunnerAbortedException return logger public void preCheckout AbstractBuild build Launcher launcher BuildListener listener throws IOException InterruptedException Deprecated public Action getProjectAction AbstractProject job return null public Collection extends Action getProjectActions AbstractProject job delegate to getJobAction singular for backward compatible behavior Action a getProjectAction job if a null return Collections emptyList return Collections singletonList a public void makeBuildVariables AbstractBuild build Map String String variables noop public void makeSensitiveBuildVariables AbstractBuild build Set String sensitiveVariables noop for compatibility we can t use BuildWrapperDescriptor public static DescriptorExtensionList BuildWrapper Descriptor BuildWrapper all use getDescriptorList and not getExtensionList to pick up legacy instances return Jenkins getInstance BuildWrapper Descriptor BuildWrapper getDescriptorList BuildWrapper classpackage hudson tasks import hudson model AbstractProject import hudson model Descriptor import hudson model Describable import hudson model AbstractProject AbstractProjectDescriptor public abstract class BuildWrapperDescriptor extends Descriptor BuildWrapper protected BuildWrapperDescriptor Class extends BuildWrapper clazz super clazz protected BuildWrapperDescriptor public abstract boolean isApplicable AbstractProject itempackage hudson tasks import hudson model AbstractProject import hudson model Descriptor import jenkins model Jenkins import hudson model AbstractProject AbstractProjectDescriptor import hudson Extension import hudson util DescriptorList import java util ArrayList import java util List public class BuildWrappers Deprecated public static final List Descriptor BuildWrapper WRAPPERS new DescriptorList BuildWrapper class public static List Descriptor BuildWrapper getFor AbstractProject project List Descriptor BuildWrapper result new ArrayList Descriptor pd Jenkins getInstance getDescriptor Class project getClass for Descriptor BuildWrapper w BuildWrapper all if pd instanceof AbstractProjectDescriptor AbstractProjectDescriptor pd isApplicable w continue if w instanceof BuildWrapperDescriptor BuildWrapperDescriptor bwd BuildWrapperDescriptor w if bwd isApplicable project result add bwd else old BuildWrapper that doesn t implement BuildWrapperDescriptor result add w return resultpackage hudson import hudson model Saveable import java io Closeable import java io IOException public class BulkChange implements Closeable private final Saveable saveable public final Exception allocator private final BulkChange parent private boolean completed public BulkChange Saveable saveable this parent current this saveable saveable rememeber who allocated this object in case someone forgot to call save at the end allocator new Exception in effect at construction INSCOPE set this public void commit throws IOException if completed return completed true move this object out of the scope first before save or otherwise the save method will do nothing pop saveable save Override public void close abort public void abort if completed return completed true pop private void pop if current this throw new AssertionError Trying to save BulkChange that s not in scope INSCOPE set parent private static final ThreadLocal BulkChange INSCOPE new ThreadLocal BulkChange public static BulkChange current return INSCOPE get public static boolean contains Saveable s for BulkChange b current b null b b parent if b saveable s b saveable ALL return true return false public static final Saveable ALL new Saveable public void savepackage hudson util import java io ByteArrayOutputStream import java io IOException import java io InputStream public class ByteArrayOutputStream2 extends ByteArrayOutputStream public ByteArrayOutputStream2 public ByteArrayOutputStream2 int size super size public byte getBuffer return buf public void readFrom InputStream is throws IOException while true if count buf length realllocate byte data new byte buf length 2 System arraycopy buf 0 data 0 buf length buf data int sz is read buf count buf length count if sz 0 return count szpackage hudson util import java io OutputStream import java io IOException import java io ByteArrayOutputStream import java io InputStream Deprecated public class ByteBuffer extends OutputStream private byte buf new byte 8192 private int size 0 public synchronized void write byte b int off int len throws IOException ensureCapacity len System arraycopy b off buf size len size len public synchronized void write int b throws IOException ensureCapacity 1 buf size byte b public synchronized long length return size private void ensureCapacity int len if buf length size len return byte n new byte Math max buf length 2 size len System arraycopy buf 0 n 0 size this buf n public synchronized String toString return new String buf 0 size public synchronized void writeTo OutputStream os throws IOException os write buf 0 size public InputStream newInputStream return new InputStream private int pos 0 public int read throws IOException synchronized ByteBuffer this if pos size return 1 return buf pos public int read byte b int off int len throws IOException synchronized ByteBuffer this if size pos return 1 int sz Math min len size pos System arraycopy buf pos b off sz pos sz return sz public int available throws IOException synchronized ByteBuffer this return size pos public long skip long n throws IOException synchronized ByteBuffer this int diff int Math min n size pos pos diff return diffpackage jenkins security s2m import hudson Extension import jenkins util SystemProperties import hudson remoting Callable import hudson remoting ChannelBuilder import jenkins security ChannelConfigurator import jenkins security Roles import org jenkinsci remoting Role import org jenkinsci remoting RoleChecker import org jenkinsci remoting RoleSensitive import org kohsuke accmod Restricted import org kohsuke accmod restrictions DoNotUse import org kohsuke accmod restrictions NoExternalUse import javax annotation Nonnull import java util Collection import java util logging Level import java util logging Logger Restricted NoExternalUse class used implicitly via listener public class CallableDirectionChecker extends RoleChecker private final Object context private static final String BYPASS PROP CallableDirectionChecker class getName allow public static boolean BYPASS SystemProperties getBoolean BYPASS PROP private CallableDirectionChecker Object context this context context Override public void check RoleSensitive subject Nonnull Collection Role expected throws SecurityException final String name subject getClass getName if expected contains Roles MASTER LOGGER log Level FINE Executing 0 is allowed since it is targeted for the master role name return known to be safe if isWhitelisted subject expected this subject is dubious but we are letting it through as per whitelisting LOGGER log Level FINE Explicitly allowing 0 to be sent from agent to master name return throw new SecurityException Sending name from agent to master is prohibited nSee http jenkins ci org security 144 for more details private boolean isWhitelisted RoleSensitive subject Collection Role expected for CallableWhitelist w CallableWhitelist all if w isWhitelisted subject expected context return true return false Restricted DoNotUse class impl Extension public static class ChannelConfiguratorImpl extends ChannelConfigurator Override public void onChannelBuilding ChannelBuilder builder Object context if the big red emergency button is pressed then we need to disable the defense mechanism including enabling classloading if BYPASS builder withRemoteClassLoadingAllowed false In either of the above cases the check method will return normally but may log things builder withRoleChecker new CallableDirectionChecker context Extension ordinal 100 public static class DefaultWhitelist extends CallableWhitelist Override public boolean isWhitelisted RoleSensitive subject Collection Role expected Object context return BYPASS private static final Logger LOGGER Logger getLogger CallableDirectionChecker class getNamepackage jenkins security s2m import com google common collect ImmutableSet import jenkins model Jenkins import java io File import java io IOException import java util ArrayList import java util HashSet import java util List import java util Set import java util logging Level import java util logging Logger public class CallableRejectionConfig extends ConfigFile Class Set Class private final CallableWhitelistConfig whitelist CallableRejectionConfig File file CallableWhitelistConfig whitelist super file this whitelist whitelist Override protected Set Class create return new HashSet Class Override protected Set Class readOnly Set Class base return ImmutableSet copyOf base Override protected Class parse String line try line line trim if whitelist contains line return null already whitelisted return Jenkins getInstance pluginManager uberClassLoader loadClass line catch ClassNotFoundException e no longer present in the system return null void report Class c if get contains c try append c getName catch IOException e LOGGER log Level WARNING Failed to persist file e public List RejectedCallable describe List RejectedCallable l new ArrayList RejectedCallable for Class c get if whitelist contains c getName l add new RejectedCallable c return l private static final Logger LOGGER Logger getLogger CallableRejectionConfig class getNamepackage jenkins security s2m import hudson ExtensionList import hudson ExtensionPoint import hudson remoting Callable import hudson remoting ChannelBuilder import jenkins model Jenkins import jenkins security ChannelConfigurator import org jenkinsci remoting Role import org jenkinsci remoting RoleChecker import org jenkinsci remoting RoleSensitive import java util Collection public abstract class CallableWhitelist implements ExtensionPoint public abstract boolean isWhitelisted RoleSensitive subject Collection Role expected Object context public static ExtensionList CallableWhitelist all return Jenkins getInstance getExtensionList CallableWhitelist classpackage jenkins security s2m import com google common collect ImmutableSet import hudson Util import org jenkinsci remoting RoleSensitive import java io File import java util HashSet import java util Set class CallableWhitelistConfig extends ConfigDirectory String Set String CallableWhitelistConfig File file super file Override protected Set String create return new HashSet String Override protected Set String readOnly Set String base return ImmutableSet copyOf base Override protected String parse String line return Util fixEmptyAndTrim line public boolean contains String name return get contains namepackage com twitter sdk android core import retrofit2 Call import retrofit2 Response public abstract class Callback T implements retrofit2 Callback T Override public final void onResponse Call T call Response T response if response isSuccessful success new Result response body response else failure new TwitterApiException response Override public final void onFailure Call T call Throwable t failure new TwitterException Request Failure t public abstract void success Result T result public abstract void failure TwitterException exceptionpackage hudson cli import hudson Extension import jenkins model Jenkins import java util logging Logger Extension public class CancelQuietDownCommand extends CLICommand private static final Logger LOGGER Logger getLogger CancelQuietDownCommand class getName Override public String getShortDescription return Messages CancelQuietDownCommand ShortDescription Override protected int run throws Exception Jenkins getActiveInstance doCancelQuietDown return 0package hudson security captcha import hudson DescriptorExtensionList import hudson ExtensionPoint import hudson model AbstractDescribableImpl import hudson model Descriptor import java io IOException import java io OutputStream import jenkins model Jenkins public abstract class CaptchaSupport extends AbstractDescribableImpl CaptchaSupport implements ExtensionPoint public static DescriptorExtensionList CaptchaSupport Descriptor CaptchaSupport all return Jenkins getInstance CaptchaSupport Descriptor CaptchaSupport getDescriptorList CaptchaSupport class abstract public boolean validateCaptcha String id String text abstract public void generateImage String id OutputStream ios throws IOException public CaptchaSupportDescriptor getDescriptor return CaptchaSupportDescriptor super getDescriptorpackage hudson security captcha import hudson model Descriptor public abstract class CaptchaSupportDescriptor extends Descriptor CaptchaSupport so far nothing different from plain Descriptor but it may prove useful for future expansionpackage com twitter sdk android tweetcomposer import android content Context import android net Uri import java io Serializable public class Card implements Serializable public static final String APP CARD TYPE promo image app final String cardType final String imageUri final String appName final String appIPadId final String appIPhoneId final String appGooglePlayId Card String cardType String imageUri String appName String appIPhoneId String appIPadId String appGooglePlayId this cardType cardType this imageUri imageUri this appName appName this appIPadId appIPadId this appIPhoneId appIPhoneId this appGooglePlayId appGooglePlayId public String getCardType return cardType static boolean isAppCard Card card return card null card getCardType null card getCardType equals APP CARD TYPE public static class AppCardBuilder private String appName private Uri imageUri private String appIPhoneId private String appIPadId private String appGooglePlayId public AppCardBuilder Context context appName getApplicationName context appGooglePlayId getPackageName context public AppCardBuilder imageUri Uri imageUri this imageUri imageUri return this public AppCardBuilder iPhoneId String appIPhoneId this appIPhoneId appIPhoneId return this public AppCardBuilder iPadId String appIPadId this appIPadId appIPadId return this public AppCardBuilder googlePlayId String appGooglePlayId this appGooglePlayId appGooglePlayId return this public Card build if imageUri null throw new IllegalStateException App Card requires a non null imageUri return new Card APP CARD TYPE imageUri toString appName appIPhoneId appIPadId appGooglePlayId private static String getApplicationName Context context return context getApplicationInfo loadLabel context getPackageManager toString private static String getPackageName Context context return context getPackageNamepackage com twitter sdk android tweetcomposer internal import com google gson annotations SerializedName public class CardCreate SerializedName card uri public final String cardUri SerializedName status public final String status public CardCreate String cardUri String status this cardUri cardUri this status statuspackage com twitter sdk android tweetcomposer internal import com google gson Gson import com google gson annotations SerializedName public class CardData private static Serializer serializer private CardData String card String image String site String description String cardData String callToAction String ctaKey String deviceId String appIPhoneId String appIPadId String appGooglePlayId String appCountry this card card this image image this site site this description description this cardData cardData this callToAction callToAction this ctaKey ctaKey this deviceId deviceId this appIPhoneId appIPhoneId this appIPadId appIPadId this appGooglePlayId appGooglePlayId this appCountry appCountry SerializedName twitter card public final String card SerializedName twitter image public final String image SerializedName twitter site public final String site SerializedName twitter description public final String description SerializedName twitter card data public final String cardData SerializedName twitter text cta public final String callToAction SerializedName twitter cta key public final String ctaKey SerializedName twitter text did value public final String deviceId SerializedName twitter app id iphone public final String appIPhoneId SerializedName twitter app id ipad public final String appIPadId SerializedName twitter app id googleplay public final String appGooglePlayId SerializedName twitter app country public final String appCountry Serializer getSerializer if serializer null serializer new Serializer return serializer Override public String toString Required bc the Cards API accepts form urlencoded requests with nested CardData JSON Retrofit converts Fields to strings without using registered Converters https github com square retrofit blob master retrofit src main java retrofit http Field java L28 return getSerializer serialize this static class Serializer private final Gson gson Serializer this gson new Gson String serialize CardData data return this gson toJson data public static class Builder private String card private String image private String site private String description private String cardData private String callToAction private String ctaKey private String deviceId private String appIPhoneId private String appIPadId private String appGooglePlayId private String appCountry public Builder card String card this card card return this public Builder image String image this image image return this public Builder site String site this site site return this public Builder description String description this description description return this public Builder cardData String data this cardData data return this public Builder callToAction String callToAction this callToAction callToAction return this public Builder ctaKey String ctaKey this ctaKey ctaKey return this public Builder deviceId String deviceId this deviceId deviceId return this public Builder appIPhoneId String appIPhoneId this appIPhoneId appIPhoneId return this public Builder appIPadId String appIPadId this appIPadId appIPadId return this public Builder appGooglePlayId String appGooglePlayId this appGooglePlayId appGooglePlayId return this public Builder appCountry String appCountry this appCountry appCountry return this public CardData build return new CardData card image site description cardData callToAction ctaKey deviceId appIPhoneId appIPadId appGooglePlayId appCountrypackage com twitter sdk android tweetcomposer import com twitter sdk android tweetcomposer internal CardData class CardDataFactory static final String APP CARD TYPE promo image app static final String APP CARD CTA KEY open private static final String MEDIA SCHEME media static CardData createAppCardData Card card Long mediaId String advertisingId return new CardData Builder card APP CARD TYPE image getCardMedia mediaId appIPhoneId card appIPhoneId appIPadId card appIPadId appGooglePlayId card appGooglePlayId cardData ctaKey APP CARD CTA KEY deviceId advertisingId build static String getCardMedia Long mediaId return MEDIA SCHEME Long toString mediaIdpackage com twitter sdk android tweetcomposer internal import retrofit2 Call import retrofit2 http Field import retrofit2 http FormUrlEncoded import retrofit2 http POST public interface CardService FormUrlEncoded POST https caps twitter com v2 cards create json Call CardCreate create Field card data CardData datapackage com twitter sdk android tweetcomposer import android content Context import android view View class CardViewFactory View createCard Context context Card card if card cardType equals Card APP CARD TYPE final AppCardView cardView new AppCardView context cardView setCard card return cardView return nullpackage hudson util import java util Comparator import java io Serializable public final class CaseInsensitiveComparator implements Comparator String Serializable public static final Comparator String INSTANCE new CaseInsensitiveComparator private CaseInsensitiveComparator public int compare String lhs String rhs return lhs compareToIgnoreCase rhs private static final long serialVersionUID 1Lpackage jenkins model item category import org kohsuke accmod Restricted import org kohsuke accmod restrictions NoExternalUse import org kohsuke stapler HttpResponse import org kohsuke stapler StaplerRequest import org kohsuke stapler StaplerResponse import org kohsuke stapler export Exported import org kohsuke stapler export ExportedBean import org kohsuke stapler export Flavor import javax annotation CheckForNull import javax annotation Nonnull import javax servlet ServletException import java io IOException import java io Serializable import java util ArrayList import java util List ExportedBean Restricted NoExternalUse class public class Categories implements HttpResponse Serializable private List Category items public Categories items new ArrayList Category Exported name categories public List Category getItems return items Override public void generateResponse StaplerRequest req StaplerResponse rsp Object node throws IOException ServletException rsp serveExposedBean req this Flavor JSON CheckForNull public Category getItem Nonnull String id for Category category items if category getId equals id return category return nullpackage jenkins model item category import hudson model TopLevelItem import org kohsuke accmod Restricted import org kohsuke accmod restrictions NoExternalUse import org kohsuke stapler export Exported import org kohsuke stapler export ExportedBean import java io Serializable import java util List import java util Map ExportedBean Restricted NoExternalUse class public class Category implements Serializable private String id private String name private String description private int order private int minToShow private List Map String Serializable items public Category String id String name String description int order int minToShow List Map String Serializable items this id id this name name this description description this order order this minToShow minToShow this items items Exported public String getId return id Exported public String getName return name Exported public String getDescription return description Exported public int getOrder return order Exported public int getMinToShow return minToShow Exported public List Map String Serializable getItems return itemspackage hudson model import java util ArrayList import java util Arrays import java util List import hudson console ModelHyperlinkNote import hudson diagnosis OldDataMonitor import hudson util XStream2 import jenkins model Jenkins import org kohsuke stapler export Exported import org kohsuke stapler export ExportedBean import com thoughtworks xstream converters UnmarshallingContext import hudson Util import java io IOException import java util HashSet import java util Objects import java util Set import javax annotation CheckForNull import javax annotation Nonnull ExportedBean public abstract class Cause Exported visibility 3 public abstract String getShortDescription public void onAddedTo Nonnull Run build if build instanceof AbstractBuild onAddedTo AbstractBuild build Deprecated public void onAddedTo AbstractBuild build if Util isOverridden Cause class getClass onAddedTo Run class onAddedTo Run build public void onLoad Nonnull Run build if build instanceof AbstractBuild onLoad AbstractBuild build void onLoad Nonnull Job job int buildNumber Run build job getBuildByNumber buildNumber if build null onLoad build Deprecated public void onLoad AbstractBuild build if Util isOverridden Cause class getClass onLoad Run class onLoad Run build public void print TaskListener listener listener getLogger println getShortDescription Deprecated public static class LegacyCodeCause extends Cause private StackTraceElement stackTrace public LegacyCodeCause stackTrace new Exception getStackTrace Override public String getShortDescription return Messages Cause LegacyCodeCause ShortDescription public static class UpstreamCause extends Cause private static final int MAX DEPTH 10 private static final int MAX LEAF 25 private String upstreamProject upstreamUrl private int upstreamBuild Deprecated private transient Cause upstreamCause private Nonnull List Cause upstreamCauses for backward bytecode compatibility Deprecated public UpstreamCause AbstractBuild up this Run up public UpstreamCause Run up upstreamBuild up getNumber upstreamProject up getParent getFullName upstreamUrl up getParent getUrl upstreamCauses new ArrayList Cause Set String traversed new HashSet String for Cause c up getCauses upstreamCauses add trim c MAX DEPTH traversed private UpstreamCause String upstreamProject int upstreamBuild String upstreamUrl Nonnull List Cause upstreamCauses this upstreamProject upstreamProject this upstreamBuild upstreamBuild this upstreamUrl upstreamUrl this upstreamCauses upstreamCauses Override public void onLoad Nonnull Job job int buildNumber Item i Jenkins getInstance getItemByFullName this upstreamProject if i null i instanceof Job cannot initialize upstream causes return Job j Job i for Cause c this upstreamCauses c onLoad j upstreamBuild Override public boolean equals Object rhs if this rhs return true if rhs instanceof UpstreamCause return false final UpstreamCause o UpstreamCause rhs return Objects equals upstreamBuild o upstreamBuild Objects equals upstreamCauses o upstreamCauses Objects equals upstreamUrl o upstreamUrl Objects equals upstreamProject o upstreamProject Override public int hashCode return Objects hash upstreamCauses upstreamBuild upstreamUrl upstreamProject private Nonnull Cause trim Nonnull Cause c int depth Set String traversed if c instanceof UpstreamCause return c UpstreamCause uc UpstreamCause c List Cause cs new ArrayList Cause if depth 0 if traversed add uc upstreamUrl uc upstreamBuild for Cause c2 uc upstreamCauses cs add trim c2 depth 1 traversed else if traversed size MAX LEAF cs add new DeeplyNestedUpstreamCause return new UpstreamCause uc upstreamProject uc upstreamBuild uc upstreamUrl cs public boolean pointsTo Job j return j getFullName equals upstreamProject public boolean pointsTo Run r return r getNumber upstreamBuild pointsTo r getParent Exported visibility 3 public String getUpstreamProject return upstreamProject Exported visibility 3 public int getUpstreamBuild return upstreamBuild public CheckForNull Run getUpstreamRun Job job Jenkins getInstance getItemByFullName upstreamProject Job class return job null job getBuildByNumber upstreamBuild null Exported visibility 3 public String getUpstreamUrl return upstreamUrl public List Cause getUpstreamCauses return upstreamCauses Override public String getShortDescription return Messages Cause UpstreamCause ShortDescription upstreamProject upstreamBuild Override public void print TaskListener listener print listener 0 private void indent TaskListener listener int depth for int i 0 i depth i listener getLogger print private void print TaskListener listener int depth indent listener depth listener getLogger println Messages Cause UpstreamCause ShortDescription ModelHyperlinkNote encodeTo upstreamUrl upstreamProject ModelHyperlinkNote encodeTo upstreamUrl upstreamBuild Integer toString upstreamBuild if upstreamCauses null upstreamCauses isEmpty indent listener depth listener getLogger println Messages Cause UpstreamCause CausedBy for Cause cause upstreamCauses if cause instanceof UpstreamCause UpstreamCause cause print listener depth 1 else indent listener depth 1 cause print listener Override public String toString return upstreamUrl upstreamBuild upstreamCauses public static class ConverterImpl extends XStream2 PassthruConverter UpstreamCause public ConverterImpl XStream2 xstream super xstream Override protected void callback UpstreamCause uc UnmarshallingContext context if uc upstreamCause null if uc upstreamCauses null uc upstreamCauses new ArrayList Cause uc upstreamCauses add uc upstreamCause uc upstreamCause null OldDataMonitor report context 1 288 public static class DeeplyNestedUpstreamCause extends Cause Override public String getShortDescription return deeply nested causes Override public String toString return JENKINS 14814 Override public void onLoad Nonnull Job job int buildNumber Deprecated public static class UserCause extends Cause private String authenticationName public UserCause this authenticationName Jenkins getAuthentication getName Exported visibility 3 public String getUserName return User get authenticationName getDisplayName Override public String getShortDescription return Messages Cause UserCause ShortDescription authenticationName Override public boolean equals Object o return o instanceof UserCause Arrays equals new Object authenticationName new Object UserCause o authenticationName Override public int hashCode return 295 this authenticationName null this authenticationName hashCode 0 public static class UserIdCause extends Cause private String userId public UserIdCause User user User current this userId user null null user getId Exported visibility 3 public String getUserId return userId Exported visibility 3 public String getUserName return userId null anonymous User get userId getDisplayName Override public String getShortDescription return Messages Cause UserIdCause ShortDescription getUserName Override public void print TaskListener listener listener getLogger println Messages Cause UserIdCause ShortDescription TODO better to use ModelHyperlinkNote encodeTo User or User getUrl since it handles URL escaping ModelHyperlinkNote encodeTo user getUserId getUserName Override public boolean equals Object o return o instanceof UserIdCause Objects equals userId UserIdCause o userId Override public int hashCode return Objects hash userId public static class RemoteCause extends Cause private String addr private String note public RemoteCause String host String note this addr host this note note Override public String getShortDescription if note null try return Messages Cause RemoteCause ShortDescriptionWithNote addr Jenkins getInstance getMarkupFormatter translate note catch IOException x ignore return Messages Cause RemoteCause ShortDescription addr Exported visibility 3 public String getAddr return addr Exported visibility 3 public String getNote return note Override public boolean equals Object o return o instanceof RemoteCause Objects equals addr RemoteCause o addr Objects equals note RemoteCause o note Override public int hashCode return Objects hash addr notepackage hudson model import hudson diagnosis OldDataMonitor import hudson model Queue Task import hudson model queue FoldableAction import hudson util XStream2 import org kohsuke stapler export Exported import org kohsuke stapler export ExportedBean import com thoughtworks xstream converters UnmarshallingContext import java util ArrayList import java util Arrays import java util Collection import java util Collections import java util LinkedHashMap import java util List import java util Map import jenkins model RunAction2 ExportedBean public class CauseAction implements FoldableAction RunAction2 Deprecated there can be multiple causes so this is deprecated private transient Cause cause Deprecated private transient List Cause causes private Map Cause Integer causeBag new LinkedHashMap public CauseAction Cause c this causeBag put c 1 private void addCause Cause c synchronized causeBag Integer cnt causeBag get c causeBag put c cnt null 1 cnt 1 private void addCauses Collection extends Cause causes for Cause cause causes addCause cause public CauseAction Cause c this Arrays asList c public CauseAction Collection extends Cause causes addCauses causes public CauseAction CauseAction ca addCauses ca getCauses Exported visibility 2 public List Cause getCauses List Cause r new ArrayList for Map Entry Cause Integer entry causeBag entrySet r addAll Collections nCopies entry getValue entry getKey return Collections unmodifiableList r public T extends Cause T findCause Class T type for Cause c causeBag keySet if type isInstance c return type cast c return null public String getDisplayName return Cause public String getIconFileName no icon return null public String getUrlName return cause public Map Cause Integer getCauseCounts return Collections unmodifiableMap causeBag Deprecated public String getShortDescription if causeBag isEmpty return N A return causeBag keySet iterator next getShortDescription Override public void onLoad Run owner for Cause c causeBag keySet if c null c onLoad owner Override public void onAttached Run owner for Cause c causeBag keySet if c null c onAddedTo owner public void foldIntoExisting hudson model Queue Item item Task owner List Action otherActions CauseAction existing item getAction CauseAction class if existing null existing addCauses getCauses return no CauseAction found so add a copy of this one item addAction new CauseAction this public static class ConverterImpl extends XStream2 PassthruConverter CauseAction public ConverterImpl XStream2 xstream super xstream Override protected void callback CauseAction ca UnmarshallingContext context if we are being read in from an older version if ca cause null if ca causeBag null ca causeBag new LinkedHashMap ca addCause ca cause OldDataMonitor report context 1 288 ca cause null else if ca causes null if ca causeBag null ca causeBag new LinkedHashMap ca addCauses ca causes OldDataMonitor report context 1 653 ca causes nullpackage hudson model queue import hudson console ModelHyperlinkNote import hudson model Queue Task import hudson model Node import hudson model Messages import hudson model Label import hudson model TaskListener import hudson slaves Cloud import org jvnet localizer Localizable public abstract class CauseOfBlockage public abstract String getShortDescription public void print TaskListener listener listener getLogger println getShortDescription public static CauseOfBlockage fromMessage final Localizable l return new CauseOfBlockage public String getShortDescription return l toString Override public String toString return getShortDescription interface NeedsMoreExecutor public static CauseOfBlockage createNeedsMoreExecutor Localizable l return new NeedsMoreExecutorImpl l private static final class NeedsMoreExecutorImpl extends CauseOfBlockage implements NeedsMoreExecutor private final Localizable l private NeedsMoreExecutorImpl Localizable l this l l public String getShortDescription return l toString public static final class BecauseNodeIsOffline extends CauseOfBlockage implements NeedsMoreExecutor public final Node node public BecauseNodeIsOffline Node node this node node public String getShortDescription String name node toComputer null node toComputer getDisplayName node getDisplayName return Messages Queue NodeOffline name Override public void print TaskListener listener listener getLogger println Messages Queue NodeOffline ModelHyperlinkNote encodeTo node public static final class BecauseLabelIsOffline extends CauseOfBlockage implements NeedsMoreExecutor public final Label label public BecauseLabelIsOffline Label l this label l public String getShortDescription if label isEmpty return Messages Queue LabelHasNoNodes label getName else return Messages Queue AllNodesOffline label getName public static final class BecauseNodeIsBusy extends CauseOfBlockage implements NeedsMoreExecutor public final Node node public BecauseNodeIsBusy Node node this node node public String getShortDescription String name node toComputer null node toComputer getDisplayName node getDisplayName return Messages Queue WaitingForNextAvailableExecutorOn name Override public void print TaskListener listener listener getLogger println Messages Queue WaitingForNextAvailableExecutorOn ModelHyperlinkNote encodeTo node public static final class BecauseLabelIsBusy extends CauseOfBlockage implements NeedsMoreExecutor public final Label label public BecauseLabelIsBusy Label label this label label public String getShortDescription return Messages Queue WaitingForNextAvailableExecutorOn label getNamepackage jenkins model import hudson console ModelHyperlinkNote import hudson model Executor import hudson model TaskListener import hudson model User import org kohsuke stapler export Exported import org kohsuke stapler export ExportedBean import java io Serializable import java util Collections import javax annotation CheckForNull ExportedBean public abstract class CauseOfInterruption implements Serializable Exported public abstract String getShortDescription public void print TaskListener listener listener getLogger println getShortDescription public static final class UserInterruption extends CauseOfInterruption private final String user public UserInterruption User user this user user getId public UserInterruption String userId this user userId CheckForNull public User getUser return User get user false Collections emptyMap public String getShortDescription return Messages CauseOfInterruption ShortDescription user Override public void print TaskListener listener final User userInstance getUser listener getLogger println Messages CauseOfInterruption ShortDescription userInstance null ModelHyperlinkNote encodeTo userInstance user Override public boolean equals Object o if o null getClass o getClass return false UserInterruption that UserInterruption o return user equals that user Override public int hashCode return user hashCode private static final long serialVersionUID 1L private static final long serialVersionUID 1Lpackage hudson security import java io IOException import java util Arrays import java util Collection import java util logging Level import java util logging Logger import javax servlet Filter import javax servlet FilterChain import javax servlet FilterConfig import javax servlet ServletException import javax servlet ServletRequest import javax servlet ServletResponse public class ChainedServletFilter implements Filter array is assumed to be immutable once set protected volatile Filter filters public ChainedServletFilter filters new Filter 0 public ChainedServletFilter Filter filters this Arrays asList filters public ChainedServletFilter Collection extends Filter filters setFilters filters public void setFilters Collection extends Filter filters this filters filters toArray new Filter filters size public void init FilterConfig filterConfig throws ServletException if LOGGER isLoggable Level FINEST for Filter f filters LOGGER finest ChainedServletFilter contains f for Filter f filters f init filterConfig public void doFilter ServletRequest request ServletResponse response final FilterChain chain throws IOException ServletException LOGGER entering ChainedServletFilter class getName doFilter new FilterChain private int position 0 capture the array for thread safety private final Filter filters ChainedServletFilter this filters public void doFilter ServletRequest request ServletResponse response throws IOException ServletException if position filters length reached to the end chain doFilter request response else call next filters position doFilter request response this doFilter request response public void destroy for Filter f filters f destroy private static final Logger LOGGER Logger getLogger ChainedServletFilter class getNamepackage hudson scm import hudson Extension import hudson ExtensionList import hudson ExtensionListView import hudson ExtensionPoint import hudson MarkupText import hudson Util import hudson model AbstractBuild import hudson model Run import hudson scm ChangeLogSet Entry import hudson util CopyOnWriteList import java util logging Level import java util logging Logger public abstract class ChangeLogAnnotator implements ExtensionPoint public void annotate Run build Entry change MarkupText text if build instanceof AbstractBuild Util isOverridden ChangeLogAnnotator class getClass annotate AbstractBuild class Entry class MarkupText class annotate AbstractBuild build change text else Logger getLogger ChangeLogAnnotator class getName log Level WARNING You must override the newer overload of annotate from 0 getClass getName Deprecated public void annotate AbstractBuild build Entry change MarkupText text annotate Run build change text Deprecated public final void register all add this public final boolean unregister return all remove this Deprecated public static final CopyOnWriteList ChangeLogAnnotator annotators ExtensionListView createCopyOnWriteList ChangeLogAnnotator class public static ExtensionList ChangeLogAnnotator all return ExtensionList lookup ChangeLogAnnotator classpackage hudson scm import hudson Util import hudson model AbstractBuild import hudson model Run import hudson scm ChangeLogSet Entry import java io File import java io IOException import org xml sax SAXException public abstract class ChangeLogParser public ChangeLogSet extends Entry parse Run build RepositoryBrowser browser File changelogFile throws IOException SAXException if build instanceof AbstractBuild Util isOverridden ChangeLogParser class getClass parse AbstractBuild class File class return parse AbstractBuild build changelogFile else throw new AbstractMethodError You must override the newer overload of parse Deprecated public ChangeLogSet extends Entry parse AbstractBuild build File changelogFile throws IOException SAXException return parse Run build build getProject getScm getEffectiveBrowser changelogFilepackage hudson scm import hudson MarkupText import hudson Util import hudson model AbstractBuild import hudson model Run import hudson model User import org kohsuke stapler export Exported import org kohsuke stapler export ExportedBean import java util ArrayList import java util Collection import java util Date import java util Iterator import java util List import java util logging Logger ExportedBean defaultVisibility 999 public abstract class ChangeLogSet T extends ChangeLogSet Entry implements Iterable T private final Run run Deprecated public final AbstractBuild build private final RepositoryBrowser browser protected ChangeLogSet Run run RepositoryBrowser browser this run run build run instanceof AbstractBuild AbstractBuild run null this browser browser Deprecated protected ChangeLogSet AbstractBuild build this Run build browserFromBuild build private static RepositoryBrowser browserFromBuild AbstractBuild build if build null not generally allowed but sometimes done in unit tests return null return build getParent getScm getEffectiveBrowser public Run getRun return run public RepositoryBrowser getBrowser return browser public abstract boolean isEmptySet method for the remote API Exported public final Object getItems List T r new ArrayList T for T t this r add t return r toArray Exported public String getKind return null public static ChangeLogSet extends ChangeLogSet Entry createEmpty Run build return new EmptyChangeLogSet build Deprecated public static ChangeLogSet extends ChangeLogSet Entry createEmpty AbstractBuild build return createEmpty Run build ExportedBean defaultVisibility 999 public static abstract class Entry private ChangeLogSet parent public ChangeLogSet getParent return parent protected void setParent ChangeLogSet parent this parent parent Exported public String getCommitId return null Exported public long getTimestamp return 1 Exported public abstract String getMsg Exported public abstract User getAuthor Exported public abstract Collection String getAffectedPaths public Collection extends AffectedFile getAffectedFiles String scm this SCM ChangeLogSet parent getParent if null parent String kind parent getKind if null kind kind trim length 0 scm kind throw new UnsupportedOperationException getAffectedFiles is not implemented by scm public String getMsgAnnotated MarkupText markup new MarkupText getMsg for ChangeLogAnnotator a ChangeLogAnnotator all try a annotate parent run this markup catch Exception e LOGGER info ChangeLogAnnotator a toString failed to annotate message getMsg e getMessage catch Error e LOGGER severe ChangeLogAnnotator a toString failed to annotate message getMsg e getMessage return markup toString false public String getMsgEscaped return Util escape getMsg static final Logger LOGGER Logger getLogger ChangeLogSet Entry class getName public interface AffectedFile String getPath EditType getEditTypepackage com kaku colorfulnews event public class ChannelChangeEventpackage jenkins security import hudson ExtensionList import hudson ExtensionPoint import hudson remoting Channel import hudson remoting ChannelBuilder import hudson slaves SlaveComputer import jenkins model Jenkins import javax annotation Nullable public abstract class ChannelConfigurator implements ExtensionPoint public void onChannelBuilding ChannelBuilder builder Nullable Object context public static ExtensionList ChannelConfigurator all return Jenkins getInstance getExtensionList ChannelConfigurator classpackage com kaku colorfulnews event public class ChannelItemMoveEvent private int fromPosition private int toPosition public int getFromPosition return fromPosition public int getToPosition return toPosition public ChannelItemMoveEvent int fromPosition int toPosition this fromPosition fromPosition this toPosition toPositionpackage hudson slaves import hudson Extension import hudson FilePath import jenkins util SystemProperties import hudson model Computer import hudson model Slave import hudson model TaskListener import hudson remoting Channel import hudson remoting PingThread import jenkins security MasterToSlaveCallable import jenkins slaves PingFailureAnalyzer import java io IOException import java util concurrent atomic AtomicBoolean import java util logging Logger import static java util logging Level Extension public class ChannelPinger extends ComputerListener private static final Logger LOGGER Logger getLogger ChannelPinger class getName private static final String SYS PROPERTY NAME ChannelPinger class getName pingInterval private static final int DEFAULT PING INTERVAL MIN 5 private final int pingInterval public ChannelPinger pingInterval SystemProperties getInteger SYS PROPERTY NAME DEFAULT PING INTERVAL MIN Override public void preOnline Computer c Channel channel FilePath root TaskListener listener install channel public void install Channel channel if pingInterval 1 LOGGER fine Agent ping is disabled return try channel call new SetUpRemotePing pingInterval LOGGER fine Set up a remote ping for channel getName catch Exception e LOGGER severe Failed to set up a ping for channel getName set up ping from both directions so that in case of a router dropping a connection both sides can notice it and take compensation actions setUpPingForChannel channel pingInterval true private static class SetUpRemotePing extends MasterToSlaveCallable Void IOException private static final long serialVersionUID 2702219700841759872L private int pingInterval public SetUpRemotePing int pingInterval this pingInterval pingInterval public Void call throws IOException setUpPingForChannel Channel current pingInterval false return null private static void setUpPingForChannel final Channel channel int interval final boolean analysis LOGGER log FINE setting up ping on 0 at interval 1 m new Object channel getName interval final AtomicBoolean isInClosed new AtomicBoolean false final PingThread t new PingThread channel interval 60 1000 Override protected void onDead Throwable cause try if analysis analyze cause if isInClosed get LOGGER log FINE Ping failed after the channel channel getName is already partially closed cause else LOGGER log INFO Ping failed Terminating the channel channel getName cause channel close cause catch IOException e LOGGER log SEVERE Failed to terminate the channel channel getName e private void analyze Throwable cause throws IOException for PingFailureAnalyzer pfa PingFailureAnalyzer all pfa onPingFailure channel cause Deprecated Override protected void onDead onDead null channel addListener new Channel Listener Override public void onClosed Channel channel IOException cause LOGGER fine Terminating ping thread for channel getName isInClosed set true t interrupt make sure the ping thread is terminated t start LOGGER fine Ping thread started for channel with a interval minute intervalpackage hudson slaves import hudson Launcher LocalLauncher import hudson Proc import hudson FilePath import hudson model Computer import hudson model TaskListener import hudson remoting Channel import hudson remoting ChannelBuilder import hudson remoting CommandTransport import hudson remoting Launcher import hudson remoting SocketChannelStream import hudson util ClasspathBuilder import hudson util JVMBuilder import hudson util StreamCopyThread import jenkins security ChannelConfigurator import java io BufferedInputStream import java io BufferedOutputStream import java io IOError import java io IOException import java io InputStream import java io OutputStream import java net InetSocketAddress import java net ServerSocket import java net Socket import java util Map import java util concurrent ExecutorService import java util logging Level import java util logging Logger public class Channels Deprecated public static Channel forProcess String name ExecutorService execService InputStream in OutputStream out Proc proc throws IOException return forProcess name execService in out null proc public static Channel forProcess String name ExecutorService execService InputStream in OutputStream out OutputStream header final Proc proc throws IOException ChannelBuilder cb new ChannelBuilder name execService Override public Channel build CommandTransport transport throws IOException return new Channel this transport Override public synchronized void terminate IOException e super terminate e try proc kill catch IOException x we are already in the error recovery mode so just record it and move on LOGGER log Level INFO Failed to terminate the severed connection x catch InterruptedException x process the interrupt later Thread currentThread interrupt Override public synchronized void join throws InterruptedException super join wait for the child process to complete too try proc join catch IOException e throw new IOError e cb withHeaderStream header for ChannelConfigurator cc ChannelConfigurator all cc onChannelBuilding cb null TODO what to pass as a context return cb build in out public static Channel forProcess String name ExecutorService execService final Process proc OutputStream header throws IOException final Thread thread new StreamCopyThread name stderr proc getErrorStream header thread start ChannelBuilder cb new ChannelBuilder name execService Override public Channel build CommandTransport transport throws IOException return new Channel this transport Override public synchronized void terminate IOException e super terminate e proc destroy the stderr copier should exit by itself Override public synchronized void join throws InterruptedException super join wait for the child process to complete too proc waitFor thread join cb withHeaderStream header for ChannelConfigurator cc ChannelConfigurator all cc onChannelBuilding cb null TODO what to pass as a context return cb build proc getInputStream proc getOutputStream public static Channel newJVM String displayName TaskListener listener FilePath workDir ClasspathBuilder classpath Map String String systemProperties throws IOException JVMBuilder vmb new JVMBuilder vmb systemProperties systemProperties return newJVM displayName listener vmb workDir classpath public static Channel newJVM String displayName TaskListener listener JVMBuilder vmb FilePath workDir ClasspathBuilder classpath throws IOException ServerSocket serverSocket new ServerSocket serverSocket bind new InetSocketAddress localhost 0 serverSocket setSoTimeout 10 1000 use cp FQCN instead of jar since remoting jar can be rebundled like in the case of the swarm plugin vmb classpath addJarOf Channel class vmb mainClass Launcher class if classpath null vmb args add cp add classpath vmb args add connectTo localhost serverSocket getLocalPort listener getLogger println Starting displayName Proc p vmb launch new LocalLauncher listener stdout listener pwd workDir start Socket s serverSocket accept serverSocket close return forProcess Channel to displayName Computer threadPoolForRemoting new BufferedInputStream SocketChannelStream in s new BufferedOutputStream SocketChannelStream out s null p private static final Logger LOGGER Logger getLogger Channels class getNamepackage hudson util import jenkins util SystemProperties import java io IOException import java util logging Level import java util logging Logger import javax servlet Filter import javax servlet FilterChain import javax servlet FilterConfig import javax servlet ServletException import javax servlet ServletRequest import javax servlet ServletResponse import javax servlet http HttpServletRequest public class CharacterEncodingFilter implements Filter private static final String ENCODING UTF 8 private static final Boolean DISABLE FILTER SystemProperties getBoolean CharacterEncodingFilter class getName disableFilter private static final Boolean FORCE ENCODING SystemProperties getBoolean CharacterEncodingFilter class getName forceEncoding public void init FilterConfig filterConfig throws ServletException LOGGER log Level FINE CharacterEncodingFilter initialized DISABLE FILTER 0 FORCE ENCODING 1 new Object DISABLE FILTER FORCE ENCODING public void destroy LOGGER fine CharacterEncodingFilter destroyed public void doFilter ServletRequest request ServletResponse response FilterChain chain throws IOException ServletException if DISABLE FILTER if request instanceof HttpServletRequest HttpServletRequest req HttpServletRequest request if shouldSetCharacterEncoding req req setCharacterEncoding ENCODING chain doFilter request response private boolean shouldSetCharacterEncoding HttpServletRequest req String method req getMethod if POST equalsIgnoreCase method return false containers often implement RFCs incorrectly in that it doesn t interpret query parameter decoding with UTF 8 This will ensure we get it right but doing this for config xml submission could potentiall overwrite valid text xml charset xxx String contentType req getContentType if contentType null boolean isXmlSubmission contentType startsWith application xml contentType startsWith text xml if isXmlSubmission return false if FORCE ENCODING req getCharacterEncoding null return true return false private static final Logger LOGGER Logger getLogger CharacterEncodingFilter class getNamepackage hudson util import java io IOException import java io Writer import java util LinkedList import java util List Deprecated public final class CharSpool extends Writer private List char buf private char last new char 1024 private int pos public void write char cbuf int off int len while len 0 int sz Math min last length pos len System arraycopy cbuf off last pos sz len sz off sz pos sz renew private void renew if pos last length return if buf null buf new LinkedList char buf add last last new char 1024 pos 0 public void write int c renew last pos char c public void flush noop public void close noop public void writeTo Writer w throws IOException if buf null for char cb buf w write cb w write last 0 pospackage hudson util import edu umd cs findbugs annotations SuppressFBWarnings import hudson model AbstractBuild import hudson model Run import org jfree chart JFreeChart import org jfree chart axis NumberAxis import org jfree data category CategoryDataset import org kohsuke stapler StaplerRequest import org kohsuke stapler StaplerResponse import java awt Font import java io IOException public class ChartUtil public static final class NumberOnlyBuildLabel implements Comparable NumberOnlyBuildLabel private final Run run Deprecated public final AbstractBuild build public NumberOnlyBuildLabel Run run this run run this build run instanceof AbstractBuild AbstractBuild run null Deprecated public NumberOnlyBuildLabel AbstractBuild build this run build this build build public Run getRun return run public int compareTo NumberOnlyBuildLabel that return this run number that run number Override public boolean equals Object o if o instanceof NumberOnlyBuildLabel return false NumberOnlyBuildLabel that NumberOnlyBuildLabel o return run that run Override public int hashCode return run hashCode Override public String toString return run getDisplayName Deprecated public static boolean awtProblem false TODO prevent usage of this APIs in plugins Needs to be deprecated and replaced by a getter method SuppressFBWarnings value MS SHOULD BE REFACTORED TO BE FINAL justification It s actually being widely used by plugins Obsolete approach should be ideally replaced by Getter public static Throwable awtProblemCause null Deprecated public static void generateGraph StaplerRequest req StaplerResponse rsp JFreeChart chart Area defaultSize throws IOException generateGraph req rsp chart defaultSize width defaultSize height Deprecated public static void generateGraph StaplerRequest req StaplerResponse rsp final JFreeChart chart int defaultW int defaultH throws IOException new Graph 1 defaultW defaultH protected JFreeChart createGraph return chart doPng req rsp Deprecated public static void generateClickableMap StaplerRequest req StaplerResponse rsp JFreeChart chart Area defaultSize throws IOException generateClickableMap req rsp chart defaultSize width defaultSize height Deprecated public static void generateClickableMap StaplerRequest req StaplerResponse rsp final JFreeChart chart int defaultW int defaultH throws IOException new Graph 1 defaultW defaultH protected JFreeChart createGraph return chart doMap req rsp public static void adjustChebyshev CategoryDataset dataset NumberAxis yAxis first compute E X and Var X double sum 0 sum2 0 final int nColumns dataset getColumnCount final int nRows dataset getRowCount for int i 0 i nRows i Comparable rowKey dataset getRowKey i for int j 0 j nColumns j Comparable columnKey dataset getColumnKey j double n dataset getValue rowKey columnKey doubleValue sum n sum2 n n double average sum nColumns nRows double stddev Math sqrt sum2 nColumns nRows average average double rangeMin average stddev CHEBYSHEV N double rangeMax average stddev CHEBYSHEV N now see if there are any data points that fall outside rangeMin rangeMax boolean found false double min 0 max 0 for int i 0 i nRows i Comparable rowKey dataset getRowKey i for int j 0 j nColumns j Comparable columnKey dataset getColumnKey j double n dataset getValue rowKey columnKey doubleValue if n rangeMin rangeMax n found true continue ignore this value min Math min min n max Math max max n if found return no adjustment was necessary some values fell outside the range so adjust the Y axis if we are ever to extend this method to handle negative value ranges correctly the code after this needs modifications min Math min 0 min always include 0 in the graph max yAxis getUpperMargin max min yAxis setRange min max public static double CHEBYSHEV N 3 static try new Font SansSerif Font BOLD 18 toString catch Throwable t awtProblemCause t awtProblem truepackage hudson model import hudson tasks BuildStep import hudson tasks Recorder import hudson tasks Builder import hudson scm SCM import javax annotation Nonnull public final class CheckPoint private final Object identity private final String internalName public CheckPoint String internalName Object identity this internalName internalName this identity identity public CheckPoint String internalName this internalName new Object Override public boolean equals Object that if that null getClass that getClass return false return identity CheckPoint that identity Override public int hashCode return identity hashCode Override public String toString return Check point internalName public void report Run reportCheckpoint this public void block throws InterruptedException Run waitForCheckpoint this null null public void block Nonnull BuildListener listener Nonnull String waiter throws InterruptedException Run waitForCheckpoint this listener waiter public static final CheckPoint CULPRITS DETERMINED new CheckPoint CULPRITS DETERMINED public static final CheckPoint COMPLETED new CheckPoint COMPLETED public static final CheckPoint MAIN COMPLETED new CheckPoint MAIN COMPLETEDpackage hudson model import hudson util FormValidation import org jenkinsci Symbol import org kohsuke stapler QueryParameter import org kohsuke stapler StaplerRequest import org kohsuke stapler DataBoundConstructor import org kohsuke stapler export Exported import org apache commons lang StringUtils import net sf json JSONObject import hudson Extension import java util ArrayList import java util List import java util Arrays public class ChoiceParameterDefinition extends SimpleParameterDefinition public static final String CHOICES DELIMITER r n Deprecated public static final String CHOICES DELIMETER CHOICES DELIMITER private final List String choices private final String defaultValue public static boolean areValidChoices String choices String strippedChoices choices trim return StringUtils isEmpty strippedChoices strippedChoices split CHOICES DELIMITER length 0 DataBoundConstructor public ChoiceParameterDefinition String name String choices String description super name description this choices Arrays asList choices split CHOICES DELIMITER defaultValue null public ChoiceParameterDefinition String name String choices String description super name description this choices new ArrayList String Arrays asList choices defaultValue null private ChoiceParameterDefinition String name List String choices String defaultValue String description super name description this choices choices this defaultValue defaultValue Override public ParameterDefinition copyWithDefaultValue ParameterValue defaultValue if defaultValue instanceof StringParameterValue StringParameterValue value StringParameterValue defaultValue return new ChoiceParameterDefinition getName choices value value getDescription else return this Exported public List String getChoices return choices public String getChoicesText return StringUtils join choices n Override public StringParameterValue getDefaultParameterValue return new StringParameterValue getName defaultValue null choices get 0 defaultValue getDescription private StringParameterValue checkValue StringParameterValue value if choices contains value value throw new IllegalArgumentException Illegal choice for parameter getName value value return value Override public ParameterValue createValue StaplerRequest req JSONObject jo StringParameterValue value req bindJSON StringParameterValue class jo value setDescription getDescription return checkValue value public StringParameterValue createValue String value return checkValue new StringParameterValue getName value getDescription Extension Symbol choice choiceParam public static class DescriptorImpl extends ParameterDescriptor Override public String getDisplayName return Messages ChoiceParameterDefinition DisplayName Override public String getHelpFile return help parameter choice html public FormValidation doCheckChoices QueryParameter String value if ChoiceParameterDefinition areValidChoices value return FormValidation ok else return FormValidation error Messages ChoiceParameterDefinition MissingChoicespackage hudson util import java io ByteArrayOutputStream import java io IOException import java io InputStream import java util logging Logger public class ChunkedInputStream extends InputStream private InputStream in private int chunkSize private int pos private boolean bof true private boolean eof false private boolean closed false private static final Logger LOGGER Logger getLogger ChunkedInputStream class getName public ChunkedInputStream final InputStream in throws IOException if in null throw new IllegalArgumentException InputStream parameter may not be null this in in this pos 0 public int read throws IOException if closed throw new IOException Attempted read from closed stream if eof return 1 if pos chunkSize nextChunk if eof return 1 pos return in read Override public int read byte b int off int len throws IOException if closed throw new IOException Attempted read from closed stream if eof return 1 if pos chunkSize nextChunk if eof return 1 len Math min len chunkSize pos int count in read b off len pos count return count Override public int read byte b throws IOException return read b 0 b length private void readCRLF throws IOException int cr in read int lf in read if cr r lf n throw new IOException CRLF expected at end of chunk cr lf private void nextChunk throws IOException if bof readCRLF chunkSize getChunkSizeFromInputStream in bof false pos 0 if chunkSize 0 eof true parseTrailerHeaders private static int getChunkSizeFromInputStream final InputStream in throws IOException ByteArrayOutputStream baos new ByteArrayOutputStream States 0 normal 1 r was scanned 2 inside quoted string 1 end int state 0 while state 1 int b in read if b 1 throw new IOException chunked stream ended unexpectedly switch state case 0 switch b case r state 1 break case state 2 default baos write b break case 1 if b n state 1 else this was not CRLF throw new IOException Protocol violation Unexpected single newline character in chunk size break case 2 switch b case b in read baos write b break case state 0 default baos write b break default throw new RuntimeException assertion failed parse data String dataString new String baos toByteArray US ASCII int separator dataString indexOf dataString separator 0 dataString substring 0 separator trim dataString trim int result try result Integer parseInt dataString trim 16 catch NumberFormatException e throw new IOException Bad chunk size dataString return result private void parseTrailerHeaders throws IOException I feel lazy No trailing header support readCRLF Header footers null try String charset US ASCII if this method null charset this method getParams getHttpElementCharset footers HttpParser parseHeaders in charset catch HttpException e LOG error Error parsing trailer headers e IOException ioe new IOException e getMessage ExceptionUtil initCause ioe e throw ioe if this method null for int i 0 i footers length i this method addResponseFooter footers i Override public void close throws IOException if closed try if eof exhaustInputStream this finally eof true closed true static void exhaustInputStream InputStream inStream throws IOException read and discard the remainder of the message byte buffer new byte 1024 while inStream read buffer 0package hudson util import java io IOException import java io OutputStream public class ChunkedOutputStream extends OutputStream Static Variables private static final byte CRLF new byte byte 13 byte 10 private static final byte ENDCHUNK CRLF private static final byte ZERO new byte byte 0 Instance Variables private OutputStream stream null private byte cache private int cachePosition 0 private boolean wroteLastChunk false Constructors public ChunkedOutputStream OutputStream stream int bufferSize throws IOException this cache new byte bufferSize this stream stream public ChunkedOutputStream OutputStream stream throws IOException this stream 2048 Internal methods protected void flushCache throws IOException if cachePosition 0 byte chunkHeader Integer toHexString cachePosition r n getBytes US ASCII stream write chunkHeader 0 chunkHeader length stream write cache 0 cachePosition stream write ENDCHUNK 0 ENDCHUNK length cachePosition 0 protected void flushCacheWithAppend byte bufferToAppend int off int len throws IOException byte chunkHeader Integer toHexString cachePosition len r n getBytes US ASCII stream write chunkHeader 0 chunkHeader length stream write cache 0 cachePosition stream write bufferToAppend off len stream write ENDCHUNK 0 ENDCHUNK length cachePosition 0 protected void writeClosingChunk throws IOException Write the final chunk stream write ZERO 0 ZERO length stream write CRLF 0 CRLF length stream write ENDCHUNK 0 ENDCHUNK length Public Methods public void finish throws IOException if wroteLastChunk flushCache writeClosingChunk wroteLastChunk true OutputStream Methods public void write int b throws IOException cache cachePosition byte b cachePosition if cachePosition cache length flushCache Override public void write byte b throws IOException this write b 0 b length Override public void write byte src int off int len throws IOException if len cache length cachePosition flushCacheWithAppend src off len else System arraycopy src off cache cachePosition len cachePosition len Override public void flush throws IOException flushCache Kohsuke flush should flush the cache stream flush Override public void close throws IOException finish super closepackage hudson import jenkins util SystemProperties import com google common collect Lists import hudson Plugin DummyImpl import hudson PluginWrapper Dependency import hudson model Hudson import jenkins util AntClassLoader import hudson util CyclicGraphDetector import hudson util CyclicGraphDetector CycleDetectedException import hudson util IOUtils import hudson util MaskingClassLoader import hudson util VersionNumber import jenkins ClassLoaderReflectionToolkit import jenkins ExtensionFilter import org apache commons io output NullOutputStream import org apache tools ant BuildException import org apache tools ant Project import org apache tools ant taskdefs Expand import org apache tools ant taskdefs Zip import org apache tools ant types FileSet import org apache tools ant types PatternSet import org apache tools ant types Resource import org apache tools ant types ZipFileSet import org apache tools ant types resources MappedResourceCollection import org apache tools ant util GlobPatternMapper import org apache tools zip ZipEntry import org apache tools zip ZipExtraField import org apache tools zip ZipOutputStream import java io Closeable import java io File import java io FileInputStream import java io FilenameFilter import java io IOException import java lang reflect Field import java net URL import java util ArrayList import java util Arrays import java util Collection import java util Collections import java util Enumeration import java util HashSet import java util List import java util Set import java util Vector import java util jar Attributes import java util jar JarFile import java util jar Manifest import java util logging Level import java util logging Logger import org jenkinsci bytecode Transformer import org kohsuke accmod Restricted import org kohsuke accmod restrictions NoExternalUse import javax annotation Nonnull import static org apache commons io FilenameUtils getBaseName public class ClassicPluginStrategy implements PluginStrategy private static final FilenameFilter JAR FILTER new FilenameFilter public boolean accept File dir String name return name endsWith jar private PluginManager pluginManager private final MaskingClassLoader coreClassLoader new MaskingClassLoader getClass getClassLoader public ClassicPluginStrategy PluginManager pluginManager this pluginManager pluginManager Override public String getShortName File archive throws IOException Manifest manifest if isLinked archive manifest loadLinkedManifest archive else try JarFile jf new JarFile archive false manifest jf getManifest return PluginWrapper computeShortName manifest archive getName private static boolean isLinked File archive return archive getName endsWith hpl archive getName endsWith jpl private static Manifest loadLinkedManifest File archive throws IOException resolve the hpl file to the location of the manifest file try Locate the manifest String firstLine FileInputStream manifestHeaderInput new FileInputStream archive try firstLine IOUtils readFirstLine manifestHeaderInput UTF 8 finally manifestHeaderInput close if firstLine startsWith Manifest Version this is the manifest already else indirection archive resolve archive firstLine Read the manifest FileInputStream manifestInput new FileInputStream archive try return new Manifest manifestInput finally manifestInput close catch IOException e throw new IOException Failed to load archive e Override public PluginWrapper createPluginWrapper File archive throws IOException final Manifest manifest URL baseResourceURL null File expandDir null if hpi this is the directory where war is expanded boolean isLinked isLinked archive if isLinked manifest loadLinkedManifest archive else if archive isDirectory already expanded expandDir archive else File f pluginManager getWorkDir expandDir new File f null archive getParentFile f getBaseName archive getName explode archive expandDir File manifestFile new File expandDir PluginWrapper MANIFEST FILENAME if manifestFile exists throw new IOException Plugin installation failed No manifest at manifestFile try FileInputStream fin new FileInputStream manifestFile manifest new Manifest fin final Attributes atts manifest getMainAttributes TODO define a mechanism to hide classes String export manifest getMainAttributes getValue Export List File paths new ArrayList File if isLinked parseClassPath manifest archive paths Libraries parseClassPath manifest archive paths Class Path backward compatibility baseResourceURL resolve archive atts getValue Resource Path toURI toURL else File classes new File expandDir WEB INF classes if classes exists paths add classes File lib new File expandDir WEB INF lib File libs lib listFiles JAR FILTER if libs null paths addAll Arrays asList libs baseResourceURL expandDir toPath toUri toURL File disableFile new File archive getPath disabled if disableFile exists LOGGER info Plugin archive getName is disabled compute dependencies List PluginWrapper Dependency dependencies new ArrayList PluginWrapper Dependency List PluginWrapper Dependency optionalDependencies new ArrayList PluginWrapper Dependency String v atts getValue Plugin Dependencies if v null for String s v split PluginWrapper Dependency d new PluginWrapper Dependency s if d optional optionalDependencies add d else dependencies add d fix atts optionalDependencies Register global classpath mask This is useful for hiding JavaEE APIs that you might see from the container such as database plugin for JPA support The Mask Classes attribute is insufficient because those classes also need to be masked by all the other plugins that depend on the database plugin String masked atts getValue Global Mask Classes if masked null for String pkg masked trim split t r n coreClassLoader add pkg ClassLoader dependencyLoader new DependencyClassLoader coreClassLoader archive Util join dependencies optionalDependencies dependencyLoader getBaseClassLoader atts dependencyLoader return new PluginWrapper pluginManager archive manifest baseResourceURL createClassLoader paths dependencyLoader atts disableFile dependencies optionalDependencies private static void fix Attributes atts List PluginWrapper Dependency optionalDependencies String pluginName atts getValue Short Name String jenkinsVersion atts getValue Jenkins Version if jenkinsVersion null jenkinsVersion atts getValue Hudson Version optionalDependencies addAll getImpliedDependencies pluginName jenkinsVersion Nonnull public static List PluginWrapper Dependency getImpliedDependencies String pluginName String jenkinsVersion List PluginWrapper Dependency out new ArrayList for DetachedPlugin detached DETACHED LIST don t fix the dependency for itself or else we ll have a cycle if detached shortName equals pluginName continue if BREAK CYCLES contains pluginName detached shortName LOGGER log Level FINE skipping implicit dependency 0 1 new Object pluginName detached shortName continue some earlier versions of maven hpi plugin apparently puts null as a literal in Hudson Version watch out for them if jenkinsVersion null jenkinsVersion equals null new VersionNumber jenkinsVersion compareTo detached splitWhen 0 out add new PluginWrapper Dependency detached shortName detached requiredVersion LOGGER log Level FINE adding implicit dependency 0 1 because of 2 new Object pluginName detached shortName jenkinsVersion return out Deprecated protected ClassLoader createClassLoader List File paths ClassLoader parent throws IOException return createClassLoader paths parent null protected ClassLoader createClassLoader List File paths ClassLoader parent Attributes atts throws IOException if atts null String usePluginFirstClassLoader atts getValue PluginFirstClassLoader if Boolean valueOf usePluginFirstClassLoader PluginFirstClassLoader classLoader new PluginFirstClassLoader classLoader setParentFirst false classLoader setParent parent classLoader addPathFiles paths return classLoader AntClassLoader2 classLoader new AntClassLoader2 parent classLoader addPathFiles paths return classLoader Restricted NoExternalUse class public static Nonnull List DetachedPlugin getDetachedPlugins return DETACHED LIST Restricted NoExternalUse class public static Nonnull List DetachedPlugin getDetachedPlugins Nonnull VersionNumber since List DetachedPlugin detachedPlugins new ArrayList for DetachedPlugin detachedPlugin DETACHED LIST if detachedPlugin getSplitWhen isOlderThan since detachedPlugins add detachedPlugin return detachedPlugins Restricted NoExternalUse class public static boolean isDetachedPlugin Nonnull String pluginId for DetachedPlugin detachedPlugin DETACHED LIST if detachedPlugin getShortName equals pluginId return true return false Restricted NoExternalUse class public static final class DetachedPlugin private final String shortName private final VersionNumber splitWhen private final String requiredVersion private DetachedPlugin String shortName String splitWhen String requiredVersion this shortName shortName this splitWhen new VersionNumber splitWhen this requiredVersion requiredVersion public String getShortName return shortName public VersionNumber getSplitWhen return splitWhen public VersionNumber getRequiredVersion return new VersionNumber requiredVersion private static final List DetachedPlugin DETACHED LIST Collections unmodifiableList Arrays asList new DetachedPlugin maven plugin 1 296 1 296 new DetachedPlugin subversion 1 310 1 0 new DetachedPlugin cvs 1 340 0 1 new DetachedPlugin ant 1 430 1 0 new DetachedPlugin javadoc 1 430 1 0 new DetachedPlugin external monitor job 1 467 1 0 new DetachedPlugin ldap 1 467 1 0 new DetachedPlugin pam auth 1 467 1 0 new DetachedPlugin mailer 1 493 1 2 new DetachedPlugin matrix auth 1 535 1 0 2 new DetachedPlugin windows slaves 1 547 1 0 new DetachedPlugin antisamy markup formatter 1 553 1 0 new DetachedPlugin matrix project 1 561 1 0 new DetachedPlugin junit 1 577 1 0 new DetachedPlugin bouncycastle api 2 16 2 16 0 private static final Set String BREAK CYCLES new HashSet String Arrays asList script security matrix auth script security windows slaves script security antisamy markup formatter script security matrix project credentials matrix auth credentials windows slaves private ClassLoader getBaseClassLoader Attributes atts ClassLoader base String masked atts getValue Mask Classes if masked null base new MaskingClassLoader base masked trim split t r n return base public void initializeComponents PluginWrapper plugin public T List ExtensionComponent T findComponents Class T type Hudson hudson List ExtensionFinder finders if type ExtensionFinder class Avoid infinite recursion of using ExtensionFinders to find ExtensionFinders finders Collections ExtensionFinder singletonList new ExtensionFinder Sezpoz else finders hudson getExtensionList ExtensionFinder class if LOGGER isLoggable Level FINER LOGGER log Level FINER Scout loading ExtensionList type new Throwable for ExtensionFinder finder finders finder scout type hudson List ExtensionComponent T r Lists newArrayList for ExtensionFinder finder finders try r addAll finder find type hudson catch AbstractMethodError e backward compatibility for T t finder findExtensions type hudson r add new ExtensionComponent T t List ExtensionComponent T filtered Lists newArrayList for ExtensionComponent T e r if ExtensionFilter isAllowed type e filtered add e return filtered public void load PluginWrapper wrapper throws IOException override the context classloader This no longer makes sense but it is left for the backward compatibility ClassLoader old Thread currentThread getContextClassLoader Thread currentThread setContextClassLoader wrapper classLoader try String className wrapper getPluginClass if className null use the default dummy instance wrapper setPlugin new DummyImpl else try Class clazz wrapper classLoader loadClass className Object o clazz newInstance if o instanceof Plugin throw new IOException className doesn t extend from hudson Plugin wrapper setPlugin Plugin o catch LinkageError ClassNotFoundException e throw new IOException Unable to load className from wrapper getShortName e catch IllegalAccessException InstantiationException e throw new IOException Unable to create instance of className from wrapper getShortName e initialize plugin try Plugin plugin wrapper getPlugin plugin setServletContext pluginManager context startPlugin wrapper catch Throwable t gracefully handle any error in plugin throw new IOException Failed to initialize t finally Thread currentThread setContextClassLoader old public void startPlugin PluginWrapper plugin throws Exception plugin getPlugin start Override public void updateDependency PluginWrapper depender PluginWrapper dependee DependencyClassLoader classLoader findAncestorDependencyClassLoader depender classLoader if classLoader null classLoader updateTransientDependencies LOGGER log Level INFO Updated dependency of 0 depender getShortName private DependencyClassLoader findAncestorDependencyClassLoader ClassLoader classLoader for classLoader null classLoader classLoader getParent if classLoader instanceof DependencyClassLoader return DependencyClassLoader classLoader if classLoader instanceof AntClassLoader AntClassLoaders hold parents not only as AntClassLoader getParent but also as AntClassLoader getConfiguredParent DependencyClassLoader ret findAncestorDependencyClassLoader AntClassLoader classLoader getConfiguredParent if ret null return ret return null private static File resolve File base String relative File rel new File relative if rel isAbsolute return rel else return new File base getParentFile relative private static void parseClassPath Manifest manifest File archive List File paths String attributeName String separator throws IOException String classPath manifest getMainAttributes getValue attributeName if classPath null return attribute not found for String s classPath split separator File file resolve archive s if file getName contains handle wildcard FileSet fs new FileSet File dir file getParentFile fs setDir dir fs setIncludes file getName for String included fs getDirectoryScanner new Project getIncludedFiles paths add new File dir included else if file exists throw new IOException No such file file paths add file private static void explode File archive File destDir throws IOException destDir mkdirs timestamp check File explodeTime new File destDir timestamp2 if explodeTime exists explodeTime lastModified archive lastModified return no need to expand delete the contents so that old files won t interfere with new files Util deleteRecursive destDir try Project prj new Project unzipExceptClasses archive destDir prj createClassJarFromWebInfClasses archive destDir prj catch BuildException x throw new IOException Failed to expand archive x try new FilePath explodeTime touch archive lastModified catch InterruptedException e throw new AssertionError e impossible private static void createClassJarFromWebInfClasses File archive File destDir Project prj throws IOException File classesJar new File destDir WEB INF lib classes jar ZipFileSet zfs new ZipFileSet zfs setProject prj zfs setSrc archive zfs setIncludes WEB INF classes MappedResourceCollection mapper new MappedResourceCollection mapper add zfs GlobPatternMapper gm new GlobPatternMapper gm setFrom WEB INF classes protected void zipDir Resource dir ZipOutputStream zOut String vPath int mode ZipExtraField extra throws IOException use wrappedZOut instead of zOut super zipDir dir wrappedZOut vPath mode extra z setProject prj z setTaskType zip classesJar getParentFile mkdirs z setDestFile classesJar z add mapper z execute private static void unzipExceptClasses File archive File destDir Project prj Expand e new Expand e setProject prj e setTaskType unzip e setSrc archive e setDest destDir PatternSet p new PatternSet p setExcludes WEB INF classes e addPatternset p e execute final class DependencyClassLoader extends ClassLoader private final File for private List Dependency dependencies private volatile List PluginWrapper transientDependencies public DependencyClassLoader ClassLoader parent File archive List Dependency dependencies super parent this for archive this dependencies dependencies private void updateTransientDependencies This will be recalculated at the next time transientDependencies null private List PluginWrapper getTransitiveDependencies if transientDependencies null CyclicGraphDetector PluginWrapper cgd new CyclicGraphDetector PluginWrapper Override protected List PluginWrapper getEdges PluginWrapper pw List PluginWrapper dep new ArrayList PluginWrapper for Dependency d pw getDependencies PluginWrapper p pluginManager getPlugin d shortName if p null p isActive dep add p return dep try for Dependency d dependencies PluginWrapper p pluginManager getPlugin d shortName if p null p isActive cgd run Collections singleton p catch CycleDetectedException e throw new AssertionError e such error should have been reported earlier transientDependencies cgd getSorted return transientDependencies public List PluginWrapper getDependencyPluginWrappers List PluginWrapper r new ArrayList PluginWrapper for Dependency d dependencies PluginWrapper w pluginManager getPlugin d shortName if w null r add w return r Override protected Class findClass String name throws ClassNotFoundException if PluginManager FAST LOOKUP for PluginWrapper pw getTransitiveDependencies try Class c ClassLoaderReflectionToolkit findLoadedClass pw classLoader name if c null return c return ClassLoaderReflectionToolkit findClass pw classLoader name catch ClassNotFoundException e not found try next else for Dependency dep dependencies PluginWrapper p pluginManager getPlugin dep shortName if p null try return p classLoader loadClass name catch ClassNotFoundException try next throw new ClassNotFoundException name Override protected Enumeration URL findResources String name throws IOException HashSet URL result new HashSet URL if PluginManager FAST LOOKUP for PluginWrapper pw getTransitiveDependencies Enumeration URL urls ClassLoaderReflectionToolkit findResources pw classLoader name while urls null urls hasMoreElements result add urls nextElement else for Dependency dep dependencies PluginWrapper p pluginManager getPlugin dep shortName if p null Enumeration URL urls p classLoader getResources name while urls null urls hasMoreElements result add urls nextElement return Collections enumeration result Override protected URL findResource String name if PluginManager FAST LOOKUP for PluginWrapper pw getTransitiveDependencies URL url ClassLoaderReflectionToolkit findResource pw classLoader name if url null return url else for Dependency dep dependencies PluginWrapper p pluginManager getPlugin dep shortName if p null URL url p classLoader getResource name if url null return url return null private final class AntClassLoader2 extends AntClassLoader implements Closeable private final Vector pathComponents private AntClassLoader2 ClassLoader parent super parent true try Field pathComponents AntClassLoader class getDeclaredField pathComponents pathComponents setAccessible true pathComponents Vector pathComponents get this catch NoSuchFieldException IllegalAccessException e throw new Error e public void addPathFiles Collection File paths throws IOException for File f paths addPathFile f public void close throws IOException cleanup Override protected URL findResource String name URL url null try and load from this loader if the parent either didn t find it or wasn t consulted Enumeration e pathComponents elements while e hasMoreElements url null File pathComponent File e nextElement url getResourceURL pathComponent name if url null log Resource name loaded from ant loader Project MSG DEBUG return url Override protected Class defineClassFromData File container byte classData String classname throws IOException if DISABLE TRANSFORMER classData pluginManager getCompatibilityTransformer transform classname classData this return super defineClassFromData container classData classname public static boolean useAntClassLoader SystemProperties getBoolean ClassicPluginStrategy class getName useAntClassLoader private static final Logger LOGGER Logger getLogger ClassicPluginStrategy class getName public static boolean DISABLE TRANSFORMER SystemProperties getBoolean ClassicPluginStrategy class getName noBytecodeTransformerpackage jenkins import java io IOException import java lang reflect InvocationTargetException import java lang reflect Method import java net URL import java util Enumeration import javax annotation CheckForNull import javax annotation Nonnull SuppressWarnings unchecked rawtypes public class ClassLoaderReflectionToolkit private static final Method FIND CLASS FIND LOADED CLASS FIND RESOURCE FIND RESOURCES GET CLASS LOADING LOCK static try FIND CLASS ClassLoader class getDeclaredMethod findClass String class FIND CLASS setAccessible true FIND LOADED CLASS ClassLoader class getDeclaredMethod findLoadedClass String class FIND LOADED CLASS setAccessible true FIND RESOURCE ClassLoader class getDeclaredMethod findResource String class FIND RESOURCE setAccessible true FIND RESOURCES ClassLoader class getDeclaredMethod findResources String class FIND RESOURCES setAccessible true catch NoSuchMethodException e throw new AssertionError e Method gCLL null try gCLL ClassLoader class getDeclaredMethod getClassLoadingLock String class gCLL setAccessible true catch NoSuchMethodException x throw new AssertionError x GET CLASS LOADING LOCK gCLL private static T extends Exception Object invoke Method method Class T exception Object obj Object args throws T try return method invoke obj args catch IllegalAccessException x throw new AssertionError x catch InvocationTargetException x Throwable x2 x getCause if x2 instanceof RuntimeException throw RuntimeException x2 else if x2 instanceof Error throw Error x2 else if exception isInstance x2 throw exception cast x2 else throw new AssertionError x2 private static Object getClassLoadingLock ClassLoader cl String name return invoke GET CLASS LOADING LOCK RuntimeException class cl name public static CheckForNull Class findLoadedClass ClassLoader cl String name synchronized getClassLoadingLock cl name return Class invoke FIND LOADED CLASS RuntimeException class cl name public static Nonnull Class findClass ClassLoader cl String name throws ClassNotFoundException synchronized getClassLoadingLock cl name return Class invoke FIND CLASS ClassNotFoundException class cl name public static CheckForNull URL findResource ClassLoader cl String name return URL invoke FIND RESOURCE RuntimeException class cl name public static Nonnull Enumeration URL findResources ClassLoader cl String name throws IOException return Enumeration URL invoke FIND RESOURCES IOException class cl name Deprecated public ClassLoaderReflectionToolkit Deprecated public Class findLoadedClass ClassLoader cl String name throws InvocationTargetException try return Class FIND LOADED CLASS invoke cl name catch IllegalAccessException e throw new Error e Deprecated public Class findClass ClassLoader cl String name throws InvocationTargetException try return Class FIND CLASS invoke cl name catch IllegalAccessException e throw new Error e Deprecated public URL findResource ClassLoader cl String name throws InvocationTargetException try return URL FIND RESOURCE invoke cl name catch IllegalAccessException e throw new Error e Deprecated public Enumeration URL findResources ClassLoader cl String name throws InvocationTargetException try return Enumeration URL FIND RESOURCES invoke cl name catch IllegalAccessException e throw new Error epackage jenkins slaves systemInfo import hudson Extension import org jenkinsci Symbol Extension ordinal 0 Symbol classLoaderStatistics public class ClassLoaderStatisticsSlaveInfo extends SlaveSystemInfo Override public String getDisplayName return Messages ClassLoaderStatisticsSlaveInfo DisplayNamepackage hudson util import hudson FilePath import hudson Util import hudson remoting Which import java io Serializable import java io File import java io IOException import java util List import java util ArrayList public class ClasspathBuilder implements Serializable private final List String args new ArrayList String public ClasspathBuilder add File f return add f getAbsolutePath public ClasspathBuilder add FilePath f return add f getRemote public ClasspathBuilder add String path args add path return this public ClasspathBuilder addJarOf Class c throws IOException return add Which jarFile c public ClasspathBuilder addAll FilePath base String glob throws IOException InterruptedException for FilePath item base list glob add item return this Override public String toString return Util join args File pathSeparatorpackage hudson cli import hudson Extension import jenkins model Jenkins import org acegisecurity AccessDeniedException import java util logging Logger Extension public class ClearQueueCommand extends CLICommand private static final Logger LOGGER Logger getLogger ClearQueueCommand class getName Override public String getShortDescription return Messages ClearQueueCommand ShortDescription Override protected int run throws Exception Jenkins getActiveInstance getQueue clear return 0package hudson cli import hudson cli client Messages import hudson remoting Channel import hudson remoting PingThread import hudson remoting Pipe import hudson remoting RemoteInputStream import hudson remoting RemoteOutputStream import hudson remoting SocketChannelStream import hudson remoting SocketOutputStream import javax crypto SecretKey import javax crypto spec SecretKeySpec import javax net ssl HostnameVerifier import javax net ssl HttpsURLConnection import javax net ssl SSLContext import javax net ssl SSLSession import javax net ssl TrustManager import java io BufferedInputStream import java io BufferedOutputStream import java io BufferedReader import java io ByteArrayInputStream import java io ByteArrayOutputStream import java io Closeable import java io DataInputStream import java io DataOutputStream import java io File import java io IOException import java io InputStream import java io OutputStream import java io PrintStream import java io StringReader import java net HttpURLConnection import java net InetSocketAddress import java net Socket import java net URL import java net URLConnection import java security GeneralSecurityException import java security KeyPair import java security PublicKey import java security SecureRandom import java security Signature import java util ArrayList import java util Arrays import java util Collections import java util List import java util Locale import java util Properties import java util concurrent ExecutorService import java util concurrent Executors import java util logging Level import java util logging Logger import static java util logging Level public class CLI private final ExecutorService pool private final Channel channel private final CliEntryPoint entryPoint private final boolean ownsPool private final List Closeable closables new ArrayList Closeable stuff to close in the close method private final String httpsProxyTunnel private final String authorization public CLI URL jenkins throws IOException InterruptedException this jenkins null Deprecated public CLI URL jenkins ExecutorService exec throws IOException InterruptedException this jenkins exec null Deprecated public CLI URL jenkins ExecutorService exec String httpsProxyTunnel throws IOException InterruptedException this new CLIConnectionFactory url jenkins executorService exec httpsProxyTunnel httpsProxyTunnel CLI CLIConnectionFactory factory throws IOException InterruptedException URL jenkins factory jenkins this httpsProxyTunnel factory httpsProxyTunnel this authorization factory authorization ExecutorService exec factory exec String url jenkins toExternalForm if url endsWith url ownsPool exec null pool exec null exec Executors newCachedThreadPool Channel channel try channel connectViaCliPort jenkins getCliTcpPort url catch IOException e LOGGER log Level FINE Failed to connect via CLI port Falling back to HTTP e try channel connectViaHttp url catch IOException e2 e addSuppressed e2 throw e this channel channel execute the command entryPoint CliEntryPoint channel waitForRemoteProperty CliEntryPoint class getName if entryPoint protocolVersion CliEntryPoint VERSION throw new IOException Messages CLI VersionMismatch private Channel connectViaHttp String url throws IOException LOGGER log FINE Trying to connect to 0 via HTTP url url cli URL jenkins new URL url FullDuplexHttpStream con new FullDuplexHttpStream jenkins authorization Channel ch new Channel Chunked connection to jenkins pool con getInputStream con getOutputStream final long interval 15 1000 final long timeout interval 3 4 new PingThread ch timeout interval protected void onDead noop the point of ping is to keep the connection alive as most HTTP servers have a rather short read time out start return ch private Channel connectViaCliPort URL jenkins CliPort clip throws IOException LOGGER log FINE Trying to connect directly via TCP IP to 0 clip endpoint final Socket s new Socket this prevents a connection from silently terminated by the router in between or the other peer and that goes without unnoticed However the time out is often very long for example 2 hours by default in Linux that this alone is enough to prevent that s setKeepAlive true we take care of buffering on our own s setTcpNoDelay true OutputStream out if httpsProxyTunnel null String tokens httpsProxyTunnel split s connect new InetSocketAddress tokens 0 Integer parseInt tokens 1 PrintStream o new PrintStream s getOutputStream o print CONNECT clip endpoint getHostName clip endpoint getPort HTTP 1 0 r n r n read the response from the proxy ByteArrayOutputStream rsp new ByteArrayOutputStream while rsp toString ISO 8859 1 endsWith r n r n int ch s getInputStream read if ch 0 throw new IOException Failed to read the HTTP proxy response rsp rsp write ch String head new BufferedReader new StringReader rsp toString ISO 8859 1 readLine if head startsWith HTTP 1 0 200 throw new IOException Failed to establish a connection through HTTP proxy rsp HTTP proxies at least the one I tried squid doesn t seem to do half close very well So instead of relying on it we ll just send the close command and then let the server cut their side then close the socket after the join out new SocketOutputStream s Override public void close throws IOException ignore else s connect clip endpoint 3000 out SocketChannelStream out s closables add new Closeable public void close throws IOException s close Connection c new Connection SocketChannelStream in s out switch clip version case 1 DataOutputStream dos new DataOutputStream s getOutputStream dos writeUTF Protocol CLI connect we aren t checking greeting from the server here because I m too lazy It gets ignored by Channel constructor break case 2 DataInputStream dis new DataInputStream s getInputStream dos new DataOutputStream s getOutputStream dos writeUTF Protocol CLI2 connect String greeting dis readUTF if greeting equals Welcome throw new IOException Handshaking failed greeting try byte secret c diffieHellman false generateSecret SecretKey sessionKey new SecretKeySpec Connection fold secret 128 8 AES c c encryptConnection sessionKey AES CFB8 NoPadding validate the instance identity so that we can be sure that we are talking to the same server and there s no one in the middle byte signature c readByteArray if clip identity null Signature verifier Signature getInstance SHA1withRSA verifier initVerify clip getIdentity verifier update secret if verifier verify signature throw new IOException Server identity signature validation failed catch GeneralSecurityException e throw IOException new IOException Failed to negotiate transport security initCause e return new Channel CLI connection to jenkins pool new BufferedInputStream c in new BufferedOutputStream c out protected CliPort getCliTcpPort String url throws IOException URL url new URL url if url getHost null url getHost length 0 throw new IOException Invalid URL url URLConnection head url openConnection try head connect catch IOException e throw IOException new IOException Failed to connect to url initCause e String h head getHeaderField X Jenkins CLI Host if h null h head getURL getHost String p1 head getHeaderField X Jenkins CLI Port if p1 null p1 head getHeaderField X Hudson CLI Port backward compatibility String p2 head getHeaderField X Jenkins CLI2 Port String identity head getHeaderField X Instance Identity flushURLConnection head if p1 null p2 null we aren t finding headers we are expecting Is this even running Jenkins if head getHeaderField X Hudson null head getHeaderField X Jenkins null throw new IOException There s no Jenkins running at url throw new IOException No X Jenkins CLI2 Port among head getHeaderFields keySet if p2 null return new CliPort new InetSocketAddress h Integer parseInt p2 identity 2 else return new CliPort new InetSocketAddress h Integer parseInt p1 identity 1 private void flushURLConnection URLConnection conn byte buf new byte 1024 try InputStream is conn getInputStream while is read buf 0 Ignore is close catch IOException e try InputStream es HttpURLConnection conn getErrorStream if es null while es read buf 0 Ignore es close catch IOException ex Ignore public void close throws IOException InterruptedException channel close channel join if ownsPool pool shutdown for Closeable c closables c close public int execute List String args InputStream stdin OutputStream stdout OutputStream stderr return entryPoint main args Locale getDefault new RemoteInputStream stdin new RemoteOutputStream stdout new RemoteOutputStream stderr public int execute List String args return execute args System in System out System err public int execute String args return execute Arrays asList args public boolean hasCommand String name return entryPoint hasCommand name public Channel getChannel return channel public void upgrade ByteArrayOutputStream out new ByteArrayOutputStream if execute Arrays asList groovy new ByteArrayInputStream hudson remoting Channel current setRestricted false getBytes out out 0 throw new SecurityException out toString failed to upgrade public static void main final String args throws Exception Logger l Logger getLogger Channel class getName l setLevel ALL ConsoleHandler h new ConsoleHandler h setLevel ALL l addHandler h try System exit main args catch Throwable t if the CLI main thread die make sure to kill the JVM t printStackTrace System exit 1 public static int main String args throws Exception List String args Arrays asList args PrivateKeyProvider provider new PrivateKeyProvider boolean sshAuthRequestedExplicitly false String httpProxy null String url System getenv JENKINS URL if url null url System getenv HUDSON URL boolean tryLoadPKey true while args isEmpty String head args get 0 if head equals version System out println Version computeVersion return 0 if head equals s args size 2 url args get 1 args args subList 2 args size continue if head equals noCertificateCheck System out println Skipping HTTPS certificate checks altogether Note that this is not secure at all SSLContext context SSLContext getInstance TLS context init null new TrustManager new NoCheckTrustManager new SecureRandom HttpsURLConnection setDefaultSSLSocketFactory context getSocketFactory bypass host name check too HttpsURLConnection setDefaultHostnameVerifier new HostnameVerifier public boolean verify String s SSLSession sslSession return true args args subList 1 args size continue if head equals noKeyAuth tryLoadPKey false args args subList 1 args size continue if head equals i args size 2 File f new File args get 1 if f exists printUsage Messages CLI NoSuchFileExists f return 1 provider readFrom f args args subList 2 args size sshAuthRequestedExplicitly true continue if head equals p args size 2 httpProxy args get 1 args args subList 2 args size continue break if url null printUsage Messages CLI NoURL return 1 if args isEmpty args Arrays asList help default to help if tryLoadPKey provider hasKeys provider readFromDefaultLocations CLIConnectionFactory factory new CLIConnectionFactory url url httpsProxyTunnel httpProxy String userInfo new URL url getUserInfo if userInfo null factory factory basicAuth userInfo CLI cli factory connect try if provider hasKeys try TODO server verification cli authenticate provider getKeys catch IllegalStateException e if sshAuthRequestedExplicitly System err println The server doesn t support public key authentication return 1 catch UnsupportedOperationException e if sshAuthRequestedExplicitly System err println The server doesn t support public key authentication return 1 catch GeneralSecurityException e if sshAuthRequestedExplicitly System err println e getMessage LOGGER log FINE e getMessage e return 1 System err println WARN Failed to authenticate with your SSH keys Proceeding as anonymous LOGGER log FINE Failed to authenticate with your SSH keys e execute the command Arrays asList is not serializable see 6835580 args new ArrayList String args return cli execute args System in System out System err finally cli close private static String computeVersion Properties props new Properties try InputStream is CLI class getResourceAsStream jenkins cli jenkins cli version properties if is null try props load is finally is close catch IOException e e printStackTrace if the version properties is missing that s OK return props getProperty version public static KeyPair loadKey File f String passwd throws IOException GeneralSecurityException return PrivateKeyProvider loadKey f passwd public static KeyPair loadKey File f throws IOException GeneralSecurityException return loadKey f null public static KeyPair loadKey String pemString String passwd throws IOException GeneralSecurityException return PrivateKeyProvider loadKey pemString passwd public static KeyPair loadKey String pemString throws IOException GeneralSecurityException return loadKey pemString null public PublicKey authenticate Iterable KeyPair privateKeys throws IOException GeneralSecurityException Pipe c2s Pipe createLocalToRemote Pipe s2c Pipe createRemoteToLocal entryPoint authenticate ssh c2s s2c Connection c new Connection s2c getIn c2s getOut try byte sharedSecret c diffieHellman false generateSecret PublicKey serverIdentity c verifyIdentity sharedSecret try all the public keys for KeyPair key privateKeys c proveIdentity sharedSecret key if c readBoolean return serverIdentity succeeded if privateKeys iterator hasNext throw new GeneralSecurityException Authentication failed No private key accepted else throw new GeneralSecurityException No private key is available for use in authentication finally c close public PublicKey authenticate KeyPair key throws IOException GeneralSecurityException return authenticate Collections singleton key private static void printUsage String msg if msg null System out println msg System err println Messages CLI Usage private static final Logger LOGGER Logger getLogger CLI class getNamepackage hudson cli import java io IOException import java util HashMap import java util Map import java util UUID import javax servlet ServletException import javax servlet http HttpServletResponse import hudson model UnprotectedRootAction import jenkins model Jenkins import org jenkinsci Symbol import org kohsuke accmod Restricted import org kohsuke accmod restrictions NoExternalUse import org kohsuke stapler HttpResponses HttpResponseException import org kohsuke stapler Stapler import org kohsuke stapler StaplerProxy import org kohsuke stapler StaplerRequest import org kohsuke stapler StaplerResponse import hudson Extension import hudson model FullDuplexHttpChannel import hudson remoting Channel Extension Symbol cli Restricted NoExternalUse class public class CLIAction implements UnprotectedRootAction StaplerProxy private transient final Map UUID FullDuplexHttpChannel duplexChannels new HashMap UUID FullDuplexHttpChannel public String getIconFileName return null public String getDisplayName return Jenkins CLI public String getUrlName return cli public void doCommand StaplerRequest req StaplerResponse rsp throws ServletException IOException final Jenkins jenkins Jenkins getActiveInstance jenkins checkPermission Jenkins READ Strip trailing slash final String commandName req getRestOfPath substring 1 CLICommand command CLICommand clone commandName if command null rsp sendError HttpServletResponse SC NOT FOUND No such command return req setAttribute command command req getView this command jelly forward req rsp Override public Object getTarget StaplerRequest req Stapler getCurrentRequest if req getRestOfPath length 0 POST equals req getMethod CLI connection request throw new CliEndpointResponse else return this private class CliEndpointResponse extends HttpResponseException Override public void generateResponse StaplerRequest req StaplerResponse rsp Object node throws IOException ServletException try do not require any permission to establish a CLI connection the actual authentication for the connecting Channel is done by CLICommand UUID uuid UUID fromString req getHeader Session rsp setHeader Hudson Duplex set the header so that the client would know FullDuplexHttpChannel server if req getHeader Side equals download duplexChannels put uuid server new FullDuplexHttpChannel uuid Jenkins getActiveInstance hasPermission Jenkins ADMINISTER Override protected void main Channel channel throws IOException InterruptedException capture the identity given by the transport since this can be useful for SecurityRealm createCliAuthenticator channel setProperty CLICommand TRANSPORT AUTHENTICATION Jenkins getAuthentication channel setProperty CliEntryPoint class getName new CliManagerImpl channel try server download req rsp finally duplexChannels remove uuid else duplexChannels get uuid upload req rsp catch InterruptedException e throw new IOException epackage hudson security import hudson cli CLICommand import org acegisecurity Authentication import org acegisecurity AuthenticationException import org kohsuke args4j Argument import org kohsuke args4j CmdLineParser import org kohsuke args4j Option import java io IOException public abstract class CliAuthenticator public abstract Authentication authenticate throws AuthenticationException IOException InterruptedExceptionpackage com twitter sdk android tweetui internal import android graphics Color import android text TextPaint import android text style ClickableSpan public abstract class ClickableLinkSpan extends ClickableSpan implements HighlightedClickableSpan public final int linkColor private final int selectedColor private final boolean colored private final boolean underlined private boolean selected public ClickableLinkSpan int selectedColor this selectedColor 0 false false public ClickableLinkSpan int selectedColor int linkColor boolean underlined this selectedColor linkColor true underlined ClickableLinkSpan int selectedColor int linkColor boolean colored boolean underlined this selectedColor selectedColor this linkColor linkColor this colored colored this underlined underlined Override public void updateDrawState TextPaint ds if colored ds setColor linkColor else ds setColor ds linkColor if selected ds bgColor selectedColor else ds bgColor Color TRANSPARENT if underlined ds setUnderlineText true Override public void select boolean selected this selected selected Override public boolean isSelected return selectedpackage com kaku colorfulnews utils import android os SystemClock public class ClickUtil private static long mLastClickTime 0 private static final int SPACE TIME 500 public static boolean isFastDoubleClick long time SystemClock elapsedRealtime if time mLastClickTime SPACE TIME return true else mLastClickTime time return falsepackage hudson cli import hudson AbortException import hudson Extension import hudson ExtensionList import hudson ExtensionPoint import hudson cli declarative CLIMethod import hudson ExtensionPoint LegacyInstancesAreScopedToHudson import jenkins util SystemProperties import hudson cli declarative OptionHandlerExtension import jenkins model Jenkins import hudson remoting Callable import hudson remoting Channel import hudson remoting ChannelProperty import hudson security CliAuthenticator import hudson security SecurityRealm import jenkins security MasterToSlaveCallable import org acegisecurity AccessDeniedException import org acegisecurity Authentication import org acegisecurity BadCredentialsException import org acegisecurity context SecurityContext import org acegisecurity context SecurityContextHolder import org apache commons discovery ResourceClassIterator import org apache commons discovery ResourceNameIterator import org apache commons discovery resource ClassLoaders import org apache commons discovery resource classes DiscoverClasses import org apache commons discovery resource names DiscoverServiceNames import org jvnet hudson annotation indexer Index import org jvnet tiger types Types import org kohsuke accmod Restricted import org kohsuke accmod restrictions NoExternalUse import org kohsuke args4j ClassParser import org kohsuke args4j CmdLineException import org kohsuke args4j CmdLineParser import org kohsuke args4j spi OptionHandler import java io BufferedInputStream import java io ByteArrayOutputStream import java io IOException import java io InputStream import java io PrintStream import java lang reflect Type import java nio charset Charset import java nio charset UnsupportedCharsetException import java util List import java util Locale import java util UUID import java util logging Level import java util logging Logger LegacyInstancesAreScopedToHudson public abstract class CLICommand implements ExtensionPoint Cloneable public transient PrintStream stdout stderr static final String CLI LISTPARAM SUMMARY ERROR TEXT Error occurred while performing this command see previous stderr output public transient InputStream stdin public transient Channel channel public transient Locale locale private transient Authentication transportAuth public String getName String name getClass getName name name substring name lastIndexOf 1 short name name name substring name lastIndexOf 1 if name endsWith Command name name substring 0 name length 7 trim off the command convert FooBarZot into foo bar zot Locale is fixed so that CreateInstance always become create instance no matter where this is run return name replaceAll a z0 9 A Z 1 2 toLowerCase Locale ENGLISH public abstract String getShortDescription public int main List String args Locale locale InputStream stdin PrintStream stdout PrintStream stderr this stdin new BufferedInputStream stdin this stdout stdout this stderr stderr this locale locale registerOptionHandlers CmdLineParser p getCmdLineParser add options from the authenticator SecurityContext sc null Authentication old null try sc SecurityContextHolder getContext old sc getAuthentication CliAuthenticator authenticator Jenkins getActiveInstance getSecurityRealm createCliAuthenticator this sc setAuthentication getTransportAuthentication new ClassParser parse authenticator p p parseArgument args toArray new String args size Authentication auth authenticator authenticate if auth Jenkins ANONYMOUS auth loadStoredAuthentication sc setAuthentication auth run the CLI with the right credential if this instanceof LoginCommand this instanceof HelpCommand Jenkins getActiveInstance checkPermission Jenkins READ return run catch CmdLineException e stderr println stderr println ERROR e getMessage printUsage stderr p return 2 catch IllegalStateException e stderr println stderr println ERROR e getMessage return 4 catch IllegalArgumentException e stderr println stderr println ERROR e getMessage return 3 catch AbortException e signals an error without stack trace stderr println stderr println ERROR e getMessage return 5 catch AccessDeniedException e stderr println stderr println ERROR e getMessage return 6 catch BadCredentialsException e to the caller we can t reveal whether the user didn t exist or the password didn t match do that to the server log instead String id UUID randomUUID toString LOGGER log Level INFO CLI login attempt failed id e stderr println stderr println ERROR Bad Credentials Search the server log for id for more details return 7 catch Throwable e final String errorMsg String format Unexpected exception occurred while performing s command getName stderr println stderr println ERROR errorMsg LOGGER log Level WARNING errorMsg e e printStackTrace stderr return 1 finally if sc null sc setAuthentication old restore protected CmdLineParser getCmdLineParser return new CmdLineParser this public Channel checkChannel throws AbortException if channel null throw new AbortException This command can only run with Jenkins CLI See https wiki jenkins ci org display JENKINS Jenkins CLI return channel protected Authentication loadStoredAuthentication throws InterruptedException try if channel null return new ClientAuthenticationCache channel get catch IOException e stderr println Failed to access the stored credential e printStackTrace stderr recover return Jenkins ANONYMOUS protected boolean shouldPerformAuthentication Authentication auth return auth Jenkins ANONYMOUS public Authentication getTransportAuthentication Authentication a transportAuth if a null a Jenkins ANONYMOUS return a public void setTransportAuth Authentication transportAuth this transportAuth transportAuth protected abstract int run throws Exception protected void printUsage PrintStream stderr CmdLineParser p stderr print java jar jenkins cli jar getName p printSingleLineUsage stderr stderr println printUsageSummary stderr p printUsage stderr Restricted NoExternalUse class public final String getSingleLineSummary ByteArrayOutputStream out new ByteArrayOutputStream getCmdLineParser printSingleLineUsage out return out toString Restricted NoExternalUse class public final String getUsage ByteArrayOutputStream out new ByteArrayOutputStream getCmdLineParser printUsage out return out toString Restricted NoExternalUse class public final String getLongDescription ByteArrayOutputStream out new ByteArrayOutputStream PrintStream ps new PrintStream out printUsageSummary ps ps close return out toString protected void printUsageSummary PrintStream stderr stderr println getShortDescription protected String getClientSystemProperty String name throws IOException InterruptedException return checkChannel call new GetSystemProperty name private static final class GetSystemProperty extends MasterToSlaveCallable String IOException private final String name private GetSystemProperty String name this name name public String call throws IOException return SystemProperties getString name private static final long serialVersionUID 1L protected Charset getClientCharset throws IOException InterruptedException if channel null for SSH assume the platform default encoding this is in line with the standard SSH behavior return Charset defaultCharset String charsetName checkChannel call new GetCharset try return Charset forName charsetName catch UnsupportedCharsetException e LOGGER log Level FINE Server doesn t have charset charsetName return Charset defaultCharset private static final class GetCharset extends MasterToSlaveCallable String IOException public String call throws IOException return Charset defaultCharset name private static final long serialVersionUID 1L protected String getClientEnvironmentVariable String name throws IOException InterruptedException return checkChannel call new GetEnvironmentVariable name private static final class GetEnvironmentVariable extends MasterToSlaveCallable String IOException private final String name private GetEnvironmentVariable String name this name name public String call throws IOException return System getenv name private static final long serialVersionUID 1L protected CLICommand createClone try return getClass newInstance catch IllegalAccessException InstantiationException e throw new AssertionError e protected void registerOptionHandlers try for Class c Index list OptionHandlerExtension class Jenkins getActiveInstance pluginManager uberClassLoader Class class Type t Types getBaseClass c OptionHandler class CmdLineParser registerHandler Types erasure Types getTypeArgument t 0 c catch IOException e throw new Error e public static ExtensionList CLICommand all return ExtensionList lookup CLICommand class public static CLICommand clone String name for CLICommand cmd all if name equals cmd getName return cmd createClone return null private static final Logger LOGGER Logger getLogger CLICommand class getName public static final ChannelProperty Authentication TRANSPORT AUTHENTICATION new ChannelProperty Authentication Authentication class transportAuthentication private static final ThreadLocal CLICommand CURRENT COMMAND new ThreadLocal CLICommand static CLICommand setCurrent CLICommand cmd CLICommand old getCurrent CURRENT COMMAND set cmd return old public static CLICommand getCurrent return CURRENT COMMAND get static register option handlers that are defined ClassLoaders cls new ClassLoaders Jenkins j Jenkins getActiveInstance if j null only when running on the master cls put j getPluginManager uberClassLoader ResourceNameIterator servicesIter new DiscoverServiceNames cls findResourceNames OptionHandler class getName final ResourceClassIterator itr new DiscoverClasses cls findResourceClasses servicesIter while itr hasNext Class h itr nextResourceClass loadClass Class c Types erasure Types getTypeArgument Types getBaseClass h OptionHandler class 0 CmdLineParser registerHandler c hpackage hudson cli import org apache commons codec binary Base64 import java io IOException import java net MalformedURLException import java net URL import java util concurrent ExecutorService public class CLIConnectionFactory URL jenkins ExecutorService exec String httpsProxyTunnel String authorization public CLIConnectionFactory url URL jenkins this jenkins jenkins return this public CLIConnectionFactory url String jenkins throws MalformedURLException return url new URL jenkins public CLIConnectionFactory executorService ExecutorService es this exec es return this public CLIConnectionFactory httpsProxyTunnel String value this httpsProxyTunnel value return this public CLIConnectionFactory authorization String value this authorization value return this public CLIConnectionFactory basicAuth String username String password return basicAuth username password public CLIConnectionFactory basicAuth String userInfo return authorization Basic new String Base64 encodeBase64 userInfo getBytes public CLI connect throws IOException InterruptedException return new CLI thispackage hudson cli import hudson Extension import hudson security csrf CrumbExclusion import org kohsuke accmod Restricted import org kohsuke accmod restrictions DoNotUse import javax servlet FilterChain import javax servlet ServletException import javax servlet http HttpServletRequest import javax servlet http HttpServletResponse import java io IOException Extension Restricted DoNotUse class public class CliCrumbExclusion extends CrumbExclusion Override public boolean process HttpServletRequest request HttpServletResponse response FilterChain chain throws IOException ServletException String pathInfo request getPathInfo if pathInfo null cli equals pathInfo chain doFilter request response return true return falsepackage hudson cli import hudson FilePath import hudson remoting Channel import hudson util Secret import jenkins model Jenkins import jenkins security MasterToSlaveCallable import org acegisecurity Authentication import org acegisecurity AuthenticationException import org acegisecurity providers UsernamePasswordAuthenticationToken import org acegisecurity userdetails UserDetails import org springframework dao DataAccessException import java io File import java io IOException import java io InputStream import java io OutputStream import java io Serializable import java util Properties public class ClientAuthenticationCache implements Serializable private final FilePath store private final Properties props new Properties public ClientAuthenticationCache Channel channel throws IOException InterruptedException store channel null FilePath localChannel channel call new MasterToSlaveCallable FilePath IOException public FilePath call throws IOException File home new File System getProperty user home File hudsonHome new File home hudson if hudsonHome exists return new FilePath new File hudsonHome cli credentials return new FilePath new File home jenkins cli credentials if store exists try InputStream istream store read props load istream public Authentication get Jenkins h Jenkins getActiveInstance Secret userName Secret decrypt props getProperty getPropertyKey if userName null return Jenkins ANONYMOUS failed to decrypt try UserDetails u h getSecurityRealm loadUserByUsername userName getPlainText return new UsernamePasswordAuthenticationToken u getUsername u getAuthorities catch AuthenticationException DataAccessException e return Jenkins ANONYMOUS private String getPropertyKey String url Jenkins getActiveInstance getRootUrl if url null return url return Secret fromString key toString public void set Authentication a throws IOException InterruptedException Jenkins h Jenkins getActiveInstance make sure that this security realm is capable of retrieving the authentication by name as it s not required UserDetails u h getSecurityRealm loadUserByUsername a getName props setProperty getPropertyKey Secret fromString u getUsername getEncryptedValue save public void remove throws IOException InterruptedException if props remove getPropertyKey null save private void save throws IOException InterruptedException try OutputStream os store write props store os Credential store try to protect this file from other users if we can store chmod 0600package hudson cli import hudson remoting Pipe import java io OutputStream import java io InputStream import java util List import java util Locale public interface CliEntryPoint int main List String args Locale locale InputStream stdin OutputStream stdout OutputStream stderr boolean hasCommand String name int protocolVersion void authenticate String protocol Pipe c2s Pipe s2c int VERSION 1package jenkins management import hudson Extension import hudson model ManagementLink import org jenkinsci Symbol Extension ordinal Integer MAX VALUE 800 Symbol cli public class CliLink extends ManagementLink Override public String getIconFileName return terminal png public String getDisplayName return Messages CliLink DisplayName Override public String getDescription return Messages CliLink Description Override public String getUrlName return clipackage hudson cli import hudson remoting CallableFilter import hudson remoting Channel import hudson remoting Pipe import org acegisecurity Authentication import org acegisecurity context SecurityContext import org acegisecurity context SecurityContextHolder import java io InputStream import java io OutputStream import java io PrintStream import java io Serializable import java util Collections import java util List import java util Locale import java util concurrent Callable import java util logging Logger public class CliManagerImpl implements CliEntryPoint Serializable private transient final Channel channel private Authentication transportAuth TODO Migrate the code to Callable decorator private transient final CallableFilter authenticationFilter new CallableFilter public V V call Callable V callable throws Exception SecurityContext context SecurityContextHolder getContext Authentication old context getAuthentication if transportAuth null context setAuthentication transportAuth try return callable call finally context setAuthentication old public CliManagerImpl Channel channel this channel channel channel addLocalExecutionInterceptor authenticationFilter public int main List String args Locale locale InputStream stdin OutputStream stdout OutputStream stderr remoting sets the context classloader to the RemoteClassLoader which slows down the classloading we don t load anything from CLI so counter that effect Thread currentThread setContextClassLoader getClass getClassLoader PrintStream out new PrintStream stdout PrintStream err new PrintStream stderr String subCmd args get 0 CLICommand cmd CLICommand clone subCmd if cmd null cmd channel Channel current final CLICommand old CLICommand setCurrent cmd try transportAuth Channel current getProperty CLICommand TRANSPORT AUTHENTICATION cmd setTransportAuth transportAuth return cmd main args subList 1 args size locale stdin out err finally CLICommand setCurrent old err println No such command subCmd new HelpCommand main Collections String emptyList locale stdin out err return 1 public void authenticate final String protocol final Pipe c2s final Pipe s2c for final CliTransportAuthenticator cta CliTransportAuthenticator all if cta supportsProtocol protocol new Thread Override public void run cta authenticate protocol channel new Connection c2s getIn s2c getOut start return throw new UnsupportedOperationException Unsupported authentication protocol protocol public boolean hasCommand String name return CLICommand clone name null public int protocolVersion return VERSION private Object writeReplace return Channel current export CliEntryPoint class this private static final Logger LOGGER Logger getLogger CliManagerImpl class getNamepackage hudson cli declarative import hudson cli CLICommand import hudson util ListBoxModel Option import org jvnet hudson annotation indexer Indexed import org kohsuke args4j Argument import java lang annotation Documented import static java lang annotation ElementType METHOD import java lang annotation Retention import static java lang annotation RetentionPolicy RUNTIME import java lang annotation Target Indexed Retention RUNTIME Target METHOD Documented public interface CLIMethod String name boolean usesChannel default falsepackage hudson cli import org apache commons codec binary Base64 import java net InetSocketAddress import java security GeneralSecurityException import java security KeyFactory import java security PublicKey import java security spec X509EncodedKeySpec public final class CliPort final InetSocketAddress endpoint final int version final String identity public CliPort InetSocketAddress endpoint String identity int version this endpoint endpoint this identity identity this version version public PublicKey getIdentity throws GeneralSecurityException if identity null return null byte image Base64 decodeBase64 identity return KeyFactory getInstance RSA generatePublic new X509EncodedKeySpec imagepackage hudson cli import hudson Extension import hudson Util import hudson model Computer import hudson remoting Channel import hudson remoting Channel Mode import hudson remoting ChannelBuilder import jenkins AgentProtocol import jenkins model Jenkins import jenkins slaves NioChannelSelector import org jenkinsci Symbol import org jenkinsci remoting nio NioChannelHub import javax inject Inject import java io BufferedInputStream import java io BufferedOutputStream import java io BufferedWriter import java io IOException import java io OutputStreamWriter import java io PrintWriter import java net Socket Extension Symbol cli public class CliProtocol extends AgentProtocol Inject NioChannelSelector nio Override public boolean isOptIn return OPT IN Override public String getName return CLI connect Override public String getDisplayName return Jenkins CLI Protocol 1 Override public void handle Socket socket throws IOException InterruptedException new Handler nio getHub socket run protected static class Handler protected final NioChannelHub hub protected final Socket socket Deprecated public Handler Socket socket this null socket public Handler NioChannelHub hub Socket socket this hub hub this socket socket public void run throws IOException InterruptedException PrintWriter out new PrintWriter new BufferedWriter new OutputStreamWriter socket getOutputStream UTF 8 true out println Welcome runCli new Connection socket protected void runCli Connection c throws IOException InterruptedException ChannelBuilder cb String name CLI channel from socket getInetAddress Connection can contain cipher wrapper which can t be NIO ed if hub null cb hub newChannelBuilder name Computer threadPoolForRemoting else cb new ChannelBuilder name Computer threadPoolForRemoting Channel channel cb withMode Mode BINARY withRestricted true withBaseLoader Jenkins getActiveInstance pluginManager uberClassLoader build new BufferedInputStream c in new BufferedOutputStream c out channel setProperty CliEntryPoint class getName new CliManagerImpl channel channel join private static final boolean OPT IN static byte hash Util fromHexString Jenkins getInstance getLegacyInstanceId 0 OPT IN hash 10 0package hudson cli import hudson Extension import jenkins model Jenkins import org jenkinsci Symbol import org jenkinsci remoting nio NioChannelHub import javax crypto SecretKey import javax crypto spec SecretKeySpec import java io DataOutputStream import java io IOException import java lang reflect InvocationTargetException import java net Socket import java security GeneralSecurityException import java security PrivateKey import java security Signature Extension Symbol cli2 public class CliProtocol2 extends CliProtocol Override public String getName return CLI2 connect Override public boolean isOptIn return false Override public String getDisplayName return Jenkins CLI Protocol 2 Override public void handle Socket socket throws IOException InterruptedException new Handler2 nio getHub socket run protected static class Handler2 extends Handler Deprecated public Handler2 Socket socket super socket public Handler2 NioChannelHub hub Socket socket super hub socket Override public void run throws IOException InterruptedException try DataOutputStream out new DataOutputStream socket getOutputStream out writeUTF Welcome perform coin toss and come up with a session key to encrypt data Connection c new Connection socket byte secret c diffieHellman true generateSecret SecretKey sessionKey new SecretKeySpec Connection fold secret 128 8 AES c c encryptConnection sessionKey AES CFB8 NoPadding try HACK TODO move the transport support into modules Class cls Jenkins getActiveInstance pluginManager uberClassLoader loadClass org jenkinsci main modules instance identity InstanceIdentity Object iid cls getDeclaredMethod get invoke null PrivateKey instanceId PrivateKey cls getDeclaredMethod getPrivate invoke iid send a signature to prove our identity Signature signer Signature getInstance SHA1withRSA signer initSign instanceId signer update secret c writeByteArray signer sign catch ClassNotFoundException IllegalAccessException InvocationTargetException NoSuchMethodException e throw new Error e runCli c catch GeneralSecurityException e throw new IOException Failed to encrypt the CLI channel epackage hudson cli declarative import hudson AbortException import hudson Extension import hudson ExtensionComponent import hudson ExtensionFinder import hudson Util import hudson cli CLICommand import hudson cli CloneableCLICommand import hudson model Hudson import jenkins ExtensionComponentSet import jenkins ExtensionRefreshException import jenkins model Jenkins import hudson security CliAuthenticator import org acegisecurity AccessDeniedException import org acegisecurity Authentication import org acegisecurity BadCredentialsException import org acegisecurity context SecurityContext import org acegisecurity context SecurityContextHolder import org jvnet hudson annotation indexer Index import org jvnet localizer ResourceBundleHolder import org kohsuke args4j ClassParser import org kohsuke args4j CmdLineParser import org kohsuke args4j CmdLineException import java io IOException import java io InputStream import java io PrintStream import java lang reflect InvocationTargetException import java lang reflect Method import java lang reflect Modifier import java util ArrayList import java util Collection import java util Collections import java util List import java util Locale import java util Stack import static java util logging Level SEVERE import java util UUID import java util logging Level import java util logging Logger Extension public class CLIRegisterer extends ExtensionFinder Override public ExtensionComponentSet refresh throws ExtensionRefreshException TODO this is not complex just bit tedious return ExtensionComponentSet EMPTY public T Collection ExtensionComponent T find Class T type Hudson jenkins if type CLICommand class return List discover jenkins else return Collections emptyList private Method findResolver Class type throws IOException List Method resolvers Util filter Index list CLIResolver class Jenkins getInstance getPluginManager uberClassLoader Method class for type null type type getSuperclass for Method m resolvers if m getReturnType type return m return null private List ExtensionComponent CLICommand discover final Jenkins hudson LOGGER fine Listing up CLIMethod List ExtensionComponent CLICommand r new ArrayList ExtensionComponent CLICommand try for final Method m Util filter Index list CLIMethod class hudson getPluginManager uberClassLoader Method class try command name final String name m getAnnotation CLIMethod class name final ResourceBundleHolder res loadMessageBundle m res format CLI name shortDescription make sure we have the resource to fail early r add new ExtensionComponent CLICommand new CloneableCLICommand Override public String getName return name Override public String getShortDescription format by using the right locale return res format CLI name shortDescription Override protected CmdLineParser getCmdLineParser return bindMethod new ArrayList MethodBinder private CmdLineParser bindMethod List MethodBinder binders registerOptionHandlers CmdLineParser parser new CmdLineParser null build up the call sequence Stack Method chains new Stack Method Method method m while true chains push method if Modifier isStatic method getModifiers break the chain is complete the method in question is an instance method so we need to resolve the instance by using another resolver Class type method getDeclaringClass try method findResolver type catch IOException ex throw new RuntimeException Unable to find the resolver method annotated with CLIResolver for type ex if method null throw new RuntimeException Unable to find the resolver method annotated with CLIResolver for type while chains isEmpty binders add new MethodBinder chains pop this parser return parser Override public int main List String args Locale locale InputStream stdin PrintStream stdout PrintStream stderr this stdout stdout this stderr stderr this locale locale List MethodBinder binders new ArrayList MethodBinder CmdLineParser parser bindMethod binders try SecurityContext sc SecurityContextHolder getContext Authentication old sc getAuthentication try authentication CliAuthenticator authenticator Jenkins getInstance getSecurityRealm createCliAuthenticator this new ClassParser parse authenticator parser fill up all the binders parser parseArgument args Authentication auth authenticator authenticate if auth Jenkins ANONYMOUS auth loadStoredAuthentication sc setAuthentication auth run the CLI with the right credential hudson checkPermission Jenkins READ resolve them Object instance null for MethodBinder binder binders instance binder call instance if instance instanceof Integer return Integer instance else return 0 catch InvocationTargetException e Throwable t e getTargetException if t instanceof Exception throw Exception t throw e finally sc setAuthentication old restore catch CmdLineException e stderr println stderr println ERROR e getMessage printUsage stderr parser return 2 catch IllegalStateException e stderr println stderr println ERROR e getMessage return 4 catch IllegalArgumentException e stderr println stderr println ERROR e getMessage return 3 catch AbortException e stderr println stderr println ERROR e getMessage return 5 catch AccessDeniedException e stderr println stderr println ERROR e getMessage return 6 catch BadCredentialsException e to the caller we can t reveal whether the user didn t exist or the password didn t match do that to the server log instead String id UUID randomUUID toString LOGGER log Level INFO CLI login attempt failed id e stderr println stderr println ERROR Bad Credentials Search the server log for id for more details return 7 catch Throwable e final String errorMsg String format Unexpected exception occurred while performing s command getName stderr println stderr println ERROR errorMsg LOGGER log Level WARNING errorMsg e e printStackTrace stderr return 1 protected int run throws Exception throw new UnsupportedOperationException catch ClassNotFoundException e LOGGER log SEVERE Failed to process CLIMethod m e catch IOException e LOGGER log SEVERE Failed to discover CLIMethod e return r private ResourceBundleHolder loadMessageBundle Method m throws ClassNotFoundException Class c m getDeclaringClass Class msg c getClassLoader loadClass c getName substring 0 c getName lastIndexOf Messages return ResourceBundleHolder get msg private static final Logger LOGGER Logger getLogger CLIRegisterer class getNamepackage hudson cli declarative import hudson cli CLICommand import org jvnet hudson annotation indexer Indexed import org kohsuke args4j CmdLineException import java lang annotation Documented import static java lang annotation ElementType METHOD import java lang annotation Retention import static java lang annotation RetentionPolicy RUNTIME import java lang annotation Target Indexed Retention RUNTIME Target METHOD Documented public interface CLIResolverpackage hudson cli import hudson ExtensionList import hudson ExtensionPoint import hudson remoting Channel import hudson security SecurityRealm public abstract class CliTransportAuthenticator implements ExtensionPoint public abstract boolean supportsProtocol String protocol public abstract void authenticate String protocol Channel channel Connection con public static ExtensionList CliTransportAuthenticator all return ExtensionList lookup CliTransportAuthenticator classpackage hudson util import hudson Util import hudson model Node import java io IOException import org kohsuke stapler export ExportedBean import org kohsuke stapler export Exported ExportedBean public final class ClockDifference Exported public final long diff public ClockDifference long value this diff value public boolean isDangerous return Math abs diff 5000 public long abs return Math abs diff Override public String toString if 1000 diff diff 1000 return Messages ClockDifference InSync clock is in sync long abs Math abs diff String s Util getTimeSpanString abs if diff 0 s Messages ClockDifference Ahead s else s Messages ClockDifference Behind s return s public String toHtml String s toString if isDangerous s Util wrapToErrorSpan s return s public static String toHtml Node d try if d null return FAILED HTML return d getClockDifference toHtml catch IOException e return FAILED HTML catch InterruptedException e return FAILED HTML public static String toHtml ClockDifference d if d null return FAILED HTML return d toHtml public static final ClockDifference ZERO new ClockDifference 0 private static final String FAILED HTML span class error Messages ClockDifference Failed spanpackage hudson node monitors import hudson model Computer import hudson model Node import hudson remoting Callable import hudson util ClockDifference import hudson Extension import org jenkinsci Symbol import org kohsuke accmod Restricted import org kohsuke accmod restrictions NoExternalUse import org kohsuke stapler StaplerRequest import java io IOException import net sf json JSONObject public class ClockMonitor extends NodeMonitor public ClockDifference getDifferenceFor Computer c return DESCRIPTOR get c Restricted NoExternalUse class public static AbstractNodeMonitorDescriptor ClockDifference DESCRIPTOR Extension Symbol clock public static class DescriptorImpl extends AbstractAsyncNodeMonitorDescriptor ClockDifference public DescriptorImpl DESCRIPTOR this Override protected Callable ClockDifference IOException createCallable Computer c Node n c getNode if n null return null return n getClockDifferenceCallable public String getDisplayName return Messages ClockMonitor DisplayName Override public NodeMonitor newInstance StaplerRequest req JSONObject formData throws FormException return new ClockMonitorpackage hudson cli public abstract class CloneableCLICommand extends CLICommand implements Cloneable Override protected CLICommand createClone try return CLICommand clone catch CloneNotSupportedException e throw new AssertionError epackage hudson import hudson util DelegatingOutputStream import java io OutputStream public class CloseProofOutputStream extends DelegatingOutputStream public CloseProofOutputStream OutputStream out super out Override public void closepackage hudson util spring import groovy lang Binding import groovy lang Closure import groovy lang GroovyObject import groovy lang MissingMethodException import groovy lang MissingPropertyException import groovy lang Script TODO moved to stapler public abstract class ClosureScript extends Script private GroovyObject delegate protected ClosureScript super protected ClosureScript Binding binding super binding public void setDelegate GroovyObject delegate this delegate delegate Override public Object invokeMethod String name Object args try return delegate invokeMethod name args catch MissingMethodException mme return super invokeMethod name args Override public Object getProperty String property try return delegate getProperty property catch MissingPropertyException e return super getProperty property Override public void setProperty String property Object newValue try delegate setProperty property newValue catch MissingPropertyException e super setProperty property newValuepackage hudson slaves import hudson ExtensionPoint import hudson Extension import hudson DescriptorExtensionList import hudson model Computer import hudson model Slave import hudson security PermissionScope import hudson slaves NodeProvisioner PlannedNode import hudson model Describable import jenkins model Jenkins import hudson model Node import hudson model AbstractModelObject import hudson model Label import hudson model Descriptor import hudson security ACL import hudson security AccessControlled import hudson security Permission import hudson util DescriptorList import org kohsuke stapler DataBoundConstructor import java util Collection import java util concurrent Future public abstract class Cloud extends AbstractModelObject implements ExtensionPoint Describable Cloud AccessControlled public final String name protected Cloud String name this name name public String getDisplayName return name public String getSearchUrl return cloud name public ACL getACL return Jenkins getInstance getAuthorizationStrategy getACL this public final void checkPermission Permission permission getACL checkPermission permission public final boolean hasPermission Permission permission return getACL hasPermission permission public abstract Collection PlannedNode provision Label label int excessWorkload public abstract boolean canProvision Label label public Descriptor Cloud getDescriptor return Jenkins getInstance getDescriptorOrDie getClass Deprecated public static final DescriptorList Cloud ALL new DescriptorList Cloud Cloud class public static DescriptorExtensionList Cloud Descriptor Cloud all return Jenkins getInstance Cloud Descriptor Cloud getDescriptorList Cloud class private static final PermissionScope PERMISSION SCOPE new PermissionScope Cloud class public static final Permission PROVISION new Permission Computer PERMISSIONS Provision Messages Cloud ProvisionPermission Description Jenkins ADMINISTER PERMISSION SCOPEpackage hudson slaves import hudson ExtensionList import hudson ExtensionPoint import hudson model Label import hudson model Node import hudson model queue CauseOfBlockage import java util Collection public abstract class CloudProvisioningListener implements ExtensionPoint public CauseOfBlockage canProvision Cloud cloud Label label int numExecutors return null public void onStarted Cloud cloud Label label Collection NodeProvisioner PlannedNode plannedNodes public void onComplete NodeProvisioner PlannedNode plannedNode Node node public void onFailure NodeProvisioner PlannedNode plannedNode Throwable t public static ExtensionList CloudProvisioningListener all return ExtensionList lookup CloudProvisioningListener classpackage hudson slaves import jenkins util SystemProperties import javax annotation concurrent GuardedBy import java io IOException import java util logging Logger import static hudson util TimeUnit2 import java util logging Level import static java util logging Level public class CloudRetentionStrategy extends RetentionStrategy AbstractCloudComputer private int idleMinutes public CloudRetentionStrategy int idleMinutes this idleMinutes idleMinutes Override GuardedBy hudson model Queue lock public long check final AbstractCloudComputer c final AbstractCloudSlave computerNode c getNode if c isIdle disabled computerNode null final long idleMilliseconds System currentTimeMillis c getIdleStartMilliseconds if idleMilliseconds MINUTES toMillis idleMinutes LOGGER log Level INFO Disconnecting 0 c getName try computerNode terminate catch InterruptedException e LOGGER log WARNING Failed to terminate c getName e catch IOException e LOGGER log WARNING Failed to terminate c getName e return 1 Override public void start AbstractCloudComputer c c connect false private static final Logger LOGGER Logger getLogger CloudRetentionStrategy class getName public static boolean disabled SystemProperties getBoolean CloudRetentionStrategy class getName disabledpackage hudson slaves import hudson model Computer import hudson model Node import hudson util TimeUnit2 import jenkins model Jenkins import javax annotation concurrent GuardedBy import java io IOException import java util logging Level import java util logging Logger import jenkins util SystemProperties public class CloudSlaveRetentionStrategy T extends Computer extends RetentionStrategy T Override GuardedBy hudson model Queue lock public long check T c if c isConnecting c isAcceptingTasks if isIdleForTooLong c try Node n c getNode if n null rare but n null if the node is deleted and being checked roughly at the same time kill n catch IOException e LOGGER log Level WARNING Failed to remove c getDisplayName e return checkCycle protected void kill Node n throws IOException Jenkins getInstance removeNode n protected long checkCycle return getIdleMaxTime 10 protected boolean isIdleForTooLong T c return System currentTimeMillis c getIdleStartMilliseconds getIdleMaxTime protected long getIdleMaxTime return TIMEOUT for debugging it s convenient to be able to reduce this time public static long TIMEOUT SystemProperties getLong CloudSlaveRetentionStrategy class getName timeout TimeUnit2 MINUTES toMillis 10 private static final Logger LOGGER Logger getLogger CloudSlaveRetentionStrategy class getNamepackage hudson search import java util Collection import java util List import java util Map public abstract class CollectionSearchIndex SMT extends SearchableModelObject implements SearchIndex protected abstract SearchItem get String key protected abstract Collection SMT all public void find String token List SearchItem result SearchItem p get token if p null result add p public void suggest String token List SearchItem result Collection SMT items all boolean isCaseSensitive UserSearchProperty isCaseInsensitive if isCaseSensitive token token toLowerCase if items null return for SMT o items String name getName o if isCaseSensitive name name toLowerCase if o null name contains token result add o protected String getName SMT o return o getDisplayNamepackage com twitter sdk android core services import com twitter sdk android core internal TwitterCollection import retrofit2 Call import retrofit2 http GET import retrofit2 http Query public interface CollectionService GET 1 1 collections entries json tweet mode extended include cards true cards platform TwitterKit 13 Call TwitterCollection collection Query id String id Query count Integer count Query max position Long maxPosition Query min position Long minPositionpackage com twitter sdk android tweetui import com twitter sdk android core Callback import com twitter sdk android core TwitterCore import com twitter sdk android core internal TwitterCollection import com twitter sdk android core Result import com twitter sdk android core TwitterException import com twitter sdk android core models Tweet import com twitter sdk android core models TweetBuilder import com twitter sdk android core models User import java util ArrayList import java util Collections import java util HashMap import java util List import java util Map import retrofit2 Call public class CollectionTimeline extends BaseTimeline implements Timeline Tweet static final String COLLECTION PREFIX custom private static final String SCRIBE SECTION collection final String collectionIdentifier final Integer maxItemsPerRequest CollectionTimeline TweetUi tweetUi Long collectionId Integer maxItemsPerRequest super tweetUi prefix the collection id with the collection prefix if collectionId null this collectionIdentifier null else this collectionIdentifier COLLECTION PREFIX Long toString collectionId this maxItemsPerRequest maxItemsPerRequest Override public void next Long minPosition Callback TimelineResult Tweet cb createCollectionRequest minPosition null enqueue new CollectionCallback cb Override public void previous Long maxPosition Callback TimelineResult Tweet cb createCollectionRequest null maxPosition enqueue new CollectionCallback cb Override String getTimelineType return SCRIBE SECTION Call TwitterCollection createCollectionRequest final Long minPosition final Long maxPosition return TwitterCore getInstance getApiClient getCollectionService collection collectionIdentifier maxItemsPerRequest maxPosition minPosition class CollectionCallback extends Callback TwitterCollection final Callback TimelineResult Tweet cb CollectionCallback Callback TimelineResult Tweet cb this cb cb Override public void success Result TwitterCollection result final TimelineCursor timelineCursor getTimelineCursor result data final List Tweet tweets getOrderedTweets result data final TimelineResult Tweet timelineResult if timelineCursor null timelineResult new TimelineResult timelineCursor tweets else timelineResult new TimelineResult null Collections Tweet emptyList if cb null cb success new Result timelineResult result response Override public void failure TwitterException exception if cb null cb failure exception static List Tweet getOrderedTweets TwitterCollection collection if collection null collection contents null collection contents tweetMap null collection contents userMap null collection metadata null collection metadata timelineItems null collection metadata position null return Collections emptyList final List Tweet tweets new ArrayList final Map Long Tweet tweetMap new HashMap for Tweet trimmedTweet collection contents tweetMap values read user id from the trimmed Tweet final Long userId trimmedTweet user id lookup User in the collection response s UserMap final User user collection contents userMap get userId build the Tweet with the hydrated User final Tweet tweet new TweetBuilder copy trimmedTweet setUser user build tweetMap put tweet id tweet for TwitterCollection TimelineItem item collection metadata timelineItems final Tweet tweet tweetMap get item tweetItem id tweets add tweet return tweets static TimelineCursor getTimelineCursor TwitterCollection twitterCollection if twitterCollection null twitterCollection metadata null twitterCollection metadata position null return null final Long minPosition twitterCollection metadata position minPosition final Long maxPosition twitterCollection metadata position maxPosition return new TimelineCursor minPosition maxPosition public static class Builder private final TweetUi tweetUi private Long collectionId private Integer maxItemsPerRequest 30 public Builder this TweetUi getInstance public Builder TweetUi tweetUi if tweetUi null throw new IllegalArgumentException TweetUi instance must not be null this tweetUi tweetUi public Builder id Long collectionId this collectionId collectionId return this public Builder maxItemsPerRequest Integer maxItemsPerRequest this maxItemsPerRequest maxItemsPerRequest return this public CollectionTimeline build if collectionId null throw new IllegalStateException collection id must not be null return new CollectionTimeline tweetUi collectionId maxItemsPerRequestpackage hudson util import org jfree chart renderer category LineAndShapeRenderer import java awt Color import java util List import java util Collections import java util Arrays public class ColorPalette public static final Color RED new Color 0xEF 0x29 0x29 public static final Color YELLOW new Color 0xFC 0xE9 0x4F public static final Color BLUE new Color 0x72 0x9F 0xCF public static final Color GREY new Color 0xAB 0xAB 0xAB public static List Color LINE GRAPH Collections unmodifiableList Arrays asList new Color 0xCC0000 new Color 0x3465a4 new Color 0x73d216 new Color 0xedd400 public static void apply LineAndShapeRenderer renderer int n 0 for Color c LINE GRAPH renderer setSeriesPaint n cpackage com twitter sdk android tweetui import android graphics Color final class ColorUtils private ColorUtils static int calculateOpacityTransform final double opacity final int overlayColor final int primaryColor final int redPrimary Color red primaryColor final int redOverlay Color red overlayColor final int greenPrimary Color green primaryColor final int greenOverlay Color green overlayColor final int bluePrimary Color blue primaryColor final int blueOverlay Color blue overlayColor final int redCalculated int 1 opacity redPrimary opacity redOverlay final int greenCalculated int 1 opacity greenPrimary opacity greenOverlay final int blueCalculated int 1 opacity bluePrimary opacity blueOverlay return Color rgb redCalculated greenCalculated blueCalculated static boolean isLightColor final int color final int r Color red color final int g Color green color final int b Color blue color final double threshold 0 21 r 0 72 g 0 07 b return threshold 128package com twitter sdk android mopub import android graphics Color import org junit Test import org junit runner RunWith import org robolectric RobolectricGradleTestRunner import org robolectric annotation Config import static org junit Assert assertEquals import static org junit Assert assertFalse import static org junit Assert assertTrue RunWith RobolectricGradleTestRunner class Config constants BuildConfig class sdk 21 public class ColorUtilsTest Test public void testIsLightColor black assertFalse ColorUtils isLightColor Color BLACK Test public void testIsLightColor white assertTrue ColorUtils isLightColor Color WHITE Test public void testDefaultCtaButtonIsDarkColor assertFalse ColorUtils isLightColor R color tw ad cta default Test public void testCtaTextColorIsLightForDarkBgColor assertEquals Color WHITE ColorUtils calculateCtaTextColor R color tw ad cta default assertEquals Color WHITE ColorUtils calculateCtaTextColor Color BLACK assertEquals Color WHITE ColorUtils calculateCtaTextColor Color DKGRAY Test public void testCtaTextColorIsDarkForLightBgColor assertTrue Color WHITE ColorUtils calculateCtaTextColor Color WHITE assertTrue Color WHITE ColorUtils calculateCtaTextColor Color LTGRAY Test public void testCTAOnTapColorIsLighterForDarkBgColor final int darkColor Color BLACK final int originalRed Color red darkColor final int originalGreen Color green darkColor final int originalBlue Color blue darkColor final int lighterColor ColorUtils calculateCtaOnTapColor darkColor final int lighterRed Color red lighterColor final int lighterGreen Color green lighterColor final int lighterBlue Color blue lighterColor assertTrue lighterRed originalRed lighterGreen originalGreen lighterBlue originalBlue Test public void testCTAOnTapColorIsDarkerForLightBgColor final int lightColor Color WHITE final int originalRed Color red lightColor final int originalGreen Color green lightColor final int originalBlue Color blue lightColor final int darkerColor ColorUtils calculateCtaOnTapColor lightColor final int darkerRed Color red darkerColor final int darkerGreen Color green darkerColor final int darkerBlue Color blue darkerColor assertTrue originalRed darkerRed originalGreen darkerGreen originalBlue darkerBlue Test public void testContrastColorForDarkColor final int darkColor Color BLACK final int contrastingLightColor ColorUtils calculateContrastingColor darkColor assertTrue ColorUtils isLightColor contrastingLightColor Test public void testContrastColorForLightColor final int lightColor Color WHITE final int contrastingDarkColor ColorUtils calculateContrastingColor lightColor assertFalse ColorUtils isLightColor contrastingDarkColorpackage hudson util import net sf json JSONArray import org kohsuke stapler HttpResponse import org kohsuke stapler StaplerRequest import org kohsuke stapler StaplerResponse import org kohsuke stapler export Flavor import javax servlet ServletException import java io IOException import java io PrintWriter import java util ArrayList import java util Collection import static java util Arrays asList public class ComboBoxModel extends ArrayList String implements HttpResponse public ComboBoxModel int initialCapacity super initialCapacity public ComboBoxModel public ComboBoxModel Collection extends String c super c public ComboBoxModel String values this asList values public void generateResponse StaplerRequest req StaplerResponse rsp Object node throws IOException ServletException rsp setContentType Flavor JSON contentType PrintWriter w rsp getWriter JSONArray fromObject this write wpackage hudson slaves import hudson EnvVars import hudson Extension import hudson model TaskListener import org jenkinsci Symbol import org kohsuke stapler DataBoundConstructor import java io IOException public class CommandConnector extends ComputerConnector public final String command DataBoundConstructor public CommandConnector String command this command command Override public CommandLauncher launch String host TaskListener listener throws IOException InterruptedException return new CommandLauncher command new EnvVars SLAVE host Extension Symbol command public static class DescriptorImpl extends ComputerConnectorDescriptor Override public String getDisplayName return Messages CommandLauncher displayNamepackage hudson cli import jenkins model Jenkins import hudson model Job import hudson model Run import jenkins security MasterToSlaveCallable import org kohsuke args4j CmdLineException import java io IOException public abstract class CommandDuringBuild extends CLICommand protected Run getCurrentlyBuilding throws CmdLineException Run r optCurrentlyBuilding if r null throw new IllegalStateException This CLI command works only when invoked from inside a build return r protected Run optCurrentlyBuilding throws CmdLineException try CLICommand c CLICommand getCurrent if c null throw new IllegalStateException Not executing a CLI command String envs c checkChannel call new GetCharacteristicEnvironmentVariables if envs 0 null envs 1 null return null Job j Jenkins getActiveInstance getItemByFullName envs 0 Job class if j null throw new IllegalArgumentException No such job envs 0 try Run r j getBuildByNumber Integer parseInt envs 1 if r null throw new IllegalArgumentException No such build envs 1 in envs 0 if r isBuilding throw new IllegalStateException r is not currently being built return r catch NumberFormatException e throw new IllegalArgumentException Invalid build number envs 1 catch IOException InterruptedException e throw new IllegalArgumentException Failed to identify the build being executed e private static final class GetCharacteristicEnvironmentVariables extends MasterToSlaveCallable String IOException public String call throws IOException return new String System getenv JOB NAME System getenv BUILD NUMBERpackage hudson tools import hudson Extension import hudson FilePath import hudson util LineEndingConversion import org jenkinsci Symbol import org kohsuke stapler DataBoundConstructor import java io ObjectStreamException public class CommandInstaller extends AbstractCommandInstaller DataBoundConstructor public CommandInstaller String label String command String toolHome super label LineEndingConversion convertEOL command LineEndingConversion EOLType Unix toolHome Override public String getCommandFileExtension return sh Override public String getCommandCall FilePath script String cmd sh e script getRemote return cmd private Object readResolve throws ObjectStreamException return new CommandInstaller getLabel getCommand getToolHome Extension Symbol command public static class DescriptorImpl extends Descriptor CommandInstaller Override public String getDisplayName return Messages CommandInstaller DescriptorImpl displayNamepackage hudson tasks import hudson FilePath import hudson Launcher import hudson Proc import hudson Util import hudson EnvVars import hudson model AbstractBuild import hudson model BuildListener import hudson model Node import hudson model Result import hudson model TaskListener import hudson remoting ChannelClosedException import java io IOException import java util Map import java util logging Level import java util logging Logger import javax annotation Nonnull public abstract class CommandInterpreter extends Builder protected final String command public CommandInterpreter String command this command command public final String getCommand return command Override public boolean perform AbstractBuild build Launcher launcher BuildListener listener throws InterruptedException return perform build launcher TaskListener listener protected boolean isErrorlevelForUnstableBuild int exitCode return false public boolean perform AbstractBuild build Launcher launcher TaskListener listener throws InterruptedException FilePath ws build getWorkspace if ws null Node node build getBuiltOn if node null throw new NullPointerException no such build node build getBuiltOnStr throw new NullPointerException no workspace from node node which is computer node toComputer and has channel node getChannel FilePath script null int r 1 try try script createScriptFile ws catch IOException e Util displayIOException e listener e printStackTrace listener fatalError Messages CommandInterpreter UnableToProduceScript return false try EnvVars envVars build getEnvironment listener on Windows environment variables are converted to all upper case but no such conversions are done on Unix so to make this cross platform convert variables to all upper cases for Map Entry String String e build getBuildVariables entrySet envVars put e getKey e getValue r join launcher launch cmds buildCommandLine script envs envVars stdout listener pwd ws start if isErrorlevelForUnstableBuild r build setResult Result UNSTABLE r 0 catch IOException e Util displayIOException e listener e printStackTrace listener fatalError Messages CommandInterpreter CommandFailed return r 0 finally try if script null script delete catch IOException e if r 1 e getCause instanceof ChannelClosedException JENKINS 5073 r 1 only when the execution of the command resulted in IOException and we ve already reported that error A common error there is channel losing a connection and in that case we don t want to confuse users by reporting the 2nd problem Technically the 1st exception may not be a channel closed error but that s rare enough and JENKINS 5073 is common enough that this suppressing of the error would be justified LOGGER log Level FINE Script deletion failed e else Util displayIOException e listener e printStackTrace listener fatalError Messages CommandInterpreter UnableToDelete script catch Exception e e printStackTrace listener fatalError Messages CommandInterpreter UnableToDelete script protected int join Proc p throws IOException InterruptedException return p join public FilePath createScriptFile Nonnull FilePath dir throws IOException InterruptedException return dir createTextTempFile hudson getFileExtension getContents false public abstract String buildCommandLine FilePath script protected abstract String getContents protected abstract String getFileExtension private static final Logger LOGGER Logger getLogger CommandInterpreter class getNamepackage hudson slaves import hudson AbortException import hudson EnvVars import hudson Util import hudson Extension import hudson model Descriptor import hudson model Slave import jenkins model Jenkins import hudson model TaskListener import hudson remoting Channel import hudson util StreamCopyThread import hudson util FormValidation import hudson util ProcessTree import java io IOException import java util Date import java util logging Level import java util logging Logger import org apache commons lang StringUtils import org jenkinsci Symbol import org kohsuke stapler DataBoundConstructor import org kohsuke stapler QueryParameter public class CommandLauncher extends ComputerLauncher private final String agentCommand private final EnvVars env DataBoundConstructor public CommandLauncher String command this command null public CommandLauncher String command EnvVars env this agentCommand command this env env public String getCommand return agentCommand private static String getTimestamp return String format 1 tD 1 tT new Date Override public void launch SlaveComputer computer final TaskListener listener EnvVars cookie null Process proc null try Slave node computer getNode if node null throw new AbortException Cannot launch commands on deleted nodes listener getLogger println hudson model Messages Slave Launching getTimestamp if getCommand trim length 0 listener getLogger println Messages CommandLauncher NoLaunchCommand return listener getLogger println getCommand ProcessBuilder pb new ProcessBuilder Util tokenize getCommand final EnvVars cookie cookie EnvVars createCookie pb environment putAll cookie pb environment put WORKSPACE StringUtils defaultString computer getAbsoluteRemoteFs node getRemoteFS path for local slave log system defined variables String rootUrl Jenkins getInstance getRootUrl if rootUrl null pb environment put HUDSON URL rootUrl for backward compatibility pb environment put JENKINS URL rootUrl pb environment put SLAVEJAR URL rootUrl jnlpJars slave jar if env null pb environment putAll env final Process proc proc pb start capture error information from stderr this will terminate itself when the process is killed new StreamCopyThread stderr copier for remote agent on computer getDisplayName proc getErrorStream listener getLogger start computer setChannel proc getInputStream proc getOutputStream listener getLogger new Channel Listener Override public void onClosed Channel channel IOException cause reportProcessTerminated proc listener try ProcessTree get killAll proc cookie catch InterruptedException e LOGGER log Level INFO interrupted e LOGGER info agent launched for computer getDisplayName catch InterruptedException e e printStackTrace listener error Messages ComputerLauncher abortedLaunch catch RuntimeException e e printStackTrace listener error Messages ComputerLauncher unexpectedError catch Error e e printStackTrace listener error Messages ComputerLauncher unexpectedError catch IOException e Util displayIOException e listener String msg Util getWin32ErrorMessage e if msg null msg else msg msg msg hudson model Messages Slave UnableToLaunch computer getDisplayName msg LOGGER log Level SEVERE msg e e printStackTrace listener error msg if proc null reportProcessTerminated proc listener try ProcessTree get killAll proc cookie catch InterruptedException x x printStackTrace listener error Messages ComputerLauncher abortedLaunch private static void reportProcessTerminated Process proc TaskListener listener try int exitCode proc exitValue listener error Process terminated with exit code exitCode catch IllegalThreadStateException e hasn t terminated yet private static final Logger LOGGER Logger getLogger CommandLauncher class getName Extension Symbol command public static class DescriptorImpl extends Descriptor ComputerLauncher public String getDisplayName return Messages CommandLauncher displayName public FormValidation doCheckCommand QueryParameter String value if Util fixEmptyAndTrim value null return FormValidation error Messages CommandLauncher NoLaunchCommand else return FormValidation okpackage com twitter sdk android tweetui import android content Context import android util AttributeSet import com twitter sdk android core models MediaEntity import com twitter sdk android core models Tweet public class CompactTweetView extends BaseTweetView private static final String VIEW TYPE NAME compact private static final double SQUARE ASPECT RATIO 1 0 private static final double MAX LANDSCAPE ASPECT RATIO 3 0 private static final double MIN LANDSCAPE ASPECT RATIO 4 0 3 0 public CompactTweetView Context context Tweet tweet super context tweet public CompactTweetView Context context Tweet tweet int styleResId super context tweet styleResId CompactTweetView Context context Tweet tweet int styleResId DependencyProvider dependencyProvider super context tweet styleResId dependencyProvider public CompactTweetView Context context AttributeSet attrs super context attrs public CompactTweetView Context context AttributeSet attrs int defStyle super context attrs defStyle Override protected int getLayout return R layout tw tweet compact Override void render super render Redraw screen name on recycle screenNameView requestLayout Override protected double getAspectRatio MediaEntity photoEntity final double ratio super getAspectRatio photoEntity if ratio SQUARE ASPECT RATIO portrait tall photos should be cropped to be square aspect ratio return SQUARE ASPECT RATIO else if ratio MAX LANDSCAPE ASPECT RATIO the widest landscape photos allowed are 3 1 return MAX LANDSCAPE ASPECT RATIO else if ratio MIN LANDSCAPE ASPECT RATIO the tallest landscape photos allowed are 4 3 return MIN LANDSCAPE ASPECT RATIO else landscape photos between 3 1 to 4 3 present the original width to height ratio return ratio Override String getViewTypeName return VIEW TYPE NAMEpackage jenkins diagnostics import hudson Extension import hudson init InitMilestone import hudson model AdministrativeMonitor import jenkins model Jenkins import org jenkinsci Symbol import org kohsuke accmod Restricted import org kohsuke accmod restrictions NoExternalUse Restricted NoExternalUse class Extension Symbol completedInitialization public class CompletedInitializationMonitor extends AdministrativeMonitor Override public String getDisplayName return Messages CompletedInitializationMonitor DisplayName Override public boolean isActivated final Jenkins instance Jenkins getInstance Safe to check in such way because monitors are being checked in UI only So Jenkins class construction and initialization must be always finished by the call of this extension return instance getInitLevel InitMilestone COMPLETEDpackage com twitter sdk android tweetcomposer import android app Activity import android content Context import android content Intent import android os Bundle import com twitter Regex import com twitter sdk android core TwitterAuthToken import com twitter sdk android core TwitterSession public class ComposerActivity extends Activity static final String EXTRA USER TOKEN EXTRA USER TOKEN static final String EXTRA CARD EXTRA CARD static final String EXTRA THEME EXTRA THEME static final String EXTRA HASHTAGS EXTRA HASHTAGS private static final int PLACEHOLDER ID 1 private static final String PLACEHOLDER SCREEN NAME Override protected void onCreate Bundle savedInstanceState super onCreate savedInstanceState final Intent intent getIntent final TwitterAuthToken token intent getParcelableExtra EXTRA USER TOKEN final TwitterSession session new TwitterSession token PLACEHOLDER ID PLACEHOLDER SCREEN NAME final Card card Card intent getSerializableExtra EXTRA CARD final String hashtags intent getStringExtra EXTRA HASHTAGS final int themeResId intent getIntExtra EXTRA THEME R style ComposerLight setTheme themeResId setContentView R layout tw activity composer final ComposerView composerView ComposerView findViewById R id tw composer view new ComposerController composerView session card hashtags new FinisherImpl interface Finisher void finish FinisherImpl allows sub components to finish the host Activity class FinisherImpl implements Finisher Override public void finish ComposerActivity this finish public static class Builder private final Context context private TwitterAuthToken token private int themeResId R style ComposerLight private Card card private String hashtags public Builder Context context if context null throw new IllegalArgumentException Context must not be null this context context public Builder session TwitterSession session if session null throw new IllegalArgumentException TwitterSession must not be null final TwitterAuthToken token session getAuthToken if token null throw new IllegalArgumentException TwitterSession token must not be null session passed via the parcelable auth token this token token return this public Builder card Card card this card card return this public Builder hashtags String hashtags if hashtags null return this final StringBuilder sb new StringBuilder for String hashtag hashtags final boolean isValid Regex VALID HASHTAG matcher hashtag find if isValid sb append append hashtag this hashtags sb length 0 null sb toString return this public Builder darkTheme themeResId R style ComposerDark return this public Intent createIntent if token null throw new IllegalStateException Must set a TwitterSession final Intent intent new Intent context ComposerActivity class intent putExtra EXTRA USER TOKEN token intent putExtra EXTRA CARD card intent putExtra EXTRA THEME themeResId intent putExtra EXTRA HASHTAGS hashtags return intentpackage com twitter sdk android tweetcomposer import com twitter sdk android core TwitterApiClient import com twitter sdk android core TwitterSession import com twitter sdk android tweetcomposer internal CardService class ComposerApiClient extends TwitterApiClient ComposerApiClient TwitterSession session super session StatusesService getComposerStatusesService return getService StatusesService class CardService getCardService return getService CardService classpackage com twitter sdk android tweetcomposer import android content Intent import android text TextUtils import android view View import com twitter Validator import com twitter sdk android core Callback import com twitter sdk android core Result import com twitter sdk android core TwitterApiClient import com twitter sdk android core TwitterCore import com twitter sdk android core TwitterException import com twitter sdk android core TwitterSession import com twitter sdk android core internal TwitterApiConstants import com twitter sdk android core models User class ComposerController final ComposerView composerView final TwitterSession session final Card card final ComposerActivity Finisher finisher final DependencyProvider dependencyProvider ComposerController final ComposerView composerView TwitterSession session Card card String hashtags ComposerActivity Finisher finisher this composerView session card hashtags finisher new DependencyProvider testing purposes ComposerController final ComposerView composerView TwitterSession session Card card String hashtags ComposerActivity Finisher finisher DependencyProvider dependencyProvider this composerView composerView this session session this card card this finisher finisher this dependencyProvider dependencyProvider composerView setCallbacks new ComposerCallbacksImpl composerView setTweetText hashtags setProfilePhoto setCardView card dependencyProvider getScribeClient impression card void setProfilePhoto dependencyProvider getApiClient session getAccountService verifyCredentials false true enqueue new Callback User Override public void success Result User result composerView setProfilePhotoView result data Override public void failure TwitterException exception show placeholder background color composerView setProfilePhotoView null void setCardView Card card if card null final CardViewFactory cardViewFactory dependencyProvider getCardViewFactory final View view cardViewFactory createCard composerView getContext card composerView setCardView view public interface ComposerCallbacks void onTextChanged String text void onTweetPost String text void onCloseClick class ComposerCallbacksImpl implements ComposerCallbacks Override public void onTextChanged String text final int charCount tweetTextLength text composerView setCharCount remainingCharCount charCount character count overflow red color if isTweetTextOverflow charCount composerView setCharCountTextStyle R style tw ComposerCharCountOverflow else composerView setCharCountTextStyle R style tw ComposerCharCount Tweet post button enable disable composerView postTweetEnabled isPostEnabled charCount Override public void onTweetPost String text dependencyProvider getScribeClient click card ScribeConstants SCRIBE TWEET ELEMENT final Intent intent new Intent composerView getContext TweetUploadService class intent putExtra TweetUploadService EXTRA USER TOKEN session getAuthToken intent putExtra TweetUploadService EXTRA TWEET TEXT text intent putExtra TweetUploadService EXTRA TWEET CARD card composerView getContext startService intent finisher finish Override public void onCloseClick dependencyProvider getScribeClient click card ScribeConstants SCRIBE CANCEL ELEMENT finisher finish int tweetTextLength String text if TextUtils isEmpty text return 0 return dependencyProvider getTweetValidator getTweetLength text static int remainingCharCount int charCount return TwitterApiConstants MAX TWEET CHARS charCount static boolean isPostEnabled int charCount return charCount 0 charCount TwitterApiConstants MAX TWEET CHARS static boolean isTweetTextOverflow int charCount return charCount TwitterApiConstants MAX TWEET CHARS static class DependencyProvider final CardViewFactory cardViewFactory new CardViewFactory final Validator tweetValidator new Validator TwitterApiClient getApiClient TwitterSession session return TwitterCore getInstance getApiClient session CardViewFactory getCardViewFactory return cardViewFactory Validator getTweetValidator return tweetValidator ComposerScribeClient getScribeClient return new ComposerScribeClientImpl TweetComposer getInstance getScribeClientpackage com twitter sdk android tweetcomposer interface ComposerScribeClient void impression Card card void click Card card String elementpackage com twitter sdk android tweetcomposer import com twitter sdk android core internal scribe EventNamespace import com twitter sdk android core internal scribe ScribeItem import java util ArrayList import java util List class ComposerScribeClientImpl implements ComposerScribeClient private final ScribeClient scribeClient ComposerScribeClientImpl ScribeClient scribeClient if scribeClient null throw new NullPointerException scribeClient must not be null this scribeClient scribeClient Override public void impression Card card final EventNamespace ns ScribeConstants ComposerEventBuilder setComponent ScribeConstants SCRIBE COMPONENT setElement ScribeConstants SCRIBE IMPRESSION ELEMENT setAction ScribeConstants SCRIBE IMPRESSION ACTION builder final List ScribeItem items new ArrayList items add ScribeConstants newCardScribeItem card scribeClient scribe ns items Override public void click Card card String element final EventNamespace ns ScribeConstants ComposerEventBuilder setComponent ScribeConstants SCRIBE COMPONENT setElement element setAction ScribeConstants SCRIBE CLICK ACTION builder final List ScribeItem items new ArrayList items add ScribeConstants newCardScribeItem card scribeClient scribe ns itemspackage com twitter sdk android tweetcomposer import android content Context import android graphics drawable ColorDrawable import android text Editable import android text TextWatcher import android util AttributeSet import android view KeyEvent import android view View import android view ViewGroup import android widget Button import android widget EditText import android widget ImageView import android widget LinearLayout import android widget TextView import com squareup picasso Picasso import com twitter sdk android core internal UserUtils import com twitter sdk android core internal util ObservableScrollView import com twitter sdk android core models User import java util Locale public class ComposerView extends LinearLayout ImageView avatarView ImageView closeView EditText tweetEditView TextView charCountView Button tweetButton ObservableScrollView scrollView View divider styled drawables for images ColorDrawable mediaBg callbacks ViewGroup cardView ComposerController ComposerCallbacks callbacks private Picasso imageLoader public ComposerView Context context this context null public ComposerView Context context AttributeSet attrs super context attrs init context public ComposerView Context context AttributeSet attrs int defStyle super context attrs defStyle init context private void init Context context imageLoader Picasso with getContext TODO make color vary depending on the style mediaBg new ColorDrawable context getResources getColor R color tw composer light gray inflate context R layout tw composer view this Override protected void onFinishInflate super onFinishInflate findSubviews closeView setOnClickListener new OnClickListener Override public void onClick View view callbacks onCloseClick tweetButton setOnClickListener new OnClickListener Override public void onClick View view callbacks onTweetPost getTweetText tweetEditView setOnEditorActionListener new TextView OnEditorActionListener Override public boolean onEditorAction TextView textView int i KeyEvent keyEvent callbacks onTweetPost getTweetText return true tweetEditView addTextChangedListener new TextWatcher Override public void beforeTextChanged CharSequence charSequence int i int i1 int i2 Override public void onTextChanged CharSequence charSequence int i int i1 int i2 Override public void afterTextChanged Editable editable callbacks onTextChanged getTweetText scrollView setScrollViewListener new ObservableScrollView ScrollViewListener Override public void onScrollChanged int scrollY if scrollY 0 divider setVisibility View VISIBLE else divider setVisibility View INVISIBLE void findSubviews avatarView ImageView findViewById R id tw author avatar closeView ImageView findViewById R id tw composer close tweetEditView EditText findViewById R id tw edit tweet charCountView TextView findViewById R id tw char count tweetButton Button findViewById R id tw post tweet scrollView ObservableScrollView findViewById R id tw composer scroll view divider findViewById R id tw composer profile divider cardView ViewGroup findViewById R id tw card view void setCallbacks ComposerController ComposerCallbacks callbacks this callbacks callbacks void setProfilePhotoView User user final String url UserUtils getProfileImageUrlHttps user UserUtils AvatarSize REASONABLY SMALL if imageLoader null Passing null url will not trigger any request but will set the placeholder bg imageLoader load url placeholder mediaBg into avatarView String getTweetText return tweetEditView getText toString void setTweetText String text tweetEditView setText text void setCharCount int remainingCount charCountView setText String format Locale getDefault d remainingCount void setCharCountTextStyle int textStyleResId charCountView setTextAppearance getContext textStyleResId void postTweetEnabled boolean enabled tweetButton setEnabled enabled void setCardView View card cardView addView card cardView setVisibility View VISIBLEpackage hudson util import java util Arrays import java util Enumeration import java util Iterator import java util NoSuchElementException public class CompoundEnumeration T implements Enumeration T private final Iterator Enumeration extends T base private Enumeration extends T cur public CompoundEnumeration Enumeration e this Iterable Arrays asList e public CompoundEnumeration Iterable Enumeration extends T e this base e iterator public boolean hasMoreElements while cur hasMoreElements base hasNext cur base next return cur hasMoreElements public T nextElement throws NoSuchElementException return cur nextElementpackage hudson util import hudson Util import java io File import java io FileInputStream import java io FileNotFoundException import java io FileOutputStream import java io IOException import java io InputStream import java io InputStreamReader import java io OutputStream import java io Reader import java util concurrent ExecutorService import java util concurrent LinkedBlockingQueue import java util concurrent ThreadPoolExecutor import java util concurrent TimeUnit import java util logging Level import java util logging Logger import com jcraft jzlib GZIPInputStream import com jcraft jzlib GZIPOutputStream public class CompressedFile private final File file private final File gz public CompressedFile File file this file file this gz new File file getParentFile file getName gz public OutputStream write throws FileNotFoundException if gz exists gz delete return new FileOutputStream file public InputStream read throws IOException if file exists return new FileInputStream file check if the compressed file exists if gz exists return new GZIPInputStream new FileInputStream gz no such file throw new FileNotFoundException file getName public String loadAsString throws IOException long sizeGuess if file exists sizeGuess file length else if gz exists sizeGuess gz length 2 else return StringBuilder str new StringBuilder int sizeGuess Reader r new InputStreamReader read try char buf new char 8192 int len while len r read buf 0 buf length 0 str append buf 0 len finally IOUtils closeQuietly r return str toString public void compress compressionThread submit new Runnable public void run try try InputStream in read OutputStream out new GZIPOutputStream new FileOutputStream gz Util copyStream in out if the compressed file is created successfully remove the original file delete catch IOException e LOGGER log Level WARNING Failed to compress file e gz delete in case a processing is left in the middle private static final ExecutorService compressionThread new ThreadPoolExecutor 0 1 5L TimeUnit SECONDS new LinkedBlockingQueue Runnable new ExceptionCatchingThreadFactory new NamingThreadFactory new DaemonThreadFactory CompressedFile private static final Logger LOGGER Logger getLogger CompressedFile class getNamepackage hudson model import hudson EnvVars import hudson Extension import hudson Launcher ProcStarter import jenkins util SystemProperties import hudson Util import hudson cli declarative CLIMethod import hudson cli declarative CLIResolver import hudson console AnnotatedLargeText import hudson init Initializer import hudson model Descriptor FormException import hudson model Queue FlyweightTask import hudson model labels LabelAtom import hudson model queue WorkUnit import hudson node monitors NodeMonitor import hudson remoting Channel import hudson remoting VirtualChannel import hudson security ACL import hudson security AccessControlled import hudson security Permission import hudson security PermissionGroup import hudson security PermissionScope import hudson slaves AbstractCloudSlave import hudson slaves ComputerLauncher import hudson slaves ComputerListener import hudson slaves NodeProperty import hudson slaves RetentionStrategy import hudson slaves WorkspaceList import hudson slaves OfflineCause import hudson slaves OfflineCause ByCLI import hudson util DaemonThreadFactory import hudson util EditDistance import hudson util ExceptionCatchingThreadFactory import hudson util RemotingDiagnostics import hudson util RemotingDiagnostics HeapDump import hudson util RunList import hudson util Futures import hudson util NamingThreadFactory import jenkins model Jenkins import jenkins util ContextResettingExecutorService import jenkins security MasterToSlaveCallable import org jenkins ui icon Icon import org jenkins ui icon IconSet import org kohsuke accmod Restricted import org kohsuke accmod restrictions DoNotUse import org kohsuke accmod restrictions NoExternalUse import org kohsuke args4j Argument import org kohsuke args4j CmdLineException import org kohsuke stapler Stapler import org kohsuke stapler StaplerRequest import org kohsuke stapler StaplerResponse import org kohsuke stapler QueryParameter import org kohsuke stapler HttpResponses import org kohsuke stapler HttpResponse import org kohsuke stapler HttpRedirect import org kohsuke stapler WebMethod import org kohsuke stapler export Exported import org kohsuke stapler export ExportedBean import org kohsuke args4j Option import org kohsuke stapler interceptor RequirePOST import javax annotation OverridingMethodsMustInvokeSuper import javax annotation concurrent GuardedBy import javax servlet ServletException import java io File import java io FilenameFilter import java io IOException import java io InputStream import java io PrintWriter import java io StringWriter import java util import java util concurrent CopyOnWriteArrayList import java util concurrent ExecutorService import java util concurrent Executors import java util concurrent Future import java util concurrent ExecutionException import java util logging LogRecord import java util logging Level import java util logging Logger import java nio charset Charset import java net InetAddress import java net NetworkInterface import java net Inet4Address import java util regex Matcher import java util regex Pattern import javax annotation CheckForNull import javax annotation Nonnull import javax annotation Nullable import static javax servlet http HttpServletResponse ExportedBean public abstract class Computer extends Actionable implements AccessControlled ExecutorListener private final CopyOnWriteArrayList Executor executors new CopyOnWriteArrayList Executor TODO private final CopyOnWriteArrayList OneOffExecutor oneOffExecutors new CopyOnWriteArrayList OneOffExecutor private int numExecutors protected volatile OfflineCause offlineCause private long connectTime 0 private boolean temporarilyOffline protected String nodeName private volatile String cachedHostName private volatile boolean hostNameCached private volatile EnvVars cachedEnvironment private final WorkspaceList workspaceList new WorkspaceList protected transient List Action transientActions protected final Object statusChangeLock new Object private transient final List TerminationRequest terminatedBy Collections synchronizedList new ArrayList TerminationRequest public void recordTermination StaplerRequest request Stapler getCurrentRequest if request null terminatedBy add new TerminationRequest String format Termination requested at s by s id d from HTTP request for s new Date Thread currentThread Thread currentThread getId request getRequestURL else terminatedBy add new TerminationRequest String format Termination requested at s by s id d new Date Thread currentThread Thread currentThread getId public List TerminationRequest getTerminatedBy return new ArrayList TerminationRequest terminatedBy public Computer Node node setNode node public List ComputerPanelBox getComputerPanelBoxs return ComputerPanelBox all this SuppressWarnings deprecation public List Action getActions List Action result new ArrayList Action result addAll super getActions synchronized this if transientActions null transientActions TransientComputerActionFactory createAllFor this result addAll transientActions return Collections unmodifiableList result SuppressWarnings deprecation Override public void addAction Action a if a null throw new IllegalArgumentException super getActions add a public Nonnull File getLogFile return new File getLogDir slave log protected Nonnull File getLogDir File dir new File Jenkins getInstance getRootDir logs slaves nodeName if dir exists dir mkdirs LOGGER severe Failed to create agent log directory dir getAbsolutePath return dir public WorkspaceList getWorkspaceList return workspaceList public String getLog throws IOException return Util loadFile getLogFile public AnnotatedLargeText Computer getLogText return new AnnotatedLargeText Computer getLogFile Charset defaultCharset false this public ACL getACL return Jenkins getInstance getAuthorizationStrategy getACL this public void checkPermission Permission permission getACL checkPermission permission public boolean hasPermission Permission permission return getACL hasPermission permission Exported public OfflineCause getOfflineCause return offlineCause Exported public String getOfflineCauseReason if offlineCause null return fetch the localized string for Disconnected By String gsub base hudson slaves Messages SlaveComputer DisconnectedBy regex to remove commented reason base string String gsub1 gsub base w W regex to remove non commented reason base string String gsub2 gsub base w W String newString offlineCause toString replaceAll gsub1 return newString replaceAll gsub2 public abstract Nullable VirtualChannel getChannel public abstract Charset getDefaultCharset public abstract List LogRecord getLogRecords throws IOException InterruptedException public abstract void doLaunchSlaveAgent StaplerRequest req StaplerResponse rsp throws IOException ServletException Deprecated public final void launch connect true public final Future connect boolean forceReconnect connectTime System currentTimeMillis return connect forceReconnect protected abstract Future connect boolean forceReconnect Deprecated public void cliConnect boolean force throws ExecutionException InterruptedException checkPermission CONNECT connect force get public final long getConnectTime return connectTime public Future disconnect OfflineCause cause recordTermination offlineCause cause if Util isOverridden Computer class getClass disconnect return disconnect legacy subtypes that extend disconnect connectTime 0 return Futures precomputed null Deprecated public Future disconnect recordTermination if Util isOverridden Computer class getClass disconnect OfflineCause class if the subtype already derives disconnect OfflineCause delegate to it return disconnect null connectTime 0 return Futures precomputed null Deprecated public void cliDisconnect String cause throws ExecutionException InterruptedException checkPermission DISCONNECT disconnect new ByCLI cause get Deprecated public void cliOffline String cause throws ExecutionException InterruptedException checkPermission DISCONNECT setTemporarilyOffline true new ByCLI cause Deprecated public void cliOnline throws ExecutionException InterruptedException checkPermission CONNECT setTemporarilyOffline false null ugly name to let EL access this Exported public int getNumExecutors return numExecutors public Nonnull String getName return nodeName null nodeName public abstract CheckForNull Boolean isUnix CheckForNull public Node getNode Jenkins j Jenkins getInstanceOrNull TODO confirm safe to assume non null and use getInstance if j null return null if nodeName null return j return j getNode nodeName Exported public LoadStatistics getLoadStatistics return LabelAtom get nodeName null nodeName Jenkins getInstance getSelfLabel toString loadStatistics public BuildTimelineWidget getTimeline return new BuildTimelineWidget getBuilds Override public void taskAccepted Executor executor Queue Task task dummy implementation Override public void taskCompleted Executor executor Queue Task task long durationMS dummy implementation Override public void taskCompletedWithProblems Executor executor Queue Task task long durationMS Throwable problems dummy implementation Exported public boolean isOffline return temporarilyOffline getChannel null public final boolean isOnline return isOffline Exported public boolean isManualLaunchAllowed return getRetentionStrategy isManualLaunchAllowed this public abstract boolean isConnecting Exported Deprecated public boolean isJnlpAgent return false Exported public boolean isLaunchSupported return true Exported Deprecated public boolean isTemporarilyOffline return temporarilyOffline Deprecated public void setTemporarilyOffline boolean temporarilyOffline setTemporarilyOffline temporarilyOffline null public void setTemporarilyOffline boolean temporarilyOffline OfflineCause cause offlineCause temporarilyOffline cause null this temporarilyOffline temporarilyOffline Node node getNode if node null node setTemporaryOfflineCause offlineCause synchronized statusChangeLock statusChangeLock notifyAll for ComputerListener cl ComputerListener all if temporarilyOffline cl onTemporarilyOffline this cause else cl onTemporarilyOnline this Exported public String getIcon if isOffline return computer x png else return computer png Exported public String getIconClassName if isOffline return icon computer x else return icon computer public String getIconAltText if isOffline return offline else return online Exported Override public Nonnull String getDisplayName return nodeName public String getCaption return Messages Computer Caption nodeName public String getUrl return computer Util rawEncode getName public List AbstractProject getTiedJobs Node node getNode return node null node getSelfLabel getTiedJobs Collections EMPTY LIST public RunList getBuilds return new RunList Jenkins getInstance getAllItems Job class node getNode protected void setNode Node node assert node null if node instanceof Slave this nodeName node getNodeName else this nodeName null setNumExecutors node getNumExecutors if this temporarilyOffline When we get a new node push our current temp offline status to it as the status is not carried across configuration changes that recreate the node Since this is also called the very first time this Computer is created avoid pushing an empty status as that could overwrite any status that the Node brought along from its persisted config data node setTemporaryOfflineCause this offlineCause protected void kill On most code paths this should already be zero and thus this next call becomes a no op and more importantly it will not acquire a lock on the Queue not that the lock is bad more that the lock may delay unnecessarily setNumExecutors 0 Restricted NoExternalUse class GuardedBy hudson model Queue lock void inflictMortalWound setNumExecutors 0 protected void onRemoved GuardedBy hudson model Queue lock private void setNumExecutors int n this numExecutors n final int diff executors size n if diff 0 we have too many executors send signal to all idle executors to potentially kill them off need the Queue maintenance lock held to prevent concurrent job assignment on the idle executors Queue withLock new Runnable Override public void run for Executor e executors if e isIdle e interrupt if diff 0 if the number is increased add new ones addNewExecutorIfNecessary private void addNewExecutorIfNecessary Set Integer availableNumbers new HashSet Integer for int i 0 i numExecutors i availableNumbers add i for Executor executor executors availableNumbers remove executor getNumber for Integer number availableNumbers if executors size numExecutors Executor e new Executor this number executors add e public int countIdle int n 0 for Executor e executors if e isIdle n return n public final int countBusy return countExecutors countIdle public final int countExecutors return executors size Exported public List Executor getExecutors return new ArrayList Executor executors Exported public List OneOffExecutor getOneOffExecutors return new ArrayList OneOffExecutor oneOffExecutors Restricted NoExternalUse class public List DisplayExecutor getDisplayExecutors The size may change while we are populating but let s start with a reasonable guess to minimize resizing List DisplayExecutor result new ArrayList DisplayExecutor executors size oneOffExecutors size int index 0 for Executor e executors if e isDisplayCell result add new DisplayExecutor Integer toString index 1 String format executors d index e index index 0 for OneOffExecutor e oneOffExecutors if e isDisplayCell result add new DisplayExecutor String format oneOffExecutors d index e index return result Exported public final boolean isIdle if oneOffExecutors isEmpty return false for Executor e executors if e isIdle return false return true public final boolean isPartiallyIdle for Executor e executors if e isIdle return true return false public final long getIdleStartMilliseconds long firstIdle Long MIN VALUE for Executor e oneOffExecutors firstIdle Math max firstIdle e getIdleStartMilliseconds for Executor e executors firstIdle Math max firstIdle e getIdleStartMilliseconds return firstIdle public final long getDemandStartMilliseconds long firstDemand Long MAX VALUE for Queue BuildableItem item Jenkins getInstance getQueue getBuildableItems this firstDemand Math min item buildableStartMilliseconds firstDemand return firstDemand protected void removeExecutor final Executor e final Runnable task new Runnable Override public void run synchronized Computer this executors remove e addNewExecutorIfNecessary if isAlive AbstractCIBase ciBase Jenkins getInstanceOrNull if ciBase null TODO confirm safe to assume non null and use getInstance ciBase removeComputer Computer this if Queue tryWithLock task JENKINS 28840 if we couldn t get the lock push the operation to a separate thread to avoid deadlocks threadPoolForRemoting submit Queue wrapWithLock task protected boolean isAlive for Executor e executors if e isActive return true return false public void interrupt Queue withLock new Runnable Override public void run for Executor e executors e interruptForShutdown public String getSearchUrl return getUrl public abstract RetentionStrategy getRetentionStrategy Exported inline true public Map String Object getMonitorData Map String Object r new HashMap String Object for NodeMonitor monitor NodeMonitor getAll r put monitor getClass getName monitor data this return r public Map Object Object getSystemProperties throws IOException InterruptedException return RemotingDiagnostics getSystemProperties getChannel Deprecated public Map String String getEnvVars throws IOException InterruptedException return getEnvironment public EnvVars getEnvironment throws IOException InterruptedException EnvVars cachedEnvironment this cachedEnvironment if cachedEnvironment null return new EnvVars cachedEnvironment cachedEnvironment EnvVars getRemote getChannel this cachedEnvironment cachedEnvironment return new EnvVars cachedEnvironment public Nonnull EnvVars buildEnvironment Nonnull TaskListener listener throws IOException InterruptedException EnvVars env new EnvVars Node node getNode if node null return env bail out for NodeProperty nodeProperty Jenkins getInstance getGlobalNodeProperties nodeProperty buildEnvVars env listener for NodeProperty nodeProperty node getNodeProperties nodeProperty buildEnvVars env listener TODO hmm they don t really belong String rootUrl Jenkins getInstance getRootUrl if rootUrl null env put HUDSON URL rootUrl Legacy env put JENKINS URL rootUrl return env public Map String String getThreadDump throws IOException InterruptedException return RemotingDiagnostics getThreadDump getChannel public HeapDump getHeapDump throws IOException return new HeapDump this getChannel public String getHostName throws IOException InterruptedException if hostNameCached in the worst case we end up having multiple threads computing the host name simultaneously but that s not harmful just wasteful return cachedHostName VirtualChannel channel getChannel if channel null return null can t compute right now for String address channel call new ListPossibleNames try InetAddress ia InetAddress getByName address if ia instanceof Inet4Address LOGGER log Level FINE 0 is not an IPv4 address address continue if ComputerPinger checkIsReachable ia 3 LOGGER log Level FINE 0 didn t respond to ping address continue cachedHostName ia getCanonicalHostName hostNameCached true return cachedHostName catch IOException e if a given name fails to parse on this host we get this error LogRecord lr new LogRecord Level FINE Failed to parse 0 lr setThrown e lr setParameters new Object address LOGGER log lr allow the administrator to manually specify the host name as a fallback HUDSON 5373 cachedHostName channel call new GetFallbackName hostNameCached true return cachedHostName final void startFlyWeightTask WorkUnit p OneOffExecutor e new OneOffExecutor this e start p oneOffExecutors add e final void remove OneOffExecutor e oneOffExecutors remove e private static class ListPossibleNames extends MasterToSlaveCallable List String IOException private static final Logger LOGGER Logger getLogger ListPossibleNames class getName public List String call throws IOException List String names new ArrayList String Enumeration NetworkInterface nis NetworkInterface getNetworkInterfaces while nis hasMoreElements NetworkInterface ni nis nextElement LOGGER log Level FINE Listing up IP addresses for 0 ni getDisplayName Enumeration InetAddress e ni getInetAddresses while e hasMoreElements InetAddress ia e nextElement if ia isLoopbackAddress LOGGER log Level FINE 0 is a loopback address ia continue if ia instanceof Inet4Address LOGGER log Level FINE 0 is not an IPv4 address ia continue LOGGER log Level FINE 0 is a viable candidate ia names add ia getHostAddress return names private static final long serialVersionUID 1L private static class GetFallbackName extends MasterToSlaveCallable String IOException public String call throws IOException return SystemProperties getString host name private static final long serialVersionUID 1L public static final ExecutorService threadPoolForRemoting new ContextResettingExecutorService Executors newCachedThreadPool new ExceptionCatchingThreadFactory new NamingThreadFactory new DaemonThreadFactory Computer threadPoolForRemoting UI public void doRssAll StaplerRequest req StaplerResponse rsp throws IOException ServletException rss req rsp all builds getBuilds public void doRssFailed StaplerRequest req StaplerResponse rsp throws IOException ServletException rss req rsp failed builds getBuilds failureOnly private void rss StaplerRequest req StaplerResponse rsp String suffix RunList runs throws IOException ServletException RSS forwardToRss getDisplayName suffix getUrl runs newBuilds Run FEED ADAPTER req rsp RequirePOST public HttpResponse doToggleOffline QueryParameter String offlineMessage throws IOException ServletException if temporarilyOffline checkPermission DISCONNECT offlineMessage Util fixEmptyAndTrim offlineMessage setTemporarilyOffline temporarilyOffline new OfflineCause UserCause User current offlineMessage else checkPermission CONNECT setTemporarilyOffline temporarilyOffline null return HttpResponses redirectToDot RequirePOST public HttpResponse doChangeOfflineCause QueryParameter String offlineMessage throws IOException ServletException checkPermission DISCONNECT offlineMessage Util fixEmptyAndTrim offlineMessage setTemporarilyOffline true new OfflineCause UserCause User current offlineMessage return HttpResponses redirectToDot public Api getApi return new Api this public void doDumpExportTable StaplerRequest req StaplerResponse rsp throws IOException ServletException InterruptedException this is a debug probe and may expose sensitive information checkPermission Jenkins ADMINISTER rsp setContentType text plain try PrintWriter w new PrintWriter rsp getCompressedWriter req VirtualChannel vc getChannel if vc instanceof Channel w println Master to slave Channel vc dumpExportTable w w flush flush here once so that even if the dump from the agent fails the client gets some useful info w println n n nSlave to master w print vc call new DumpExportTableTask else w println Messages Computer BadChannel private static final class DumpExportTableTask extends MasterToSlaveCallable String IOException public String call throws IOException StringWriter sw new StringWriter PrintWriter pw new PrintWriter sw Channel current dumpExportTable pw pw close return sw toString public void doScript StaplerRequest req StaplerResponse rsp throws IOException ServletException doScript req rsp script jelly public void doScriptText StaplerRequest req StaplerResponse rsp throws IOException ServletException doScript req rsp scriptText jelly protected void doScript StaplerRequest req StaplerResponse rsp String view throws IOException ServletException Jenkins doScript req rsp req getView this view getChannel getACL RequirePOST public void doConfigSubmit StaplerRequest req StaplerResponse rsp throws IOException ServletException FormException checkPermission CONFIGURE String proposedName Util fixEmptyAndTrim req getSubmittedForm getString name Jenkins checkGoodName proposedName Node node getNode if node null throw new ServletException No such node nodeName if proposedName equals nodeName Jenkins getActiveInstance getNode proposedName null throw new FormException Messages ComputerSet SlaveAlreadyExists proposedName name Node result node reconfigure req req getSubmittedForm Jenkins getInstance getNodesObject replaceNode this getNode result take the user back to the agent top page rsp sendRedirect2 result getNodeName WebMethod name config xml public void doConfigDotXml StaplerRequest req StaplerResponse rsp throws IOException ServletException if req getMethod equals GET read checkPermission EXTENDED READ rsp setContentType application xml Node node getNode if node null throw HttpResponses notFound Jenkins XSTREAM2 toXMLUTF8 node rsp getOutputStream return if req getMethod equals POST submission updateByXml req getInputStream return huh rsp sendError SC BAD REQUEST public void updateByXml final InputStream source throws IOException ServletException checkPermission CONFIGURE Node result Node Jenkins XSTREAM2 fromXML source Jenkins getInstance getNodesObject replaceNode this getNode result RequirePOST public HttpResponse doDoDelete throws IOException checkPermission DELETE Node node getNode if node null Jenkins getInstance removeNode node else AbstractCIBase app Jenkins getInstance app removeComputer this return new HttpRedirect public void waitUntilOnline throws InterruptedException synchronized statusChangeLock while isOnline statusChangeLock wait 1000 public void waitUntilOffline throws InterruptedException synchronized statusChangeLock while isOffline statusChangeLock wait 1000 public void doProgressiveLog StaplerRequest req StaplerResponse rsp throws IOException getLogText doProgressText req rsp public static Nullable Computer currentComputer Executor e Executor currentExecutor return e null e getOwner null OverridingMethodsMustInvokeSuper public boolean isAcceptingTasks final Node node getNode return getRetentionStrategy isAcceptingTasks this node null node isAcceptingTasks CLIResolver public static Computer resolveForCLI Argument required true metaVar NAME usage Agent name or empty string for master String name throws CmdLineException Jenkins h Jenkins getInstance Computer item h getComputer name if item null List String names ComputerSet getComputerNames String adv EditDistance findNearest name names throw new IllegalArgumentException adv null hudson model Messages Computer NoSuchSlaveExistsWithoutAdvice name hudson model Messages Computer NoSuchSlaveExists name adv return item Initializer public static void relocateOldLogs relocateOldLogs Jenkins getInstance getRootDir static void relocateOldLogs File dir final Pattern logfile Pattern compile slave log 0 9 File logfiles dir listFiles new FilenameFilter public boolean accept File dir String name return logfile matcher name matches if logfiles null return for File f logfiles Matcher m logfile matcher f getName if m matches File newLocation new File dir logs slaves m group 1 slave log Util fixNull m group 2 newLocation getParentFile mkdirs boolean relocationSuccessful f renameTo newLocation if relocationSuccessful The operation will fail if mkdir fails LOGGER log Level INFO Relocated log file 0 to 1 new Object f getPath newLocation getPath else LOGGER log Level WARNING Cannot relocate log file 0 to 1 new Object f getPath newLocation getPath else assert false Restricted NoExternalUse class public static class DisplayExecutor implements ModelObject Nonnull private final String displayName Nonnull private final String url Nonnull private final Executor executor public DisplayExecutor Nonnull String displayName Nonnull String url Nonnull Executor executor this displayName displayName this url url this executor executor Override Nonnull public String getDisplayName return displayName Nonnull public String getUrl return url Nonnull public Executor getExecutor return executor Override public String toString final StringBuilder sb new StringBuilder DisplayExecutor sb append displayName append displayName append sb append url append url append sb append executor append executor sb append return sb toString Override public boolean equals Object o if this o return true if o null getClass o getClass return false DisplayExecutor that DisplayExecutor o if executor equals that executor return false return true Extension ordinal Double MAX VALUE Restricted DoNotUse class public static class InternalComputerListener extends ComputerListener Override public void onOnline Computer c TaskListener listener throws IOException InterruptedException c cachedEnvironment null Override public int hashCode return executor hashCode public static class TerminationRequest extends RuntimeException private final long when public TerminationRequest String message super message this when System currentTimeMillis public long getWhen return when public static final PermissionGroup PERMISSIONS new PermissionGroup Computer class Messages Computer Permissions Title public static final Permission CONFIGURE new Permission PERMISSIONS Configure Messages Computer ConfigurePermission Description Permission CONFIGURE PermissionScope COMPUTER public static final Permission EXTENDED READ new Permission PERMISSIONS ExtendedRead Messages Computer ExtendedReadPermission Description CONFIGURE SystemProperties getBoolean hudson security ExtendedReadPermission new PermissionScope PermissionScope COMPUTER public static final Permission DELETE new Permission PERMISSIONS Delete Messages Computer DeletePermission Description Permission DELETE PermissionScope COMPUTER public static final Permission CREATE new Permission PERMISSIONS Create Messages Computer CreatePermission Description Permission CREATE PermissionScope JENKINS public static final Permission DISCONNECT new Permission PERMISSIONS Disconnect Messages Computer DisconnectPermission Description Jenkins ADMINISTER PermissionScope COMPUTER public static final Permission CONNECT new Permission PERMISSIONS Connect Messages Computer ConnectPermission Description DISCONNECT PermissionScope COMPUTER public static final Permission BUILD new Permission PERMISSIONS Build Messages Computer BuildPermission Description Permission WRITE PermissionScope COMPUTER private static final Logger LOGGER Logger getLogger Computer class getNamepackage hudson slaves import hudson ExtensionPoint import hudson model AbstractDescribableImpl import hudson model TaskListener import java io IOException import javax annotation Nonnull public abstract class ComputerConnector extends AbstractDescribableImpl ComputerConnector implements ExtensionPoint public abstract ComputerLauncher launch Nonnull String host TaskListener listener throws IOException InterruptedException Override public ComputerConnectorDescriptor getDescriptor return ComputerConnectorDescriptor super getDescriptorpackage hudson slaves import hudson DescriptorExtensionList import hudson model Descriptor import jenkins model Jenkins public abstract class ComputerConnectorDescriptor extends Descriptor ComputerConnector public static DescriptorExtensionList ComputerConnector ComputerConnectorDescriptor all return Jenkins getInstance ComputerConnector ComputerConnectorDescriptor getDescriptorList ComputerConnector classpackage hudson slaves import hudson ExtensionPoint import hudson Extension import hudson model import hudson remoting Channel import hudson util DescriptorList import hudson util StreamTaskListener import java io import java util regex Matcher import java util regex Pattern import org apache tools ant util DeweyDecimal public abstract class ComputerLauncher extends AbstractDescribableImpl ComputerLauncher implements ExtensionPoint public boolean isLaunchSupported return true public void launch SlaveComputer computer TaskListener listener throws IOException InterruptedException to remain compatible with the legacy implementation that overrides the old signature launch computer cast listener Deprecated public void launch SlaveComputer computer StreamTaskListener listener throws IOException InterruptedException throw new UnsupportedOperationException getClass must implement the launch method public void afterDisconnect SlaveComputer computer TaskListener listener to remain compatible with the legacy implementation that overrides the old signature afterDisconnect computer cast listener Deprecated public void afterDisconnect SlaveComputer computer StreamTaskListener listener public void beforeDisconnect SlaveComputer computer TaskListener listener to remain compatible with the legacy implementation that overrides the old signature beforeDisconnect computer cast listener Deprecated public void beforeDisconnect SlaveComputer computer StreamTaskListener listener private StreamTaskListener cast TaskListener listener if listener instanceof StreamTaskListener return StreamTaskListener listener return new StreamTaskListener listener getLogger Deprecated public static final DescriptorList ComputerLauncher LIST new DescriptorList ComputerLauncher ComputerLauncher class protected static void checkJavaVersion final PrintStream logger String javaCommand final BufferedReader r throws IOException String line Pattern p Pattern compile i java openjdk version 0 9 while null line r readLine Matcher m p matcher line if m matches final String versionStr m group 1 logger println Messages ComputerLauncher JavaVersionResult javaCommand versionStr try if new DeweyDecimal versionStr isLessThan new DeweyDecimal 1 6 throw new IOException Messages ComputerLauncher NoJavaFound line catch NumberFormatException x throw new IOException Messages ComputerLauncher NoJavaFound line return logger println Messages ComputerLauncher UknownJavaVersion javaCommand throw new IOException Messages ComputerLauncher UknownJavaVersion javaCommandpackage hudson slaves import hudson model Descriptor import hudson model TaskListener import java io IOException public abstract class ComputerLauncherFilter extends ComputerLauncher protected volatile ComputerLauncher core public ComputerLauncherFilter ComputerLauncher core this core core public ComputerLauncher getCore return core Override public boolean isLaunchSupported return core isLaunchSupported Override public void launch SlaveComputer computer TaskListener listener throws IOException InterruptedException core launch computer listener Override public void afterDisconnect SlaveComputer computer TaskListener listener core afterDisconnect computer listener Override public void beforeDisconnect SlaveComputer computer TaskListener listener core beforeDisconnect computer listener Override public Descriptor ComputerLauncher getDescriptor throw new UnsupportedOperationExceptionpackage hudson slaves import hudson AbortException import hudson Extension import hudson ExtensionList import hudson ExtensionPoint import hudson FilePath import hudson model Computer import hudson model Node import hudson model TaskListener import hudson remoting Channel import java io IOException import javax annotation CheckForNull import javax annotation Nonnull public abstract class ComputerListener implements ExtensionPoint public void preLaunch Computer c TaskListener taskListener throws IOException InterruptedException public void onLaunchFailure Computer c TaskListener taskListener throws IOException InterruptedException public void preOnline Computer c Channel channel FilePath root TaskListener listener throws IOException InterruptedException Deprecated public void onOnline Computer c public void onOnline Computer c TaskListener listener throws IOException InterruptedException compatibility onOnline c Deprecated public void onOffline Computer c public void onOffline Nonnull Computer c CheckForNull OfflineCause cause onOffline c public void onTemporarilyOnline Computer c public void onTemporarilyOffline Computer c OfflineCause cause public void onConfigurationChange Deprecated public final void register all add this public final boolean unregister return all remove this public static ExtensionList ComputerListener all return ExtensionList lookup ComputerListener classpackage hudson model import hudson ExtensionList import hudson ExtensionPoint import java util ArrayList import java util List public abstract class ComputerPanelBox implements ExtensionPoint private Computer computer public void setComputer Computer computer this computer computer public Computer getComputer return computer public static List ComputerPanelBox all Computer computer List ComputerPanelBox boxs new ArrayList ComputerPanelBox for ComputerPanelBox box ExtensionList lookup ComputerPanelBox class box setComputer computer boxs add box return boxspackage hudson model import hudson Extension import hudson ExtensionList import hudson ExtensionPoint import java io IOException import java net InetAddress import java util logging Logger public abstract class ComputerPinger implements ExtensionPoint public abstract boolean isReachable InetAddress ia int timeout throws IOException public static ExtensionList ComputerPinger all return ExtensionList lookup ComputerPinger class public static boolean checkIsReachable InetAddress ia int timeout throws IOException for ComputerPinger pinger ComputerPinger all try if pinger isReachable ia timeout return true catch IOException e LOGGER fine Error checking reachability with pinger e getMessage return false Extension public static class BuiltInComputerPinger extends ComputerPinger Override public boolean isReachable InetAddress ia int timeout throws IOException return ia isReachable timeout 1000 private static final Logger LOGGER Logger getLogger ComputerPinger class getNamepackage hudson slaves import java util Map import java util WeakHashMap import hudson model Computer import hudson model Queue import jenkins model Jenkins import hudson model Node import hudson model PeriodicWork import hudson Extension import org jenkinsci Symbol Extension Symbol computerRetention public class ComputerRetentionWork extends PeriodicWork private final Map Computer Long nextCheck new WeakHashMap Computer Long public long getRecurrencePeriod return MIN SuppressWarnings unchecked Override protected void doRun final long startRun System currentTimeMillis for final Computer c Jenkins getInstance getComputers Queue withLock new Runnable Override public void run Node n c getNode if n null n isHoldOffLaunchUntilSave return if nextCheck containsKey c startRun nextCheck get c at the moment I don t trust strategies to wait more than 60 minutes strategies need to wait at least one minute final long waitInMins Math max 1 Math min 60 c getRetentionStrategy check c nextCheck put c startRun waitInMins 1000 60package hudson model import hudson BulkChange import hudson DescriptorExtensionList import hudson Extension import hudson Util import hudson XmlFile import hudson init Initializer import hudson model Descriptor FormException import hudson model listeners SaveableListener import hudson node monitors NodeMonitor import hudson slaves NodeDescriptor import hudson triggers SafeTimerTask import hudson util DescribableList import hudson util FormApply import hudson util FormValidation import jenkins model Jenkins import jenkins model ModelObjectWithChildren import jenkins model ModelObjectWithContextMenu ContextMenu import jenkins util Timer import org kohsuke stapler HttpResponse import org kohsuke stapler QueryParameter import org kohsuke stapler StaplerRequest import org kohsuke stapler StaplerResponse import org kohsuke stapler export Exported import org kohsuke stapler export ExportedBean import org kohsuke stapler interceptor RequirePOST import javax annotation Nonnull import javax servlet ServletException import java io File import java io IOException import java util AbstractList import java util ArrayList import java util HashMap import java util List import java util Map import java util concurrent TimeUnit import java util logging Level import java util logging Logger import net sf json JSONObject import static hudson init InitMilestone JOB LOADED ExportedBean public final class ComputerSet extends AbstractModelObject implements Describable ComputerSet ModelObjectWithChildren private static final Saveable MONITORS OWNER new Saveable public void save throws IOException getConfigFile write monitors SaveableListener fireOnChange this getConfigFile private static final DescribableList NodeMonitor Descriptor NodeMonitor monitors new DescribableList NodeMonitor Descriptor NodeMonitor MONITORS OWNER Exported public String getDisplayName return Messages ComputerSet DisplayName Deprecated public static List NodeMonitor get monitors return monitors toList Exported name computer inline true public Computer get all return Jenkins getInstance getComputers public ContextMenu doChildrenContextMenu StaplerRequest request StaplerResponse response throws Exception ContextMenu m new ContextMenu for Computer c get all m add c return m public DescriptorExtensionList NodeMonitor Descriptor NodeMonitor getNodeMonitorDescriptors return NodeMonitor all public static DescribableList NodeMonitor Descriptor NodeMonitor getMonitors return monitors public static Map Descriptor NodeMonitor NodeMonitor getNonIgnoredMonitors Map Descriptor NodeMonitor NodeMonitor r new HashMap Descriptor NodeMonitor NodeMonitor for NodeMonitor m monitors if m isIgnored r put m getDescriptor m return r public List String get slaveNames return new AbstractList String final List Node nodes Jenkins getInstance getNodes public String get int index return nodes get index getNodeName public int size return nodes size Exported public int getTotalExecutors int r 0 for Computer c get all if c isOnline r c countExecutors return r Exported public int getBusyExecutors int r 0 for Computer c get all if c isOnline r c countBusy return r public int getIdleExecutors int r 0 for Computer c get all if c isOnline c isConnecting c isAcceptingTasks r c countIdle return r public String getSearchUrl return computers public Computer getDynamic String token StaplerRequest req StaplerResponse rsp return Jenkins getInstance getComputer token public void do launchAll StaplerRequest req StaplerResponse rsp throws IOException Jenkins getInstance checkPermission Jenkins ADMINISTER for Computer c get all if c isLaunchSupported c connect true rsp sendRedirect public void doUpdateNow StaplerRequest req StaplerResponse rsp throws IOException ServletException Jenkins getInstance checkPermission Jenkins ADMINISTER for NodeMonitor nodeMonitor NodeMonitor getAll Thread t nodeMonitor triggerUpdate String columnCaption nodeMonitor getColumnCaption if columnCaption null t setName columnCaption rsp forwardToPreviousPage req public synchronized void doCreateItem StaplerRequest req StaplerResponse rsp QueryParameter String name QueryParameter String mode QueryParameter String from throws IOException ServletException final Jenkins app Jenkins getInstance app checkPermission Computer CREATE if mode null mode equals copy name checkName name Node src app getNode from if src null if Util fixEmpty from null throw new Failure Messages ComputerSet SpecifySlaveToCopy else throw new Failure Messages ComputerSet NoSuchSlave from copy through XStream String xml Jenkins XSTREAM toXML src Node result Node Jenkins XSTREAM fromXML xml result setNodeName name if result instanceof Slave change userId too User user User current Slave result setUserId user null anonymous user getId result holdOffLaunchUntilSave true app addNode result send the browser to the config page rsp sendRedirect2 result getNodeName configure else proceed to step 2 if mode null throw new Failure No mode given NodeDescriptor d NodeDescriptor all findByName mode if d null throw new Failure No node type mode is known d handleNewNodePage this name req rsp public synchronized void doDoCreateItem StaplerRequest req StaplerResponse rsp QueryParameter String name QueryParameter String type throws IOException ServletException FormException final Jenkins app Jenkins getInstance app checkPermission Computer CREATE String fixedName Util fixEmptyAndTrim name checkName fixedName JSONObject formData req getSubmittedForm formData put name fixedName TODO type is probably NodeDescriptor id but confirm Node result NodeDescriptor all find type newInstance req formData app addNode result take the user back to the agent list top page rsp sendRedirect2 public String checkName String name throws Failure if name null throw new Failure Query parameter name is required name name trim Jenkins checkGoodName name if Jenkins getInstance getNode name null throw new Failure Messages ComputerSet SlaveAlreadyExists name looks good return name public FormValidation doCheckName QueryParameter String value throws IOException ServletException Jenkins getInstance checkPermission Computer CREATE if Util fixEmpty value null return FormValidation ok try checkName value return FormValidation ok catch Failure e return FormValidation error e getMessage RequirePOST public synchronized HttpResponse doConfigSubmit StaplerRequest req throws IOException ServletException FormException BulkChange bc new BulkChange MONITORS OWNER try Jenkins getInstance checkPermission Jenkins ADMINISTER monitors rebuild req req getSubmittedForm getNodeMonitorDescriptors add in the rest of instances are ignored instances for Descriptor NodeMonitor d NodeMonitor all if monitors get d null NodeMonitor i createDefaultInstance d true if i null monitors add i recompute the data for NodeMonitor nm monitors nm triggerUpdate return FormApply success finally bc commit private static XmlFile getConfigFile return new XmlFile new File Jenkins getInstance getRootDir nodeMonitors xml public Api getApi return new Api this public Descriptor ComputerSet getDescriptor return Jenkins getInstance getDescriptorOrDie ComputerSet class Extension public static class DescriptorImpl extends Descriptor ComputerSet public AutoCompletionCandidates doAutoCompleteCopyNewItemFrom QueryParameter final String value final AutoCompletionCandidates r new AutoCompletionCandidates for Node n Jenkins getInstance getNodes if n getNodeName startsWith value r add n getNodeName return r public static void initialize Initializer after JOB LOADED public static void init start monitoring nodes although there s no hurry Timer get schedule new SafeTimerTask public void doRun ComputerSet initialize 10 TimeUnit SECONDS Nonnull public static List String getComputerNames final ArrayList String names new ArrayList String for Computer c Jenkins getInstance getComputers if c getName isEmpty names add c getName return names private static final Logger LOGGER Logger getLogger ComputerSet class getName static try DescribableList NodeMonitor Descriptor NodeMonitor r new DescribableList NodeMonitor Descriptor NodeMonitor Saveable NOOP load persisted monitors XmlFile xf getConfigFile if xf exists DescribableList NodeMonitor Descriptor NodeMonitor persisted DescribableList NodeMonitor Descriptor NodeMonitor xf read List NodeMonitor sanitized new ArrayList NodeMonitor for NodeMonitor nm persisted try nm getDescriptor sanitized add nm catch Throwable e the descriptor didn t load see JENKINS 15869 r replaceBy sanitized if we have any new monitors let s add them for Descriptor NodeMonitor d NodeMonitor all if r get d null NodeMonitor i createDefaultInstance d false if i null r add i monitors replaceBy r toList catch Throwable x LOGGER log Level WARNING Failed to instantiate NodeMonitors x private static NodeMonitor createDefaultInstance Descriptor NodeMonitor d boolean ignored try NodeMonitor nm d clazz newInstance nm setIgnored ignored return nm catch InstantiationException IllegalAccessException e LOGGER log Level SEVERE Failed to instantiate d clazz e return nullpackage jenkins security import hudson scm SCM import hudson tasks Builder import hudson util Secret import javax annotation CheckForNull import java io IOException public abstract class ConfidentialKey private final String id protected ConfidentialKey String id this id id protected CheckForNull byte load throws IOException return ConfidentialStore get load this protected void store byte payload throws IOException ConfidentialStore get store this payload public String getId return idpackage jenkins security import hudson Extension import hudson Lookup import hudson util Secret import hudson util Service import jenkins model Jenkins import org kohsuke MetaInfServices import javax annotation CheckForNull import javax annotation Nonnull import java io IOException import java util List import java util logging Level import java util logging Logger public abstract class ConfidentialStore protected abstract void store ConfidentialKey key byte payload throws IOException protected abstract CheckForNull byte load ConfidentialKey key throws IOException public abstract byte randomBytes int size public static Nonnull ConfidentialStore get if TEST null return TEST get Jenkins j Jenkins getInstance Lookup lookup j lookup ConfidentialStore cs lookup get ConfidentialStore class if cs null try List ConfidentialStore r List Service loadInstances ConfidentialStore class getClassLoader ConfidentialStore class if r isEmpty cs r get 0 catch IOException e LOGGER log Level WARNING Failed to list up ConfidentialStore implementations e fall through if cs null try cs new DefaultConfidentialStore catch Exception e if it s still null bail out throw new Error e cs lookup setIfNull ConfidentialStore class cs return cs static ThreadLocal ConfidentialStore TEST null private static final Logger LOGGER Logger getLogger ConfidentialStore class getNamepackage jenkins security s2m import java io BufferedReader import java io File import java io FileReader import java io FilenameFilter import java io IOException import java util Arrays import java util Collection import java util logging Level import java util logging Logger abstract class ConfigDirectory T COL extends Collection T extends ConfigFile T COL private final File dir protected ConfigDirectory File file super file this dir file getParentFile Override public synchronized void load COL result create if dir exists String fragments dir list new FilenameFilter Override public boolean accept File dir String name return name endsWith conf if fragments null Arrays sort fragments for String fragment fragments File f new File dir fragment try BufferedReader reader new BufferedReader new FileReader f String line while line reader readLine null if line startsWith continue comment T r parse line if r null result add r catch IOException e LOGGER log Level WARNING Failed to parse f e parsed readOnly result private static final Logger LOGGER Logger getLogger ConfigDirectory class getNamepackage jenkins security s2m import hudson CopyOnWrite import hudson util TextFile import jenkins model Jenkins import java io BufferedReader import java io File import java io IOException import java io StringReader import java util Collection abstract class ConfigFile T COL extends Collection T extends TextFile CopyOnWrite protected volatile COL parsed public ConfigFile File file super file protected abstract COL create protected abstract COL readOnly COL base public synchronized void load COL result create if exists for String line lines if line startsWith continue comment T r parse line if r null result add r parsed readOnly result public void parseTest String candidate try BufferedReader r new BufferedReader new StringReader candidate String line while line r readLine null if line startsWith continue comment parse line catch IOException e throw new IllegalArgumentException e can t happen but just in case protected abstract T parse String line public synchronized void set String newContent throws IOException Jenkins getInstance checkPermission Jenkins ADMINISTER write newContent load public synchronized void append String additional throws IOException String s read if s endsWith n s n s additional set s public COL get load upon the first use if parsed null synchronized this if parsed null load return parsedpackage com twitter sdk android core models import com google gson annotations SerializedName import java util List public class Configuration SerializedName dm text character limit public final int dmTextCharacterLimit SerializedName non username paths public final List String nonUsernamePaths SerializedName photo size limit public final long photoSizeLimit SerializedName photo sizes public final MediaEntity Sizes photoSizes SerializedName short url length https public final int shortUrlLengthHttps public Configuration int dmTextCharacterLimit List String nonUsernamePaths long photoSizeLimit MediaEntity Sizes photoSizes int shortUrlLengthHttps this dmTextCharacterLimit dmTextCharacterLimit this nonUsernamePaths nonUsernamePaths this photoSizeLimit photoSizeLimit this photoSizes photoSizes this shortUrlLengthHttps shortUrlLengthHttpspackage com twitter sdk android core services import com twitter sdk android core models Configuration import retrofit2 Call import retrofit2 http GET public interface ConfigurationService GET 1 1 help configuration json Call Configuration configurationpackage jenkins management import hudson Extension import hudson model ManagementLink import org jenkinsci Symbol Extension ordinal Integer MAX VALUE 200 Symbol configure public class ConfigureLink extends ManagementLink Override public String getIconFileName return gear2 png public String getDisplayName return Messages ConfigureLink DisplayName Override public String getDescription return Messages ConfigureLink Description Override public String getUrlName return configurepackage hudson cli import hudson remoting ClassFilter import hudson remoting ObjectInputStreamEx import hudson remoting SocketChannelStream import org apache commons codec binary Base64 import javax crypto Cipher import javax crypto CipherInputStream import javax crypto CipherOutputStream import javax crypto KeyAgreement import javax crypto SecretKey import javax crypto interfaces DHPublicKey import javax crypto spec DHParameterSpec import javax crypto spec IvParameterSpec import java io DataInputStream import java io DataOutputStream import java io IOException import java io InputStream import java io ObjectInputStream import java io ObjectOutputStream import java io OutputStream import java net Socket import java security AlgorithmParameterGenerator import java security GeneralSecurityException import java security Key import java security KeyFactory import java security KeyPair import java security KeyPairGenerator import java security PublicKey import java security Signature import java security interfaces DSAPublicKey import java security interfaces RSAPublicKey import java security spec X509EncodedKeySpec public class Connection public final InputStream in public final OutputStream out public final DataInputStream din public final DataOutputStream dout public Connection Socket socket throws IOException this SocketChannelStream in socket SocketChannelStream out socket public Connection InputStream in OutputStream out this in in this out out this din new DataInputStream in this dout new DataOutputStream out Convenience methods public void writeUTF String msg throws IOException dout writeUTF msg public String readUTF throws IOException return din readUTF public void writeBoolean boolean b throws IOException dout writeBoolean b public boolean readBoolean throws IOException return din readBoolean public void writeObject Object o throws IOException ObjectOutputStream oos new ObjectOutputStream out oos writeObject o don t close oss which will close the underlying stream no need to flush either given the way oos is implemented public T T readObject throws IOException ClassNotFoundException ObjectInputStream ois new ObjectInputStreamEx in getClass getClassLoader ClassFilter DEFAULT return T ois readObject public void writeKey Key key throws IOException writeUTF new String Base64 encodeBase64 key getEncoded public X509EncodedKeySpec readKey throws IOException byte otherHalf Base64 decodeBase64 readUTF for historical reasons we don t use readByteArray return new X509EncodedKeySpec otherHalf public void writeByteArray byte data throws IOException dout writeInt data length dout write data public byte readByteArray throws IOException int bufSize din readInt if bufSize 0 throw new IOException DataInputStream unexpectedly returned negative integer byte buf new byte bufSize din readFully buf return buf public KeyAgreement diffieHellman boolean side throws IOException GeneralSecurityException return diffieHellman side 512 public KeyAgreement diffieHellman boolean side int keySize throws IOException GeneralSecurityException KeyPair keyPair PublicKey otherHalf if side AlgorithmParameterGenerator paramGen AlgorithmParameterGenerator getInstance DH paramGen init keySize KeyPairGenerator dh KeyPairGenerator getInstance DH dh initialize paramGen generateParameters getParameterSpec DHParameterSpec class keyPair dh generateKeyPair send a half and get a half writeKey keyPair getPublic otherHalf KeyFactory getInstance DH generatePublic readKey else otherHalf KeyFactory getInstance DH generatePublic readKey KeyPairGenerator keyPairGen KeyPairGenerator getInstance DH keyPairGen initialize DHPublicKey otherHalf getParams keyPair keyPairGen generateKeyPair send a half and get a half writeKey keyPair getPublic KeyAgreement ka KeyAgreement getInstance DH ka init keyPair getPrivate ka doPhase otherHalf true return ka public Connection encryptConnection SecretKey sessionKey String algorithm throws IOException GeneralSecurityException Cipher cout Cipher getInstance algorithm cout init Cipher ENCRYPT MODE sessionKey new IvParameterSpec sessionKey getEncoded CipherOutputStream o new CipherOutputStream out cout Cipher cin Cipher getInstance algorithm cin init Cipher DECRYPT MODE sessionKey new IvParameterSpec sessionKey getEncoded CipherInputStream i new CipherInputStream in cin return new Connection i o public static byte fold byte bytes int size byte r new byte size for int i Math max bytes length size 1 i 0 i r i r length bytes i bytes length return r private String detectKeyAlgorithm KeyPair kp return detectKeyAlgorithm kp getPublic private String detectKeyAlgorithm PublicKey kp if kp instanceof RSAPublicKey return RSA if kp instanceof DSAPublicKey return DSA throw new IllegalArgumentException Unknown public key type kp public void proveIdentity byte sharedSecret KeyPair key throws IOException GeneralSecurityException String algorithm detectKeyAlgorithm key writeUTF algorithm writeKey key getPublic Signature sig Signature getInstance SHA1with algorithm sig initSign key getPrivate sig update key getPublic getEncoded sig update sharedSecret writeObject sig sign public PublicKey verifyIdentity byte sharedSecret throws IOException GeneralSecurityException try String serverKeyAlgorithm readUTF PublicKey spk KeyFactory getInstance serverKeyAlgorithm generatePublic readKey verify the identity of the server Signature sig Signature getInstance SHA1with serverKeyAlgorithm sig initVerify spk sig update spk getEncoded sig update sharedSecret sig verify byte readObject return spk catch ClassNotFoundException e throw new Error e impossible public void close throws IOException in close out closepackage hudson slaves import hudson model AsyncPeriodicWork import hudson model TaskListener import jenkins model Jenkins import hudson model Computer import hudson util TimeUnit2 import hudson remoting VirtualChannel import hudson remoting Channel import hudson Extension import jenkins util SystemProperties import jenkins security SlaveToMasterCallable import org jenkinsci Symbol import java io IOException import java util logging Logger Extension Symbol connectionActivityMonitor public class ConnectionActivityMonitor extends AsyncPeriodicWork public ConnectionActivityMonitor super Connection Activity monitoring to agents protected void execute TaskListener listener throws IOException InterruptedException if enabled return long now System currentTimeMillis for Computer c Jenkins getInstance getComputers VirtualChannel ch c getChannel if ch instanceof Channel Channel channel Channel ch if now channel getLastHeard TIME TILL PING haven t heard from this agent for a while Long lastPing Long channel getProperty ConnectionActivityMonitor class if lastPing null now lastPing TIMEOUT LOGGER info Repeated ping attempts failed on c getName Disconnecting c disconnect OfflineCause create Messages ConnectionActivityMonitor OfflineCause else send a ping if we receive a reply it will be reflected in the next getLastHeard call channel callAsync PING COMMAND if lastPing null channel setProperty ConnectionActivityMonitor class now else we are receiving data nicely channel setProperty ConnectionActivityMonitor class null public long getRecurrencePeriod return enabled FREQUENCY TimeUnit2 DAYS toMillis 30 private static final long TIME TILL PING SystemProperties getLong ConnectionActivityMonitor class getName timeToPing TimeUnit2 MINUTES toMillis 3 private static final long FREQUENCY SystemProperties getLong ConnectionActivityMonitor class getName frequency TimeUnit2 SECONDS toMillis 10 private static final long TIMEOUT SystemProperties getLong ConnectionActivityMonitor class getName timeToPing TimeUnit2 MINUTES toMillis 4 disabled by default until proven in the production public boolean enabled SystemProperties getBoolean ConnectionActivityMonitor class getName enabled private static final PingCommand PING COMMAND new PingCommand private static final class PingCommand extends SlaveToMasterCallable Void RuntimeException public Void call throws RuntimeException return null private static final long serialVersionUID 1L private static final Logger LOGGER Logger getLogger ConnectionActivityMonitor class getNamepackage hudson cli import hudson remoting FastPipedInputStream import hudson remoting FastPipedOutputStream import java io DataInputStream import java io IOException import static org junit Assert import org junit Test import org junit runner RunWith import static org powermock api mockito PowerMockito import org powermock core classloader annotations PrepareForTest import org powermock modules junit4 PowerMockRunner RunWith PowerMockRunner class PrepareForTest Connection class public class ConnectionMockTest Test public void shouldTolerateEmptyByteArrayUponStreamZeroValue throws IOException DataInputStream din mock DataInputStream class when din readInt thenReturn 0 does not work mock always return 0 for some TBD reason Connection c new Connection din new FastPipedOutputStream new FastPipedInputStream assertTrue c readByteArray length 0package hudson cli import static org junit Assert import hudson remoting FastPipedInputStream import hudson remoting FastPipedOutputStream import org codehaus groovy runtime Security218 import org junit Assert import org junit Before import org junit Test import javax crypto SecretKey import javax crypto spec SecretKeySpec import java io IOException public class ConnectionTest Throwable e private Connection c1 private Connection c2 Before public void setUp throws IOException FastPipedInputStream i new FastPipedInputStream FastPipedInputStream j new FastPipedInputStream c1 new Connection i new FastPipedOutputStream j c2 new Connection j new FastPipedOutputStream i Test public void testEncrypt throws Throwable final SecretKey sessionKey new SecretKeySpec new byte 16 AES Thread t1 new Thread Override public void run try c1 encryptConnection sessionKey AES CFB8 NoPadding writeUTF Hello catch Throwable x e x t1 start Thread t2 new Thread Override public void run try String data c2 encryptConnection sessionKey AES CFB8 NoPadding readUTF assertEquals Hello data catch Throwable x e x t2 start t1 join 9999 t2 join 9999 if e null throw e if t1 isAlive t2 isAlive t1 interrupt t2 interrupt throw new Error thread is still alive Test public void testSecurity218 throws Exception c1 writeObject new Security218 try c2 readObject fail catch SecurityException e assertTrue e getMessage contains Security218 class getNamepackage hudson cli import hudson AbortException import hudson Extension import hudson model Computer import hudson model ComputerSet import hudson util EditDistance import jenkins model Jenkins import org kohsuke args4j Argument import org kohsuke args4j Option import java util HashSet import java util List import java util logging Logger Extension public class ConnectNodeCommand extends CLICommand Argument metaVar NAME usage Slave name or empty string for master comma separated list is supported required true multiValued true private List String nodes Option name f usage Cancel any currently pending connect operation and retry from scratch public boolean force false private static final Logger LOGGER Logger getLogger ConnectNodeCommand class getName Override public String getShortDescription return Messages ConnectNodeCommand ShortDescription Override protected int run throws Exception boolean errorOccurred false final Jenkins jenkins Jenkins getActiveInstance final HashSet String hs new HashSet String hs addAll nodes List String names null for String node s hs Computer computer null try computer jenkins getComputer node s if computer null if names null names ComputerSet getComputerNames String adv EditDistance findNearest node s names throw new IllegalArgumentException adv null hudson model Messages Computer NoSuchSlaveExistsWithoutAdvice node s hudson model Messages Computer NoSuchSlaveExists node s adv computer cliConnect force catch Exception e if hs size 1 throw e final String errorMsg String format node s e getMessage stderr println errorMsg errorOccurred true continue if errorOccurred throw new AbortException CLI LISTPARAM SUMMARY ERROR TEXT return 0package hudson util import com trilead ssh2 crypto digest MD5 import java util Arrays import java util HashMap import java util Map import java util Collection import java util Iterator import java util NoSuchElementException import hudson util Iterators DuplicateFilterIterator public class ConsistentHash T private final Map T Point items new HashMap T Point private int numPoints private final int defaultReplication private final Hash T hash private static final class Point implements Comparable Point final int hash final Object item private Point int hash Object item this hash hash this item item public int compareTo Point that if this hash that hash return 1 if this hash that hash return 0 return 1 private volatile Table table private final class Table private final int hash private final Object owner really T private Table int r 0 for Point v items values r v length numPoints r merge all points from all nodes and sort them into a single array Point allPoints new Point numPoints int p 0 for Point v items values System arraycopy v 0 allPoints p v length p v length Arrays sort allPoints hash new int allPoints length owner new Object allPoints length for int i 0 i allPoints length i Point pt allPoints i hash i pt hash owner i pt item T lookup int queryPoint int i index queryPoint if i 0 return null return T owner i Iterator T list int queryPoint final int start index queryPoint return new DuplicateFilterIterator T new Iterator T int pos 0 public boolean hasNext return pos owner length public T next if hasNext throw new NoSuchElementException return T owner start pos owner length public void remove throw new UnsupportedOperationException private int index int queryPoint int idx Arrays binarySearch hash queryPoint if idx 0 idx idx 1 idx is now insertion point if hash length 0 return 1 idx hash length make it a circle return idx public interface Hash T String hash T t static final Hash DEFAULT HASH new Hash Object public String hash Object o return o toString public ConsistentHash this Hash T DEFAULT HASH public ConsistentHash int defaultReplication this Hash T DEFAULT HASH defaultReplication public ConsistentHash Hash T hash this hash 100 public ConsistentHash Hash T hash int defaultReplication this hash hash this defaultReplication defaultReplication refreshTable public int countAllPoints return numPoints public synchronized void add T node add node defaultReplication public synchronized void addAll T nodes for T node nodes addInternal node defaultReplication refreshTable public synchronized void addAll Collection extends T nodes for T node nodes addInternal node defaultReplication refreshTable public synchronized void addAll Map extends T Integer nodes for Map Entry extends T Integer node nodes entrySet addInternal node getKey node getValue refreshTable public synchronized void remove T node add node 0 public synchronized void add T node int replica addInternal node replica refreshTable private synchronized void addInternal T node int replica if replica 0 items remove node else Point points new Point replica String seed hash hash node for int i 0 i replica i points i new Point md5 seed i node items put node points private synchronized void refreshTable table new Table private int md5 String s MD5 md5 new MD5 md5 update s getBytes byte digest new byte 16 md5 digest digest 16 bytes 4 bytes for int i 0 i 4 i digest i digest i 4 digest i 8 digest i 12 return b2i digest 0 24 b2i digest 1 16 b2i digest 2 8 b2i digest 3 private int b2i byte b return int b 0xFF public T lookup int queryPoint return table lookup queryPoint public T lookup String queryPoint return lookup md5 queryPoint public Iterable T list final int queryPoint return new Iterable T public Iterator T iterator return table list queryPoint public Iterable T list String queryPoint return list md5 queryPointpackage hudson console import hudson DescriptorExtensionList import hudson ExtensionPoint import hudson model Descriptor import jenkins model Jenkins import hudson util TimeUnit2 import org kohsuke stapler StaplerRequest import org kohsuke stapler StaplerResponse import org kohsuke stapler WebMethod import javax servlet ServletException import java io IOException import java net URL public abstract class ConsoleAnnotationDescriptor extends Descriptor ConsoleNote implements ExtensionPoint public ConsoleAnnotationDescriptor Class extends ConsoleNote clazz super clazz public ConsoleAnnotationDescriptor Override public String getDisplayName return super getDisplayName public boolean hasScript return hasResource script js null public boolean hasStylesheet return hasResource style css null private URL hasResource String name return clazz getClassLoader getResource clazz getName replace replace name WebMethod name script js public void doScriptJs StaplerRequest req StaplerResponse rsp throws IOException ServletException rsp serveFile req hasResource script js TimeUnit2 DAYS toMillis 1 WebMethod name style css public void doStyleCss StaplerRequest req StaplerResponse rsp throws IOException ServletException rsp serveFile req hasResource style css TimeUnit2 DAYS toMillis 1 public static DescriptorExtensionList ConsoleNote ConsoleAnnotationDescriptor all return DescriptorExtensionList Jenkins getInstance getDescriptorList ConsoleNote classpackage hudson console import hudson MarkupText import org apache commons io output ProxyWriter import org kohsuke stapler framework io WriterOutputStream import java io ByteArrayInputStream import java io DataInputStream import java io IOException import java io OutputStream import java io StringWriter import java io Writer import java nio charset Charset import java util ArrayList import java util List import java util logging Level import java util logging Logger public class ConsoleAnnotationOutputStream T extends LineTransformationOutputStream private final Writer out private final T context private ConsoleAnnotator T ann private final LineBuffer line new LineBuffer 256 private final WriterOutputStream lineOut public ConsoleAnnotationOutputStream Writer out ConsoleAnnotator super T ann T context Charset charset this out out this ann ConsoleAnnotator cast ann this context context this lineOut new WriterOutputStream line charset public ConsoleAnnotator getConsoleAnnotator return ann protected void eol byte in int sz throws IOException line reset final StringBuffer strBuf line getStringBuffer int next ConsoleNote findPreamble in 0 sz List ConsoleAnnotator T annotators null perform byte char while figuring out the char positions of the BLOBs int written 0 while next 0 if next written lineOut write in written next written lineOut flush written next else assert next written character position of this annotation in this line final int charPos strBuf length int rest sz next ByteArrayInputStream b new ByteArrayInputStream in next rest try final ConsoleNote a ConsoleNote readFrom new DataInputStream b if a null if annotators null annotators new ArrayList ConsoleAnnotator T annotators add new ConsoleAnnotator T public ConsoleAnnotator annotate T context MarkupText text return a annotate context text charPos catch IOException e if we failed to resurrect an annotation ignore it LOGGER log Level FINE Failed to resurrect annotation e catch ClassNotFoundException e LOGGER log Level FINE Failed to resurrect annotation e int bytesUsed rest b available bytes consumed by annotations written bytesUsed next ConsoleNote findPreamble in written sz written finish the remaining bytes chars conversion lineOut write in written sz written if annotators null aggregate newly retrieved ConsoleAnnotators into the current one if ann null annotators add ann ann ConsoleAnnotator combine annotators lineOut flush MarkupText mt new MarkupText strBuf toString if ann null ann ann annotate context mt out write mt toString true this perform escapes Override public void flush throws IOException out flush Override public void close throws IOException super close out close private static class LineBuffer extends ProxyWriter private LineBuffer int initialSize super new StringWriter initialSize private void reset StringBuffer buf getStringBuffer if buf length 4096 out new StringWriter 256 else buf setLength 0 private StringBuffer getStringBuffer StringWriter w StringWriter out return w getBuffer private static final Logger LOGGER Logger getLogger ConsoleAnnotationOutputStream class getNamepackage hudson console import hudson MarkupText import java io Serializable import java util ArrayList import java util Collection import java util List import java util ListIterator public abstract class ConsoleAnnotator T implements Serializable public abstract ConsoleAnnotator annotate T context MarkupText text public static T ConsoleAnnotator T cast ConsoleAnnotator super T a return ConsoleAnnotator a public static T ConsoleAnnotator T combine Collection extends ConsoleAnnotator super T all switch all size case 0 return null none case 1 return cast all iterator next just one class Aggregator extends ConsoleAnnotator T List ConsoleAnnotator T list Aggregator Collection list this list new ArrayList ConsoleAnnotator T list public ConsoleAnnotator annotate T context MarkupText text ListIterator ConsoleAnnotator T itr list listIterator while itr hasNext ConsoleAnnotator a itr next ConsoleAnnotator b a annotate context text if a b if b null itr remove else itr set b switch list size case 0 return null no more annotator left case 1 return list get 0 no point in aggregating default return this return new Aggregator all public static T ConsoleAnnotator T initial T context return combine for context public static T List ConsoleAnnotator T for T context List ConsoleAnnotator T r new ArrayList ConsoleAnnotator T for ConsoleAnnotatorFactory f ConsoleAnnotatorFactory all if f type isInstance context ConsoleAnnotator ca f newInstance context if ca null r add ca return r private static final long serialVersionUID 1Lpackage hudson console import hudson Extension import hudson ExtensionList import hudson ExtensionPoint import hudson model Run import hudson util TimeUnit2 import org jvnet tiger types Types import org kohsuke stapler StaplerRequest import org kohsuke stapler StaplerResponse import org kohsuke stapler WebMethod import javax servlet ServletException import java io IOException import java lang reflect ParameterizedType import java lang reflect Type import java net URL public abstract class ConsoleAnnotatorFactory T implements ExtensionPoint public abstract ConsoleAnnotator newInstance T context public Class type Type type Types getBaseClass getClass ConsoleAnnotator class if type instanceof ParameterizedType return Types erasure Types getTypeArgument type 0 else return Object class public boolean hasScript return getResource script js null public boolean hasStylesheet return getResource style css null private URL getResource String fileName Class c getClass return c getClassLoader getResource c getName replace replace fileName WebMethod name script js public void doScriptJs StaplerRequest req StaplerResponse rsp throws IOException ServletException rsp serveFile req getResource script js TimeUnit2 DAYS toMillis 1 WebMethod name style css public void doStyleCss StaplerRequest req StaplerResponse rsp throws IOException ServletException rsp serveFile req getResource style css TimeUnit2 DAYS toMillis 1 public static ExtensionList ConsoleAnnotatorFactory all return ExtensionList lookup ConsoleAnnotatorFactory classpackage hudson cli import hudson Extension import hudson console AnnotatedLargeText import hudson model AbstractBuild import hudson model AbstractProject import hudson model Item import hudson model PermalinkProjectAction Permalink import org kohsuke args4j Argument import org kohsuke args4j CmdLineException import org kohsuke args4j Option import java io IOException import java io InputStream import java io InputStreamReader import java io OutputStreamWriter import java io PrintStream import org apache commons io IOUtils Extension public class ConsoleCommand extends CLICommand Override public String getShortDescription return Messages ConsoleCommand ShortDescription Argument metaVar JOB usage Name of the job required true public AbstractProject job Argument metaVar BUILD usage Build number or permalink to point to the build Defaults to the last build required false index 1 public String build lastBuild Option name f usage If the build is in progress stay around and append console output as it comes like tail f public boolean follow false Option name n metaVar N usage Display the last N lines public int n 1 protected int run throws Exception job checkPermission Item BUILD AbstractBuild run try int n Integer parseInt build run job getBuildByNumber n if run null throw new IllegalArgumentException No such build n catch NumberFormatException e maybe a permalink Permalink p job getPermalinks get build if p null run AbstractBuild p resolve job if run null throw new IllegalStateException Permalink build produced no build else Permalink nearest job getPermalinks findNearest build throw new IllegalArgumentException nearest null String format Not sure what you meant by s build String format Not sure what you meant by s Did you mean s build nearest getId OutputStreamWriter w new OutputStreamWriter stdout getClientCharset try long pos n 0 seek run 0 if follow AnnotatedLargeText logText do logText run getLogText pos logText writeLogTo pos w while logText isComplete else try InputStream logInputStream run getLogInputStream IOUtils skip logInputStream pos IOUtils copy new InputStreamReader logInputStream run getCharset w finally w flush this pointless flush needed to work around SSHD 154 w close return 0 private long seek AbstractBuild run throws IOException class RingBuffer long lastNlines new long n int ptr 0 RingBuffer for int i 0 i n i lastNlines i 1 void add long pos lastNlines ptr pos ptr ptr 1 lastNlines length long get long v lastNlines ptr if v 0 return lastNlines 0 didn t even wrap around return v RingBuffer rb new RingBuffer InputStream in run getLogInputStream try byte buf new byte 4096 int len byte prev 0 long pos 0 boolean prevIsNL false while len in read buf 0 for int i 0 i len i byte ch buf i boolean isNL ch r ch n if isNL prevIsNL rb add pos if isNL prevIsNL prev r ch n rb add pos pos prev ch prevIsNL isNL return rb get finally org apache commons io IOUtils closeQuietly in Override protected void printUsageSummary PrintStream stderr stderr println Produces the console output of a specific build to stdout as if you are doing cat build logpackage jenkins management import hudson Extension import hudson model ManagementLink import hudson security Permission import jenkins model Jenkins import org jenkinsci Symbol Extension ordinal Integer MAX VALUE 900 Symbol console public class ConsoleLink extends ManagementLink Override public String getIconFileName return notepad png public String getDisplayName return Messages ConsoleLink DisplayName Override public String getDescription return Messages ConsoleLink Description Override public String getUrlName return script Override public Permission getRequiredPermission return Jenkins RUN SCRIPTSpackage hudson console import hudson ExtensionList import hudson ExtensionPoint import hudson Util import hudson model AbstractBuild import hudson model Computer import hudson model Run import hudson tasks BuildWrapper import hudson util ArgumentListBuilder import javax annotation Nonnull import java io IOException import java io OutputStream public abstract class ConsoleLogFilter implements ExtensionPoint public OutputStream decorateLogger AbstractBuild build OutputStream logger throws IOException InterruptedException if Util isOverridden ConsoleLogFilter class getClass decorateLogger Run class OutputStream class old client calling newer implementation forward the call return decorateLogger Run build logger else happens only if the subtype fails to override neither decorateLogger method throw new AssertionError The plugin this getClass getName still uses deprecated decorateLogger AbstractBuild OutputStream method Update the plugin to use setUp Run OutputStream instead public OutputStream decorateLogger Run build OutputStream logger throws IOException InterruptedException this implementation is backward compatibility thunk in case subtypes only override the old signature AbstractBuild OutputStream if build instanceof AbstractBuild maybe the plugin implements the old signature return decorateLogger AbstractBuild build logger else this ConsoleLogFilter can only decorate AbstractBuild so just pass through return logger public OutputStream decorateLogger Nonnull Computer computer OutputStream logger throws IOException InterruptedException return logger by default no op public static ExtensionList ConsoleLogFilter all return ExtensionList lookup ConsoleLogFilter classpackage hudson console import hudson ExtensionPoint import hudson Functions import hudson MarkupText import hudson model Describable import jenkins model Jenkins import hudson model Run import hudson remoting ObjectInputStreamEx import hudson util IOUtils import hudson util UnbufferedBase64InputStream import org apache commons codec binary Base64OutputStream import org apache commons io output ByteArrayOutputStream import org apache tools ant BuildListener import java io ByteArrayInputStream import java io DataInputStream import java io DataOutputStream import java io IOException import java io ObjectInputStream import java io ObjectOutputStream import java io OutputStream import java io Serializable import java io Writer import java util ArrayList import java util Arrays import java util Collection import java util List import com jcraft jzlib GZIPInputStream import com jcraft jzlib GZIPOutputStream public abstract class ConsoleNote T implements Serializable Describable ConsoleNote ExtensionPoint public abstract ConsoleAnnotator annotate T context MarkupText text int charPos public ConsoleAnnotationDescriptor getDescriptor return ConsoleAnnotationDescriptor Jenkins getInstance getDescriptorOrDie getClass public void encodeTo OutputStream out throws IOException atomically write to the final output to minimize the chance of something else getting in between the output even with this it is still technically possible to get such a mix up to occur for example if Java program is reading stdout stderr separately and copying them into the same final stream out write encodeToBytes toByteArray public void encodeTo Writer out throws IOException out write encodeToBytes toString private ByteArrayOutputStream encodeToBytes throws IOException ByteArrayOutputStream buf new ByteArrayOutputStream try ObjectOutputStream oos new ObjectOutputStream new GZIPOutputStream buf oos writeObject this ByteArrayOutputStream buf2 new ByteArrayOutputStream DataOutputStream dos new DataOutputStream new Base64OutputStream buf2 true 1 null try buf2 write PREAMBLE dos writeInt buf size buf writeTo dos finally dos close buf2 write POSTAMBLE return buf2 public String encode throws IOException return encodeToBytes toString public static ConsoleNote readFrom DataInputStream in throws IOException ClassNotFoundException try byte preamble new byte PREAMBLE length in readFully preamble if Arrays equals preamble PREAMBLE return null not a valid preamble DataInputStream decoded new DataInputStream new UnbufferedBase64InputStream in int sz decoded readInt byte buf new byte sz decoded readFully buf byte postamble new byte POSTAMBLE length in readFully postamble if Arrays equals postamble POSTAMBLE return null not a valid postamble try ObjectInputStream ois new ObjectInputStreamEx new GZIPInputStream new ByteArrayInputStream buf Jenkins getInstance pluginManager uberClassLoader return ConsoleNote ois readObject catch Error e for example bogus sz can result in OutOfMemoryError package that up as IOException so that the caller won t fatally die throw new IOException e public static void skip DataInputStream in throws IOException byte preamble new byte PREAMBLE length in readFully preamble if Arrays equals preamble PREAMBLE return not a valid preamble DataInputStream decoded new DataInputStream new UnbufferedBase64InputStream in int sz decoded readInt IOUtils skip decoded sz byte postamble new byte POSTAMBLE length in readFully postamble private static final long serialVersionUID 1L public static final String PREAMBLE STR u001B 8mha public static final String POSTAMBLE STR u001B 0m public static final byte PREAMBLE PREAMBLE STR getBytes public static final byte POSTAMBLE POSTAMBLE STR getBytes public static int findPreamble byte buf int start int len int e start len PREAMBLE length 1 OUTER for int i start i e i if buf i PREAMBLE 0 check for the rest of the match for int j 1 j PREAMBLE length j if buf i j PREAMBLE j continue OUTER return i found it return 1 not found public static List String removeNotes Collection String logLines List String r new ArrayList String logLines size for String l logLines r add removeNotes l return r public static String removeNotes String line while true int idx line indexOf PREAMBLE STR if idx 0 return line int e line indexOf POSTAMBLE STR idx if e 0 return line line line substring 0 idx line substring e POSTAMBLE STR lengthpackage com kaku colorfulnews common public class Constants public static final String DB NAME NewsChannelTable public static final String SHARES COLOURFUL NEWS shares colourful news public static final String NIGHT THEME MODE night theme mode public static final String INIT DB init db public static final String NEWS ID news id public static final String NEWS TYPE news type public static final String CHANNEL POSITION channel position public static final String NEWS POST ID news post id public static final String NEWS IMG RES news img res public static final String TRANSITION ANIMATION NEWS PHOTOS transition animation news photos public static final String SHOW NEWS PHOTO show news photo public static final int NEWS CHANNEL MINE 0 public static final int NEWS CHANNEL MORE 1 public static final String PHOTO DETAIL photo detail public static final String PHOTO DETAIL IMGSRC photo detail imgsrc public static final String NEWS LINK news link public static final String NEWS TITLE news titlepackage hudson security import jenkins model Jenkins import org acegisecurity Authentication import org acegisecurity GrantedAuthority import org acegisecurity GrantedAuthorityImpl import javax servlet ServletRequest import javax servlet http HttpServletRequest import java security Principal import java util List import java util ArrayList public final class ContainerAuthentication implements Authentication private final Principal principal private GrantedAuthority authorities public ContainerAuthentication HttpServletRequest request this principal request getUserPrincipal if principal null throw new IllegalStateException for anonymous users we just don t call SecurityContextHolder getContext setAuthentication Servlet API doesn t provide a way to list up all roles the current user has so we need to ask AuthorizationStrategy what roles it is going to check against List GrantedAuthority l new ArrayList GrantedAuthority for String g Jenkins getInstance getAuthorizationStrategy getGroups if request isUserInRole g l add new GrantedAuthorityImpl g l add SecurityRealm AUTHENTICATED AUTHORITY authorities l toArray new GrantedAuthority l size public GrantedAuthority getAuthorities return authorities public Object getCredentials return null public Object getDetails return null public String getPrincipal return principal getName public boolean isAuthenticated return true public void setAuthenticated boolean isAuthenticated throws IllegalArgumentException noop public String getName return getPrincipalpackage com kaku colorfulnews di scope import java lang annotation Documented import java lang annotation Retention import java lang annotation RetentionPolicy import javax inject Qualifier Qualifier Documented Retention RetentionPolicy RUNTIME public interface ContextLife String value default Applicationpackage jenkins util import java util concurrent Callable import java util concurrent ExecutorService public class ContextResettingExecutorService extends InterceptingExecutorService public ContextResettingExecutorService ExecutorService base super base Override protected Runnable wrap final Runnable r return new Runnable Override public void run Thread t Thread currentThread String name t getName ClassLoader cl t getContextClassLoader try r run finally t setName name t setContextClassLoader cl Override protected V Callable V wrap final Callable V r return new Callable V Override public V call throws Exception Thread t Thread currentThread String name t getName ClassLoader cl t getContextClassLoader try return r call finally t setName name t setContextClassLoader clpackage com twitter sdk android core models import com google gson annotations SerializedName import java util ArrayList import java util List public class Coordinates public static final int INDEX LONGITUDE 0 public static final int INDEX LATITUDE 1 SerializedName coordinates public final List Double coordinates SerializedName type public final String type public Coordinates Double longitude Double latitude String type final List Double coords new ArrayList 2 coords add INDEX LONGITUDE longitude coords add INDEX LATITUDE latitude this coordinates coords this type type public Double getLongitude return coordinates get INDEX LONGITUDE public Double getLatitude return coordinates get INDEX LATITUDEpackage hudson cli import jenkins model Jenkins import hudson model TopLevelItem import hudson Extension import hudson model Item import jenkins model ModifiableTopLevelItemGroup import org kohsuke args4j Argument Extension public class CopyJobCommand extends CLICommand Override public String getShortDescription return Messages CopyJobCommand ShortDescription Argument metaVar SRC usage Name of the job to copy required true public TopLevelItem src Argument metaVar DST usage Name of the new job to be created index 1 required true public String dst protected int run throws Exception Jenkins jenkins Jenkins getActiveInstance if jenkins getItemByFullName dst null throw new IllegalStateException Job dst already exists ModifiableTopLevelItemGroup ig jenkins int i dst lastIndexOf if i 0 String group dst substring 0 i Item item jenkins getItemByFullName group if item null throw new IllegalArgumentException Unknown ItemGroup group if item instanceof ModifiableTopLevelItemGroup ig ModifiableTopLevelItemGroup item else throw new IllegalStateException Can t create job from CLI in group dst dst substring i 1 ig copy src dst save return 0package hudson import java lang annotation Documented import static java lang annotation ElementType FIELD import java lang annotation Retention import static java lang annotation RetentionPolicy SOURCE import java lang annotation Target Retention SOURCE Documented Target FIELD public interface CopyOnWritepackage hudson util import com thoughtworks xstream XStreamException import com thoughtworks xstream converters Converter import com thoughtworks xstream converters MarshallingContext import com thoughtworks xstream converters UnmarshallingContext import com thoughtworks xstream converters collections AbstractCollectionConverter import com thoughtworks xstream io HierarchicalStreamReader import com thoughtworks xstream io HierarchicalStreamWriter import com thoughtworks xstream mapper Mapper import java util ArrayList import java util Collection import java util Collections import java util Iterator import java util List import java util Arrays import jenkins util xstream CriticalXStreamException public class CopyOnWriteList E implements Iterable E private volatile List extends E core public CopyOnWriteList List E core this core false private CopyOnWriteList List E core boolean noCopy this core noCopy core new ArrayList E core public CopyOnWriteList this core Collections emptyList public synchronized void add E e List E n new ArrayList E core n add e core n public synchronized void addAll Collection extends E items List E n new ArrayList E core n addAll items core n public synchronized boolean remove E e List E n new ArrayList E core boolean r n remove e core n return r public Iterator E iterator final Iterator extends E itr core iterator return new Iterator E private E last public boolean hasNext return itr hasNext public E next return last itr next public void remove CopyOnWriteList this remove last public void replaceBy CopyOnWriteList extends E that this core that core public void replaceBy Collection extends E that this core new ArrayList E that public void replaceBy E that replaceBy Arrays asList that public void clear this core new ArrayList E public E E toArray E array return core toArray array public List E getView return Collections E unmodifiableList core public void addAllTo Collection super E dst dst addAll core public E get int index return core get index public boolean isEmpty return core isEmpty public int size return core size public boolean contains Object item return core contains item Override public String toString return core toString public static final class ConverterImpl extends AbstractCollectionConverter public ConverterImpl Mapper mapper super mapper public boolean canConvert Class type return type CopyOnWriteList class public void marshal Object source HierarchicalStreamWriter writer MarshallingContext context for Object o CopyOnWriteList source writeItem o context writer SuppressWarnings unchecked public CopyOnWriteList unmarshal HierarchicalStreamReader reader UnmarshallingContext context read the items from xml into a list List items new ArrayList while reader hasMoreChildren reader moveDown try Object item readItem reader context items items add item catch CriticalXStreamException e throw e catch XStreamException e RobustReflectionConverter addErrorInContext context e catch LinkageError e RobustReflectionConverter addErrorInContext context e reader moveUp return new CopyOnWriteList items truepackage hudson util import com thoughtworks xstream converters MarshallingContext import com thoughtworks xstream converters UnmarshallingContext import com thoughtworks xstream converters collections MapConverter import com thoughtworks xstream converters collections TreeMapConverter import com thoughtworks xstream io HierarchicalStreamReader import com thoughtworks xstream io HierarchicalStreamWriter import com thoughtworks xstream mapper Mapper import java util Collection import java util Collections import java util Comparator import java util HashMap import java util LinkedHashMap import java util Map import java util Set import java util TreeMap public abstract class CopyOnWriteMap K V implements Map K V protected volatile Map K V core private volatile Map K V view protected CopyOnWriteMap Map K V core update core protected CopyOnWriteMap update Collections K V emptyMap protected void update Map K V m core m view Collections unmodifiableMap core public void replaceBy Map extends K extends V data Map K V d copy d clear d putAll data update d public int size return core size public boolean isEmpty return core isEmpty public boolean containsKey Object key return core containsKey key public boolean containsValue Object value return core containsValue value public V get Object key return core get key public synchronized V put K key V value Map K V m copy V r m put key value update m return r public synchronized V remove Object key Map K V m copy V r m remove key update m return r public synchronized void putAll Map extends K extends V t Map K V m copy m putAll t update m protected abstract Map K V copy public synchronized void clear update Collections K V emptyMap public Set K keySet return view keySet public Collection V values return view values public Set Entry K V entrySet return view entrySet Override public int hashCode return copy hashCode SuppressWarnings EqualsWhichDoesntCheckParameterClass Override public boolean equals Object obj return copy equals obj Override public String toString return copy toString public static final class Hash K V extends CopyOnWriteMap K V public Hash Map K V core super new LinkedHashMap K V core public Hash protected Map K V copy return new LinkedHashMap K V core public static class ConverterImpl extends MapConverter public ConverterImpl Mapper mapper super mapper Override public boolean canConvert Class type return type Hash class Override public Object unmarshal HierarchicalStreamReader reader UnmarshallingContext context return new Hash Map super unmarshal reader context Override public void marshal Object source HierarchicalStreamWriter writer MarshallingContext context super marshal Hash source core writer context public static final class Tree K V extends CopyOnWriteMap K V private final Comparator K comparator public Tree Map K V core Comparator K comparator this comparator putAll core public Tree Comparator K comparator super new TreeMap K V comparator this comparator comparator public Tree this null protected Map K V copy TreeMap K V m new TreeMap K V comparator m putAll core return m Override public synchronized void clear update new TreeMap K V comparator public static class ConverterImpl extends TreeMapConverter public ConverterImpl Mapper mapper super mapper Override public boolean canConvert Class type return type Tree class Override public Object unmarshal HierarchicalStreamReader reader UnmarshallingContext context TreeMap tm TreeMap super unmarshal reader context return new Tree tm tm comparator Override public void marshal Object source HierarchicalStreamWriter writer MarshallingContext context super marshal Tree source core writer contextpackage jenkins model import hudson EnvVars import hudson Extension import hudson Util import hudson model Computer import hudson model EnvironmentContributor import hudson model Executor import hudson model Job import hudson model Node import hudson model Run import hudson model TaskListener import jenkins model Jenkins MasterComputer import org jenkinsci Symbol import java io IOException Extension ordinal 100 Symbol core public class CoreEnvironmentContributor extends EnvironmentContributor Override public void buildEnvironmentFor Run r EnvVars env TaskListener listener throws IOException InterruptedException Computer c Computer currentComputer if c null EnvVars compEnv c getEnvironment overrideAll env env putAll compEnv env put BUILD DISPLAY NAME r getDisplayName Jenkins j Jenkins getInstance String rootUrl j getRootUrl if rootUrl null env put BUILD URL rootUrl r getUrl Override public void buildEnvironmentFor Job j EnvVars env TaskListener listener throws IOException InterruptedException Jenkins jenkins Jenkins getInstance String rootUrl jenkins getRootUrl if rootUrl null env put JENKINS URL rootUrl env put HUDSON URL rootUrl Legacy compatibility env put JOB URL rootUrl j getUrl String root jenkins getRootDir getPath env put JENKINS HOME root env put HUDSON HOME root legacy compatibility Thread t Thread currentThread if t instanceof Executor Executor e Executor t env put EXECUTOR NUMBER String valueOf e getNumber if e getOwner instanceof MasterComputer env put NODE NAME master else env put NODE NAME e getOwner getName Node n e getOwner getNode if n null env put NODE LABELS Util join n getAssignedLabelspackage com zxy recovery core public class CrashData public long crashTime public int crashCount public boolean shouldRestart private CrashData public static CrashData newInstance return new CrashData public CrashData time long time this crashTime time return this public CrashData count int count this crashCount count return this public CrashData restart boolean restart this shouldRestart restart return this Override public String toString return CrashData crashCount crashCount crashTime crashTime shouldRestart shouldRestartpackage hudson cli import jenkins model Jenkins import hudson Extension import hudson model Item import jenkins model ModifiableTopLevelItemGroup import org kohsuke args4j Argument Extension public class CreateJobCommand extends CLICommand Override public String getShortDescription return Messages CreateJobCommand ShortDescription Argument metaVar NAME usage Name of the job to create required true public String name protected int run throws Exception Jenkins h Jenkins getActiveInstance if h getItemByFullName name null throw new IllegalStateException Job name already exists ModifiableTopLevelItemGroup ig h int i name lastIndexOf if i 0 String group name substring 0 i Item item h getItemByFullName group if item null throw new IllegalArgumentException Unknown ItemGroup group if item instanceof ModifiableTopLevelItemGroup ig ModifiableTopLevelItemGroup item else throw new IllegalStateException Can t create job from CLI in group name name substring i 1 Jenkins checkGoodName name ig createProjectFromXML name stdin return 0package hudson cli import hudson Extension import hudson model Computer import hudson model Node import hudson model Slave import hudson model User import jenkins model Jenkins import org kohsuke args4j Argument import org kohsuke args4j CmdLineException Extension public class CreateNodeCommand extends CLICommand Argument metaVar NODE usage Name of the node public String nodeName Override public String getShortDescription return Messages CreateNodeCommand ShortDescription Override protected int run throws Exception final Jenkins jenkins Jenkins getActiveInstance jenkins checkPermission Computer CREATE final Node newNode Node Jenkins XSTREAM2 fromXML stdin if nodeName null Using deprecated method but it s contract is preserved newNode setNodeName nodeName if newNode instanceof Slave change userId too User user User current Slave newNode setUserId user null anonymous user getId if jenkins getNode newNode getNodeName null throw new IllegalStateException Node newNode getNodeName already exists jenkins addNode newNode return 0package hudson cli import org kohsuke args4j Argument import jenkins model Jenkins import hudson Extension import hudson model Failure import hudson model View Extension public class CreateViewCommand extends CLICommand Argument usage Name of the view to use instead of the one in XML public String viewName null Override public String getShortDescription return Messages CreateViewCommand ShortDescription Override protected int run throws Exception final Jenkins jenkins Jenkins getActiveInstance jenkins checkPermission View CREATE View newView try newView View createViewFromXML viewName stdin catch Failure ex throw new IllegalArgumentException Invalid view name ex getMessage final String newName newView getViewName if jenkins getView newName null throw new IllegalStateException View newName already exists jenkins addView newView return 0public class Credentials static protected String test address https pal test adyen com pal servlet soap Payment static protected String live address https pal live adyen com pal servlet soap Payment static protected String recurring test address https pal test adyen com pal servlet soap Recurring static protected String recurring live address https pal test adyen com pal servlet soap Recurring static protected String merchant account your merchant account static protected String ws user your web service user static protected String pwd user your web service user passwordpublic class Credentials static protected String test address https pal test adyen com pal servlet soap Payment static protected String live address https pal live adyen com pal servlet soap Payment static protected String recurring test address https pal test adyen com pal servlet soap Recurring static protected String recurring live address https pal test adyen com pal servlet soap Recurring static protected String merchant account your merchant account static protected String ws user your web service user static protected String pwd user your web service user passwordpublic class Credentials static protected String test address https pal test adyen com pal servlet soap Payment static protected String live address https pal live adyen com pal servlet soap Payment static protected String recurring test address https pal test adyen com pal servlet soap Recurring static protected String recurring live address https pal test adyen com pal servlet soap Recurring static protected String merchant account your merchant account static protected String ws user your web service user static protected String pwd user your web service user passwordpackage jenkins util xstream import com thoughtworks xstream XStreamException import com thoughtworks xstream converters ConversionException public class CriticalXStreamException extends ConversionException private static final long serialVersionUID 1L public CriticalXStreamException XStreamException cause super causepackage hudson scheduler import antlr ANTLRException import java io StringReader import java util Calendar import java util TimeZone import java util GregorianCalendar import java util Locale import java util regex Matcher import java util regex Pattern import static java util Calendar import javax annotation CheckForNull public final class CronTab final long bits new long 4 int dayOfWeek private String spec private CheckForNull String specTimezone public CronTab String format throws ANTLRException this format null public CronTab String format Hash hash throws ANTLRException this format 1 hash Deprecated public CronTab String format int line throws ANTLRException set format line null public CronTab String format int line Hash hash throws ANTLRException this format line hash null public CronTab String format int line Hash hash CheckForNull String timezone throws ANTLRException set format line hash timezone private void set String format int line Hash hash throws ANTLRException set format line hash null private void set String format int line Hash hash String timezone throws ANTLRException CrontabLexer lexer new CrontabLexer new StringReader format lexer setLine line CrontabParser parser new CrontabParser lexer parser setHash hash spec format specTimezone timezone parser startRule this if dayOfWeek 1 7 0 dayOfWeek 1 copy bit 7 over to bit 0 dayOfWeek 1 7 clear bit 7 or CalendarField ceil will return an invalid value 7 boolean check Calendar cal Calendar checkCal cal if specTimezone null specTimezone isEmpty Calendar tzCal Calendar getInstance TimeZone getTimeZone specTimezone tzCal setTime cal getTime checkCal tzCal if checkBits bits 0 checkCal get MINUTE return false if checkBits bits 1 checkCal get HOUR OF DAY return false if checkBits bits 2 checkCal get DAY OF MONTH return false if checkBits bits 3 checkCal get MONTH 1 return false if checkBits dayOfWeek checkCal get Calendar DAY OF WEEK 1 return false return true private static abstract class CalendarField final int field final CalendarField lowerField final int offset final int min final boolean redoAdjustmentIfModified SuppressWarnings unused private final String displayName private CalendarField String displayName int field int min int offset boolean redoAdjustmentIfModified CalendarField lowerField this displayName displayName this field field this min min this redoAdjustmentIfModified redoAdjustmentIfModified this lowerField lowerField this offset offset int valueOf Calendar c return c get field offset void addTo Calendar c int i c add field i void setTo Calendar c int i c set field i offset void clear Calendar c setTo c min private int ceil CronTab c int n long bits bits c while bits 1L n bits if n 60 return 1 n return n private int first CronTab c return ceil c 0 private int floor CronTab c int n long bits bits c while bits 1L n bits if n 0 return 1 n return n private int last CronTab c return floor c 63 abstract long bits CronTab c abstract void rollUp Calendar cal int i private static final CalendarField MINUTE new CalendarField minute Calendar MINUTE 0 0 false null long bits CronTab c return c bits 0 void rollUp Calendar cal int i cal add Calendar HOUR OF DAY i private static final CalendarField HOUR new CalendarField hour Calendar HOUR OF DAY 0 0 false MINUTE long bits CronTab c return c bits 1 void rollUp Calendar cal int i cal add Calendar DAY OF MONTH i private static final CalendarField DAY OF MONTH new CalendarField day Calendar DAY OF MONTH 1 0 true HOUR long bits CronTab c return c bits 2 void rollUp Calendar cal int i cal add Calendar MONTH i private static final CalendarField MONTH new CalendarField month Calendar MONTH 1 1 false DAY OF MONTH long bits CronTab c return c bits 3 void rollUp Calendar cal int i cal add Calendar YEAR i private static final CalendarField DAY OF WEEK new CalendarField dow Calendar DAY OF WEEK 1 1 true HOUR long bits CronTab c return c dayOfWeek void rollUp Calendar cal int i cal add Calendar DAY OF WEEK 7 i Override void setTo Calendar c int i int v i offset int was c get field c set field v final int firstDayOfWeek c getFirstDayOfWeek if v firstDayOfWeek was firstDayOfWeek in crontab the first DoW is always Sunday but in Java it can be Monday or in theory arbitrary other days When first DoW is 1 2 Monday calendar points to 1 2 Monday setting the DoW to Sunday makes the calendar moves forward to 1 8 Sunday instead of 1 1 Sunday So we need to compensate that effect here addTo c 7 else if was firstDayOfWeek firstDayOfWeek v If we wrap the other way around we need to adjust in the opposite direction of above addTo c 7 private static final CalendarField ADJUST ORDER MONTH DAY OF MONTH DAY OF WEEK HOUR MINUTE public Calendar ceil long t Calendar cal new GregorianCalendar Locale US cal setTimeInMillis t return ceil cal public Calendar ceil Calendar cal OUTER while true for CalendarField f CalendarField ADJUST ORDER int cur f valueOf cal int next f ceil this cur if cur next continue this field is already in a good shape move on to next we are modifying this field so clear all the lower level fields for CalendarField l f lowerField l null l l lowerField l clear cal if next 0 we need to roll over to the next field f rollUp cal 1 f setTo cal f first this since higher order field is affected by this we need to restart from all over continue OUTER else f setTo cal next if f redoAdjustmentIfModified continue OUTER when we modify DAY OF MONTH and DAY OF WEEK do it all over from the top return cal all fields adjusted public Calendar floor long t Calendar cal new GregorianCalendar Locale US cal setTimeInMillis t return floor cal public Calendar floor Calendar cal OUTER while true for CalendarField f CalendarField ADJUST ORDER int cur f valueOf cal int next f floor this cur if cur next continue this field is already in a good shape move on to next we are modifying this field so clear all the lower level fields for CalendarField l f lowerField l null l l lowerField l clear cal if next 0 we need to borrow from the next field f rollUp cal 1 the problem here in contrast with the ceil method is that the maximum value of the field is not always a fixed value that is day of month so we zero clear all the lower fields set the desired value 1 f setTo cal f last this f addTo cal 1 then subtract a minute to achieve maximum values on all the lower fields with the desired value in f CalendarField MINUTE addTo cal 1 since higher order field is affected by this we need to restart from all over continue OUTER else f setTo cal next f addTo cal 1 CalendarField MINUTE addTo cal 1 if f redoAdjustmentIfModified continue OUTER when we modify DAY OF MONTH and DAY OF WEEK do it all over from the top return cal all fields adjusted void set String format Hash hash throws ANTLRException set format 1 hash private boolean checkBits long bitMask int n return bitMask 1L n bitMask public String toString return super toString toString minute bits 0 toString hour bits 1 toString dayOfMonth bits 2 toString month bits 3 toString dayOfWeek dayOfWeek private String toString String key long bit return key Long toHexString bit public CheckForNull String checkSanity OUTER for int i 0 i 5 i long bitMask i 4 bits i long dayOfWeek for int j BaseParser LOWER BOUNDS i j BaseParser UPPER BOUNDS i j if checkBits bitMask j this rank has a sparse entry if we have a sparse rank one of them better be the left most if i 0 return Messages CronTab do you really mean every minute when you spec H spec substring spec indexOf 1 once we find a sparse rank upper ranks don t matter break OUTER int daysOfMonth 0 for int i 1 i 31 i if checkBits bits 2 i daysOfMonth if daysOfMonth 5 daysOfMonth 28 a bit arbitrary return Messages CronTab short cycles in the day of month field w String hashified hashify spec if hashified null return Messages CronTab spread load evenly by using rather than hashified spec return null public static CheckForNull String hashify String spec if spec contains H if someone is already using H presumably he knows what it is so a warning is likely false positive return null else if spec startsWith 15 every N minutes to hash return H spec substring 1 else if spec matches d 0 certain minute to hash return H spec substring spec indexOf 1 else Matcher m Pattern compile 0 d d matcher spec if m matches 0 15 30 45 to H 15 int period Integer parseInt m group 2 if period 0 StringBuilder b new StringBuilder for int i period i 60 i period b append append i if b toString equals m group 1 return H period m group 4 return nullpackage hudson scheduler import antlr ANTLRException import java util Calendar import java util TimeZone import java util Collection import java util Vector import javax annotation CheckForNull import javax annotation Nonnull import org kohsuke accmod Restricted import org kohsuke accmod restrictions NoExternalUse import java util logging Level import java util logging Logger public final class CronTabList private final Vector CronTab tabs public CronTabList Collection CronTab tabs this tabs new Vector tabs public synchronized boolean check Calendar cal for CronTab tab tabs if tab check cal return true return false public String checkSanity for CronTab tab tabs String s tab checkSanity if s null return s return null public static CheckForNull String getValidTimezone String timezone String validIDs TimeZone getAvailableIDs for String str validIDs if str null str equals timezone return timezone return null public static CronTabList create Nonnull String format throws ANTLRException return create format null public static CronTabList create Nonnull String format Hash hash throws ANTLRException Vector CronTab r new Vector int lineNumber 0 String timezone null for String line format split r n lineNumber line line trim if lineNumber 1 line startsWith TZ timezone getValidTimezone line replace TZ if timezone null LOGGER log Level CONFIG cron with timezone 0 timezone else LOGGER log Level CONFIG invalid timezone 0 line continue if line length 0 line startsWith continue ignorable line try r add new CronTab line lineNumber hash timezone catch ANTLRException e throw new ANTLRException Messages CronTabList InvalidInput line e toString e return new CronTabList r Restricted NoExternalUse class just for form validation public CheckForNull Calendar previous Calendar nearest null for CronTab tab tabs Calendar scheduled tab floor Calendar getInstance if nearest null nearest before scheduled nearest scheduled return nearest Restricted NoExternalUse class just for form validation public CheckForNull Calendar next Calendar nearest null for CronTab tab tabs Calendar scheduled tab ceil Calendar getInstance if nearest null nearest after scheduled nearest scheduled return nearest private static final Logger LOGGER Logger getLogger CronTabList class getNamepackage hudson security csrf import hudson ExtensionList import hudson ExtensionPoint import javax servlet FilterChain import javax servlet ServletException import javax servlet http HttpServletRequest import javax servlet http HttpServletResponse import java io IOException public abstract class CrumbExclusion implements ExtensionPoint public abstract boolean process HttpServletRequest request HttpServletResponse response FilterChain chain throws IOException ServletException public static ExtensionList CrumbExclusion all return ExtensionList lookup CrumbExclusion classpackage hudson security csrf import hudson util MultipartFormDataParser import jenkins model Jenkins import java io IOException import java util Enumeration import java util logging Level import java util logging Logger import javax servlet Filter import javax servlet FilterChain import javax servlet FilterConfig import javax servlet ServletException import javax servlet ServletRequest import javax servlet ServletResponse import javax servlet http HttpServletRequest import javax servlet http HttpServletResponse public class CrumbFilter implements Filter public CrumbIssuer getCrumbIssuer Jenkins h Jenkins getInstanceOrNull if h null return null before Jenkins is initialized return h getCrumbIssuer public void init FilterConfig filterConfig throws ServletException public void doFilter ServletRequest request ServletResponse response FilterChain chain throws IOException ServletException CrumbIssuer crumbIssuer getCrumbIssuer if crumbIssuer null request instanceof HttpServletRequest chain doFilter request response return HttpServletRequest httpRequest HttpServletRequest request HttpServletResponse httpResponse HttpServletResponse response if POST equals httpRequest getMethod for CrumbExclusion e CrumbExclusion all if e process httpRequest httpResponse chain return String crumbFieldName crumbIssuer getDescriptor getCrumbRequestField String crumbSalt crumbIssuer getDescriptor getCrumbSalt boolean valid false String crumb extractCrumbFromRequest httpRequest crumbFieldName if crumb null compatibility for clients that hard code the default crumb name up to Jenkins 1 TODO extractCrumbFromRequest httpRequest crumb if crumb null if crumbIssuer validateCrumb httpRequest crumbSalt crumb valid true else LOGGER log Level WARNING Found invalid crumb 0 Will check remaining parameters for a valid one crumb if valid chain doFilter request response else LOGGER log Level WARNING No valid crumb was included in request for 0 Returning 1 new Object httpRequest getRequestURI HttpServletResponse SC FORBIDDEN httpResponse sendError HttpServletResponse SC FORBIDDEN No valid crumb was included in the request else chain doFilter request response private String extractCrumbFromRequest HttpServletRequest httpRequest String crumbFieldName String crumb httpRequest getHeader crumbFieldName if crumb null Enumeration paramNames httpRequest getParameterNames while paramNames hasMoreElements String paramName String paramNames nextElement if crumbFieldName equals paramName crumb httpRequest getParameter paramName break return crumb protected static boolean isMultipart HttpServletRequest request if request null return false return MultipartFormDataParser isMultiPartForm request getContentType Override public void destroy private static final Logger LOGGER Logger getLogger CrumbFilter class getNamepackage hudson security csrf import javax servlet ServletRequest import hudson init Initializer import jenkins model Jenkins import org kohsuke stapler Stapler import org kohsuke stapler StaplerRequest import org kohsuke stapler WebApp import org kohsuke stapler export Exported import org kohsuke stapler export ExportedBean import hudson DescriptorExtensionList import hudson ExtensionPoint import hudson model Api import hudson model Describable import hudson model Descriptor import hudson util MultipartFormDataParser import java io IOException import java io OutputStream import javax servlet ServletException import org kohsuke accmod Restricted import org kohsuke accmod restrictions NoExternalUse import org kohsuke stapler QueryParameter import org kohsuke stapler StaplerResponse ExportedBean public abstract class CrumbIssuer implements Describable CrumbIssuer ExtensionPoint private static final String CRUMB ATTRIBUTE CrumbIssuer class getName crumb Restricted NoExternalUse class public static final String DEFAULT CRUMB NAME Jenkins Crumb Exported public String getCrumbRequestField return getDescriptor getCrumbRequestField Exported public String getCrumb return getCrumb Stapler getCurrentRequest public String getCrumb ServletRequest request String crumb null if request null crumb String request getAttribute CRUMB ATTRIBUTE if crumb null crumb issueCrumb request getDescriptor getCrumbSalt if request null if crumb null crumb length 0 request setAttribute CRUMB ATTRIBUTE crumb else request removeAttribute CRUMB ATTRIBUTE return crumb protected abstract String issueCrumb ServletRequest request String salt public boolean validateCrumb ServletRequest request CrumbIssuerDescriptor CrumbIssuer desc getDescriptor String crumbField desc getCrumbRequestField String crumbSalt desc getCrumbSalt return validateCrumb request crumbSalt request getParameter crumbField public boolean validateCrumb ServletRequest request MultipartFormDataParser parser CrumbIssuerDescriptor CrumbIssuer desc getDescriptor String crumbField desc getCrumbRequestField String crumbSalt desc getCrumbSalt return validateCrumb request crumbSalt parser get crumbField public abstract boolean validateCrumb ServletRequest request String salt String crumb public CrumbIssuerDescriptor CrumbIssuer getDescriptor return CrumbIssuerDescriptor CrumbIssuer Jenkins getInstance getDescriptorOrDie getClass public static DescriptorExtensionList CrumbIssuer Descriptor CrumbIssuer all return Jenkins getInstance CrumbIssuer Descriptor CrumbIssuer getDescriptorList CrumbIssuer class public Api getApi return new RestrictedApi this Initializer public static void initStaplerCrumbIssuer WebApp get Jenkins getInstance servletContext setCrumbIssuer new org kohsuke stapler CrumbIssuer Override public String issueCrumb StaplerRequest request CrumbIssuer ci Jenkins getInstance getCrumbIssuer return ci null ci getCrumb request DEFAULT issueCrumb request Override public void validateCrumb StaplerRequest request String submittedCrumb CrumbIssuer ci Jenkins getInstance getCrumbIssuer if ci null DEFAULT validateCrumb request submittedCrumb else if ci validateCrumb request ci getDescriptor getCrumbSalt submittedCrumb throw new SecurityException Crumb didn t match Restricted NoExternalUse class public static class RestrictedApi extends Api RestrictedApi CrumbIssuer instance super instance Override public void doXml StaplerRequest req StaplerResponse rsp QueryParameter String xpath QueryParameter String wrapper QueryParameter String tree QueryParameter int depth throws IOException ServletException String text CrumbIssuer ci CrumbIssuer bean if crumb text equals xpath ditto text ci getCrumb else if concat crumbRequestField crumb equals xpath new FullDuplexHttpStream Main text ci getCrumbRequestField ci getCrumb else if concat crumbRequestField crumb equals xpath NetBeans if ci getCrumbRequestField startsWith ci getCrumbRequestField contains text ci getCrumbRequestField ci getCrumb else text null else text null if text null try OutputStream o rsp getCompressedOutputStream req rsp setContentType text plain charset UTF 8 o write text getBytes UTF 8 else super doXml req rsp xpath wrapper tree depthpackage hudson security csrf import hudson Util import hudson model Descriptor public abstract class CrumbIssuerDescriptor T extends CrumbIssuer extends Descriptor CrumbIssuer private String crumbSalt private String crumbRequestField protected CrumbIssuerDescriptor String salt String crumbRequestField setCrumbSalt salt setCrumbRequestField crumbRequestField public String getCrumbSalt return crumbSalt public void setCrumbSalt String salt if Util fixEmptyAndTrim salt null crumbSalt hudson crumb else crumbSalt salt public String getCrumbRequestField return crumbRequestField public void setCrumbRequestField String requestField if Util fixEmptyAndTrim requestField null crumbRequestField CrumbIssuer DEFAULT CRUMB NAME else crumbRequestField requestFieldpackage jenkins security import hudson util Secret import javax crypto Cipher import javax crypto SecretKey import javax crypto spec SecretKeySpec import java io IOException import java security GeneralSecurityException public class CryptoConfidentialKey extends ConfidentialKey private volatile SecretKey secret public CryptoConfidentialKey String id super id public CryptoConfidentialKey Class owner String shortName this owner getName shortName private SecretKey getKey try if secret null synchronized this if secret null byte payload load if payload null payload ConfidentialStore get randomBytes 256 store payload Due to the stupid US export restriction JDK only ships 128bit version secret new SecretKeySpec payload 0 128 8 ALGORITHM return secret catch IOException e throw new Error Failed to load the key getId e public Cipher encrypt try Cipher cipher Secret getCipher ALGORITHM cipher init Cipher ENCRYPT MODE getKey return cipher catch GeneralSecurityException e throw new AssertionError e public Cipher decrypt try Cipher cipher Secret getCipher ALGORITHM cipher init Cipher DECRYPT MODE getKey return cipher catch GeneralSecurityException e throw new AssertionError e private static final String ALGORITHM AESpackage hudson util import hudson Util import java util ArrayList import java util HashSet import java util List import java util Set import java util Stack public abstract class CyclicGraphDetector N private final Set N visited new HashSet N private final Set N visiting new HashSet N private final Stack N path new Stack N private final List N topologicalOrder new ArrayList N public void run Iterable extends N allNodes throws CycleDetectedException for N n allNodes visit n public List N getSorted return topologicalOrder protected abstract Iterable extends N getEdges N n private void visit N p throws CycleDetectedException if visited add p return visiting add p path push p for N q getEdges p if q null continue ignore unresolved references if visiting contains q detectedCycle q visit q visiting remove p path pop topologicalOrder add p private void detectedCycle N q throws CycleDetectedException int i path indexOf q path push q reactOnCycle q path subList i path size protected void reactOnCycle N q List N cycle throws CycleDetectedException throw new CycleDetectedException cycle public static final class CycleDetectedException extends Exception public final List cycle public CycleDetectedException List cycle super Cycle detected Util join cycle this cycle cyclepackage hudson util import java util concurrent Executors import java util concurrent ThreadFactory public class DaemonThreadFactory implements ThreadFactory private final ThreadFactory core public DaemonThreadFactory this Executors defaultThreadFactory public DaemonThreadFactory ThreadFactory core this core core public Thread newThread Runnable r Thread t core newThread r t setDaemon true return tpackage com colorfulnews import de greenrobot daogenerator DaoGenerator import de greenrobot daogenerator Entity import de greenrobot daogenerator Schema public class DaoAutoGenerator public static void main String args throws Exception int version 1 String defaultJavaPackage com kaku colorfulnews greendao Entity Schema Schema schema new Schema version defaultJavaPackage Bean DAO Schema schema new Schema 1 me itangqi bean schema setDefaultJavaPackageDao me itangqi dao Schema flags entity activie keep sections schema2 enableActiveEntitiesByDefault schema2 enableKeepSectionsByDefault Schema Entities createTable schema DAOGenerator generateAll java gen build gradle new DaoGenerator generateAll schema app src main java gen private static void createTable Schema schema Note Entity entity schema addEntity NewsChannelTable note setTableName NODE greenDAO Java For example a property called creationDate will become a database column CREATION DATE note addIdProperty entity addStringProperty newsChannelName notNull primaryKey index entity addStringProperty newsChannelId notNull entity addStringProperty newsChannelType notNull entity addBooleanProperty newsChannelSelect notNull entity addIntProperty newsChannelIndex notNull entity addBooleanProperty newsChannelFixedpackage com example public class DaoGeneratorpackage com kaku colorfulnews greendao import android content Context import android database sqlite SQLiteDatabase import android database sqlite SQLiteDatabase CursorFactory import android database sqlite SQLiteOpenHelper import android util Log import de greenrobot dao AbstractDaoMaster import de greenrobot dao identityscope IdentityScopeType import com kaku colorfulnews greendao NewsChannelTableDao THIS CODE IS GENERATED BY greenDAO DO NOT EDIT public class DaoMaster extends AbstractDaoMaster public static final int SCHEMA VERSION 1 public static void createAllTables SQLiteDatabase db boolean ifNotExists NewsChannelTableDao createTable db ifNotExists public static void dropAllTables SQLiteDatabase db boolean ifExists NewsChannelTableDao dropTable db ifExists public static abstract class OpenHelper extends SQLiteOpenHelper public OpenHelper Context context String name CursorFactory factory super context name factory SCHEMA VERSION Override public void onCreate SQLiteDatabase db Log i greenDAO Creating tables for schema version SCHEMA VERSION createAllTables db false public static class DevOpenHelper extends OpenHelper public DevOpenHelper Context context String name CursorFactory factory super context name factory Override public void onUpgrade SQLiteDatabase db int oldVersion int newVersion Log i greenDAO Upgrading schema from version oldVersion to newVersion by dropping all tables dropAllTables db true onCreate db public DaoMaster SQLiteDatabase db super db SCHEMA VERSION registerDaoClass NewsChannelTableDao class public DaoSession newSession return new DaoSession db IdentityScopeType Session daoConfigMap public DaoSession newSession IdentityScopeType type return new DaoSession db type daoConfigMappackage com kaku colorfulnews greendao import android database sqlite SQLiteDatabase import java util Map import de greenrobot dao AbstractDao import de greenrobot dao AbstractDaoSession import de greenrobot dao identityscope IdentityScopeType import de greenrobot dao internal DaoConfig import com kaku colorfulnews greendao NewsChannelTable import com kaku colorfulnews greendao NewsChannelTableDao THIS CODE IS GENERATED BY greenDAO DO NOT EDIT public class DaoSession extends AbstractDaoSession private final DaoConfig newsChannelTableDaoConfig private final NewsChannelTableDao newsChannelTableDao public DaoSession SQLiteDatabase db IdentityScopeType type Map Class extends AbstractDao DaoConfig daoConfigMap super db newsChannelTableDaoConfig daoConfigMap get NewsChannelTableDao class clone newsChannelTableDaoConfig initIdentityScope type newsChannelTableDao new NewsChannelTableDao newsChannelTableDaoConfig this registerDao NewsChannelTable class newsChannelTableDao public void clear newsChannelTableDaoConfig getIdentityScope clear public NewsChannelTableDao getNewsChannelTableDao return newsChannelTableDaopackage hudson util import org jfree data category CategoryDataset import org jfree data category DefaultCategoryDataset import java util ArrayList import java util List import java util TreeSet public final class DataSetBuilder Row extends Comparable Column extends Comparable private List Number values new ArrayList Number private List Row rows new ArrayList Row private List Column columns new ArrayList Column public void add Number value Row rowKey Column columnKey values add value rows add rowKey columns add columnKey public CategoryDataset build DefaultCategoryDataset ds new DefaultCategoryDataset TreeSet Row rowSet new TreeSet Row rows TreeSet Column colSet new TreeSet Column columns Comparable rows rowSet toArray new Comparable rowSet size Comparable cols colSet toArray new Comparable colSet size insert rows and columns in the right order for Comparable r rows ds setValue null r cols 0 for Comparable c cols ds setValue null rows 0 c for int i 0 i values size i ds addValue values get i rows get i columns get i return dspackage hudson util import java io FilterOutputStream import java io IOException import java io OutputStream public class DecodingStream extends FilterOutputStream private int last 1 public DecodingStream OutputStream out super out Override public void write int b throws IOException if last 1 last b return out write Character getNumericValue last 16 Character getNumericValue b last 1package hudson util spring import groovy lang GroovyObjectSupport import org apache commons lang StringUtils import org springframework beans BeanWrapper import org springframework beans BeanWrapperImpl import org springframework beans factory config AutowireCapableBeanFactory import org springframework beans factory config ConstructorArgumentValues import org springframework beans factory config RuntimeBeanReference import org springframework beans factory support AbstractBeanDefinition import org springframework beans factory support ChildBeanDefinition import org springframework beans factory support RootBeanDefinition import java util class DefaultBeanConfiguration extends GroovyObjectSupport implements BeanConfiguration private static final String AUTOWIRE autowire private static final String CONSTRUCTOR ARGS constructorArgs private static final String DESTROY METHOD destroyMethod private static final String FACTORY BEAN factoryBean private static final String FACTORY METHOD factoryMethod private static final String INIT METHOD initMethod private static final String BY NAME byName private static final String PARENT parent private static final String BY TYPE byType private static final String BY CONSTRUCTOR constructor private static final Set String DYNAMIC PROPS new HashSet String Arrays asList AUTOWIRE CONSTRUCTOR ARGS DESTROY METHOD FACTORY BEAN FACTORY METHOD INIT METHOD BY NAME BY TYPE BY CONSTRUCTOR private String parentName Override public Object getProperty String property getBeanDefinition if wrapper isReadableProperty property return wrapper getPropertyValue property else if DYNAMIC PROPS contains property return null return super getProperty property Override public void setProperty String property Object newValue if PARENT equals property setParent newValue else AbstractBeanDefinition bd getBeanDefinition if AUTOWIRE equals property if BY NAME equals newValue bd setAutowireMode AutowireCapableBeanFactory AUTOWIRE BY NAME else if BY TYPE equals newValue bd setAutowireMode AutowireCapableBeanFactory AUTOWIRE BY TYPE else if Boolean TRUE equals newValue bd setAutowireMode AutowireCapableBeanFactory AUTOWIRE BY NAME else if BY CONSTRUCTOR equals newValue bd setAutowireMode AutowireCapableBeanFactory AUTOWIRE CONSTRUCTOR constructorArgs else if CONSTRUCTOR ARGS equals property newValue instanceof List ConstructorArgumentValues cav new ConstructorArgumentValues List args List newValue for Object e args cav addGenericArgumentValue e bd setConstructorArgumentValues cav destroyMethod else if DESTROY METHOD equals property if newValue null bd setDestroyMethodName newValue toString factoryBean else if FACTORY BEAN equals property if newValue null bd setFactoryBeanName newValue toString factoryMethod else if FACTORY METHOD equals property if newValue null bd setFactoryMethodName newValue toString initMethod else if INIT METHOD equals property if newValue null bd setInitMethodName newValue toString else if wrapper isWritableProperty property wrapper setPropertyValue property newValue autowire else super setProperty property newValue private Class clazz private String name private boolean singleton true private AbstractBeanDefinition definition private Collection constructorArgs Collections EMPTY LIST private BeanWrapper wrapper public DefaultBeanConfiguration String name Class clazz this name name this clazz clazz public DefaultBeanConfiguration String name Class clazz boolean prototype this name clazz Collections EMPTY LIST this singleton prototype public DefaultBeanConfiguration String name this name null Collections EMPTY LIST public DefaultBeanConfiguration Class clazz2 this clazz clazz2 public DefaultBeanConfiguration String name2 Class clazz2 Collection args this name name2 this clazz clazz2 this constructorArgs args public DefaultBeanConfiguration String name2 boolean prototype this name2 null Collections EMPTY LIST this singleton prototype public DefaultBeanConfiguration Class clazz2 Collection constructorArguments this clazz clazz2 this constructorArgs constructorArguments public String getName return this name public boolean isSingleton return this singleton public AbstractBeanDefinition getBeanDefinition if definition null definition createBeanDefinition return definition protected AbstractBeanDefinition createBeanDefinition AbstractBeanDefinition bd if constructorArgs size 0 ConstructorArgumentValues cav new ConstructorArgumentValues for Object constructorArg constructorArgs cav addGenericArgumentValue constructorArg if StringUtils isBlank parentName bd new RootBeanDefinition clazz cav null else bd new ChildBeanDefinition parentName clazz cav null bd setSingleton singleton else if StringUtils isBlank parentName bd new RootBeanDefinition clazz singleton else bd new ChildBeanDefinition parentName clazz null null bd setSingleton singleton wrapper new BeanWrapperImpl bd return bd public BeanConfiguration addProperty String propertyName Object propertyValue if propertyValue instanceof BeanConfiguration propertyValue BeanConfiguration propertyValue getBeanDefinition getBeanDefinition getPropertyValues addPropertyValue propertyName propertyValue return this public BeanConfiguration setDestroyMethod String methodName getBeanDefinition setDestroyMethodName methodName return this public BeanConfiguration setDependsOn String dependsOn getBeanDefinition setDependsOn dependsOn return this public BeanConfiguration setFactoryBean String beanName getBeanDefinition setFactoryBeanName beanName return this public BeanConfiguration setFactoryMethod String methodName getBeanDefinition setFactoryMethodName methodName return this public BeanConfiguration setAutowire String type if byName equals type getBeanDefinition setAutowireMode AbstractBeanDefinition AUTOWIRE BY NAME else if byType equals type getBeanDefinition setAutowireMode AbstractBeanDefinition AUTOWIRE BY TYPE return this public void setName String beanName this name beanName public Object getPropertyValue String name return getBeanDefinition getPropertyValues getPropertyValue name getValue public boolean hasProperty String name return getBeanDefinition getPropertyValues contains name public void setPropertyValue String property Object newValue getBeanDefinition getPropertyValues addPropertyValue property newValue public BeanConfiguration setAbstract boolean isAbstract getBeanDefinition setAbstract isAbstract return this public void setParent Object obj if obj null throw new IllegalArgumentException Parent bean cannot be set to a null runtime bean reference if obj instanceof String this parentName String obj else if obj instanceof RuntimeBeanReference this parentName RuntimeBeanReference obj getBeanName else if obj instanceof BeanConfiguration this parentName BeanConfiguration obj getNamepackage jenkins security import hudson FilePath import hudson Util import hudson util Secret import hudson util TextFile import jenkins model Jenkins import javax crypto Cipher import javax crypto CipherInputStream import javax crypto CipherOutputStream import javax crypto SecretKey import java io File import java io FileInputStream import java io FileOutputStream import java io IOException import java security GeneralSecurityException import java security SecureRandom import javax crypto BadPaddingException import org apache commons io IOUtils MetaInfServices not annotated because this is the fallback implementation public class DefaultConfidentialStore extends ConfidentialStore private final SecureRandom sr new SecureRandom private final File rootDir private final SecretKey masterKey public DefaultConfidentialStore throws IOException InterruptedException this new File Jenkins getInstance getRootDir secrets public DefaultConfidentialStore File rootDir throws IOException InterruptedException this rootDir rootDir if rootDir mkdirs protect this directory but don t change the permission of the existing directory in case the administrator changed this new FilePath rootDir chmod 0700 TextFile masterSecret new TextFile new File rootDir master key if masterSecret exists we are only going to use small number of bits since export control limits AES key length but let s generate a long enough key anyway masterSecret write Util toHexString randomBytes 128 this masterKey Util toAes128Key masterSecret readTrim Override protected void store ConfidentialKey key byte payload throws IOException CipherOutputStream cos null FileOutputStream fos null try Cipher sym Secret getCipher AES sym init Cipher ENCRYPT MODE masterKey cos new CipherOutputStream fos new FileOutputStream getFileFor key sym cos write payload cos write MAGIC catch GeneralSecurityException e throw new IOException Failed to persist the key key getId e finally IOUtils closeQuietly cos IOUtils closeQuietly fos Override protected byte load ConfidentialKey key throws IOException CipherInputStream cis null FileInputStream fis null try File f getFileFor key if f exists return null Cipher sym Secret getCipher AES sym init Cipher DECRYPT MODE masterKey cis new CipherInputStream fis new FileInputStream f sym byte bytes IOUtils toByteArray cis return verifyMagic bytes catch GeneralSecurityException e throw new IOException Failed to load the key key getId e catch IOException x if x getCause instanceof BadPaddingException return null broken somehow else throw x finally IOUtils closeQuietly cis IOUtils closeQuietly fis private byte verifyMagic byte payload int payloadLen payload length MAGIC length if payloadLen 0 return null obviously broken for int i 0 i MAGIC length i if payload payloadLen i MAGIC i return null broken byte truncated new byte payloadLen System arraycopy payload 0 truncated 0 truncated length return truncated private File getFileFor ConfidentialKey key return new File rootDir key getId public byte randomBytes int size byte random new byte size sr nextBytes random return random private static final byte MAGIC MAGIC getBytespackage hudson security csrf import java nio charset Charset import java security MessageDigest import java security NoSuchAlgorithmException import java util logging Level import java util logging Logger import hudson Extension import jenkins util SystemProperties import hudson Util import jenkins model Jenkins import hudson model ModelObject import javax servlet ServletRequest import javax servlet http HttpServletRequest import jenkins security HexStringConfidentialKey import net sf json JSONObject import org acegisecurity Authentication import org jenkinsci Symbol import org kohsuke stapler DataBoundConstructor import org kohsuke stapler StaplerRequest public class DefaultCrumbIssuer extends CrumbIssuer private transient MessageDigest md private boolean excludeClientIPFromCrumb DataBoundConstructor public DefaultCrumbIssuer boolean excludeClientIPFromCrumb try this md MessageDigest getInstance MD5 this excludeClientIPFromCrumb excludeClientIPFromCrumb catch NoSuchAlgorithmException e this md null this excludeClientIPFromCrumb false LOGGER log Level SEVERE Can t find MD5 e public boolean isExcludeClientIPFromCrumb return this excludeClientIPFromCrumb private Object readResolve try this md MessageDigest getInstance MD5 catch NoSuchAlgorithmException e this md null LOGGER log Level SEVERE Can t find MD5 e return this Override protected synchronized String issueCrumb ServletRequest request String salt if request instanceof HttpServletRequest if md null HttpServletRequest req HttpServletRequest request StringBuilder buffer new StringBuilder Authentication a Jenkins getAuthentication if a null buffer append a getName buffer append if isExcludeClientIPFromCrumb buffer append getClientIP req md update buffer toString getBytes return Util toHexString md digest salt getBytes return null Override public boolean validateCrumb ServletRequest request String salt String crumb if request instanceof HttpServletRequest String newCrumb issueCrumb request salt if newCrumb null crumb null String equals is not constant time but this is return MessageDigest isEqual newCrumb getBytes Charset forName US ASCII crumb getBytes Charset forName US ASCII return false private static final String X FORWARDED FOR X Forwarded For private String getClientIP HttpServletRequest req String defaultAddress req getRemoteAddr String forwarded req getHeader X FORWARDED FOR if forwarded null String hopList forwarded split if hopList length 1 return hopList 0 return defaultAddress Extension Symbol standard public static final class DescriptorImpl extends CrumbIssuerDescriptor DefaultCrumbIssuer implements ModelObject private final static HexStringConfidentialKey CRUMB SALT new HexStringConfidentialKey Jenkins class crumbSalt 16 public DescriptorImpl super CRUMB SALT get SystemProperties getString hudson security csrf requestfield CrumbIssuer DEFAULT CRUMB NAME load Override public String getDisplayName return Messages DefaultCrumbIssuer DisplayName Override public DefaultCrumbIssuer newInstance StaplerRequest req JSONObject formData throws FormException if req null This state is prohibited according to the Javadoc of the super method throw new FormException DefaultCrumbIssuer new instance method is called for null Stapler request Such call is prohibited req return req bindJSON DefaultCrumbIssuer class formData private static final Logger LOGGER Logger getLogger DefaultCrumbIssuer class getNamepackage jenkins security s2m import hudson Extension import jenkins util SystemProperties import hudson remoting ChannelBuilder import jenkins ReflectiveFilePathFilter import jenkins security ChannelConfigurator import org kohsuke accmod Restricted import org kohsuke accmod restrictions DoNotUse import java io File import java util logging Level import java util logging Logger Restricted DoNotUse class impl Extension public class DefaultFilePathFilter extends ChannelConfigurator public static boolean BYPASS SystemProperties getBoolean DefaultFilePathFilter class getName allow private static final Logger LOGGER Logger getLogger DefaultFilePathFilter class getName Override public void onChannelBuilding ChannelBuilder builder Object context new ReflectiveFilePathFilter protected boolean op String op File f throws SecurityException if BYPASS LOGGER log Level FINE agent allowed to 0 1 new Object op f return true else return false installTo builder AdminFilePathFilter ORDINAL 100 for the bypass switch to be effective it should have a high prioritypackage jenkins mvn import hudson Extension import hudson FilePath import hudson model AbstractBuild import hudson model TaskListener import org jenkinsci Symbol import org kohsuke stapler DataBoundConstructor public class DefaultGlobalSettingsProvider extends GlobalSettingsProvider DataBoundConstructor public DefaultGlobalSettingsProvider Override public FilePath supplySettings AbstractBuild project TaskListener listener return null Extension ordinal 99 Symbol standard public static class DescriptorImpl extends GlobalSettingsProviderDescriptor Override public String getDisplayName return Messages DefaultGlobalSettingsProvider DisplayNamepackage com zxy recovery tools import com zxy recovery exception RecoveryException public class DefaultHandlerUtil private DefaultHandlerUtil throw new RecoveryException Stub private static Thread UncaughtExceptionHandler getDefaultUncaughtExceptionHandler Object object Reflect on com android internal os RuntimeInit UncaughtHandler constructor newInstance return object null null Thread UncaughtExceptionHandler object public static boolean isSystemDefaultUncaughtExceptionHandler Thread UncaughtExceptionHandler handler Thread UncaughtExceptionHandler defHandler getDefaultUncaughtExceptionHandler return defHandler null defHandler getClass isInstance handlerpackage jenkins slaves import edu umd cs findbugs annotations NonNull import hudson Extension import hudson TcpSlaveAgentListener ConnectionFromCurrentPeer import hudson Util import hudson model Computer import hudson model Slave import hudson remoting Channel import hudson slaves JNLPLauncher import hudson slaves SlaveComputer import java io OutputStream import java io PrintWriter import javax annotation CheckForNull import javax annotation Nonnull import jenkins model Jenkins import jenkins security ChannelConfigurator import org apache commons io IOUtils import org jenkinsci remoting engine JnlpConnectionState import java io IOException import java security SecureRandom import java util concurrent ExecutionException import java util concurrent TimeUnit import java util concurrent TimeoutException import java util logging Level import java util logging Logger import org jenkinsci remoting protocol impl ConnectionRefusalException Extension public class DefaultJnlpSlaveReceiver extends JnlpAgentReceiver Override public boolean owns String clientName Computer computer Jenkins getInstance getComputer clientName return computer null Override public void afterProperties NonNull JnlpConnectionState event String clientName event getProperty JnlpConnectionState CLIENT NAME KEY SlaveComputer computer SlaveComputer Jenkins getInstance getComputer clientName if computer null computer getLauncher instanceof JNLPLauncher event reject new ConnectionRefusalException String format s is not a JNLP agent clientName return Channel ch computer getChannel if ch null String cookie event getProperty JnlpConnectionState COOKIE KEY if cookie null cookie equals ch getProperty COOKIE NAME we think we are currently connected but this request proves that it s from the party we are supposed to be communicating to so let the current one get disconnected LOGGER log Level INFO Disconnecting 0 as we are reconnected from the current peer clientName try computer disconnect new ConnectionFromCurrentPeer get 15 TimeUnit SECONDS catch ExecutionException TimeoutException InterruptedException e event reject new ConnectionRefusalException Failed to disconnect the current client e return else event reject new ConnectionRefusalException String format s is already connected to this master Rejecting this connection clientName return event approve event setStash new State computer Override public void beforeChannel NonNull JnlpConnectionState event DefaultJnlpSlaveReceiver State state event getStash DefaultJnlpSlaveReceiver State class final SlaveComputer computer state getNode final OutputStream log computer openLogFile state setLog log PrintWriter logw new PrintWriter log true logw println JNLP agent connected from event getSocket getInetAddress for ChannelConfigurator cc ChannelConfigurator all cc onChannelBuilding event getChannelBuilder computer event getChannelBuilder withHeaderStream log String cookie event getProperty JnlpConnectionState COOKIE KEY if cookie null event getChannelBuilder withProperty COOKIE NAME cookie Override public void afterChannel NonNull JnlpConnectionState event DefaultJnlpSlaveReceiver State state event getStash DefaultJnlpSlaveReceiver State class final SlaveComputer computer state getNode try computer setChannel event getChannel state getLog null catch IOException InterruptedException e PrintWriter logw new PrintWriter state getLog true e printStackTrace logw IOUtils closeQuietly event getChannel Override public void channelClosed NonNull JnlpConnectionState event final String nodeName event getProperty JnlpConnectionState CLIENT NAME KEY IOException cause event getCloseCause if cause null LOGGER log Level WARNING Thread currentThread getName for nodeName terminated cause private static class State implements JnlpConnectionState ListenerState Nonnull private final SlaveComputer node CheckForNull private OutputStream log public State Nonnull SlaveComputer node this node node Nonnull public SlaveComputer getNode return node CheckForNull public OutputStream getLog return log public void setLog Nonnull OutputStream log this log log private static final Logger LOGGER Logger getLogger DefaultJnlpSlaveReceiver class getName private static final String COOKIE NAME JnlpSlaveAgentProtocol2 class getName cookiepackage hudson views import hudson Extension import org jenkinsci Symbol import org kohsuke stapler DataBoundConstructor public class DefaultMyViewsTabBar extends MyViewsTabBar DataBoundConstructor public DefaultMyViewsTabBar Extension Symbol standard public static class DescriptorImpl extends MyViewsTabBarDescriptor Override public String getDisplayName return Messages DefaultMyViewsTabsBar DisplayName return Default My Views TabsBarpackage hudson util spring import org springframework beans PropertyValue import org springframework beans factory config BeanDefinition import org springframework beans factory config BeanFactoryPostProcessor import org springframework beans factory support AbstractBeanDefinition import org springframework context ApplicationContext import org springframework context support StaticApplicationContext import org springframework web context WebApplicationContext import org springframework web context support StaticWebApplicationContext import javax servlet ServletContext import java util ArrayList import java util Collection import java util HashMap import java util List import java util Map import java util logging Level import java util logging Logger class DefaultRuntimeSpringConfiguration implements RuntimeSpringConfiguration private static final Logger LOGGER Logger getLogger DefaultRuntimeSpringConfiguration class getName private StaticWebApplicationContext context private Map String BeanConfiguration beanConfigs new HashMap String BeanConfiguration private Map String BeanDefinition beanDefinitions new HashMap String BeanDefinition private List String beanNames new ArrayList String public DefaultRuntimeSpringConfiguration super this context new StaticWebApplicationContext public DefaultRuntimeSpringConfiguration ApplicationContext parent super this context new StaticWebApplicationContext context setParent parent if parent null trySettingClassLoaderOnContextIfFoundInParent parent private void trySettingClassLoaderOnContextIfFoundInParent ApplicationContext parent try Object classLoader parent getBean GrailsRuntimeConfigurator CLASS LOADER BEAN if classLoader instanceof ClassLoader this context setClassLoader ClassLoader classLoader catch NoSuchBeanDefinitionException nsbde ignore we tried our best public BeanConfiguration addSingletonBean String name Class clazz BeanConfiguration bc new DefaultBeanConfiguration name clazz registerBeanConfiguration name bc return bc public BeanConfiguration addPrototypeBean String name Class clazz BeanConfiguration bc new DefaultBeanConfiguration name clazz true registerBeanConfiguration name bc return bc public WebApplicationContext getApplicationContext registerBeansWithContext context context refresh return context public WebApplicationContext getUnrefreshedApplicationContext return context public BeanConfiguration addSingletonBean String name BeanConfiguration bc new DefaultBeanConfiguration name registerBeanConfiguration name bc return bc public BeanConfiguration createSingletonBean Class clazz return new DefaultBeanConfiguration clazz public BeanConfiguration addSingletonBean String name Class clazz Collection args BeanConfiguration bc new DefaultBeanConfiguration name clazz args registerBeanConfiguration name bc return bc public BeanConfiguration addPrototypeBean String name BeanConfiguration bc new DefaultBeanConfiguration name true registerBeanConfiguration name bc return bc private void registerBeanConfiguration String name BeanConfiguration bc beanConfigs put name bc beanNames add name public BeanConfiguration createSingletonBean Class clazz Collection constructorArguments return new DefaultBeanConfiguration clazz constructorArguments public void setServletContext ServletContext context this context setServletContext context public BeanConfiguration createPrototypeBean String name return new DefaultBeanConfiguration name true public BeanConfiguration createSingletonBean String name return new DefaultBeanConfiguration name public void addBeanConfiguration String beanName BeanConfiguration beanConfiguration beanConfiguration setName beanName registerBeanConfiguration beanName beanConfiguration public void addBeanDefinition String name BeanDefinition bd beanDefinitions put name bd beanNames add name public boolean containsBean String name return beanNames contains name public BeanConfiguration getBeanConfig String name return beanConfigs get name public AbstractBeanDefinition createBeanDefinition String name if containsBean name if beanDefinitions containsKey name return AbstractBeanDefinition beanDefinitions get name else if beanConfigs containsKey name return beanConfigs get name getBeanDefinition return null public void registerPostProcessor BeanFactoryPostProcessor processor this context addBeanFactoryPostProcessor processor public List String getBeanNames return beanNames public void registerBeansWithContext StaticApplicationContext applicationContext for BeanConfiguration bc beanConfigs values if LOGGER isLoggable Level FINER LOGGER finer RuntimeConfiguration Registering bean bc getName if LOGGER isLoggable Level FINEST PropertyValue pvs bc getBeanDefinition getPropertyValues getPropertyValues for PropertyValue pv pvs LOGGER finest RuntimeConfiguration With property pv getName set to pv getValue if applicationContext containsBeanDefinition bc getName applicationContext removeBeanDefinition bc getName applicationContext registerBeanDefinition bc getName bc getBeanDefinition for String key beanDefinitions keySet BeanDefinition bd beanDefinitions get key if LOGGER isLoggable Level FINER LOGGER finer RuntimeConfiguration Registering bean key if LOGGER isLoggable Level FINEST for PropertyValue pv bd getPropertyValues getPropertyValues LOGGER finest RuntimeConfiguration With property pv getName set to pv getValue if applicationContext containsBean key applicationContext removeBeanDefinition key applicationContext registerBeanDefinition key bd public BeanConfiguration addAbstractBean String name BeanConfiguration bc new DefaultBeanConfiguration name bc setAbstract true registerBeanConfiguration name bc return bcpackage jenkins scm import hudson Extension import hudson model AbstractProject import org jenkinsci Symbol import org kohsuke stapler DataBoundConstructor public class DefaultSCMCheckoutStrategyImpl extends SCMCheckoutStrategy DataBoundConstructor public DefaultSCMCheckoutStrategyImpl Extension Symbol standard public static class DescriptorImpl extends SCMCheckoutStrategyDescriptor Override public String getDisplayName return Default Override public boolean isApplicable AbstractProject project return truepackage com twitter sdk android core internal scribe import android os Build import android text TextUtils import com google gson FieldNamingPolicy import com google gson Gson import com google gson GsonBuilder import com twitter sdk android core BuildConfig import com twitter sdk android core GuestSession import com twitter sdk android core GuestSessionProvider import com twitter sdk android core Session import com twitter sdk android core SessionManager import com twitter sdk android core TwitterAuthToken import com twitter sdk android core TwitterCore import java util Collections import java util List import java util concurrent ScheduledExecutorService import io fabric sdk android Kit import io fabric sdk android services common ExecutorUtils import io fabric sdk android services common IdManager import io fabric sdk android services settings Settings import io fabric sdk android services settings SettingsData public class DefaultScribeClient extends ScribeClient private static final String SCRIBE URL https syndication twitter com private static final String SCRIBE PATH VERSION i private static final String SCRIBE PATH TYPE sdk private static final String DEBUG BUILD debug private static volatile ScheduledExecutorService executor private final Kit kit private final SessionManager extends Session TwitterAuthToken sessionManager private final String advertisingId public DefaultScribeClient Kit kit String kitName SessionManager extends Session TwitterAuthToken sessionManager GuestSessionProvider guestSessionProvider IdManager idManager this kit kitName getGson sessionManager guestSessionProvider idManager DefaultScribeClient Kit kit String kitName Gson gson SessionManager extends Session TwitterAuthToken sessionManager GuestSessionProvider guestSessionProvider IdManager idManager super kit getExecutor getScribeConfig Settings getInstance awaitSettingsData getUserAgent kitName kit new ScribeEvent Transform gson TwitterCore getInstance getAuthConfig sessionManager guestSessionProvider TwitterCore getInstance getSSLSocketFactory idManager this sessionManager sessionManager this kit kit this advertisingId idManager getAdvertisingId public void scribe EventNamespace namespaces for EventNamespace ns namespaces scribe ns Collections ScribeItem emptyList public void scribe EventNamespace namespace List ScribeItem items final String language getLanguageFromKit final long timestamp System currentTimeMillis scribe ScribeEventFactory newScribeEvent namespace timestamp language advertisingId items public void scribe ScribeEvent event super scribe event getScribeSessionId getActiveSession public void scribe EventNamespace namespace String eventInfo final String language getLanguageFromKit final long timestamp System currentTimeMillis scribe ScribeEventFactory newScribeEvent namespace eventInfo timestamp language advertisingId Collections ScribeItem emptyList visible for tests Session getActiveSession return sessionManager getActiveSession visible for tests long getScribeSessionId Session activeSession final long scribeSessionId if activeSession null scribeSessionId activeSession getId else It s possible that we re attempting to load a tweet before we have a valid session Store the scribe event locally with the logged out user id so that we can send it up at a later time with the logged out session scribeSessionId GuestSession LOGGED OUT USER ID return scribeSessionId private String getLanguageFromKit final String language if kit getContext null language kit getContext getResources getConfiguration locale getLanguage else language return language private static Gson getGson return new GsonBuilder setFieldNamingPolicy FieldNamingPolicy LOWER CASE WITH UNDERSCORES create private static ScheduledExecutorService getExecutor if executor null synchronized DefaultScribeClient class if executor null executor ExecutorUtils buildSingleThreadScheduledExecutorService scribe return executor static ScribeConfig getScribeConfig SettingsData settingsData String userAgent Get scribe configuration using analytics settings which is used by crashlytics for configuring Answers This is temporary until we have can get our scribe settings from the backend If analytics settings are not available fallback to defaults final int maxFilesToKeep final int sendIntervalSeconds if settingsData null settingsData analyticsSettingsData null maxFilesToKeep settingsData analyticsSettingsData maxPendingSendFileCount sendIntervalSeconds settingsData analyticsSettingsData flushIntervalSeconds else maxFilesToKeep ScribeConfig DEFAULT MAX FILES TO KEEP sendIntervalSeconds ScribeConfig DEFAULT SEND INTERVAL SECONDS final String scribeUrl getScribeUrl SCRIBE URL BuildConfig SCRIBE ENDPOINT OVERRIDE return new ScribeConfig isEnabled scribeUrl SCRIBE PATH VERSION SCRIBE PATH TYPE BuildConfig SCRIBE SEQUENCE userAgent maxFilesToKeep sendIntervalSeconds private static boolean isEnabled return BuildConfig BUILD TYPE equals DEBUG BUILD static String getUserAgent String kitName Kit kit return new StringBuilder append Fabric append kit getFabric getVersion append Android append Build VERSION SDK INT append append kitName append append kit getVersion toString visible for tests static String getScribeUrl String defaultUrl String overrideUrl if TextUtils isEmpty overrideUrl return overrideUrl else return defaultUrlpackage com twitter sdk android core internal scribe import android os Build import io fabric sdk android Fabric import io fabric sdk android FabricAndroidTestCase import io fabric sdk android FabricTestUtils import io fabric sdk android Kit import io fabric sdk android services common IdManager import io fabric sdk android services settings AnalyticsSettingsData import io fabric sdk android services settings Settings import io fabric sdk android services settings SettingsData import io fabric sdk android services settings TestSettingsController import com twitter sdk android core BuildConfig import com twitter sdk android core GuestSessionProvider import com twitter sdk android core Session import com twitter sdk android core SessionManager import com twitter sdk android core TwitterAuthConfig import com twitter sdk android core TwitterCore import com twitter sdk android core TwitterSession import java util Locale import static org mockito Mockito mock import static org mockito Mockito when public class DefaultScribeClientTest extends FabricAndroidTestCase private static final int TEST SEND INTERVAL SECONDS 6000000 60 6 million minutes private static final int TEST MAX FILES TO KEEP 100000 private static final String TEST USER AGENT user agent private static final String TEST DEFAULT SCRIBE URL https syndication twitter com private static final String TEST OVERRIDE SCRIBE URL http api twitter com private static final String TEST SCRIBE USER AGENT FORMAT Fabric s Android s ExampleKit s private static final String TEST SCRIBE KIT NAME ExampleKit private static final String TEST KIT VERSION 1000 private static final String ANY KIT IDENTIFIER private static final String REQUIRED SCRIBE URL COMPONENT https syndication twitter com private static final long REQUIRED LOGGED OUT USER ID 0L private static final long TEST ACTIVE SESSION ID 1L private static final String DEBUG BUILD TYPE debug private ExampleKit testKit private DefaultScribeClient scribeClient private SessionManager TwitterSession mockTwitterSessionManager private GuestSessionProvider mockGuestSessionProvider Override public void setUp throws Exception super setUp FabricTestUtils resetFabric Settings getInstance setSettingsController new TestSettingsController Fabric with getContext new TwitterCore new TwitterAuthConfig new ExampleKit testKit Fabric getKit ExampleKit class mockTwitterSessionManager mock SessionManager class mockGuestSessionProvider mock GuestSessionProvider class scribeClient new DefaultScribeClient testKit TEST SCRIBE KIT NAME mockTwitterSessionManager mockGuestSessionProvider mock IdManager class Override protected void tearDown throws Exception super tearDown FabricTestUtils resetFabric private class ExampleKit extends Kit Override public String getIdentifier return ANY KIT IDENTIFIER Override public String getVersion return TEST KIT VERSION Override protected Object doInBackground return null public void testGetScribeConfig settingsDataNull final ScribeConfig scribeConfig DefaultScribeClient getScribeConfig null TEST USER AGENT assertScribeConfig TEST USER AGENT ScribeConfig DEFAULT MAX FILES TO KEEP ScribeConfig DEFAULT SEND INTERVAL SECONDS scribeConfig public void testGetScribeConfig settingsDataAnalyticsSettingsDataNull final SettingsData settingsData new SettingsData 0L null null null null null null 0 0 final ScribeConfig scribeConfig DefaultScribeClient getScribeConfig settingsData TEST USER AGENT assertScribeConfig TEST USER AGENT ScribeConfig DEFAULT MAX FILES TO KEEP ScribeConfig DEFAULT SEND INTERVAL SECONDS scribeConfig public void testGetScribeConfig settingsDataValid final AnalyticsSettingsData analyticsSettingsData new AnalyticsSettingsData null TEST SEND INTERVAL SECONDS 0 0 TEST MAX FILES TO KEEP true final SettingsData settingsData new SettingsData 0L null null null null analyticsSettingsData null 0 0 final ScribeConfig scribeConfig DefaultScribeClient getScribeConfig settingsData TEST USER AGENT assertScribeConfig TEST USER AGENT TEST MAX FILES TO KEEP TEST SEND INTERVAL SECONDS scribeConfig public void testGetScribeUrl nullOverride final String scribeUrl DefaultScribeClient getScribeUrl TEST DEFAULT SCRIBE URL null assertEquals TEST DEFAULT SCRIBE URL scribeUrl public void testGetScribeUrl emptyOverride final String scribeUrl DefaultScribeClient getScribeUrl TEST DEFAULT SCRIBE URL assertEquals TEST DEFAULT SCRIBE URL scribeUrl public void testGetScribeUrl override final String scribeUrl DefaultScribeClient getScribeUrl TEST DEFAULT SCRIBE URL TEST OVERRIDE SCRIBE URL assertEquals TEST OVERRIDE SCRIBE URL scribeUrl private void assertScribeConfig String expectedUserAgent int expectedMaxFilesToKeep int expectedSendIntervalSeconds ScribeConfig scribeConfig assertEquals BuildConfig BUILD TYPE equals DEBUG BUILD TYPE scribeConfig isEnabled assertEquals REQUIRED SCRIBE URL COMPONENT scribeConfig baseUrl assertEquals BuildConfig SCRIBE SEQUENCE scribeConfig sequence assertEquals expectedUserAgent scribeConfig userAgent assertEquals expectedMaxFilesToKeep scribeConfig maxFilesToKeep assertEquals expectedSendIntervalSeconds scribeConfig sendIntervalSeconds public void testGetScribeUserAgent Fabric with getContext new ExampleKit final Kit kit Fabric getKit ExampleKit class final String userAgent String format Locale ENGLISH TEST SCRIBE USER AGENT FORMAT kit getFabric getVersion Build VERSION SDK INT kit getVersion assertEquals userAgent DefaultScribeClient getUserAgent TEST SCRIBE KIT NAME kit public void testGetActiveSession activeSessionDoesNotExist assertNull scribeClient getActiveSession public void testGetActiveSession activeSessionFirstManager final TwitterSession mockSession mock TwitterSession class when mockTwitterSessionManager getActiveSession thenReturn mockSession assertSame mockSession scribeClient getActiveSession public void testGetScribeSessionId nullSession assertEquals REQUIRED LOGGED OUT USER ID scribeClient getScribeSessionId null public void testGetScribeSessionId activeSession final DefaultScribeClient scribeClient new DefaultScribeClient testKit TEST SCRIBE KIT NAME mockTwitterSessionManager mockGuestSessionProvider mock IdManager class final Session mockSession mock Session class when mockSession getId thenReturn TEST ACTIVE SESSION ID assertEquals TEST ACTIVE SESSION ID scribeClient getScribeSessionId mockSessionpackage jenkins mvn import hudson Extension import hudson FilePath import hudson model AbstractBuild import hudson model TaskListener import org jenkinsci Symbol import org kohsuke stapler DataBoundConstructor public class DefaultSettingsProvider extends SettingsProvider DataBoundConstructor public DefaultSettingsProvider Override public FilePath supplySettings AbstractBuild project TaskListener listener return null Extension ordinal 99 Symbol standard public static class DescriptorImpl extends SettingsProviderDescriptor Override public String getDisplayName return Messages DefaultSettingsProvider DisplayNamepackage jenkins model import hudson Extension import hudson Functions import hudson model Descriptor import hudson model User import java util Map Extension public class DefaultUserCanonicalIdResolver extends User CanonicalIdResolver Override public String resolveCanonicalId String idOrFullName Map String context String id idOrFullName replace replace replace replace 4 replace still faster than regex if Functions isWindows id id replace return id Override public int getPriority return Integer MIN VALUE Override public Descriptor User CanonicalIdResolver getDescriptor return DESCRIPTOR public static final Descriptor User CanonicalIdResolver DESCRIPTOR new Descriptor User CanonicalIdResolver public String getDisplayName return compute default user IDpackage hudson views import hudson Extension import org jenkinsci Symbol import org kohsuke stapler DataBoundConstructor public class DefaultViewsTabBar extends ViewsTabBar DataBoundConstructor public DefaultViewsTabBar Extension Symbol standard public static class DescriptorImpl extends ViewsTabBarDescriptor Override public String getDisplayName return Messages DefaultViewsTabsBar DisplayName return Default Views TabsBarpackage hudson security import org acegisecurity GrantedAuthority import org acegisecurity ldap InitialDirContextFactory import org acegisecurity ldap LdapDataAccessException import org acegisecurity providers ldap LdapAuthoritiesPopulator import org acegisecurity providers ldap populator DefaultLdapAuthoritiesPopulator import org acegisecurity userdetails ldap LdapUserDetails import hudson security SecurityRealm SecurityComponents Deprecated public class DeferredCreationLdapAuthoritiesPopulator implements LdapAuthoritiesPopulator private String defaultRole null private InitialDirContextFactory initialDirContextFactory null private boolean searchSubtree false private String groupRoleAttribute cn private String groupSearchBase null private String groupSearchFilter member 0 uniqueMember 0 memberUid 0 private String rolePrefix ROLE private boolean convertToUpperCase true public DeferredCreationLdapAuthoritiesPopulator InitialDirContextFactory initialDirContextFactory String groupSearchBase this setInitialDirContextFactory initialDirContextFactory this setGroupSearchBase groupSearchBase public GrantedAuthority getGrantedAuthorities LdapUserDetails userDetails throws LdapDataAccessException return create getGrantedAuthorities userDetails public void setConvertToUpperCase boolean convertToUpperCase this convertToUpperCase convertToUpperCase public void setDefaultRole String defaultRole this defaultRole defaultRole public void setGroupRoleAttribute String groupRoleAttribute this groupRoleAttribute groupRoleAttribute public void setGroupSearchBase String groupSearchBase this groupSearchBase groupSearchBase public void setGroupSearchFilter String groupSearchFilter this groupSearchFilter groupSearchFilter public void setInitialDirContextFactory InitialDirContextFactory initialDirContextFactory this initialDirContextFactory initialDirContextFactory public void setRolePrefix String rolePrefix this rolePrefix rolePrefix public void setSearchSubtree boolean searchSubtree this searchSubtree searchSubtree private DefaultLdapAuthoritiesPopulator create DefaultLdapAuthoritiesPopulator populator new DefaultLdapAuthoritiesPopulator initialDirContextFactory groupSearchBase populator setConvertToUpperCase convertToUpperCase if defaultRole null populator setDefaultRole defaultRole populator setGroupRoleAttribute groupRoleAttribute populator setGroupSearchFilter groupSearchFilter populator setRolePrefix rolePrefix populator setSearchSubtree searchSubtree return populatorpackage hudson slaves import hudson RestrictedSince import hudson model Descriptor import hudson model Slave import hudson model TaskListener import java io IOException import java util ArrayList import java util List import javax annotation CheckForNull import javax annotation Nonnull import jenkins model Jenkins import org kohsuke accmod Restricted import org kohsuke accmod restrictions DoNotUse public abstract class DelegatingComputerLauncher extends ComputerLauncher protected ComputerLauncher launcher protected DelegatingComputerLauncher ComputerLauncher launcher this launcher launcher public ComputerLauncher getLauncher return launcher Override public void launch SlaveComputer computer TaskListener listener throws IOException InterruptedException getLauncher launch computer listener Override public void afterDisconnect SlaveComputer computer TaskListener listener getLauncher afterDisconnect computer listener Override public void beforeDisconnect SlaveComputer computer TaskListener listener getLauncher beforeDisconnect computer listener public static abstract class DescriptorImpl extends Descriptor ComputerLauncher public List Descriptor ComputerLauncher applicableDescriptors CheckForNull Slave it Nonnull Slave SlaveDescriptor itDescriptor List Descriptor ComputerLauncher r new ArrayList Descriptor ComputerLauncher for Descriptor ComputerLauncher d itDescriptor computerLauncherDescriptors it if DelegatingComputerLauncher class isAssignableFrom d getKlass toJavaClass continue r add d return r Deprecated Restricted DoNotUse class RestrictedSince 2 12 public List Descriptor ComputerLauncher getApplicableDescriptors List Descriptor ComputerLauncher r new ArrayList Descriptor ComputerLauncher for Descriptor ComputerLauncher d Jenkins getInstance ComputerLauncher Descriptor ComputerLauncher getDescriptorList ComputerLauncher class if DelegatingComputerLauncher class isAssignableFrom d getKlass toJavaClass continue r add d return rpackage hudson util import java io FilterOutputStream import java io OutputStream import java io IOException public abstract class DelegatingOutputStream extends OutputStream protected OutputStream out protected DelegatingOutputStream OutputStream out if out null throw new IllegalArgumentException null stream this out out public void write int b throws IOException out write b Override public void write byte b throws IOException out write b Override public void write byte b int off int len throws IOException out write b off len Override public void flush throws IOException out flush Override public void close throws IOException out closepackage hudson cli import hudson Extension import hudson model AbstractBuild import hudson model Run import java io IOException import java io PrintStream import java util HashSet import java util List Extension public class DeleteBuildsCommand extends AbstractBuildRangeCommand Override public String getShortDescription return Messages DeleteBuildsCommand ShortDescription Override protected void printUsageSummary PrintStream stderr stderr println Delete build records of a specified job possibly in a bulk Override protected int act List AbstractBuild builds throws IOException job checkPermission Run DELETE final HashSet Integer hsBuilds new HashSet Integer for AbstractBuild build builds if hsBuilds contains build number build delete hsBuilds add build number stdout println Deleted hsBuilds size builds return 0package hudson cli import hudson AbortException import hudson Extension import hudson model AbstractItem import jenkins model Jenkins import org kohsuke args4j Argument import java util List import java util HashSet import java util logging Logger Extension public class DeleteJobCommand extends CLICommand Argument usage Name of the job s to delete required true multiValued true private List String jobs Override public String getShortDescription return Messages DeleteJobCommand ShortDescription Override protected int run throws Exception boolean errorOccurred false final Jenkins jenkins Jenkins getActiveInstance final HashSet String hs new HashSet String hs addAll jobs for String job s hs AbstractItem job null try job AbstractItem jenkins getItemByFullName job s if job null throw new IllegalArgumentException No such job job s job checkPermission AbstractItem DELETE job delete catch Exception e if hs size 1 throw e final String errorMsg String format job s e getMessage stderr println errorMsg errorOccurred true continue if errorOccurred throw new AbortException CLI LISTPARAM SUMMARY ERROR TEXT return 0package hudson cli import hudson AbortException import hudson Extension import hudson model Node import jenkins model Jenkins import org kohsuke args4j Argument import java util HashSet import java util List import java util logging Logger Extension public class DeleteNodeCommand extends CLICommand Argument usage Names of nodes to delete required true multiValued true private List String nodes Override public String getShortDescription return Messages DeleteNodeCommand ShortDescription Override protected int run throws Exception boolean errorOccurred false final Jenkins jenkins Jenkins getActiveInstance final HashSet String hs new HashSet String hs addAll nodes for String node s hs Node node null try node jenkins getNode node s if node null throw new IllegalArgumentException No such node node s node toComputer doDoDelete catch Exception e if hs size 1 throw e final String errorMsg String format node s e getMessage stderr println errorMsg errorOccurred true continue if errorOccurred throw new AbortException CLI LISTPARAM SUMMARY ERROR TEXT return 0package hudson cli import hudson AbortException import hudson Extension import hudson cli handlers ViewOptionHandler import hudson model ViewGroup import hudson model View import org kohsuke args4j Argument import java util HashSet import java util List import java util logging Logger Extension public class DeleteViewCommand extends CLICommand Argument usage View names to delete required true multiValued true private List String views Override public String getShortDescription return Messages DeleteViewCommand ShortDescription Override protected int run throws Exception boolean errorOccurred false Remove duplicates final HashSet String hs new HashSet String hs addAll views ViewOptionHandler voh new ViewOptionHandler null null null for String view s hs View view null try view voh getView view s if view null throw new IllegalArgumentException View name is empty view checkPermission View DELETE ViewGroup group view getOwner if group canDelete view throw new IllegalStateException String format s does not allow to delete s view group getDisplayName view getViewName group deleteView view catch Exception e if hs size 1 throw e final String errorMsg String format view s e getMessage stderr println errorMsg errorOccurred true continue if errorOccurred throw new AbortException CLI LISTPARAM SUMMARY ERROR TEXT return 0package hudson model import jenkins model DependencyDeclarer Deprecated public interface DependecyDeclarer extends DependencyDeclarerpackage jenkins model import hudson model AbstractProject import hudson model DependencyGraph import hudson tasks BuildWrapper import hudson tasks Builder import hudson tasks Publisher import hudson triggers Trigger public interface DependencyDeclarer I thought about whether this should extend BuildStep or not and decided not to so that this concept can be extended elsewhere like maven projects and so on void buildDependencyGraph AbstractProject owner DependencyGraph graphpackage hudson model import jenkins model DependencyDeclarer import com google common collect ImmutableList import hudson security ACL import jenkins model Jenkins import jenkins util DirectedGraph import jenkins util DirectedGraph SCC import org acegisecurity context SecurityContext import org acegisecurity context SecurityContextHolder import java util ArrayList import java util Collection import java util Collections import java util Comparator import java util HashMap import java util HashSet import java util LinkedHashSet import java util List import java util ListIterator import java util Map import java util Map Entry import java util Set import java util Stack public class DependencyGraph implements Comparator AbstractProject private Map AbstractProject List DependencyGroup forward new HashMap AbstractProject List DependencyGroup private Map AbstractProject List DependencyGroup backward new HashMap AbstractProject List DependencyGroup private transient Map Class Object computationalData private boolean built private Comparator AbstractProject topologicalOrder private List AbstractProject topologicallySorted public DependencyGraph public void build Set full privileges while computing to avoid missing any projects the current user cannot see SecurityContext saveCtx ACL impersonate ACL SYSTEM try this computationalData new HashMap Class Object for AbstractProject p getAllProjects p buildDependencyGraph this forward finalize forward backward finalize backward topologicalDagSort this computationalData null built true finally SecurityContextHolder setContext saveCtx private void topologicalDagSort DirectedGraph AbstractProject g new DirectedGraph AbstractProject Override protected Collection AbstractProject nodes final Set AbstractProject nodes new HashSet AbstractProject nodes addAll forward keySet nodes addAll backward keySet return nodes Override protected Collection AbstractProject forward AbstractProject node return getDownstream node List SCC AbstractProject sccs g getStronglyConnectedComponents final Map AbstractProject Integer topoOrder new HashMap AbstractProject Integer topologicallySorted new ArrayList AbstractProject int idx 0 for SCC AbstractProject scc sccs for AbstractProject n scc topoOrder put n idx topologicallySorted add n topologicalOrder new Comparator AbstractProject Override public int compare AbstractProject o1 AbstractProject o2 return topoOrder get o1 topoOrder get o2 topologicallySorted Collections unmodifiableList topologicallySorted Collection AbstractProject getAllProjects return Jenkins getInstance getAllItems AbstractProject class private DependencyGraph boolean dummy forward backward Collections emptyMap topologicalDagSort built true public T void putComputationalData Class T key T value this computationalData put key value public T T getComputationalData Class T key SuppressWarnings unchecked T result T this computationalData get key return result public List AbstractProject getDownstream AbstractProject p return get forward p false public List AbstractProject getUpstream AbstractProject p return get backward p true private List AbstractProject get Map AbstractProject List DependencyGroup map AbstractProject src boolean up List DependencyGroup v map get src if v null return Collections emptyList List AbstractProject result new ArrayList AbstractProject v size for DependencyGroup d v result add up d getUpstreamProject d getDownstreamProject return result public List Dependency getDownstreamDependencies AbstractProject p return get forward p public List Dependency getUpstreamDependencies AbstractProject p return get backward p private List Dependency get Map AbstractProject List DependencyGroup map AbstractProject src List DependencyGroup v map get src if v null return ImmutableList of else ImmutableList Builder Dependency builder ImmutableList builder for DependencyGroup dependencyGroup v builder addAll dependencyGroup getGroup return builder build Deprecated public void addDependency AbstractProject upstream AbstractProject downstream addDependency new Dependency upstream downstream public void addDependency Dependency dep if built throw new IllegalStateException add forward dep getUpstreamProject dep add backward dep getDownstreamProject dep Deprecated public void addDependency AbstractProject upstream Collection extends AbstractProject downstream for AbstractProject p downstream addDependency upstream p Deprecated public void addDependency Collection extends AbstractProject upstream AbstractProject downstream for AbstractProject p upstream addDependency p downstream public void addDependencyDeclarers AbstractProject upstream Collection possibleDependecyDeclarers for Object o possibleDependecyDeclarers if o instanceof DependencyDeclarer DependencyDeclarer dd DependencyDeclarer o dd buildDependencyGraph upstream this public boolean hasIndirectDependencies AbstractProject src AbstractProject dst Set AbstractProject visited new HashSet AbstractProject Stack AbstractProject queue new Stack AbstractProject queue addAll getDownstream src queue remove dst while queue isEmpty AbstractProject p queue pop if p dst return true if visited add p queue addAll getDownstream p return false public Set AbstractProject getTransitiveUpstream AbstractProject src return getTransitive backward src true public Set AbstractProject getTransitiveDownstream AbstractProject src return getTransitive forward src false private Set AbstractProject getTransitive Map AbstractProject List DependencyGroup direction AbstractProject src boolean up Set AbstractProject visited new HashSet AbstractProject Stack AbstractProject queue new Stack AbstractProject queue add src while queue isEmpty AbstractProject p queue pop for AbstractProject child get direction p up if visited add child queue add child return visited private void add Map AbstractProject List DependencyGroup map AbstractProject key Dependency dep List DependencyGroup set map get key if set null set new ArrayList DependencyGroup map put key set for ListIterator DependencyGroup it set listIterator it hasNext DependencyGroup d it next Check for existing edge that connects the same two projects if d getUpstreamProject dep getUpstreamProject d getDownstreamProject dep getDownstreamProject d add dep return Otherwise add to list set add new DependencyGroup dep private Map AbstractProject List DependencyGroup finalize Map AbstractProject List DependencyGroup m for Entry AbstractProject List DependencyGroup e m entrySet Collections sort e getValue NAME COMPARATOR e setValue Collections unmodifiableList e getValue return Collections unmodifiableMap m private static final Comparator DependencyGroup NAME COMPARATOR new Comparator DependencyGroup public int compare DependencyGroup lhs DependencyGroup rhs int cmp lhs getUpstreamProject getName compareTo rhs getUpstreamProject getName return cmp 0 cmp lhs getDownstreamProject getName compareTo rhs getDownstreamProject getName public static final DependencyGraph EMPTY new DependencyGraph false public int compare AbstractProject o1 AbstractProject o2 return topologicalOrder compare o1 o2 public List AbstractProject getTopologicallySorted return topologicallySorted public static class Dependency private AbstractProject upstream downstream public Dependency AbstractProject upstream AbstractProject downstream this upstream upstream this downstream downstream public AbstractProject getUpstreamProject return upstream public AbstractProject getDownstreamProject return downstream public boolean shouldTriggerBuild AbstractBuild build TaskListener listener List Action actions return true public boolean pointsItself return upstream downstream Override public boolean equals Object obj if obj null return false if getClass obj getClass return false final Dependency that Dependency obj return this upstream that upstream this downstream that downstream Override public int hashCode int hash 7 hash 23 hash this upstream hashCode hash 23 hash this downstream hashCode return hash Override public String toString return super toString upstream downstream private static class DependencyGroup private Set Dependency group new LinkedHashSet Dependency DependencyGroup Dependency first this upstream first getUpstreamProject this downstream first getDownstreamProject group add first private void add Dependency next group add next public Set Dependency getGroup return group private AbstractProject upstream downstream public AbstractProject getUpstreamProject return upstream public AbstractProject getDownstreamProject return downstreampackage hudson import hudson model AbstractProject import jenkins model Jenkins import hudson security ACL import java util ArrayList import java util HashSet import java util List import java util Set import java util Collection import java util logging Logger import org acegisecurity context SecurityContext import org acegisecurity context SecurityContextHolder public class DependencyRunner implements Runnable private static final Logger LOGGER Logger getLogger DependencyRunner class getName ProjectRunnable runnable List AbstractProject polledProjects new ArrayList AbstractProject public DependencyRunner ProjectRunnable runnable this runnable runnable public void run SecurityContext oldContext ACL impersonate ACL SYSTEM try Set AbstractProject topLevelProjects new HashSet AbstractProject Get all top level projects LOGGER fine assembling top level projects for AbstractProject p Jenkins getInstance getAllItems AbstractProject class if p getUpstreamProjects size 0 LOGGER fine adding top level project p getName topLevelProjects add p else LOGGER fine skipping project since not a top level project p getName populate topLevelProjects for AbstractProject p polledProjects LOGGER fine running project in correct dependency order p getName runnable run p finally SecurityContextHolder setContext oldContext private void populate Collection extends AbstractProject projectList for AbstractProject p projectList if polledProjects contains p Project will be readded at the queue so that we always use the longest path LOGGER fine removing project p getName for re add polledProjects remove p LOGGER fine adding project p getName polledProjects add p Add all downstream dependencies populate p getDownstreamProjects public interface ProjectRunnable void run AbstractProject ppackage hudson model public interface Describable T extends Describable T Descriptor T getDescriptorpackage hudson util import com thoughtworks xstream converters Converter import com thoughtworks xstream converters MarshallingContext import com thoughtworks xstream converters UnmarshallingContext import com thoughtworks xstream converters collections AbstractCollectionConverter import com thoughtworks xstream io HierarchicalStreamReader import com thoughtworks xstream io HierarchicalStreamWriter import com thoughtworks xstream mapper Mapper import hudson model AbstractProject import jenkins model DependencyDeclarer import hudson model DependencyGraph import hudson model Describable import hudson model Descriptor import hudson model Descriptor FormException import hudson model ReconfigurableDescribable import hudson model Saveable import net sf json JSONObject import org kohsuke stapler StaplerRequest import java io IOException import java util ArrayList import java util Collection import java util List import java util Map import java util logging Level import java util logging Logger public class DescribableList T extends Describable T D extends Descriptor T extends PersistedList T protected DescribableList Deprecated public DescribableList Owner owner setOwner owner public DescribableList Saveable owner setOwner owner public DescribableList Saveable owner Collection extends T initialList super initialList setOwner owner Deprecated public void setOwner Owner owner this owner owner public void replace T item throws IOException removeAll Class item getClass data add item onModified public T getDynamic String id by ID for T t data if t getDescriptor getId equals id return t by position try return data get Integer parseInt id catch NumberFormatException e fall through return null public T get D descriptor for T t data if t getDescriptor descriptor return t return null public boolean contains D d return get d null public void remove D descriptor throws IOException for T t data if t getDescriptor descriptor data remove t onModified return SuppressWarnings unchecked public Map D T toMap return Map Descriptor toMap data public void rebuild StaplerRequest req JSONObject json List extends Descriptor T descriptors throws FormException IOException List T newList new ArrayList T for Descriptor T d descriptors T existing get D d String name d getJsonSafeClassName JSONObject o json optJSONObject name T instance null if o null if existing instanceof ReconfigurableDescribable instance T ReconfigurableDescribable existing reconfigure req o else instance d newInstance req o else if existing instanceof ReconfigurableDescribable instance T ReconfigurableDescribable existing reconfigure req null if instance null newList add instance replaceBy newList Deprecated public void rebuild StaplerRequest req JSONObject json List extends Descriptor T descriptors String prefix throws FormException IOException rebuild req json descriptors public void rebuildHetero StaplerRequest req JSONObject formData Collection extends Descriptor T descriptors String key throws FormException IOException replaceBy Descriptor newInstancesFromHeteroList req formData key descriptors public void buildDependencyGraph AbstractProject owner DependencyGraph graph for Object o this if o instanceof DependencyDeclarer DependencyDeclarer dd DependencyDeclarer o try dd buildDependencyGraph owner graph catch RuntimeException e LOGGER log Level SEVERE Failed to build dependency graph for owner e public U extends T U get Class U type return super get type public T toArray T array return super toArray array Deprecated public interface Owner extends Saveable public static class ConverterImpl extends AbstractCollectionConverter CopyOnWriteList ConverterImpl copyOnWriteListConverter public ConverterImpl Mapper mapper super mapper copyOnWriteListConverter new CopyOnWriteList ConverterImpl mapper public boolean canConvert Class type handle subtypes in case the onModified method is overridden return DescribableList class isAssignableFrom type public void marshal Object source HierarchicalStreamWriter writer MarshallingContext context for Object o DescribableList source writeItem o context writer public Object unmarshal HierarchicalStreamReader reader UnmarshallingContext context CopyOnWriteList core copyOnWriteListConverter unmarshal reader context try DescribableList r DescribableList context getRequiredType newInstance r data replaceBy core return r catch InstantiationException e InstantiationError x new InstantiationError x initCause e throw x catch IllegalAccessException e IllegalAccessError x new IllegalAccessError x initCause e throw x private final static Logger LOGGER Logger getLogger DescribableList class getNamepackage hudson model import hudson DescriptorExtensionList import hudson PluginWrapper import hudson RelativePath import hudson XmlFile import hudson BulkChange import hudson ExtensionList import hudson Util import hudson model listeners SaveableListener import hudson util FormApply import hudson util FormValidation CheckMethod import hudson util ReflectionUtils import hudson util ReflectionUtils Parameter import hudson views ListViewColumn import jenkins model GlobalConfiguration import jenkins model GlobalConfigurationCategory import jenkins model Jenkins import jenkins util io OnMaster import net sf json JSONArray import net sf json JSONObject import org kohsuke stapler import org kohsuke stapler jelly JellyCompatibleFacet import org kohsuke stapler lang Klass import org springframework util StringUtils import org jvnet tiger types Types import org apache commons io IOUtils import static hudson util QuotedStringTokenizer import static javax servlet http HttpServletResponse SC NOT FOUND import javax servlet ServletException import javax servlet RequestDispatcher import java io File import java io IOException import java io InputStream import java net URL import java util ArrayList import java util Collection import java util LinkedHashMap import java util List import java util Map import java util HashMap import java util Locale import java util Arrays import java util Collections import java util concurrent ConcurrentHashMap import java util logging Level import java util logging Logger import java lang reflect Method import java lang reflect Modifier import java lang reflect Type import java lang reflect Field import java lang reflect ParameterizedType import java beans Introspector import java util IdentityHashMap import javax annotation CheckForNull import javax annotation Nonnull public abstract class Descriptor T extends Describable T implements Saveable OnMaster public transient final Class extends T clazz private transient final Map String CheckMethod checkMethods new ConcurrentHashMap String CheckMethod private transient volatile Map String PropertyType propertyTypes globalPropertyTypes public static final class PropertyType public final Class clazz public final Type type private volatile Class itemType public final String displayName PropertyType Class clazz Type type String displayName this clazz clazz this type type this displayName displayName PropertyType Field f this f getType f getGenericType f toString PropertyType Method getter this getter getReturnType getter getGenericReturnType getter toString public Enum getEnumConstants return Enum clazz getEnumConstants public Class getItemType if itemType null itemType computeItemType return itemType private Class computeItemType if clazz isArray return clazz getComponentType if Collection class isAssignableFrom clazz Type col Types getBaseClass type Collection class if col instanceof ParameterizedType return Types erasure Types getTypeArgument col 0 else return Object class return null public Descriptor getItemTypeDescriptor return Jenkins getInstance getDescriptor getItemType public Descriptor getItemTypeDescriptorOrDie Class it getItemType if it null throw new AssertionError clazz is not an array collection type in displayName See https wiki jenkins ci org display JENKINS My class is missing descriptor Descriptor d Jenkins getInstance getDescriptor it if d null throw new AssertionError it is missing its descriptor in displayName See https wiki jenkins ci org display JENKINS My class is missing descriptor return d public List extends Descriptor getApplicableDescriptors return Jenkins getInstance getDescriptorList clazz public List extends Descriptor getApplicableItemDescriptors return Jenkins getInstance getDescriptorList getItemType private transient final Map String HelpRedirect helpRedirect new HashMap String HelpRedirect private static class HelpRedirect private final Class extends Describable owner private final String fieldNameToRedirectTo private HelpRedirect Class extends Describable owner String fieldNameToRedirectTo this owner owner this fieldNameToRedirectTo fieldNameToRedirectTo private String resolve the resolution has to be deferred to avoid ordering issue among descriptor registrations return Jenkins getInstance getDescriptor owner getHelpFile fieldNameToRedirectTo protected Descriptor Class extends T clazz if clazz self clazz Class getClass this clazz clazz doing this turns out to be very error prone as field initializers in derived types will override values load protected Descriptor this clazz Class T getClass getEnclosingClass if clazz null throw new AssertionError getClass doesn t have an outer class Use the constructor that takes the Class object explicitly detect an type error Type bt Types getBaseClass getClass Descriptor class if bt instanceof ParameterizedType ParameterizedType pt ParameterizedType bt this t is the closest approximation of T of Descriptor T Class t Types erasure pt getActualTypeArguments 0 if t isAssignableFrom clazz throw new AssertionError Outer class clazz of getClass is not assignable to t Perhaps wrong outer class detect a type error this Descriptor is supposed to be returned from getDescriptor so make sure its type match up this prevents a bug like http www nabble com Creating a new parameter Type 3A Masked Parameter td24786554 html try Method getd clazz getMethod getDescriptor if getd getReturnType isAssignableFrom getClass throw new AssertionError getClass must be assignable to getd getReturnType catch NoSuchMethodException e throw new AssertionError getClass is missing getDescriptor method Nonnull public String getDisplayName return clazz getSimpleName public String getId return clazz getName public Class T getT Type subTyping Types getBaseClass getClass Descriptor class if subTyping instanceof ParameterizedType throw new IllegalStateException getClass doesn t extend Descriptor with a type parameter return Types erasure Types getTypeArgument subTyping 0 public String getDescriptorUrl return descriptorByName getId public final String getDescriptorFullUrl return getCurrentDescriptorByNameUrl getDescriptorUrl public static String getCurrentDescriptorByNameUrl StaplerRequest req Stapler getCurrentRequest this override allows RenderOnDemandClosure to preserve the proper value Object url req getAttribute currentDescriptorByNameUrl if url null return url toString Ancestor a req findAncestor DescriptorByNameOwner class return a getUrl Deprecated public String getCheckUrl String fieldName return getCheckMethod fieldName toCheckUrl public CheckMethod getCheckMethod String fieldName CheckMethod method checkMethods get fieldName if method null method new CheckMethod this fieldName checkMethods put fieldName method return method public void calcFillSettings String field Map String Object attributes String capitalizedFieldName StringUtils capitalize field String methodName doFill capitalizedFieldName Items Method method ReflectionUtils getPublicMethodNamed getClass methodName if method null throw new IllegalStateException String format s doesn t have the s method for filling a drop down list getClass methodName build query parameter line by figuring out what should be submitted List String depends buildFillDependencies method new ArrayList String if depends isEmpty attributes put fillDependsOn Util join depends attributes put fillUrl String format s s fill sItems getCurrentDescriptorByNameUrl getDescriptorUrl capitalizedFieldName private List String buildFillDependencies Method method List String depends for Parameter p ReflectionUtils getParameters method QueryParameter qp p annotation QueryParameter class if qp null String name qp value if name length 0 name p name if name null name length 0 continue unknown parameter name we ll report the error when the form is submitted RelativePath rp p annotation RelativePath class if rp null name rp value name depends add name continue Method m ReflectionUtils getPublicMethodNamed p type fromStapler if m null buildFillDependencies m depends return depends public void calcAutoCompleteSettings String field Map String Object attributes String capitalizedFieldName StringUtils capitalize field String methodName doAutoComplete capitalizedFieldName Method method ReflectionUtils getPublicMethodNamed getClass methodName if method null return no auto completion attributes put autoCompleteUrl String format s s autoComplete s getCurrentDescriptorByNameUrl getDescriptorUrl capitalizedFieldName public CheckForNull PropertyType getPropertyType Nonnull Object instance Nonnull String field in global jelly instance descriptor return instance this getGlobalPropertyType field getPropertyType field public Nonnull PropertyType getPropertyTypeOrDie Nonnull Object instance Nonnull String field PropertyType propertyType getPropertyType instance field if propertyType null return propertyType else if instance this throw new AssertionError getClass getName has no property field else throw new AssertionError clazz getName has no property field public PropertyType getPropertyType String field if propertyTypes null propertyTypes buildPropertyTypes clazz return propertyTypes get field public PropertyType getGlobalPropertyType String field if globalPropertyTypes null globalPropertyTypes buildPropertyTypes getClass return globalPropertyTypes get field private Map String PropertyType buildPropertyTypes Class clazz Map String PropertyType r new HashMap String PropertyType for Field f clazz getFields r put f getName new PropertyType f for Method m clazz getMethods if m getName startsWith get r put Introspector decapitalize m getName substring 3 new PropertyType m return r public final String getJsonSafeClassName return getId replace Deprecated public T newInstance StaplerRequest req throws FormException throw new UnsupportedOperationException getClass should implement newInstance StaplerRequest JSONObject public T newInstance CheckForNull StaplerRequest req Nonnull JSONObject formData throws FormException try Method m getClass getMethod newInstance StaplerRequest class if Modifier isAbstract m getDeclaringClass getModifiers this class overrides newInstance StaplerRequest maintain the backward compatible behavior return verifyNewInstance newInstance req else if req null yes req is supposed to be always non null but see the note above return verifyNewInstance clazz newInstance new behavior as of 1 206 BindInterceptor oldInterceptor req getBindInterceptor try NewInstanceBindInterceptor interceptor if oldInterceptor instanceof NewInstanceBindInterceptor interceptor NewInstanceBindInterceptor oldInterceptor else interceptor new NewInstanceBindInterceptor oldInterceptor req setBindInterceptor interceptor interceptor processed put formData true return verifyNewInstance req bindJSON clazz formData finally req setBindInterceptor oldInterceptor catch NoSuchMethodException e throw new AssertionError e impossible catch InstantiationException IllegalAccessException RuntimeException e throw new Error Failed to instantiate clazz from formData e SuppressWarnings unchecked rawtypes private static class NewInstanceBindInterceptor extends BindInterceptor private final BindInterceptor oldInterceptor private final Map JSONObject Boolean processed new IdentityHashMap NewInstanceBindInterceptor BindInterceptor oldInterceptor LOGGER log Level FINER new interceptor delegating to 0 oldInterceptor this oldInterceptor oldInterceptor private boolean isApplicable Class type JSONObject json if Modifier isAbstract type getModifiers LOGGER log Level FINER ignoring abstract 0 1 new Object type getName json return false if Describable class isAssignableFrom type LOGGER log Level FINER ignoring non Describable 0 1 new Object type getName json return false if Boolean TRUE equals processed put json true LOGGER log Level FINER already processed 0 1 new Object type getName json return false return true Override public Object instantiate Class actualType JSONObject json if isApplicable actualType json LOGGER log Level FINE switching to newInstance 0 1 new Object actualType getName json try final Descriptor descriptor Jenkins getActiveInstance getDescriptor actualType if descriptor null return descriptor newInstance Stapler getCurrentRequest json else LOGGER log Level WARNING Descriptor not found Falling back to default instantiation actualType getName json catch Exception x LOGGER log Level WARNING falling back to default instantiation actualType getName json x If nested objects are not using newInstance bindJSON will wind up throwing the same exception anyway so logging above will result in a duplicated stack trace However if they are then this is the only way to find errors in that newInstance Normally oldInterceptor instantiate will just return DEFAULT not actually do anything so we cannot try calling the default instantiation and then decide which problem to report return oldInterceptor instantiate actualType json Override public Object onConvert Type targetType Class targetTypeErasure Object jsonSource if jsonSource instanceof JSONObject JSONObject json JSONObject jsonSource if isApplicable targetTypeErasure json LOGGER log Level FINE switching to newInstance 0 1 new Object targetTypeErasure getName json try return Jenkins getActiveInstance getDescriptor targetTypeErasure newInstance Stapler getCurrentRequest json catch Exception x LOGGER log Level WARNING falling back to default instantiation targetTypeErasure getName json x else LOGGER log Level FINER ignoring non object 0 jsonSource return oldInterceptor onConvert targetType targetTypeErasure jsonSource private T verifyNewInstance T t if t null t getDescriptor this TODO should this be a fatal error LOGGER warning Father of t and its getDescriptor points to two different instances Probably malplaced Extension See http hudson 361315 n4 nabble com Help Hint needed Post build action doesn t stay activated td2308833 html return t public Klass getKlass return Klass java clazz public String getHelpFile return getHelpFile null public String getHelpFile final String fieldName return getHelpFile getKlass fieldName public String getHelpFile Klass clazz String fieldName HelpRedirect r helpRedirect get fieldName if r null return r resolve for Klass c clazz getAncestors String page descriptor getId help String suffix if fieldName null suffix else page fieldName suffix fieldName try if Stapler getCurrentRequest getView c help suffix null return page catch IOException e throw new Error e if getStaticHelpUrl c suffix null return page return null protected void addHelpFileRedirect String fieldName Class extends Describable owner String fieldNameToRedirectTo helpRedirect put fieldName new HelpRedirect owner fieldNameToRedirectTo public final boolean isInstance T instance return clazz isInstance instance public final boolean isSubTypeOf Class type return type isAssignableFrom clazz Deprecated public boolean configure StaplerRequest req throws FormException return true public boolean configure StaplerRequest req JSONObject json throws FormException compatibility return configure req public String getConfigPage return getViewPage clazz getPossibleViewNames config config jelly public String getGlobalConfigPage return getViewPage clazz getPossibleViewNames global null public GlobalConfigurationCategory getCategory return GlobalConfigurationCategory get GlobalConfigurationCategory Unclassified class private String getViewPage Class clazz String pageName String defaultValue return getViewPage clazz Collections singleton pageName defaultValue private String getViewPage Class clazz Collection String pageNames String defaultValue while clazz Object class clazz null for String pageName pageNames String name clazz getName replace replace pageName if clazz getClassLoader getResource name null return name clazz clazz getSuperclass return defaultValue protected final String getViewPage Class clazz String pageName We didn t find the configuration page Either this is non fatal in which case it doesn t matter what string we return so long as it doesn t exist Or this error is fatal in which case we want the developer to see what page he s missing so we put the page name return getViewPage clazz pageName pageName protected List String getPossibleViewNames String baseName List String names new ArrayList String for Facet f WebApp get Jenkins getInstance servletContext facets if f instanceof JellyCompatibleFacet JellyCompatibleFacet jcf JellyCompatibleFacet f for String ext jcf getScriptExtensions names add baseName ext return names public synchronized void save if BulkChange contains this return try getConfigFile write this SaveableListener fireOnChange this getConfigFile catch IOException e LOGGER log Level WARNING Failed to save getConfigFile e public synchronized void load XmlFile file getConfigFile if file exists return try file unmarshal this catch IOException e LOGGER log Level WARNING Failed to load file e protected XmlFile getConfigFile return new XmlFile new File Jenkins getInstance getRootDir getId xml protected PluginWrapper getPlugin return Jenkins getInstance getPluginManager whichPlugin clazz public void doHelp StaplerRequest req StaplerResponse rsp throws IOException ServletException String path req getRestOfPath if path contains throw new ServletException Illegal path path path path replace PluginWrapper pw getPlugin if pw null rsp setHeader X Plugin Short Name pw getShortName rsp setHeader X Plugin Long Name pw getLongName rsp setHeader X Plugin From Messages Descriptor From pw getLongName replace Hudson Jenkins replace hudson jenkins pw getUrl for Klass c getKlass c null c c getSuperClass RequestDispatcher rd Stapler getCurrentRequest getView c help path if rd null template based help page rd forward req rsp return URL url getStaticHelpUrl c path if url null TODO generalize macro expansion and perhaps even support JEXL rsp setContentType text html charset UTF 8 InputStream in url openStream try String literal IOUtils toString in UTF 8 rsp getWriter println Util replaceMacro literal Collections singletonMap rootURL req getContextPath finally IOUtils closeQuietly in return rsp sendError SC NOT FOUND private URL getStaticHelpUrl Klass c String suffix Locale locale Stapler getCurrentRequest getLocale String base help suffix URL url url c getResource base locale getLanguage locale getCountry locale getVariant html if url null return url url c getResource base locale getLanguage locale getCountry html if url null return url url c getResource base locale getLanguage html if url null return url default return c getResource base html static methods to work around warning when creating a generic array type public static T T toArray T values return values public static T List T toList T values return new ArrayList T Arrays asList values public static T extends Describable T Map Descriptor T T toMap Iterable T describables Map Descriptor T T m new LinkedHashMap Descriptor T T for T d describables m put d getDescriptor d return m public static T extends Describable T List T newInstancesFromHeteroList StaplerRequest req JSONObject formData String key Collection extends Descriptor T descriptors throws FormException return newInstancesFromHeteroList req formData get key descriptors public static T extends Describable T List T newInstancesFromHeteroList StaplerRequest req Object formData Collection extends Descriptor T descriptors throws FormException List T items new ArrayList T if formData null for Object o JSONArray fromObject formData JSONObject jo JSONObject o Descriptor T d null kind and class are mutually exclusive see class entry jelly but to be more lenient on the reader side we check them both anyway kind which maps to ID is more unique than class which can have multiple matching Descriptors so we prefer kind if it s present String kind jo optString kind null if kind null Only applies when Descriptor getId is overridden Note that kind is only supported here not inside the StaplerRequest bindJSON which is normally called by newInstance since Descriptor newInstance is not itself available to Stapler If you merely override getId for some reason but use DataBoundConstructor on your Describable there is no problem but you can only rely on newInstance being called at top level d findById descriptors kind if d null kind jo optString class if kind null else we will fall through to the warning This is the normal case d findByDescribableClassName descriptors kind if d null Deprecated system where stapler class was the Descriptor class name rather than Describable class name d findByClassName descriptors kind if d null items add d newInstance req jo else LOGGER log Level WARNING Received unexpected form data element 0 jo return items public static CheckForNull T extends Descriptor T findById Collection extends T list String id for T d list if d getId equals id return d return null private static CheckForNull T extends Descriptor T findByClassName Collection extends T list String className for T d list if d getClass getName equals className return d return null public static CheckForNull T extends Descriptor T findByDescribableClassName Collection extends T list String className for T d list if d clazz getName equals className return d return null public static CheckForNull T extends Descriptor T find Collection extends T list String string T d findByClassName list string if d null return d return findById list string public static CheckForNull Descriptor find String className return find ExtensionList lookup Descriptor class className public static final class FormException extends Exception implements HttpResponse private final String formField public FormException String message String formField super message this formField formField public FormException String message Throwable cause String formField super message cause this formField formField public FormException Throwable cause String formField super cause this formField formField public String getFormField return formField public void generateResponse StaplerRequest req StaplerResponse rsp Object node throws IOException ServletException if FormApply isApply req FormApply applyResponse notificationBar show quote getMessage notificationBar ERROR generateResponse req rsp node else for now we can t really use the field name that caused the problem new Failure getMessage generateResponse req rsp node getCause private static final Logger LOGGER Logger getLogger Descriptor class getName public static final class Self protected static Class self return Self classpackage hudson model public interface DescriptorByNameOwner extends ModelObject Descriptor getDescriptorByName String idpackage hudson import hudson model Descriptor import hudson model Describable import hudson model Hudson import jenkins ExtensionComponentSet import jenkins model Jenkins import hudson model ViewDescriptor import hudson model Descriptor FormException import hudson util AdaptedIterator import hudson util Memoizer import hudson util Iterators FlattenIterator import hudson slaves NodeDescriptor import hudson tasks Publisher import java util Collection import java util List import java util ArrayList import java util Collections import java util Iterator import java util logging Level import java util logging Logger import java util concurrent CopyOnWriteArrayList import javax annotation CheckForNull import org kohsuke stapler Stapler import net sf json JSONObject public class DescriptorExtensionList T extends Describable T D extends Descriptor T extends ExtensionList D SuppressWarnings unchecked rawtypes public static T extends Describable T D extends Descriptor T DescriptorExtensionList T D createDescriptorList Jenkins jenkins Class T describableType if describableType Class Publisher class return DescriptorExtensionList new Publisher DescriptorExtensionListImpl jenkins return new DescriptorExtensionList T D jenkins describableType Deprecated public static T extends Describable T D extends Descriptor T DescriptorExtensionList T D createDescriptorList Hudson hudson Class T describableType return DescriptorExtensionList createDescriptorList Jenkins hudson describableType private final Class T describableType Deprecated protected DescriptorExtensionList Hudson hudson Class T describableType this Jenkins hudson describableType protected DescriptorExtensionList Jenkins jenkins Class T describableType super jenkins Class Descriptor class CopyOnWriteArrayList getLegacyDescriptors describableType this describableType describableType public D find String fqcn return Descriptor find this fqcn public D find Class extends T type for D d this if d clazz type return d return null public T newInstanceFromRadioList JSONObject config throws FormException if config isNullObject return null none was selected int idx config getInt value return get idx newInstance Stapler getCurrentRequest config public T newInstanceFromRadioList JSONObject parent String name throws FormException return newInstanceFromRadioList parent getJSONObject name public CheckForNull D findByName String id for D d this if d getId equals id return d return null Override public boolean add D d boolean r super add d hudson getExtensionList Descriptor class add d return r Override public boolean remove Object o hudson getExtensionList Descriptor class remove o return super remove o Override protected Object getLoadLock return this Override protected List ExtensionComponent D load if jenkins null Should never happen on the real instance LOGGER log Level WARNING Cannot load extension components because Jenkins instance has not been assigned yet return Collections emptyList return load jenkins getExtensionList Descriptor class getComponents Override protected Collection ExtensionComponent D load ExtensionComponentSet delta return load delta find Descriptor class private List ExtensionComponent D load Iterable ExtensionComponent Descriptor set List ExtensionComponent D r new ArrayList ExtensionComponent D for ExtensionComponent Descriptor c set Descriptor d c getInstance try if d getT describableType r add ExtensionComponent c catch IllegalStateException e LOGGER log Level SEVERE d getClass doesn t extend Descriptor with a type parameter e skip this one return r private static final Memoizer Class CopyOnWriteArrayList ExtensionComponent Descriptor legacyDescriptors new Memoizer Class CopyOnWriteArrayList ExtensionComponent Descriptor public CopyOnWriteArrayList compute Class key return new CopyOnWriteArrayList private static T extends Describable T CopyOnWriteArrayList ExtensionComponent Descriptor T getLegacyDescriptors Class T type return CopyOnWriteArrayList legacyDescriptors get type public static Iterable Descriptor listLegacyInstances return new Iterable Descriptor public Iterator Descriptor iterator return new AdaptedIterator ExtensionComponent Descriptor Descriptor new FlattenIterator ExtensionComponent Descriptor CopyOnWriteArrayList ExtensionComponent Descriptor legacyDescriptors values protected Iterator ExtensionComponent Descriptor expand CopyOnWriteArrayList ExtensionComponent Descriptor v return v iterator protected Descriptor adapt ExtensionComponent Descriptor item return item getInstance public static void clearLegacyInstances legacyDescriptors clear private static final Logger LOGGER Logger getLogger DescriptorExtensionList class getNamepackage hudson util import hudson Extension import hudson ExtensionList import hudson model Describable import hudson model Descriptor import hudson model Descriptor FormException import jenkins model Jenkins import net sf json JSONObject import org kohsuke stapler Stapler import java util AbstractList import java util Iterator import java util List import java util concurrent CopyOnWriteArrayList import javax annotation CheckForNull public final class DescriptorList T extends Describable T extends AbstractList Descriptor T private final Class T type private final CopyOnWriteArrayList Descriptor T legacy Deprecated public DescriptorList Descriptor T descriptors this type null this legacy new CopyOnWriteArrayList Descriptor T descriptors public DescriptorList Class T type this type type this legacy null Override public Descriptor T get int index return store get index Override public int size return store size Override public Iterator Descriptor T iterator return store iterator Override Deprecated public boolean add Descriptor T d return store add d Override Deprecated public void add int index Descriptor T element add element order is ignored Override public boolean remove Object o return store remove o private List Descriptor T store if type null return legacy else return Jenkins getInstance T Descriptor T getDescriptorList type CheckForNull public T newInstanceFromRadioList JSONObject config throws FormException if config isNullObject return null none was selected int idx config getInt value return get idx newInstance Stapler getCurrentRequest config CheckForNull public T newInstanceFromRadioList JSONObject parent String name throws FormException return newInstanceFromRadioList parent getJSONObject name CheckForNull public Descriptor T findByName String id for Descriptor T d this if d getId equals id return d return null public void load Class extends Describable c try Class forName c getName true c getClassLoader catch ClassNotFoundException e throw new AssertionError e Can t happen CheckForNull public Descriptor T find String fqcn return Descriptor find this fqcnpackage hudson model import hudson ExtensionList import hudson ExtensionPoint import hudson scm SCMDescriptor import java util ArrayList import java util List import java util WeakHashMap import java util concurrent TimeUnit import java util logging Level import java util logging Logger import javax annotation CheckForNull import javax annotation Nonnull import jenkins ExtensionFilter import jenkins util SystemProperties public abstract class DescriptorVisibilityFilter implements ExtensionPoint private static final Logger LOGGER Logger getLogger DescriptorVisibilityFilter class getName public boolean filterType Nonnull Class contextClass Nonnull Descriptor descriptor return true public abstract boolean filter CheckForNull Object context Nonnull Descriptor descriptor public static ExtensionList DescriptorVisibilityFilter all return ExtensionList lookup DescriptorVisibilityFilter class public static T extends Descriptor List T apply Object context Iterable T source ExtensionList DescriptorVisibilityFilter filters all List T r new ArrayList T Class contextClass context null null context getClass OUTER for T d source if LOGGER isLoggable Level FINE LOGGER fine Determining visibility of d in context context for DescriptorVisibilityFilter f filters if LOGGER isLoggable Level FINER LOGGER finer Querying f for visibility of d in context try if contextClass null f filterType contextClass d if LOGGER isLoggable Level CONFIG LOGGER config Filter f hides d in contexts of type contextClass continue OUTER veto ed not shown if f filter context d if LOGGER isLoggable Level CONFIG LOGGER config Filter f hides d in context context continue OUTER veto ed not shown catch Error e LOGGER log Level WARNING Encountered error while processing filter f for context context e throw e catch Throwable e LOGGER log logLevelFor f Uncaught exception from filter f for context context e continue OUTER veto ed not shown r add d return r public static T extends Descriptor List T applyType Class contextClass Iterable T source ExtensionList DescriptorVisibilityFilter filters all List T r new ArrayList T OUTER for T d source if LOGGER isLoggable Level FINE LOGGER fine Determining visibility of d in contexts of type contextClass for DescriptorVisibilityFilter f filters if LOGGER isLoggable Level FINER LOGGER finer Querying f for visibility of d in type contextClass try if contextClass null f filterType contextClass d if LOGGER isLoggable Level CONFIG LOGGER config Filter f hides d in contexts of type contextClass continue OUTER veto ed not shown catch Error e LOGGER log Level WARNING Encountered error while processing filter f for contexts of type contextClass e throw e catch Throwable e LOGGER log logLevelFor f Uncaught exception from filter f for context of type contextClass e continue OUTER veto ed not shown r add d return r private static Level logLevelFor DescriptorVisibilityFilter f Long interval SystemProperties getLong DescriptorVisibilityFilter class getName badFilterLogWarningIntervalMinutes 60L the healthy path will never see this synchronized block synchronized ResourceHolder BAD FILTERS Long lastTime ResourceHolder BAD FILTERS get f if lastTime null lastTime TimeUnit MINUTES toMillis interval System currentTimeMillis ResourceHolder BAD FILTERS put f System currentTimeMillis return Level WARNING else return Level FINE private static final class ResourceHolder private static final WeakHashMap DescriptorVisibilityFilter Long BAD FILTERS new WeakHashMappackage hudson util import org apache commons digester Digester import org apache commons digester Rule import org xml sax Attributes public class Digester2 extends Digester Override public void addObjectCreate String pattern Class clazz addRule pattern new ObjectCreateRule2 clazz private static final class ObjectCreateRule2 extends Rule private final Class clazz public ObjectCreateRule2 Class clazz this clazz clazz Override public void begin String namespace String name Attributes attributes throws Exception Object instance clazz newInstance digester push instance Override public void end String namespace String name throws Exception digester poppackage com kaku colorfulnews utils import com kaku colorfulnews App public class DimenUtil public static float dp2px float dp final float scale App getAppContext getResources getDisplayMetrics density return dp scale 0 5f public static float sp2px float sp final float scale App getAppContext getResources getDisplayMetrics scaledDensity return sp scale public static int getScreenSize return App getAppContext getResources getDisplayMetrics widthPixelspackage jenkins util import java util AbstractSet import java util ArrayList import java util Collection import java util Collections import java util HashMap import java util Iterator import java util List import java util Map import java util Stack public abstract class DirectedGraph N protected abstract Collection N nodes protected abstract Collection N forward N node public static class SCC N extends AbstractSet N public final int index private final List N members new ArrayList N public SCC int index this index index Override public Iterator N iterator return members iterator Override public int size return members size class Node final N n int index 1 int lowlink SCC scc Node N n this n n Collection N edges return forward n public List SCC N getStronglyConnectedComponents final Map N Node nodes new HashMap N Node for N n nodes nodes put n new Node n final List SCC N sccs new ArrayList SCC N class Tarjan int index 0 int sccIndex 0 Stack Node pending new Stack Node void traverse for Node n nodes values if n index 1 visit n void visit Node v v index v lowlink index pending push v for N q v edges Node w nodes get q if w index 1 visit w v lowlink Math min v lowlink w lowlink else if pending contains w v lowlink Math min v lowlink w index if v lowlink v index found a new SCC SCC N scc new SCC N sccIndex sccs add scc Node w do w pending pop w scc scc scc members add w n while w v new Tarjan traverse Collections reverse sccs return sccspackage jenkins model import hudson model TopLevelItem import java io IOException public interface DirectlyModifiableTopLevelItemGroup extends ModifiableTopLevelItemGroup boolean canAdd TopLevelItem item I extends TopLevelItem I add I item String name throws IOException IllegalArgumentException void remove TopLevelItem item throws IOException IllegalArgumentExceptionpackage hudson model import java io IOException import javax annotation Nonnull import javax servlet ServletException import org kohsuke stapler HttpResponse import org kohsuke stapler QueryParameter import org kohsuke stapler interceptor RequirePOST public interface DirectlyModifiableView boolean remove Nonnull TopLevelItem item throws IOException IllegalArgumentException void add Nonnull TopLevelItem item throws IOException IllegalArgumentException HttpResponse doAddJobToView QueryParameter String name throws IOException ServletException HttpResponse doRemoveJobFromView QueryParameter String name throws IOException ServletExceptionpackage hudson model import hudson FilePath import hudson Util import java io IOException import java io InputStream import java io OutputStream import java io Serializable import java text Collator import java util ArrayList import java util Arrays import java util Collections import java util Comparator import java util List import java util Locale import java util StringTokenizer import java util logging Level import java util logging Logger import javax servlet ServletException import javax servlet http HttpServletResponse import jenkins model Jenkins import jenkins security MasterToSlaveCallable import jenkins util SystemProperties import jenkins util VirtualFile import org apache commons io IOUtils import org apache tools zip ZipEntry import org apache tools zip ZipOutputStream import org kohsuke accmod Restricted import org kohsuke accmod restrictions NoExternalUse import org kohsuke stapler HttpResponse import org kohsuke stapler StaplerRequest import org kohsuke stapler StaplerResponse public final class DirectoryBrowserSupport implements HttpResponse public final ModelObject owner public final String title private final VirtualFile base private final String icon private final boolean serveDirIndex private String indexFileName index html Deprecated public DirectoryBrowserSupport ModelObject owner String title this owner VirtualFile null title null false public DirectoryBrowserSupport ModelObject owner FilePath base String title String icon boolean serveDirIndex this owner base toVirtualFile title icon serveDirIndex public DirectoryBrowserSupport ModelObject owner VirtualFile base String title String icon boolean serveDirIndex this owner owner this base base this title title this icon icon this serveDirIndex serveDirIndex public void generateResponse StaplerRequest req StaplerResponse rsp Object node throws IOException ServletException try serveFile req rsp base icon serveDirIndex catch InterruptedException e throw new IOException interrupted e public void setIndexFileName String fileName this indexFileName fileName Deprecated public void serveFile StaplerRequest req StaplerResponse rsp FilePath root String icon boolean serveDirIndex throws IOException ServletException InterruptedException serveFile req rsp root toVirtualFile icon serveDirIndex private void serveFile StaplerRequest req StaplerResponse rsp VirtualFile root String icon boolean serveDirIndex throws IOException ServletException InterruptedException handle form submission String pattern req getParameter pattern if pattern null pattern req getParameter path compatibility with Hudson 1 129 if pattern null Util isSafeToRedirectTo pattern avoid open redirect rsp sendRedirect2 pattern return String path getPath req if path replace indexOf 1 don t serve anything other than files in the artifacts dir rsp sendError HttpServletResponse SC BAD REQUEST return split the path to the base directory portion abc def ghi which doesn t include any wildcard and the GLOB portion bar zip the last bar zip portion is to causes browses to set a good default file name so the rest portion ends here zip true break if pathElement equals plain plain true break StringBuilder sb inBase base rest if sb length 0 sb append sb append pathElement if inBase restSize restSize Math max restSize 0 String base base toString String rest rest toString this is the base file directory VirtualFile baseFile root child base if baseFile isDirectory if zip rsp setContentType application zip zip rsp getOutputStream baseFile rest return if plain rsp setContentType text plain charset UTF 8 try OutputStream os rsp getOutputStream for VirtualFile kid baseFile list os write kid getName getBytes UTF 8 if kid isDirectory os write os write n os flush return if rest length 0 if the target page to be displayed is a directory and the path doesn t end with redirect StringBuffer reqUrl req getRequestURL if reqUrl charAt reqUrl length 1 rsp sendRedirect2 reqUrl append toString return List List Path glob null if rest length 0 the rest is Ant glob pattern glob patternScan baseFile rest createBackRef restSize else if serveDirIndex serve directory index glob baseFile run new BuildChildPaths baseFile req getLocale if glob null serve glob req setAttribute it this List Path parentPaths buildParentPath base restSize req setAttribute parentPath parentPaths req setAttribute backPath createBackRef restSize req setAttribute topPath createBackRef parentPaths size restSize req setAttribute files glob req setAttribute icon icon req setAttribute path path req setAttribute pattern rest req setAttribute dir baseFile req getView this dir jelly forward req rsp return convert a directory service request to a single file service request by serving index html baseFile baseFile child indexFileName serve a single file if baseFile exists rsp sendError HttpServletResponse SC NOT FOUND return boolean view rest equals view if rest equals fingerprint InputStream fingerprintInput baseFile open try rsp forward Jenkins getInstance getFingerprint Util getDigestOf fingerprintInput req finally fingerprintInput close return long lastModified baseFile lastModified long length baseFile length if LOGGER isLoggable Level FINE LOGGER fine Serving baseFile with lastModified lastModified length length InputStream in baseFile open if view for binary files provide the file name for download rsp setHeader Content Disposition inline filename baseFile getName pseudo file name to let the Stapler set text plain rsp serveFile req in lastModified 1 length plain txt else String csp SystemProperties getString DirectoryBrowserSupport class getName CSP DEFAULT CSP VALUE if csp trim equals allow users to prevent sending this header by setting empty system property for String header new String Content Security Policy X WebKit CSP X Content Security Policy rsp setHeader header csp rsp serveFile req in lastModified 1 length baseFile getName private String getPath StaplerRequest req String path req getRestOfPath if path length 0 path return path private List Path buildParentPath String pathList int restSize List Path r new ArrayList Path StringTokenizer tokens new StringTokenizer pathList int total tokens countTokens int current 1 while tokens hasMoreTokens String token tokens nextToken r add new Path createBackRef total current restSize token true 0 true current return r private static String createBackRef int times if times 0 return StringBuilder buf new StringBuilder 3 times for int i 0 i times i buf append return buf toString private static void zip OutputStream outputStream VirtualFile dir String glob throws IOException try ZipOutputStream zos new ZipOutputStream outputStream zos setEncoding System getProperty file encoding TODO JENKINS 20663 make this overridable via query parameter for String n dir list glob length 0 glob String relativePath if glob length 0 JENKINS 19947 traditional behavior is to prepend the directory name relativePath dir getName n else relativePath n In ZIP archives All slashes MUST be forward slashes http pkware com documents casestudies APPNOTE TXT TODO On Linux file names can contain backslashes which should not treated as file separators Unfortunately only the file separator char of the master is known File separatorChar but not the file separator char of the maybe remote dir ZipEntry e new ZipEntry relativePath replace VirtualFile f dir child n e setTime f lastModified zos putNextEntry e InputStream in f open try Util copyStream in zos finally IOUtils closeQuietly in zos closeEntry public static final class Path implements Serializable private final String href private final String title private final boolean isFolder private final long size private final boolean isReadable public Path String href String title boolean isFolder long size boolean isReadable this href href this title title this isFolder isFolder this size size this isReadable isReadable public boolean isFolder return isFolder public boolean isReadable return isReadable public String getHref return href public String getTitle return title public String getIconName if isReadable return isFolder folder png text png else return isFolder folder error png text error png public String getIconClassName if isReadable return isFolder icon folder icon text else return isFolder icon folder error icon text error public long getSize return size private static final long serialVersionUID 1L private static final class FileComparator implements Comparator VirtualFile private Collator collator FileComparator Locale locale this collator Collator getInstance locale public int compare VirtualFile lhs VirtualFile rhs directories first files next int r dirRank lhs dirRank rhs if r 0 return r otherwise alphabetical return this collator compare lhs getName rhs getName private int dirRank VirtualFile f try if f isDirectory return 0 else return 1 catch IOException ex return 0 private static final class BuildChildPaths extends MasterToSlaveCallable List List Path IOException private final VirtualFile cur private final Locale locale BuildChildPaths VirtualFile cur Locale locale this cur cur this locale locale Override public List List Path call throws IOException return buildChildPaths cur locale private static List List Path buildChildPaths VirtualFile cur Locale locale throws IOException List List Path r new ArrayList List Path VirtualFile files cur list Arrays sort files new FileComparator locale for VirtualFile f files Path p new Path Util rawEncode f getName f getName f isDirectory f length f canRead if f isDirectory r add Collections singletonList p else find all empty intermediate directory List Path l new ArrayList Path l add p String relPath Util rawEncode f getName while true files that don t start with qualify for meaningful files nor SCM related files List VirtualFile sub new ArrayList VirtualFile for VirtualFile vf f list String name vf getName if name startsWith name equals CVS name equals svn sub add vf if sub size 1 sub get 0 isDirectory break f sub get 0 relPath Util rawEncode f getName l add new Path relPath f getName true 0 f canRead r add l return r private static List List Path patternScan VirtualFile baseDir String pattern String baseRef throws IOException String files baseDir list pattern if files length 0 List List Path r new ArrayList List Path files length for String match files List Path file buildPathList baseDir baseDir child match baseRef r add file return r return null private static List Path buildPathList VirtualFile baseDir VirtualFile filePath String baseRef throws IOException List Path pathList new ArrayList Path StringBuilder href new StringBuilder baseRef buildPathList baseDir filePath pathList href return pathList private static void buildPathList VirtualFile baseDir VirtualFile filePath List Path pathList StringBuilder href throws IOException VirtualFile parent filePath getParent if baseDir equals parent buildPathList baseDir parent pathList href href append Util rawEncode filePath getName if filePath isDirectory href append Path path new Path href toString filePath getName filePath isDirectory filePath length filePath canRead pathList add path private static final Logger LOGGER Logger getLogger DirectoryBrowserSupport class getName Restricted NoExternalUse class public static final String DEFAULT CSP VALUE sandbox default src none img src self style src selfpackage hudson util import hudson Util import org apache tools ant DirectoryScanner import org apache tools ant types FileSet import java io File import java io FileFilter import java io IOException import java io InterruptedIOException import java io Serializable import static hudson Util fixEmpty public abstract class DirScanner implements Serializable public abstract void scan File dir FileVisitor visitor throws IOException protected final void scanSingle File f String relative FileVisitor visitor throws IOException if visitor understandsSymlink try String target try target Util resolveSymlink f catch IOException x JENKINS 13202 target null if target null visitor visitSymlink f target relative return catch InterruptedException e throw IOException new InterruptedIOException initCause e visitor visit f relative public static class Full extends DirScanner private void scan File f String path FileVisitor visitor throws IOException if f canRead scanSingle f path f getName visitor if f isDirectory for File child f listFiles scan child path f getName visitor public void scan File dir FileVisitor visitor throws IOException scan dir visitor private static final long serialVersionUID 1L public static class Filter extends Full private final FileFilter filter public Filter FileFilter filter this filter filter Override public void scan File dir FileVisitor visitor throws IOException super scan dir visitor with filter private static final long serialVersionUID 1L public static class Glob extends DirScanner private final String includes excludes private boolean useDefaultExcludes true public Glob String includes String excludes this includes includes this excludes excludes public Glob String includes String excludes boolean useDefaultExcludes this includes excludes this useDefaultExcludes useDefaultExcludes public void scan File dir FileVisitor visitor throws IOException if fixEmpty includes null excludes null optimization new Full scan dir visitor return FileSet fs Util createFileSet dir includes excludes fs setDefaultexcludes useDefaultExcludes if dir exists DirectoryScanner ds fs getDirectoryScanner new org apache tools ant Project for String f ds getIncludedFiles File file new File dir f scanSingle file f visitor private static final long serialVersionUID 1L private static final long serialVersionUID 1Limport java util Date import org apache axis client Call import org apache axis client Stub import com adyen services common Amount import com adyen services payment PaymentLocator import com adyen services payment PaymentPortType import com adyen services payment PaymentRequest import com adyen services payment PaymentResult import com adyen services payment Recurring import com adyen services recurring DisableRequest import com adyen services recurring DisableResult import com adyen services recurring RecurringLocator import com adyen services recurring RecurringPortType public class DisablingRecurringDetail public static void main String args try RecurringPortType ws new RecurringLocator getRecurringHttpPort new java net URL Credentials recurring test address Basic HTTP Authentication Stub ws setProperty Call USERNAME PROPERTY Credentials ws user Stub ws setProperty Call PASSWORD PROPERTY Credentials pwd user DisableRequest request new DisableRequest request setMerchantAccount Credentials merchant account request setRecurringDetailReference recurring detail reference request setShopperReference shopperreference DisableResult result ws disable request System out println new Date System out println result getResponse catch Exception ex ex printStackTracepackage hudson cli import hudson AbortException import hudson Extension import hudson model Computer import hudson model ComputerSet import hudson util EditDistance import jenkins model Jenkins import org kohsuke args4j Argument import org kohsuke args4j Option import java util HashSet import java util List import java util logging Logger Extension public class DisconnectNodeCommand extends CLICommand Argument metaVar NAME usage Slave name or empty string for master comma separated list is supported required true multiValued true private List String nodes Option name m usage Record the reason about why you are disconnecting this node public String cause private static final Logger LOGGER Logger getLogger DisconnectNodeCommand class getName Override public String getShortDescription return Messages DisconnectNodeCommand ShortDescription Override protected int run throws Exception boolean errorOccurred false final Jenkins jenkins Jenkins getActiveInstance final HashSet String hs new HashSet String hs addAll nodes List String names null for String node s hs Computer computer null try computer jenkins getComputer node s if computer null if names null names ComputerSet getComputerNames String adv EditDistance findNearest node s names throw new IllegalArgumentException adv null hudson model Messages Computer NoSuchSlaveExistsWithoutAdvice node s hudson model Messages Computer NoSuchSlaveExists node s adv computer cliDisconnect cause catch Exception e if hs size 1 throw e stderr println String format node s e getMessage errorOccurred true continue if errorOccurred throw new AbortException CLI LISTPARAM SUMMARY ERROR TEXT return 0package hudson node monitors import hudson Extension import hudson FilePath import hudson model Computer import hudson model Node import hudson remoting Callable import jenkins model Jenkins import hudson node monitors DiskSpaceMonitorDescriptor DiskSpace import org kohsuke stapler DataBoundConstructor import java io IOException import java text ParseException public class DiskSpaceMonitor extends AbstractDiskSpaceMonitor DataBoundConstructor public DiskSpaceMonitor String freeSpaceThreshold throws ParseException super freeSpaceThreshold public DiskSpaceMonitor public DiskSpace getFreeSpace Computer c return DESCRIPTOR get c Override public String getColumnCaption Hide this column from non admins return Jenkins getInstance hasPermission Jenkins ADMINISTER super getColumnCaption null public static final DiskSpaceMonitorDescriptor DESCRIPTOR new DiskSpaceMonitorDescriptor public String getDisplayName return Messages DiskSpaceMonitor DisplayName Override protected Callable DiskSpace IOException createCallable Computer c Node node c getNode if node null return null FilePath p node getRootPath if p null return null return p asCallableWith new GetUsableSpace Extension public static DiskSpaceMonitorDescriptor install return DESCRIPTORpackage hudson node monitors import hudson Functions import jenkins MasterToSlaveFileCallable import hudson remoting VirtualChannel import hudson Util import hudson node monitors DiskSpaceMonitorDescriptor DiskSpace import java io File import java io IOException import java io Serializable import java math BigDecimal import java text ParseException import java util Locale import org kohsuke accmod Restricted import org kohsuke accmod restrictions DoNotUse import org kohsuke stapler export ExportedBean import org kohsuke stapler export Exported public abstract class DiskSpaceMonitorDescriptor extends AbstractAsyncNodeMonitorDescriptor DiskSpace ExportedBean public static final class DiskSpace extends MonitorOfflineCause implements Serializable private final String path Exported public final long size private boolean triggered private Class extends AbstractDiskSpaceMonitor trigger public DiskSpace String path long size this path path this size size Override public String toString return Messages DiskSpaceMonitorDescriptor DiskSpace FreeSpaceTooLow getGbLeft path Exported public String getPath return path Needed for jelly that does not seem to be able to access properties named size as it confuses it with built in size method and fails to parse the expression expecting Restricted DoNotUse class public long getFreeSize return size public String getGbLeft long space size space 1024L convert to KB space 1024L convert to MB return new BigDecimal space scaleByPowerOfTen 3 toPlainString public String toHtml String humanReadableSpace Functions humanReadableByteSize size if triggered return Util wrapToErrorSpan humanReadableSpace return humanReadableSpace protected void setTriggered boolean triggered this triggered triggered protected void setTriggered Class extends AbstractDiskSpaceMonitor trigger boolean triggered this trigger trigger this triggered triggered Override public Class extends AbstractDiskSpaceMonitor getTrigger return trigger public static DiskSpace parse String size throws ParseException size size toUpperCase Locale ENGLISH trim if size endsWith B cut off B from KB MB etc size size substring 0 size length 1 long multiplier 1 look for the size suffix The goal here isn t to detect all invalid size suffix so we ignore double suffix like 10gkb or anything like that String suffix KMGT for int i 0 i suffix length i if size endsWith suffix substring i i 1 multiplier 1 for int j 0 j i j multiplier 1024 size size substring 0 size length 1 return new DiskSpace long Double parseDouble size trim multiplier private static final long serialVersionUID 2L protected static final class GetUsableSpace extends MasterToSlaveFileCallable DiskSpace public GetUsableSpace public DiskSpace invoke File f VirtualChannel channel throws IOException long s f getUsableSpace if s 0 return null return new DiskSpace f getCanonicalPath s private static final long serialVersionUID 1Lpackage hudson model import java io IOException import java util logging Level import java util logging Logger import hudson Extension import hudson model listeners ItemListener Extension public class DisplayNameListener extends ItemListener private final static Logger LOGGER Logger getLogger DisplayNameListener class getName Override public void onCopied Item src Item item bug 5056825 Display name field should be cleared when you copy a job within the same folder if item instanceof AbstractItem src getParent item getParent AbstractItem dest AbstractItem item try dest setDisplayName null catch IOException ioe LOGGER log Level WARNING String format onCopied Exception while trying to clear the displayName for Item name s item getName ioe Override public void onRenamed Item item String oldName String newName bug 5077308 Display name field should be cleared when you rename a job if item instanceof AbstractItem AbstractItem abstractItem AbstractItem item if oldName equals abstractItem getDisplayName the user renamed the job but the old project name which is shown as the displayname if no displayname was set has been set into the displayname field This means that the displayname was never set so we want to set it to null as it was before try LOGGER info String format onRenamed Setting displayname to null for item name s item getName abstractItem setDisplayName null catch IOException ioe LOGGER log Level WARNING String format onRenamed Exception while trying to clear the displayName for Item name s item getName ioepackage hudson import jenkins util SystemProperties import jenkins model Jenkins import jenkins model Jenkins MasterComputer import javax jmdns JmDNS import javax jmdns ServiceInfo import java io Closeable import java io IOException import java net URL import java util HashMap import java util Map import java util concurrent Callable import java util logging Level import java util logging Logger public class DNSMultiCast implements Closeable private JmDNS jmdns public DNSMultiCast final Jenkins jenkins if disabled return escape hatch the registerService call can be slow run these asynchronously MasterComputer threadPoolForRemoting submit new Callable Object public Object call try jmdns JmDNS create Map String String props new HashMap String String String rootURL jenkins getRootUrl if rootURL null return null props put url rootURL try props put version String valueOf Jenkins getVersion catch IllegalArgumentException e failed to parse the version number TcpSlaveAgentListener tal jenkins getTcpSlaveAgentListener if tal null props put slave port String valueOf tal getPort props put server id jenkins getLegacyInstanceId URL jenkins url new URL rootURL int jenkins port jenkins url getPort if jenkins port 1 jenkins port 80 if jenkins url getPath length 0 props put path jenkins url getPath jmdns registerService ServiceInfo create hudson tcp local jenkins jenkins port 0 0 props for backward compatibility jmdns registerService ServiceInfo create jenkins tcp local jenkins jenkins port 0 0 props Make Jenkins appear in Safari s Bonjour bookmarks jmdns registerService ServiceInfo create http tcp local Jenkins jenkins port 0 0 props catch IOException e LOGGER log Level INFO Cannot advertise service to DNS multi cast skipping 0 e LOGGER log Level FINE null e return null public void close if jmdns null try jmdns abort jmdns null catch final IOException e LOGGER log Level WARNING Failed to close down JmDNS instance e private static final Logger LOGGER Logger getLogger DNSMultiCast class getName public static boolean disabled SystemProperties getBoolean DNSMultiCast class getName disabledpackage hudson util jna import org jinterop dcom common IJIAuthInfo import org jinterop dcom common JIException import org jinterop winreg IJIWinReg import org jinterop winreg JIPolicyHandle import org jinterop winreg JIWinRegFactory import java net UnknownHostException import java util regex Matcher import java util regex Pattern public class DotNet public static boolean isInstalled int major int minor try see http support microsoft com scid kb en us 315291 for the basic algorithm observation in my registry shows that the actual key name can be things like v2 0 SP1 or v2 0 50727 so the regexp is written to accommodate this RegistryKey key RegistryKey LOCAL MACHINE openReadonly SOFTWARE Microsoft NETFramework try for String keyName key getSubKeys if matches keyName major minor return true return false finally key dispose catch JnaException e if e getErrorCode 2 thrown when openReadonly fails because the key doesn t exist return false throw e public static boolean isInstalled int major int minor String targetMachine IJIAuthInfo session throws JIException UnknownHostException IJIWinReg registry JIWinRegFactory getSingleTon getWinreg session targetMachine true JIPolicyHandle hklm null JIPolicyHandle key null try hklm registry winreg OpenHKLM key registry winreg OpenKey hklm SOFTWARE Microsoft NETFramework IJIWinReg KEY READ for int i 0 i String keyName registry winreg EnumKey key i 0 if matches keyName major minor return true catch JIException e if e getErrorCode 2 return false not found throw e finally if hklm null registry winreg CloseKey hklm if key null registry winreg CloseKey key registry closeConnection private static boolean matches String keyName int major int minor Matcher m VERSION PATTERN matcher keyName if m matches int mj Integer parseInt m group 1 if mj major int mn Integer parseInt m group 2 if mn minor return true return false private static final Pattern VERSION PATTERN Pattern compile v d dpackage hudson util import hudson init Initializer import jenkins model Jenkins import hudson triggers SafeTimerTask import jenkins util Timer import org apache commons io FileUtils import org kohsuke stapler StaplerRequest import org kohsuke stapler StaplerResponse import javax servlet ServletException import javax servlet ServletContext import static hudson init InitMilestone JOB LOADED import static javax servlet http HttpServletResponse SC INTERNAL SERVER ERROR import java io File import java io IOException import java util Random import java util concurrent TimeUnit import java util logging Logger import java util logging Level import java lang management ManagementFactory import java lang reflect Method public class DoubleLaunchChecker private long lastWriteTime 0L private boolean ignore false private final Random random new Random public final File home private String collidingId public DoubleLaunchChecker home Jenkins getInstance getRootDir protected void execute File timestampFile new File home owner long t timestampFile lastModified if t 0 lastWriteTime 0 t lastWriteTime ignore try collidingId FileUtils readFileToString timestampFile catch IOException e LOGGER log Level SEVERE Failed to read collision file e we noticed that someone else have updated this file switch GUI to display this error Jenkins getInstance servletContext setAttribute app this LOGGER severe Collision detected timestamp t expected lastWriteTime we need to continue updating this file so that the other Hudson would notice the problem too try FileUtils writeStringToFile timestampFile getId lastWriteTime timestampFile lastModified catch IOException e if failed to write err on the safe side and assume things are OK lastWriteTime 0 schedule public String getId Jenkins h Jenkins getInstance in servlet 2 5 we can get the context path String contextPath try Method m ServletContext class getMethod getContextPath contextPath contextPath m invoke h servletContext catch Exception e maybe running with Servlet 2 4 return h hashCode contextPath at ManagementFactory getRuntimeMXBean getName public String getCollidingId return collidingId public void schedule randomize the scheduling so that multiple Hudson instances will write at the file at different time long MINUTE 1000 60 Timer get schedule new SafeTimerTask protected void doRun execute random nextInt 30 60 MINUTE TimeUnit MILLISECONDS Initializer after JOB LOADED public static void init new DoubleLaunchChecker schedule public void doDynamic StaplerRequest req StaplerResponse rsp throws IOException ServletException rsp setStatus SC INTERNAL SERVER ERROR req getView this index jelly forward req rsp public void doIgnore StaplerRequest req StaplerResponse rsp throws IOException ignore true Jenkins getInstance servletContext setAttribute app Jenkins getInstance rsp sendRedirect2 req getContextPath private static final Logger LOGGER Logger getLogger DoubleLaunchChecker class getNamepackage hudson tools import hudson FilePath import hudson model DownloadService Downloadable import hudson model Node import hudson model TaskListener import hudson slaves NodeSpecific import net sf json JSONObject import java io IOException import java util Arrays import java util Collections import java util LinkedList import java util List import java net URL public abstract class DownloadFromUrlInstaller extends ToolInstaller public final String id protected DownloadFromUrlInstaller String id this installer implementation is designed for platform independent binary and as such we don t provide the label support super null this id id protected boolean isUpToDate FilePath expectedLocation Installable i throws IOException InterruptedException FilePath marker expectedLocation child installedFrom return marker exists marker readToString equals i url public Installable getInstallable throws IOException for Installable i DescriptorImpl getDescriptor getInstallables if id equals i id return i return null public FilePath performInstallation ToolInstallation tool Node node TaskListener log throws IOException InterruptedException FilePath expected preferredLocation tool node Installable inst getInstallable if inst null log getLogger println Invalid tool ID id return expected if inst instanceof NodeSpecific inst Installable NodeSpecific inst forNode node log if isUpToDate expected inst return expected if expected installIfNecessaryFrom new URL inst url log Unpacking inst url to expected on node getDisplayName expected child timestamp delete we don t use the timestamp FilePath base findPullUpDirectory expected if base null base expected base moveAllChildrenTo expected leave a record for the next up to date check expected child installedFrom write inst url UTF 8 expected act new ZipExtractionInstaller ChmodRecAPlusX return expected protected FilePath findPullUpDirectory FilePath root throws IOException InterruptedException if the directory just contains one directory and that alone assume that s the pull up subject otherwise leave it as is List FilePath children root list if children size 1 return null if children get 0 isDirectory return children get 0 return null public static abstract class DescriptorImpl T extends DownloadFromUrlInstaller extends ToolInstallerDescriptor T SuppressWarnings deprecation intentionally adding dynamic item here protected DescriptorImpl Downloadable all add createDownloadable public Downloadable createDownloadable if this instanceof DownloadFromUrlInstaller DescriptorImpl final DownloadFromUrlInstaller DescriptorImpl delegate DownloadFromUrlInstaller DescriptorImpl this return new Downloadable getId public JSONObject reduce List JSONObject jsonList if isDefaultSchema jsonList return delegate reduce jsonList else if it s not default schema fall back to the super class implementation return super reduce jsonList return new Downloadable getId private boolean isDefaultSchema List JSONObject jsonList JSONObject jsonToolInstallerList jsonList get 0 ToolInstallerList toolInstallerList ToolInstallerList JSONObject toBean jsonToolInstallerList ToolInstallerList class if toolInstallerList null ToolInstallerEntry entryList toolInstallerList list ToolInstallerEntry sampleEntry entryList 0 if sampleEntry null if sampleEntry id null sampleEntry name null sampleEntry url null return true return false private JSONObject reduce List JSONObject jsonList List ToolInstallerEntry reducedToolEntries new LinkedList collect all tool installers objects from the multiple json objects for JSONObject jsonToolList jsonList ToolInstallerList toolInstallerList ToolInstallerList JSONObject toBean jsonToolList ToolInstallerList class reducedToolEntries addAll Arrays asList toolInstallerList list while Downloadable hasDuplicates reducedToolEntries id List ToolInstallerEntry tmpToolInstallerEntries new LinkedList we need to skip the processed entries boolean processed new boolean reducedToolEntries size for int i 0 i reducedToolEntries size i if processed i true continue ToolInstallerEntry data1 reducedToolEntries get i boolean hasDuplicate false for int j i 1 j reducedToolEntries size j ToolInstallerEntry data2 reducedToolEntries get j if we found a duplicate we choose the first one if data1 id equals data2 id hasDuplicate true processed j true tmpToolInstallerEntries add data1 after the first duplicate has been found we break the loop since the duplicates are processed two by two break if no duplicate has been found we just insert the entry in the tmp list if hasDuplicate tmpToolInstallerEntries add data1 reducedToolEntries tmpToolInstallerEntries ToolInstallerList toolInstallerList new ToolInstallerList toolInstallerList list new ToolInstallerEntry reducedToolEntries size reducedToolEntries toArray toolInstallerList list JSONObject reducedToolEntriesJsonList JSONObject fromObject toolInstallerList return the list with no duplicates return reducedToolEntriesJsonList public String getId return clazz getName replace public List extends Installable getInstallables throws IOException JSONObject d Downloadable get getId getData if d null return Collections emptyList return Arrays asList InstallableList JSONObject toBean d InstallableList class list public static class InstallableList initialize with an empty array just in case JSON doesn t have the list field which shouldn t happen public Installable list new Installable 0 public static class Installable public String id public String name public String url public abstract class NodeSpecificInstallable extends Installable implements NodeSpecific NodeSpecificInstallable public NodeSpecificInstallable Installable inst this id inst id this name inst name this url inst urlpackage hudson model import hudson Extension import hudson ExtensionList import hudson ExtensionListListener import hudson ExtensionPoint import hudson ProxyConfiguration import jenkins util SystemProperties import hudson init InitMilestone import hudson init Initializer import hudson util FormValidation import hudson util FormValidation Kind import hudson util QuotedStringTokenizer import hudson util TextFile import static hudson util TimeUnit2 DAYS import java io File import java io IOException import java io InputStream import java lang reflect Field import java net URL import java net URLEncoder import java util ArrayList import java util List import java util logging Level import java util logging Logger import jenkins model DownloadSettings import jenkins model Jenkins import jenkins util JSONSignatureValidator import net sf json JSONException import net sf json JSONObject import org apache commons io IOUtils import org kohsuke accmod Restricted import org kohsuke accmod restrictions NoExternalUse import org kohsuke stapler Stapler import org kohsuke stapler StaplerRequest import org kohsuke stapler StaplerResponse Extension public class DownloadService extends PageDecorator private static final String signatureValidatorPrefix downloadable public String generateFragment if DownloadSettings usePostBack return if neverUpdate return if doesNotSupportPostMessage return StringBuilder buf new StringBuilder if Jenkins getInstance hasPermission Jenkins READ long now System currentTimeMillis for Downloadable d Downloadable all if d getDue now d lastAttempt 10 1000 now buf append script append Behaviour addLoadEvent function append downloadService download append QuotedStringTokenizer quote d getId append append QuotedStringTokenizer quote mapHttps d getUrl append append version QuotedStringTokenizer quote Jenkins VERSION append append QuotedStringTokenizer quote Stapler getCurrentRequest getContextPath getUrl byId d getId postBack append append null append append script d lastAttempt now return buf toString private boolean doesNotSupportPostMessage StaplerRequest req Stapler getCurrentRequest if req null return false String ua req getHeader User Agent if ua null return false according to http caniuse com feat x doc messaging IE 7 doesn t support pstMessage see http www useragentstring com pages Internet 20Explorer for user agents we want to err on the cautious side here Because of JENKINS 15105 we can t serve signed metadata from JSON which means we need to be using a modern browser as a vehicle to request these data This check is here to prevent Jenkins from using older browsers that are known not to support postMessage as the vehicle return ua contains Windows ua contains MSIE 5 ua contains MSIE 6 ua contains MSIE 7 private String mapHttps String url if url startsWith http updates jenkins ci org Jenkins getInstance isRootUrlSecure return https url substring 4 return url public Downloadable getById String id for Downloadable d Downloadable all if d getId equals id return d return null Restricted NoExternalUse class public static String loadJSON URL src throws IOException try InputStream is ProxyConfiguration open src getInputStream String jsonp IOUtils toString is UTF 8 int start jsonp indexOf int end jsonp lastIndexOf if start 0 end start return jsonp substring start end 1 else throw new IOException Could not find JSON in src Restricted NoExternalUse class public static String loadJSONHTML URL src throws IOException try InputStream is ProxyConfiguration open src getInputStream String jsonp IOUtils toString is UTF 8 String preamble window parent postMessage JSON stringify int start jsonp indexOf preamble int end jsonp lastIndexOf if start 0 end start return jsonp substring start preamble length end trim else throw new IOException Could not find JSON in src Restricted NoExternalUse class public static class DownloadableListener extends ExtensionListListener Initializer after InitMilestone EXTENSIONS AUGMENTED public static void installListener ExtensionList lookup Downloadable class addListener new DownloadableListener Override public void onChange for Downloadable d Downloadable all TextFile f d getDataFile if f null f exists LOGGER log Level FINE Updating metadata for d getId try d updateNow catch IOException e LOGGER log Level WARNING Failed to update metadata for d getId e else LOGGER log Level FINER Skipping update of metadata for d getId private static final Logger LOGGER Logger getLogger DownloadableListener class getName public static class Downloadable implements ExtensionPoint private final String id private final String url private final long interval private volatile long due 0 private volatile long lastAttempt Long MIN VALUE public Downloadable String id String url long interval this id id this url url this interval interval public Downloadable this id getClass getName replace this url this id json this interval DEFAULT INTERVAL public Downloadable Class id this id getName replace public Downloadable String id this id id json public Downloadable String id String url this id url DEFAULT INTERVAL public String getId return id public String getUrl return Jenkins getInstance getUpdateCenter getDefaultBaseUrl updates url public List String getUrls List String updateSites new ArrayList String for UpdateSite site Jenkins getActiveInstance getUpdateCenter getSiteList String siteUrl site getUrl int baseUrlEnd siteUrl indexOf update center json if baseUrlEnd 1 String siteBaseUrl siteUrl substring 0 baseUrlEnd updateSites add siteBaseUrl updates url else LOGGER log Level WARNING Url 0 does not look like an update center siteUrl return updateSites public long getInterval return interval public TextFile getDataFile return new TextFile new File Jenkins getInstance getRootDir updates id public long getDue if due 0 if the file doesn t exist this code should result in a very small but 0 due value which should trigger the retrieval immediately due getDataFile file lastModified interval return due public JSONObject getData throws IOException TextFile df getDataFile if df exists try return JSONObject fromObject df read catch JSONException e df delete if we keep this file it will cause repeated failures throw new IOException Failed to parse df into JSON e return null public void doPostBack StaplerRequest req StaplerResponse rsp throws IOException DownloadSettings checkPostBackAccess long dataTimestamp System currentTimeMillis due dataTimestamp getInterval success or fail don t try too often String json IOUtils toString req getInputStream UTF 8 FormValidation e load json dataTimestamp if e kind Kind OK LOGGER severe e renderHtml throw e rsp setContentType text plain So browser won t try to parse response private FormValidation load String json long dataTimestamp throws IOException TextFile df getDataFile df write json df file setLastModified dataTimestamp LOGGER info Obtained the updated data file for id return FormValidation ok Restricted NoExternalUse class public FormValidation updateNow throws IOException List JSONObject jsonList new ArrayList boolean toolInstallerMetadataExists false for UpdateSite updatesite Jenkins getActiveInstance getUpdateCenter getSiteList String site updatesite getMetadataUrlForDownloadable url if site null return FormValidation warning The update site site does not look like an update center String jsonString try jsonString loadJSONHTML new URL site html id URLEncoder encode getId UTF 8 version URLEncoder encode Jenkins VERSION UTF 8 toolInstallerMetadataExists true catch Exception e LOGGER log Level FINE Could not load json from site e continue JSONObject o JSONObject fromObject jsonString if signatureCheck FormValidation e updatesite getJsonSignatureValidator signatureValidatorPrefix id verifySignature o if e kind Kind OK LOGGER log Level WARNING signature check failed for site e continue jsonList add o if jsonList size 0 toolInstallerMetadataExists return FormValidation warning None of the tool installer metadata passed the signature check else if toolInstallerMetadataExists LOGGER log Level WARNING No tool installer metadata found for id return FormValidation ok JSONObject reducedJson reduce jsonList return load reducedJson toString System currentTimeMillis public JSONObject reduce List JSONObject jsonList return jsonList get 0 public static T boolean hasDuplicates List T genericList String comparator if genericList isEmpty return false Field field try field genericList get 0 getClass getDeclaredField comparator catch NoSuchFieldException e LOGGER warning comparator comparator does not exist for genericList get 0 getClass e return false for int i 0 i genericList size i T data1 genericList get i for int j i 1 j genericList size j T data2 genericList get j try if field get data1 equals field get data2 return true catch IllegalAccessException e LOGGER warning could not access field comparator e return false public static ExtensionList Downloadable all return ExtensionList lookup Downloadable class public static Downloadable get String id for Downloadable d all if d id equals id return d return null private static final Logger LOGGER Logger getLogger Downloadable class getName private static final long DEFAULT INTERVAL SystemProperties getLong Downloadable class getName defaultInterval DAYS toMillis 1 public static boolean neverUpdate SystemProperties getBoolean DownloadService class getName never public static boolean signatureCheck SystemProperties getBoolean DownloadService class getName noSignatureCheckpackage jenkins model import hudson Extension import hudson Main import hudson model AdministrativeMonitor import hudson model AsyncPeriodicWork import hudson model DownloadService import hudson model DownloadService Downloadable import hudson model TaskListener import hudson model UpdateSite import hudson util FormValidation import java io IOException import java util logging Level import java util logging Logger import org acegisecurity AccessDeniedException import org jenkinsci Symbol import org kohsuke accmod Restricted import org kohsuke accmod restrictions NoExternalUse import org kohsuke stapler HttpResponse Restricted NoExternalUse class no clear reason for this to be an API Extension Symbol downloadSettings public final class DownloadSettings extends GlobalConfiguration public static DownloadSettings get return Jenkins getInstance getInjector getInstance DownloadSettings class private boolean useBrowser false public DownloadSettings load public boolean isUseBrowser return useBrowser public void setUseBrowser boolean useBrowser this useBrowser useBrowser save Override public GlobalConfigurationCategory getCategory return GlobalConfigurationCategory get GlobalConfigurationCategory Security class public static boolean usePostBack return get isUseBrowser Jenkins getInstance hasPermission Jenkins ADMINISTER public static void checkPostBackAccess throws AccessDeniedException if get isUseBrowser throw new AccessDeniedException browser based download disabled Jenkins getInstance checkPermission Jenkins ADMINISTER Extension Symbol updateCenterCheck public static final class DailyCheck extends AsyncPeriodicWork private static final Logger LOGGER Logger getLogger DailyCheck class getName public DailyCheck super Download metadata Override public long getRecurrencePeriod return DAY Override public long getInitialDelay return Main isUnitTest DAY 0 Override protected void execute TaskListener listener throws IOException InterruptedException if get isUseBrowser return boolean due false for UpdateSite site Jenkins getInstance getUpdateCenter getSites if site isDue due true break if due JENKINS 32886 downloadables like the tool installer data may have never been tried if the plugin was installed after a restart so let s give them a try here final long now System currentTimeMillis for Downloadable d Downloadable all if d getDue now try d updateNow catch Exception e LOGGER log Level WARNING String format Unable to update downloadable s d getId e return This checks updates of the update sites and downloadables HttpResponse rsp Jenkins getInstance getPluginManager doCheckUpdatesServer if rsp instanceof FormValidation listener error FormValidation rsp renderHtml Extension public static final class Warning extends AdministrativeMonitor Override public String getDisplayName return Messages DownloadSettings Warning DisplayName Override public boolean isActivated return DownloadSettings get isUseBrowserpackage hudson util import java io IOException import java io OutputStream public class DualOutputStream extends OutputStream private final OutputStream lhs rhs public DualOutputStream OutputStream lhs OutputStream rhs this lhs lhs this rhs rhs public void write int b throws IOException lhs write b rhs write b Override public void write byte b throws IOException lhs write b rhs write b Override public void write byte b int off int len throws IOException lhs write b off len rhs write b off len Override public void flush throws IOException lhs flush rhs flush Override public void close throws IOException lhs close rhs closepackage hudson slaves import hudson model Slave import hudson model Descriptor FormException import hudson Extension import java io IOException import java util ArrayList import java util List import org jenkinsci Symbol import org kohsuke stapler DataBoundConstructor import javax annotation Nonnull public final class DumbSlave extends Slave Deprecated public DumbSlave String name String nodeDescription String remoteFS String numExecutors Mode mode String labelString ComputerLauncher launcher RetentionStrategy retentionStrategy throws FormException IOException this name nodeDescription remoteFS numExecutors mode labelString launcher retentionStrategy new ArrayList public DumbSlave String name String nodeDescription String remoteFS String numExecutors Mode mode String labelString ComputerLauncher launcher RetentionStrategy retentionStrategy List extends NodeProperty nodeProperties throws IOException FormException super name nodeDescription remoteFS numExecutors mode labelString launcher retentionStrategy nodeProperties DataBoundConstructor public DumbSlave Nonnull String name String remoteFS ComputerLauncher launcher throws FormException IOException super name remoteFS launcher Extension Symbol dumb slave public static final class DescriptorImpl extends SlaveDescriptor public String getDisplayName return Messages DumbSlave displayNamepackage hudson util import java util Collection import java util Arrays public class EditDistance public static int editDistance String a String b return new EditDistance a b calc public static String findNearest String key String group return findNearest key Arrays asList group public static String findNearest String key Collection String group int c Integer MAX VALUE String r null for String g group int ed editDistance key g if c ed c ed r g return r private int cost private int back private final String a b private EditDistance String a String b this a a this b b cost new int a length 1 back new int a length 1 back buffer for int i 0 i a length i cost i i private void flip int t cost cost back back t private int min int a int b int c return Math min a Math min b c private int calc for int j 0 j b length j flip cost 0 j 1 for int i 0 i a length i int match a charAt i b charAt j 0 1 cost i 1 min back i match cost i 1 back i 1 1 return cost a lengthpackage hudson scm import org kohsuke stapler export CustomExportedBean import java util List import java util Collections import java util Arrays public final class EditType implements CustomExportedBean private String name private String description public EditType String name String description this name name this description description public String getName return name public String getDescription return description public String toExportedObject return name public static final EditType ADD new EditType add The file was added public static final EditType EDIT new EditType edit The file was modified public static final EditType DELETE new EditType delete The file was removed public static final List EditType ALL Collections unmodifiableList Arrays asList ADD EDIT DELETEpackage hudson scm import hudson model Run import java io IOException import java net URL import java util Collections import java util Iterator final class EmptyChangeLogSet extends ChangeLogSet ChangeLogSet Entry EmptyChangeLogSet Run build super build new RepositoryBrowser ChangeLogSet Entry Override public URL getChangeSetLink ChangeLogSet Entry changeSet throws IOException return null Override public boolean isEmptySet return true public Iterator Entry iterator return Collections Entry emptySet iteratorpackage com twitter sdk android core internal scribe import android content Context import io fabric sdk android services events EnabledEventsStrategy import io fabric sdk android services events FilesSender import java util concurrent ScheduledExecutorService class EnabledScribeStrategy extends EnabledEventsStrategy ScribeEvent private final FilesSender filesSender public EnabledScribeStrategy Context context ScheduledExecutorService executorService ScribeFilesManager filesManager ScribeConfig config ScribeFilesSender filesSender super context executorService filesManager this filesSender filesSender configureRollover config sendIntervalSeconds Override public FilesSender getFilesSender return filesSenderpackage hudson util import java io FilterOutputStream import java io IOException import java io OutputStream public class EncodingStream extends FilterOutputStream public EncodingStream OutputStream out super out Override public void write int b throws IOException out write chars charAt b 4 0xF out write chars charAt b 0xF private static final String chars 0123456789ABCDEFpackage jenkins slaves import hudson security AccessControlled import hudson security Permission import hudson slaves SlaveComputer import hudson util Secret import org kohsuke stapler HttpResponse import org kohsuke stapler ResponseImpl import org kohsuke stapler StaplerRequest import org kohsuke stapler StaplerResponse import org kohsuke stapler compression FilterServletOutputStream import javax crypto Cipher import javax crypto SecretKey import javax crypto spec IvParameterSpec import javax crypto spec SecretKeySpec import javax servlet RequestDispatcher import javax servlet ServletException import javax servlet ServletOutputStream import javax servlet http HttpServletResponseWrapper import java io ByteArrayOutputStream import java io IOException import java io PrintWriter import java security GeneralSecurityException import java security SecureRandom public class EncryptedSlaveAgentJnlpFile implements HttpResponse private final AccessControlled it private final String viewName private final String slaveName private final Permission connectPermission public EncryptedSlaveAgentJnlpFile AccessControlled it String viewName String slaveName Permission connectPermission this it it this viewName viewName this slaveName slaveName this connectPermission connectPermission Override public void generateResponse StaplerRequest req StaplerResponse res Object node throws IOException ServletException RequestDispatcher view req getView it viewName if true equals req getParameter encrypt final ByteArrayOutputStream baos new ByteArrayOutputStream StaplerResponse temp new ResponseImpl req getStapler new HttpServletResponseWrapper res Override public ServletOutputStream getOutputStream throws IOException return new FilterServletOutputStream baos Override public PrintWriter getWriter throws IOException throw new IllegalStateException view forward req temp byte iv new byte 128 8 new SecureRandom nextBytes iv byte jnlpMac JnlpSlaveAgentProtocol SLAVE SECRET mac slaveName getBytes UTF 8 SecretKey key new SecretKeySpec jnlpMac 0 128 8 AES byte encrypted try Cipher c Secret getCipher AES CFB8 NoPadding c init Cipher ENCRYPT MODE key new IvParameterSpec iv encrypted c doFinal baos toByteArray catch GeneralSecurityException x throw new IOException x res setContentType application octet stream res getOutputStream write iv res getOutputStream write encrypted else it checkPermission connectPermission view forward req respackage com twitter sdk android core models import com google gson annotations SerializedName import java io Serializable import java util ArrayList import java util Collections import java util List class Entity implements Serializable private static final int START INDEX 0 private static final int END INDEX 1 SerializedName indices public final List Integer indices public Entity int start int end final List Integer temp new ArrayList 2 temp add START INDEX start temp add END INDEX end indices Collections unmodifiableList temp public int getStart return indices get START INDEX public int getEnd return indices get END INDEXpackage hudson util import org apache commons beanutils Converter public class EnumConverter implements Converter public Object convert Class aClass Object object return Enum valueOf aClass object toStringpackage hudson model import hudson Launcher import hudson model listeners RunListener import hudson slaves NodeProperty import hudson tasks BuildWrapper import hudson tasks Builder import hudson EnvVars import java io IOException import java util Map public abstract class Environment public void buildEnvVars Map String String env no op by default public boolean tearDown AbstractBuild build BuildListener listener throws IOException InterruptedException return true public static Environment create final EnvVars envVars return new Environment Override public void buildEnvVars Map String String env env putAll envVarspackage hudson model import hudson EnvVars import hudson model Queue Task import hudson tasks Builder import hudson tasks BuildWrapper public interface EnvironmentContributingAction extends Action void buildEnvVars AbstractBuild build EnvVars envpackage hudson model import hudson EnvVars import hudson Extension import hudson ExtensionList import hudson ExtensionPoint import hudson scm SCM import java io IOException import javax annotation Nonnull public abstract class EnvironmentContributor implements ExtensionPoint public void buildEnvironmentFor Nonnull Run r Nonnull EnvVars envs Nonnull TaskListener listener throws IOException InterruptedException public void buildEnvironmentFor Nonnull Job j Nonnull EnvVars envs Nonnull TaskListener listener throws IOException InterruptedException public static ExtensionList EnvironmentContributor all return ExtensionList lookup EnvironmentContributor class Extension public static class EnvVarsHtml implements RootAction public String getIconFileName return null public String getDisplayName return null public String getUrlName return env vars htmlpackage hudson model import java util AbstractList import java util List public final class EnvironmentList extends AbstractList Environment private final List Environment base public EnvironmentList List Environment base this base base Override public Environment get int index return base get index Override public int size return base size public T extends Environment T get Class T type for Environment e this if type isInstance e return type cast e return null Override public Environment set int index Environment element return base set index element Override public void add int index Environment element base add index element Override public Environment remove int index return base remove indexpackage hudson model import hudson EnvVars import hudson slaves NodeSpecific public interface EnvironmentSpecific T extends EnvironmentSpecific T T forEnvironment EnvVars environmentpackage hudson slaves import hudson EnvVars import hudson Extension import hudson Launcher import hudson model AbstractBuild import hudson model BuildListener import hudson model ComputerSet import hudson model Environment import hudson model Node import hudson model TaskListener import org jenkinsci Symbol import org kohsuke stapler DataBoundConstructor import org kohsuke stapler Stapler import java io IOException import java util Arrays import java util List public class EnvironmentVariablesNodeProperty extends NodeProperty Node private final EnvVars envVars DataBoundConstructor public EnvironmentVariablesNodeProperty List Entry env this envVars toMap env public EnvironmentVariablesNodeProperty Entry env this Arrays asList env public EnvVars getEnvVars return envVars Override public Environment setUp AbstractBuild build Launcher launcher BuildListener listener throws IOException InterruptedException return Environment create envVars Override public void buildEnvVars EnvVars env TaskListener listener throws IOException InterruptedException env putAll envVars Extension Symbol envVars public static class DescriptorImpl extends NodePropertyDescriptor Override public String getDisplayName return Messages EnvironmentVariablesNodeProperty displayName public String getHelpPage yes I know this is a hack ComputerSet object Stapler getCurrentRequest findAncestorObject ComputerSet class if object null we re on a node configuration page show show that help page return help system config nodeEnvironmentVariables html else show the help for the global config page return help system config globalEnvironmentVariables html public static class Entry public String key value DataBoundConstructor public Entry String key String value this key key this value value private static EnvVars toMap List Entry entries EnvVars map new EnvVars if entries null for Entry entry entries map put entry key entry value return mappackage hudson import hudson remoting VirtualChannel import hudson util CaseInsensitiveComparator import hudson util CyclicGraphDetector import hudson util CyclicGraphDetector CycleDetectedException import hudson util VariableResolver import jenkins security MasterToSlaveCallable import java io File import java io IOException import java util ArrayList import java util Collections import java util Comparator import java util List import java util Map import java util Set import java util TreeMap import java util Arrays import java util TreeSet import java util UUID import java util logging Logger public class EnvVars extends TreeMap String String private static Logger LOGGER Logger getLogger EnvVars class getName private Platform platform public EnvVars super CaseInsensitiveComparator INSTANCE public EnvVars Map String String m this putAll m because of the backward compatibility some parts of Jenkins passes EnvVars as Map String String so downcasting is safer if m instanceof EnvVars EnvVars lhs EnvVars m this platform lhs platform public EnvVars EnvVars m this constructor is so that in future we can get rid of the downcasting this Map m public EnvVars String keyValuePairs this if keyValuePairs length 2 0 throw new IllegalArgumentException Arrays asList keyValuePairs toString for int i 0 i keyValuePairs length i 2 put keyValuePairs i keyValuePairs i 1 public void override String key String value if value null value length 0 remove key return int idx key indexOf if idx 0 String realKey key substring 0 idx String v get realKey if v null v value else we might be handling environment variables for a agent that can have different path separator than the master so the following is an attempt to get it right it s still more error prone that I d like char ch platform null File pathSeparatorChar platform pathSeparator v value ch v put realKey v return put key value public EnvVars overrideAll Map String String all for Map Entry String String e all entrySet override e getKey e getValue return this static class OverrideOrderCalculator private static class TraceResolver implements VariableResolver String private final Comparator super String comparator public Set String referredVariables public TraceResolver Comparator super String comparator this comparator comparator clear public void clear referredVariables new TreeSet String comparator public String resolve String name referredVariables add name return private static class VariableReferenceSorter extends CyclicGraphDetector String map from a variable to a set of variables that variable refers private final Map String Set String refereeSetMap public VariableReferenceSorter Map String Set String refereeSetMap this refereeSetMap refereeSetMap Override protected Iterable extends String getEdges String n return variables referred from the variable if refereeSetMap containsKey n there is a case a non existing variable is referred return Collections emptySet return refereeSetMap get n private final Comparator super String comparator private final EnvVars target private final Map String String overrides private Map String Set String refereeSetMap private List String orderedVariableNames public OverrideOrderCalculator EnvVars target Map String String overrides comparator target comparator this target target this overrides overrides scan public List String getOrderedVariableNames return orderedVariableNames Cut the reference to the variable in a cycle private void cutCycleAt String referee List String cycle cycle contains variables in referrer to referee order This should not be negative for the first and last one is same int refererIndex cycle lastIndexOf referee 1 assert refererIndex 0 String referrer cycle get refererIndex boolean removed refereeSetMap get referrer remove referee assert removed LOGGER warning String format Cyclic reference detected s Util join cycle LOGGER warning String format Cut the reference s s referrer referee Cut the variable reference in a cycle private void cutCycle List String cycle if an existing variable is contained in that cycle cut the cycle with that variable existing PATH usr bin overriding PATH1 usr local bin PATH PATH opt something bin PATH1 then consider reference PATH1 PATH can be ignored for String referee cycle if target containsKey referee cutCycleAt referee cycle return if not cut the reference to the first one cutCycleAt cycle get 0 cycle public void scan refereeSetMap new TreeMap String Set String comparator List String extendingVariableNames new ArrayList String TraceResolver resolver new TraceResolver comparator for Map Entry String String entry overrides entrySet if entry getKey indexOf 0 XYZ AAA variables should be always processed in last extendingVariableNames add entry getKey continue resolver clear Util replaceMacro entry getValue resolver Variables directly referred from the current scanning variable Set String refereeSet resolver referredVariables Ignore self reference refereeSet remove entry getKey refereeSetMap put entry getKey refereeSet VariableReferenceSorter sorter while true sorter new VariableReferenceSorter refereeSetMap try sorter run refereeSetMap keySet catch CycleDetectedException e cyclic reference found cut the cycle and retry SuppressWarnings unchecked List String cycle e cycle cutCycle cycle continue break When A refers B the last appearance of B always comes after the last appearance of A List String reversedDuplicatedOrder new ArrayList String sorter getSorted Collections reverse reversedDuplicatedOrder orderedVariableNames new ArrayList String overrides size for String key reversedDuplicatedOrder if overrides containsKey key orderedVariableNames contains key orderedVariableNames add key Collections reverse orderedVariableNames orderedVariableNames addAll extendingVariableNames public EnvVars overrideExpandingAll Map String String all for String key new OverrideOrderCalculator this all getOrderedVariableNames override key expand all get key return this public static void resolve Map String String env for Map Entry String String entry env entrySet entry setValue Util replaceMacro entry getValue env public String get String key String defaultValue String v get key if v null v defaultValue return v Override public String put String key String value if value null throw new IllegalArgumentException Null value not allowed as an environment variable key return super put key value public void putIfNotNull String key String value if value null put key value public void addLine String line int sep line indexOf if sep 0 put line substring 0 sep line substring sep 1 public String expand String s return Util replaceMacro s this public static EnvVars createCookie return new EnvVars HUDSON COOKIE UUID randomUUID toString public static EnvVars getRemote VirtualChannel channel throws IOException InterruptedException if channel null return new EnvVars N A N A return channel call new GetEnvVars private static final class GetEnvVars extends MasterToSlaveCallable EnvVars RuntimeException public EnvVars call return new EnvVars EnvVars masterEnvVars private static final long serialVersionUID 1L public static final Map String String masterEnvVars initMaster private static EnvVars initMaster EnvVars vars new EnvVars System getenv vars platform Platform current if Main isUnitTest Main isDevelopmentMode if unit test is launched with maven debug switch we need to prevent forked Maven processes from seeing it or else they ll hang vars remove MAVEN OPTS return varspackage jenkins slaves systemInfo import hudson Extension import org jenkinsci Symbol Extension ordinal 2 Symbol envVars public class EnvVarsSlaveInfo extends SlaveSystemInfo Override public String getDisplayName return Messages EnvVarsSlaveInfo DisplayNamepackage hudson slaves import hudson model Node public interface EphemeralNode Node asNodepackage jenkins util import java util concurrent CancellationException import java util concurrent ExecutionException import java util concurrent Future import java util concurrent RejectedExecutionHandler import java util concurrent ScheduledThreadPoolExecutor import java util concurrent ThreadFactory import java util concurrent TimeUnit import java util concurrent TimeoutException import java util logging Level import java util logging Logger class ErrorLoggingScheduledThreadPoolExecutor extends ScheduledThreadPoolExecutor private static final Logger LOGGER Logger getLogger ErrorLoggingScheduledThreadPoolExecutor class getName ErrorLoggingScheduledThreadPoolExecutor int corePoolSize super corePoolSize ErrorLoggingScheduledThreadPoolExecutor int corePoolSize ThreadFactory threadFactory super corePoolSize threadFactory ErrorLoggingScheduledThreadPoolExecutor int corePoolSize RejectedExecutionHandler handler super corePoolSize handler ErrorLoggingScheduledThreadPoolExecutor int corePoolSize ThreadFactory threadFactory RejectedExecutionHandler handler super corePoolSize threadFactory handler Override protected void afterExecute Runnable r Throwable t super afterExecute r t if t null r instanceof Future Future f Future r if f isDone TODO super Javadoc does not suggest this but without it we hang in FutureTask awaitDone try f get 0 TimeUnit NANOSECONDS catch TimeoutException x should not happen right catch CancellationException x probably best to ignore this catch ExecutionException x t x getCause catch InterruptedException x Thread currentThread interrupt if t null LOGGER log Level WARNING failure in task not wrapped in SafeTimerTask tpackage hudson util import hudson Functions import org kohsuke stapler StaplerRequest import org kohsuke stapler StaplerResponse import javax servlet ServletException import static javax servlet http HttpServletResponse SC SERVICE UNAVAILABLE import java io IOException public abstract class ErrorObject extends Exception protected ErrorObject protected ErrorObject Throwable cause super cause public String getStackTraceString return Functions printThrowable this public void doDynamic StaplerRequest req StaplerResponse rsp throws IOException ServletException InterruptedException rsp setStatus SC SERVICE UNAVAILABLE req getView this index jelly forward req rsppackage hudson markup import hudson Extension import hudson Util import hudson markup MarkupFormatter import hudson markup MarkupFormatterDescriptor import java io IOException import java io Writer import org jenkinsci Symbol import org kohsuke stapler DataBoundConstructor public class EscapedMarkupFormatter extends MarkupFormatter DataBoundConstructor public EscapedMarkupFormatter Override public void translate String markup Writer output throws IOException output write Util escape markup Extension Symbol plainText public static class DescriptorImpl extends MarkupFormatterDescriptor Override public String getDisplayName return Messages EscapedMarkupFormatter DisplayNamepackage com twitter sdk android core internal scribe import com google gson annotations SerializedName public class EventNamespace SerializedName client public final String client SerializedName page public final String page SerializedName section public final String section SerializedName component public final String component SerializedName element public final String element SerializedName action public final String action public EventNamespace String client String page String section String component String element String action this client client this page page this section section this component component this element element this action action Override public String toString return new StringBuilder append client append client append page append page append section append section append component append component append element append element append action append action toString Override public boolean equals Object o if this o return true if o null getClass o getClass return false final EventNamespace that EventNamespace o if action null action equals that action that action null return false if client null client equals that client that client null return false if component null component equals that component that component null return false if element null element equals that element that element null return false if page null page equals that page that page null return false if section null section equals that section that section null return false return true Override public int hashCode int result client null client hashCode 0 result 31 result page null page hashCode 0 result 31 result section null section hashCode 0 result 31 result component null component hashCode 0 result 31 result element null element hashCode 0 result 31 result action null action hashCode 0 return result public static class Builder private String client private String page private String section private String component private String element private String action public Builder setClient String client this client client return this public Builder setPage String page this page page return this public Builder setSection String section this section section return this public Builder setComponent String component this component component return this public Builder setElement String element this element element return this public Builder setAction String action this action action return this public EventNamespace builder return new EventNamespace client page section component element actionpackage com zxy recovery test import android content Context import android support test InstrumentationRegistry import android support test runner AndroidJUnit4 import org junit Test import org junit runner RunWith import static org junit Assert RunWith AndroidJUnit4 class public class ExampleInstrumentedTest Test public void useAppContext throws Exception Context of the app under test Context appContext InstrumentationRegistry getTargetContext assertEquals com zxy recovery test appContext getPackageNamepackage hudson util import java util concurrent ThreadFactory import java util concurrent Executors import java util logging Logger import java util logging Level public class ExceptionCatchingThreadFactory implements ThreadFactory Thread UncaughtExceptionHandler private final ThreadFactory core public ExceptionCatchingThreadFactory this Executors defaultThreadFactory public ExceptionCatchingThreadFactory ThreadFactory core this core core public Thread newThread Runnable r Thread t core newThread r t setUncaughtExceptionHandler this return t public void uncaughtException Thread t Throwable e LOGGER log Level WARNING Thread t getName terminated unexpectedly e private static final Logger LOGGER Logger getLogger ExceptionCatchingThreadFactory class getNamepackage jenkins security import org acegisecurity AccessDeniedException import org acegisecurity AcegiSecurityException import org acegisecurity AuthenticationException import org acegisecurity AuthenticationTrustResolver import org acegisecurity AuthenticationTrustResolverImpl import org acegisecurity InsufficientAuthenticationException import org acegisecurity context SecurityContextHolder import org acegisecurity ui AbstractProcessingFilter import org acegisecurity ui AccessDeniedHandler import org acegisecurity ui AccessDeniedHandlerImpl import org acegisecurity ui AuthenticationEntryPoint import org acegisecurity ui savedrequest SavedRequest import org acegisecurity util PortResolver import org acegisecurity util PortResolverImpl import org springframework beans factory InitializingBean import org springframework util Assert import javax servlet Filter import javax servlet FilterChain import javax servlet FilterConfig import javax servlet ServletException import javax servlet ServletRequest import javax servlet ServletResponse import javax servlet http HttpServletRequest import javax servlet http HttpServletResponse import java io IOException import java util logging Level import java util logging Logger public class ExceptionTranslationFilter implements Filter InitializingBean Static fields initializers private static final Logger LOGGER Logger getLogger ExceptionTranslationFilter class getName Instance fields private AccessDeniedHandler accessDeniedHandler new AccessDeniedHandlerImpl private AuthenticationEntryPoint authenticationEntryPoint private AuthenticationTrustResolver authenticationTrustResolver new AuthenticationTrustResolverImpl private PortResolver portResolver new PortResolverImpl private boolean createSessionAllowed true Methods public void afterPropertiesSet throws Exception Assert notNull authenticationEntryPoint authenticationEntryPoint must be specified Assert notNull portResolver portResolver must be specified Assert notNull authenticationTrustResolver authenticationTrustResolver must be specified public void doFilter ServletRequest request ServletResponse response FilterChain chain throws IOException ServletException if request instanceof HttpServletRequest throw new ServletException HttpServletRequest required if response instanceof HttpServletResponse throw new ServletException HttpServletResponse required try chain doFilter request response LOGGER finer Chain processed normally catch AuthenticationException ex handleException request response chain ex catch AccessDeniedException ex handleException request response chain ex catch ServletException ex if ex getRootCause instanceof AuthenticationException ex getRootCause instanceof AccessDeniedException handleException request response chain AcegiSecurityException ex getRootCause else throw ex catch IOException ex throw ex public AuthenticationEntryPoint getAuthenticationEntryPoint return authenticationEntryPoint public AuthenticationTrustResolver getAuthenticationTrustResolver return authenticationTrustResolver public PortResolver getPortResolver return portResolver private void handleException ServletRequest request ServletResponse response FilterChain chain AcegiSecurityException exception throws IOException ServletException if exception instanceof AuthenticationException LOGGER log Level FINER Authentication exception occurred redirecting to authentication entry point exception sendStartAuthentication request response chain AuthenticationException exception else if exception instanceof AccessDeniedException if authenticationTrustResolver isAnonymous SecurityContextHolder getContext getAuthentication LOGGER log Level FINER Access is denied user is anonymous redirecting to authentication entry point exception sendStartAuthentication request response chain new InsufficientAuthenticationException Full authentication is required to access this resource exception else LOGGER log Level FINER Access is denied user is not anonymous delegating to AccessDeniedHandler exception accessDeniedHandler handle request response AccessDeniedException exception public boolean isCreateSessionAllowed return createSessionAllowed protected void sendStartAuthentication ServletRequest request ServletResponse response FilterChain chain AuthenticationException reason throws ServletException IOException HttpServletRequest httpRequest HttpServletRequest request SavedRequest savedRequest new SavedRequest httpRequest portResolver LOGGER finer Authentication entry point being called SavedRequest added to Session savedRequest if createSessionAllowed Store the HTTP request itself Used by AbstractProcessingFilter for redirection after successful authentication SEC 29 httpRequest getSession setAttribute AbstractProcessingFilter ACEGI SAVED REQUEST KEY savedRequest SEC 112 Clear the SecurityContextHolder s Authentication as the existing Authentication is no longer considered valid SecurityContextHolder getContext setAuthentication null authenticationEntryPoint commence httpRequest response reason public void setAccessDeniedHandler AccessDeniedHandler accessDeniedHandler Assert notNull accessDeniedHandler AccessDeniedHandler required this accessDeniedHandler accessDeniedHandler public void setAuthenticationEntryPoint AuthenticationEntryPoint authenticationEntryPoint this authenticationEntryPoint authenticationEntryPoint public void setAuthenticationTrustResolver AuthenticationTrustResolver authenticationTrustResolver this authenticationTrustResolver authenticationTrustResolver public void setCreateSessionAllowed boolean createSessionAllowed this createSessionAllowed createSessionAllowed public void setPortResolver PortResolver portResolver this portResolver portResolver public void init FilterConfig filterConfig throws ServletException public void destroypackage hudson model queue import hudson model Queue Executable import java lang reflect InvocationTargetException import java lang reflect Method import javax annotation CheckForNull import javax annotation Nonnull public class Executables public static Nonnull SubTask getParentOf Executable e try return e getParent catch AbstractMethodError try Method m e getClass getMethod getParent m setAccessible true return SubTask m invoke e catch IllegalAccessException x throw Error new IllegalAccessError initCause x catch NoSuchMethodException x throw Error new NoSuchMethodError initCause x catch InvocationTargetException x Throwable y x getTargetException if y instanceof Error throw Error y if y instanceof RuntimeException throw RuntimeException y throw new Error x public static long getEstimatedDurationFor CheckForNull Executable e if e null return 1 try return e getEstimatedDuration catch AbstractMethodError error return e getParent getEstimatedDurationpackage hudson model import hudson FilePath import hudson Util import hudson model Queue Executable import hudson model queue Executables import hudson model queue SubTask import hudson model queue Tasks import hudson model queue WorkUnit import hudson security ACL import hudson util InterceptingProxy import hudson util TimeUnit2 import jenkins model CauseOfInterruption import jenkins model CauseOfInterruption UserInterruption import jenkins model InterruptedBuildAction import jenkins model Jenkins import org acegisecurity Authentication import org kohsuke stapler HttpResponse import org kohsuke stapler HttpResponses import org kohsuke stapler StaplerRequest import org kohsuke stapler StaplerResponse import org kohsuke stapler export Exported import org kohsuke stapler export ExportedBean import org kohsuke stapler interceptor RequirePOST import javax annotation concurrent GuardedBy import javax servlet ServletException import java io IOException import java io PrintWriter import java io StringWriter import java lang reflect Method import java util ArrayList import java util Arrays import java util Collections import java util List import java util Vector import java util concurrent locks ReadWriteLock import java util concurrent locks ReentrantReadWriteLock import java util logging Level import java util logging Logger import static hudson model queue Executables import java util Collection import static java util logging Level import javax annotation CheckForNull import javax annotation Nonnull import jenkins model queue AsynchronousExecution import org kohsuke accmod Restricted import org kohsuke accmod restrictions NoExternalUse ExportedBean public class Executor extends Thread implements ModelObject protected final Nonnull Computer owner private final Queue queue private final ReadWriteLock lock new ReentrantReadWriteLock GuardedBy lock private long startTime private final long creationTime System currentTimeMillis private int number GuardedBy lock private Queue Executable executable GuardedBy lock private AsynchronousExecution asynchronousExecution GuardedBy lock private WorkUnit workUnit GuardedBy lock private boolean started GuardedBy lock private Result interruptStatus GuardedBy lock private final List CauseOfInterruption causes new Vector CauseOfInterruption public Executor Nonnull Computer owner int n super Executor n for owner getDisplayName this owner owner this queue Jenkins getInstance getQueue this number n Override public void interrupt if Thread currentThread this If you catch an InterruptedException the correct options are limited to one of two choices 1 Propagate the exception 2 Restore the Thread currentThread interrupted flag The JVM locking support assumes such behaviour Evil Jenkins overrides the interrupt method so that when a different thread interrupts this thread we abort the build but that causes JENKINS 28690 style deadlocks when the correctly written code does try some long running thing catch InterruptedException e some tidy up restore interrupted flag Thread currentThread interrupted What about why we do not set the Result ABORTED on this branch That is a good question to ask the answer is that the only time a thread should be restoring its own interrupted flag is when that thread has already been interrupted by another thread as such we should assume that the result has already been applied If that assumption were incorrect then the Run execute s catch InterruptedException block will either set the result or have been escaped in which case the result of the run has been sealed anyway so it does not matter super interrupt else interrupt Result ABORTED void interruptForShutdown interrupt Result ABORTED true public void interrupt Result result interrupt result false private void interrupt Result result boolean forShutdown Authentication a Jenkins getAuthentication if a ACL SYSTEM interrupt result forShutdown new CauseOfInterruption 0 else worth recording who did it avoid using User get to avoid deadlock interrupt result forShutdown new UserInterruption a getName public void interrupt Result result CauseOfInterruption causes interrupt result false causes private void interrupt Result result boolean forShutdown CauseOfInterruption causes if LOGGER isLoggable FINE LOGGER log FINE String format s is interrupted s s getDisplayName result Util join Arrays asList causes new InterruptedException lock writeLock lock try if started not yet started so simply dispose this owner removeExecutor this return interruptStatus result for CauseOfInterruption c causes if this causes contains c this causes add c if asynchronousExecution null asynchronousExecution interrupt forShutdown else super interrupt finally lock writeLock unlock public Result abortResult this method is almost always called as a result of the current thread being interrupted as a result we need to clean the interrupt flag so that the lock s lock method doesn t get confused and think it was interrupted while awaiting the lock Thread interrupted we need to use a write lock as we may be repeatedly interrupted while processing and we need the same lock as used in void interrupt Result boolean CauseOfInterruption JENKINS 28690 lock writeLock lock try Result r interruptStatus if r null r Result ABORTED this is when we programmatically throw InterruptedException instead of calling the interrupt method return r finally lock writeLock unlock public void recordCauseOfInterruption Run build TaskListener listener List CauseOfInterruption r atomically get clear causes lock writeLock lock try if causes isEmpty return r new ArrayList CauseOfInterruption causes causes clear finally lock writeLock unlock build addAction new InterruptedBuildAction r for CauseOfInterruption c r c print listener private void resetWorkUnit String reason StringWriter writer new StringWriter try PrintWriter pw new PrintWriter writer pw printf s grabbed s from queue but s s getName workUnit owner getDisplayName reason if owner getTerminatedBy isEmpty pw print No termination trace available else pw println Termination trace follows for Computer TerminationRequest request owner getTerminatedBy request printStackTrace pw LOGGER log WARNING writer toString lock writeLock lock try if executable null throw new IllegalStateException Cannot reset the work unit after the executable has been created workUnit null finally lock writeLock unlock Override public void run if owner isOnline resetWorkUnit went off line before the task s worker thread started owner removeExecutor this queue scheduleMaintenance return if owner getNode null resetWorkUnit was removed before the task s worker thread started owner removeExecutor this queue scheduleMaintenance return final WorkUnit workUnit lock writeLock lock try startTime System currentTimeMillis workUnit this workUnit finally lock writeLock unlock ACL impersonate ACL SYSTEM try SubTask task transition from idle to building perform this state change as an atomic operation wrt other queue operations task Queue withLock new java util concurrent Callable SubTask Override public SubTask call throws Exception if owner isOnline resetWorkUnit went off line before the task s worker thread was ready to execute return null if owner getNode null resetWorkUnit was removed before the task s worker thread was ready to execute return null after this point we cannot unwind the assignment of the work unit if the owner is removed or goes off line then the build will just have to fail workUnit setExecutor Executor this queue onStartExecuting Executor this if LOGGER isLoggable FINE LOGGER log FINE getName grabbed workUnit from queue SubTask task workUnit work Executable executable task createExecutable lock writeLock lock try Executor this executable executable finally lock writeLock unlock workUnit setExecutable executable return task Executable executable lock readLock lock try if this workUnit null we called resetWorkUnit so bail Outer finally will remove this and schedule queue maintenance return executable this executable finally lock readLock unlock if LOGGER isLoggable FINE LOGGER log FINE getName is going to execute executable Throwable problems null try workUnit context synchronizeStart this code handles the behavior of null Executables returned by tasks In such case Jenkins starts the workUnit in order to report results to console outputs if executable null throw new Error The null Executable has been created for workUnit The task cannot be executed if executable instanceof Actionable for Action action workUnit context actions Actionable executable addAction action ACL impersonate workUnit context item authenticate setName getName executing executable toString if LOGGER isLoggable FINE LOGGER log FINE getName is now executing executable queue execute executable task catch AsynchronousExecution x lock writeLock lock try x setExecutor this this asynchronousExecution x finally lock writeLock unlock catch Throwable e problems e finally boolean needFinish1 lock readLock lock try needFinish1 asynchronousExecution null finally lock readLock unlock if needFinish1 finish1 problems catch InterruptedException e LOGGER log FINE getName interrupted e die peacefully catch Exception Error e LOGGER log SEVERE Unexpected executor death e finally if asynchronousExecution null finish2 private void finish1 CheckForNull Throwable problems if problems null for some reason the executor died this is really a bug in the code but we don t want the executor to die so just leave some info and go on to build other things LOGGER log Level SEVERE Executor threw an exception problems workUnit context abort problems long time System currentTimeMillis startTime LOGGER log FINE 0 completed 1 in 2 ms new Object getName executable time try workUnit context synchronizeEnd this executable problems time catch InterruptedException e workUnit context abort e finally workUnit setExecutor null private void finish2 for RuntimeException e1 owner getTerminatedBy LOGGER log Level FINE String format s termination trace getName e1 owner removeExecutor this if this instanceof OneOffExecutor owner remove OneOffExecutor this queue scheduleMaintenance Restricted NoExternalUse class public void completedAsynchronous CheckForNull Throwable error try finish1 error finally finish2 asynchronousExecution null Exported public CheckForNull Queue Executable getCurrentExecutable lock readLock lock try return executable finally lock readLock unlock public Nonnull Collection CauseOfInterruption getCausesOfInterruption return Collections unmodifiableCollection causes Exported public WorkUnit getCurrentWorkUnit lock readLock lock try return workUnit finally lock readLock unlock public FilePath getCurrentWorkspace lock readLock lock try if executable null return null if executable instanceof AbstractBuild AbstractBuild ab AbstractBuild executable return ab getWorkspace return null finally lock readLock unlock public String getDisplayName return Executor getNumber Exported public int getNumber return number Exported public boolean isIdle lock readLock lock try return workUnit null executable null finally lock readLock unlock public boolean isBusy lock readLock lock try return workUnit null executable null finally lock readLock unlock public boolean isActive lock readLock lock try return started asynchronousExecution null isAlive finally lock readLock unlock public CheckForNull AsynchronousExecution getAsynchronousExecution lock readLock lock try return asynchronousExecution finally lock readLock unlock public boolean isDisplayCell AsynchronousExecution asynchronousExecution getAsynchronousExecution return asynchronousExecution null asynchronousExecution displayCell public boolean isParking lock readLock lock try return started finally lock readLock unlock Deprecated public CheckForNull Throwable getCauseOfDeath return null Exported public int getProgress long d lock readLock lock try if executable null return 1 d Executables getEstimatedDurationFor executable finally lock readLock unlock if d 0 return 1 int num int getElapsedTime 100 d if num 100 num 99 return num Exported public boolean isLikelyStuck long d long elapsed lock readLock lock try if executable null return false elapsed getElapsedTime d Executables getEstimatedDurationFor executable finally lock readLock unlock if d 0 if it s taking 10 times longer than ETA consider it stuck return d 10 elapsed else if no ETA is available a build taking longer than a day is considered stuck return TimeUnit2 MILLISECONDS toHours elapsed 24 public long getElapsedTime lock readLock lock try return System currentTimeMillis startTime finally lock readLock unlock public long getTimeSpentInQueue lock readLock lock try return startTime workUnit context item buildableStartMilliseconds finally lock readLock unlock public String getTimestampString return Util getPastTimeString getElapsedTime public String getEstimatedRemainingTime long d lock readLock lock try if executable null return Messages Executor NotAvailable d Executables getEstimatedDurationFor executable finally lock readLock unlock if d 0 return Messages Executor NotAvailable long eta d getElapsedTime if eta 0 return Messages Executor NotAvailable return Util getTimeSpanString eta public long getEstimatedRemainingTimeMillis long d lock readLock lock try if executable null return 1 d Executables getEstimatedDurationFor executable finally lock readLock unlock if d 0 return 1 long eta d getElapsedTime if eta 0 return 1 return eta Override public void start throw new UnsupportedOperationException void start WorkUnit task lock writeLock lock try this workUnit task super start started true finally lock writeLock unlock RequirePOST Deprecated public void doStop StaplerRequest req StaplerResponse rsp throws IOException ServletException doStop generateResponse req rsp this RequirePOST public HttpResponse doStop lock writeLock lock need write lock as interrupt will change the field try if executable null Tasks getOwnerTaskOf getParentOf executable checkAbortPermission interrupt finally lock writeLock unlock return HttpResponses forwardToPreviousPage Deprecated public HttpResponse doYank return HttpResponses redirectViaContextPath public boolean hasStopPermission lock readLock lock try return executable null Tasks getOwnerTaskOf getParentOf executable hasAbortPermission finally lock readLock unlock public Nonnull Computer getOwner return owner public long getIdleStartMilliseconds lock readLock lock try if isIdle return Math max creationTime owner getConnectTime else return Math max startTime Math max 0 Executables getEstimatedDurationFor executable System currentTimeMillis 15000 finally lock readLock unlock public Api getApi return new Api this public T T newImpersonatingProxy Class T type T core return new InterceptingProxy protected Object call Object o Method m Object args throws Throwable final Executor old IMPERSONATION get IMPERSONATION set Executor this try return m invoke o args finally IMPERSONATION set old wrap type core public static CheckForNull Executor currentExecutor Thread t Thread currentThread if t instanceof Executor return Executor t return IMPERSONATION get CheckForNull public static Executor of Executable executable Jenkins jenkins Jenkins getInstanceOrNull TODO confirm safe to assume non null and use getInstance if jenkins null return null for Computer computer jenkins getComputers for Executor executor computer getExecutors if executor getCurrentExecutable executable return executor for Executor executor computer getOneOffExecutors if executor getCurrentExecutable executable return executor return null Deprecated public static long getEstimatedDurationFor Executable e return Executables getEstimatedDurationFor e private static final ThreadLocal Executor IMPERSONATION new ThreadLocal Executor private static final Logger LOGGER Logger getLogger Executor class getNamepackage hudson model public interface ExecutorListener void taskAccepted Executor executor Queue Task task void taskCompleted Executor executor Queue Task task long durationMS void taskCompletedWithProblems Executor executor Queue Task task long durationMS Throwable problemspackage jenkins widgets import hudson Extension import hudson widgets Widget import jenkins model Jenkins import org jenkinsci Symbol Extension ordinal 100 Symbol executors historically this was above normal widgets and below BuildQueueWidget public class ExecutorsWidget extends Widgetpackage hudson console import hudson Extension import hudson MarkupText import java io IOException import java util logging Level import java util logging Logger public class ExpandableDetailsNote extends ConsoleNote private final String caption private final String html public ExpandableDetailsNote String caption String html this caption caption this html html Override public ConsoleAnnotator annotate Object context MarkupText text int charPos text addMarkup charPos input type button value caption class reveal expandable detail div class expandable detail html div return null public static String encodeTo String buttonCaption String html try return new ExpandableDetailsNote buttonCaption html encode catch IOException e impossible but don t make this a fatal problem LOGGER log Level WARNING Failed to serialize HyperlinkNote class e return Extension public static final class DescriptorImpl extends ConsoleAnnotationDescriptor public String getDisplayName return Expandable details private static final Logger LOGGER Logger getLogger ExpandableDetailsNote class getNamepackage hudson import org acegisecurity AcegiSecurityException import org apache commons jelly JellyContext import org apache commons jelly JellyException import org apache commons jelly expression Expression import org apache commons jelly expression ExpressionFactory import org apache commons jelly expression ExpressionSupport import org apache commons jexl JexlContext import java util Collection import java util Map import java util Set import java util logging Level import java util logging Logger import org kohsuke stapler Stapler import org kohsuke stapler StaplerRequest final class ExpressionFactory2 implements ExpressionFactory public Expression createExpression String text throws JellyException try return new JexlExpression org apache commons jexl ExpressionFactory createExpression text catch Exception e throw new JellyException Unable to create expression text e static final class JexlExpression extends ExpressionSupport private org apache commons jexl Expression expression public JexlExpression org apache commons jexl Expression expression this expression expression Override public String toString return super toString expression getExpression Expression interface public String getExpressionText return expression getExpression public Object evaluate JellyContext context try CURRENT CONTEXT set context JexlContext jexlContext new JellyJexlContext context return expression evaluate jexlContext catch AcegiSecurityException e let the security exception pass through throw e catch Exception e StaplerRequest currentRequest Stapler getCurrentRequest LOGGER log Level WARNING Caught exception evaluating expression in currentRequest null currentRequest getOriginalRequestURI Reason e e return null finally CURRENT CONTEXT set null private static final Logger LOGGER Logger getLogger JexlExpression class getName static final class JellyJexlContext implements JexlContext private Map vars JellyJexlContext JellyContext context this vars new JellyMap context public void setVars Map vars this vars clear this vars putAll vars public Map getVars return this vars static final class JellyMap implements Map private JellyContext context JellyMap JellyContext context this context context public Object get Object key return context getVariable String key public void clear not implemented public boolean containsKey Object key return get key null public boolean containsValue Object value return false public Set entrySet return null public boolean isEmpty return false public Set keySet return null public Object put Object key Object value return null public void putAll Map t not implemented public Object remove Object key return null public int size return 1 public Collection values return null protected static final ThreadLocal JellyContext CURRENT CONTEXT new ThreadLocal JellyContextpackage hudson import jenkins YesNoMaybe import net java sezpoz Indexable import java lang annotation Documented import java lang annotation Retention import java lang annotation Target import static java lang annotation ElementType import static java lang annotation RetentionPolicy RUNTIME import static jenkins YesNoMaybe MAYBE Indexable Retention RUNTIME Target TYPE FIELD METHOD Documented public interface Extension double ordinal default 0 boolean optional default false YesNoMaybe dynamicLoadable default MAYBEpackage hudson import hudson model Describable import hudson model Descriptor import java util logging Level import java util logging Logger import jenkins ExtensionFilter public class ExtensionComponent T implements Comparable ExtensionComponent T private static final Logger LOG Logger getLogger ExtensionComponent class getName private final T instance private final double ordinal public ExtensionComponent T instance double ordinal this instance instance this ordinal ordinal public ExtensionComponent T instance Extension annotation this instance annotation ordinal public ExtensionComponent T instance this instance 0 public double ordinal return ordinal public T getInstance return instance public boolean isDescriptorOf Class extends Describable c return instance instanceof Descriptor Descriptor instance isSubTypeOf c public int compareTo ExtensionComponent T that double a this ordinal double b that ordinal if a b return 1 if a b return 1 make the order bit more deterministic among extensions of the same ordinal if this instance instanceof Descriptor that instance instanceof Descriptor try return Util fixNull Descriptor this instance getDisplayName compareTo Util fixNull Descriptor that instance getDisplayName catch RuntimeException x LOG log Level WARNING null x catch LinkageError x LOG log Level WARNING null x return this instance getClass getName compareTo that instance getClass getNamepackage jenkins import com google common collect Lists import hudson ExtensionComponent import hudson ExtensionFinder import hudson ExtensionPoint import hudson model Descriptor import hudson model Hudson import java util Arrays import java util Collection import java util Collections import java util List public abstract class ExtensionComponentSet public abstract T Collection ExtensionComponent T find Class T type public final ExtensionComponentSet filtered final ExtensionComponentSet base this return new ExtensionComponentSet Override public T Collection ExtensionComponent T find Class T type List ExtensionComponent T a Lists newArrayList for ExtensionComponent T c base find type if ExtensionFilter isAllowed type c a add c return a public static final ExtensionComponentSet EMPTY new ExtensionComponentSet Override public T Collection ExtensionComponent T find Class T type return Collections emptyList public static ExtensionComponentSet union final Collection extends ExtensionComponentSet base return new ExtensionComponentSet Override public T Collection ExtensionComponent T find Class T type List ExtensionComponent T r Lists newArrayList for ExtensionComponentSet d base r addAll d find type return r public static ExtensionComponentSet union ExtensionComponentSet members return union Arrays asList members public static ExtensionComponentSet allOf final ExtensionFinder f return new ExtensionComponentSet Override public T Collection ExtensionComponent T find Class T type return f find type Hudson getInstancepackage jenkins import hudson ExtensionComponent import hudson ExtensionFinder import hudson ExtensionList import hudson ExtensionPoint import hudson model AdministrativeMonitor import hudson model Describable import hudson model Descriptor import hudson model DescriptorVisibilityFilter public abstract class ExtensionFilter implements ExtensionPoint public abstract T boolean allows Class T type ExtensionComponent T component public static T boolean isAllowed Class T type ExtensionComponent T component to avoid infinite recursion those extension points are handled differently if type ExtensionFilter class type ExtensionFinder class return true for ExtensionFilter f all if f allows type component return false return true public static ExtensionList ExtensionFilter all return ExtensionList lookup ExtensionFilter classpackage hudson import com google common collect Iterables import com google common collect Lists import com google common collect Maps import com google inject AbstractModule import com google inject Binding import com google inject Guice import com google inject Injector import com google inject Key import com google inject Module import com google inject Provider import com google inject Scope import com google inject Scopes import com google inject name Names import com google common collect ImmutableList import hudson init InitMilestone import hudson model Descriptor import hudson model Hudson import jenkins ExtensionComponentSet import jenkins ExtensionFilter import jenkins ExtensionRefreshException import jenkins ProxyInjector import jenkins model Jenkins import net java sezpoz Index import net java sezpoz IndexItem import org kohsuke accmod Restricted import org kohsuke accmod restrictions NoExternalUse import java lang annotation Annotation import java util Collections import java util HashMap import java util Map import java util Map Entry import java util logging Logger import java util logging Level import java util List import java util ArrayList import java util Collection import java lang reflect AnnotatedElement import java lang reflect Field import java lang reflect Method public abstract class ExtensionFinder implements ExtensionPoint Restricted NoExternalUse class Deprecated public T Collection T findExtensions Class T type Hudson hudson return Collections emptyList public boolean isRefreshable try return getClass getMethod refresh getDeclaringClass ExtensionFinder class catch NoSuchMethodException e return false public abstract ExtensionComponentSet refresh throws ExtensionRefreshException public abstract T Collection ExtensionComponent T find Class T type Hudson jenkins Deprecated public T Collection ExtensionComponent T find Class T type Hudson hudson return find type hudson public void scout Class extensionType Hudson hudson Extension public static final class DefaultGuiceExtensionAnnotation extends GuiceExtensionAnnotation Extension public DefaultGuiceExtensionAnnotation super Extension class Override protected boolean isOptional Extension annotation return annotation optional Override protected double getOrdinal Extension annotation return annotation ordinal Override protected boolean isActive AnnotatedElement e return true public static abstract class GuiceExtensionAnnotation T extends Annotation public final Class T annotationType protected GuiceExtensionAnnotation Class T annotationType this annotationType annotationType protected abstract double getOrdinal T annotation protected abstract boolean isActive AnnotatedElement e protected abstract boolean isOptional T annotation Extension public static class GuiceFinder extends ExtensionFinder private volatile Injector container private List IndexItem Object sezpozIndex private final Map Key Annotation annotations new HashMap private final Sezpoz moduleFinder new Sezpoz private Map Class extends Annotation GuiceExtensionAnnotation extensionAnnotations Maps newHashMap public GuiceFinder for ExtensionComponent GuiceExtensionAnnotation ec moduleFinder find GuiceExtensionAnnotation class Hudson getInstance GuiceExtensionAnnotation gea ec getInstance extensionAnnotations put gea annotationType gea sezpozIndex loadSezpozIndices Jenkins getInstance getPluginManager uberClassLoader List Module modules new ArrayList modules add new AbstractModule Override protected void configure Jenkins j Jenkins getInstance bind Jenkins class toInstance j bind PluginManager class toInstance j getPluginManager modules add new SezpozModule sezpozIndex for ExtensionComponent Module ec moduleFinder find Module class Hudson getInstance modules add ec getInstance try container Guice createInjector modules catch Throwable e LOGGER log Level SEVERE Failed to create Guice container from all the plugins e failing to load all bindings are disastrous so recover by creating minimum that works by just including the core container Guice createInjector new SezpozModule loadSezpozIndices Jenkins class getClassLoader expose Injector via lookup mechanism for interop with non Guice clients Jenkins getInstance lookup set Injector class new ProxyInjector protected Injector resolve return getContainer private ImmutableList IndexItem Object loadSezpozIndices ClassLoader classLoader List IndexItem Object indices Lists newArrayList for GuiceExtensionAnnotation gea extensionAnnotations values Iterables addAll indices Index load gea annotationType Object class classLoader return ImmutableList copyOf indices public Injector getContainer return container Override public synchronized ExtensionComponentSet refresh throws ExtensionRefreshException figure out newly discovered sezpoz components List IndexItem Object delta Lists newArrayList for Class extends Annotation annotationType extensionAnnotations keySet delta addAll Sezpoz listDelta annotationType sezpozIndex List IndexItem Object l Lists newArrayList sezpozIndex l addAll delta sezpozIndex l List Module modules new ArrayList modules add new SezpozModule delta for ExtensionComponent Module ec moduleFinder refresh find Module class modules add ec getInstance try final Injector child container createChildInjector modules container child return new ExtensionComponentSet Override public T Collection ExtensionComponent T find Class T type List ExtensionComponent T result new ArrayList find type result child return result catch Throwable e LOGGER log Level SEVERE Failed to create Guice container from newly added plugins e throw new ExtensionRefreshException e private Object instantiate IndexItem Object item try return item instance catch LinkageError Exception e sometimes the instantiation fails in an indirect classloading failure which results in a LinkageError LOGGER log isOptional item annotation Level FINE Level WARNING Failed to load item className e return null private boolean isOptional Annotation annotation GuiceExtensionAnnotation gea extensionAnnotations get annotation annotationType return gea isOptional annotation private boolean isActive Annotation annotation AnnotatedElement e GuiceExtensionAnnotation gea extensionAnnotations get annotation annotationType return gea isActive e public U Collection ExtensionComponent U find Class U type Hudson jenkins the find method contract requires us to traverse all known components List ExtensionComponent U result new ArrayList for Injector i container i null i i getParent find type result i return result private U void find Class U type List ExtensionComponent U result Injector container for Entry Key Binding e container getBindings entrySet if type isAssignableFrom e getKey getTypeLiteral getRawType Annotation a annotations get e getKey Object o e getValue getProvider get if o null GuiceExtensionAnnotation gea a null extensionAnnotations get a annotationType null result add new ExtensionComponent type cast o gea null gea getOrdinal a 0 Override public void scout Class extensionType Hudson hudson public static final Scope FAULT TOLERANT SCOPE new FaultTolerantScope true private static final Scope QUIET FAULT TOLERANT SCOPE new FaultTolerantScope false private static final class FaultTolerantScope implements Scope private final boolean verbose FaultTolerantScope boolean verbose this verbose verbose public T Provider T scope final Key T key final Provider T unscoped final Provider T base Scopes SINGLETON scope key unscoped return new Provider T public T get try return base get catch Exception LinkageError e error key e return null void error Key T key Throwable x if verbose LOGGER log Level WARNING Failed to instantiate key skipping this component x else LOGGER log Level INFO Failed to instantiate optional component 0 skipping key getTypeLiteral LOGGER log Level FINE key toString x private static final Logger LOGGER Logger getLogger GuiceFinder class getName private class SezpozModule extends AbstractModule private final List IndexItem Object index public SezpozModule List IndexItem Object index this index index private void resolve Class c try c getGenericSuperclass c getGenericInterfaces ClassLoader ecl c getClassLoader Method m ClassLoader class getDeclaredMethod resolveClass Class class m setAccessible true m invoke ecl c c getConstructors c getMethods for Field f c getFields if f getAnnotation javax inject Inject class null f getAnnotation com google inject Inject class null resolve f getType LOGGER log Level FINER 0 looks OK c while c Object class c getGenericSuperclass c c getSuperclass catch Exception x throw LinkageError new LinkageError Failed to resolve c initCause x SuppressWarnings unchecked ChainOfInstanceofChecks Override protected void configure for final IndexItem Object item index boolean optional isOptional item annotation try AnnotatedElement e item element Annotation a item annotation if isActive a e continue Scope scope optional QUIET FAULT TOLERANT SCOPE FAULT TOLERANT SCOPE if e instanceof Class Key key Key get Class e resolve Class e annotations put key a bind key in scope else Class extType if e instanceof Field extType Field e getType else if e instanceof Method extType Method e getReturnType else throw new AssertionError resolve extType make unique key because Guice wants that Key key Key get extType Names named item className item memberName annotations put key a bind key toProvider new Provider public Object get return instantiate item in scope catch Exception LinkageError e sometimes the instantiation fails in an indirect classloading failure which results in a LinkageError LOGGER log optional Level FINE Level WARNING Failed to load item className e public static final class Sezpoz extends ExtensionFinder private volatile List IndexItem Extension Object indices private List IndexItem Extension Object getIndices this method cannot be synchronized because of a dead lock possibility in the following order of events 1 thread X can start listing indices locking this object SZ 2 thread Y starts loading a class locking a classloader CL 3 thread X needs to load a class now blocked on CL 4 thread Y decides to load extensions now blocked on SZ 5 dead lock if indices null ClassLoader cl Jenkins getInstance getPluginManager uberClassLoader indices ImmutableList copyOf Index load Extension class Object class cl return indices Override public synchronized ExtensionComponentSet refresh final List IndexItem Extension Object old indices if old null return ExtensionComponentSet EMPTY we haven t loaded anything final List IndexItem Extension Object delta listDelta Extension class old List IndexItem Extension Object r Lists newArrayList old r addAll delta indices ImmutableList copyOf r return new ExtensionComponentSet Override public T Collection ExtensionComponent T find Class T type return find type delta static T extends Annotation List IndexItem T Object listDelta Class T annotationType List extends IndexItem Object old list up newly discovered components final List IndexItem T Object delta Lists newArrayList ClassLoader cl Jenkins getInstance getPluginManager uberClassLoader for IndexItem T Object ii Index load annotationType Object class cl if old contains ii delta add ii return delta public T Collection ExtensionComponent T find Class T type Hudson jenkins return find type getIndices private T Collection ExtensionComponent T find Class T type List IndexItem Extension Object indices List ExtensionComponent T result new ArrayList for IndexItem Extension Object item indices try AnnotatedElement e item element Class extType if e instanceof Class extType Class e else if e instanceof Field extType Field e getType else if e instanceof Method extType Method e getReturnType else throw new AssertionError if type isAssignableFrom extType Object instance item instance if instance null result add new ExtensionComponent type cast instance item annotation catch LinkageError Exception e sometimes the instantiation fails in an indirect classloading failure which results in a LinkageError LOGGER log logLevel item Failed to load item className e return result Override public void scout Class extensionType Hudson hudson for IndexItem Extension Object item getIndices try we might end up having multiple threads concurrently calling into element but we can t synchronize this if we do the one thread that s supposed to load a class can block while other threads wait for the entry into the element call looking at the sezpoz code it should be safe to do so AnnotatedElement e item element Class extType if e instanceof Class extType Class e else if e instanceof Field extType Field e getType else if e instanceof Method extType Method e getReturnType else throw new AssertionError according to JDK 4993813 this is the only way to force class initialization Class forName extType getName true extType getClassLoader catch Exception LinkageError e LOGGER log logLevel item Failed to scout item className e private Level logLevel IndexItem Extension Object item return item annotation optional Level FINE Level WARNING private static final Logger LOGGER Logger getLogger ExtensionFinder class getNamepackage hudson import com google common collect Lists import hudson init InitMilestone import hudson model Hudson import jenkins ExtensionComponentSet import jenkins model Jenkins import hudson util AdaptedIterator import hudson util DescriptorList import hudson util Memoizer import hudson util Iterators import hudson ExtensionPoint LegacyInstancesAreScopedToHudson import java util AbstractList import java util ArrayList import java util Collection import java util Collections import java util Iterator import java util List import java util Vector import java util concurrent CopyOnWriteArrayList import java util logging Level import java util logging Logger import javax annotation CheckForNull import javax annotation Nonnull import jenkins util io OnMaster public class ExtensionList T extends AbstractList T implements OnMaster Deprecated public final Hudson hudson public final CheckForNull Jenkins jenkins public final Class T extensionType CopyOnWrite private volatile List ExtensionComponent T extensions private final List ExtensionListListener listeners new CopyOnWriteArrayList ExtensionListListener private final CopyOnWriteArrayList ExtensionComponent T legacyInstances Deprecated protected ExtensionList Hudson hudson Class T extensionType this Jenkins hudson extensionType protected ExtensionList Jenkins jenkins Class T extensionType this jenkins extensionType new CopyOnWriteArrayList ExtensionComponent T Deprecated protected ExtensionList Hudson hudson Class T extensionType CopyOnWriteArrayList ExtensionComponent T legacyStore this Jenkins hudson extensionType legacyStore protected ExtensionList Jenkins jenkins Class T extensionType CopyOnWriteArrayList ExtensionComponent T legacyStore this hudson Hudson jenkins this jenkins jenkins this extensionType extensionType this legacyInstances legacyStore if jenkins null extensions Collections emptyList public void addListener Nonnull ExtensionListListener listener listeners add listener public CheckForNull U extends T U get Class U type for T ext this if ext getClass type return type cast ext return null Override public Iterator T iterator we need to intercept mutation so for now don t allow Iterator remove return new AdaptedIterator ExtensionComponent T T Iterators readOnly ensureLoaded iterator protected T adapt ExtensionComponent T item return item getInstance public List ExtensionComponent T getComponents return Collections unmodifiableList ensureLoaded public T get int index return ensureLoaded get index getInstance public int size return ensureLoaded size public List T reverseView return new AbstractList T Override public T get int index return ExtensionList this get size index 1 Override public int size return ExtensionList this size Override public boolean remove Object o try return removeSync o finally if extensions null fireOnChangeListeners private synchronized boolean removeSync Object o boolean removed removeComponent legacyInstances o if extensions null List ExtensionComponent T r new ArrayList ExtensionComponent T extensions removed removeComponent r o extensions sort r return removed private T boolean removeComponent Collection ExtensionComponent T collection Object t for Iterator ExtensionComponent T itr collection iterator itr hasNext ExtensionComponent T c itr next if c getInstance equals t return collection remove c return false Override public final synchronized T remove int index T t get index remove t return t Override Deprecated public boolean add T t try return addSync t finally if extensions null fireOnChangeListeners private synchronized boolean addSync T t legacyInstances add new ExtensionComponent T t if we ve already filled extensions add it if extensions null List ExtensionComponent T r new ArrayList ExtensionComponent T extensions r add new ExtensionComponent T t extensions sort r return true Override public void add int index T element add element public T getDynamic String className for T t this if t getClass getName equals className return t return null private List ExtensionComponent T ensureLoaded if extensions null return extensions already loaded if jenkins getInitLevel compareTo InitMilestone PLUGINS PREPARED 0 return legacyInstances can t perform the auto discovery until all plugins are loaded so just make the legacy instances visible synchronized getLoadLock if extensions null List ExtensionComponent T r load r addAll legacyInstances extensions sort r return extensions protected Object getLoadLock return jenkins lookup setIfNull Lock class new Lock public void refresh ExtensionComponentSet delta boolean fireOnChangeListeners false synchronized getLoadLock if extensions null return not yet loaded when we load it we ll load everything visible by then so no work needed Collection ExtensionComponent T found load delta if found isEmpty List ExtensionComponent T l Lists newArrayList extensions l addAll found extensions sort l fireOnChangeListeners true if fireOnChangeListeners fireOnChangeListeners private void fireOnChangeListeners for ExtensionListListener listener listeners try listener onChange catch Exception e LOGGER log Level SEVERE Error firing ExtensionListListener onChange e private static final class Lock protected List ExtensionComponent T load if LOGGER isLoggable Level FINE LOGGER log Level FINE Loading ExtensionList extensionType new Throwable return jenkins getPluginManager getPluginStrategy findComponents extensionType hudson protected Collection ExtensionComponent T load ExtensionComponentSet delta return delta find extensionType protected List ExtensionComponent T sort List ExtensionComponent T r r new ArrayList ExtensionComponent T r Collections sort r return r Deprecated public static T ExtensionList T create Hudson hudson Class T type return create Jenkins hudson type public static T ExtensionList T create Jenkins jenkins Class T type if type getAnnotation LegacyInstancesAreScopedToHudson class null return new ExtensionList T jenkins type else return new ExtensionList T jenkins type staticLegacyInstances get type public static Nonnull T ExtensionList T lookup Class T type Jenkins j Jenkins getInstanceOrNull return j null create Jenkins null type j getExtensionList type private static final Memoizer Class CopyOnWriteArrayList staticLegacyInstances new Memoizer Class CopyOnWriteArrayList public CopyOnWriteArrayList compute Class key return new CopyOnWriteArrayList public static void clearLegacyInstances staticLegacyInstances clear private static final Logger LOGGER Logger getLogger ExtensionList class getNamepackage hudson public abstract class ExtensionListListener public abstract void onChangepackage hudson import jenkins model Jenkins import hudson util CopyOnWriteList import java util AbstractList import java util Iterator import java util List import java util Collection public class ExtensionListView public static T List T createList final Class T type return new AbstractList T private ExtensionList T storage return Jenkins getInstance getExtensionList type Override public Iterator T iterator return storage iterator public T get int index return storage get index public int size return storage size Override public boolean add T t return storage add t Override public void add int index T t index ignored storage add t Override public T remove int index return storage remove index Override public boolean remove Object o return storage remove o public static T CopyOnWriteList T createCopyOnWriteList final Class T type return new CopyOnWriteList T private ExtensionList T storage return Jenkins getInstance getExtensionList type Override public void add T t storage add t Override public boolean remove T t return storage remove t Override public Iterator T iterator return storage iterator Override public void replaceBy CopyOnWriteList extends T that throw new UnsupportedOperationException Override public void replaceBy Collection extends T that throw new UnsupportedOperationException Override public void replaceBy T that throw new UnsupportedOperationException Override public void clear throw new UnsupportedOperationException Override public T T toArray T array return storage toArray array Override public List T getView return storage Override public void addAllTo Collection super T dst dst addAll storage Override public boolean isEmpty return storage isEmpty TODO we need a few more types whose implementations get uglierpackage hudson import jenkins model Jenkins import static java lang annotation ElementType TYPE import java lang annotation Retention import static java lang annotation RetentionPolicy RUNTIME import java lang annotation Target import jenkins util io OnMaster public interface ExtensionPoint extends OnMaster Target TYPE Retention RUNTIME interface LegacyInstancesAreScopedToHudsonpackage jenkins import hudson ExtensionFinder public class ExtensionRefreshException extends Exception public ExtensionRefreshException public ExtensionRefreshException String message super message public ExtensionRefreshException String message Throwable cause super message cause public ExtensionRefreshException Throwable cause super causepackage hudson model import jenkins model Jenkins import org kohsuke stapler HttpResponse import org kohsuke stapler StaplerRequest import org kohsuke stapler StaplerResponse import javax annotation CheckForNull import javax servlet ServletException import java io IOException public class Failure extends RuntimeException implements HttpResponse private final boolean pre public Failure String message this message false public Failure String message boolean pre super message this pre pre public void generateResponse StaplerRequest req StaplerResponse rsp Object node CheckForNull Throwable throwable throws IOException ServletException if throwable null req setAttribute exception throwable generateResponse req rsp node public void generateResponse StaplerRequest req StaplerResponse rsp Object node throws IOException ServletException req setAttribute message getMessage if pre req setAttribute pre true if node instanceof AbstractItem Maintain ancestors rsp forward Jenkins getInstance AbstractItem node getUrl error req else rsp forward node instanceof AbstractModelObject node Jenkins getInstance error reqpackage com twitter sdk android core services import com twitter sdk android core models Tweet import java util List import retrofit2 Call import retrofit2 http Field import retrofit2 http FormUrlEncoded import retrofit2 http GET import retrofit2 http POST import retrofit2 http Query public interface FavoriteService GET 1 1 favorites list json tweet mode extended include cards true cards platform TwitterKit 13 Call List Tweet list Query user id Long userId Query screen name String screenName Query count Integer count Query since id String sinceId Query max id String maxId Query include entities Boolean includeEntities FormUrlEncoded POST 1 1 favorites destroy json tweet mode extended include cards true cards platform TwitterKit 13 Call Tweet destroy Field id Long id Field include entities Boolean includeEntities FormUrlEncoded POST 1 1 favorites create json tweet mode extended include cards true cards platform TwitterKit 13 Call Tweet create Field id Long id Field include entities Boolean includeEntitiespackage hudson security import hudson ExtensionList import hudson ExtensionPoint import jenkins model Jenkins import hudson model User import hudson model UserProperty import org acegisecurity context SecurityContextHolder import org acegisecurity providers UsernamePasswordAuthenticationToken import org acegisecurity userdetails UserDetails import org kohsuke stapler HttpResponse import org kohsuke stapler StaplerRequest import org kohsuke stapler StaplerResponse import javax servlet ServletException import java io IOException import java io Serializable public abstract class FederatedLoginService implements ExtensionPoint public abstract String getUrlName public abstract Class extends FederatedLoginServiceUserProperty getUserPropertyClass public abstract class FederatedIdentity implements Serializable public abstract String getIdentifier public abstract String getNickname public abstract String getFullName public abstract String getEmailAddress public abstract String getPronoun public final User locateUser Class extends FederatedLoginServiceUserProperty pt getUserPropertyClass String id getIdentifier for User u User getAll if u getProperty pt has id return u return null SuppressWarnings ACL impersonate public User signin throws UnclaimedIdentityException User u locateUser if u null login as this user UserDetails d Jenkins getInstance getSecurityRealm loadUserByUsername u getId UsernamePasswordAuthenticationToken token new UsernamePasswordAuthenticationToken d d getAuthorities token setDetails d SecurityContextHolder getContext setAuthentication token return u else Unassociated identity throw new UnclaimedIdentityException this public void addToCurrentUser throws IOException User u User current if u null throw new IllegalStateException Current request is unauthenticated addTo u public void addTo User u throws IOException FederatedLoginServiceUserProperty p u getProperty getUserPropertyClass if p null p FederatedLoginServiceUserProperty UserProperty all find getUserPropertyClass newInstance u u addProperty p p addIdentifier getIdentifier Override public String toString return getIdentifier public static class UnclaimedIdentityException extends RuntimeException implements HttpResponse public final FederatedIdentity identity public UnclaimedIdentityException FederatedIdentity identity this identity identity public void generateResponse StaplerRequest req StaplerResponse rsp Object node throws IOException ServletException SecurityRealm sr Jenkins getInstance getSecurityRealm if sr allowsSignup try sr commenceSignup identity generateResponse req rsp node return catch UnsupportedOperationException e fall through this security realm doesn t support user registration just report an error req getView this error forward req rsp public static ExtensionList FederatedLoginService all return ExtensionList lookup FederatedLoginService classpackage hudson security import hudson model UserProperty import java io IOException import java util Collection import java util Collections import java util HashSet import java util Set public class FederatedLoginServiceUserProperty extends UserProperty protected final Set String identifiers protected FederatedLoginServiceUserProperty Collection String identifiers this identifiers new HashSet String identifiers public boolean has String identifier return identifiers contains identifier public Collection String getIdentifiers return Collections unmodifiableSet identifiers public synchronized void addIdentifier String id throws IOException identifiers add id user savepackage hudson import java util Calendar public interface FeedAdapter E String getEntryTitle E entry String getEntryUrl E entry String getEntryID E entry String getEntryDescription E entry Calendar getEntryTimestamp E entry String getEntryAuthor E entrypackage jenkins util io import jenkins model Jenkins import java io File import java io FileOutputStream import java io IOException import java util logging Level import java util logging Logger public class FileBoolean private final File file private volatile Boolean state public FileBoolean File file this file file public FileBoolean Class owner String name this new File Jenkins getInstance getRootDir owner getName replace name public boolean get return state file exists public boolean fastGet if state null return get return state public boolean isOn return get public boolean isOff return get public void set boolean b if b on else off public void on try file getParentFile mkdirs new FileOutputStream file close get update state catch IOException e LOGGER log Level WARNING Failed to touch file public void off file delete get update state private static final Logger LOGGER Logger getLogger FileBoolean class getNamepackage hudson model import net sf json JSONObject import org jenkinsci Symbol import org kohsuke stapler DataBoundConstructor import org kohsuke stapler StaplerRequest import hudson Extension import hudson FilePath import hudson cli CLICommand import org apache commons fileupload FileItem import java io IOException import java io File import javax servlet ServletException public class FileParameterDefinition extends ParameterDefinition DataBoundConstructor public FileParameterDefinition String name String description super name description public FileParameterValue createValue StaplerRequest req JSONObject jo FileParameterValue p req bindJSON FileParameterValue class jo p setLocation getName p setDescription getDescription return p Extension Symbol file fileParam public static class DescriptorImpl extends ParameterDescriptor Override public String getDisplayName return Messages FileParameterDefinition DisplayName Override public String getHelpFile return help parameter file html Override public ParameterValue createValue StaplerRequest req FileItem src try src req getFileItem getName catch ServletException IOException e Not sure what to do here We might want to raise this but that would involve changing the throws for this call return null if src null the requested file parameter wasn t uploaded return null FileParameterValue p new FileParameterValue getName src getFileName src getName p setDescription getDescription p setLocation getName return p private String getFileName String possiblyPathName possiblyPathName possiblyPathName substring possiblyPathName lastIndexOf 1 possiblyPathName possiblyPathName substring possiblyPathName lastIndexOf 1 return possiblyPathName Override public ParameterValue createValue CLICommand command String value throws IOException InterruptedException capture the file to the server FilePath src new FilePath command checkChannel value File local File createTempFile jenkins parameter src copyTo new FilePath local FileParameterValue p new FileParameterValue getName local src getName p setDescription getDescription p setLocation getName return ppackage hudson model import hudson EnvVars import hudson FilePath import hudson Launcher import hudson tasks BuildWrapper import hudson util VariableResolver import java io File import java io FileInputStream import java io FileOutputStream import java io IOException import java io InputStream import java io OutputStream import java io UnsupportedEncodingException import javax servlet ServletException import org apache commons fileupload FileItem import org apache commons fileupload FileItemHeaders import org apache commons fileupload disk DiskFileItem import org apache commons fileupload util FileItemHeadersImpl import org apache commons io FilenameUtils import org apache commons io IOUtils import org apache commons lang StringUtils import org kohsuke stapler DataBoundConstructor import org kohsuke stapler StaplerRequest import org kohsuke stapler StaplerResponse public class FileParameterValue extends ParameterValue private transient final FileItem file private final String originalFileName private String location DataBoundConstructor public FileParameterValue String name FileItem file this name file FilenameUtils getName file getName public FileParameterValue String name File file String originalFileName this name new FileItemImpl file originalFileName protected FileParameterValue String name FileItem file String originalFileName super name this file file this originalFileName originalFileName setLocation name post initialization hook protected void setLocation String location this location location public String getLocation return location Override public Object getValue return file Override public void buildEnvironment Run build EnvVars env env put name originalFileName Override public VariableResolver String createVariableResolver AbstractBuild build return new VariableResolver String public String resolve String name return FileParameterValue this name equals name originalFileName null public String getOriginalFileName return originalFileName public FileItem getFile return file Override public BuildWrapper createBuildWrapper AbstractBuild build return new BuildWrapper Override public Environment setUp AbstractBuild build Launcher launcher BuildListener listener throws IOException InterruptedException if StringUtils isEmpty location StringUtils isEmpty file getName listener getLogger println Copying file to location FilePath locationFilePath build getWorkspace child location locationFilePath getParent mkdirs locationFilePath copyFrom file locationFilePath copyTo new FilePath getLocationUnderBuild build return new Environment Override public int hashCode final int prime 31 int result super hashCode result prime result location null 0 location hashCode return result Override public boolean equals Object obj if this obj return true if super equals obj return false if getClass obj getClass return false FileParameterValue other FileParameterValue obj if location null other location null return true Consider null parameters as equal TODO check fingerprints or checksums to improve the behavior JENKINS 25211 Return false even if files are equal return false Override public String toString return FileParameterValue getName originalFileName Override public String getShortDescription return name originalFileName public void doDynamic StaplerRequest request StaplerResponse response throws ServletException IOException if originalFileName equals request getRestOfPath AbstractBuild build AbstractBuild request findAncestor AbstractBuild class getObject File fileParameter getLocationUnderBuild build if fileParameter isFile InputStream data new FileInputStream fileParameter try long lastModified fileParameter lastModified long contentLength fileParameter length if request hasParameter view response serveFile request data lastModified contentLength plain txt else response serveFile request data lastModified contentLength originalFileName finally IOUtils closeQuietly data private File getLocationUnderBuild AbstractBuild build return new File build getRootDir fileParameters location public static final class FileItemImpl implements FileItem private final File file public FileItemImpl File file if file null throw new NullPointerException file this file file public InputStream getInputStream throws IOException return new FileInputStream file public String getContentType return null public String getName return file getName public boolean isInMemory return false public long getSize return file length public byte get try try FileInputStream inputStream new FileInputStream file return IOUtils toByteArray inputStream catch IOException e throw new Error e public String getString String encoding throws UnsupportedEncodingException return new String get encoding public String getString return new String get public void write File to throws Exception new FilePath file copyTo new FilePath to public void delete file delete public String getFieldName return null public void setFieldName String name public boolean isFormField return false public void setFormField boolean state Deprecated public OutputStream getOutputStream throws IOException return new FileOutputStream file Override public FileItemHeaders getHeaders return new FileItemHeadersImpl Override public void setHeaders FileItemHeaders headerspackage hudson import jenkins util SystemProperties import com google common annotations VisibleForTesting import com jcraft jzlib GZIPInputStream import com jcraft jzlib GZIPOutputStream import hudson Launcher LocalLauncher import hudson Launcher RemoteLauncher import hudson model AbstractProject import hudson model Computer import hudson model Item import hudson model TaskListener import hudson os PosixAPI import hudson os PosixException import hudson remoting Callable import hudson remoting Channel import hudson remoting DelegatingCallable import hudson remoting Future import hudson remoting LocalChannel import hudson remoting Pipe import hudson remoting RemoteInputStream import hudson remoting RemoteInputStream Flag import hudson remoting RemoteOutputStream import hudson remoting VirtualChannel import hudson remoting Which import hudson security AccessControlled import hudson util DaemonThreadFactory import hudson util DirScanner import hudson util ExceptionCatchingThreadFactory import hudson util FileVisitor import hudson util FormValidation import hudson util HeadBufferingStream import hudson util IOUtils import hudson util NamingThreadFactory import hudson util io Archiver import hudson util io ArchiverFactory import jenkins FilePathFilter import jenkins MasterToSlaveFileCallable import jenkins SlaveToMasterFileCallable import jenkins SoloFilePathFilter import jenkins model Jenkins import jenkins util ContextResettingExecutorService import jenkins util VirtualFile import org apache commons fileupload FileItem import org apache commons io input CountingInputStream import org apache tools ant DirectoryScanner import org apache tools ant Project import org apache tools ant types FileSet import org apache tools zip ZipEntry import org apache tools zip ZipFile import org kohsuke accmod Restricted import org kohsuke accmod restrictions NoExternalUse import org kohsuke stapler Stapler import javax annotation CheckForNull import java io BufferedOutputStream import java io File import java io FileFilter import java io FileInputStream import java io FileOutputStream import java io FileWriter import java io IOException import java io InputStream import java io InterruptedIOException import java io ObjectInputStream import java io ObjectOutputStream import java io OutputStream import java io OutputStreamWriter import java io RandomAccessFile import java io Serializable import java io Writer import java net HttpURLConnection import java net MalformedURLException import java net URI import java net URL import java net URLConnection import java util ArrayList import java util Arrays import java util Comparator import java util Enumeration import java util List import java util Map import java util StringTokenizer import java util concurrent ExecutionException import java util concurrent ExecutorService import java util concurrent Executors import java util concurrent TimeUnit import java util concurrent TimeoutException import java util concurrent atomic AtomicInteger import java util logging Level import java util logging Logger import java util regex Matcher import java util regex Pattern import static hudson FilePath TarCompression import static hudson Util import javax annotation Nonnull import javax annotation Nullable import jenkins security MasterToSlaveCallable import org apache commons compress archivers tar TarArchiveEntry import org apache commons compress archivers tar TarArchiveInputStream import org jenkinsci remoting RoleChecker import org jenkinsci remoting RoleSensitive public final class FilePath implements Serializable private static final int MAX REDIRECTS 20 private transient VirtualChannel channel since the platform of the agent might be different can t use java io File private final String remote private transient Nullable SoloFilePathFilter filter public FilePath VirtualChannel channel String remote this channel channel instanceof LocalChannel null channel this remote normalize remote public FilePath File localPath this channel null this remote normalize localPath getPath public FilePath FilePath base String rel this channel base channel this remote normalize resolvePathIfRelative base rel private String resolvePathIfRelative FilePath base String rel if isAbsolute rel return rel if base isUnix shouldn t need this replace but better safe than sorry return base remote rel replace else need this replace see Slave getWorkspaceFor and AbstractItem getFullName nested jobs on Windows agents will always have a rel containing at least one character JENKINS 13649 return base remote rel replace private static boolean isAbsolute String rel return rel startsWith DRIVE PATTERN matcher rel matches UNC PATTERN matcher rel matches private static final Pattern DRIVE PATTERN Pattern compile A Za z UNC PATTERN Pattern compile ABSOLUTE PREFIX PATTERN Pattern compile A Za z private static String normalize String path StringBuilder buf new StringBuilder Check for prefix designating absolute path Matcher m ABSOLUTE PREFIX PATTERN matcher path if m find buf append m group 1 path path substring m end boolean isAbsolute buf length 0 Split remaining path into tokens trimming any duplicate or trailing separators List String tokens new ArrayList String int s 0 end path length for int i 0 i end i char c path charAt i if c c tokens add path substring s i s i Skip any extra separator chars while i end c path charAt i c Add token for separator unless we reached the end if i end tokens add path substring s s 1 s i if s end tokens add path substring s Look through tokens for or for int i 0 i tokens size String token tokens get i if token equals tokens remove i if tokens size 0 tokens remove i 0 i 1 i else if token equals if i 0 If absolute path just remove something If relative path not collapsible so leave as is tokens remove 0 if tokens size 0 token tokens remove 0 if isAbsolute buf append token else Normalize remove something plus separator before after i 2 for int j 0 j 3 j tokens remove i if i 0 tokens remove i 1 else if tokens size 0 tokens remove 0 else i 2 Recombine tokens for String token tokens buf append token if buf length 0 buf append return buf toString boolean isUnix if the path represents a local path there no need to guess if isRemote return File pathSeparatorChar note that we can t use the usual File pathSeparator and etc as the OS of the machine where this code runs and the OS that this FilePath refers to may be different Windows absolute path is X so this is usually a good indication of Windows path if remote length 3 remote charAt 1 remote charAt 2 return false Windows can handle as a path separator but Unix can t so err on Unix side return remote indexOf 1 public String getRemote return remote Deprecated public void createZipArchive OutputStream os throws IOException InterruptedException zip os public void zip OutputStream os throws IOException InterruptedException zip os FileFilter null public void zip FilePath dst throws IOException InterruptedException try OutputStream os dst write zip os public void zip OutputStream os FileFilter filter throws IOException InterruptedException archive ArchiverFactory ZIP os filter Deprecated public void createZipArchive OutputStream os final String glob throws IOException InterruptedException archive ArchiverFactory ZIP os glob public void zip OutputStream os final String glob throws IOException InterruptedException archive ArchiverFactory ZIP os glob public int zip OutputStream out DirScanner scanner throws IOException InterruptedException return archive ArchiverFactory ZIP out scanner public int archive final ArchiverFactory factory OutputStream os final DirScanner scanner throws IOException InterruptedException final OutputStream out channel null new RemoteOutputStream os os return act new SecureFileCallable Integer public Integer invoke File f VirtualChannel channel throws IOException Archiver a factory create out try scanner scan f reading a finally a close return a countEntries private static final long serialVersionUID 1L public int archive final ArchiverFactory factory OutputStream os final FileFilter filter throws IOException InterruptedException return archive factory os new DirScanner Filter filter public int archive final ArchiverFactory factory OutputStream os final String glob throws IOException InterruptedException return archive factory os new DirScanner Glob glob null public void unzip final FilePath target throws IOException InterruptedException TODO post release re unite two branches by introducing FileStreamCallable that resolves InputStream if this channel target channel local remote or remote local final RemoteInputStream in new RemoteInputStream read Flag GREEDY target act new SecureFileCallable Void public Void invoke File dir VirtualChannel channel throws IOException InterruptedException unzip dir in return null private static final long serialVersionUID 1L else local local or remote remote target act new SecureFileCallable Void public Void invoke File dir VirtualChannel channel throws IOException InterruptedException assert FilePath this isRemote this channel target channel above unzip dir reading new File FilePath this getRemote shortcut to local file return null private static final long serialVersionUID 1L public void untar final FilePath target final TarCompression compression throws IOException InterruptedException TODO post release re unite two branches by introducing FileStreamCallable that resolves InputStream if this channel target channel local remote or remote local final RemoteInputStream in new RemoteInputStream read Flag GREEDY target act new SecureFileCallable Void public Void invoke File dir VirtualChannel channel throws IOException InterruptedException readFromTar FilePath this getName dir compression extract in return null private static final long serialVersionUID 1L else local local or remote remote target act new SecureFileCallable Void public Void invoke File dir VirtualChannel channel throws IOException InterruptedException readFromTar FilePath this getName dir compression extract FilePath this read return null private static final long serialVersionUID 1L public void unzipFrom InputStream in throws IOException InterruptedException final InputStream in new RemoteInputStream in Flag GREEDY act new SecureFileCallable Void public Void invoke File dir VirtualChannel channel throws IOException unzip dir in return null private static final long serialVersionUID 1L private void unzip File dir InputStream in throws IOException File tmpFile File createTempFile tmpzip null uses java io tmpdir try TODO why does this not simply use ZipInputStream IOUtils copy in tmpFile unzip dir tmpFile finally tmpFile delete private void unzip File dir File zipFile throws IOException dir dir getAbsoluteFile without absolutization getParentFile below seems to fail ZipFile zip new ZipFile zipFile SuppressWarnings unchecked Enumeration ZipEntry entries zip getEntries try while entries hasMoreElements ZipEntry e entries nextElement File f new File dir e getName if e isDirectory mkdirs f else File p f getParentFile if p null mkdirs p try InputStream input zip getInputStream e IOUtils copy input writing f try FilePath target new FilePath f int mode e getUnixMode if mode 0 Ant returns 0 if the archive doesn t record the access mode target chmod mode catch InterruptedException ex LOGGER log Level WARNING unable to set permissions ex f setLastModified e getTime finally zip close public FilePath absolutize throws IOException InterruptedException return new FilePath channel act new SecureFileCallable String private static final long serialVersionUID 1L public String invoke File f VirtualChannel channel throws IOException return f getAbsolutePath public void symlinkTo final String target final TaskListener listener throws IOException InterruptedException act new SecureFileCallable Void private static final long serialVersionUID 1L public Void invoke File f VirtualChannel channel throws IOException InterruptedException symlinking f Util createSymlink f getParentFile target f getName listener return null public String readLink throws IOException InterruptedException return act new SecureFileCallable String private static final long serialVersionUID 1L public String invoke File f VirtualChannel channel throws IOException InterruptedException return Util resolveSymlink reading f Override public boolean equals Object o if this o return true if o null getClass o getClass return false FilePath that FilePath o if channel null channel equals that channel that channel null return false return remote equals that remote Override public int hashCode return 31 channel null channel hashCode 0 remote hashCode public enum TarCompression NONE public InputStream extract InputStream in return in public OutputStream compress OutputStream out return out GZIP public InputStream extract InputStream in throws IOException HeadBufferingStream in new HeadBufferingStream in SIDE BUFFER SIZE try return new GZIPInputStream in 8192 true catch IOException e various people reported java io IOException Not in GZIP format here so diagnose this problem better in fillSide throw new IOException e getMessage nstream Util toHexString in getSideBuffer e public OutputStream compress OutputStream out throws IOException return new GZIPOutputStream new BufferedOutputStream out public abstract InputStream extract InputStream in throws IOException public abstract OutputStream compress OutputStream in throws IOException public void untarFrom InputStream in final TarCompression compression throws IOException InterruptedException try final InputStream in new RemoteInputStream in Flag GREEDY act new SecureFileCallable Void public Void invoke File dir VirtualChannel channel throws IOException readFromTar input stream dir compression extract in return null private static final long serialVersionUID 1L finally org apache commons io IOUtils closeQuietly in public boolean installIfNecessaryFrom Nonnull URL archive CheckForNull TaskListener listener Nonnull String message throws IOException InterruptedException return installIfNecessaryFrom archive listener message MAX REDIRECTS private boolean installIfNecessaryFrom Nonnull URL archive CheckForNull TaskListener listener Nonnull String message int maxRedirects throws InterruptedException IOException try FilePath timestamp this child timestamp long lastModified timestamp lastModified URLConnection con try con ProxyConfiguration open archive if lastModified 0 con setIfModifiedSince lastModified con connect catch IOException x if this exists Cannot connect now so assume whatever was last unpacked is still OK if listener null listener getLogger println Skipping installation of archive to remote x return false else throw x if con instanceof HttpURLConnection HttpURLConnection httpCon HttpURLConnection con int responseCode httpCon getResponseCode if responseCode HttpURLConnection HTTP MOVED PERM responseCode HttpURLConnection HTTP MOVED TEMP follows redirect if maxRedirects 0 String location httpCon getHeaderField Location listener getLogger println Following redirect archive toExternalForm location return installIfNecessaryFrom getUrlFactory newURL location listener message maxRedirects 1 else listener getLogger println Skipping installation of archive to remote due to too many redirects return false if lastModified 0 if responseCode HttpURLConnection HTTP NOT MODIFIED return false else if responseCode HttpURLConnection HTTP OK listener getLogger println Skipping installation of archive to remote due to server error responseCode httpCon getResponseMessage return false long sourceTimestamp con getLastModified if this exists if lastModified 0 sourceTimestamp lastModified return false already up to date this deleteContents else this mkdirs if listener null listener getLogger println message if isRemote First try to download from the agent machine try act new Unpack archive timestamp touch sourceTimestamp return true catch IOException x if listener null x printStackTrace listener error Failed to download archive from agent will retry from master for HTTP downloads enable automatic retry for added resilience InputStream in archive getProtocol startsWith http ProxyConfiguration getInputStream archive con getInputStream CountingInputStream cis new CountingInputStream in try if archive toExternalForm endsWith zip unzipFrom cis else untarFrom cis GZIP catch IOException e throw new IOException String format Failed to unpack s d bytes read of total d archive cis getByteCount con getContentLength e timestamp touch sourceTimestamp return true catch IOException e throw new IOException Failed to install archive to remote e this reads from arbitrary URL private final class Unpack extends MasterToSlaveFileCallable Void private final URL archive Unpack URL archive this archive archive Override public Void invoke File dir VirtualChannel channel throws IOException InterruptedException try InputStream in archive openStream CountingInputStream cis new CountingInputStream in try if archive toExternalForm endsWith zip unzip dir cis else readFromTar input stream dir GZIP extract cis catch IOException x throw new IOException String format Failed to unpack s d bytes read archive cis getByteCount x return null public void copyFrom URL url throws IOException InterruptedException try InputStream in url openStream copyFrom in public void copyFrom InputStream in throws IOException InterruptedException try OutputStream os write org apache commons io IOUtils copy in os public void copyFrom FilePath src throws IOException InterruptedException src copyTo this public void copyFrom FileItem file throws IOException InterruptedException if channel null try file write writing new File remote catch IOException e throw e catch Exception e throw new IOException e else try InputStream i file getInputStream OutputStream o write org apache commons io IOUtils copy i o public interface FileCallable T extends Serializable RoleSensitive T invoke File f VirtualChannel channel throws IOException InterruptedException static abstract class SecureFileCallable T extends SlaveToMasterFileCallable T public T T act final FileCallable T callable throws IOException InterruptedException return act callable callable getClass getClassLoader private T T act final FileCallable T callable ClassLoader cl throws IOException InterruptedException if channel null run this on a remote system try DelegatingCallable T IOException wrapper new FileCallableWrapper T callable cl for FileCallableWrapperFactory factory ExtensionList lookup FileCallableWrapperFactory class wrapper factory wrap wrapper return channel call wrapper catch TunneledInterruptedException e throw InterruptedException new InterruptedException e getMessage initCause e catch AbortException e throw e pass through so that the caller can catch it as AbortException catch IOException e wrap it into a new IOException so that we get the caller s stack trace as well throw new IOException remote file operation failed remote at channel e e else the file is on the local machine return callable invoke new File remote localChannel public static abstract class FileCallableWrapperFactory implements ExtensionPoint public abstract T DelegatingCallable T IOException wrap DelegatingCallable T IOException callable public static abstract class AbstractInterceptorCallableWrapper T implements DelegatingCallable T IOException private static final long serialVersionUID 1L private final DelegatingCallable T IOException callable public AbstractInterceptorCallableWrapper DelegatingCallable T IOException callable this callable callable Override public final ClassLoader getClassLoader return callable getClassLoader public final T call throws IOException before try return callable call finally after protected void before protected void after public T Future T actAsync final FileCallable T callable throws IOException InterruptedException try DelegatingCallable T IOException wrapper new FileCallableWrapper T callable for FileCallableWrapperFactory factory ExtensionList lookup FileCallableWrapperFactory class wrapper factory wrap wrapper return channel null channel localChannel callAsync wrapper catch IOException e wrap it into a new IOException so that we get the caller s stack trace as well throw new IOException remote file operation failed e public V E extends Throwable V act Callable V E callable throws IOException InterruptedException E if channel null run this on a remote system return channel call callable else the file is on the local machine return callable call public V Callable V IOException asCallableWith final FileCallable V task return new Callable V IOException Override public V call throws IOException try return act task catch InterruptedException e throw IOException new InterruptedIOException initCause e Override public void checkRoles RoleChecker checker throws SecurityException task checkRoles checker private static final long serialVersionUID 1L public URI toURI throws IOException InterruptedException return act new SecureFileCallable URI private static final long serialVersionUID 1L public URI invoke File f VirtualChannel channel return f toURI public VirtualFile toVirtualFile return VirtualFile forFilePath this public CheckForNull Computer toComputer Jenkins j Jenkins getInstanceOrNull if j null for Computer c j getComputers if getChannel c getChannel return c return null public void mkdirs throws IOException InterruptedException if act new SecureFileCallable Boolean private static final long serialVersionUID 1L public Boolean invoke File f VirtualChannel channel throws IOException InterruptedException if mkdirs f f exists return true OK following Ant mkdir task to avoid possible race condition Thread sleep 10 return f mkdirs f exists throw new IOException Failed to mkdirs remote public void deleteRecursive throws IOException InterruptedException act new SecureFileCallable Void private static final long serialVersionUID 1L public Void invoke File f VirtualChannel channel throws IOException deleteRecursive deleting f return null public void deleteContents throws IOException InterruptedException act new SecureFileCallable Void private static final long serialVersionUID 1L public Void invoke File f VirtualChannel channel throws IOException deleteContentsRecursive f return null private void deleteRecursive File dir throws IOException if isSymlink dir deleteContentsRecursive dir try deleteFile deleting dir catch IOException e if some of the child directories are big it might take long enough to delete that it allows others to create new files causing problemsl ike JENKINS 10113 so give it one more attempt before we give up if isSymlink dir deleteContentsRecursive dir deleteFile deleting dir private void deleteContentsRecursive File file throws IOException File files file listFiles if files null return the directory didn t exist in the first place for File child files deleteRecursive child public String getBaseName String n getName int idx n lastIndexOf if idx 0 return n return n substring 0 idx public String getName String r remote if r endsWith r endsWith r r substring 0 r length 1 int len r length 1 while len 0 char ch r charAt len if ch ch break len return r substring len 1 public FilePath sibling String rel return getParent child rel public FilePath withSuffix String suffix return new FilePath channel remote suffix public Nonnull FilePath child String relOrAbsolute return new FilePath this relOrAbsolute public FilePath getParent int i remote length 2 for i 0 i char ch remote charAt i if ch ch break return i 0 new FilePath channel remote substring 0 i 1 null public FilePath createTempFile final String prefix final String suffix throws IOException InterruptedException try return new FilePath this act new SecureFileCallable String private static final long serialVersionUID 1L public String invoke File dir VirtualChannel channel throws IOException File f writing File createTempFile prefix suffix dir return f getName catch IOException e throw new IOException Failed to create a temp file on remote e public FilePath createTextTempFile final String prefix final String suffix final String contents throws IOException InterruptedException return createTextTempFile prefix suffix contents true public FilePath createTextTempFile final String prefix final String suffix final String contents final boolean inThisDirectory throws IOException InterruptedException try return new FilePath channel act new SecureFileCallable String private static final long serialVersionUID 1L public String invoke File dir VirtualChannel channel throws IOException if inThisDirectory dir new File System getProperty java io tmpdir else mkdirs dir File f try f creating File createTempFile prefix suffix dir catch IOException e throw new IOException Failed to create a temporary directory in dir e try Writer w new FileWriter writing f w write contents return f getAbsolutePath catch IOException e throw new IOException Failed to create a temp file on remote e public FilePath createTempDir final String prefix final String suffix throws IOException InterruptedException try return new FilePath this act new SecureFileCallable String private static final long serialVersionUID 1L public String invoke File dir VirtualChannel channel throws IOException File f File createTempFile prefix suffix dir f delete f mkdir return f getName catch IOException e throw new IOException Failed to create a temp directory on remote e public boolean delete throws IOException InterruptedException act new SecureFileCallable Void private static final long serialVersionUID 1L public Void invoke File f VirtualChannel channel throws IOException Util deleteFile deleting f return null return true public boolean exists throws IOException InterruptedException return act new SecureFileCallable Boolean private static final long serialVersionUID 1L public Boolean invoke File f VirtualChannel channel throws IOException return stating f exists public long lastModified throws IOException InterruptedException return act new SecureFileCallable Long private static final long serialVersionUID 1L public Long invoke File f VirtualChannel channel throws IOException return stating f lastModified public void touch final long timestamp throws IOException InterruptedException act new SecureFileCallable Void private static final long serialVersionUID 5094638816500738429L public Void invoke File f VirtualChannel channel throws IOException if f exists new FileOutputStream creating f close if stating f setLastModified timestamp throw new IOException Failed to set the timestamp of f to timestamp return null private void setLastModifiedIfPossible final long timestamp throws IOException InterruptedException String message act new SecureFileCallable String private static final long serialVersionUID 828220335793641630L public String invoke File f VirtualChannel channel throws IOException if writing f setLastModified timestamp if Functions isWindows On Windows this seems to fail often See JENKINS 11073 Therefore don t fail but just log a warning return Failed to set the timestamp of f to timestamp else throw new IOException Failed to set the timestamp of f to timestamp return null if message null LOGGER warning message public boolean isDirectory throws IOException InterruptedException return act new SecureFileCallable Boolean private static final long serialVersionUID 1L public Boolean invoke File f VirtualChannel channel throws IOException return stating f isDirectory public long length throws IOException InterruptedException return act new SecureFileCallable Long private static final long serialVersionUID 1L public Long invoke File f VirtualChannel channel throws IOException return stating f length public long getFreeDiskSpace throws IOException InterruptedException return act new SecureFileCallable Long private static final long serialVersionUID 1L Override public Long invoke File f VirtualChannel channel throws IOException return f getFreeSpace public long getTotalDiskSpace throws IOException InterruptedException return act new SecureFileCallable Long private static final long serialVersionUID 1L Override public Long invoke File f VirtualChannel channel throws IOException return f getTotalSpace public long getUsableDiskSpace throws IOException InterruptedException return act new SecureFileCallable Long private static final long serialVersionUID 1L Override public Long invoke File f VirtualChannel channel throws IOException return f getUsableSpace public void chmod final int mask throws IOException InterruptedException if isUnix mask 1 return act new SecureFileCallable Void private static final long serialVersionUID 1L public Void invoke File f VirtualChannel channel throws IOException TODO first check for Java 7 and use PosixFileAttributeView chmod writing f mask return null private static void chmod File f int mask throws IOException TODO WindowsPosix actually does something here WindowsLibC wchmod should we let it Anyway the existing calls already skip this method if on Windows if File pathSeparatorChar return noop PosixAPI jnr chmod f getAbsolutePath mask private static boolean CHMOD WARNED false public int mode throws IOException InterruptedException PosixException if isUnix return 1 return act new SecureFileCallable Integer private static final long serialVersionUID 1L public Integer invoke File f VirtualChannel channel throws IOException return IOUtils mode stating f public List FilePath list throws IOException InterruptedException return list FileFilter null public List FilePath listDirectories throws IOException InterruptedException return list new DirectoryFilter private static final class DirectoryFilter implements FileFilter Serializable public boolean accept File f return f isDirectory private static final long serialVersionUID 1L public List FilePath list final FileFilter filter throws IOException InterruptedException if filter null filter instanceof Serializable throw new IllegalArgumentException Non serializable filter of filter getClass return act new SecureFileCallable List FilePath private static final long serialVersionUID 1L public List FilePath invoke File f VirtualChannel channel throws IOException File children reading f listFiles filter if children null return null ArrayList FilePath r new ArrayList FilePath children length for File child children r add new FilePath child return r filter null filter this getClass getClassLoader public FilePath list final String includes throws IOException InterruptedException return list includes null public FilePath list final String includes final String excludes throws IOException InterruptedException return list includes excludes true public FilePath list final String includes final String excludes final boolean defaultExcludes throws IOException InterruptedException return act new SecureFileCallable FilePath private static final long serialVersionUID 1L public FilePath invoke File f VirtualChannel channel throws IOException String files glob reading f includes excludes defaultExcludes FilePath r new FilePath files length for int i 0 i r length i r i new FilePath new File f files i return r private static String glob File dir String includes String excludes boolean defaultExcludes throws IOException if isAbsolute includes throw new IOException Expecting Ant GLOB pattern but saw includes See http ant apache org manual Types fileset html for syntax FileSet fs Util createFileSet dir includes excludes fs setDefaultexcludes defaultExcludes DirectoryScanner ds fs getDirectoryScanner new Project String files ds getIncludedFiles return files public InputStream read throws IOException InterruptedException if channel null return new FileInputStream reading new File remote final Pipe p Pipe createRemoteToLocal actAsync new SecureFileCallable Void private static final long serialVersionUID 1L Override public Void invoke File f VirtualChannel channel throws IOException InterruptedException FileInputStream fis null try fis new FileInputStream reading f Util copyStream fis p getOut catch Exception x p error x finally org apache commons io IOUtils closeQuietly fis org apache commons io IOUtils closeQuietly p getOut return null return p getIn public InputStream readFromOffset final long offset throws IOException InterruptedException if channel null final RandomAccessFile raf new RandomAccessFile new File remote r try raf seek offset catch IOException e try raf close catch IOException e1 ignore throw e return new InputStream Override public int read throws IOException return raf read Override public void close throws IOException raf close Override public int read byte b int off int len throws IOException return raf read b off len Override public int read byte b throws IOException return raf read b final Pipe p Pipe createRemoteToLocal actAsync new SecureFileCallable Void private static final long serialVersionUID 1L public Void invoke File f VirtualChannel channel throws IOException final OutputStream out new java util zip GZIPOutputStream p getOut 8192 RandomAccessFile raf null try raf new RandomAccessFile reading f r raf seek offset byte buf new byte 8192 int len while len raf read buf 0 out write buf 0 len return null finally IOUtils closeQuietly out if raf null try raf close catch IOException e ignore return new java util zip GZIPInputStream p getIn public String readToString throws IOException InterruptedException try InputStream in read return org apache commons io IOUtils toString in public OutputStream write throws IOException InterruptedException if channel null File f new File remote getAbsoluteFile mkdirs f getParentFile return new FileOutputStream writing f return act new SecureFileCallable OutputStream private static final long serialVersionUID 1L public OutputStream invoke File f VirtualChannel channel throws IOException InterruptedException f f getAbsoluteFile mkdirs f getParentFile FileOutputStream fos new FileOutputStream writing f return new RemoteOutputStream fos public void write final String content final String encoding throws IOException InterruptedException act new SecureFileCallable Void private static final long serialVersionUID 1L public Void invoke File f VirtualChannel channel throws IOException mkdirs f getParentFile FileOutputStream fos new FileOutputStream writing f try Writer w encoding null new OutputStreamWriter fos encoding new OutputStreamWriter fos w write content return null public String digest throws IOException InterruptedException return act new SecureFileCallable String private static final long serialVersionUID 1L public String invoke File f VirtualChannel channel throws IOException return Util getDigestOf reading f public void renameTo final FilePath target throws IOException InterruptedException if this channel target channel throw new IOException renameTo target must be on the same host act new SecureFileCallable Void private static final long serialVersionUID 1L public Void invoke File f VirtualChannel channel throws IOException reading f renameTo creating new File target remote return null public void moveAllChildrenTo final FilePath target throws IOException InterruptedException if this channel target channel throw new IOException pullUpTo target must be on the same host act new SecureFileCallable Void private static final long serialVersionUID 1L public Void invoke File f VirtualChannel channel throws IOException JENKINS 16846 if f getName is the same as one of the files directories in f then the rename op will fail File tmp new File f getAbsolutePath rename if f renameTo tmp throw new IOException Failed to rename f to tmp File t new File target getRemote for File child reading tmp listFiles File target new File t child getName if stating child renameTo creating target throw new IOException Failed to rename child to target deleting tmp delete return null public void copyTo FilePath target throws IOException InterruptedException try try OutputStream out target write copyTo out catch IOException e throw new IOException Failed to copy this to target e public void copyToWithPermission FilePath target throws IOException InterruptedException copyTo target copy file permission target chmod mode target setLastModifiedIfPossible lastModified public void copyTo OutputStream os throws IOException InterruptedException final OutputStream out new RemoteOutputStream os act new SecureFileCallable Void private static final long serialVersionUID 4088559042349254141L public Void invoke File f VirtualChannel channel throws IOException FileInputStream fis null try fis new FileInputStream reading f Util copyStream fis out return null finally org apache commons io IOUtils closeQuietly fis org apache commons io IOUtils closeQuietly out make sure the writes fully got delivered to os before we return this is needed because I O operation is asynchronous syncIO private void syncIO throws InterruptedException try if channel null channel syncLocalIO catch AbstractMethodError e legacy slave jar Handle this gracefully try LOGGER log Level WARNING Looks like an old slave jar Please update Which jarFile Channel class to the new version e catch IOException really ignore this time private void syncIO throws InterruptedException channel syncLocalIO interface RemoteCopier void open String fileName throws IOException void write byte buf int len throws IOException void close throws IOException public int copyRecursiveTo FilePath target throws IOException InterruptedException return copyRecursiveTo public int copyRecursiveTo String fileMask FilePath target throws IOException InterruptedException return copyRecursiveTo fileMask null target public int copyRecursiveTo final String fileMask final String excludes final FilePath target throws IOException InterruptedException return copyRecursiveTo new DirScanner Glob fileMask excludes target fileMask public int copyRecursiveTo final DirScanner scanner final FilePath target final String description throws IOException InterruptedException if this channel target channel local to local copy return act new SecureFileCallable Integer private static final long serialVersionUID 1L public Integer invoke File base VirtualChannel channel throws IOException if base exists return 0 assert target channel null final File dest new File target remote final AtomicInteger count new AtomicInteger scanner scan base reading new FileVisitor Override public void visit File f String relativePath throws IOException if f isFile File target new File dest relativePath mkdirsE target getParentFile Util copyFile f writing target count incrementAndGet Override public boolean understandsSymlink return true Override public void visitSymlink File link String target String relativePath throws IOException try mkdirsE new File dest relativePath getParentFile writing new File dest target Util createSymlink dest target relativePath TaskListener NULL catch InterruptedException x throw IOException new IOException x toString initCause x count incrementAndGet return count get else if this channel null local remote copy final Pipe pipe Pipe createLocalToRemote Future Void future target actAsync new SecureFileCallable Void private static final long serialVersionUID 1L public Void invoke File f VirtualChannel channel throws IOException try InputStream in pipe getIn readFromTar remote description f TarCompression GZIP extract in return null Future Integer future2 actAsync new SecureFileCallable Integer private static final long serialVersionUID 1L Override public Integer invoke File f VirtualChannel channel throws IOException InterruptedException return writeToTar new File remote scanner TarCompression GZIP compress pipe getOut try JENKINS 9540 in case the reading side failed report that error first future get return future2 get catch ExecutionException e throw new IOException e else remote local copy final Pipe pipe Pipe createRemoteToLocal Future Integer future actAsync new SecureFileCallable Integer private static final long serialVersionUID 1L public Integer invoke File f VirtualChannel channel throws IOException try OutputStream out pipe getOut return writeToTar f scanner TarCompression GZIP compress out try readFromTar remote description new File target remote TarCompression GZIP extract pipe getIn catch IOException e BuildException or IOException try future get 3 TimeUnit SECONDS throw e the remote side completed successfully so the error must be local catch ExecutionException x report both errors throw new IOException Functions printThrowable e x catch TimeoutException remote is hanging throw e try return future get catch ExecutionException e throw new IOException e public int tar OutputStream out final String glob throws IOException InterruptedException return archive ArchiverFactory TAR out glob public int tar OutputStream out FileFilter filter throws IOException InterruptedException return archive ArchiverFactory TAR out filter public int tar OutputStream out DirScanner scanner throws IOException InterruptedException return archive ArchiverFactory TAR out scanner private Integer writeToTar File baseDir DirScanner scanner OutputStream out throws IOException Archiver tw ArchiverFactory TAR create out try scanner scan baseDir reading tw finally tw close return tw countEntries private void readFromTar String name File baseDir InputStream in throws IOException TarInputStream t new TarInputStream in try TarArchiveInputStream t new TarArchiveInputStream in TarArchiveEntry te while te t getNextTarEntry null File f new File baseDir te getName if te isDirectory mkdirs f else File parent f getParentFile if parent null mkdirs parent writing f if te isSymbolicLink new FilePath f symlinkTo te getLinkName TaskListener NULL else IOUtils copy t f f setLastModified te getModTime getTime int mode te getMode 0777 if mode 0 Functions isWindows be defensive chmod f mode catch IOException e throw new IOException Failed to extract name e catch InterruptedException e Thread currentThread interrupt process this later throw new IOException Failed to extract name e public Launcher createLauncher TaskListener listener throws IOException InterruptedException if channel null return new LocalLauncher listener else return new RemoteLauncher listener channel channel call new IsUnix private static final class IsUnix extends MasterToSlaveCallable Boolean IOException public Boolean call throws IOException return File pathSeparatorChar private static final long serialVersionUID 1L Deprecated public String validateAntFileMask final String fileMasks throws IOException InterruptedException return validateAntFileMask fileMasks Integer MAX VALUE public String validateAntFileMask final String fileMasks final int bound throws IOException InterruptedException return validateAntFileMask fileMasks bound true public static int VALIDATE ANT FILE MASK BOUND SystemProperties getInteger FilePath class getName VALIDATE ANT FILE MASK BOUND 10000 public String validateAntFileMask final String fileMasks final int bound final boolean caseSensitive throws IOException InterruptedException return act new MasterToSlaveFileCallable String private static final long serialVersionUID 1 public String invoke File dir VirtualChannel channel throws IOException InterruptedException if fileMasks startsWith return Messages FilePath TildaDoesntWork StringTokenizer tokens new StringTokenizer fileMasks while tokens hasMoreTokens final String fileMask tokens nextToken trim if hasMatch dir fileMask caseSensitive continue no error on this portion JENKINS 5253 if we can get some match in case insensitive mode and user requested case sensitive match notify the user if caseSensitive hasMatch dir fileMask false return Messages FilePath validateAntFileMask matchWithCaseInsensitive fileMask in 1 172 we introduced an incompatible change to stop using as the separator so see if we can match by using as the separator if fileMask contains boolean matched true for String token Util tokenize fileMask matched hasMatch dir token caseSensitive if matched return Messages FilePath validateAntFileMask whitespaceSeprator a common mistake is to assume the wrong base dir and there are two variations to this 1 the user gave us aa bb cc dd where cc dd was correct and 2 the user gave us cc dd where aa bb cc dd was correct check the 1 above first String f fileMask while true int idx findSeparator f if idx 1 break f f substring idx 1 if hasMatch dir f caseSensitive return Messages FilePath validateAntFileMask doesntMatchAndSuggest fileMask f check the 2 above next as this is more expensive Try prepending to see if that results in a match FileSet fs Util createFileSet reading dir fileMask fs setCaseSensitive caseSensitive DirectoryScanner ds fs getDirectoryScanner new Project if ds getIncludedFilesCount 0 try shorter name first so that the suggestion results in least amount of changes String names ds getIncludedFiles Arrays sort names SHORTER STRING FIRST for String f names now we want to decompose f to the leading portion that matched and the trailing portion that matched the file mask so that we can suggest the user error this is not a very efficient clever way to do it but it s relatively simple String prefix while true int idx findSeparator f if idx 1 break prefix f substring 0 idx f f substring idx 1 if hasMatch dir prefix fileMask caseSensitive return Messages FilePath validateAntFileMask doesntMatchAndSuggest fileMask prefix fileMask finally see if we can identify any sub portion that s valid Otherwise bail out String previous null String pattern fileMask while true if hasMatch dir pattern caseSensitive found a match if previous null return Messages FilePath validateAntFileMask portionMatchAndSuggest fileMask pattern else return Messages FilePath validateAntFileMask portionMatchButPreviousNotMatchAndSuggest fileMask pattern previous int idx findSeparator pattern if idx 0 no more path component left to go back if pattern equals fileMask return Messages FilePath validateAntFileMask doesntMatchAnything fileMask else return Messages FilePath validateAntFileMask doesntMatchAnythingAndSuggest fileMask pattern cut off the trailing component and try again previous pattern pattern pattern substring 0 idx return null no error private boolean hasMatch File dir String pattern boolean bCaseSensitive throws InterruptedException class Cancel extends RuntimeException DirectoryScanner ds bound Integer MAX VALUE new DirectoryScanner new DirectoryScanner int ticks long start System currentTimeMillis Override public synchronized boolean isCaseSensitive if filesIncluded isEmpty dirsIncluded isEmpty ticks bound System currentTimeMillis start 5000 throw new Cancel filesNotIncluded clear dirsNotIncluded clear notFollowedSymlinks might be large but probably unusual scannedDirs will typically be largish but seems to be needed return super isCaseSensitive ds setBasedir reading dir ds setIncludes new String pattern ds setCaseSensitive bCaseSensitive try ds scan catch Cancel c if ds getIncludedFilesCount 0 ds getIncludedDirsCount 0 return true else throw new InterruptedException no matches found within bound return ds getIncludedFilesCount 0 ds getIncludedDirsCount 0 private int findSeparator String pattern int idx1 pattern indexOf int idx2 pattern indexOf if idx1 1 return idx2 if idx2 1 return idx1 return Math min idx1 idx2 private static final UrlFactory DEFAULT URL FACTORY new UrlFactory Restricted NoExternalUse class static class UrlFactory public URL newURL String location throws MalformedURLException return new URL location private UrlFactory urlFactory VisibleForTesting Restricted NoExternalUse class void setUrlFactory UrlFactory urlFactory this urlFactory urlFactory private UrlFactory getUrlFactory if urlFactory null return urlFactory else return DEFAULT URL FACTORY public static FormValidation validateFileMask CheckForNull FilePath path String value throws IOException return FilePath validateFileMask path value true public static FormValidation validateFileMask CheckForNull FilePath path String value boolean caseSensitive throws IOException if path null return FormValidation ok return path validateFileMask value true caseSensitive public FormValidation validateFileMask String value throws IOException return validateFileMask value true true public FormValidation validateFileMask String value boolean errorIfNotExist throws IOException return validateFileMask value errorIfNotExist true public FormValidation validateFileMask String value boolean errorIfNotExist boolean caseSensitive throws IOException checkPermissionForValidate value fixEmpty value if value null return FormValidation ok try if exists no workspace can t check return FormValidation ok String msg validateAntFileMask value VALIDATE ANT FILE MASK BOUND caseSensitive if errorIfNotExist return FormValidation error msg else return FormValidation warning msg catch InterruptedException e return FormValidation ok Messages FilePath did not manage to validate may be too sl value public FormValidation validateRelativePath String value boolean errorIfNotExist boolean expectingFile throws IOException checkPermissionForValidate value fixEmpty value none entered yet or something is seriously wrong if value null return FormValidation ok a common mistake is to use wildcard if value contains return FormValidation error Messages FilePath validateRelativePath wildcardNotAllowed try if exists no base directory can t check return FormValidation ok FilePath path child value if path exists if expectingFile if path isDirectory return FormValidation ok else return FormValidation error Messages FilePath validateRelativePath notFile value else if path isDirectory return FormValidation ok else return FormValidation error Messages FilePath validateRelativePath notDirectory value String msg expectingFile Messages FilePath validateRelativePath noSuchFile value Messages FilePath validateRelativePath noSuchDirectory value if errorIfNotExist return FormValidation error msg else return FormValidation warning msg catch InterruptedException e return FormValidation ok private static void checkPermissionForValidate AccessControlled subject Stapler getCurrentRequest findAncestorObject AbstractProject class if subject null Jenkins getInstance checkPermission Jenkins ADMINISTER else subject checkPermission Item CONFIGURE public FormValidation validateRelativeDirectory String value boolean errorIfNotExist throws IOException return validateRelativePath value errorIfNotExist false public FormValidation validateRelativeDirectory String value throws IOException return validateRelativeDirectory value true Deprecated Override public String toString to make writing JSPs easily return local return remote public VirtualChannel getChannel if channel null return channel else return localChannel public boolean isRemote return channel null private void writeObject ObjectOutputStream oos throws IOException Channel target Channel current if channel null channel target throw new IllegalStateException Can t send a remote FilePath to a different remote channel oos defaultWriteObject oos writeBoolean channel null private void readObject ObjectInputStream ois throws IOException ClassNotFoundException Channel channel Channel current assert channel null ois defaultReadObject if ois readBoolean this channel channel this filter null else this channel null If the remote channel wants us to create a FilePath that points to a local file we need to make sure the access control takes place This covers the immediate case of FileCallables taking FilePath into reference closure implicitly but it also covers more general case of FilePath sent as a return value or argument this filter SoloFilePathFilter wrap FilePathFilter current private static final long serialVersionUID 1L public static int SIDE BUFFER SIZE 1024 private static final Logger LOGGER Logger getLogger FilePath class getName private class FileCallableWrapper T implements DelegatingCallable T IOException private final FileCallable T callable private transient ClassLoader classLoader public FileCallableWrapper FileCallable T callable this callable callable this classLoader callable getClass getClassLoader private FileCallableWrapper FileCallable T callable ClassLoader classLoader this callable callable this classLoader classLoader public T call throws IOException try return callable invoke new File remote Channel current catch InterruptedException e throw new TunneledInterruptedException e Override public void checkRoles RoleChecker checker throws SecurityException callable checkRoles checker public ClassLoader getClassLoader return classLoader private static final long serialVersionUID 1L private static class TunneledInterruptedException extends IOException private TunneledInterruptedException InterruptedException cause super cause private static final long serialVersionUID 1L private static final Comparator String SHORTER STRING FIRST new Comparator String public int compare String o1 String o2 return o1 length o2 length public static FilePath getHomeDirectory VirtualChannel ch throws InterruptedException IOException return ch call new MasterToSlaveCallable FilePath IOException public FilePath call throws IOException return new FilePath new File System getProperty user home public static final class ExplicitlySpecifiedDirScanner extends DirScanner private static final long serialVersionUID 1 private final Map String String files public ExplicitlySpecifiedDirScanner Map String String files this files files Override public void scan File dir FileVisitor visitor throws IOException for Map Entry String String entry files entrySet String archivedPath entry getKey assert archivedPath indexOf 1 String workspacePath entry getValue assert workspacePath indexOf 1 scanSingle new File dir workspacePath archivedPath visitor private static final ExecutorService threadPoolForRemoting new ContextResettingExecutorService Executors newCachedThreadPool new ExceptionCatchingThreadFactory new NamingThreadFactory new DaemonThreadFactory FilePath localPool public static final LocalChannel localChannel new LocalChannel threadPoolForRemoting private Nonnull SoloFilePathFilter filterNonNull return filter null filter UNRESTRICTED private FileVisitor reading final FileVisitor v final FilePathFilter filter FilePathFilter current if filter null return v return new FileVisitor Override public void visit File f String relativePath throws IOException filter read f v visit f relativePath Override public void visitSymlink File link String target String relativePath throws IOException filter read link v visitSymlink link target relativePath Override public boolean understandsSymlink return v understandsSymlink private File reading File f filterNonNull read f return f private File stating File f filterNonNull stat f return f private File creating File f filterNonNull create f return f private File writing File f FilePathFilter filter filterNonNull if f exists filter create f filter write f return f private File symlinking File f FilePathFilter filter filterNonNull if f exists filter create f filter symlink f return f private File deleting File f filterNonNull delete f return f private boolean mkdirs File dir if dir exists return false filterNonNull mkdirs dir return dir mkdirs private File mkdirsE File dir throws IOException if dir exists return dir filterNonNull mkdirs dir return IOUtils mkdirs dir private static final SoloFilePathFilter UNRESTRICTED SoloFilePathFilter wrap FilePathFilter UNRESTRICTEDpackage jenkins import hudson FilePath import hudson remoting Channel import hudson remoting ChannelBuilder import jenkins security ChannelConfigurator import javax annotation CheckForNull import java io File public abstract class FilePathFilter public boolean read File f throws SecurityException return false public boolean write File f throws SecurityException return false public boolean symlink File f throws SecurityException return false public boolean mkdirs File f throws SecurityException return false public boolean create File f throws SecurityException return false public boolean delete File f throws SecurityException return false public boolean stat File f throws SecurityException return false public final void installTo ChannelBuilder cb installTo cb FilePathFilterAggregator DEFAULT ORDINAL public final void installTo ChannelBuilder cb double d synchronized cb FilePathFilterAggregator filters FilePathFilterAggregator cb getProperties get FilePathFilterAggregator KEY if filters null filters new FilePathFilterAggregator cb withProperty FilePathFilterAggregator KEY filters filters add this d public final void uninstallFrom Channel ch synchronized ch FilePathFilterAggregator filters ch getProperty FilePathFilterAggregator KEY if filters null filters remove this public static CheckForNull FilePathFilter current Channel ch Channel current if ch null return null return ch getProperty FilePathFilterAggregator KEY public static final FilePathFilter UNRESTRICTED new FilePathFilterAggregator Override protected boolean defaultAction throws SecurityException return true Override public void add FilePathFilter f double d noop because we are immutable Override public String toString return Unrestrictedpackage jenkins import hudson Extension import hudson FilePath import hudson remoting ChannelProperty import java io File import java util Collections import java util concurrent CopyOnWriteArrayList class FilePathFilterAggregator extends FilePathFilter private final CopyOnWriteArrayList Entry all new CopyOnWriteArrayList Entry private class Entry implements Comparable Entry final FilePathFilter filter final double ordinal private Entry FilePathFilter filter double ordinal this filter filter this ordinal ordinal Override public int compareTo Entry that double d this ordinal that ordinal if d 0 return 1 if d 0 return 1 to create predictable order that doesn t depend on the insertion order use class name to break a tie return this filter getClass getName compareTo that filter getClass getName public final void add FilePathFilter f add f DEFAULT ORDINAL public void add FilePathFilter f double ordinal Entry e new Entry f ordinal int i Collections binarySearch all e Collections reverseOrder if i 0 all add i e else all add i 1 e public void remove FilePathFilter f for Entry e all if e filter f all remove e protected boolean defaultAction throws SecurityException return false Override public boolean read File f throws SecurityException for Entry e all if e filter read f return true return defaultAction Override public boolean mkdirs File f throws SecurityException for Entry e all if e filter mkdirs f return true return defaultAction Override public boolean write File f throws SecurityException for Entry e all if e filter write f return true return defaultAction Override public boolean symlink File f throws SecurityException for Entry e all if e filter symlink f return true return defaultAction Override public boolean create File f throws SecurityException for Entry e all if e filter create f return true return defaultAction Override public boolean delete File f throws SecurityException for Entry e all if e filter delete f return true return defaultAction Override public boolean stat File f throws SecurityException for Entry e all if e filter stat f return true return defaultAction Override public String toString return FilePathFilterAggregator all static final ChannelProperty FilePathFilterAggregator KEY new ChannelProperty FilePathFilterAggregator FilePathFilterAggregator class FilePathFilters public static final int DEFAULT ORDINAL 0package jenkins mvn import hudson EnvVars import hudson Extension import hudson FilePath import hudson Util import hudson model AbstractBuild import hudson model TaskListener import hudson util IOUtils import java io File import org apache commons lang StringUtils import org kohsuke stapler DataBoundConstructor public class FilePathGlobalSettingsProvider extends GlobalSettingsProvider private final String path DataBoundConstructor public FilePathGlobalSettingsProvider String path this path path public String getPath return path Override public FilePath supplySettings AbstractBuild build TaskListener listener if StringUtils isEmpty path return null try EnvVars env build getEnvironment listener String targetPath Util replaceMacro this path build getBuildVariableResolver targetPath env expand targetPath if IOUtils isAbsolute targetPath return new FilePath new File targetPath else FilePath mrSettings build getModuleRoot child targetPath FilePath wsSettings build getWorkspace child targetPath try if wsSettings exists mrSettings exists wsSettings mrSettings catch Exception e throw new IllegalStateException failed to find settings xml at wsSettings getRemote return wsSettings catch Exception e throw new IllegalStateException failed to prepare global settings xml Extension ordinal 10 public static class DescriptorImpl extends GlobalSettingsProviderDescriptor Override public String getDisplayName return Messages FilePathGlobalSettingsProvider DisplayNamepackage jenkins security s2m import hudson FilePath import java util regex Pattern class FilePathRule final Pattern path final OpMatcher op final boolean allow FilePathRule Pattern path OpMatcher op boolean allow this path path this op op this allow allowpackage jenkins security s2m import com google common collect ImmutableList import com google common collect ImmutableSet import hudson Functions import hudson model Failure import jenkins model Jenkins import java io File import java util ArrayList import java util List import java util regex Matcher import java util regex Pattern import static hudson Functions isWindows class FilePathRuleConfig extends ConfigDirectory FilePathRule List FilePathRule FilePathRuleConfig File file super file Override protected List FilePathRule create return new ArrayList FilePathRule Override protected List FilePathRule readOnly List FilePathRule base return ImmutableList copyOf base Override protected FilePathRule parse String line line line trim if line isEmpty return null line line replace BUILDDIR JOBDIR builds BUILDID line line replace BUILDID 0 9 0 9 0 9 0 9 0 9 0 9 0 9 0 9 0 9 0 9 0 9 0 9 0 9 0 9 0 9 line line replace JOBDIR JENKINS HOME jobs line line replace JENKINS HOME Q Jenkins getInstance getRootDir getPath E config file is always separated even on Windows so bring it back to separation This is done in the context of regex so it has to be which means in the source code it is if isWindows line line replace Matcher m PARSER matcher line if m matches throw new Failure Invalid filter rule line line try return new FilePathRule Pattern compile m group 3 createOpMatcher m group 2 m group 1 equals allow catch Exception e throw new Failure Invalid filter rule line line n Functions printThrowable e private OpMatcher createOpMatcher String token if token equals all return OpMatcher ALL final ImmutableSet ops ImmutableSet copyOf token split return new OpMatcher Override public boolean matches String op return ops contains op public boolean checkFileAccess String op File path throws SecurityException String pathStr null for FilePathRule rule get if rule op matches op if pathStr null do not canonicalize so that JENKINS HOME that spans across multiple volumes via symlinks can look logically like one unit pathStr path getPath if isWindows Windows accepts as separator but for rule matching we want to normalize for consistent comparison pathStr pathStr replace if rule path matcher pathStr matches exclusion rule is only to bypass later path rules within filePathRules and we still want other FilePathFilters to whitelist blacklist access therefore I m not throwing a SecurityException here return rule allow return false private static final Pattern PARSER Pattern compile allow deny s a z spackage jenkins mvn import hudson EnvVars import hudson Extension import hudson FilePath import hudson Util import hudson model AbstractBuild import hudson model TaskListener import hudson util IOUtils import java io File import org apache commons lang StringUtils import org jenkinsci Symbol import org kohsuke stapler DataBoundConstructor public class FilePathSettingsProvider extends SettingsProvider private final String path DataBoundConstructor public FilePathSettingsProvider String path this path path public String getPath return path Override public FilePath supplySettings AbstractBuild build TaskListener listener if StringUtils isEmpty path return null try EnvVars env build getEnvironment listener String targetPath Util replaceMacro this path build getBuildVariableResolver targetPath env expand targetPath if IOUtils isAbsolute targetPath return new FilePath new File targetPath else FilePath mrSettings build getModuleRoot child targetPath FilePath wsSettings build getWorkspace child targetPath try if wsSettings exists mrSettings exists wsSettings mrSettings catch Exception e throw new IllegalStateException failed to find settings xml at wsSettings getRemote return wsSettings catch Exception e throw new IllegalStateException failed to prepare settings xml Extension ordinal 10 Symbol filePath public static class DescriptorImpl extends SettingsProviderDescriptor Override public String getDisplayName return Messages FilePathSettingsProvider DisplayNamepackage hudson import hudson FilePath TarCompression import hudson model AbstractBuild import hudson model AbstractProject import hudson model Computer import hudson model Describable import hudson model Job import hudson model TaskListener import hudson util io ArchiverFactory import jenkins model Jenkins import hudson model listeners RunListener import hudson scm SCM import org jenkinsci Symbol import java io BufferedOutputStream import java io File import java io FileOutputStream import java io IOException import java io OutputStream public abstract class FileSystemProvisioner implements ExtensionPoint Describable FileSystemProvisioner public abstract void prepareWorkspace AbstractBuild build FilePath ws TaskListener listener throws IOException InterruptedException public abstract void discardWorkspace AbstractProject project FilePath ws throws IOException InterruptedException public abstract void moveWorkspace AbstractProject project File oldWorkspace File newWorkspace throws IOException public abstract WorkspaceSnapshot snapshot AbstractBuild build FilePath ws String glob TaskListener listener throws IOException InterruptedException public FileSystemProvisionerDescriptor getDescriptor return FileSystemProvisionerDescriptor Jenkins getInstance getDescriptorOrDie getClass public static final FileSystemProvisioner DEFAULT new Default public static DescriptorExtensionList FileSystemProvisioner FileSystemProvisionerDescriptor all return Jenkins getInstance FileSystemProvisioner FileSystemProvisionerDescriptor getDescriptorList FileSystemProvisioner class public static final class Default extends FileSystemProvisioner public void prepareWorkspace AbstractBuild build FilePath ws TaskListener listener throws IOException InterruptedException public void discardWorkspace AbstractProject project FilePath ws throws IOException InterruptedException Deprecated public WorkspaceSnapshot snapshot AbstractBuild build FilePath ws TaskListener listener throws IOException InterruptedException return snapshot build ws public WorkspaceSnapshot snapshot AbstractBuild build FilePath ws String glob TaskListener listener throws IOException InterruptedException File wss new File build getRootDir workspace tgz try OutputStream os new BufferedOutputStream new FileOutputStream wss ws archive ArchiverFactory TARGZ os glob return new WorkspaceSnapshotImpl public static final class WorkspaceSnapshotImpl extends WorkspaceSnapshot public void restoreTo AbstractBuild owner FilePath dst TaskListener listener throws IOException InterruptedException File zip new File owner getRootDir workspace zip if zip exists we used to keep it in zip new FilePath zip unzip dst else but since 1 456 we do tgz File tgz new File owner getRootDir workspace tgz new FilePath tgz untar dst TarCompression GZIP Extension Symbol standard public static final class DescriptorImpl extends FileSystemProvisionerDescriptor public boolean discard FilePath ws TaskListener listener throws IOException InterruptedException the default provisioner does not do anything special so allow other types to manage it return false public String getDisplayName return Defaultpackage hudson import hudson model Descriptor import hudson model TaskListener import java io IOException public abstract class FileSystemProvisionerDescriptor extends Descriptor FileSystemProvisioner implements ExtensionPoint public abstract boolean discard FilePath ws TaskListener listener throws IOException InterruptedExceptionpackage com twitter sdk android tweetcomposer import android annotation TargetApi import android content ContentResolver import android content Context import android database Cursor import android net Uri import android os Build import android provider DocumentsContract import android provider MediaStore import android text TextUtils import android webkit MimeTypeMap import java io File class FileUtils private static final String MEDIA SCHEME com android providers media documents TargetApi Build VERSION CODES KITKAT static String getPath final Context context final Uri uri final boolean isKitKat Build VERSION SDK INT Build VERSION CODES KITKAT if isKitKat isMediaDocumentAuthority uri final String documentId DocumentsContract getDocumentId uri e g image 1234 final String parts documentId split final String type parts 0 Uri contentUri if image equals type contentUri MediaStore Images Media EXTERNAL CONTENT URI else reject video or audio documents return null query content resolver for MediaStore id column final String selection id final String args new String parts 1 return resolveFilePath context contentUri selection args else if isContentScheme uri return resolveFilePath context uri null null else if isFileScheme uri return uri getPath return null public static boolean isMediaDocumentAuthority Uri uri return MEDIA SCHEME equalsIgnoreCase uri getAuthority public static boolean isContentScheme Uri uri return ContentResolver SCHEME CONTENT equalsIgnoreCase uri getScheme public static boolean isFileScheme Uri uri return ContentResolver SCHEME FILE equalsIgnoreCase uri getScheme static String resolveFilePath Context context Uri uri String selection String args Cursor cursor null final String projection MediaStore Images Media DATA try cursor context getContentResolver query uri projection selection args null if cursor null cursor moveToFirst final int i cursor getColumnIndexOrThrow MediaStore Images Media DATA return cursor getString i finally if cursor null cursor close return null static String getMimeType File file final String ext getExtension file getName if TextUtils isEmpty ext return MimeTypeMap getSingleton getMimeTypeFromExtension ext default from https dev twitter com rest public uploading media return application octet stream static String getExtension String filename if filename null return null final int i filename lastIndexOf return i 0 filename substring i 1package hudson util import java io File import java io FileFilter import java io IOException import java io Serializable public abstract class FileVisitor public abstract void visit File f String relativePath throws IOException public void visitSymlink File link String target String relativePath throws IOException visit link relativePath public boolean understandsSymlink return false public final FileVisitor with FileFilter f if f null return this return new FilterFileVisitor f this private static final class FilterFileVisitor extends FileVisitor implements Serializable private final FileFilter filter private final FileVisitor visitor private FilterFileVisitor FileFilter filter FileVisitor visitor this filter filter null filter PASS THROUGH this visitor visitor public void visit File f String relativePath throws IOException if f isDirectory filter accept f visitor visit f relativePath private static final FileFilter PASS THROUGH new FileFilter public boolean accept File pathname return true private static final long serialVersionUID 1Lpackage jenkins util xml import org jaxen Function import org jaxen FunctionContext import org jaxen UnresolvableException import org jaxen XPathFunctionContext import org kohsuke accmod Restricted import org kohsuke accmod restrictions NoExternalUse import java util Arrays import java util Collections import java util HashSet import java util Locale import java util Set Restricted NoExternalUse class public class FilteredFunctionContext implements FunctionContext private static final Set String DEFAULT ILLEGAL FUNCTIONS Collections unmodifiableSet new HashSet String Arrays asList document private final FunctionContext base private final Set String illegalFunctions public FilteredFunctionContext Set String illegalFunctions this illegalFunctions illegalFunctions base XPathFunctionContext getInstance public FilteredFunctionContext this DEFAULT ILLEGAL FUNCTIONS Override public Function getFunction String namespaceURI String prefix String localName throws UnresolvableException if localName null illegalFunctions contains localName toLowerCase Locale ENGLISH throw new UnresolvableException Illegal function localName return base getFunction namespaceURI prefix localNamepackage hudson model import com google common collect ImmutableList import com infradna tool bridge method injector WithBridgeMethods import com thoughtworks xstream converters Converter import com thoughtworks xstream converters MarshallingContext import com thoughtworks xstream converters UnmarshallingContext import com thoughtworks xstream converters basic DateConverter import com thoughtworks xstream converters collections CollectionConverter import com thoughtworks xstream io HierarchicalStreamReader import com thoughtworks xstream io HierarchicalStreamWriter import hudson Util import hudson XmlFile import hudson BulkChange import hudson Extension import hudson model listeners ItemListener import hudson model listeners SaveableListener import hudson security ACL import hudson security ACLContext import hudson util AtomicFileWriter import hudson util HexBinaryConverter import hudson util Iterators import hudson util PersistedList import hudson util RunList import hudson util XStream2 import java io EOFException import jenkins model FingerprintFacet import jenkins model Jenkins import jenkins model TransientFingerprintFacetFactory import org apache commons lang StringUtils import org kohsuke stapler export Exported import org kohsuke stapler export ExportedBean import java io File import java io IOException import java io PrintWriter import java util AbstractCollection import java util ArrayList import java util Collection import java util Collections import java util Comparator import java util Date import java util Hashtable import java util Iterator import java util List import java util Map import java util Map Entry import java util TreeMap import java util logging Level import java util logging Logger import javax annotation CheckForNull import javax annotation Nonnull import org acegisecurity AccessDeniedException import org acegisecurity Authentication import org xmlpull v1 XmlPullParserException ExportedBean public class Fingerprint implements ModelObject Saveable ExportedBean defaultVisibility 2 public static class BuildPtr String name final int number public BuildPtr String name int number this name name this number number public BuildPtr Run run this run getParent getFullName run getNumber Exported Nonnull public String getName return name private boolean hasPermissionToDiscoverBuild We expose the data to Jenkins administrators in order to let them manage the data for deleted jobs also works for SYSTEM final Jenkins instance Jenkins getInstance if instance hasPermission Jenkins ADMINISTER return true return canDiscoverItem name void setName String newName name newName WithBridgeMethods value AbstractProject class castRequired true public Job getJob return Jenkins getInstance getItemByFullName name Job class Exported Nonnull public int getNumber return number public Run getRun Job j getJob if j null return null return j getBuildByNumber number private boolean isAlive return getRun null public boolean is Run r return r getNumber number r getParent getFullName equals name public boolean is Job job return job getFullName equals name public boolean belongsTo Job job Item p Jenkins getInstance getItemByFullName name while p null if p job return true go up the chain while we ItemGroup extends Item parent p getParent if parent instanceof Item return false p Item parent return false Override public String toString return name number ExportedBean defaultVisibility 4 public static final class Range final int start final int end public Range int start int end assert start end this start start this end end Exported public int getStart return start Exported public int getEnd return end public boolean isSmallerThan int i return end i public boolean isBiggerThan int i return i start public boolean includes int i return start i i end public Range expandRight return new Range start end 1 public Range expandLeft return new Range start 1 end public boolean isAdjacentTo Range that return this end that start Override public String toString return start end public boolean isIndependent Range that return this end that start that end this start public boolean isDisjoint Range that return this end that start that end this start public boolean isSingle return end 1 start public boolean contains Range that return this start that start that end this end public Range combine Range that assert isIndependent that return new Range Math min this start that start Math max this end that end public Range intersect Range that assert isDisjoint that return new Range Math max this start that start Math min this end that end Override public boolean equals Object o if this o return true if o null getClass o getClass return false Range that Range o return start that start end that end Override public int hashCode return 31 start end ExportedBean defaultVisibility 3 public static final class RangeSet sorted private final List Range ranges public RangeSet this new ArrayList Range private RangeSet List Range data this ranges data private RangeSet Range initial this ranges add initial public Iterable Integer listNumbers final List Range ranges getRanges return new Iterable Integer public Iterator Integer iterator return new Iterators FlattenIterator Integer Range ranges protected Iterator Integer expand Range range return Iterators sequence range start range end iterator public J extends Job J R R extends Run J R Iterable R listBuilds final J job return new Iterable R public Iterator R iterator return new Iterators FilterIterator R new AdaptedIterator Integer R listNumbers iterator protected R adapt Integer n return job getBuildByNumber n protected boolean filter R r return r null public Iterable Integer listNumbersReverse final List Range ranges getRanges return new Iterable Integer public Iterator Integer iterator return new Iterators FlattenIterator Integer Range Iterators reverse ranges protected Iterator Integer expand Range range return Iterators reverseSequence range start range end iterator Exported public synchronized List Range getRanges return new ArrayList Range ranges public synchronized void add int n for int i 0 i ranges size i Range r ranges get i if r includes n return already included if r end n ranges set i r expandRight checkCollapse i return if r start n 1 ranges set i r expandLeft checkCollapse i 1 return if r isBiggerThan n needs to insert a single value Range ranges add i new Range n n 1 return ranges add new Range n n 1 public synchronized void addAll int n for int i n add i private void checkCollapse int i if i 0 i ranges size 1 return Range lhs ranges get i Range rhs ranges get i 1 if lhs isAdjacentTo rhs collapsed Range r new Range lhs start rhs end ranges set i r ranges remove i 1 public synchronized boolean includes int i for Range r ranges if r includes i return true return false public synchronized void add RangeSet that int lhs 0 rhs 0 while lhs this ranges size rhs that ranges size Range lr this ranges get lhs Range rr that ranges get rhs no overlap if lr end rr start lhs continue if rr end lr start ranges add lhs rr lhs rhs continue overlap merge two Range m lr combine rr rhs since ranges lhs is expanded it might overlap with others in this ranges while lhs 1 this ranges size m isIndependent this ranges get lhs 1 m m combine this ranges get lhs 1 this ranges remove lhs 1 this ranges set lhs m if anything is left in that ranges add them all this ranges addAll that ranges subList rhs that ranges size public synchronized boolean retainAll RangeSet that List Range intersection new ArrayList Range int lhs 0 rhs 0 while lhs this ranges size rhs that ranges size Range lr this ranges get lhs Range rr that ranges get rhs if lr end rr start lr has no overlap with that ranges lhs continue if rr end lr start rr has no overlap with this ranges rhs continue overlap figure out the intersection Range v lr intersect rr intersection add v move on to the next pair if lr end rr end lhs else rhs boolean same this ranges equals intersection if same this ranges clear this ranges addAll intersection return true else return false public synchronized boolean removeAll RangeSet that boolean modified false List Range sub new ArrayList Range int lhs 0 rhs 0 while lhs this ranges size rhs that ranges size Range lr this ranges get lhs Range rr that ranges get rhs if lr end rr start lr has no overlap with that ranges lr stays sub add lr lhs continue if rr end lr start rr has no overlap with this ranges rhs continue some overlap between lr and rr assert lr isDisjoint rr modified true if rr contains lr lr completely removed by rr lhs continue we want to look at A and B below if they are non null lr rr A B note that lr and rr could be something like or the other way around lr rr A no B if lr start rr start if A is non empty that will stay Range a new Range lr start rr start sub add a if rr end lr end if B is non empty we still need to check that with that ranges so keep it in the place of lr how much of them will eventually stay is up to the remainder of that ranges this ranges set lhs new Range rr end lr end rhs else if B is empty we are done considering lr lhs if modified return false no changes whatever that remains in lhs will survive sub addAll this ranges subList lhs this ranges size this ranges clear this ranges addAll sub return true Override public synchronized String toString StringBuilder buf new StringBuilder for Range r ranges if buf length 0 buf append buf append r return buf toString Override public boolean equals Object o if this o return true if o null getClass o getClass return false return ranges equals RangeSet o ranges Override public int hashCode return ranges hashCode public synchronized boolean isEmpty return ranges isEmpty public synchronized int min return ranges get 0 start public synchronized int max return ranges get ranges size 1 end public synchronized boolean isSmallerThan int n if ranges isEmpty return true return ranges get ranges size 1 isSmallerThan n public static RangeSet fromString String list boolean skipError RangeSet rs new RangeSet Reject malformed ranges like 1 10 1 3 etc if list contains list contains if skipError throw new IllegalArgumentException String format Unable to parse s expected correct notation M N or M N list ignore malformed notation return rs String items Util tokenize list if items length 1 items length StringUtils countMatches list if skipError throw new IllegalArgumentException String format Unable to parse s expected correct notation M N or M N list ignore malformed notation like 1 2 or 1 2 return rs for String s items s s trim s is either single number or range x y note that the end range is inclusive in this notation but not in the Range class try if s isEmpty if skipError throw new IllegalArgumentException String format Unable to parse s expected number list ignore element continue if s contains if StringUtils countMatches s 1 if skipError throw new IllegalArgumentException String format Unable to parse s expected correct notation M N or M N list ignore malformed ranges like 5 2 or 2 5 continue String tokens Util tokenize s if tokens length 2 int left Integer parseInt tokens 0 int right Integer parseInt tokens 1 if left 0 right 0 if skipError throw new IllegalArgumentException String format Unable to parse s expected number above zero list ignore a range which starts or ends under zero like 5 3 continue if left right if skipError throw new IllegalArgumentException String format Unable to parse s expected string with a range M N where M N list ignore inverse range like 10 5 continue rs ranges add new Range left right 1 else if skipError throw new IllegalArgumentException String format Unable to parse s expected string with a range M N list ignore malformed text like 1 10 50 continue else int n Integer parseInt s rs ranges add new Range n n 1 catch NumberFormatException e if skipError throw new IllegalArgumentException String format Unable to parse s expected number list ignore malformed text return rs static final class ConverterImpl implements Converter private final Converter collectionConv used to convert ArrayList in it public ConverterImpl Converter collectionConv this collectionConv collectionConv public boolean canConvert Class type return type RangeSet class public void marshal Object source HierarchicalStreamWriter writer MarshallingContext context RangeSet src RangeSet source writer setValue serialize src static String serialize RangeSet src StringBuilder buf new StringBuilder src ranges size 10 for Range r src ranges if buf length 0 buf append if r isSingle buf append r start else buf append r start append append r end 1 return buf toString public Object unmarshal HierarchicalStreamReader reader final UnmarshallingContext context if reader hasMoreChildren return new RangeSet List Range collectionConv unmarshal reader context else return RangeSet fromString reader getValue true Extension public static final class ProjectRenameListener extends ItemListener Override public void onLocationChanged final Item item final String oldName final String newName try ACLContext ACL as ACL SYSTEM locationChanged item oldName newName private void locationChanged Item item String oldName String newName if item instanceof AbstractProject AbstractProject p Jenkins getInstance getItemByFullName newName AbstractProject class if p null RunList builds p getBuilds for Object build builds if build instanceof AbstractBuild Collection Fingerprint fingerprints AbstractBuild build getBuildFingerprints for Fingerprint f fingerprints try f rename oldName newName catch IOException e logger log Level WARNING Failed to update fingerprint record f getFileName when oldName was renamed to newName e private static final DateConverter DATE CONVERTER new DateConverter private final Nonnull Date timestamp private final CheckForNull BuildPtr original private final byte md5sum private final String fileName private final Hashtable String RangeSet usages new Hashtable String RangeSet PersistedList FingerprintFacet facets new PersistedList FingerprintFacet this private transient volatile List FingerprintFacet transientFacets null public Fingerprint CheckForNull Run build Nonnull String fileName Nonnull byte md5sum throws IOException this build null null new BuildPtr build fileName md5sum save Fingerprint CheckForNull BuildPtr original Nonnull String fileName Nonnull byte md5sum this original original this md5sum md5sum this fileName fileName this timestamp new Date Exported public CheckForNull BuildPtr getOriginal if original null original hasPermissionToDiscoverBuild return original return null public Nonnull String getDisplayName return fileName Exported public Nonnull String getFileName return fileName Exported name hash public Nonnull String getHashString return Util toHexString md5sum Exported public Nonnull Date getTimestamp return timestamp public Nonnull String getTimestampString long duration System currentTimeMillis timestamp getTime return Util getPastTimeString duration public Nonnull RangeSet getRangeSet String jobFullName RangeSet r usages get jobFullName if r null r new RangeSet return r public RangeSet getRangeSet Job job return getRangeSet job getFullName public Nonnull List String getJobs List String r new ArrayList String r addAll usages keySet Collections sort r return r public Nonnull Hashtable String RangeSet getUsages return usages ExportedBean defaultVisibility 2 public static final class RangeItem Exported public final String name Exported public final RangeSet ranges public RangeItem String name RangeSet ranges this name name this ranges ranges this is for remote API Exported name usage public Nonnull List RangeItem getUsages List RangeItem r new ArrayList RangeItem final Jenkins instance Jenkins getInstance for Entry String RangeSet e usages entrySet final String itemName e getKey if instance hasPermission Jenkins ADMINISTER canDiscoverItem itemName r add new RangeItem itemName e getValue return r Deprecated public synchronized void add Nonnull AbstractBuild b throws IOException addFor Run b public synchronized void addFor Nonnull Run b throws IOException add b getParent getFullName b getNumber public synchronized void add Nonnull String jobFullName int n throws IOException addWithoutSaving jobFullName n save void addWithoutSaving Nonnull String jobFullName int n synchronized usages TODO why not synchronized this like some though not all other accesses RangeSet r usages get jobFullName if r null r new RangeSet usages put jobFullName r r add n public synchronized boolean isAlive if original null original isAlive return true for Entry String RangeSet e usages entrySet Job j Jenkins getInstance getItemByFullName e getKey Job class if j null continue Run firstBuild j getFirstBuild if firstBuild null continue int oldest firstBuild getNumber if e getValue isSmallerThan oldest return true return false public synchronized boolean trim throws IOException boolean modified false for Entry String RangeSet e new Hashtable String RangeSet usages entrySet copy because we mutate Job j Jenkins getInstance getItemByFullName e getKey Job class if j null no such job any more recycle the record modified true usages remove e getKey continue Run firstBuild j getFirstBuild if firstBuild null no builds recycle the whole record modified true usages remove e getKey continue RangeSet cur e getValue builds that are around without the keepLog flag on are normally clustered together in terms of build so our basic strategy is to discard everything up to the first ephemeral build except those builds that are marked as kept RangeSet kept new RangeSet Run r firstBuild while r null r isKeepLog kept add r getNumber r r getNextBuild if r null all the build records are permanently kept ones so we ll just have to keep kept out of whatever currently in cur modified cur retainAll kept else otherwise we are ready to discard 0 r number except those marked as kept RangeSet discarding new RangeSet new Range 1 r getNumber discarding removeAll kept modified cur removeAll discarding if cur isEmpty usages remove e getKey modified true if modified if logger isLoggable Level FINE logger log Level FINE Saving trimmed 0 getFingerprintFile md5sum save return modified public Nonnull Collection FingerprintFacet getFacets if transientFacets null List FingerprintFacet transientFacets new ArrayList FingerprintFacet for TransientFingerprintFacetFactory fff TransientFingerprintFacetFactory all fff createFor this transientFacets this transientFacets ImmutableList copyOf transientFacets return new AbstractCollection FingerprintFacet Override public Iterator FingerprintFacet iterator return Iterators sequence facets iterator transientFacets iterator Override public boolean add FingerprintFacet e facets add e return true Override public boolean remove Object o return facets remove o Override public boolean contains Object o return facets contains o transientFacets contains o Override public int size return facets size transientFacets size public Nonnull Collection FingerprintFacet getSortedFacets List FingerprintFacet r new ArrayList FingerprintFacet getFacets Collections sort r new Comparator FingerprintFacet public int compare FingerprintFacet o1 FingerprintFacet o2 long a o1 getTimestamp long b o2 getTimestamp if a b return 1 if a b return 0 return 1 return r public CheckForNull T extends FingerprintFacet T getFacet Class T type for FingerprintFacet f getFacets if type isInstance f return type cast f return null public Nonnull List Action getActions List Action r new ArrayList Action for FingerprintFacet ff getFacets ff createActions r return Collections unmodifiableList r public synchronized void save throws IOException if BulkChange contains this return long start 0 if logger isLoggable Level FINE start System currentTimeMillis File file getFingerprintFile md5sum save file SaveableListener fireOnChange this getConfigFile file if logger isLoggable Level FINE logger fine Saving fingerprint file took System currentTimeMillis start ms void save File file throws IOException if facets isEmpty file getParentFile mkdirs JENKINS 16301 fast path for the common case AtomicFileWriter afw new AtomicFileWriter file try PrintWriter w new PrintWriter afw w println xml version 1 0 encoding UTF 8 w println fingerprint w print timestamp w print DATE CONVERTER toString timestamp w println timestamp if original null w println original w print name w print Util xmlEscape original name w println name w print number w print original number w println number w println original w print md5sum w print Util toHexString md5sum w println md5sum w print fileName w print Util xmlEscape fileName w println fileName w println usages for Map Entry String RangeSet e usages entrySet w println entry w print string w print Util xmlEscape e getKey w println string w print ranges w print RangeSet ConverterImpl serialize e getValue w println ranges w println entry w println usages w println facets w print fingerprint w flush afw commit finally afw abort else Slower fallback that can persist facets getConfigFile file write this public synchronized void rename String oldName String newName throws IOException boolean touched false if original null if original getName equals oldName original setName newName touched true if usages null RangeSet r usages get oldName if r null usages put newName r usages remove oldName touched true if touched save public Api getApi return new Api this private static Nonnull XmlFile getConfigFile Nonnull File file return new XmlFile XSTREAM file private static Nonnull File getFingerprintFile Nonnull byte md5sum assert md5sum length 16 return new File Jenkins getInstance getRootDir fingerprints Util toHexString md5sum 0 1 Util toHexString md5sum 1 1 Util toHexString md5sum 2 md5sum length 2 xml static CheckForNull Fingerprint load Nonnull byte md5sum throws IOException return load getFingerprintFile md5sum static CheckForNull Fingerprint load Nonnull File file throws IOException XmlFile configFile getConfigFile file if configFile exists return null long start 0 if logger isLoggable Level FINE start System currentTimeMillis try Fingerprint f Fingerprint configFile read if logger isLoggable Level FINE logger fine Loading fingerprint file took System currentTimeMillis start ms if f facets null f facets new PersistedList FingerprintFacet f for FingerprintFacet facet f facets facet setOwner f return f catch IOException e if file exists file length 0 Despite the use of AtomicFile there are reports indicating that people often see empty XML file presumably either due to file system corruption perhaps by sudden power loss etc or abnormal program termination generally we don t want to wipe out user data just because we can t load it but if the file size is 0 which is what s reported in HUDSON 2012 then it seems like recovering it silently by deleting the file is not a bad idea logger log Level WARNING Size zero fingerprint Disk corruption 0 configFile file delete return null String parseError messageOfParseException e if parseError null logger log Level WARNING Malformed XML in 0 1 new Object configFile parseError file delete return null logger log Level WARNING Failed to load configFile e throw e private static String messageOfParseException Throwable t if t instanceof XmlPullParserException t instanceof EOFException return t getMessage Throwable t2 t getCause if t2 null return messageOfParseException t2 else return null Override public String toString return Fingerprint original original hash getHashString fileName fileName timestamp DATE CONVERTER toString timestamp usages new TreeMap String RangeSet usages facets facets private static boolean canDiscoverItem Nonnull final String fullName final Jenkins jenkins Jenkins getInstance Fast check to avoid security context switches Item item null try item jenkins getItemByFullName fullName catch AccessDeniedException ex ignore we will fall back later if item null return true Probably it failed due to the missing Item DISCOVER We try to retrieve the job using SYSTEM user and to check permissions manually final Authentication userAuth Jenkins getAuthentication try ACLContext ACL as ACL SYSTEM final Item itemBySystemUser jenkins getItemByFullName fullName if itemBySystemUser null return false To get the item existence fact a user needs Item DISCOVER for the item and Item READ for all container folders boolean canDiscoverTheItem itemBySystemUser getACL hasPermission userAuth Item DISCOVER if canDiscoverTheItem ItemGroup current itemBySystemUser getParent do if current instanceof Item final Item i Item current current i getParent if i getACL hasPermission userAuth Item READ canDiscoverTheItem false else current null while canDiscoverTheItem current null return canDiscoverTheItem private static final XStream2 XSTREAM new XStream2 Nonnull public static XStream2 getXStream return XSTREAM static XSTREAM alias fingerprint Fingerprint class XSTREAM alias range Range class XSTREAM alias ranges RangeSet class XSTREAM registerConverter new HexBinaryConverter 10 XSTREAM registerConverter new RangeSet ConverterImpl new CollectionConverter XSTREAM getMapper Override protected Object createCollection Class type return new ArrayList 10 private static final Logger logger Logger getLogger Fingerprint class getNamepackage hudson model import hudson Extension import hudson ExtensionList import jenkins model Jenkins import org jenkinsci Symbol import java io File import java io FileFilter import java io IOException import java util regex Pattern Extension Symbol fingerprintCleanup public final class FingerprintCleanupThread extends AsyncPeriodicWork public FingerprintCleanupThread super Fingerprint cleanup public long getRecurrencePeriod return DAY public static void invoke getInstance run private static FingerprintCleanupThread getInstance return ExtensionList lookup AsyncPeriodicWork class get FingerprintCleanupThread class public void execute TaskListener listener int numFiles 0 File root new File Jenkins getInstance getRootDir fingerprints File files1 root listFiles LENGTH2DIR FILTER if files1 null for File file1 files1 File files2 file1 listFiles LENGTH2DIR FILTER for File file2 files2 File files3 file2 listFiles FINGERPRINTFILE FILTER for File file3 files3 if check file3 listener numFiles deleteIfEmpty file2 deleteIfEmpty file1 listener getLogger println Cleaned up numFiles records private void deleteIfEmpty File dir String r dir list if r null return can happen in a rare occasion if r length 0 dir delete private boolean check File fingerprintFile TaskListener listener try Fingerprint fp Fingerprint load fingerprintFile if fp null fp isAlive listener getLogger println deleting obsolete fingerprintFile fingerprintFile delete return true else get the fingerprint in the official map so have the changes visible to Jenkins otherwise the mutation made in FingerprintMap can override our trimming listener getLogger println possibly trimming fingerprintFile fp Jenkins getInstance getFingerprint fp getHashString return fp trim catch IOException e e printStackTrace listener error Failed to process fingerprintFile return false private static final FileFilter LENGTH2DIR FILTER new FileFilter public boolean accept File f return f isDirectory f getName length 2 private static final FileFilter FINGERPRINTFILE FILTER new FileFilter private final Pattern PATTERN Pattern compile 0 9a f 28 xml public boolean accept File f return f isFile PATTERN matcher f getName matchespackage hudson tasks import com google common collect ImmutableMap import hudson EnvVars import hudson Extension import hudson FilePath import jenkins MasterToSlaveFileCallable import hudson Launcher import jenkins util SystemProperties import hudson Util import hudson model AbstractBuild import hudson model AbstractProject import hudson model Action import jenkins model DependencyDeclarer import hudson model DependencyGraph import hudson model DependencyGraph Dependency import hudson model Fingerprint import hudson model Fingerprint BuildPtr import hudson model FingerprintMap import hudson model Job import jenkins model Jenkins import hudson model Result import hudson model Run import hudson model TaskListener import hudson remoting VirtualChannel import hudson util FormValidation import hudson util PackedMap import hudson util RunList import net sf json JSONObject import org acegisecurity AccessDeniedException import org apache tools ant DirectoryScanner import org apache tools ant types FileSet import org jenkinsci Symbol import org kohsuke stapler AncestorInPath import org kohsuke stapler DataBoundConstructor import org kohsuke stapler QueryParameter import org kohsuke stapler StaplerRequest import java io File import java io IOException import java io Serializable import java lang ref WeakReference import java util ArrayList import java util HashMap import java util HashSet import java util List import java util ListIterator import java util Map import java util Map Entry import java util Random import java util Set import java util TreeMap import java util logging Level import java util logging Logger import jenkins model RunAction2 import jenkins tasks SimpleBuildStep public class Fingerprinter extends Recorder implements Serializable DependencyDeclarer SimpleBuildStep public static boolean enableFingerprintsInDependencyGraph SystemProperties getBoolean Fingerprinter class getName enableFingerprintsInDependencyGraph private final String targets Deprecated Boolean recordBuildArtifacts DataBoundConstructor public Fingerprinter String targets this targets targets Deprecated public Fingerprinter String targets boolean recordBuildArtifacts this targets this recordBuildArtifacts recordBuildArtifacts public String getTargets return targets Deprecated public boolean getRecordBuildArtifacts return recordBuildArtifacts null recordBuildArtifacts Override public void perform Run build FilePath workspace Launcher launcher TaskListener listener throws InterruptedException try listener getLogger println Messages Fingerprinter Recording Map String String record new HashMap String String EnvVars environment build getEnvironment listener if targets length 0 String expandedTargets environment expand targets record build workspace listener record expandedTargets FingerprintAction fingerprintAction build getAction FingerprintAction class if fingerprintAction null fingerprintAction add record else build addAction new FingerprintAction build record if enableFingerprintsInDependencyGraph Jenkins getInstance rebuildDependencyGraphAsync catch IOException e e printStackTrace listener error Messages Fingerprinter Failed build setResult Result FAILURE failing to record fingerprints is an error but not fatal public BuildStepMonitor getRequiredMonitorService return BuildStepMonitor NONE public void buildDependencyGraph AbstractProject owner DependencyGraph graph if enableFingerprintsInDependencyGraph RunList builds owner getBuilds Set String seenUpstreamProjects new HashSet String for ListIterator iter builds listIterator iter hasNext Run build Run iter next for FingerprintAction action build getActions FingerprintAction class for AbstractProject key action getDependencies keySet if key owner continue Avoid self references AbstractProject p key TODO is this harmful to call unconditionally so it would apply also to MavenModule for example if key getClass getName equals hudson matrix MatrixConfiguration p key getRootProject if seenUpstreamProjects contains p getName continue seenUpstreamProjects add p getName graph addDependency new Dependency p owner Override public boolean shouldTriggerBuild AbstractBuild build TaskListener listener List Action actions Fingerprints should not trigger builds return false private void record Run build FilePath ws TaskListener listener Map String String record final String targets throws IOException InterruptedException final class Record implements Serializable final boolean produced final String relativePath final String fileName final String md5sum public Record boolean produced String relativePath String fileName String md5sum this produced produced this relativePath relativePath this fileName fileName this md5sum md5sum Fingerprint addRecord Run build throws IOException FingerprintMap map Jenkins getInstance getFingerprintMap return map getOrCreate produced build null fileName md5sum private static final long serialVersionUID 1L final long buildTimestamp build getTimeInMillis List Record records ws act new MasterToSlaveFileCallable List Record public List Record invoke File baseDir VirtualChannel channel throws IOException List Record results new ArrayList Record FileSet src Util createFileSet baseDir targets DirectoryScanner ds src getDirectoryScanner for String f ds getIncludedFiles File file new File baseDir f consider the file to be produced by this build only if the timestamp is newer than when the build has started 2000ms is an error margin since since VFAT only retains timestamp at 2sec precision boolean produced buildTimestamp file lastModified 2000 try results add new Record produced f file getName new FilePath file digest catch IOException e throw new IOException Messages Fingerprinter DigestFailed file e catch InterruptedException e throw new IOException Messages Fingerprinter Aborted e return results for Record r records Fingerprint fp r addRecord build if fp null listener error Messages Fingerprinter FailedFor r relativePath continue fp addFor build record put r relativePath fp getHashString Extension Symbol fingerprint public static class DescriptorImpl extends BuildStepDescriptor Publisher public String getDisplayName return Messages Fingerprinter DisplayName Deprecated public FormValidation doCheck AncestorInPath AbstractProject project QueryParameter String value throws IOException return doCheckTargets project value public FormValidation doCheckTargets AncestorInPath AbstractProject project QueryParameter String value throws IOException if project null return FormValidation ok return FilePath validateFileMask project getSomeWorkspace value Override public Publisher newInstance StaplerRequest req JSONObject formData return req bindJSON Fingerprinter class formData public boolean isApplicable Class extends AbstractProject jobType return true public static final class FingerprintAction implements RunAction2 private transient Run build private static final Random rand new Random private PackedMap String String record private transient WeakReference Map String Fingerprint ref public FingerprintAction Run build Map String String record this build build this record compact record Deprecated public FingerprintAction AbstractBuild build Map String String record this Run build record public void add Map String String moreRecords Map String String r new HashMap String String record r putAll moreRecords record compact r ref null public String getIconFileName return fingerprint png public String getDisplayName return Messages Fingerprinter Action DisplayName public String getUrlName return fingerprints public Run getRun return build Deprecated public AbstractBuild getBuild return build instanceof AbstractBuild AbstractBuild build null public Map String String getRecords return record Override public void onLoad Run r build r record compact record Override public void onAttached Run r for historical reasons this setup is done in the constructor instead private PackedMap String String compact Map String String record Map String String b new HashMap String String for Entry String String e record entrySet b put e getKey intern e getValue intern return PackedMap of b public synchronized Map String Fingerprint getFingerprints if ref null Map String Fingerprint m ref get if m null return m Jenkins h Jenkins getInstance Map String Fingerprint m new TreeMap String Fingerprint for Entry String String r record entrySet try Fingerprint fp h getFingerprint r getValue if fp null m put r getKey fp catch IOException e logger log Level WARNING e getMessage e m ImmutableMap copyOf m ref new WeakReference Map String Fingerprint m return m public Map AbstractProject Integer getDependencies return getDependencies false public Map AbstractProject Integer getDependencies boolean includeMissing Map AbstractProject Integer r new HashMap AbstractProject Integer for Fingerprint fp getFingerprints values BuildPtr bp fp getOriginal if bp null continue outside Hudson if bp is build continue we are the owner try Job job bp getJob if job null continue project no longer exists if job instanceof AbstractProject Ignoring this for now In the future we may want a dependency map function not limited to AbstractProject Could be used by getDependencyChanges if pulled up from AbstractBuild into Run for example continue if job getParent build getParent continue we are the parent of the build owner that is almost like we are the owner if includeMissing job getBuildByNumber bp getNumber null continue build no longer exists Integer existing r get job if existing null existing bp getNumber continue the record in the map is already up to date r put AbstractProject job bp getNumber catch AccessDeniedException e Need to log in to access this job so ignore continue return r private static final Logger logger Logger getLogger Fingerprinter class getName private static final long serialVersionUID 1Lpackage jenkins model import hudson ExtensionPoint import hudson model Action import hudson model Fingerprint import org kohsuke accmod Restricted import org kohsuke accmod restrictions NoExternalUse import java util List import javax annotation Nonnull public abstract class FingerprintFacet implements ExtensionPoint private transient Fingerprint fingerprint private final long timestamp protected FingerprintFacet Nonnull Fingerprint fingerprint long timestamp assert fingerprint null this fingerprint fingerprint this timestamp timestamp public Nonnull Fingerprint getFingerprint return fingerprint public void createActions List Action result Create no actions by default public long getTimestamp return timestamp Restricted NoExternalUse class public void setOwner Fingerprint fingerprint assert fingerprint null this fingerprint fingerprintpackage hudson model import hudson Util import hudson util KeyedDataStorage import jenkins model Jenkins import java io File import java io IOException import java util Locale import javax annotation CheckForNull import javax annotation Nonnull public final class FingerprintMap extends KeyedDataStorage Fingerprint FingerprintMap FingerprintParams public boolean isReady return new File Jenkins getInstance getRootDir fingerprints exists public Nonnull Fingerprint getOrCreate CheckForNull AbstractBuild build Nonnull String fileName Nonnull byte md5sum throws IOException return getOrCreate build fileName Util toHexString md5sum public Nonnull Fingerprint getOrCreate CheckForNull AbstractBuild build Nonnull String fileName Nonnull String md5sum throws IOException return super getOrCreate md5sum new FingerprintParams build fileName public Nonnull Fingerprint getOrCreate CheckForNull Run build Nonnull String fileName Nonnull String md5sum throws IOException return super getOrCreate md5sum new FingerprintParams build fileName Override protected Fingerprint get String md5sum boolean createIfNotExist FingerprintParams createParams throws IOException sanity check if md5sum length 32 return null illegal input md5sum md5sum toLowerCase Locale ENGLISH return super get md5sum createIfNotExist createParams private byte toByteArray String md5sum byte data new byte 16 for int i 0 i md5sum length i 2 data i 2 byte Integer parseInt md5sum substring i i 2 16 return data protected Nonnull Fingerprint create Nonnull String md5sum Nonnull FingerprintParams createParams throws IOException return new Fingerprint createParams build createParams fileName toByteArray md5sum protected CheckForNull Fingerprint load Nonnull String key throws IOException return Fingerprint load toByteArray key static class FingerprintParams final CheckForNull Run build final String fileName public FingerprintParams CheckForNull Run build Nonnull String fileName this build build this fileName fileName assert fileName nullpackage hudson search import java util Arrays import java util Collection import java util List public class FixedSet implements SearchIndex private final Collection extends SearchItem items public FixedSet Collection extends SearchItem items this items items public FixedSet SearchItem items this Arrays asList items public void find String token List SearchItem result boolean caseInsensitive UserSearchProperty isCaseInsensitive for SearchItem i items String name i getSearchName if caseInsensitive token token toLowerCase name name toLowerCase if token equals i getSearchName result add i public void suggest String token List SearchItem result boolean caseInsensitive UserSearchProperty isCaseInsensitive for SearchItem i items String name i getSearchName if caseInsensitive token token toLowerCase name name toLowerCase if name contains token result add ipackage com twitter sdk android tweetui import com twitter sdk android core Callback import com twitter sdk android core Result import com twitter sdk android core models Tweet import java util ArrayList import java util Collections import java util List public class FixedTweetTimeline extends BaseTimeline implements Timeline Tweet private static final String SCRIBE SECTION fixed List Tweet tweets FixedTweetTimeline TweetUi tweetUi List Tweet tweets super tweetUi this tweets tweets null new ArrayList Tweet tweets Override public void next Long minPosition Callback TimelineResult Tweet cb always return the same fixed set of latest Tweets final TimelineResult Tweet timelineResult new TimelineResult new TimelineCursor tweets tweets cb success new Result timelineResult null Override public void previous Long maxPosition Callback TimelineResult Tweet cb final List Tweet empty Collections emptyList final TimelineResult Tweet timelineResult new TimelineResult new TimelineCursor empty empty cb success new Result timelineResult null Override String getTimelineType return SCRIBE SECTION public static class Builder private final TweetUi tweetUi private List Tweet tweets public Builder this TweetUi getInstance public Builder TweetUi tweetUi if tweetUi null throw new IllegalArgumentException TweetUi instance must not be null this tweetUi tweetUi public Builder setTweets List Tweet tweets this tweets tweets return this public FixedTweetTimeline build return new FixedTweetTimeline tweetUi tweetspackage hudson util import java io IOException import java io OutputStream public class FlushProofOutputStream extends DelegatingOutputStream public FlushProofOutputStream OutputStream out super out Override public void flush throws IOExceptionpackage hudson model queue import hudson model Queue Task import hudson model Action import hudson model Queue import java util List public interface FoldableAction extends Action void foldIntoExisting Queue Item item Task owner List Action otherActionspackage hudson util import java io IOException import java io OutputStream public class ForkOutputStream extends OutputStream private final OutputStream lhs private final OutputStream rhs public ForkOutputStream OutputStream lhs OutputStream rhs this lhs lhs this rhs rhs public void write int b throws IOException lhs write b rhs write b Override public void write byte b throws IOException lhs write b rhs write b Override public void write byte b int off int len throws IOException lhs write b off len rhs write b off len Override public void flush throws IOException lhs flush rhs flush Override public void close throws IOException lhs close rhs closepackage hudson util import org kohsuke stapler HttpResponses HttpResponseException import org kohsuke stapler StaplerRequest import org kohsuke stapler StaplerResponse import javax servlet ServletException import java io IOException public class FormApply public static HttpResponseException success final String destination return new HttpResponseException public void generateResponse StaplerRequest req StaplerResponse rsp Object node throws IOException ServletException if isApply req if the submission is via apply show a response in the notification bar applyResponse notificationBar show Messages HttpResponses Saved notificationBar OK generateResponse req rsp node else rsp sendRedirect destination public static boolean isApply StaplerRequest req return Boolean parseBoolean req getParameter core apply public static HttpResponseException applyResponse final String script return new HttpResponseException public void generateResponse StaplerRequest req StaplerResponse rsp Object node throws IOException ServletException rsp setContentType text html charset UTF 8 rsp getWriter println html body script window applyCompletionHandler function w with w script script body htmlpackage com twitter sdk android tweetui import com twitter sdk android core models MediaEntity class FormattedMediaEntity extends FormattedUrlEntity final String type final String mediaUrlHttps FormattedMediaEntity MediaEntity entity super entity this type entity type this mediaUrlHttps entity mediaUrlHttpspackage com twitter sdk android tweetui import java util ArrayList import java util List class FormattedTweetText String text final List FormattedUrlEntity urlEntities final List FormattedMediaEntity mediaEntities FormattedTweetText urlEntities new ArrayList mediaEntities new ArrayListpackage com twitter sdk android tweetui import com twitter sdk android core models UrlEntity class FormattedUrlEntity int start int end final String displayUrl final String url FormattedUrlEntity UrlEntity entity this start entity getStart this end entity getEnd this displayUrl entity displayUrl this url entity urlpackage hudson util import static hudson Util fixEmpty import hudson EnvVars import hudson FilePath import hudson ProxyConfiguration import hudson Util import hudson model AbstractProject import jenkins model Jenkins import hudson model Item import hudson security Permission import hudson security AccessControlled import java io BufferedReader import java io File import java io IOException import java io InputStreamReader import java net HttpURLConnection import java net URL import java net URLConnection import java util Locale import javax servlet ServletException import org kohsuke stapler StaplerRequest import org kohsuke stapler StaplerResponse import org acegisecurity AccessDeniedException import org kohsuke stapler Stapler Deprecated public abstract class FormFieldValidator public static final Permission CHECK Jenkins ADMINISTER protected final StaplerRequest request protected final StaplerResponse response protected final Permission permission protected final AccessControlled subject protected FormFieldValidator StaplerRequest request StaplerResponse response boolean adminOnly this request response adminOnly Jenkins getInstance null adminOnly CHECK null Deprecated protected FormFieldValidator StaplerRequest request StaplerResponse response Permission permission this request response Jenkins getInstance permission protected FormFieldValidator Permission permission this Stapler getCurrentRequest Stapler getCurrentResponse permission Deprecated protected FormFieldValidator StaplerRequest request StaplerResponse response AccessControlled subject Permission permission this request request this response response this subject subject this permission permission protected FormFieldValidator AccessControlled subject Permission permission this Stapler getCurrentRequest Stapler getCurrentResponse subject permission public final void process throws IOException ServletException if permission null try if subject null throw new AccessDeniedException No subject subject checkPermission permission catch AccessDeniedException e if the user has hudson wisde admin permission all checks are allowed this is to protect Hudson administrator from broken ACL SecurityRealm implementation configuration if Jenkins getInstance hasPermission Jenkins ADMINISTER throw e check protected abstract void check throws IOException ServletException protected final File getFileParameter String paramName return new File Util fixNull request getParameter paramName public void ok throws IOException ServletException respond div public void respond String html throws IOException ServletException response setContentType text html response getWriter print html public void error String message throws IOException ServletException errorWithMarkup message null null Util escape message public void warning String message throws IOException ServletException warningWithMarkup message null null Util escape message public void ok String message throws IOException ServletException okWithMarkup message null null Util escape message public void error String format Object args throws IOException ServletException error String format format args public void warning String format Object args throws IOException ServletException warning String format format args public void ok String format Object args throws IOException ServletException ok String format format args public void errorWithMarkup String message throws IOException ServletException errorWithMarkup message error public void warningWithMarkup String message throws IOException ServletException errorWithMarkup message warning public void okWithMarkup String message throws IOException ServletException errorWithMarkup message ok private void errorWithMarkup String message String cssClass throws IOException ServletException if message null ok else response setContentType text html charset UTF 8 1x16 spacer needed for IE since it doesn t support min height response getWriter print div class cssClass img src request getContextPath Jenkins RESOURCE PATH images none gif height 16 width 1 message div Deprecated public static abstract class URLCheck extends FormFieldValidator public URLCheck StaplerRequest request StaplerResponse response can be used to check the existence of any file in file system or other HTTP URLs inside firewall so limit this to the admin super request response true protected BufferedReader open URL url throws IOException use HTTP content type to find out the charset URLConnection con ProxyConfiguration open url if con null TODO is this even permitted by URL openConnection throw new IOException url toExternalForm return new BufferedReader new InputStreamReader con getInputStream getCharset con protected boolean findText BufferedReader in String literal throws IOException String line while line in readLine null if line indexOf literal 1 return true return false protected void handleIOException String url IOException e throws IOException ServletException any invalid URL comes here if e getMessage equals url Sun JRE and probably others too often return just the URL in the error error Unable to connect url else error e getMessage private String getCharset URLConnection con for String t con getContentType split t t trim toLowerCase Locale ENGLISH if t startsWith charset return t substring 8 couldn t find it HTML spec says default is US ASCII but UTF 8 is a better choice since 1 it s compatible with US ASCII 2 a well written web applications tend to use UTF 8 return UTF 8 public static class HudsonURL extends URLCheck public HudsonURL StaplerRequest request StaplerResponse response super request response protected void check throws IOException ServletException String value fixEmpty request getParameter value if value null nothing entered yet ok return if value endsWith value try URL url new URL value HttpURLConnection con HttpURLConnection url openConnection con connect if con getResponseCode 200 con getHeaderField X Hudson null error value is not Hudson con getResponseMessage return ok catch IOException e handleIOException value e Deprecated public static class WorkspaceFileMask extends FormFieldValidator private final boolean errorIfNotExist public WorkspaceFileMask StaplerRequest request StaplerResponse response this request response true public WorkspaceFileMask StaplerRequest request StaplerResponse response boolean errorIfNotExist Require CONFIGURE permission on the job super request response request findAncestorObject AbstractProject class Item CONFIGURE this errorIfNotExist errorIfNotExist protected void check throws IOException ServletException String value fixEmpty request getParameter value AbstractProject p AbstractProject subject if value null p null ok none entered yet or something is seriously wrong return try FilePath ws getBaseDirectory p if ws null ws exists no workspace can t check ok return String msg ws validateAntFileMask value FilePath VALIDATE ANT FILE MASK BOUND if errorIfNotExist error msg else warning msg catch InterruptedException e ok Messages FormFieldValidator did not manage to validate may be too sl value protected FilePath getBaseDirectory AbstractProject p return p getSomeWorkspace Deprecated public static class WorkspaceDirectory extends WorkspaceFilePath public WorkspaceDirectory StaplerRequest request StaplerResponse response boolean errorIfNotExist super request response errorIfNotExist false public WorkspaceDirectory StaplerRequest request StaplerResponse response this request response true Deprecated public static class WorkspaceFilePath extends FormFieldValidator private final boolean errorIfNotExist private final boolean expectingFile public WorkspaceFilePath StaplerRequest request StaplerResponse response boolean errorIfNotExist boolean expectingFile Require CONFIGURE permission on this job super request response request findAncestorObject AbstractProject class Item CONFIGURE this errorIfNotExist errorIfNotExist this expectingFile expectingFile protected void check throws IOException ServletException String value fixEmpty request getParameter value AbstractProject p AbstractProject subject if value null p null ok none entered yet or something is seriously wrong return if value contains a common mistake is to use wildcard error Wildcard is not allowed here return try FilePath ws getBaseDirectory p if ws null can t check ok return if ws exists no workspace can t check ok return if ws child value exists if expectingFile if ws child value isDirectory ok else error value is not a file else if ws child value isDirectory ok else error value is not a directory else String msg No such expectingFile file directory value if errorIfNotExist error msg else warning msg catch InterruptedException e ok coundn t check protected FilePath getBaseDirectory AbstractProject p return p getSomeWorkspace Deprecated public static class Executable extends FormFieldValidator public Executable StaplerRequest request StaplerResponse response Require admin permission super request response true protected void check throws IOException ServletException String exe fixEmpty request getParameter value if exe null ok nothing entered yet return if exe indexOf File separatorChar 0 this is full path File f new File exe if f exists checkExecutable f return File fexe new File exe exe if fexe exists checkExecutable fexe return error There s no such file exe else look in PATH String path EnvVars masterEnvVars get PATH String tokenizedPath String delimiter null if path null for String dir Util tokenize path replace File pathSeparator if delimiter null delimiter else tokenizedPath delimiter tokenizedPath dir replace File dir new File dir File f new File dir exe if f exists checkExecutable f return File fexe new File dir exe exe if fexe exists checkExecutable fexe return tokenizedPath else tokenizedPath unavailable didn t find it error There s no such executable exe in PATH tokenizedPath protected void checkExecutable File exe throws IOException ServletException ok Deprecated public static class Base64 extends FormFieldValidator private final boolean allowWhitespace private final boolean allowEmpty private final String errorMessage public Base64 StaplerRequest request StaplerResponse response boolean allowWhitespace boolean allowEmpty String errorMessage super request response false this allowWhitespace allowWhitespace this allowEmpty allowEmpty this errorMessage errorMessage protected void check throws IOException ServletException try String v request getParameter value if allowWhitespace if v indexOf 0 v indexOf n 0 fail return v v trim if allowEmpty v length 0 fail return com trilead ssh2 crypto Base64 decode v toCharArray ok catch IOException e fail protected void fail throws IOException ServletException error errorMessage Deprecated public static class NonNegativeInteger extends FormFieldValidator public NonNegativeInteger super null protected void check throws IOException ServletException try String value request getParameter value if Integer parseInt value 0 error hudson model Messages Hudson NotAPositiveNumber else ok catch NumberFormatException e error hudson model Messages Hudson NotANumberpackage hudson util import hudson EnvVars import hudson Functions import hudson Launcher import hudson ProxyConfiguration import hudson RelativePath import hudson Util import hudson FilePath import hudson model AbstractBuild import hudson model BuildListener import hudson model Descriptor import hudson tasks Builder import hudson util ReflectionUtils Parameter import jenkins model Jenkins import org kohsuke stapler HttpResponse import org kohsuke stapler QueryParameter import org kohsuke stapler StaplerRequest import org kohsuke stapler StaplerResponse import org kohsuke stapler Stapler import org springframework util StringUtils import javax annotation Nonnull import javax servlet ServletException import java io File import java io IOException import java io BufferedReader import java io InputStreamReader import java lang reflect Method import java net URL import java net URLConnection import java util ArrayList import java util Collection import java util List import java util Locale import static hudson Functions jsStringEscape import static hudson Util public abstract class FormValidation extends IOException implements HttpResponse public enum Kind OK WARNING ERROR public static FormValidation error String message return errorWithMarkup message null null Util escape message public static FormValidation warning String message return warningWithMarkup message null null Util escape message public static FormValidation ok String message return okWithMarkup message null null Util escape message private static final FormValidation OK respond Kind OK div public static FormValidation ok return OK public static FormValidation error String format Object args return error String format format args public static FormValidation warning String format Object args return warning String format format args public static FormValidation ok String format Object args return ok String format format args public static FormValidation error Throwable e String message return error Kind ERROR e message public static FormValidation warning Throwable e String message return error Kind WARNING e message private static FormValidation error Kind kind Throwable e String message if e null return errorWithMarkup Util escape message kind return errorWithMarkup Util escape message a href class showDetails Messages FormValidation Error Details a pre style display none Util escape Functions printThrowable e pre kind public static FormValidation error Throwable e String format Object args return error e String format format args public static FormValidation warning Throwable e String format Object args return warning e String format format args public static Nonnull FormValidation aggregate Nonnull Collection FormValidation validations if validations null validations isEmpty return FormValidation ok if validations size 1 return validations iterator next final StringBuilder sb new StringBuilder ul style list style type none padding left 0 margin 0 FormValidation Kind worst Kind OK for FormValidation validation validations sb append li append validation renderHtml append li if validation kind ordinal worst ordinal worst validation kind sb append ul return respond worst sb toString public static FormValidation errorWithMarkup String message return errorWithMarkup message Kind ERROR public static FormValidation warningWithMarkup String message return errorWithMarkup message Kind WARNING public static FormValidation okWithMarkup String message return errorWithMarkup message Kind OK private static FormValidation errorWithMarkup final String message final Kind kind if message null return ok return new FormValidation kind message public String renderHtml StaplerRequest req Stapler getCurrentRequest if req null being called from some other context return message 1x16 spacer needed for IE since it doesn t support min height return div class kind name toLowerCase Locale ENGLISH img src req getContextPath Jenkins RESOURCE PATH images none gif height 16 width 1 message div Override public String toString return kind message public static FormValidation respond Kind kind final String html return new FormValidation kind public String renderHtml return html Override public String toString return kind html public static abstract class FileValidator public abstract FormValidation validate File f public static final FileValidator NOOP new FileValidator public FormValidation validate File f return ok public static FormValidation validateExecutable String exe return validateExecutable exe FileValidator NOOP public static FormValidation validateExecutable String exe FileValidator exeValidator insufficient permission to perform validation if Jenkins getInstance hasPermission Jenkins ADMINISTER return ok exe fixEmpty exe if exe null return ok if exe indexOf File separatorChar 0 this is full path File f new File exe if f exists return exeValidator validate f File fexe new File exe exe if fexe exists return exeValidator validate fexe return error There s no such file exe look in PATH String path EnvVars masterEnvVars get PATH String tokenizedPath String delimiter null if path null for String dir Util tokenize path replace File pathSeparator if delimiter null delimiter else tokenizedPath delimiter tokenizedPath dir replace File dir new File dir File f new File dir exe if f exists return exeValidator validate f File fexe new File dir exe exe if fexe exists return exeValidator validate fexe tokenizedPath else tokenizedPath unavailable didn t find it return error There s no such executable exe in PATH tokenizedPath public static FormValidation validateNonNegativeInteger String value try if Integer parseInt value 0 return error hudson model Messages Hudson NotANonNegativeNumber return ok catch NumberFormatException e return error hudson model Messages Hudson NotANumber public static FormValidation validatePositiveInteger String value try if Integer parseInt value 0 return error hudson model Messages Hudson NotAPositiveNumber return ok catch NumberFormatException e return error hudson model Messages Hudson NotANumber public static FormValidation validateRequired String value if Util fixEmptyAndTrim value null return error Messages FormValidation ValidateRequired return ok public static FormValidation validateBase64 String value boolean allowWhitespace boolean allowEmpty String errorMessage try String v value if allowWhitespace if v indexOf 0 v indexOf n 0 return error errorMessage v v trim if allowEmpty v length 0 return error errorMessage com trilead ssh2 crypto Base64 decode v toCharArray return ok catch IOException e return error errorMessage public static abstract class URLCheck protected BufferedReader open URL url throws IOException use HTTP content type to find out the charset URLConnection con ProxyConfiguration open url if con null TODO is this even permitted by URL openConnection throw new IOException url toExternalForm return new BufferedReader new InputStreamReader con getInputStream getCharset con protected boolean findText BufferedReader in String literal throws IOException String line while line in readLine null if line indexOf literal 1 return true return false protected FormValidation handleIOException String url IOException e throws IOException ServletException any invalid URL comes here if e getMessage equals url Sun JRE and probably others too often return just the URL in the error return error Unable to connect url else return error e getMessage private String getCharset URLConnection con for String t con getContentType split t t trim toLowerCase Locale ENGLISH if t startsWith charset return t substring 8 couldn t find it HTML spec says default is US ASCII but UTF 8 is a better choice since 1 it s compatible with US ASCII 2 a well written web applications tend to use UTF 8 return UTF 8 protected abstract FormValidation check throws IOException ServletException public final Kind kind private FormValidation Kind kind this kind kind private FormValidation Kind kind String message super message this kind kind public void generateResponse StaplerRequest req StaplerResponse rsp Object node throws IOException ServletException respond rsp renderHtml public abstract String renderHtml protected void respond StaplerResponse rsp String html throws IOException ServletException rsp setContentType text html charset UTF 8 rsp getWriter print html public static class CheckMethod private final Descriptor descriptor private final Method method private final String capitalizedFieldName private final List String names private volatile String checkUrl cached once computed private volatile String dependsOn cached once computed public CheckMethod Descriptor descriptor String fieldName this descriptor descriptor this capitalizedFieldName StringUtils capitalize fieldName method ReflectionUtils getPublicMethodNamed descriptor getClass doCheck capitalizedFieldName if method null names new ArrayList String findParameters method else names null private void findParameters Method method for Parameter p ReflectionUtils getParameters method QueryParameter qp p annotation QueryParameter class if qp null String name qp value if name length 0 name p name if name null name length 0 continue unknown parameter name we ll report the error when the form is submitted if name equals value continue value parameter is implicit RelativePath rp p annotation RelativePath class if rp null name rp value name names add name continue Method m ReflectionUtils getPublicMethodNamed p type fromStapler if m null findParameters m public String toCheckUrl if names null return null if checkUrl null StringBuilder buf new StringBuilder singleQuote relativePath if names isEmpty buf append qs this addThis for String name names buf append nearBy name buf append toString checkUrl buf toString put this under the right contextual umbrella a in getCurrentDescriptorByNameUrl is always non null because we already have Hudson as the sentinel return jsStringEscape Descriptor getCurrentDescriptorByNameUrl checkUrl public String toStemUrl if names null return null return Descriptor getCurrentDescriptorByNameUrl relativePath public String getDependsOn if names null return null if dependsOn null dependsOn join names return dependsOn private String relativePath return descriptor getDescriptorUrl check capitalizedFieldNamepackage com kaku colorfulnews di component import android app Activity import android content Context import com kaku colorfulnews di module FragmentModule import com kaku colorfulnews di scope ContextLife import com kaku colorfulnews di scope PerFragment import com kaku colorfulnews mvp ui fragment NewsListFragment import dagger Component PerFragment Component dependencies ApplicationComponent class modules FragmentModule class public interface FragmentComponent ContextLife Activity Context getActivityContext ContextLife Application Context getApplicationContext Activity getActivity void inject NewsListFragment newsListFragmentpackage com kaku colorfulnews di module import android app Activity import android content Context import android support v4 app Fragment import com kaku colorfulnews di scope ContextLife import com kaku colorfulnews di scope PerFragment import dagger Module import dagger Provides Module public class FragmentModule private Fragment mFragment public FragmentModule Fragment fragment mFragment fragment Provides PerFragment ContextLife Activity public Context provideActivityContext return mFragment getActivity Provides PerFragment public Activity provideActivity return mFragment getActivity Provides PerFragment public Fragment provideFragment return mFragmentpackage jenkins security import hudson Extension import jenkins util SystemProperties import hudson model PageDecorator import org jenkinsci Symbol import org kohsuke accmod Restricted import org kohsuke accmod restrictions NoExternalUse Extension ordinal 1000 Symbol frameOptions public class FrameOptionsPageDecorator extends PageDecorator Restricted NoExternalUse class public static boolean enabled Boolean valueOf SystemProperties getString FrameOptionsPageDecorator class getName enabled truepackage hudson model import java io IOException import java io File public class FreeStyleBuild extends Build FreeStyleProject FreeStyleBuild public FreeStyleBuild FreeStyleProject project throws IOException super project public FreeStyleBuild FreeStyleProject project File buildDir throws IOException super project buildDir Override public void run execute new BuildExecutionpackage hudson model import hudson Extension import jenkins model Jenkins import org jenkins ui icon Icon import org jenkins ui icon IconSet import org jenkinsci Symbol import jenkins model item category StandaloneProjectsCategory import org kohsuke accmod Restricted import org kohsuke accmod restrictions NoExternalUse public class FreeStyleProject extends Project FreeStyleProject FreeStyleBuild implements TopLevelItem Deprecated public FreeStyleProject Jenkins parent String name super parent name public FreeStyleProject ItemGroup parent String name super parent name Override protected Class FreeStyleBuild getBuildClass return FreeStyleBuild class public DescriptorImpl getDescriptor return DescriptorImpl Jenkins getInstance getDescriptorOrDie getClass Restricted NoExternalUse class public static DescriptorImpl DESCRIPTOR Extension ordinal 1000 Symbol freeStyle freeStyleJob public static class DescriptorImpl extends AbstractProjectDescriptor public DescriptorImpl DESCRIPTOR this public String getDisplayName return Messages FreeStyleProject DisplayName public FreeStyleProject newInstance ItemGroup parent String name return new FreeStyleProject parent name Override public String getDescription return Messages FreeStyleProject Description Override public String getCategoryId return StandaloneProjectsCategory ID Override public String getIconFilePathPattern return Jenkins RESOURCE PATH images size freestyleproject png replaceFirst Override public String getIconClassName return icon freestyle project static IconSet icons addIcon new Icon icon freestyle project icon sm 16x16 freestyleproject png Icon ICON SMALL STYLE IconSet icons addIcon new Icon icon freestyle project icon md 24x24 freestyleproject png Icon ICON MEDIUM STYLE IconSet icons addIcon new Icon icon freestyle project icon lg 32x32 freestyleproject png Icon ICON LARGE STYLE IconSet icons addIcon new Icon icon freestyle project icon xlg 48x48 freestyleproject png Icon ICON XLARGE STYLEpackage hudson security import hudson Extension import hudson model Descriptor import jenkins model Jenkins import org jenkinsci Symbol import org kohsuke accmod Restricted import org kohsuke accmod restrictions NoExternalUse import org kohsuke stapler DataBoundConstructor import org kohsuke stapler DataBoundSetter import javax inject Inject import java util Collections import java util List public class FullControlOnceLoggedInAuthorizationStrategy extends AuthorizationStrategy private boolean denyAnonymousReadAccess false DataBoundConstructor public FullControlOnceLoggedInAuthorizationStrategy Override public ACL getRootACL return denyAnonymousReadAccess AUTHENTICATED READ ANONYMOUS READ public List String getGroups return Collections emptyList public boolean isAllowAnonymousRead return denyAnonymousReadAccess DataBoundSetter public void setAllowAnonymousRead boolean allowAnonymousRead this denyAnonymousReadAccess allowAnonymousRead private static final SparseACL AUTHENTICATED READ new SparseACL null private static final SparseACL ANONYMOUS READ new SparseACL null static ANONYMOUS READ add ACL EVERYONE Jenkins ADMINISTER true ANONYMOUS READ add ACL ANONYMOUS Jenkins ADMINISTER false ANONYMOUS READ add ACL ANONYMOUS Permission READ true AUTHENTICATED READ add ACL EVERYONE Jenkins ADMINISTER true AUTHENTICATED READ add ACL ANONYMOUS Jenkins ADMINISTER false Restricted NoExternalUse class public static Descriptor AuthorizationStrategy DESCRIPTOR Extension Symbol loggedInUsersCanDoAnything public static class DescriptorImpl extends Descriptor AuthorizationStrategy public DescriptorImpl DESCRIPTOR this public String getDisplayName return Messages FullControlOnceLoggedInAuthorizationStrategy DisplayNamepackage hudson model import jenkins util SystemProperties import hudson remoting Channel import hudson remoting PingThread import hudson remoting Channel Mode import hudson util ChunkedOutputStream import hudson util ChunkedInputStream import org kohsuke accmod Restricted import org kohsuke accmod restrictions NoExternalUse import org kohsuke stapler StaplerRequest import org kohsuke stapler StaplerResponse import javax servlet http HttpServletResponse import java io IOException import java io InputStream import java io OutputStream import java util UUID import java util concurrent TimeUnit import java util logging Level import java util logging Logger abstract public class FullDuplexHttpChannel private Channel channel private InputStream upload private final UUID uuid private final boolean restricted private boolean completed public FullDuplexHttpChannel UUID uuid boolean restricted throws IOException this uuid uuid this restricted restricted public synchronized void download StaplerRequest req StaplerResponse rsp throws InterruptedException IOException rsp setStatus HttpServletResponse SC OK server client channel this is created first and this controls the lifespan of the channel rsp addHeader Transfer Encoding chunked OutputStream out rsp getOutputStream if DIY CHUNKING out new ChunkedOutputStream out send something out so that the client will see the HTTP headers out write Starting HTTP duplex channel getBytes out flush wait until we have the other channel long end System currentTimeMillis CONNECTION TIMEOUT while upload null System currentTimeMillis end wait 1000 if upload null throw new IOException HTTP full duplex channel timeout uuid try channel new Channel HTTP full duplex channel uuid Computer threadPoolForRemoting Mode BINARY upload out null restricted so that we can detect dead clients periodically send something PingThread ping new PingThread channel Override protected void onDead Throwable diagnosis LOGGER log Level INFO Duplex HTTP session uuid is terminated diagnosis this will cause the channel to abort and subsequently clean up try upload close catch IOException e this can never happen throw new AssertionError e Override protected void onDead onDead null ping start main channel channel join ping interrupt finally publish that we are done completed true notify protected abstract void main Channel channel throws IOException InterruptedException public synchronized void upload StaplerRequest req StaplerResponse rsp throws InterruptedException IOException rsp setStatus HttpServletResponse SC OK InputStream in req getInputStream if DIY CHUNKING in new ChunkedInputStream in publish the upload channel upload in notify wait until we are done while completed wait public Channel getChannel return channel private static final Logger LOGGER Logger getLogger FullDuplexHttpChannel class getName Restricted NoExternalUse class public static boolean DIY CHUNKING SystemProperties getBoolean hudson diyChunking Restricted NoExternalUse class public static long CONNECTION TIMEOUT TimeUnit SECONDS toMillis 15package hudson cli import java io BufferedReader import java io IOException import java io InputStream import java io InputStreamReader import java io OutputStream import java net HttpURLConnection import java net URL import java util UUID import java util logging Level import java util logging Logger import org apache commons codec binary Base64 public class FullDuplexHttpStream private final URL target private final String authorization private final OutputStream output private final InputStream input public InputStream getInputStream return input public OutputStream getOutputStream return output Deprecated public FullDuplexHttpStream URL target throws IOException this target basicAuth target getUserInfo private static String basicAuth String userInfo if userInfo null return Basic new String Base64 encodeBase64 userInfo getBytes return null public FullDuplexHttpStream URL target String authorization throws IOException this target target this authorization authorization CrumbData crumbData new CrumbData UUID uuid UUID randomUUID so that the server can correlate those two connections server client HttpURLConnection con HttpURLConnection target openConnection con setDoOutput true request POST to avoid caching con setRequestMethod POST con addRequestProperty Session uuid toString con addRequestProperty Side download if authorization null con addRequestProperty Authorization authorization if crumbData isValid con addRequestProperty crumbData crumbName crumbData crumb con getOutputStream close input con getInputStream make sure we hit the right URL if con getHeaderField Hudson Duplex null throw new IOException target doesn t look like Jenkins client server uses chunked encoded POST for unlimited capacity con HttpURLConnection target openConnection con setDoOutput true request POST con setRequestMethod POST con setChunkedStreamingMode 0 con setRequestProperty Content type application octet stream con addRequestProperty Session uuid toString con addRequestProperty Side upload if authorization null con addRequestProperty Authorization authorization if crumbData isValid con addRequestProperty crumbData crumbName crumbData crumb output con getOutputStream static final int BLOCK SIZE 1024 static final Logger LOGGER Logger getLogger FullDuplexHttpStream class getName private final class CrumbData String crumbName String crumb boolean isValid private CrumbData this crumbName this crumb this isValid false getData private void getData try String base createCrumbUrlBase String pair readData base xpath concat crumbRequestField crumb split 2 crumbName pair 0 crumb pair 1 isValid true LOGGER fine Crumb data crumbName crumb catch IOException e presumably this Hudson doesn t use crumb LOGGER log Level FINE Failed to get crumb data e private String createCrumbUrlBase String url target toExternalForm return new StringBuilder url substring 0 url lastIndexOf cli append crumbIssuer api xml toString private String readData String dest throws IOException HttpURLConnection con HttpURLConnection new URL dest openConnection if authorization null con addRequestProperty Authorization authorization try BufferedReader reader new BufferedReader new InputStreamReader con getInputStream String line reader readLine String nextLine reader readLine if nextLine null System err println Warning received junk from dest System err println line System err println nextLine while nextLine reader readLine null System err println nextLine return line finally con disconnectpackage hudson util public interface Function1 R P1 R call P1 param1package hudson import hudson model Slave import jenkins util SystemProperties import hudson cli CLICommand import hudson console ConsoleAnnotationDescriptor import hudson console ConsoleAnnotatorFactory import hudson init InitMilestone import hudson model AbstractProject import hudson model Action import hudson model Describable import hudson model Descriptor import hudson model DescriptorVisibilityFilter import hudson model Hudson import hudson model Item import hudson model ItemGroup import hudson model Items import hudson model JDK import hudson model Job import hudson model JobPropertyDescriptor import hudson model ModelObject import hudson model Node import hudson model PageDecorator import hudson model PaneStatusProperties import hudson model ParameterDefinition import hudson model ParameterDefinition ParameterDescriptor import hudson model Run import hudson model TopLevelItem import hudson model User import hudson model View import hudson scm SCM import hudson scm SCMDescriptor import hudson search SearchableModelObject import hudson security AccessControlled import hudson security AuthorizationStrategy import hudson security GlobalSecurityConfiguration import hudson security Permission import hudson security SecurityRealm import hudson security captcha CaptchaSupport import hudson security csrf CrumbIssuer import hudson slaves Cloud import hudson slaves ComputerLauncher import hudson slaves NodeProperty import hudson slaves NodePropertyDescriptor import hudson slaves RetentionStrategy import hudson tasks BuildStepDescriptor import hudson tasks BuildWrapper import hudson tasks BuildWrappers import hudson tasks Builder import hudson tasks Publisher import hudson tasks UserAvatarResolver import hudson util Area import hudson util FormValidation CheckMethod import hudson util HudsonIsLoading import hudson util HudsonIsRestarting import hudson util Iterators import hudson util jna GNUCLibrary import hudson util Secret import hudson views MyViewsTabBar import hudson views ViewsTabBar import hudson widgets RenderOnDemandClosure import java io File import java io IOException import java io PrintWriter import java io StringWriter import java io UnsupportedEncodingException import java lang management LockInfo import java lang management ManagementFactory import java lang management MonitorInfo import java lang management ThreadInfo import java lang management ThreadMXBean import java lang reflect ParameterizedType import java lang reflect Type import java net MalformedURLException import java net URI import java net URISyntaxException import java net URL import java net URLDecoder import java text DecimalFormat import java util ArrayList import java util Arrays import java util Calendar import java util Collection import java util Collections import java util Comparator import java util ConcurrentModificationException import java util Date import java util Enumeration import java util HashMap import java util List import java util Locale import java util Map import java util SortedMap import java util TreeMap import java util logging Level import java util logging LogManager import java util logging LogRecord import java util logging Logger import java util logging SimpleFormatter import java util regex Pattern import javax servlet ServletException import javax servlet http Cookie import javax servlet http HttpServletRequest import javax servlet http HttpServletResponse import jenkins model GlobalConfiguration import jenkins model GlobalConfigurationCategory import jenkins model Jenkins import jenkins model ModelObjectWithChildren import jenkins model ModelObjectWithContextMenu import org acegisecurity providers anonymous AnonymousAuthenticationToken import org apache commons jelly JellyContext import org apache commons jelly JellyTagException import org apache commons jelly Script import org apache commons jelly XMLOutput import org apache commons jexl parser ASTSizeFunction import org apache commons jexl util Introspector import org apache commons lang StringUtils import org jenkins ui icon IconSet import org jvnet tiger types Types import org kohsuke stapler Ancestor import org kohsuke stapler Stapler import org kohsuke stapler StaplerRequest import org kohsuke stapler StaplerResponse import org kohsuke stapler jelly InternationalizedStringExpression RawHtmlArgument import com google common base Predicate import com google common base Predicates import hudson model PasswordParameterDefinition import hudson util RunList import java util concurrent atomic AtomicLong import javax annotation CheckForNull import org kohsuke accmod Restricted import org kohsuke accmod restrictions NoExternalUse import org kohsuke accmod restrictions DoNotUse SuppressWarnings rawtypes public class Functions private static final AtomicLong iota new AtomicLong public Functions public String generateId return id iota getAndIncrement public static boolean isModel Object o return o instanceof ModelObject public static boolean isModelWithContextMenu Object o return o instanceof ModelObjectWithContextMenu public static boolean isModelWithChildren Object o return o instanceof ModelObjectWithChildren Deprecated public static boolean isMatrixProject Object o return o null o getClass getName equals hudson matrix MatrixProject public static String xsDate Calendar cal return Util XS DATETIME FORMATTER format cal getTime public static String rfc822Date Calendar cal return Util RFC822 DATETIME FORMATTER format cal getTime public static boolean isExtensionsAvailable final Jenkins jenkins Jenkins getInstanceOrNull return jenkins null jenkins getInitLevel compareTo InitMilestone EXTENSIONS AUGMENTED 0 jenkins isTerminating public static void initPageVariables JellyContext context StaplerRequest currentRequest Stapler getCurrentRequest String rootURL currentRequest getContextPath Functions h new Functions context setVariable h h The path starts with a character but does not end with a character context setVariable rootURL rootURL context setVariable resURL rootURL getResourcePath context setVariable imagesURL rootURL getResourcePath images context setVariable userAgent currentRequest getHeader User Agent IconSet initPageVariables context public static B Class getTypeParameter Class extends B c Class B base int n Type parameterization Types getBaseClass c base if parameterization instanceof ParameterizedType ParameterizedType pt ParameterizedType parameterization return Types erasure Types getTypeArgument pt n else throw new AssertionError c doesn t properly parameterize base public JDK DescriptorImpl getJDKDescriptor return Jenkins getInstance getDescriptorByType JDK DescriptorImpl class public static String getDiffString int i if i 0 return 0 String s Integer toString i if i 0 return s else return s public static String getDiffString2 int i if i 0 return String s Integer toString i if i 0 return s else return s public static String getDiffString2 String prefix int i String suffix if i 0 return String s Integer toString i if i 0 return prefix s suffix else return prefix s suffix public static String addSuffix int n String singular String plural StringBuilder buf new StringBuilder buf append n append if n 1 buf append singular else buf append plural return buf toString public static RunUrl decompose StaplerRequest req List Ancestor ancestors req getAncestors find the first and last Run instances Ancestor f null l null for Ancestor anc ancestors if anc getObject instanceof Run if f null f anc l anc if l null return null there was no Run object String head f getPrev getUrl String base l getUrl String reqUri req getOriginalRequestURI Find rest or URI by removing N path components Not using reqUri substring f getUrl length to avoid mismatches due to url encoding or extra slashes Former may occur in Tomcat despite the spec saying this string is not decoded Tomcat apparently decodes this string You see instead of 20 which is what the browser has sent latter may occur in some proxy or URL rewriting setups where extra slashes are inadvertently added String furl f getUrl int slashCount 0 Count components in ancestor URL for int i furl indexOf i 0 i furl indexOf i 1 slashCount Remove that many from request URL ignoring extra slashes String rest reqUri replaceFirst slashCount return new RunUrl Run f getObject head base rest public static Area getScreenResolution Cookie res Functions getCookie Stapler getCurrentRequest screenResolution if res null return Area parse res getValue return null public static final class RunUrl private final String head base rest private final Run run public RunUrl Run run String head String base String rest this run run this head head this base base this rest rest public String getBaseUrl return base public String getNextBuildUrl return getUrl run getNextBuild public String getPreviousBuildUrl return getUrl run getPreviousBuild private String getUrl Run n if n null return null else return head n getNumber rest public static Node Mode getNodeModes return Node Mode values public static String getProjectListString List AbstractProject projects return Items toNameList projects Deprecated public static Object ifThenElse boolean cond Object thenValue Object elseValue return cond thenValue elseValue public static String appendIfNotNull String text String suffix String nullText return text null nullText text suffix public static Map getSystemProperties return new TreeMap Object Object System getProperties public static Map getEnvVars return new TreeMap String String EnvVars masterEnvVars public static boolean isWindows return File pathSeparatorChar public static boolean isGlibcSupported try GNUCLibrary LIBC getpid return true catch Throwable t return false public static List LogRecord getLogRecords return Jenkins logRecords public static String printLogRecord LogRecord r return formatter format r Restricted NoExternalUse class public static String printLogRecordHtml LogRecord r LogRecord prior String oldParts prior null new String 4 logRecordPreformat prior String newParts logRecordPreformat r for int i 0 i 3 i newParts i span class newParts i equals oldParts i logrecord metadata old logrecord metadata new newParts i span newParts 3 Util xmlEscape newParts 3 return newParts private static String logRecordPreformat LogRecord r String source if r getSourceClassName null source r getLoggerName else if r getSourceMethodName null source r getSourceClassName else source r getSourceClassName r getSourceMethodName String message new SimpleFormatter formatMessage r n Throwable x r getThrown return new String String format 1 tb 1 td 1 tY 1 tl 1 tM 1 tS 1 Tp new Date r getMillis source r getLevel getLocalizedName x null message message printThrowable x n public static T Iterable T reverse Collection T collection List T list new ArrayList T collection Collections reverse list return list public static Cookie getCookie HttpServletRequest req String name Cookie cookies req getCookies if cookies null for Cookie cookie cookies if cookie getName equals name return cookie return null public static String getCookie HttpServletRequest req String name String defaultValue Cookie c getCookie req name if c null c getValue null return defaultValue return c getValue private static final Pattern ICON SIZE Pattern compile d x d Restricted NoExternalUse class public static String validateIconSize String iconSize throws SecurityException if ICON SIZE matcher iconSize matches throw new SecurityException invalid iconSize return iconSize public static String getYuiSuffix return DEBUG YUI debug min public static boolean DEBUG YUI SystemProperties getBoolean debug YUI public static V SortedMap Integer V filter SortedMap Integer V map String from String to if from null to null return map if to null return map headMap Integer parseInt from 1 if from null return map tailMap Integer parseInt to return map subMap Integer parseInt to Integer parseInt from 1 Restricted NoExternalUse class public static V SortedMap Integer V filterExcludingFrom SortedMap Integer V map String from String to if from null to null return map if to null return map headMap Integer parseInt from if from null return map tailMap Integer parseInt to return map subMap Integer parseInt to Integer parseInt from private static final SimpleFormatter formatter new SimpleFormatter public static void configureAutoRefresh HttpServletRequest request HttpServletResponse response boolean noAutoRefresh if noAutoRefresh return String param request getParameter auto refresh boolean refresh isAutoRefresh request if param null refresh Boolean parseBoolean param Cookie c new Cookie hudson auto refresh Boolean toString refresh Need to set path or it will not stick from e g a project page to the dashboard Using request getContextPath might work but it seems simpler to just use the hudson prefix to avoid conflicts with any other web apps that might be on the same machine c setPath c setMaxAge 60 60 24 30 persist it roughly for a month response addCookie c if refresh response addHeader Refresh SystemProperties getString hudson Functions autoRefreshSeconds 10 public static boolean isAutoRefresh HttpServletRequest request String param request getParameter auto refresh if param null return Boolean parseBoolean param Cookie cookies request getCookies if cookies null return false when API design messes it up we all suffer for Cookie c cookies if c getName equals hudson auto refresh return Boolean parseBoolean c getValue return false public static boolean isCollapsed String paneId return PaneStatusProperties forCurrentUser isCollapsed paneId public static String getNearestAncestorUrl StaplerRequest req Object it List list req getAncestors for int i list size 1 i 0 i Ancestor anc Ancestor list get i if anc getObject it return anc getUrl return null public static String getSearchURL List list Stapler getCurrentRequest getAncestors for int i list size 1 i 0 i Ancestor anc Ancestor list get i if anc getObject instanceof SearchableModelObject return anc getUrl search return null public static String appendSpaceIfNotNull String n if n null return null else return n public static String nbspIndent String size int i size indexOf x i Integer parseInt i 0 size substring 0 i size 10 StringBuilder buf new StringBuilder 30 for int j 0 j i j buf append nbsp return buf toString public static String getWin32ErrorMessage IOException e return Util getWin32ErrorMessage e public static boolean isMultiline String s if s null return false return s indexOf r 0 s indexOf n 0 public static String encode String s return Util encode s public static String escape String s return Util escape s public static String xmlEscape String s return Util xmlEscape s public static String xmlUnescape String s return s replace lt replace gt replace amp public static String htmlAttributeEscape String text StringBuilder buf new StringBuilder text length 64 for int i 0 i text length i char ch text charAt i if ch buf append lt else if ch buf append gt else if ch buf append amp else if ch buf append quot else if ch buf append 39 else buf append ch return buf toString public static void checkPermission Permission permission throws IOException ServletException checkPermission Jenkins getInstance permission public static void checkPermission AccessControlled object Permission permission throws IOException ServletException if permission null object checkPermission permission public static void checkPermission Object object Permission permission throws IOException ServletException if permission null return if object instanceof AccessControlled checkPermission AccessControlled object permission else List Ancestor ancs Stapler getCurrentRequest getAncestors for Ancestor anc Iterators reverse ancs Object o anc getObject if o instanceof AccessControlled checkPermission AccessControlled o permission return checkPermission Jenkins getInstance permission public static boolean hasPermission Permission permission throws IOException ServletException return hasPermission Jenkins getInstance permission public static boolean hasPermission Object object Permission permission throws IOException ServletException if permission null return true if object instanceof AccessControlled return AccessControlled object hasPermission permission else List Ancestor ancs Stapler getCurrentRequest getAncestors for Ancestor anc Iterators reverse ancs Object o anc getObject if o instanceof AccessControlled return AccessControlled o hasPermission permission return Jenkins getInstance hasPermission permission public static void adminCheck StaplerRequest req StaplerResponse rsp Object required Permission permission throws IOException ServletException this is legacy all views should be eventually converted to the permission based model if required null Hudson adminCheck req rsp check failed commit the FORBIDDEN response then abort rsp setStatus HttpServletResponse SC FORBIDDEN rsp getOutputStream close throw new ServletException Unauthorized access make sure the user owns the necessary permission to access this page if permission null checkPermission permission public static String inferHudsonURL StaplerRequest req String rootUrl Jenkins getInstance getRootUrl if rootUrl null prefer the one explicitly configured to work with load balancer frontend etc return rootUrl StringBuilder buf new StringBuilder buf append req getScheme append buf append req getServerName if req getScheme equals http req getLocalPort 80 req getScheme equals https req getLocalPort 443 buf append append req getLocalPort buf append req getContextPath append return buf toString public static String getFooterURL if footerURL null footerURL SystemProperties getString hudson footerURL if StringUtils isBlank footerURL footerURL http jenkins ci org return footerURL private static String footerURL null public static List JobPropertyDescriptor getJobPropertyDescriptors Class extends Job clazz return JobPropertyDescriptor getPropertyDescriptors clazz public static List JobPropertyDescriptor getJobPropertyDescriptors Job job return DescriptorVisibilityFilter apply job JobPropertyDescriptor getPropertyDescriptors job getClass public static List Descriptor BuildWrapper getBuildWrapperDescriptors AbstractProject project return BuildWrappers getFor project public static List Descriptor SecurityRealm getSecurityRealmDescriptors return SecurityRealm all public static List Descriptor AuthorizationStrategy getAuthorizationStrategyDescriptors return AuthorizationStrategy all public static List Descriptor Builder getBuilderDescriptors AbstractProject project return BuildStepDescriptor filter Builder all project getClass public static List Descriptor Publisher getPublisherDescriptors AbstractProject project return BuildStepDescriptor filter Publisher all project getClass public static List SCMDescriptor getSCMDescriptors AbstractProject project return SCM for project Deprecated Restricted DoNotUse class RestrictedSince 2 12 public static List Descriptor ComputerLauncher getComputerLauncherDescriptors return Jenkins getInstance ComputerLauncher Descriptor ComputerLauncher getDescriptorList ComputerLauncher class Deprecated Restricted DoNotUse class RestrictedSince 2 12 public static List Descriptor RetentionStrategy getRetentionStrategyDescriptors return RetentionStrategy all public static List ParameterDescriptor getParameterDescriptors return ParameterDefinition all public static List Descriptor CaptchaSupport getCaptchaSupportDescriptors return CaptchaSupport all public static List Descriptor ViewsTabBar getViewsTabBarDescriptors return ViewsTabBar all public static List Descriptor MyViewsTabBar getMyViewsTabBarDescriptors return MyViewsTabBar all Deprecated Restricted DoNotUse class RestrictedSince 2 12 public static List NodePropertyDescriptor getNodePropertyDescriptors Class extends Node clazz List NodePropertyDescriptor result new ArrayList NodePropertyDescriptor Collection NodePropertyDescriptor list Collection Jenkins getInstance getDescriptorList NodeProperty class for NodePropertyDescriptor npd list if npd isApplicable clazz result add npd return result public static List NodePropertyDescriptor getGlobalNodePropertyDescriptors List NodePropertyDescriptor result new ArrayList NodePropertyDescriptor Collection NodePropertyDescriptor list Collection Jenkins getInstance getDescriptorList NodeProperty class for NodePropertyDescriptor npd list if npd isApplicableAsGlobal result add npd return result public static Collection Descriptor getSortedDescriptorsForGlobalConfig Predicate GlobalConfigurationCategory predicate ExtensionList Descriptor exts ExtensionList lookup Descriptor class List Tag r new ArrayList Tag exts size for ExtensionComponent Descriptor c exts getComponents Descriptor d c getInstance if d getGlobalConfigPage null continue if predicate apply d getCategory r add new Tag c ordinal d Collections sort r List Descriptor answer new ArrayList Descriptor r size for Tag d r answer add d d return DescriptorVisibilityFilter apply Jenkins getInstance answer public static Collection Descriptor getSortedDescriptorsForGlobalConfig return getSortedDescriptorsForGlobalConfig Predicates GlobalConfigurationCategory alwaysTrue Deprecated public static Collection Descriptor getSortedDescriptorsForGlobalConfigNoSecurity return getSortedDescriptorsForGlobalConfig Predicates not GlobalSecurityConfiguration FILTER public static Collection Descriptor getSortedDescriptorsForGlobalConfigUnclassified return getSortedDescriptorsForGlobalConfig new Predicate GlobalConfigurationCategory public boolean apply GlobalConfigurationCategory cat return cat instanceof GlobalConfigurationCategory Unclassified private static class Tag implements Comparable Tag double ordinal String hierarchy Descriptor d Tag double ordinal Descriptor d this ordinal ordinal this d d this hierarchy buildSuperclassHierarchy d clazz new StringBuilder toString private StringBuilder buildSuperclassHierarchy Class c StringBuilder buf Class sc c getSuperclass if sc null buildSuperclassHierarchy sc buf append return buf append c getName public int compareTo Tag that int r Double compare this ordinal that ordinal if r 0 return r descending for ordinal return this hierarchy compareTo that hierarchy public static String getIconFilePath Action a String name a getIconFileName if name null return null if name startsWith return name substring 1 else return images 24x24 name public static int size2 Object o throws Exception if o null return 0 return ASTSizeFunction sizeOf o Introspector getUberspect public static String getRelativeLinkTo Item p Map Object String ancestors new HashMap Object String View view null StaplerRequest request Stapler getCurrentRequest for Ancestor a request getAncestors ancestors put a getObject a getRelativePath if a getObject instanceof View view View a getObject String path ancestors get p if path null return normalizeURI path Item i p String url while true ItemGroup ig i getParent url i getShortUrl url if ig Jenkins getInstance view null ig view getOwnerItemGroup assert i instanceof TopLevelItem if view null assume p and the current page belong to the same view so return a relative path even if they did not View getItem does not by default verify ownership return normalizeURI ancestors get view url else otherwise return a path from the root Hudson return normalizeURI request getContextPath p getUrl path ancestors get ig if path null return normalizeURI path url assert ig instanceof Item if not ig must have been the Hudson instance i Item ig private static String normalizeURI String uri return URI create uri normalize toString public static List TopLevelItem getAllTopLevelItems ItemGroup root return Items getAllItems root TopLevelItem class public static String getRelativeNameFrom Item p ItemGroup g boolean useDisplayName if p null return null if g null return useDisplayName p getFullDisplayName p getFullName String separationString useDisplayName first list up all the parents Map ItemGroup Integer parents new HashMap ItemGroup Integer int depth 0 while g null parents put g depth if g instanceof Item g Item g getParent else g null StringBuilder buf new StringBuilder Item i p while true if buf length 0 buf insert 0 separationString buf insert 0 useDisplayName i getDisplayName i getName ItemGroup gr i getParent Integer d parents get gr if d null for int j d j 0 j buf insert 0 separationString buf insert 0 return buf toString if gr instanceof Item i Item gr else return null public static String getRelativeNameFrom Item p ItemGroup g return getRelativeNameFrom p g false public static String getRelativeDisplayNameFrom Item p ItemGroup g return getRelativeNameFrom p g true public static Map Thread StackTraceElement dumpAllThreads Map Thread StackTraceElement sorted new TreeMap Thread StackTraceElement new ThreadSorter sorted putAll Thread getAllStackTraces return sorted public static ThreadInfo getThreadInfos ThreadMXBean mbean ManagementFactory getThreadMXBean return mbean dumpAllThreads mbean isObjectMonitorUsageSupported mbean isSynchronizerUsageSupported public static ThreadGroupMap sortThreadsAndGetGroupMap ThreadInfo list ThreadGroupMap sorter new ThreadGroupMap Arrays sort list sorter return sorter Common code for sorting Threads ThreadInfos by ThreadGroup private static class ThreadSorterBase protected Map Long String map new HashMap Long String private ThreadSorterBase ThreadGroup tg Thread currentThread getThreadGroup while tg getParent null tg tg getParent Thread threads new Thread tg activeCount 2 int threadsLen tg enumerate threads true for int i 0 i threadsLen i ThreadGroup group threads i getThreadGroup map put threads i getId group null group getName null protected int compare long idA long idB String tga map get idA tgb map get idB int result tga null 1 0 tgb null 1 0 Will be non zero if only one is null if result 0 tga null result tga compareToIgnoreCase tgb return result public static class ThreadGroupMap extends ThreadSorterBase implements Comparator ThreadInfo public String getThreadGroup ThreadInfo ti return map get ti getThreadId public int compare ThreadInfo a ThreadInfo b int result compare a getThreadId b getThreadId if result 0 result a getThreadName compareToIgnoreCase b getThreadName return result private static class ThreadSorter extends ThreadSorterBase implements Comparator Thread public int compare Thread a Thread b int result compare a getId b getId if result 0 result a getName compareToIgnoreCase b getName return result Deprecated public static boolean isMustangOrAbove return true ThreadInfo toString truncates the stack trace by first 8 so needed my own version public static String dumpThreadInfo ThreadInfo ti ThreadGroupMap map String grp map getThreadGroup ti StringBuilder sb new StringBuilder ti getThreadName Id ti getThreadId Group grp null grp ti getThreadState if ti getLockName null sb append on ti getLockName if ti getLockOwnerName null sb append owned by ti getLockOwnerName Id ti getLockOwnerId if ti isSuspended sb append suspended if ti isInNative sb append in native sb append n StackTraceElement stackTrace ti getStackTrace for int i 0 i stackTrace length i StackTraceElement ste stackTrace i sb append tat append ste sb append n if i 0 ti getLockInfo null Thread State ts ti getThreadState switch ts case BLOCKED sb append t blocked on append ti getLockInfo sb append n break case WAITING sb append t waiting on append ti getLockInfo sb append n break case TIMED WAITING sb append t waiting on append ti getLockInfo sb append n break default for MonitorInfo mi ti getLockedMonitors if mi getLockedStackDepth i sb append t locked append mi sb append n LockInfo locks ti getLockedSynchronizers if locks length 0 sb append n tNumber of locked synchronizers locks length sb append n for LockInfo li locks sb append t append li sb append n sb append n return sb toString public static T Collection T emptyList return Collections emptyList public static String jsStringEscape String s StringBuilder buf new StringBuilder for int i 0 i s length i char ch s charAt i switch ch case buf append break case buf append break case buf append break default buf append ch return buf toString public static String capitalize String s if s null s length 0 return s return Character toUpperCase s charAt 0 s substring 1 public static String getVersion return Jenkins VERSION public static String getResourcePath return Jenkins RESOURCE PATH public static String getViewResource Object it String path Class clazz it getClass if it instanceof Class clazz Class it if it instanceof Descriptor clazz Descriptor it clazz StringBuilder buf new StringBuilder Stapler getCurrentRequest getContextPath buf append Jenkins VIEW RESOURCE PATH append buf append clazz getName replace replace buf append append path return buf toString public static boolean hasView Object it String path throws IOException if it null return false return Stapler getCurrentRequest getView it path null public static boolean defaultToTrue Boolean b if b null return true return b public static T T defaulted T value T defaultValue return value null value defaultValue public static String printThrowable CheckForNull Throwable t if t null return Messages Functions NoExceptionDetails StringWriter sw new StringWriter t printStackTrace new PrintWriter sw return sw toString public static int determineRows String s if s null return 5 return Math max 5 LINE END split s length public static String toCCStatus Item i if i instanceof Job Job j Job i switch j getIconColor case ABORTED case ABORTED ANIME case RED case RED ANIME case YELLOW case YELLOW ANIME return Failure case BLUE case BLUE ANIME return Success case DISABLED case DISABLED ANIME case GREY case GREY ANIME case NOTBUILT case NOTBUILT ANIME return Unknown return Unknown private static final Pattern LINE END Pattern compile r n public static boolean isAnonymous return Jenkins getAuthentication instanceof AnonymousAuthenticationToken public static JellyContext getCurrentJellyContext JellyContext context ExpressionFactory2 CURRENT CONTEXT get assert context null return context public static String runScript Script script throws JellyTagException StringWriter out new StringWriter script run getCurrentJellyContext XMLOutput createXMLOutput out return out toString public static T List T subList List T base int maxSize if maxSize base size return base subList 0 maxSize else return base public static String joinPath String components StringBuilder buf new StringBuilder for String s components if s length 0 continue if buf length 0 if buf charAt buf length 1 buf append if s charAt 0 s s substring 1 buf append s return buf toString public static CheckForNull String getActionUrl String itUrl Action action String urlName action getUrlName if urlName null return null Should not be displayed try if new URI urlName isAbsolute return urlName catch URISyntaxException x Logger getLogger Functions class getName log Level WARNING Failed to parse URL for 0 1 new Object action x return null if urlName startsWith return joinPath Stapler getCurrentRequest getContextPath urlName else relative URL name return joinPath Stapler getCurrentRequest getContextPath itUrl urlName public static String toEmailSafeString String projectName TODO escape non ASCII characters StringBuilder buf new StringBuilder projectName length for int i 0 i projectName length i char ch projectName charAt i if a ch ch z z ch ch Z 0 ch ch 9 indexOf ch 0 buf append ch else buf append escape return projectName public String getServerName Try to infer this from the configured root URL This makes it work correctly when Hudson runs behind a reverse proxy String url Jenkins getInstance getRootUrl try if url null String host new URL url getHost if host null return host catch MalformedURLException e fall back to HTTP request return Stapler getCurrentRequest getServerName Deprecated public String getCheckUrl String userDefined Object descriptor String field if userDefined null field null return userDefined if descriptor instanceof Descriptor Descriptor d Descriptor descriptor return d getCheckUrl field return null public void calcCheckUrl Map attributes String userDefined Object descriptor String field if userDefined null field null return if descriptor instanceof Descriptor Descriptor d Descriptor descriptor CheckMethod m d getCheckMethod field attributes put checkUrl m toStemUrl attributes put checkDependsOn m getDependsOn public boolean hyperlinkMatchesCurrentPage String href throws UnsupportedEncodingException String url Stapler getCurrentRequest getRequestURL toString if href null href length 1 return equals href url endsWith url URLDecoder decode url UTF 8 href URLDecoder decode href UTF 8 if url endsWith url url substring 0 url length 1 if href endsWith href href substring 0 href length 1 return url endsWith href public T List T singletonList T t return Collections singletonList t public static List PageDecorator getPageDecorators this method may be called to render start up errors at which point Hudson doesn t exist yet see HUDSON 3608 if Jenkins getInstanceOrNull null return Collections emptyList return PageDecorator all public static List Descriptor Cloud getCloudDescriptors return Cloud all public String prepend String prefix String body if body null body length 0 return prefix body return body public static List Descriptor CrumbIssuer getCrumbIssuerDescriptors return CrumbIssuer all public static String getCrumb StaplerRequest req Jenkins h Jenkins getInstanceOrNull CrumbIssuer issuer h null h getCrumbIssuer null return issuer null issuer getCrumb req public static String getCrumbRequestField Jenkins h Jenkins getInstanceOrNull CrumbIssuer issuer h null h getCrumbIssuer null return issuer null issuer getDescriptor getCrumbRequestField public static Date getCurrentTime return new Date public static Locale getCurrentLocale Locale locale null StaplerRequest req Stapler getCurrentRequest if req null locale req getLocale if locale null locale Locale getDefault return locale public static String generateConsoleAnnotationScriptAndStylesheet String cp Stapler getCurrentRequest getContextPath StringBuilder buf new StringBuilder for ConsoleAnnotatorFactory f ConsoleAnnotatorFactory all String path cp extensionList ConsoleAnnotatorFactory class getName f getClass getName if f hasScript buf append script src append path append script js script if f hasStylesheet buf append link rel stylesheet type text css href append path append style css for ConsoleAnnotationDescriptor d ConsoleAnnotationDescriptor all String path cp descriptor d clazz getName if d hasScript buf append script src append path append script js script if d hasStylesheet buf append link rel stylesheet type text css href append path append style css return buf toString public List String getLoggerNames while true try List String r new ArrayList String Enumeration String e LogManager getLogManager getLoggerNames while e hasMoreElements r add e nextElement return r catch ConcurrentModificationException e retry public String getPasswordValue Object o if o null return null if o instanceof Secret StaplerRequest req Stapler getCurrentRequest if req null Item item req findAncestorObject Item class if item null item hasPermission Item CONFIGURE return return Secret o getEncryptedValue if getIsUnitTest o equals PasswordParameterDefinition DEFAULT VALUE throw new SecurityException attempted to render plaintext o in password field use a getter of type Secret instead return o toString public List filterDescriptors Object context Iterable descriptors return DescriptorVisibilityFilter apply context descriptors public static boolean getIsUnitTest return Main isUnitTest public static boolean isArtifactsPermissionEnabled return SystemProperties getBoolean hudson security ArtifactsPermission public static boolean isWipeOutPermissionEnabled return SystemProperties getBoolean hudson security WipeOutPermission public static String createRenderOnDemandProxy JellyContext context String attributesToCapture return Stapler getCurrentRequest createJavaScriptProxy new RenderOnDemandClosure context attributesToCapture public static String getCurrentDescriptorByNameUrl return Descriptor getCurrentDescriptorByNameUrl public static String setCurrentDescriptorByNameUrl String value String o getCurrentDescriptorByNameUrl Stapler getCurrentRequest setAttribute currentDescriptorByNameUrl value return o public static void restoreCurrentDescriptorByNameUrl String old Stapler getCurrentRequest setAttribute currentDescriptorByNameUrl old public static List String getRequestHeaders String name List String r new ArrayList String Enumeration e Stapler getCurrentRequest getHeaders name while e hasMoreElements r add e nextElement toString return r public static Object rawHtml Object o return o null null new RawHtmlArgument o public static ArrayList CLICommand getCLICommands ArrayList CLICommand all new ArrayList CLICommand CLICommand all Collections sort all new Comparator CLICommand public int compare CLICommand cliCommand CLICommand cliCommand1 return cliCommand getName compareTo cliCommand1 getName return all public static String getAvatar User user String avatarSize return UserAvatarResolver resolve user avatarSize Deprecated public String getUserAvatar User user String avatarSize return getAvatar user avatarSize public static String humanReadableByteSize long size String measure B if size 1024 return size measure Double number new Double size if number 1024 number number 1024 measure KB if number 1024 number number 1024 measure MB if number 1024 number number 1024 measure GB DecimalFormat format new DecimalFormat 0 00 return format format number measure public static String breakableString final String plain if plain null return null return plain replaceAll p Punct w wbr 1 replaceAll p Punct s 20 p Punct s 10 1 wbr public static void advertiseHeaders HttpServletResponse rsp Jenkins j Jenkins getInstanceOrNull if j null rsp setHeader X Hudson 1 395 rsp setHeader X Jenkins Jenkins VERSION rsp setHeader X Jenkins Session Jenkins SESSION HASH TcpSlaveAgentListener tal j tcpSlaveAgentListener if tal null int p tal getAdvertisedPort rsp setIntHeader X Hudson CLI Port p rsp setIntHeader X Jenkins CLI Port p rsp setIntHeader X Jenkins CLI2 Port p rsp setHeader X Jenkins CLI Host TcpSlaveAgentListener CLI HOST NAME Restricted NoExternalUse class for actions jelly and ContextMenu add public static boolean isContextMenuVisible Action a if a instanceof ModelObjectWithContextMenu ContextMenuVisibility return ModelObjectWithContextMenu ContextMenuVisibility a isVisible else return truepackage hudson model queue import hudson model Executor import jenkins model Jenkins import hudson model Queue import hudson model Queue Executable import hudson model Queue Task import hudson remoting AsyncFutureImpl import java util HashSet import java util Set import java util concurrent ExecutionException import java util concurrent Future import javax annotation Nonnull public final class FutureImpl extends AsyncFutureImpl Executable implements QueueTaskFuture Executable private final Task task private final Set Executor executors new HashSet Executor final AsyncFutureImpl Executable start new AsyncFutureImpl Executable public FutureImpl Task task this task task public Future Executable getStartCondition return start public final Executable waitForStart throws InterruptedException ExecutionException return getStartCondition get Override public boolean cancel boolean mayInterruptIfRunning Queue q Jenkins getInstance getQueue synchronized q synchronized this if executors isEmpty if mayInterruptIfRunning for Executor e executors e interrupt return mayInterruptIfRunning return q cancel task Override public synchronized void setAsCancelled super setAsCancelled if start isDone start setAsCancelled synchronized void addExecutor Nonnull Executor executor this executors add executorpackage hudson model queue public final class FutureLoad public final long startTime public final int numExecutors public final long duration public FutureLoad long startTime long duration int numExecutors this startTime startTime this numExecutors numExecutors this duration duration public String toString return startTime startTime executors numExecutors duration durationpackage hudson util import hudson remoting Future import java util concurrent TimeUnit public class Futures public static T Future T precomputed final T value return new Future T public boolean cancel boolean mayInterruptIfRunning return false public boolean isCancelled return false public boolean isDone return true public T get return value public T get long timeout TimeUnit unit return valuepackage com twitter sdk android tweetui import android app Activity import android os Bundle import com squareup picasso Picasso import com twitter sdk android core models MediaEntity import com twitter sdk android tweetui internal MultiTouchImageView public class GalleryActivity extends Activity static final String MEDIA ENTITY MEDIA ENTITY static final String TWEET ID TWEET ID Override protected void onCreate Bundle savedInstanceState super onCreate savedInstanceState setContentView R layout tw gallery activity final MediaEntity entity MediaEntity getIntent getSerializableExtra MEDIA ENTITY final MultiTouchImageView imageView MultiTouchImageView findViewById R id image view Picasso with this load entity mediaUrlHttps into imageViewpackage hudson cli handlers import hudson model Item import hudson model Items import hudson security ACL import hudson security ACLContext import java util logging Level import java util logging Logger import jenkins model Jenkins import org acegisecurity Authentication import org kohsuke args4j CmdLineException import org kohsuke args4j CmdLineParser import org kohsuke args4j OptionDef import org kohsuke args4j spi OptionHandler import org kohsuke args4j spi Parameters import org kohsuke args4j spi Setter public abstract class GenericItemOptionHandler T extends Item extends OptionHandler T private static final Logger LOGGER Logger getLogger GenericItemOptionHandler class getName protected GenericItemOptionHandler CmdLineParser parser OptionDef option Setter T setter super parser option setter protected abstract Class T type Override public int parseArguments Parameters params throws CmdLineException final Jenkins j Jenkins getInstance final String src params getParameter 0 T s j getItemByFullName src type if s null final Authentication who Jenkins getAuthentication try ACLContext ACL as ACL SYSTEM Item actual j getItemByFullName src if actual null LOGGER log Level FINE really no item exists named 0 src else LOGGER log Level WARNING running as 0 could not find 1 of 2 new Object who getPrincipal actual type T nearest Items findNearest type src j if nearest null throw new IllegalArgumentException No such job src perhaps you meant nearest getFullName else throw new IllegalArgumentException No such job src setter addValue s return 1 Override public String getDefaultMetaVariable return ITEMpackage com twitter sdk android core services params public class Geocode public enum Distance MILES mi KILOMETERS km public final String identifier Distance String identifier this identifier identifier public final double latitude public final double longitude public final int radius public final Distance distance public Geocode double latitude double longitude int radius Distance distance this latitude latitude this longitude longitude this radius radius this distance distance Override public String toString return latitude longitude radius distance identifierpackage hudson cli import hudson Extension import hudson model AbstractItem import org kohsuke args4j Argument Extension public class GetJobCommand extends CLICommand Argument metaVar JOB usage Name of the job required true public AbstractItem job Override public String getShortDescription return Messages GetJobCommand ShortDescription protected int run throws Exception job writeConfigDotXml stdout return 0package hudson cli import hudson Extension import hudson model Computer import hudson model Node import java io IOException import jenkins model Jenkins import org kohsuke args4j Argument Extension public class GetNodeCommand extends CLICommand Argument metaVar NODE usage Name of the node required true public Node node Override public String getShortDescription return Messages GetNodeCommand ShortDescription Override protected int run throws IOException node checkPermission Computer EXTENDED READ Jenkins XSTREAM2 toXMLUTF8 node stdout return 0package hudson cli import hudson Extension import hudson model View import org kohsuke args4j Argument Extension public class GetViewCommand extends CLICommand Argument usage Name of the view to obtain required true private View view Override public String getShortDescription return Messages GetViewCommand ShortDescription Override protected int run throws Exception view checkPermission View READ view writeXml stdout return 0package com kaku colorfulnews mvp entity import java util List public class GirlData private boolean isError private List PhotoGirl results public boolean isError return isError public void setError boolean error isError error public void setResults List PhotoGirl results this results results public List PhotoGirl getResults return resultspackage jenkins model import hudson Extension import hudson slaves Cloud import net sf json JSONObject import org jenkinsci Symbol import org kohsuke stapler StaplerRequest import java io IOException Extension ordinal 100 Symbol cloud historically this was placed at the very end of the configuration page public class GlobalCloudConfiguration extends GlobalConfiguration Override public boolean configure StaplerRequest req JSONObject json throws FormException try Jenkins getInstance clouds rebuildHetero req json Cloud all cloud return true catch IOException e throw new FormException e cloudspackage jenkins model import hudson ExtensionList import hudson ExtensionPoint import hudson model Describable import hudson model Descriptor import net sf json JSONObject import org kohsuke stapler StaplerRequest public abstract class GlobalConfiguration extends Descriptor GlobalConfiguration implements ExtensionPoint Describable GlobalConfiguration protected GlobalConfiguration super self public final Descriptor GlobalConfiguration getDescriptor return this Override public String getGlobalConfigPage return getConfigPage Override public boolean configure StaplerRequest req JSONObject json throws FormException req bindJSON this json return true public static ExtensionList GlobalConfiguration all return Jenkins getInstance GlobalConfiguration GlobalConfiguration getDescriptorList GlobalConfiguration class pointless type parameters help work around bugs in javac in earlier versions http codepad org m1bbFRrHpackage jenkins model import hudson Extension import hudson ExtensionList import hudson ExtensionPoint import hudson model ModelObject import hudson security import hudson security Messages import org jenkinsci Symbol public abstract class GlobalConfigurationCategory implements ExtensionPoint ModelObject public abstract String getShortDescription public static ExtensionList GlobalConfigurationCategory all return ExtensionList lookup GlobalConfigurationCategory class public static T extends GlobalConfigurationCategory T get Class T type return all get type Extension Symbol unclassified public static class Unclassified extends GlobalConfigurationCategory Override public String getShortDescription return jenkins management Messages ConfigureLink Description public String getDisplayName return jenkins management Messages ConfigureLink DisplayName Extension Symbol security public static class Security extends GlobalConfigurationCategory Override public String getShortDescription return hudson security Messages GlobalSecurityConfiguration Description public String getDisplayName return hudson security Messages GlobalSecurityConfiguration DisplayNamepackage hudson security csrf import hudson Extension import jenkins model GlobalConfiguration import jenkins model GlobalConfigurationCategory import jenkins model Jenkins import net sf json JSONObject import org jenkinsci Symbol import org kohsuke stapler StaplerRequest Extension ordinal 195 Symbol crumb immediately after the security setting public class GlobalCrumbIssuerConfiguration extends GlobalConfiguration Override public GlobalConfigurationCategory getCategory return GlobalConfigurationCategory get GlobalConfigurationCategory Security class Override public boolean configure StaplerRequest req JSONObject json throws FormException for compatibility reasons the actual value is stored in Jenkins Jenkins j Jenkins getInstance if json has csrf JSONObject csrf json getJSONObject csrf j setCrumbIssuer CrumbIssuer all newInstanceFromRadioList csrf issuer else j setCrumbIssuer null return truepackage hudson views import hudson Extension import jenkins model GlobalConfiguration import jenkins model Jenkins import net sf json JSONObject import org jenkinsci Symbol import org kohsuke stapler StaplerRequest Extension ordinal 300 Symbol defaultView public class GlobalDefaultViewConfiguration extends GlobalConfiguration Override public boolean configure StaplerRequest req JSONObject json throws FormException for compatibility reasons the actual value is stored in Jenkins Jenkins j Jenkins getInstance j setPrimaryView json has primaryView j getView json getString primaryView j getViews iterator next return truepackage jenkins mvn import hudson Extension import jenkins model GlobalConfiguration import jenkins model GlobalConfigurationCategory import jenkins tools ToolConfigurationCategory import org jenkinsci Symbol as close as it gets to the global Maven Project configuration Extension ordinal 50 Symbol maven public class GlobalMavenConfig extends GlobalConfiguration private SettingsProvider settingsProvider private GlobalSettingsProvider globalSettingsProvider public GlobalMavenConfig load Override public ToolConfigurationCategory getCategory return GlobalConfigurationCategory get ToolConfigurationCategory class public void setGlobalSettingsProvider GlobalSettingsProvider globalSettingsProvider this globalSettingsProvider globalSettingsProvider save public void setSettingsProvider SettingsProvider settingsProvider this settingsProvider settingsProvider save public GlobalSettingsProvider getGlobalSettingsProvider return globalSettingsProvider null globalSettingsProvider new DefaultGlobalSettingsProvider public SettingsProvider getSettingsProvider return settingsProvider null settingsProvider new DefaultSettingsProvider public static GlobalMavenConfig get return GlobalConfiguration all get GlobalMavenConfig classpackage jenkins model import hudson Extension import hudson slaves NodeProperty import hudson slaves NodePropertyDescriptor import net sf json JSONObject import org jenkinsci Symbol import org kohsuke stapler StaplerRequest import java io IOException Extension ordinal 110 Symbol nodeProperties historically this was placed above GlobalPluginConfiguration public class GlobalNodePropertiesConfiguration extends GlobalConfiguration Override public boolean configure StaplerRequest req JSONObject json throws FormException try Jenkins j Jenkins getInstance JSONObject np json getJSONObject globalNodeProperties if np isNullObject j getGlobalNodeProperties rebuild req np NodeProperty for j return true catch IOException e throw new FormException e globalNodePropertiespackage jenkins model import hudson Extension import hudson Plugin import hudson StructuredForm import net sf json JSONObject import org jenkinsci Symbol import org kohsuke stapler StaplerRequest import javax servlet ServletException import java io IOException Extension ordinal 100 Symbol plugin historically this was placed above general configuration from arbitrary descriptors public class GlobalPluginConfiguration extends GlobalConfiguration Override public boolean configure StaplerRequest req JSONObject json throws FormException try for JSONObject o StructuredForm toList json plugin Jenkins getInstance pluginManager getPlugin o getString name getPlugin configure req o return true catch IOException ServletException e throw new FormException e pluginpackage jenkins model import hudson Extension import jenkins model ProjectNamingStrategy DefaultProjectNamingStrategy import net sf json JSONObject import org jenkinsci Symbol import org kohsuke stapler StaplerRequest Extension ordinal 250 Symbol projectNamingStrategy public class GlobalProjectNamingStrategyConfiguration extends GlobalConfiguration Override public boolean configure StaplerRequest req JSONObject json throws hudson model Descriptor FormException for compatibility reasons the actual value is stored in Jenkins Jenkins j Jenkins getInstance final JSONObject optJSONObject json optJSONObject useProjectNamingStrategy if optJSONObject null final JSONObject strategyObject optJSONObject getJSONObject namingStrategy final String className strategyObject getString class try Class clazz Class forName className true Jenkins getInstance getPluginManager uberClassLoader final ProjectNamingStrategy strategy ProjectNamingStrategy req bindJSON clazz strategyObject j setProjectNamingStrategy strategy catch ClassNotFoundException e throw new FormException e namingStrategy if j getProjectNamingStrategy null j setProjectNamingStrategy DefaultProjectNamingStrategy DEFAULT NAMING STRATEGY return truepackage jenkins model import hudson Extension import net sf json JSONObject import org jenkinsci Symbol import org kohsuke stapler StaplerRequest import java io IOException Extension ordinal 400 Symbol quietPeriod public class GlobalQuietPeriodConfiguration extends GlobalConfiguration public int getQuietPeriod return Jenkins getInstance getQuietPeriod Override public boolean configure StaplerRequest req JSONObject json throws FormException int i 0 try i Integer parseInt json getString quietPeriod catch NumberFormatException e fall through try for compatibility reasons this value is stored in Jenkins Jenkins getInstance setQuietPeriod i return true catch IOException e throw new FormException e quietPeriodpackage jenkins model import hudson Extension import net sf json JSONException import net sf json JSONObject import org jenkinsci Symbol import org kohsuke stapler StaplerRequest import java io IOException Extension ordinal 395 Symbol scmRetryCount public class GlobalSCMRetryCountConfiguration extends GlobalConfiguration public int getScmCheckoutRetryCount return Jenkins getInstance getScmCheckoutRetryCount Override public boolean configure StaplerRequest req JSONObject json throws FormException try for compatibility reasons this value is stored in Jenkins Jenkins getInstance setScmCheckoutRetryCount json getInt scmCheckoutRetryCount return true catch IOException e throw new FormException e quietPeriod catch JSONException e throw new FormException e getMessage quietPeriodpackage hudson security import com google common base Predicate import hudson BulkChange import hudson Extension import hudson Functions import hudson markup MarkupFormatter import hudson model Descriptor import hudson model Descriptor FormException import hudson model Describable import hudson model ManagementLink import hudson util FormApply import java io IOException import java util Set import java util TreeSet import java util logging Level import java util logging Logger import javax servlet ServletException import jenkins model GlobalConfigurationCategory import jenkins model Jenkins import jenkins util ServerTcpPort import net sf json JSONArray import net sf json JSONObject import org jenkinsci Symbol import org kohsuke accmod Restricted import org kohsuke accmod restrictions DoNotUse import org kohsuke accmod restrictions NoExternalUse import org kohsuke stapler StaplerRequest import org kohsuke stapler StaplerResponse Extension ordinal Integer MAX VALUE 210 Symbol securityConfig public class GlobalSecurityConfiguration extends ManagementLink implements Describable GlobalSecurityConfiguration private static final Logger LOGGER Logger getLogger GlobalSecurityConfiguration class getName public MarkupFormatter getMarkupFormatter return Jenkins getInstance getMarkupFormatter public int getSlaveAgentPort return Jenkins getInstance getSlaveAgentPort Restricted DoNotUse class only for index groovy public boolean isSlaveAgentPortEnforced return Jenkins getInstance isSlaveAgentPortEnforced public Set String getAgentProtocols return Jenkins getInstance getAgentProtocols public boolean isDisableRememberMe return Jenkins getInstance isDisableRememberMe public synchronized void doConfigure StaplerRequest req StaplerResponse rsp throws IOException ServletException FormException for compatibility reasons the actual value is stored in Jenkins BulkChange bc new BulkChange Jenkins getInstance try boolean result configure req req getSubmittedForm LOGGER log Level FINE security saved result Jenkins getInstance save FormApply success req getContextPath manage generateResponse req rsp null finally bc commit public boolean configure StaplerRequest req JSONObject json throws hudson model Descriptor FormException for compatibility reasons the actual value is stored in Jenkins Jenkins j Jenkins getInstance j checkPermission Jenkins ADMINISTER if json has useSecurity JSONObject security json getJSONObject useSecurity j setDisableRememberMe security optBoolean disableRememberMe false j setSecurityRealm SecurityRealm all newInstanceFromRadioList security realm j setAuthorizationStrategy AuthorizationStrategy all newInstanceFromRadioList security authorization try j setSlaveAgentPort new ServerTcpPort security getJSONObject slaveAgentPort getPort catch IOException e throw new hudson model Descriptor FormException e slaveAgentPortType Set String agentProtocols new TreeSet if security has agentProtocol Object protocols security get agentProtocol if protocols instanceof JSONArray for int i 0 i JSONArray protocols size i agentProtocols add JSONArray protocols getString i else agentProtocols add protocols toString j setAgentProtocols agentProtocols else j disableSecurity if json has markupFormatter j setMarkupFormatter req bindJSON MarkupFormatter class json getJSONObject markupFormatter else j setMarkupFormatter null persist all the additional security configs boolean result true for Descriptor d Functions getSortedDescriptorsForGlobalConfig FILTER result configureDescriptor req json d return result private boolean configureDescriptor StaplerRequest req JSONObject json Descriptor d throws FormException collapse the structure to remain backward compatible with the JSON structure before 1 String name d getJsonSafeClassName JSONObject js json has name json getJSONObject name new JSONObject if it doesn t have the property the method returns invalid null object json putAll js return d configure req js Override public String getDisplayName return getDescriptor getDisplayName Override public String getDescription return Messages GlobalSecurityConfiguration Description Override public String getIconFileName return secure png Override public String getUrlName return configureSecurity Override public Permission getRequiredPermission return Jenkins ADMINISTER public static Predicate GlobalConfigurationCategory FILTER new Predicate GlobalConfigurationCategory public boolean apply GlobalConfigurationCategory input return input instanceof GlobalConfigurationCategory Security SuppressWarnings unchecked Override public Descriptor GlobalSecurityConfiguration getDescriptor return Jenkins getInstance getDescriptorOrDie getClass Extension Symbol security public static final class DescriptorImpl extends Descriptor GlobalSecurityConfiguration Override public String getDisplayName return Messages GlobalSecurityConfiguration DisplayNamepackage jenkins mvn import hudson ExtensionPoint import hudson FilePath import hudson model AbstractBuild import hudson model AbstractDescribableImpl import hudson model Descriptor import hudson model TaskListener import javax servlet ServletException import net sf json JSONObject import org kohsuke stapler StaplerRequest public abstract class GlobalSettingsProvider extends AbstractDescribableImpl GlobalSettingsProvider implements ExtensionPoint public abstract FilePath supplySettings AbstractBuild build TaskListener listener public static GlobalSettingsProvider parseSettingsProvider StaplerRequest req throws Descriptor FormException ServletException JSONObject settings req getSubmittedForm getJSONObject globalSettings if settings null return new DefaultGlobalSettingsProvider return req bindJSON GlobalSettingsProvider class settings public static final FilePath getSettingsFilePath GlobalSettingsProvider settings AbstractBuild build TaskListener listener FilePath settingsPath null if settings null settingsPath settings supplySettings build listener return settingsPath public static final String getSettingsRemotePath GlobalSettingsProvider provider AbstractBuild build TaskListener listener FilePath fp getSettingsFilePath provider build listener return fp null null fp getRemotepackage jenkins mvn import com infradna tool bridge method injector WithBridgeMethods import hudson DescriptorExtensionList import hudson model Descriptor import java util List import jenkins model Jenkins public abstract class GlobalSettingsProviderDescriptor extends Descriptor GlobalSettingsProvider WithBridgeMethods List class public static DescriptorExtensionList GlobalSettingsProvider GlobalSettingsProviderDescriptor all return Jenkins getInstance GlobalSettingsProvider GlobalSettingsProviderDescriptor getDescriptorList GlobalSettingsProvider classpackage jenkins tools import com google common base Predicate import hudson Extension import hudson Functions import hudson model Descriptor import hudson model ManagementLink import hudson security Permission import hudson util FormApply import jenkins model GlobalConfigurationCategory import jenkins model Jenkins import net sf json JSONObject import org kohsuke accmod Restricted import org kohsuke accmod restrictions NoExternalUse import org kohsuke stapler StaplerRequest import org kohsuke stapler StaplerResponse import javax servlet ServletException import java io IOException import java util logging Level import java util logging Logger Extension ordinal Integer MAX VALUE 220 Restricted NoExternalUse class public class GlobalToolConfiguration extends ManagementLink Override public String getIconFileName return setting png Override public String getDisplayName return jenkins management Messages ConfigureTools DisplayName Override public String getDescription return jenkins management Messages ConfigureTools Description Override public String getUrlName return configureTools Override public Permission getRequiredPermission return Jenkins ADMINISTER public synchronized void doConfigure StaplerRequest req StaplerResponse rsp throws IOException ServletException Descriptor FormException boolean result configure req req getSubmittedForm LOGGER log Level FINE tools saved result FormApply success req getContextPath manage generateResponse req rsp null private boolean configure StaplerRequest req JSONObject json throws hudson model Descriptor FormException IOException Jenkins j Jenkins getInstance j checkPermission Jenkins ADMINISTER boolean result true for Descriptor d Functions getSortedDescriptorsForGlobalConfig FILTER result configureDescriptor req json d j save return result private boolean configureDescriptor StaplerRequest req JSONObject json Descriptor d throws Descriptor FormException String name d getJsonSafeClassName JSONObject js json has name json getJSONObject name new JSONObject if it doesn t have the property the method returns invalid null object json putAll js return d configure req js public static Predicate GlobalConfigurationCategory FILTER new Predicate GlobalConfigurationCategory public boolean apply GlobalConfigurationCategory input return input instanceof ToolConfigurationCategory private static final Logger LOGGER Logger getLogger GlobalToolConfiguration class getNamepackage hudson util jna import com sun jna Library import com sun jna StringArray import com sun jna Pointer import com sun jna Native import com sun jna Memory import com sun jna NativeLong import com sun jna LastErrorException import com sun jna ptr IntByReference import jnr posix POSIX import org jvnet libpam impl CLibrary passwd public interface GNUCLibrary extends Library int fork int kill int pid int signum int setsid int umask int mask int getpid int geteuid int getegid int getppid int chdir String dir int getdtablesize int execv String path StringArray args int execvp String file StringArray args int setenv String name String value int replace int unsetenv String name void perror String msg String strerror int errno passwd getpwuid int uid int fcntl int fd int command int fcntl int fd int command int flags obtained from Linux Needs to be checked if these values are portable int F GETFD 1 int F SETFD 2 int FD CLOEXEC 1 int chown String fileName int uid int gid int chmod String fileName int i int open String pathname int flags throws LastErrorException int dup int old int dup2 int old int new long pread int fd Memory buffer NativeLong size NativeLong offset throws LastErrorException int close int fd see http www gnu org s libc manual html node Renaming Files html int rename String oldname String newname this is listed in http developer apple com DOCUMENTATION Darwin Reference ManPages man3 sysctlbyname 3 html but not in http www gnu org software libc manual html node System Parameters html index sysctl 3493 perhaps it is only supported on BSD int sysctlbyname String name Pointer oldp IntByReference oldlenp Pointer newp IntByReference newlen int sysctl int mib int nameLen Pointer oldp IntByReference oldlenp Pointer newp IntByReference newlen int sysctlnametomib String name Pointer mibp IntByReference size int symlink String oldname String newname int readlink String filename Memory buffer NativeLong size GNUCLibrary LIBC GNUCLibrary Native loadLibrary c GNUCLibrary classpackage hudson util import org jfree chart JFreeChart import org jfree chart ChartRenderingInfo import org jfree chart ChartUtilities import org jfree chart plot Plot import org kohsuke stapler StaplerRequest import org kohsuke stapler StaplerResponse import javax servlet ServletOutputStream import javax imageio ImageIO import java io IOException import java util Calendar import java awt image BufferedImage import java awt import javax annotation Nonnull import javax annotation CheckForNull public abstract class Graph private final long timestamp private final int defaultW private final int defaultH private volatile JFreeChart graph protected Graph long timestamp int defaultW int defaultH this timestamp timestamp this defaultW defaultW this defaultH defaultH protected Graph Calendar timestamp int defaultW int defaultH this timestamp getTimeInMillis defaultW defaultH protected abstract JFreeChart createGraph private BufferedImage render StaplerRequest req ChartRenderingInfo info String w req getParameter width if w null w String valueOf defaultW String h req getParameter height if h null h String valueOf defaultH Color graphBg stringToColor req getParameter graphBg Color plotBg stringToColor req getParameter plotBg if graph null graph createGraph graph setBackgroundPaint graphBg Plot p graph getPlot p setBackgroundPaint plotBg return graph createBufferedImage Integer parseInt w Integer parseInt h info Nonnull private static Color stringToColor CheckForNull String s if s null try return Color decode 0x s catch NumberFormatException e return Color WHITE else return Color WHITE public void doPng StaplerRequest req StaplerResponse rsp throws IOException if req checkIfModified timestamp rsp return try BufferedImage image render req null rsp setContentType image png ServletOutputStream os rsp getOutputStream ImageIO write image PNG os os close catch Error e if e getMessage contains Probable fatal error No fonts found rsp sendRedirect2 req getContextPath images headless png return throw e otherwise let the caller deal with it catch HeadlessException e not available send out error message rsp sendRedirect2 req getContextPath images headless png public void doMap StaplerRequest req StaplerResponse rsp throws IOException if req checkIfModified timestamp rsp return ChartRenderingInfo info new ChartRenderingInfo render req info rsp setContentType text plain charset UTF 8 rsp getWriter println ChartUtilities getImageMap map infopackage hudson cli import groovy lang GroovyShell import groovy lang Binding import hudson cli util ScriptLoader import hudson model AbstractProject import jenkins model Jenkins import hudson model Item import hudson model Run import hudson Extension import org kohsuke args4j Argument import org kohsuke args4j CmdLineException import org apache commons io IOUtils import java io IOException import java io PrintWriter import java util ArrayList import java util List Extension public class GroovyCommand extends CLICommand Override public String getShortDescription return Messages GroovyCommand ShortDescription Argument metaVar SCRIPT usage Script to be executed File URL or to represent stdin public String script Argument metaVar ARGUMENTS index 1 usage Command line arguments to pass into script public List String remaining new ArrayList String protected int run throws Exception this allows the caller to manipulate the JVM state so require the execute script privilege Jenkins getActiveInstance checkPermission Jenkins RUN SCRIPTS Binding binding new Binding binding setProperty out new PrintWriter stdout true binding setProperty stdin stdin binding setProperty stdout stdout binding setProperty stderr stderr binding setProperty channel channel String j getClientEnvironmentVariable JOB NAME if j null Item job Jenkins getActiveInstance getItemByFullName j binding setProperty currentJob job String b getClientEnvironmentVariable BUILD NUMBER if b null job instanceof AbstractProject Run r AbstractProject job getBuildByNumber Integer parseInt b binding setProperty currentBuild r GroovyShell groovy new GroovyShell Jenkins getActiveInstance getPluginManager uberClassLoader binding groovy run loadScript RemoteClass remaining toArray new String remaining size return 0 private String loadScript throws CmdLineException IOException InterruptedException if script null throw new CmdLineException null No script is specified if script equals return IOUtils toString stdin return checkChannel call new ScriptLoader scriptpackage jenkins util groovy import groovy lang Binding import groovy lang GroovyCodeSource import groovy lang GroovyShell import java io File import java io FileFilter import java io IOException import java net URL import java util Arrays import java util Set import java util TreeSet import static java util logging Level WARNING import java util logging Logger import javax annotation Nonnull import javax servlet ServletContext import jenkins model Jenkins public class GroovyHookScript private final String hook private final Binding bindings new Binding private final ServletContext servletContext private final File home private final ClassLoader loader Deprecated public GroovyHookScript String hook this hook Jenkins getActiveInstance private GroovyHookScript String hook Jenkins j this hook j servletContext j getRootDir j getPluginManager uberClassLoader public GroovyHookScript String hook Nonnull ServletContext servletContext Nonnull File home Nonnull ClassLoader loader this hook hook this servletContext servletContext this home home this loader loader public GroovyHookScript bind String name Object o bindings setProperty name o return this public Binding getBindings return bindings public void run final String hookGroovy hook groovy final String hookGroovyD hook groovy d try URL bundled servletContext getResource WEB INF hookGroovy execute bundled catch IOException e LOGGER log WARNING Failed to execute WEB INF hookGroovy e Set String resources servletContext getResourcePaths WEB INF hookGroovyD if resources null sort to execute them in a deterministic order for String res new TreeSet String resources try URL bundled servletContext getResource res execute bundled catch IOException e LOGGER log WARNING Failed to execute res e File script new File home hookGroovy execute script File scriptD new File home hookGroovyD if scriptD isDirectory File scripts scriptD listFiles new FileFilter public boolean accept File f return f getName endsWith groovy if scripts null sort to run them in a deterministic order Arrays sort scripts for File f scripts execute f protected void execute URL bundled throws IOException if bundled null LOGGER info Executing bundled script bundled execute new GroovyCodeSource bundled protected void execute File f if f exists LOGGER info Executing f try execute new GroovyCodeSource f catch IOException e LOGGER log WARNING Failed to execute f e protected void execute GroovyCodeSource s try createShell evaluate s catch RuntimeException x LOGGER log WARNING Failed to run script s getName x protected GroovyShell createShell return new GroovyShell loader bindings private static final Logger LOGGER Logger getLogger GroovyHookScript class getNamepackage hudson init impl import hudson init Initializer import jenkins model Jenkins import jenkins util groovy GroovyHookScript import static hudson init InitMilestone public class GroovyInitScript Initializer after JOB LOADED public static void init Jenkins j new GroovyHookScript init j servletContext j getRootDir j getPluginManager uberClassLoader runpackage hudson cli import hudson Extension import jenkins model Jenkins import hudson remoting ChannelClosedException import groovy lang Binding import groovy lang Closure import org codehaus groovy tools shell Groovysh import org codehaus groovy tools shell IO import org codehaus groovy tools shell Shell import org codehaus groovy tools shell util XmlCommandRegistrar import java util List import java io PrintStream import java io InputStream import java io BufferedInputStream import java io PrintWriter import java util ArrayList import jline UnsupportedTerminal import jline TerminalFactory import org kohsuke args4j Argument Extension public class GroovyshCommand extends CLICommand Override public String getShortDescription return Messages GroovyshCommand ShortDescription Argument metaVar ARGS public List String args new ArrayList String Override protected int run this allows the caller to manipulate the JVM state so require the admin privilege Jenkins getActiveInstance checkPermission Jenkins RUN SCRIPTS this being remote means no jline capability is available System setProperty jline terminal UnsupportedTerminal class getName TerminalFactory reset StringBuilder commandLine new StringBuilder for String arg args if commandLine length 0 commandLine append commandLine append arg Groovysh shell createShell stdin stdout stderr return shell run commandLine toString SuppressWarnings unchecked rawtypes protected Groovysh createShell InputStream stdin PrintStream stdout PrintStream stderr Binding binding new Binding redirect println to the CLI binding setProperty out new PrintWriter stdout true binding setProperty hudson Jenkins getActiveInstance backward compatibility binding setProperty jenkins Jenkins getActiveInstance IO io new IO new BufferedInputStream stdin stdout stderr final ClassLoader cl Jenkins getActiveInstance pluginManager uberClassLoader Closure registrar new Closure null null private static final long serialVersionUID 1L SuppressWarnings unused edu umd cs findbugs annotations SuppressFBWarnings value UMAC UNCALLABLE METHOD OF ANONYMOUS CLASS justification Closure invokes this via reflection public Object doCall Object args assert args length 1 assert args 0 instanceof Shell Shell shell Shell args 0 XmlCommandRegistrar r new XmlCommandRegistrar shell cl r register GroovyshCommand class getResource commands xml return null Groovysh shell new Groovysh cl binding io registrar shell getImports add hudson model defaultErrorHook doesn t re throw IOException so ShellRunner in Groovysh will keep looping forever if we don t terminate when the channel is closed final Closure originalErrorHook shell getErrorHook shell setErrorHook new Closure shell shell private static final long serialVersionUID 1L SuppressWarnings unused edu umd cs findbugs annotations SuppressFBWarnings value UMAC UNCALLABLE METHOD OF ANONYMOUS CLASS justification Closure invokes this via reflection public Object doCall Object args throws ChannelClosedException if args length 1 args 0 instanceof ChannelClosedException throw ChannelClosedException args 0 return originalErrorHook call args return shellpackage hudson security import org acegisecurity userdetails UserDetails import java util Set public abstract class GroupDetails public abstract String getName public String getDisplayName return getName public Set String getMembers return nullpackage com twitter sdk android core internal network import com twitter sdk android core GuestSession import com twitter sdk android core GuestSessionProvider import com twitter sdk android core internal oauth GuestAuthToken import com twitter sdk android core internal oauth OAuthConstants import java io IOException import okhttp3 Authenticator import okhttp3 Request import okhttp3 Response import okhttp3 Route public class GuestAuthenticator implements Authenticator static final int MAX RETRIES 2 final GuestSessionProvider guestSessionProvider public GuestAuthenticator GuestSessionProvider guestSessionProvider this guestSessionProvider guestSessionProvider Override public Request authenticate Route route Response response throws IOException return reauth response Request reauth Response response if canRetry response final GuestSession session guestSessionProvider refreshCurrentSession new GuestSession getExpiredToken response final GuestAuthToken token session null null session getAuthToken if token null return resign response request token return null GuestAuthToken getExpiredToken Response response final String auth response request header OAuthConstants HEADER AUTHORIZATION final String guest response request header OAuthConstants HEADER GUEST TOKEN return new GuestAuthToken bearer auth replace bearer guest Request resign Request request GuestAuthToken token final Request Builder builder request newBuilder GuestAuthInterceptor addAuthHeaders builder token return builder build boolean canRetry Response response int responseCount 1 while response response priorResponse null responseCount return responseCount MAX RETRIESpackage com twitter sdk android core internal network import com twitter sdk android core GuestSession import com twitter sdk android core GuestSessionProvider import com twitter sdk android core internal oauth GuestAuthToken import com twitter sdk android core internal oauth OAuthConstants import java io IOException import okhttp3 Interceptor import okhttp3 Request import okhttp3 Response public class GuestAuthInterceptor implements Interceptor final GuestSessionProvider guestSessionProvider public GuestAuthInterceptor GuestSessionProvider guestSessionProvider this guestSessionProvider guestSessionProvider Override public Response intercept Chain chain throws IOException final Request request chain request final GuestSession session guestSessionProvider getCurrentSession final GuestAuthToken token session null null session getAuthToken if token null final Request Builder builder request newBuilder addAuthHeaders builder token return chain proceed builder build return chain proceed request static void addAuthHeaders Request Builder builder GuestAuthToken token final String authHeader token getTokenType token getAccessToken builder header OAuthConstants HEADER AUTHORIZATION authHeader builder header OAuthConstants HEADER GUEST TOKEN token getGuestTokenpackage com twitter sdk android core internal network import java io IOException import okhttp3 Interceptor import okhttp3 Response public class GuestAuthNetworkInterceptor implements Interceptor Override public Response intercept Chain chain throws IOException Response response chain proceed chain request if response code 403 response response newBuilder code 401 build return responsepackage com twitter sdk android core internal oauth import android text format DateUtils import com google gson annotations SerializedName public class GuestAuthToken extends OAuth2Token public static final String HEADER GUEST TOKEN x guest token private static final long EXPIRES IN MS DateUtils HOUR IN MILLIS 3 SerializedName guest token private final String guestToken public GuestAuthToken String tokenType String accessToken String guestToken super tokenType accessToken this guestToken guestToken public GuestAuthToken String tokenType String accessToken String guestToken long createdAt super tokenType accessToken createdAt this guestToken guestToken public String getGuestToken return guestToken Passbird maintains guest tokens for at least 1 hour but no more than 3 hours Tokens older than 3 hours are known to have expired and should not be reused Override public boolean isExpired return System currentTimeMillis this createdAt EXPIRES IN MS Override public boolean equals Object o if this o return true if o null getClass o getClass return false if super equals o return false final GuestAuthToken that GuestAuthToken o if guestToken null guestToken equals that guestToken that guestToken null return false return true Override public int hashCode int result super hashCode result 31 result guestToken null guestToken hashCode 0 return resultpackage com twitter sdk android core import android text TextUtils import com google gson Gson import com google gson GsonBuilder import com twitter sdk android core internal oauth GuestAuthToken import io fabric sdk android Fabric import io fabric sdk android services persistence SerializationStrategy public class GuestSession extends Session GuestAuthToken public static final long LOGGED OUT USER ID 0L public GuestSession GuestAuthToken authToken super authToken LOGGED OUT USER ID static public class Serializer implements SerializationStrategy GuestSession private final Gson gson public Serializer this gson new GsonBuilder registerTypeAdapter GuestAuthToken class new AuthTokenAdapter create Override public String serialize GuestSession session if session null session getAuthToken null try return gson toJson session catch Exception e Fabric getLogger d TwitterCore TAG Failed to serialize session e getMessage return Override public GuestSession deserialize String serializedSession if TextUtils isEmpty serializedSession try return gson fromJson serializedSession GuestSession class catch Exception e Fabric getLogger d TwitterCore TAG Failed to deserialize session e getMessage return nullpackage com twitter sdk android core import com twitter sdk android core internal oauth GuestAuthToken import com twitter sdk android core internal oauth OAuth2Service import java util concurrent CountDownLatch import io fabric sdk android Fabric public class GuestSessionProvider private final OAuth2Service oAuth2Service private final SessionManager GuestSession sessionManager public GuestSessionProvider OAuth2Service oAuth2Service SessionManager GuestSession sessionManager this oAuth2Service oAuth2Service this sessionManager sessionManager public synchronized GuestSession getCurrentSession final GuestSession session sessionManager getActiveSession if isSessionValid session return session refreshToken return sessionManager getActiveSession public synchronized GuestSession refreshCurrentSession GuestSession expiredSession final GuestSession session sessionManager getActiveSession if expiredSession null expiredSession equals session refreshToken return sessionManager getActiveSession void refreshToken Fabric getLogger d GuestSessionProvider Refreshing expired guest session final CountDownLatch latch new CountDownLatch 1 oAuth2Service requestGuestAuthToken new Callback GuestAuthToken Override public void success Result GuestAuthToken result sessionManager setActiveSession new GuestSession result data latch countDown Override public void failure TwitterException exception sessionManager clearSession GuestSession LOGGED OUT USER ID latch countDown try latch await catch InterruptedException e sessionManager clearSession GuestSession LOGGED OUT USER ID boolean isSessionValid GuestSession session return session null session getAuthToken null session getAuthToken isExpiredpackage com twitter sdk android core internal oauth import com google gson annotations SerializedName class GuestTokenResponse SerializedName guest token public final String guestToken public GuestTokenResponse String guestToken this guestToken guestTokenpackage hudson scheduler import java io UnsupportedEncodingException import java security MessageDigest import java security NoSuchAlgorithmException import java util Random public abstract class Hash Hash public abstract int next int n public static Hash from String seed try MessageDigest md5 MessageDigest getInstance MD5 md5 update seed getBytes UTF 8 byte digest md5 digest for int i 8 i digest length i digest i 8 digest i long l 0 for int i 0 i 8 i l l 8 digest i 0xFF final Random rnd new Random l return new Hash Override public int next int n return rnd nextInt n catch NoSuchAlgorithmException e throw new AssertionError e MD5 is a part of JRE catch UnsupportedEncodingException e throw new AssertionError e UTF 8 is mandatory public static Hash zero return ZERO private static final Hash ZERO new Hash Override public int next int n return 0package com twitter sdk android core models import com google gson annotations SerializedName public class HashtagEntity extends Entity SerializedName text public final String text public HashtagEntity String text int start int end super start end this text textpackage hudson util import org apache commons io output ByteArrayOutputStream import java io FilterInputStream import java io InputStream import java io IOException public class HeadBufferingStream extends FilterInputStream private final ByteArrayOutputStream side private final int sideBufferSize public HeadBufferingStream InputStream in int sideBufferSize super in this sideBufferSize sideBufferSize this side new ByteArrayOutputStream sideBufferSize Override public int read throws IOException int i in read if i 0 space 0 side write i return i Override public int read byte b int off int len throws IOException int r in read b off len if r 0 int sp space if sp 0 side write b off Math min r sp return r private int space return sideBufferSize side size public void fillSide throws IOException byte buf new byte space while space 0 if read buf 0 return public byte getSideBuffer return side toByteArraypackage hudson model import com thoughtworks xstream converters UnmarshallingContext import hudson diagnosis OldDataMonitor import hudson util XStream2 import jenkins model Jenkins import jenkins util NonLocalizable import org jvnet localizer Localizable import org kohsuke stapler export Exported import org kohsuke stapler export ExportedBean import java io import java util Collections import java util HashMap import java util List import java util Map ExportedBean defaultVisibility 2 this is always exported as a part of Job and never on its own so start with 2 public class HealthReport implements Serializable Comparable HealthReport These are now 0 20 21 40 41 60 61 80 81 but filenames unchanged for compatibility private static final String HEALTH OVER 80 icon health 80plus private static final String HEALTH 61 TO 80 icon health 60to79 private static final String HEALTH 41 TO 60 icon health 40to59 private static final String HEALTH 21 TO 40 icon health 20to39 private static final String HEALTH 0 TO 20 icon health 00to19 private static final String HEALTH OVER 80 IMG health 80plus png private static final String HEALTH 61 TO 80 IMG health 60to79 png private static final String HEALTH 41 TO 60 IMG health 40to59 png private static final String HEALTH 21 TO 40 IMG health 20to39 png private static final String HEALTH 0 TO 20 IMG health 00to19 png private static final String HEALTH UNKNOWN IMG empty png private static final Map String String iconIMGToClassMap new HashMap String String static iconIMGToClassMap put HEALTH OVER 80 IMG HEALTH OVER 80 iconIMGToClassMap put HEALTH 61 TO 80 IMG HEALTH 61 TO 80 iconIMGToClassMap put HEALTH 41 TO 60 IMG HEALTH 41 TO 60 iconIMGToClassMap put HEALTH 21 TO 40 IMG HEALTH 21 TO 40 iconIMGToClassMap put HEALTH 0 TO 20 IMG HEALTH 0 TO 20 private int score private String iconClassName private String iconUrl Deprecated private transient String description private Localizable localizibleDescription Deprecated public HealthReport int score String iconUrl String description this score iconUrl new NonLocalizable description public HealthReport int score String iconUrl Localizable description this score score if score 20 this iconClassName HEALTH 0 TO 20 else if score 40 this iconClassName HEALTH 21 TO 40 else if score 60 this iconClassName HEALTH 41 TO 60 else if score 80 this iconClassName HEALTH 61 TO 80 else this iconClassName HEALTH OVER 80 if iconUrl null if score 20 this iconUrl HEALTH 0 TO 20 IMG else if score 40 this iconUrl HEALTH 21 TO 40 IMG else if score 60 this iconUrl HEALTH 41 TO 60 IMG else if score 80 this iconUrl HEALTH 61 TO 80 IMG else this iconUrl HEALTH OVER 80 IMG else this iconUrl iconUrl this description null setLocalizibleDescription description Deprecated public HealthReport int score String description this score null description public HealthReport int score Localizable description this score null description public HealthReport this 100 HEALTH UNKNOWN IMG Messages HealthReport EmptyString Exported public int getScore return score public void setScore int score this score score Exported public String getIconUrl return iconUrl Exported public String getIconClassName return iconClassName public String getIconUrl String size if iconUrl null return Jenkins RESOURCE PATH images size HEALTH UNKNOWN IMG if iconUrl startsWith return iconUrl replace 32x32 size return Jenkins RESOURCE PATH images size iconUrl public void setIconUrl String iconUrl this iconUrl iconUrl Exported public String getDescription return getLocalizableDescription toString public void setDescription String description setLocalizibleDescription new NonLocalizable description public Localizable getLocalizableDescription return localizibleDescription public void setLocalizibleDescription Localizable localizibleDescription this localizibleDescription localizibleDescription public List HealthReport getAggregatedReports return Collections emptyList public boolean isAggregateReport return false Override public int compareTo HealthReport o return this score o score 1 this score o score 0 1 public static HealthReport min HealthReport a HealthReport b if a null b null return null if a null return b if b null return a if a compareTo b 0 return a return b public static HealthReport max HealthReport a HealthReport b if a null b null return null if a null return b if b null return a if a compareTo b 0 return a return b public static class ConverterImpl extends XStream2 PassthruConverter HealthReport public ConverterImpl XStream2 xstream super xstream Override protected void callback HealthReport hr UnmarshallingContext context If we are being read back in from an older version if hr localizibleDescription null hr localizibleDescription new NonLocalizable hr description null hr description OldDataMonitor report context 1 256 if hr iconClassName null hr iconUrl null iconIMGToClassMap containsKey hr iconUrl hr iconClassName iconIMGToClassMap get hr iconUrlpackage hudson model public interface HealthReportingAction extends Action HealthReport getBuildHealthpackage hudson util import com thoughtworks xstream converters basic AbstractSingleValueConverter import com thoughtworks xstream converters basic StringConverter public class HeapSpaceStringConverter extends AbstractSingleValueConverter public boolean canConvert Class type return type equals String class public Object fromString String str return strpackage hudson cli import hudson AbortException import hudson Extension import jenkins model Jenkins import java util Map import java util TreeMap import org acegisecurity AccessDeniedException import org kohsuke args4j Argument Extension public class HelpCommand extends CLICommand Argument metaVar COMMAND usage Name of the command public String command Override public String getShortDescription return Messages HelpCommand ShortDescription Override protected int run throws Exception if Jenkins getActiveInstance hasPermission Jenkins READ throw new AccessDeniedException You must authenticate to access this Jenkins n Use username password password file parameters or login command if command null return showCommandDetails showAllCommands return 0 private int showAllCommands Map String CLICommand commands new TreeMap String CLICommand for CLICommand c CLICommand all commands put c getName c for CLICommand c commands values stderr println c getName stderr println c getShortDescription return 0 private int showCommandDetails throws Exception CLICommand command CLICommand clone this command if command null showAllCommands throw new AbortException String format No such command s Available commands are above this command command printUsage stderr command getCmdLineParser return 0package hudson util import com thoughtworks xstream converters Converter import com thoughtworks xstream converters MarshallingContext import com thoughtworks xstream converters UnmarshallingContext import com thoughtworks xstream io HierarchicalStreamReader import com thoughtworks xstream io HierarchicalStreamWriter import hudson Util public class HexBinaryConverter implements Converter public boolean canConvert Class type return type byte class public void marshal Object source HierarchicalStreamWriter writer MarshallingContext context byte data byte source writer setValue Util toHexString data public Object unmarshal HierarchicalStreamReader reader UnmarshallingContext context String data reader getValue needs to be called before hasMoreChildren return Util fromHexString datapackage jenkins security import hudson Util import java io IOException public class HexStringConfidentialKey extends ConfidentialKey private final int length private volatile String secret public HexStringConfidentialKey String id int length super id if length 2 0 throw new IllegalArgumentException length must be even length this length length public HexStringConfidentialKey Class owner String shortName int length this owner getName shortName length public String get try if secret null synchronized this if secret null byte payload load if payload null payload ConfidentialStore get randomBytes length 2 store payload secret Util toHexString payload substring 0 length return secret catch IOException e throw new Error Failed to load the key getId epackage com twitter sdk android tweetui internal import android view View public interface HighlightedClickableSpan void onClick View view void select boolean selected boolean isSelectedpackage jenkins widgets import hudson model Queue import hudson model Run import javax annotation Nonnull public class HistoryPageEntry T private final T entry public HistoryPageEntry T entry this entry entry public T getEntry return entry public long getEntryId return getEntryId entry protected static long getEntryId Nonnull Object entry if entry instanceof Queue Item return Queue Item entry getId else if entry instanceof Run Run run Run entry return Long MIN VALUE run getNumber else if entry instanceof Number Used for testing purposes because of JENKINS 30899 and JENKINS 30909 return Long MIN VALUE Number entry longValue else return Run QUEUE ID UNKNOWNpackage jenkins widgets import com google common collect Iterables import com google common collect Iterators import hudson model Job import hudson model Queue import hudson model Run import hudson widgets HistoryWidget import javax annotation Nonnull import java util ArrayList import java util Collections import java util Comparator import java util Iterator import java util LinkedList import java util List public class HistoryPageFilter T private final int maxEntries private Long newerThan private Long olderThan private String searchString Need to use different Lists for Queue Items and Runs because we need access to them separately in the jelly files for rendering public final List HistoryPageEntry Queue Item queueItems new ArrayList HistoryPageEntry Queue Item public final List HistoryPageEntry Run runs new ArrayList HistoryPageEntry Run public boolean hasUpPage false there are newer builds than on this page public boolean hasDownPage false there are older builds than on this page public long nextBuildNumber public HistoryWidget widget public long newestOnPage Long MIN VALUE see updateNewestOldest public long oldestOnPage Long MAX VALUE see updateNewestOldest public HistoryPageFilter int maxEntries this maxEntries maxEntries public void setNewerThan Long newerThan if olderThan null throw new UnsupportedOperationException Cannot set newerThan olderThan already set this newerThan newerThan public void setOlderThan Long olderThan if newerThan null throw new UnsupportedOperationException Cannot set olderThan newerThan already set this olderThan olderThan public void setSearchString Nonnull String searchString this searchString searchString Deprecated public void add Nonnull List T runItems addInternal runItems public void add Nonnull Iterable T runItems addInternal runItems public void add Nonnull Iterable T runItems Nonnull List Queue Item queueItems sort queueItems addInternal Iterables concat queueItems runItems private ItemT void addInternal Nonnull Iterable ItemT items Note that items can be a large lazily evaluated collection so this method is optimized to only iterate through it as much as needed if items iterator hasNext return nextBuildNumber getNextBuildNumber items iterator next if newerThan null olderThan null Just return the first page of entries newest Iterator ItemT iter items iterator while iter hasNext add iter next if isFull break hasDownPage iter hasNext else if newerThan null int toFillCount getFillCount if toFillCount 0 Walk through the items and keep track of the oldest toFillCount items until we reach an item older than newerThan or the end of the list LinkedList ItemT itemsToAdd new LinkedList Iterator ItemT iter items iterator while iter hasNext ItemT item iter next if HistoryPageEntry getEntryId item newerThan itemsToAdd addLast item Discard an item off the front of the list if we have to which means we would be able to page up if itemsToAdd size toFillCount itemsToAdd removeFirst hasUpPage true else break if itemsToAdd size 0 All builds are older than newerThan hasDownPage true else If there s less than a full page of items newer than newerThan then it s ok to fill the page with older items if itemsToAdd size toFillCount We have to restart the iterator and skip the items that we added because we may have popped an extra item off the iterator that did not get added Iterator ItemT skippedIter items iterator Iterators skip skippedIter itemsToAdd size for int i itemsToAdd size i toFillCount skippedIter hasNext i ItemT item skippedIter next itemsToAdd addLast item hasDownPage iter hasNext for Object item itemsToAdd add item else if olderThan null Iterator ItemT iter items iterator while iter hasNext Object item iter next if HistoryPageEntry getEntryId item olderThan hasUpPage true else add item if isFull hasDownPage iter hasNext break public int size return queueItems size runs size private void sort List extends Object items Queue items can start building out of order with how they got added to the queue Sorting them before adding to the page They ll still get displayed before the building items coz they end up in a different list in HistoryPageFilter Collections sort items new Comparator Object Override public int compare Object o1 Object o2 long o1QID HistoryPageEntry getEntryId o1 long o2QID HistoryPageEntry getEntryId o2 if o1QID o2QID return 1 else if o1QID o2QID return 0 else return 1 private long getNextBuildNumber Nonnull Object entry if entry instanceof Queue Item Queue Task task Queue Item entry task if task instanceof Job return Job task getNextBuildNumber else if entry instanceof Run return Run entry getParent getNextBuildNumber TODO maybe this should be an error return HistoryPageEntry getEntryId entry 1 private void addQueueItem Queue Item item HistoryPageEntry Queue Item entry new HistoryPageEntry item queueItems add entry updateNewestOldest entry getEntryId private void addRun Run run HistoryPageEntry Run entry new HistoryPageEntry run Assert that runs have been added in descending order if runs size 0 if entry getEntryId runs get runs size 1 getEntryId throw new IllegalStateException Runs were out of order runs add entry updateNewestOldest entry getEntryId private void updateNewestOldest long entryId newestOnPage Math max newestOnPage entryId oldestOnPage Math min oldestOnPage entryId private boolean add Object entry Purposely not calling isFull May need to add a greater number of entries to the page initially newerThan then cutting it back down to size using cutLeading if entry instanceof Queue Item Queue Item item Queue Item entry if searchString null fitsSearchParams item return false addQueueItem item return true else if entry instanceof Run Run run Run entry if searchString null fitsSearchParams run return false addRun run return true return false private boolean isFull return size maxEntries private int getFillCount return Math max 0 maxEntries size private boolean fitsSearchParams Nonnull Queue Item item if fitsSearchString item getDisplayName return true else if fitsSearchString item getId return true Non of the fuzzy matches liked the search term return false private boolean fitsSearchParams Nonnull Run run if searchString null return true if fitsSearchString run getDisplayName return true else if fitsSearchString run getDescription return true else if fitsSearchString run getNumber return true else if fitsSearchString run getQueueId return true else if fitsSearchString run getResult return true Non of the fuzzy matches liked the search term return false private boolean fitsSearchString Object data if searchString null return true if data null if data instanceof Number return data toString equals searchString else return data toString toLowerCase contains searchString return falsepackage hudson widgets import hudson Functions import jenkins util SystemProperties import hudson model ModelObject import hudson model Run import jenkins widgets HistoryPageEntry import jenkins widgets HistoryPageFilter import org kohsuke stapler Header import org kohsuke stapler Stapler import org kohsuke stapler StaplerRequest import org kohsuke stapler StaplerResponse import javax annotation CheckForNull import javax servlet ServletException import java io IOException import java util ArrayList import java util Collections import java util Iterator import java util List public class HistoryWidget O extends ModelObject T extends Widget public Iterable T baseList private String nextBuildNumberToFetch public final String baseUrl public final O owner private boolean trimmed public final Adapter super T adapter final Long newerThan final Long olderThan final String searchString private String firstTransientBuildKey public HistoryWidget O owner Iterable T baseList Adapter super T adapter StaplerRequest currentRequest Stapler getCurrentRequest this adapter adapter this baseList baseList this baseUrl Functions getNearestAncestorUrl currentRequest owner this owner owner this newerThan getPagingParam currentRequest newer than this olderThan getPagingParam currentRequest older than this searchString currentRequest getParameter search public String getDisplayName return Messages BuildHistoryWidget DisplayName Override public String getUrlName return buildHistory public String getFirstTransientBuildKey return firstTransientBuildKey SuppressWarnings unchecked protected HistoryPageFilter updateFirstTransientBuildKey HistoryPageFilter historyPageFilter updateFirstTransientBuildKey historyPageFilter runs return historyPageFilter private Iterable HistoryPageEntry T updateFirstTransientBuildKey Iterable HistoryPageEntry T source String key null for HistoryPageEntry T t source if adapter isBuilding t getEntry key adapter getKey t getEntry firstTransientBuildKey key return source public Iterable HistoryPageEntry T getRenderList if trimmed List HistoryPageEntry T pageEntries toPageEntries baseList if pageEntries size THRESHOLD return updateFirstTransientBuildKey pageEntries subList 0 THRESHOLD else trimmed false return updateFirstTransientBuildKey pageEntries else to prevent baseList s concrete type from getting picked up by j forEach in view return updateFirstTransientBuildKey toPageEntries baseList private List HistoryPageEntry T toPageEntries Iterable T historyItemList Iterator T iterator historyItemList iterator if iterator hasNext return Collections emptyList List HistoryPageEntry T pageEntries new ArrayList HistoryPageEntry T while iterator hasNext pageEntries add new HistoryPageEntry T iterator next return pageEntries public HistoryPageFilter getHistoryPageFilter HistoryPageFilter T historyPageFilter newPageFilter historyPageFilter add baseList historyPageFilter widget this return updateFirstTransientBuildKey historyPageFilter protected HistoryPageFilter T newPageFilter HistoryPageFilter T historyPageFilter new HistoryPageFilter T THRESHOLD if newerThan null historyPageFilter setNewerThan newerThan else if olderThan null historyPageFilter setOlderThan olderThan if searchString null historyPageFilter setSearchString searchString return historyPageFilter public boolean isTrimmed return trimmed public void setTrimmed boolean trimmed this trimmed trimmed public void doAjax StaplerRequest req StaplerResponse rsp Header n String n throws IOException ServletException rsp setContentType text html charset UTF 8 pick up builds to send back List T items new ArrayList T if n null String nn null we ll compute next n here list up all builds n for T t baseList if adapter compare t n 0 items add t if adapter isBuilding t nn adapter getKey t the next fetch should start from youngest build in progress else break if nn null if items isEmpty nothing to report back next fetch should retry the same n nn n else every record fetched this time is frozen next fetch should start from the next build nn adapter getNextKey adapter getKey items get 0 baseList items rsp setHeader n nn firstTransientBuildKey nn all builds nn should be marked transient HistoryPageFilter page getHistoryPageFilter req getView page ajaxBuildHistory jelly forward req rsp static final int THRESHOLD SystemProperties getInteger HistoryWidget class getName threshold 30 public String getNextBuildNumberToFetch return nextBuildNumberToFetch public void setNextBuildNumberToFetch String nextBuildNumberToFetch this nextBuildNumberToFetch nextBuildNumberToFetch public interface Adapter T int compare T record String key String getKey T record boolean isBuilding T record String getNextKey String key private Long getPagingParam CheckForNull StaplerRequest currentRequest CheckForNull String name if currentRequest null name null return null String paramVal currentRequest getParameter name if paramVal null return null try return new Long paramVal catch NumberFormatException nfe return nullpackage jenkins security import hudson Util import javax crypto KeyGenerator import javax crypto Mac import javax crypto SecretKey import javax crypto spec SecretKeySpec import java io IOException import java io UnsupportedEncodingException import java security GeneralSecurityException import java security NoSuchAlgorithmException import java util Arrays public class HMACConfidentialKey extends ConfidentialKey private volatile SecretKey key private final int length public HMACConfidentialKey String id int length super id this length length public HMACConfidentialKey String id this id Integer MAX VALUE public HMACConfidentialKey Class owner String shortName int length this owner getName shortName length public HMACConfidentialKey Class owner String shortName this owner shortName Integer MAX VALUE public byte mac byte message return chop createMac doFinal message public boolean checkMac byte message byte mac return Arrays equals mac message mac public String mac String message try return Util toHexString mac message getBytes UTF 8 catch UnsupportedEncodingException e throw new AssertionError e public boolean checkMac String message String mac return mac message equals mac private byte chop byte mac if mac length length return mac already too short byte b new byte length System arraycopy mac 0 b 0 b length return b public Mac createMac try Mac mac Mac getInstance ALGORITHM mac init getKey return mac catch GeneralSecurityException e Javadoc says HmacSHA256 must be supported by every Java implementation throw new Error ALGORITHM not supported e private SecretKey getKey if key null synchronized this if key null try byte encoded load if encoded null KeyGenerator kg KeyGenerator getInstance ALGORITHM SecretKey key kg generateKey store encoded key getEncoded key new SecretKeySpec encoded ALGORITHM catch IOException e throw new Error Failed to load the key getId e catch NoSuchAlgorithmException e throw new Error Failed to load the key getId e return key private static final String ALGORITHM HmacSHA256package com kaku colorfulnews common import android support annotation IntDef import java lang annotation Retention import java lang annotation RetentionPolicy public class HostType public static final int TYPE COUNT 3 public static final int NETEASE NEWS VIDEO 1 public static final int GANK GIRL PHOTO 2 public static final int NEWS DETAIL HTML PHOTO 3 IntDef NETEASE NEWS VIDEO GANK GIRL PHOTO NEWS DETAIL HTML PHOTO Retention RetentionPolicy SOURCE public interface HostTypeCheckerpackage jenkins diagnosis import hudson Util import hudson util HttpResponses import jenkins model Jenkins import org kohsuke stapler HttpResponse import java io File import java io IOException import java util Date public class HsErrPidFile private final HsErrPidList owner private final File file public HsErrPidFile HsErrPidList owner File file this owner owner this file file public String getName return file getName public String getPath return file getPath public long getLastModified return file lastModified public Date getLastModifiedDate return new Date file lastModified public String getTimeSpanString return Util getTimeSpanString System currentTimeMillis getLastModified public HttpResponse doDownload throws IOException Jenkins getInstance checkPermission Jenkins ADMINISTER return HttpResponses staticResource file public HttpResponse doDelete throws IOException Jenkins getInstance checkPermission Jenkins ADMINISTER file delete owner files remove this return HttpResponses redirectTopackage jenkins diagnosis import com sun akuma JavaVMArguments import hudson Extension import hudson Functions import hudson Util import hudson model AdministrativeMonitor import hudson util jna Kernel32Utils import jenkins model Jenkins import org apache tools ant DirectoryScanner import org apache tools ant Project import org apache tools ant types FileSet import java io BufferedReader import java io File import java io FileInputStream import java io FileReader import java io IOException import java nio MappedByteBuffer import java nio channels FileChannel import java nio channels FileChannel MapMode import java util ArrayList import java util List import java util logging Level import java util logging Logger import org apache commons io IOUtils import org jenkinsci Symbol Extension optional true Symbol hsErrPid TODO why would an extension using a built in extension point need to be marked optional public class HsErrPidList extends AdministrativeMonitor final List HsErrPidFile files new ArrayList HsErrPidFile private MappedByteBuffer map public HsErrPidList if Functions getIsUnitTest return try try FileChannel ch new FileInputStream getSecretKeyFile getChannel map ch map MapMode READ ONLY 0 1 scan hs err pid p log if Functions isWindows File dir Kernel32Utils getTempDir if dir null scan dir getPath hs err pid p log else scan tmp hs err pid p log on different platforms rules about the default locations are a lot more subtle check our arguments in the very end since this might fail on some platforms JavaVMArguments args JavaVMArguments current for String a args see http www oracle com technetwork java javase felog 138657 html if a startsWith ERROR FILE OPTION scan a substring ERROR FILE OPTION length catch UnsupportedOperationException e ignore catch Throwable e LOGGER log Level WARNING Failed to list up hs err pid files e Override public String getDisplayName return JVM Crash Reports public List HsErrPidFile getFiles return files private void scan String pattern LOGGER fine Scanning pattern for hs err pid files pattern pattern replace p replace File f new File pattern getAbsoluteFile if pattern contains scanFile f else GLOB File commonParent f while commonParent null commonParent getPath contains commonParent commonParent getParentFile if commonParent null LOGGER warning Failed to process f return huh FileSet fs Util createFileSet commonParent f getPath substring commonParent getPath length 1 null DirectoryScanner ds fs getDirectoryScanner new Project for String child ds getIncludedFiles scanFile new File commonParent child private void scanFile File log LOGGER fine Scanning log BufferedReader r null try r new BufferedReader new FileReader log if findHeader r return we should find a memory mapped file for secret key String secretKey getSecretKeyFile getAbsolutePath String line while line r readLine null if line contains secretKey files add new HsErrPidFile this log return catch IOException e not a big enough deal LOGGER log Level FINE Failed to parse hs err pid file log e finally IOUtils closeQuietly r private File getSecretKeyFile return new File Jenkins getInstance getRootDir secret key private boolean findHeader BufferedReader r throws IOException for int i 0 i 5 i String line r readLine if line null return false if line startsWith A fatal error has been detected by the Java Runtime Environment return true return false Override public boolean isActivated return files isEmpty private static final String ERROR FILE OPTION XX ErrorFile private static final Logger LOGGER Logger getLogger HsErrPidList class getNamepackage com twitter sdk android tweetui internal util import java util ArrayList import java util HashMap import java util Map import java util TreeMap public class HtmlEntities public static final Entities XML public static final Entities HTML32 public static final HtmlEntities HTML40 package scoped for testing static final String ISO8859 1 ARRAY nbsp 160 non breaking space iexcl 161 inverted exclamation mark cent 162 cent sign pound 163 pound sign curren 164 currency sign yen 165 yen sign yuan sign brvbar 166 broken bar broken vertical bar sect 167 section sign uml 168 diaeresis spacing diaeresis copy 169 copyright sign ordf 170 feminine ordinal indicator laquo 171 left pointing double angle quotation mark left pointing guillemet not 172 not sign shy 173 soft hyphen discretionary hyphen reg 174 registered trademark sign macr 175 macron spacing macron overline APL overbar deg 176 degree sign plusmn 177 plus minus sign plus or minus sign sup2 178 superscript two superscript digit two squared sup3 179 superscript three superscript digit three cubed acute 180 acute accent spacing acute micro 181 micro sign para 182 pilcrow sign paragraph sign middot 183 middle dot Georgian comma Greek middle dot cedil 184 cedilla spacing cedilla sup1 185 superscript one superscript digit one ordm 186 masculine ordinal indicator raquo 187 right pointing double angle quotation mark right pointing guillemet frac14 188 vulgar fraction one quarter fraction one quarter frac12 189 vulgar fraction one half fraction one half frac34 190 vulgar fraction three quarters fraction three quarters iquest 191 inverted question mark turned question mark Agrave 192 uppercase A grave accent Aacute 193 uppercase A acute accent Acirc 194 uppercase A circumflex accent Atilde 195 uppercase A tilde Auml 196 uppercase A umlaut Aring 197 uppercase A ring AElig 198 uppercase AE Ccedil 199 uppercase C cedilla Egrave 200 uppercase E grave accent Eacute 201 uppercase E acute accent Ecirc 202 uppercase E circumflex accent Euml 203 uppercase E umlaut Igrave 204 uppercase I grave accent Iacute 205 uppercase I acute accent Icirc 206 uppercase I circumflex accent Iuml 207 uppercase I umlaut ETH 208 uppercase Eth Icelandic Ntilde 209 uppercase N tilde Ograve 210 uppercase O grave accent Oacute 211 uppercase O acute accent Ocirc 212 uppercase O circumflex accent Otilde 213 uppercase O tilde Ouml 214 uppercase O umlaut times 215 multiplication sign Oslash 216 uppercase O slash Ugrave 217 uppercase U grave accent Uacute 218 uppercase U acute accent Ucirc 219 uppercase U circumflex accent Uuml 220 uppercase U umlaut Yacute 221 uppercase Y acute accent THORN 222 uppercase THORN Icelandic szlig 223 lowercase sharps German agrave 224 lowercase a grave accent aacute 225 lowercase a acute accent acirc 226 lowercase a circumflex accent atilde 227 lowercase a tilde auml 228 lowercase a umlaut aring 229 lowercase a ring aelig 230 lowercase ae ccedil 231 lowercase c cedilla egrave 232 lowercase e grave accent eacute 233 lowercase e acute accent ecirc 234 lowercase e circumflex accent euml 235 lowercase e umlaut igrave 236 lowercase i grave accent iacute 237 lowercase i acute accent icirc 238 lowercase i circumflex accent iuml 239 lowercase i umlaut eth 240 lowercase eth Icelandic ntilde 241 lowercase n tilde ograve 242 lowercase o grave accent oacute 243 lowercase o acute accent ocirc 244 lowercase o circumflex accent otilde 245 lowercase o tilde ouml 246 lowercase o umlaut divide 247 division sign oslash 248 lowercase o slash ugrave 249 lowercase u grave accent uacute 250 lowercase u acute accent ucirc 251 lowercase u circumflex accent uuml 252 lowercase u umlaut yacute 253 lowercase y acute accent thorn 254 lowercase thorn Icelandic yuml 255 lowercase y umlaut http www w3 org TR REC html40 sgml entities html package scoped for testing static final String HTML40 ARRAY Latin Extended B fnof 402 latin small f with hook function florin U 0192 ISOtech Greek Alpha 913 greek capital letter alpha U 0391 Beta 914 greek capital letter beta U 0392 Gamma 915 greek capital letter gamma U 0393 ISOgrk3 Delta 916 greek capital letter delta U 0394 ISOgrk3 Epsilon 917 greek capital letter epsilon U 0395 Zeta 918 greek capital letter zeta U 0396 Eta 919 greek capital letter eta U 0397 Theta 920 greek capital letter theta U 0398 ISOgrk3 Iota 921 greek capital letter iota U 0399 Kappa 922 greek capital letter kappa U 039A Lambda 923 greek capital letter lambda U 039B ISOgrk3 Mu 924 greek capital letter mu U 039C Nu 925 greek capital letter nu U 039D Xi 926 greek capital letter xi U 039E ISOgrk3 Omicron 927 greek capital letter omicron U 039F Pi 928 greek capital letter pi U 03A0 ISOgrk3 Rho 929 greek capital letter rho U 03A1 there is no Sigmaf and no U 03A2 character either Sigma 931 greek capital letter sigma U 03A3 ISOgrk3 Tau 932 greek capital letter tau U 03A4 Upsilon 933 greek capital letter upsilon U 03A5 ISOgrk3 Phi 934 greek capital letter phi U 03A6 ISOgrk3 Chi 935 greek capital letter chi U 03A7 Psi 936 greek capital letter psi U 03A8 ISOgrk3 Omega 937 greek capital letter omega U 03A9 ISOgrk3 alpha 945 greek small letter alpha U 03B1 ISOgrk3 beta 946 greek small letter beta U 03B2 ISOgrk3 gamma 947 greek small letter gamma U 03B3 ISOgrk3 delta 948 greek small letter delta U 03B4 ISOgrk3 epsilon 949 greek small letter epsilon U 03B5 ISOgrk3 zeta 950 greek small letter zeta U 03B6 ISOgrk3 eta 951 greek small letter eta U 03B7 ISOgrk3 theta 952 greek small letter theta U 03B8 ISOgrk3 iota 953 greek small letter iota U 03B9 ISOgrk3 kappa 954 greek small letter kappa U 03BA ISOgrk3 lambda 955 greek small letter lambda U 03BB ISOgrk3 mu 956 greek small letter mu U 03BC ISOgrk3 nu 957 greek small letter nu U 03BD ISOgrk3 xi 958 greek small letter xi U 03BE ISOgrk3 omicron 959 greek small letter omicron U 03BF NEW pi 960 greek small letter pi U 03C0 ISOgrk3 rho 961 greek small letter rho U 03C1 ISOgrk3 sigmaf 962 greek small letter final sigma U 03C2 ISOgrk3 sigma 963 greek small letter sigma U 03C3 ISOgrk3 tau 964 greek small letter tau U 03C4 ISOgrk3 upsilon 965 greek small letter upsilon U 03C5 ISOgrk3 phi 966 greek small letter phi U 03C6 ISOgrk3 chi 967 greek small letter chi U 03C7 ISOgrk3 psi 968 greek small letter psi U 03C8 ISOgrk3 omega 969 greek small letter omega U 03C9 ISOgrk3 thetasym 977 greek small letter theta symbol U 03D1 NEW upsih 978 greek upsilon with hook symbol U 03D2 NEW piv 982 greek pi symbol U 03D6 ISOgrk3 General Punctuation bull 8226 bullet black small circle U 2022 ISOpub bullet is NOT the same as bullet operator U 2219 hellip 8230 horizontal ellipsis three dot leader U 2026 ISOpub prime 8242 prime minutes feet U 2032 ISOtech Prime 8243 double prime seconds inches U 2033 ISOtech oline 8254 overline spacing overscore U 203E NEW frasl 8260 fraction slash U 2044 NEW Letterlike Symbols weierp 8472 script capital P power set Weierstrass p U 2118 ISOamso image 8465 blackletter capital I imaginary part U 2111 ISOamso real 8476 blackletter capital R real part symbol U 211C ISOamso trade 8482 trade mark sign U 2122 ISOnum alefsym 8501 alef symbol first transfinite cardinal U 2135 NEW alef symbol is NOT the same as hebrew letter alef U 05D0 although the same glyph could be used to depict both characters Arrows larr 8592 leftwards arrow U 2190 ISOnum uarr 8593 upwards arrow U 2191 ISOnum rarr 8594 rightwards arrow U 2192 ISOnum darr 8595 downwards arrow U 2193 ISOnum harr 8596 left right arrow U 2194 ISOamsa crarr 8629 downwards arrow with corner leftwards carriage return U 21B5 NEW lArr 8656 leftwards double arrow U 21D0 ISOtech ISO 10646 does not say that lArr is the same as the is implied by arrowbut also does not have any other character for that function So lArr canbe used for is implied by as ISOtech suggests uArr 8657 upwards double arrow U 21D1 ISOamsa rArr 8658 rightwards double arrow U 21D2 ISOtech ISO 10646 does not say this is the implies character but does not have another character with this function so rArr can be used for implies as ISOtech suggests dArr 8659 downwards double arrow U 21D3 ISOamsa hArr 8660 left right double arrow U 21D4 ISOamsa Mathematical Operators forall 8704 for all U 2200 ISOtech part 8706 partial differential U 2202 ISOtech exist 8707 there exists U 2203 ISOtech empty 8709 empty set null set diameter U 2205 ISOamso nabla 8711 nabla backward difference U 2207 ISOtech isin 8712 element of U 2208 ISOtech notin 8713 not an element of U 2209 ISOtech ni 8715 contains as member U 220B ISOtech should there be a more memorable name than ni prod 8719 n ary product product sign U 220F ISOamsb prod is NOT the same character as U 03A0 greek capital letter pi though the same glyph might be used for both sum 8721 n ary summation U 2211 ISOamsb sum is NOT the same character as U 03A3 greek capital letter sigma though the same glyph might be used for both minus 8722 minus sign U 2212 ISOtech lowast 8727 asterisk operator U 2217 ISOtech radic 8730 square root radical sign U 221A ISOtech prop 8733 proportional to U 221D ISOtech infin 8734 infinity U 221E ISOtech ang 8736 angle U 2220 ISOamso and 8743 logical and wedge U 2227 ISOtech or 8744 logical or vee U 2228 ISOtech cap 8745 intersection cap U 2229 ISOtech cup 8746 union cup U 222A ISOtech int 8747 integral U 222B ISOtech there4 8756 therefore U 2234 ISOtech sim 8764 tilde operator varies with similar to U 223C ISOtech tilde operator is NOT the same character as the tilde U 007E although the same glyph might be used to represent both cong 8773 approximately equal to U 2245 ISOtech asymp 8776 almost equal to asymptotic to U 2248 ISOamsr ne 8800 not equal to U 2260 ISOtech equiv 8801 identical to U 2261 ISOtech le 8804 less than or equal to U 2264 ISOtech ge 8805 greater than or equal to U 2265 ISOtech sub 8834 subset of U 2282 ISOtech sup 8835 superset of U 2283 ISOtech note that nsup not a superset of U 2283 is not covered by the Symbol font encoding and is not included Should it be for symmetry It is in ISOamsn ENTITY nsub 8836 not a subset of U 2284 ISOamsn sube 8838 subset of or equal to U 2286 ISOtech supe 8839 superset of or equal to U 2287 ISOtech oplus 8853 circled plus direct sum U 2295 ISOamsb otimes 8855 circled times vector product U 2297 ISOamsb perp 8869 up tack orthogonal to perpendicular U 22A5 ISOtech sdot 8901 dot operator U 22C5 ISOamsb dot operator is NOT the same character as U 00B7 middle dot Miscellaneous Technical lceil 8968 left ceiling apl upstile U 2308 ISOamsc rceil 8969 right ceiling U 2309 ISOamsc lfloor 8970 left floor apl downstile U 230A ISOamsc rfloor 8971 right floor U 230B ISOamsc lang 9001 left pointing angle bracket bra U 2329 ISOtech lang is NOT the same character as U 003C less than or U 2039 single left pointing angle quotation mark rang 9002 right pointing angle bracket ket U 232A ISOtech rang is NOT the same character as U 003E greater than or U 203A single right pointing angle quotation mark Geometric Shapes loz 9674 lozenge U 25CA ISOpub Miscellaneous Symbols spades 9824 black spade suit U 2660 ISOpub black here seems to mean filled as opposed to hollow clubs 9827 black club suit shamrock U 2663 ISOpub hearts 9829 black heart suit valentine U 2665 ISOpub diams 9830 black diamond suit U 2666 ISOpub Latin Extended A OElig 338 latin capital ligature OE U 0152 ISOlat2 oelig 339 latin small ligature oe U 0153 ISOlat2 ligature is a misnomer this is a separate character in some languages Scaron 352 latin capital letter S with caron U 0160 ISOlat2 scaron 353 latin small letter s with caron U 0161 ISOlat2 Yuml 376 latin capital letter Y with diaeresis U 0178 ISOlat2 Spacing Modifier Letters circ 710 modifier letter circumflex accent U 02C6 ISOpub tilde 732 small tilde U 02DC ISOdia General Punctuation ensp 8194 en space U 2002 ISOpub emsp 8195 em space U 2003 ISOpub thinsp 8201 thin space U 2009 ISOpub zwnj 8204 zero width non joiner U 200C NEW RFC 2070 zwj 8205 zero width joiner U 200D NEW RFC 2070 lrm 8206 left to right mark U 200E NEW RFC 2070 rlm 8207 right to left mark U 200F NEW RFC 2070 ndash 8211 en dash U 2013 ISOpub mdash 8212 em dash U 2014 ISOpub lsquo 8216 left single quotation mark U 2018 ISOnum rsquo 8217 right single quotation mark U 2019 ISOnum sbquo 8218 single low 9 quotation mark U 201A NEW ldquo 8220 left double quotation mark U 201C ISOnum rdquo 8221 right double quotation mark U 201D ISOnum bdquo 8222 double low 9 quotation mark U 201E NEW dagger 8224 dagger U 2020 ISOpub Dagger 8225 double dagger U 2021 ISOpub permil 8240 per mille sign U 2030 ISOtech lsaquo 8249 single left pointing angle quotation mark U 2039 ISO proposed lsaquo is proposed but not yet ISO standardized rsaquo 8250 single right pointing angle quotation mark U 203A ISO proposed rsaquo is proposed but not yet ISO standardized euro 8364 euro sign U 20AC NEW private static final String BASIC ARRAY quot 34 double quote amp 38 ampersand lt 60 less than gt 62 greater than package scoped for testing final EntityMap map new HtmlEntities LookupEntityMap static HTML40 new HtmlEntities fillWithHtml40Entities HTML40 static void fillWithHtml40Entities HtmlEntities entities entities addEntities BASIC ARRAY entities addEntities ISO8859 1 ARRAY entities addEntities HTML40 ARRAY interface EntityMap void add String name int value String name int value int value String name static class PrimitiveEntityMap implements EntityMap SuppressWarnings unchecked private final Map mapNameToValue new HashMap private final IntHashMap mapValueToName new IntHashMap SuppressWarnings unchecked public void add String name int value mapNameToValue put name value mapValueToName put value name public String name int value return String mapValueToName get value public int value String name final Object value mapNameToValue get name if value null return 1 return Integer value intValue abstract static class MapIntMap implements EntityMap SuppressWarnings unchecked protected Map mapNameToValue SuppressWarnings unchecked protected Map mapValueToName SuppressWarnings unchecked public void add String name int value mapNameToValue put name value mapValueToName put value name public String name int value return String mapValueToName get value public int value String name final Object value mapNameToValue get name if value null return 1 return Integer value intValue static class HashEntityMap extends MapIntMap SuppressWarnings unchecked public HashEntityMap mapNameToValue new HashMap mapValueToName new HashMap static class TreeEntityMap extends MapIntMap SuppressWarnings unchecked public TreeEntityMap mapNameToValue new TreeMap mapValueToName new TreeMap static class LookupEntityMap extends PrimitiveEntityMap private static final int LOOKUP TABLE SIZE 256 private String lookupTable Override public String name int value if value LOOKUP TABLE SIZE return lookupTable value return super name value private String lookupTable if lookupTable null createLookupTable return lookupTable private void createLookupTable lookupTable new String LOOKUP TABLE SIZE for int i 0 i LOOKUP TABLE SIZE i lookupTable i super name i static class ArrayEntityMap implements EntityMap protected int growBy 100 protected int size 0 protected String names protected int values public ArrayEntityMap names new String growBy values new int growBy public ArrayEntityMap int growBy this growBy growBy names new String growBy values new int growBy public void add String name int value ensureCapacity size 1 names size name values size value size protected void ensureCapacity int capacity if capacity names length final int newSize Math max capacity size growBy final String newNames new String newSize System arraycopy names 0 newNames 0 size names newNames final int newValues new int newSize System arraycopy values 0 newValues 0 size values newValues public String name int value for int i 0 i size i if values i value return names i return null public int value String name for int i 0 i size i if names i equals name return values i return 1 static class BinaryEntityMap extends ArrayEntityMap public BinaryEntityMap public BinaryEntityMap int growBy super growBy based on code in java util Arrays private int binarySearch int key int low 0 int high size 1 while low high final int mid low high 1 final int midVal values mid if midVal key low mid 1 else if midVal key high mid 1 else return mid key found return low 1 key not found Override public void add String name int value ensureCapacity size 1 int insertAt binarySearch value if insertAt 0 return note this means you can t insert the same value twice insertAt insertAt 1 binarySearch returns it negative and off by one System arraycopy values insertAt values insertAt 1 size insertAt values insertAt value System arraycopy names insertAt names insertAt 1 size insertAt names insertAt name size Override public String name int value final int index binarySearch value if index 0 return null return names index public static final class Unescaped public final String unescaped An ordered list of start end indices public final ArrayList int indices public Unescaped String unescaped ArrayList int indices this unescaped unescaped this indices indices public void addEntities String entityArray for String anEntityArray entityArray addEntity anEntityArray 0 Integer parseInt anEntityArray 1 public void addEntity String name int value map add name value public String entityName int value return map name value public int entityValue String name return map value name public Unescaped unescape String str final int length str length final StringBuilder buf new StringBuilder length final ArrayList int indices new ArrayList 5 int i for i 0 i length i final char ch str charAt i if ch final int semi str indexOf i 1 if semi 1 buf append ch continue final String entityName str substring i 1 semi final int entityNameLength entityName length int entityValue 1 if entityNameLength 0 if entityName charAt 0 entityNameLength 1 final char charAt1 entityName charAt 1 try if charAt1 x charAt1 X if entityNameLength 2 entityValue Integer valueOf entityName substring 2 16 intValue else entityValue Integer parseInt entityName substring 1 catch Exception ignore else entityValue this entityValue entityName if entityValue 1 buf append final int amp entityName indexOf if amp 1 buf append entityName buf append i semi else buf append char entityValue indices add new int i semi i semi else buf append ch return new Unescaped buf toString indicespackage hudson util import net sf json JSONArray import net sf json JSONObject import org kohsuke stapler HttpResponse import org kohsuke stapler StaplerRequest import org kohsuke stapler StaplerResponse import javax annotation CheckForNull import javax annotation Nonnull import javax servlet ServletException import java io File import java io IOException import java nio charset Charset import java util Map public class HttpResponses extends org kohsuke stapler HttpResponses public static HttpResponse staticResource File f throws IOException return staticResource f toURI toURL public static HttpResponse okJSON return new JSONObjectResponse public static HttpResponse okJSON Nonnull JSONObject data return new JSONObjectResponse data public static HttpResponse okJSON Nonnull JSONArray data return new JSONObjectResponse data public static HttpResponse okJSON Nonnull Map data return new JSONObjectResponse data public static HttpResponse errorJSON Nonnull String message return new JSONObjectResponse error message static class JSONObjectResponse implements HttpResponse private static final Charset UTF8 Charset forName UTF 8 private final JSONObject jsonObject JSONObjectResponse this jsonObject new JSONObject status ok JSONObjectResponse Nonnull JSONObject data this this jsonObject put data data JSONObjectResponse Nonnull JSONArray data this this jsonObject put data data JSONObjectResponse Nonnull Map data this this jsonObject put data JSONObject fromObject data Nonnull JSONObjectResponse error Nonnull String message status error this jsonObject put message message return this Nonnull JSONObject getJsonObject return jsonObject private Nonnull JSONObjectResponse status Nonnull String status this jsonObject put status status return this Override public void generateResponse StaplerRequest req StaplerResponse rsp Object node throws IOException ServletException byte bytes jsonObject toString getBytes UTF8 rsp setContentType application json charset UTF 8 rsp setContentLength bytes length rsp getOutputStream write bytespackage hudson security import jenkins security NonSerializableSecurityContext import org acegisecurity context HttpSessionContextIntegrationFilter import org acegisecurity context SecurityContext import org acegisecurity Authentication import javax servlet ServletException import javax servlet ServletRequest import javax servlet ServletResponse import javax servlet FilterChain import javax servlet http HttpServletRequest import javax servlet http HttpSession import java io IOException public class HttpSessionContextIntegrationFilter2 extends HttpSessionContextIntegrationFilter public HttpSessionContextIntegrationFilter2 throws ServletException setContext NonSerializableSecurityContext class public void doFilter ServletRequest req ServletResponse res FilterChain chain throws IOException ServletException HttpSession session HttpServletRequest req getSession false if session null SecurityContext o SecurityContext session getAttribute ACEGI SECURITY CONTEXT KEY if o null Authentication a o getAuthentication if a null if a getPrincipal instanceof InvalidatableUserDetails InvalidatableUserDetails ud InvalidatableUserDetails a getPrincipal if ud isInvalid don t let Acegi see invalid security context session setAttribute ACEGI SECURITY CONTEXT KEY null super doFilter req res chainpackage jenkins util import hudson ExtensionList import hudson ExtensionPoint import javax servlet http HttpSession import javax servlet http HttpSessionEvent public abstract class HttpSessionListener implements ExtensionPoint javax servlet http HttpSessionListener public static ExtensionList HttpSessionListener all return ExtensionList lookup HttpSessionListener class Override public void sessionCreated HttpSessionEvent httpSessionEvent Override public void sessionDestroyed HttpSessionEvent httpSessionEventpackage hudson model import hudson ExtensionListView import hudson Functions import hudson Platform import hudson PluginManager import hudson cli declarative CLIResolver import hudson model listeners ItemListener import hudson slaves ComputerListener import hudson util CopyOnWriteList import hudson util FormValidation import javax annotation Nonnull import jenkins model Jenkins import org jvnet hudson reactor ReactorException import org kohsuke stapler QueryParameter import org kohsuke stapler Stapler import org kohsuke stapler StaplerRequest import org kohsuke stapler StaplerResponse import javax servlet ServletContext import javax servlet ServletException import java io File import java io IOException import java text NumberFormat import java text ParseException import java util List import static hudson Util fixEmpty import javax annotation CheckForNull public class Hudson extends Jenkins Deprecated private transient final CopyOnWriteList ItemListener itemListeners ExtensionListView createCopyOnWriteList ItemListener class Deprecated private transient final CopyOnWriteList ComputerListener computerListeners ExtensionListView createCopyOnWriteList ComputerListener class Deprecated CLIResolver Nonnull public static Hudson getInstance return Hudson Jenkins getInstance public Hudson File root ServletContext context throws IOException InterruptedException ReactorException this root context null public Hudson File root ServletContext context PluginManager pluginManager throws IOException InterruptedException ReactorException super root context pluginManager Deprecated public CopyOnWriteList ItemListener getJobListeners return itemListeners Deprecated public CopyOnWriteList ComputerListener getComputerListeners return computerListeners Deprecated public Slave getSlave String name Node n getNode name if n instanceof Slave return Slave n return null Deprecated public List Slave getSlaves return List getNodes Deprecated public void setSlaves List Slave slaves throws IOException setNodes slaves Deprecated public TopLevelItem getJob String name return getItem name Deprecated public TopLevelItem getJobCaseInsensitive String name String match Functions toEmailSafeString name for TopLevelItem item getItems if Functions toEmailSafeString item getName equalsIgnoreCase match return item return null Deprecated public synchronized void doQuietDown StaplerResponse rsp throws IOException ServletException doQuietDown generateResponse null rsp this Deprecated public void doLogRss StaplerRequest req StaplerResponse rsp throws IOException ServletException String qs req getQueryString rsp sendRedirect2 log rss qs null qs Deprecated public void doFieldCheck StaplerRequest req StaplerResponse rsp throws IOException ServletException doFieldCheck fixEmpty req getParameter value fixEmpty req getParameter type fixEmpty req getParameter errorText fixEmpty req getParameter warningText generateResponse req rsp this Deprecated public FormValidation doFieldCheck QueryParameter fixEmpty true String value QueryParameter fixEmpty true String type QueryParameter fixEmpty true String errorText QueryParameter fixEmpty true String warningText if value null if errorText null return FormValidation error errorText if warningText null return FormValidation warning warningText return FormValidation error No error or warning text was set for fieldCheck if type null try if type equalsIgnoreCase number NumberFormat getInstance parse value else if type equalsIgnoreCase number positive if NumberFormat getInstance parse value floatValue 0 return FormValidation error Messages Hudson NotAPositiveNumber else if type equalsIgnoreCase number negative if NumberFormat getInstance parse value floatValue 0 return FormValidation error Messages Hudson NotANegativeNumber catch ParseException e return FormValidation error Messages Hudson NotANumber return FormValidation ok Deprecated public static boolean isWindows return File pathSeparatorChar Deprecated public static boolean isDarwin return Platform isDarwin Deprecated public static boolean adminCheck throws IOException return adminCheck Stapler getCurrentRequest Stapler getCurrentResponse Deprecated public static boolean adminCheck StaplerRequest req StaplerResponse rsp throws IOException if isAdmin req return true rsp sendError StaplerResponse SC FORBIDDEN return false Deprecated public static boolean isAdmin return Jenkins getInstance getACL hasPermission ADMINISTER Deprecated public static boolean isAdmin StaplerRequest req return isAdmin static XSTREAM alias hudson Hudson class Deprecated public static final class MasterComputer extends Jenkins MasterComputer no op Deprecated public static class CloudList extends Jenkins CloudList public CloudList Jenkins h super h public CloudList needed for XStream deserialization superpackage hudson security import hudson Functions import com google common base Strings import org acegisecurity AuthenticationException import org acegisecurity InsufficientAuthenticationException import org acegisecurity ui webapp AuthenticationProcessingFilterEntryPoint import javax servlet ServletException import javax servlet ServletRequest import javax servlet ServletResponse import javax servlet http HttpServletRequest import javax servlet http HttpServletResponse import static javax servlet http HttpServletResponse SC FORBIDDEN import java io IOException import java io OutputStreamWriter import java io PrintWriter import java net URLEncoder import java text MessageFormat public class HudsonAuthenticationEntryPoint extends AuthenticationProcessingFilterEntryPoint Override public void commence ServletRequest request ServletResponse response AuthenticationException reason throws IOException ServletException HttpServletRequest req HttpServletRequest request HttpServletResponse rsp HttpServletResponse response String requestedWith req getHeader X Requested With if XMLHttpRequest equals requestedWith container authentication normally relies on session attribute to remember where the user came from so concurrent AJAX requests often ends up sending users back to AJAX pages after successful login this is not desirable so don t redirect AJAX requests to the user this header value is sent from Prototype rsp sendError SC FORBIDDEN else give the opportunity to include the target URL String uriFrom req getRequestURI if Strings isNullOrEmpty req getQueryString uriFrom req getQueryString String loginForm req getContextPath getLoginFormUrl loginForm MessageFormat format loginForm URLEncoder encode uriFrom UTF 8 req setAttribute loginForm loginForm rsp setStatus SC FORBIDDEN rsp setContentType text html charset UTF 8 Functions advertiseHeaders rsp AccessDeniedException2 cause null report the diagnosis information if possible if reason instanceof InsufficientAuthenticationException if reason getCause instanceof AccessDeniedException2 cause AccessDeniedException2 reason getCause cause reportAsHeaders rsp PrintWriter out try out new PrintWriter new OutputStreamWriter rsp getOutputStream catch IllegalStateException e out rsp getWriter out printf html head meta http equiv refresh content 1 url 1 s script window location replace 1 s script head body style background color white color white n n n Authentication required n n loginForm if cause null cause report out out printf n n body html Turn Off Show Friendly HTTP Error Messages Feature on the Server Side See http support microsoft com kb 294807 for int i 0 i 10 i out print out closepackage hudson console import hudson Extension import hudson MarkupText import org jenkinsci Symbol import java util regex Matcher import java util regex Pattern public class HudsonExceptionNote extends ConsoleNote Object Override public ConsoleAnnotator annotate Object context MarkupText text int charPos An exception stack trace looks like this org acme FooBarException message TAB at org acme Foo method Foo java 123 Caused by java lang ClassNotFoundException String line text getText int end line indexOf charPos if end 0 if CLASSNAME matcher line substring charPos matches end line length else return null unexpected format abort text addHyperlinkLowKey charPos end annotateClassName line substring charPos end return new ConsoleAnnotator public ConsoleAnnotator annotate Object context MarkupText text String line text getText Matcher m STACK TRACE ELEMENT matcher line if m find allow the match to happen in the middle of a line to cope with prefix Ant and Maven put them among many other tools text addHyperlinkLowKey m start 4 m end annotateMethodName m group 1 m group 2 m group 3 Integer parseInt m group 4 return this int idx line indexOf CAUSED BY if idx 0 int s idx CAUSED BY length int e line indexOf s if e 0 e line length text addHyperlinkLowKey s e annotateClassName line substring s e return this if AND MORE matcher line matches return this looks like we are done with the stack trace return null TODO separate out the annotations and mark up private String annotateMethodName String className String methodName String sourceFileName int lineNumber return http stacktrace jenkins ci org search query className methodName entity method private String annotateClassName String className return http stacktrace jenkins ci org search query className Extension Symbol stackTrace public static final class DescriptorImpl extends ConsoleAnnotationDescriptor Override public String getDisplayName return Exception Stack Trace private static final String CLASSNAME PATTERN p L 0 9 private static final Pattern CLASSNAME Pattern compile CLASSNAME PATTERN r n private static final Pattern STACK TRACE ELEMENT Pattern compile tat CLASSNAME PATTERN p L 0 9 S 0 9 private static final String CAUSED BY Caused by private static final Pattern AND MORE Pattern compile t 0 9 more npackage hudson util import org kohsuke accmod Restricted import org kohsuke accmod restrictions NoExternalUse public class HudsonFailedToLoad extends BootFailure Restricted NoExternalUse class Deprecated public final Throwable exception public HudsonFailedToLoad Throwable exception super exception this exception exceptionpackage hudson security import jenkins model Jenkins import java io IOException import java util logging Logger import static java util logging Level SEVERE import javax servlet Filter import javax servlet FilterChain import javax servlet FilterConfig import javax servlet ServletContext import javax servlet ServletException import javax servlet ServletRequest import javax servlet ServletResponse import javax servlet http HttpServletResponse import org acegisecurity AuthenticationManager import org acegisecurity ui rememberme RememberMeServices import org acegisecurity userdetails UserDetailsService public class HudsonFilter implements Filter private volatile Filter filter private FilterConfig filterConfig Deprecated public static final AuthenticationManagerProxy AUTHENTICATION MANAGER new AuthenticationManagerProxy Deprecated public static final UserDetailsServiceProxy USER DETAILS SERVICE PROXY new UserDetailsServiceProxy Deprecated public static final RememberMeServicesProxy REMEMBER ME SERVICES PROXY new RememberMeServicesProxy public void init FilterConfig filterConfig throws ServletException this filterConfig filterConfig this is how we make us available to the rest of Hudson filterConfig getServletContext setAttribute HudsonFilter class getName this try Jenkins hudson Jenkins getInstanceOrNull if hudson null looks like we are initialized after Hudson came into being initialize it now See 3069 LOGGER fine Security wasn t initialized Initializing it SecurityRealm securityRealm hudson getSecurityRealm reset securityRealm LOGGER fine securityRealm is securityRealm LOGGER fine Security initialized catch ExceptionInInitializerError e see HUDSON 4592 In some containers this happens before WebAppMain contextInitialized kicks in which makes the whole thing fail hard before a nicer error check in WebAppMain contextInitialized So for now just report it here and let the WebAppMain handle the failure gracefully LOGGER log SEVERE Failed to initialize Jenkins e public static HudsonFilter get ServletContext context return HudsonFilter context getAttribute HudsonFilter class getName public void reset SecurityRealm securityRealm throws ServletException if securityRealm null SecurityRealm SecurityComponents sc securityRealm getSecurityComponents AUTHENTICATION MANAGER setDelegate sc manager USER DETAILS SERVICE PROXY setDelegate sc userDetails REMEMBER ME SERVICES PROXY setDelegate sc rememberMe make sure this filter is always a valid filter Filter oldf this filter Filter newf securityRealm createFilter this filterConfig newf init this filterConfig this filter newf if oldf null oldf destroy else no security related filter needed AUTHENTICATION MANAGER setDelegate null USER DETAILS SERVICE PROXY setDelegate null REMEMBER ME SERVICES PROXY setDelegate null filter null public void doFilter ServletRequest request ServletResponse response FilterChain chain throws IOException ServletException LOGGER entering HudsonFilter class getName doFilter this is not the best place to do it but doing it here makes the patch smaller HttpServletResponse response setHeader X Content Type Options nosniff to deal with concurrency we need to capture the object Filter f filter if f null Hudson is starting up chain doFilter request response else f doFilter request response chain public void destroy the filter can be null if the filter is not initialized yet if filter null filter destroy private static final Logger LOGGER Logger getLogger HudsonFilter class getNamepackage hudson diagnosis import hudson Extension import jenkins model Jenkins import hudson model PeriodicWork import org jenkinsci Symbol import java util logging Logger Extension Symbol diskUsageCheck public class HudsonHomeDiskUsageChecker extends PeriodicWork public long getRecurrencePeriod return HOUR protected void doRun long free Jenkins getInstance getRootDir getUsableSpace long total Jenkins getInstance getRootDir getTotalSpace if free 0 total 0 information unavailable pointless to try LOGGER info JENKINS HOME disk usage information isn t available aborting to monitor cancel return LOGGER fine Monitoring disk usage of JENKINS HOME total total free free if it s more than 90 full and less than the minimum activate it s AND and not OR so that small Hudson home won t get a warning and similarly if you have a 1TB disk you don t get a warning when you still have 100GB to go HudsonHomeDiskUsageMonitor get activated total free 10 free FREE SPACE THRESHOLD private static final Logger LOGGER Logger getLogger HudsonHomeDiskUsageChecker class getName public static long FREE SPACE THRESHOLD Long getLong HudsonHomeDiskUsageChecker class getName freeSpaceThreshold 1024L 1024 1024package hudson diagnosis import hudson model AdministrativeMonitor import hudson model AbstractModelObject import hudson Extension import hudson ExtensionPoint import hudson ExtensionList import org jenkinsci Symbol import org kohsuke stapler HttpResponse import org kohsuke stapler HttpResponses import org kohsuke stapler QueryParameter import java io IOException import java util List Extension Symbol diskUsageCheck public final class HudsonHomeDiskUsageMonitor extends AdministrativeMonitor boolean activated public HudsonHomeDiskUsageMonitor super hudsonHomeIsFull public boolean isActivated return activated Override public String getDisplayName return Messages HudsonHomeDiskUsageMonitor DisplayName public HttpResponse doAct QueryParameter String no throws IOException if no null disable true return HttpResponses redirectViaContextPath manage else return HttpResponses redirectToDot public List Solution getSolutions return Solution all public Solution getSolution String id for Solution s Solution all if s id equals id return s return null public static HudsonHomeDiskUsageMonitor get return all get HudsonHomeDiskUsageMonitor class public static abstract class Solution extends AbstractModelObject implements ExtensionPoint public final String id protected Solution String id this id id protected Solution this id this getClass getName public String getUrl return HudsonHomeDiskUsageMonitor get getUrl solution id public static ExtensionList Solution all return ExtensionList lookup Solution classpackage hudson util import org kohsuke stapler StaplerRequest import org kohsuke stapler StaplerResponse import javax servlet ServletContext import javax servlet ServletException import static javax servlet http HttpServletResponse SC SERVICE UNAVAILABLE import java io IOException public class HudsonIsLoading public void doDynamic StaplerRequest req StaplerResponse rsp throws IOException ServletException InterruptedException rsp setStatus SC SERVICE UNAVAILABLE req getView this index jelly forward req rsppackage hudson util import org kohsuke stapler StaplerRequest import org kohsuke stapler StaplerResponse import javax servlet ServletContext import javax servlet ServletException import static javax servlet http HttpServletResponse SC SERVICE UNAVAILABLE import java io IOException public class HudsonIsRestarting public void doDynamic StaplerRequest req StaplerResponse rsp throws IOException ServletException InterruptedException rsp setStatus SC SERVICE UNAVAILABLE req getView this index jelly forward req rsppackage hudson security import com thoughtworks xstream converters UnmarshallingContext import hudson Extension import hudson ExtensionList import hudson Util import hudson diagnosis OldDataMonitor import hudson model Descriptor import jenkins model Jenkins import hudson model ManagementLink import hudson model ModelObject import hudson model User import hudson model UserProperty import hudson model UserPropertyDescriptor import hudson security FederatedLoginService FederatedIdentity import hudson security captcha CaptchaSupport import hudson util PluginServletFilter import hudson util Protector import hudson util Scrambler import hudson util XStream2 import net sf json JSONObject import org acegisecurity Authentication import org acegisecurity AuthenticationException import org acegisecurity BadCredentialsException import org acegisecurity GrantedAuthority import org acegisecurity context SecurityContextHolder import org acegisecurity providers UsernamePasswordAuthenticationToken import org acegisecurity providers encoding PasswordEncoder import org acegisecurity providers encoding ShaPasswordEncoder import org acegisecurity userdetails UserDetails import org acegisecurity userdetails UsernameNotFoundException import org jenkinsci Symbol import org kohsuke stapler DataBoundConstructor import org kohsuke stapler ForwardToView import org kohsuke stapler HttpResponse import org kohsuke stapler HttpResponses import org kohsuke stapler Stapler import org kohsuke stapler StaplerRequest import org kohsuke stapler StaplerResponse import org mindrot jbcrypt BCrypt import org springframework dao DataAccessException import javax servlet Filter import javax servlet FilterChain import javax servlet FilterConfig import javax servlet ServletException import javax servlet ServletRequest import javax servlet ServletResponse import javax servlet http HttpServletRequest import javax servlet http HttpServletResponse import static javax servlet http HttpServletResponse SC UNAUTHORIZED import java io IOException import java lang reflect Constructor import java security SecureRandom import java util ArrayList import java util Collections import java util List import java util MissingResourceException import java util ResourceBundle import java util logging Logger import org kohsuke accmod Restricted import org kohsuke accmod restrictions NoExternalUse public class HudsonPrivateSecurityRealm extends AbstractPasswordBasedSecurityRealm implements ModelObject AccessControlled private final boolean disableSignup private final boolean enableCaptcha Deprecated public HudsonPrivateSecurityRealm boolean allowsSignup this allowsSignup false CaptchaSupport null DataBoundConstructor public HudsonPrivateSecurityRealm boolean allowsSignup boolean enableCaptcha CaptchaSupport captchaSupport this disableSignup allowsSignup this enableCaptcha enableCaptcha setCaptchaSupport captchaSupport if allowsSignup hasSomeUser if Hudson is newly set up with the security realm and there s no user account created yet insert a filter that asks the user to create one try PluginServletFilter addFilter CREATE FIRST USER FILTER catch ServletException e throw new AssertionError e never happen because our Filter init is no op Override public boolean allowsSignup return disableSignup Restricted NoExternalUse class Jelly public boolean getAllowsSignup return allowsSignup public boolean isEnableCaptcha return enableCaptcha private static boolean hasSomeUser for User u User getAll if u getProperty Details class null return true return false Override public GroupDetails loadGroupByGroupname String groupname throws UsernameNotFoundException DataAccessException throw new UsernameNotFoundException groupname Override public Details loadUserByUsername String username throws UsernameNotFoundException DataAccessException User u User getById username false Details p u null u getProperty Details class null if p null throw new UsernameNotFoundException Password is not set username if p getUser null throw new AssertionError return p Override protected Details authenticate String username String password throws AuthenticationException Details u loadUserByUsername username if u isPasswordCorrect password String message try message ResourceBundle getBundle org acegisecurity messages getString AbstractUserDetailsAuthenticationProvider badCredentials catch MissingResourceException x message Bad credentials throw new BadCredentialsException message return u Override public HttpResponse commenceSignup final FederatedIdentity identity store the identity in the session so that we can use this later Stapler getCurrentRequest getSession setAttribute FEDERATED IDENTITY SESSION KEY identity return new ForwardToView this signupWithFederatedIdentity jelly Override public void generateResponse StaplerRequest req StaplerResponse rsp Object node throws IOException ServletException SignupInfo si new SignupInfo identity si errorMessage Messages HudsonPrivateSecurityRealm WouldYouLikeToSignUp identity getPronoun identity getIdentifier req setAttribute data si super generateResponse req rsp node public User doCreateAccountWithFederatedIdentity StaplerRequest req StaplerResponse rsp throws IOException ServletException User u doCreateAccount req rsp signupWithFederatedIdentity jelly if u null FederatedIdentity req getSession getAttribute FEDERATED IDENTITY SESSION KEY addTo u return u private static final String FEDERATED IDENTITY SESSION KEY HudsonPrivateSecurityRealm class getName federatedIdentity public User doCreateAccount StaplerRequest req StaplerResponse rsp throws IOException ServletException return doCreateAccount req rsp signup jelly private User doCreateAccount StaplerRequest req StaplerResponse rsp String formView throws ServletException IOException if allowsSignup throw HttpResponses error SC UNAUTHORIZED new Exception User sign up is prohibited boolean firstUser hasSomeUser User u createAccount req rsp enableCaptcha formView if u null if firstUser tryToMakeAdmin u the first user should be admin or else there s a risk of lock out loginAndTakeBack req rsp u return u SuppressWarnings ACL impersonate private void loginAndTakeBack StaplerRequest req StaplerResponse rsp User u throws ServletException IOException and let him login Authentication a new UsernamePasswordAuthenticationToken u getId req getParameter password1 a this getSecurityComponents manager authenticate a SecurityContextHolder getContext setAuthentication a then back to top req getView this success jelly forward req rsp public void doCreateAccountByAdmin StaplerRequest req StaplerResponse rsp throws IOException ServletException createAccountByAdmin req rsp addUser jelly send the user back to the listing page on success Restricted NoExternalUse class public User createAccountByAdmin StaplerRequest req StaplerResponse rsp String addUserView String successView throws IOException ServletException checkPermission Jenkins ADMINISTER User u createAccount req rsp false addUserView if u null rsp sendRedirect successView return u public void doCreateFirstAccount StaplerRequest req StaplerResponse rsp throws IOException ServletException if hasSomeUser rsp sendError SC UNAUTHORIZED First user was already created return User u createAccount req rsp false firstUser jelly if u null tryToMakeAdmin u loginAndTakeBack req rsp u private void tryToMakeAdmin User u AuthorizationStrategy as Jenkins getInstance getAuthorizationStrategy for PermissionAdder adder ExtensionList lookup PermissionAdder class if adder add as u Jenkins ADMINISTER return private User createAccount StaplerRequest req StaplerResponse rsp boolean selfRegistration String formView throws ServletException IOException form field validation this pattern needs to be generalized and moved to stapler SignupInfo si new SignupInfo req if selfRegistration validateCaptcha si captcha si errorMessage Messages HudsonPrivateSecurityRealm CreateAccount TextNotMatchWordInImage if si password1 null si password1 equals si password2 si errorMessage Messages HudsonPrivateSecurityRealm CreateAccount PasswordNotMatch if si password1 null si password1 length 0 si errorMessage Messages HudsonPrivateSecurityRealm CreateAccount PasswordRequired if si username null si username length 0 si errorMessage Messages HudsonPrivateSecurityRealm CreateAccount UserNameRequired else do not create the user we just want to check if the user already exists but is not a login user User user User getById si username false if null user Allow sign up SCM people has no such property if user getProperty Details class null si errorMessage Messages HudsonPrivateSecurityRealm CreateAccount UserNameAlreadyTaken if si fullname null si fullname length 0 si fullname si username if isMailerPluginPresent si email null si email contains si errorMessage Messages HudsonPrivateSecurityRealm CreateAccount InvalidEmailAddress if User isIdOrFullnameAllowed si username si errorMessage hudson model Messages User IllegalUsername si username if User isIdOrFullnameAllowed si fullname si errorMessage hudson model Messages User IllegalFullname si fullname if si errorMessage null failed ask the user to try again req setAttribute data si req getView this formView forward req rsp return null register the user User user createAccount si username si password1 user setFullName si fullname if isMailerPluginPresent try legacy hack mail support has moved out to a separate plugin Class up Jenkins getInstance pluginManager uberClassLoader loadClass hudson tasks Mailer UserProperty Constructor c up getDeclaredConstructor String class user addProperty UserProperty c newInstance si email catch ReflectiveOperationException e throw new RuntimeException e user save return user Restricted NoExternalUse class public boolean isMailerPluginPresent try mail support has moved to a separate plugin return null Jenkins getInstance pluginManager uberClassLoader loadClass hudson tasks Mailer UserProperty catch ClassNotFoundException e LOGGER finer Mailer plugin not present return false public User createAccount String userName String password throws IOException User user User getById userName true user addProperty Details fromPlainPassword password return user public String getDisplayName return Messages HudsonPrivateSecurityRealm DisplayName public ACL getACL return Jenkins getInstance getACL public void checkPermission Permission permission Jenkins getInstance checkPermission permission public boolean hasPermission Permission permission return Jenkins getInstance hasPermission permission public List User getAllUsers List User r new ArrayList User for User u User getAll if u getProperty Details class null r add u Collections sort r return r public User getUser String id return User getById id true TODO private static final GrantedAuthority TEST AUTHORITY AUTHENTICATED AUTHORITY public static final class SignupInfo public String username password1 password2 fullname email captcha public String errorMessage public SignupInfo public SignupInfo StaplerRequest req req bindParameters this public SignupInfo FederatedIdentity i this username i getNickname this fullname i getFullName this email i getEmailAddress public static final class Details extends UserProperty implements InvalidatableUserDetails private String passwordHash Deprecated private transient String password private Details String passwordHash this passwordHash passwordHash static Details fromHashedPassword String hashed return new Details hashed static Details fromPlainPassword String rawPassword return new Details PASSWORD ENCODER encodePassword rawPassword null public GrantedAuthority getAuthorities TODO return TEST AUTHORITY public String getPassword return passwordHash public boolean isPasswordCorrect String candidate return PASSWORD ENCODER isPasswordValid getPassword candidate null public String getProtectedPassword put session Id in it to prevent a replay attack return Protector protect Stapler getCurrentRequest getSession getId getPassword public String getUsername return user getId User getUser return user public boolean isAccountNonExpired return true public boolean isAccountNonLocked return true public boolean isCredentialsNonExpired return true public boolean isEnabled return true public boolean isInvalid return user null public static class ConverterImpl extends XStream2 PassthruConverter Details public ConverterImpl XStream2 xstream super xstream Override protected void callback Details d UnmarshallingContext context Convert to hashed password and report to monitor if we load old data if d password null d passwordHash null d passwordHash PASSWORD ENCODER encodePassword Scrambler descramble d password null OldDataMonitor report context 1 283 Extension Symbol password public static final class DescriptorImpl extends UserPropertyDescriptor Override public String getDisplayName return Messages HudsonPrivateSecurityRealm Details DisplayName Override public Details newInstance StaplerRequest req JSONObject formData throws FormException if req null Should never happen see newInstance Javadoc throw new FormException Stapler request is missing in the call staplerRequest String pwd Util fixEmpty req getParameter user password String pwd2 Util fixEmpty req getParameter user password2 if Util fixNull pwd equals Util fixNull pwd2 throw new FormException Please confirm the password by typing it twice user password2 String data Protector unprotect pwd if data null String prefix Stapler getCurrentRequest getSession getId if data startsWith prefix return Details fromHashedPassword data substring prefix length return Details fromPlainPassword Util fixNull pwd Override public boolean isEnabled this feature is only when HudsonPrivateSecurityRealm is enabled return Jenkins getInstance getSecurityRealm instanceof HudsonPrivateSecurityRealm public UserProperty newInstance User user return null Extension Symbol localUsers public static final class ManageUserLinks extends ManagementLink public String getIconFileName if Jenkins getInstance getSecurityRealm instanceof HudsonPrivateSecurityRealm return user png else return null not applicable now public String getUrlName return securityRealm public String getDisplayName return Messages HudsonPrivateSecurityRealm ManageUserLinks DisplayName Override public String getDescription return Messages HudsonPrivateSecurityRealm ManageUserLinks Description static final PasswordEncoder CLASSIC new PasswordEncoder private final PasswordEncoder passwordEncoder new ShaPasswordEncoder 256 public String encodePassword String rawPass Object throws DataAccessException return hash rawPass public boolean isPasswordValid String encPass String rawPass Object throws DataAccessException pull out the sale from the encoded password int i encPass indexOf if i 0 return false String salt encPass substring 0 i return encPass substring i 1 equals passwordEncoder encodePassword rawPass salt private String hash String password String salt generateSalt return salt passwordEncoder encodePassword password salt private String generateSalt StringBuilder buf new StringBuilder SecureRandom sr new SecureRandom for int i 0 i 6 i log2 52 6 34 20 so this is about 32bit strong boolean upper sr nextBoolean char ch char sr nextInt 26 a if upper ch Character toUpperCase ch buf append ch return buf toString private static final PasswordEncoder JBCRYPT ENCODER new PasswordEncoder public String encodePassword String rawPass Object throws DataAccessException return BCrypt hashpw rawPass BCrypt gensalt public boolean isPasswordValid String encPass String rawPass Object throws DataAccessException return BCrypt checkpw rawPass encPass public static final PasswordEncoder PASSWORD ENCODER new PasswordEncoder public String encodePassword String rawPass Object salt throws DataAccessException return JBCRYPT HEADER JBCRYPT ENCODER encodePassword rawPass salt public boolean isPasswordValid String encPass String rawPass Object salt throws DataAccessException if encPass startsWith JBCRYPT HEADER return JBCRYPT ENCODER isPasswordValid encPass substring JBCRYPT HEADER length rawPass salt else return CLASSIC isPasswordValid encPass rawPass salt private static final String JBCRYPT HEADER jbcrypt Extension Symbol local public static final class DescriptorImpl extends Descriptor SecurityRealm public String getDisplayName return Messages HudsonPrivateSecurityRealm DisplayName private static final Filter CREATE FIRST USER FILTER new Filter public void init FilterConfig config throws ServletException public void doFilter ServletRequest request ServletResponse response FilterChain chain throws IOException ServletException HttpServletRequest req HttpServletRequest request if req getRequestURI equals req getContextPath req getRequestURI equals req getContextPath manage if needsToCreateFirstUser HttpServletResponse response sendRedirect securityRealm firstUser else the first user already created the role of this filter is over PluginServletFilter removeFilter this chain doFilter request response else chain doFilter request response private boolean needsToCreateFirstUser return hasSomeUser Jenkins getInstance getSecurityRealm instanceof HudsonPrivateSecurityRealm public void destroy private static final Logger LOGGER Logger getLogger HudsonPrivateSecurityRealm class getNamepackage hudson console import hudson Extension import hudson MarkupText import jenkins model Jenkins import org jenkinsci Symbol import org kohsuke stapler Stapler import org kohsuke stapler StaplerRequest import java io IOException import java util logging Level import java util logging Logger public class HyperlinkNote extends ConsoleNote private final String url private final int length public HyperlinkNote String url int length this url url this length length Override public ConsoleAnnotator annotate Object context MarkupText text int charPos String url this url if url startsWith StaplerRequest req Stapler getCurrentRequest if req null if we are serving HTTP request we want to use app relative URL url req getContextPath url else otherwise presumably this is rendered for e mails and other non HTTP stuff url Jenkins getInstance getRootUrl url substring 1 text addMarkup charPos charPos length a href url extraAttributes a return null protected String extraAttributes return public static String encodeTo String url String text try return new HyperlinkNote url text length encode text catch IOException e impossible but don t make this a fatal problem LOGGER log Level WARNING Failed to serialize HyperlinkNote class e return text Extension Symbol hyperlink public static class DescriptorImpl extends ConsoleAnnotationDescriptor public String getDisplayName return Hyperlinks private static final Logger LOGGER Logger getLogger HyperlinkNote class getNamepackage jenkins import hudson Extension import hudson model RootAction import hudson util HttpResponses import jenkins util ResourceBundleUtil import org kohsuke accmod Restricted import org kohsuke accmod restrictions NoExternalUse import org kohsuke stapler HttpResponse import org kohsuke stapler StaplerRequest import java util Locale Extension Restricted NoExternalUse class public class I18n implements RootAction Override public String getIconFileName return null Override public String getDisplayName return null Override public String getUrlName return i18n public HttpResponse doResourceBundle StaplerRequest request String baseName request getParameter baseName if baseName null return HttpResponses errorJSON Mandatory parameter baseName not specified String language request getParameter language String country request getParameter country String variant request getParameter variant try Locale locale request getLocale if language null country null variant null locale new Locale language country variant else if language null country null locale new Locale language country else if language null locale new Locale language return HttpResponses okJSON ResourceBundleUtil getBundle baseName locale catch Exception e return HttpResponses errorJSON e getMessagepackage com twitter sdk android core models public interface Identifiable long getIdpackage jenkins model identity import hudson Extension import hudson model UnprotectedRootAction import java security MessageDigest import java security NoSuchAlgorithmException import java security interfaces RSAPrivateKey import java security interfaces RSAPublicKey import org apache commons codec Charsets import org apache commons codec binary Base64 Extension public class IdentityRootAction implements UnprotectedRootAction Override public String getIconFileName return null Override public String getDisplayName return null Override public String getUrlName return InstanceIdentityProvider RSA getKeyPair null null instance identity public String getPublicKey RSAPublicKey key InstanceIdentityProvider RSA getPublicKey if key null return null byte encoded Base64 encodeBase64 key getEncoded int index 0 StringBuilder buf new StringBuilder encoded length 20 while index encoded length int len Math min 64 encoded length index if index 0 buf append n buf append new String encoded index len Charsets UTF 8 index len return String format BEGIN PUBLIC KEY n s n END PUBLIC KEY n buf toString public String getFingerprint RSAPublicKey key InstanceIdentityProvider RSA getPublicKey if key null return null TODO replace with org jenkinsci remoting util KeyUtils once JENKINS 36871 changes are merged try MessageDigest digest MessageDigest getInstance MD5 digest reset byte bytes digest digest key getEncoded StringBuilder result new StringBuilder Math max 0 bytes length 3 1 for int i 0 i bytes length i if i 0 result append int b bytes i 0xFF result append Character forDigit b 4 0x0f 16 append Character forDigit b 0xf 16 return result toString catch NoSuchAlgorithmException e throw new IllegalStateException JLS mandates MD5 supportpackage jenkins model import hudson DescriptorExtensionList import hudson Extension import hudson ExtensionPoint import hudson model AbstractDescribableImpl import hudson util CaseInsensitiveComparator import org apache commons lang StringUtils import org jenkinsci Symbol import org kohsuke stapler DataBoundConstructor import javax annotation Nonnull import java util Comparator import java util Locale public abstract class IdStrategy extends AbstractDescribableImpl IdStrategy implements ExtensionPoint Comparator String public static IdStrategy CASE INSENSITIVE new CaseInsensitive Nonnull public abstract String filenameOf Nonnull String id public String idFromFilename Nonnull String filename return filename Nonnull public abstract String keyFor Nonnull String id public boolean equals Nonnull String id1 Nonnull String id2 return compare id1 id2 0 Override public abstract int compare Nonnull String id1 Nonnull String id2 Override SuppressWarnings unchecked public IdStrategyDescriptor getDescriptor return IdStrategyDescriptor super getDescriptor Override public boolean equals Object obj return this obj obj null getClass equals obj getClass Override public int hashCode return getClass hashCode Override public String toString return getClass getName public static DescriptorExtensionList IdStrategy IdStrategyDescriptor all return Jenkins getInstance getDescriptorList IdStrategy class public static class CaseInsensitive extends IdStrategy DataBoundConstructor public CaseInsensitive Override Nonnull public String filenameOf Nonnull String id return id toLowerCase Locale ENGLISH Override Nonnull public String keyFor Nonnull String id return id toLowerCase Locale ENGLISH Override public int compare Nonnull String id1 Nonnull String id2 return CaseInsensitiveComparator INSTANCE compare id1 id2 Extension Symbol caseInsensitive public static class DescriptorImpl extends IdStrategyDescriptor Override public String getDisplayName return Messages IdStrategy CaseInsensitive DisplayName public static class CaseSensitive extends IdStrategy DataBoundConstructor public CaseSensitive Override Nonnull public String filenameOf Nonnull String id if id matches a z0 9 return id else StringBuilder buf new StringBuilder id length 16 for char c id toCharArray if a c c z buf append c else if 0 c c 9 buf append c else if c c c c c buf append c else if A c c Z buf append buf append Character toLowerCase c else buf append buf append StringUtils leftPad Integer toHexString c 0xffff 4 0 return buf toString Override public String idFromFilename Nonnull String filename if filename matches a z0 9 return filename else StringBuilder buf new StringBuilder filename length final char chars filename toCharArray for int i 0 i chars length i char c chars i if a c c z buf append c else if 0 c c 9 buf append c else if c c c c c buf append c else if c i if i chars length buf append Character toUpperCase chars i else if c StringBuilder hex new StringBuilder 4 i if i chars length hex append chars i else break i if i chars length hex append chars i else break i if i chars length hex append chars i else break i if i chars length hex append chars i else break buf append Character valueOf char Integer parseInt hex toString 16 return buf toString Override public boolean equals Nonnull String id1 Nonnull String id2 return StringUtils equals id1 id2 Override Nonnull public String keyFor Nonnull String id return id Override public int compare Nonnull String id1 Nonnull String id2 return id1 compareTo id2 Extension Symbol caseSensitive public static class DescriptorImpl extends IdStrategyDescriptor Override public String getDisplayName return Messages IdStrategy CaseSensitive DisplayName public static class CaseSensitiveEmailAddress extends CaseSensitive DataBoundConstructor public CaseSensitiveEmailAddress Override Nonnull public String filenameOf Nonnull String id return super filenameOf keyFor id Override public boolean equals Nonnull String id1 Nonnull String id2 return StringUtils equals keyFor id1 keyFor id2 Override Nonnull public String keyFor Nonnull String id int index id lastIndexOf The can be used in local part if quoted correctly the last is the one used to separate the domain and local part return index 1 id id substring 0 index id substring index toLowerCase Locale ENGLISH Override public int compare Nonnull String id1 Nonnull String id2 return keyFor id1 compareTo keyFor id2 Extension public static class DescriptorImpl extends IdStrategyDescriptor Override public String getDisplayName return Messages IdStrategy CaseSensitiveEmailAddress DisplayNamepackage jenkins model import hudson model Descriptor public abstract class IdStrategyDescriptor extends Descriptor IdStrategypackage com twitter sdk android core models import com google gson annotations SerializedName public class Image SerializedName w public final int w SerializedName h public final int h SerializedName image type public final String imageType public Image int w int h String imageType this w w this h h this imageType imageTypepackage com twitter sdk android core models import com google gson annotations SerializedName public class ImageValue SerializedName height public final int height SerializedName width public final int width SerializedName url public final String url SerializedName alt public final String alt public ImageValue int height int width String url String alt this height height this width width this url url this alt altpackage hudson util xstream import com google common collect ImmutableList import com thoughtworks xstream XStream import com thoughtworks xstream XStreamException import com thoughtworks xstream converters UnmarshallingContext import com thoughtworks xstream converters collections CollectionConverter import com thoughtworks xstream converters reflection ReflectionProvider import com thoughtworks xstream converters reflection SerializableConverter import com thoughtworks xstream io HierarchicalStreamReader import com thoughtworks xstream mapper Mapper import hudson util RobustReflectionConverter import java util ArrayList import java util List import jenkins util xstream CriticalXStreamException public class ImmutableListConverter extends CollectionConverter private final SerializableConverter sc public ImmutableListConverter XStream xs this xs getMapper xs getReflectionProvider public ImmutableListConverter Mapper mapper ReflectionProvider reflectionProvider super mapper sc new SerializableConverter mapper reflectionProvider Override public boolean canConvert Class type return ImmutableList class isAssignableFrom type Override public Object unmarshal HierarchicalStreamReader reader UnmarshallingContext context String resolvesTo reader getAttribute resolves to if com google common collect ImmutableList SerializedForm equals resolvesTo Skip into the elements element This has the real children List items new ArrayList if reader hasMoreChildren reader moveDown read the individual items from xml into a list while reader hasMoreChildren reader moveDown try Object item readItem reader context items items add item catch CriticalXStreamException e throw e catch XStreamException e RobustReflectionConverter addErrorInContext context e catch LinkageError e RobustReflectionConverter addErrorInContext context e reader moveUp move back up past the elements element reader moveUp return ImmutableList copyOf items else return ImmutableList copyOf List super unmarshal reader context Override protected Object createCollection Class type return new ArrayListpackage hudson util xstream import com google common collect ImmutableMap import com thoughtworks xstream XStream import com thoughtworks xstream converters UnmarshallingContext import com thoughtworks xstream converters collections MapConverter import com thoughtworks xstream converters reflection ReflectionProvider import com thoughtworks xstream converters reflection SerializableConverter import com thoughtworks xstream io HierarchicalStreamReader import com thoughtworks xstream mapper Mapper import java util HashMap import java util Map import java util concurrent ConcurrentHashMap public class ImmutableMapConverter extends MapConverter private final SerializableConverter sc public ImmutableMapConverter XStream xs this xs getMapper xs getReflectionProvider public ImmutableMapConverter Mapper mapper ReflectionProvider reflectionProvider super mapper sc new SerializableConverter mapper reflectionProvider Override public boolean canConvert Class type return ImmutableMap class isAssignableFrom type Override public Object unmarshal HierarchicalStreamReader reader UnmarshallingContext context return ImmutableMap copyOf Map super unmarshal reader context Override protected Object createCollection Class type return new HashMappackage hudson util xstream import com google common collect ImmutableSet import com thoughtworks xstream XStream import com thoughtworks xstream converters UnmarshallingContext import com thoughtworks xstream converters collections CollectionConverter import com thoughtworks xstream converters reflection ReflectionProvider import com thoughtworks xstream converters reflection SerializableConverter import com thoughtworks xstream io HierarchicalStreamReader import com thoughtworks xstream mapper Mapper import java util ArrayList import java util List public class ImmutableSetConverter extends CollectionConverter private final SerializableConverter sc public ImmutableSetConverter XStream xs this xs getMapper xs getReflectionProvider public ImmutableSetConverter Mapper mapper ReflectionProvider reflectionProvider super mapper sc new SerializableConverter mapper reflectionProvider Override public boolean canConvert Class type return ImmutableSet class isAssignableFrom type Override public Object unmarshal HierarchicalStreamReader reader UnmarshallingContext context return ImmutableSet copyOf List super unmarshal reader context Override protected Object createCollection Class type return new ArrayListpackage hudson util xstream import com google common collect ImmutableSortedSet import com thoughtworks xstream XStream import com thoughtworks xstream converters UnmarshallingContext import com thoughtworks xstream converters collections CollectionConverter import com thoughtworks xstream converters reflection ReflectionProvider import com thoughtworks xstream converters reflection SerializableConverter import com thoughtworks xstream io HierarchicalStreamReader import com thoughtworks xstream mapper Mapper import java util ArrayList import java util List public class ImmutableSortedSetConverter extends CollectionConverter private final SerializableConverter sc public ImmutableSortedSetConverter XStream xs this xs getMapper xs getReflectionProvider public ImmutableSortedSetConverter Mapper mapper ReflectionProvider reflectionProvider super mapper sc new SerializableConverter mapper reflectionProvider Override public boolean canConvert Class type return ImmutableSortedSet class isAssignableFrom type Override public Object unmarshal HierarchicalStreamReader reader UnmarshallingContext context return ImmutableSortedSet copyOf List super unmarshal reader context Override protected Object createCollection Class type return new ArrayListpackage jenkins security import hudson model User import hudson security SecurityRealm import hudson security UserMayOrMayNotExistException import org acegisecurity userdetails UserDetails import org acegisecurity userdetails UserDetailsService import org acegisecurity userdetails UsernameNotFoundException import org springframework dao DataAccessException import static java util Collections public class ImpersonatingUserDetailsService implements UserDetailsService private final UserDetailsService base public ImpersonatingUserDetailsService UserDetailsService base this base base Override public UserDetails loadUserByUsername String username throws UsernameNotFoundException DataAccessException try return base loadUserByUsername username catch UserMayOrMayNotExistException e return attemptToImpersonate username e catch DataAccessException e return attemptToImpersonate username e protected UserDetails attemptToImpersonate String username RuntimeException e this backend cannot tell if the user name exists or not so substitute by what we know User u User getById username false if u null LastGrantedAuthoritiesProperty p u getProperty LastGrantedAuthoritiesProperty class if p null return new org acegisecurity userdetails User username true true true true p getAuthorities throw epackage hudson util import hudson remoting Which import java io IOException import java net URL public class IncompatibleAntVersionDetected extends BootFailure private final Class antClass public IncompatibleAntVersionDetected Class antClass this antClass antClass Override public String getMessage try return Incompatible Ant loaded from getWhereAntIsLoaded catch IOException e return Incompatible Ant loaded public URL getWhereAntIsLoaded throws IOException return Which jarURL antClasspackage hudson util import hudson remoting Which import java io IOException import java net URL public class IncompatibleServletVersionDetected extends BootFailure private final Class servletClass public IncompatibleServletVersionDetected Class servletClass this servletClass servletClass public URL getWhereServletIsLoaded throws IOException return Which jarURL servletClasspackage hudson util import java util Map public class IncompatibleVMDetected extends BootFailure public Map getSystemProperties return System getPropertiespackage hudson import hudson model Job public abstract class Indenter J extends Job protected abstract int getNestLevel J job public final String getCss J job return padding left getNestLevel job 2 em public final String getRelativeShift J job int i getNestLevel job if i 0 return null return position relative left i 2 empackage hudson util jna import java lang reflect InvocationHandler import java lang reflect Method import java lang reflect Proxy public class InitializationErrorInvocationHandler implements InvocationHandler private final Throwable cause private InitializationErrorInvocationHandler Throwable cause this cause cause public Object invoke Object proxy Method method Object args throws Throwable if method getDeclaringClass Object class return method invoke this args throw new UnsupportedOperationException Failed to link the library method getDeclaringClass cause public static T T create Class T type Throwable cause return type cast Proxy newProxyInstance type getClassLoader new Class type new InitializationErrorInvocationHandler causepackage hudson init import hudson Extension import org jvnet hudson annotation indexer Indexed import org jvnet hudson reactor Task import java lang annotation Documented import static java lang annotation ElementType METHOD import java lang annotation Retention import static java lang annotation RetentionPolicy RUNTIME import java lang annotation Target import static hudson init InitMilestone STARTED import static hudson init InitMilestone COMPLETED Indexed Documented Retention RUNTIME Target METHOD public interface Initializer InitMilestone after default STARTED InitMilestone before default COMPLETED String requires default String attains default String displayName default boolean fatal default truepackage hudson init import org jvnet hudson reactor Milestone public class InitializerFinder extends TaskMethodFinder Initializer public InitializerFinder ClassLoader cl super Initializer class InitMilestone class cl public InitializerFinder this Thread currentThread getContextClassLoader Override protected String displayNameOf Initializer i return i displayName Override protected String requiresOf Initializer i return i requires Override protected String attainsOf Initializer i return i attains Override protected Milestone afterOf Initializer i return i after Override protected Milestone beforeOf Initializer i return i before Override protected boolean fatalOf Initializer i return i fatalpackage hudson init impl import static hudson init InitMilestone JOB LOADED import hudson init Initializer import jenkins model Jenkins import hudson model Messages import org apache commons io FileUtils import java io File import java io IOException public class InitialUserContent Initializer after JOB LOADED public static void init Jenkins h throws IOException File userContentDir new File h getRootDir userContent if userContentDir exists userContentDir mkdirs FileUtils writeStringToFile new File userContentDir readme txt Messages Hudson USER CONTENT README npackage hudson init import org jvnet hudson reactor Executable import org jvnet hudson reactor Milestone import org jvnet hudson reactor TaskBuilder import org jvnet hudson reactor TaskGraphBuilder public enum InitMilestone implements Milestone STARTED Started initialization PLUGINS LISTED Listed all plugins PLUGINS PREPARED Prepared all plugins PLUGINS STARTED Started all plugins EXTENSIONS AUGMENTED Augmented all extensions JOB LOADED Loaded all jobs COMPLETED Completed initialization private final String message InitMilestone String message this message message public static TaskBuilder ordering TaskGraphBuilder b new TaskGraphBuilder InitMilestone v values for int i 0 i v length 1 i b add null Executable NOOP requires v i attains v i 1 return b Override public String toString return messagepackage hudson init import org jvnet hudson reactor ReactorListener import org kohsuke MetaInfServices public interface InitReactorListener extends ReactorListenerpackage jenkins import jenkins util SystemProperties import hudson init InitMilestone import hudson init InitReactorListener import hudson util DaemonThreadFactory import hudson util NamingThreadFactory import hudson util Service import jenkins model Configuration import jenkins model Jenkins import org jvnet hudson reactor Milestone import org jvnet hudson reactor Reactor import org jvnet hudson reactor ReactorException import org jvnet hudson reactor ReactorListener import org jvnet hudson reactor Task import java io IOException import java util List import java util concurrent ExecutorService import java util concurrent Executors import java util concurrent LinkedBlockingQueue import java util concurrent ThreadPoolExecutor import java util concurrent TimeUnit import java util logging Level import java util logging Logger import static java util logging Level SEVERE import org kohsuke accmod Restricted import org kohsuke accmod restrictions NoExternalUse public class InitReactorRunner public void run Reactor reactor throws InterruptedException ReactorException IOException reactor addAll InitMilestone ordering discoverTasks reactor ExecutorService es if Jenkins PARALLEL LOAD es new ThreadPoolExecutor TWICE CPU NUM TWICE CPU NUM 5L TimeUnit SECONDS new LinkedBlockingQueue Runnable new DaemonThreadFactory else es Executors newSingleThreadExecutor new NamingThreadFactory new DaemonThreadFactory InitReactorRunner try reactor execute es buildReactorListener finally es shutdownNow upon a successful return the executor queue should be empty Upon an exception we want to cancel all pending tasks private ReactorListener buildReactorListener throws IOException List ReactorListener r List Service loadInstances Thread currentThread getContextClassLoader InitReactorListener class r add new ReactorListener final Level level Level parse Configuration getStringConfigParameter initLogLevel FINE public void onTaskStarted Task t LOGGER log level Started 0 getDisplayName t public void onTaskCompleted Task t LOGGER log level Completed 0 getDisplayName t public void onTaskFailed Task t Throwable err boolean fatal LOGGER log SEVERE Failed getDisplayName t err public void onAttained Milestone milestone Level lv level String s Attained milestone toString if milestone instanceof InitMilestone lv Level INFO noteworthy milestones at least while we debug problems further onInitMilestoneAttained InitMilestone milestone s milestone toString LOGGER log lv s return new ReactorListener Aggregator r Restricted NoExternalUse class public static String getDisplayName Task t try return t getDisplayName catch RuntimeException Error x LOGGER log Level WARNING failed to find displayName of t x return t toString protected void onInitMilestoneAttained InitMilestone milestone private static final int TWICE CPU NUM SystemProperties getInteger InitReactorRunner class getName concurrency Runtime getRuntime availableProcessors 2 private static final Logger LOGGER Logger getLogger InitReactorRunner class getNamepackage hudson init import org kohsuke MetaInfServices import org jvnet hudson reactor Task import java io File import java io FilenameFilter import java io IOException import java util Collection import java util List import java util ArrayList import java util Arrays import java util logging Level import java util logging Logger import hudson PluginManager import jenkins util SystemProperties import hudson util DirScanner import hudson util FileVisitor import hudson util Service public class InitStrategy public List File listPluginArchives PluginManager pm throws IOException List File r new ArrayList File the ordering makes sure that during the debugging we get proper precedence among duplicates for example while doing mvn jpi run or mvn hpi run on a plugin that s bundled with Jenkins we want to the jpl file to override the bundled jpi hpi file getBundledPluginsFromProperty r similarly we prefer jpi over hpi listPluginFiles pm jpl r linked plugin for debugging listPluginFiles pm hpl r linked plugin for debugging for backward compatibility listPluginFiles pm jpi r plugin jar file listPluginFiles pm hpi r plugin jar file for backward compatibility return r private void listPluginFiles PluginManager pm String extension Collection File all throws IOException File files pm rootDir listFiles new FilterByExtension extension if files null throw new IOException Jenkins is unable to create pm rootDir nPerhaps its security privilege is insufficient all addAll Arrays asList files protected void getBundledPluginsFromProperty final List File r String hplProperty SystemProperties getString hudson bundled plugins if hplProperty null for String hplLocation hplProperty split File hpl new File hplLocation trim if hpl exists r add hpl else if hpl getName contains try new DirScanner Glob hpl getName null scan hpl getParentFile new FileVisitor Override public void visit File f String relativePath throws IOException r add f catch IOException x LOGGER log Level WARNING could not expand hplLocation x else LOGGER warning bundled plugin hplLocation does not exist public boolean skipInitTask Task task return false public static InitStrategy get ClassLoader cl throws IOException List InitStrategy r Service loadInstances cl InitStrategy class if r isEmpty return new InitStrategy default InitStrategy s r get 0 LOGGER fine Using s as InitStrategy return s private static final Logger LOGGER Logger getLogger InitStrategy class getName private static class FilterByExtension implements FilenameFilter private final List String extensions public FilterByExtension String extensions this extensions Arrays asList extensions public boolean accept File dir String name for String extension extensions if name endsWith extension return true return falsepackage hudson tools import hudson Extension import hudson model Node import hudson model TaskListener import java io IOException import java util Map import java util WeakHashMap import java util concurrent Semaphore Extension public class InstallerTranslator extends ToolLocationTranslator private static final Map Node Map ToolInstallation Semaphore mutexByNode new WeakHashMap Node Map ToolInstallation Semaphore public String getToolHome Node node ToolInstallation tool TaskListener log throws IOException InterruptedException if node getRootPath null log error node getDisplayName is offline cannot locate tool getName return null InstallSourceProperty isp tool getProperties get InstallSourceProperty class if isp null return null for ToolInstaller installer isp installers if installer appliesTo node Semaphore semaphore synchronized mutexByNode Map ToolInstallation Semaphore mutexByTool mutexByNode get node if mutexByTool null mutexByNode put node mutexByTool new WeakHashMap ToolInstallation Semaphore semaphore mutexByTool get tool if semaphore null mutexByTool put tool semaphore new Semaphore 1 semaphore acquire try return installer performInstallation tool node log getRemote finally semaphore release return nullpackage hudson cli import hudson AbortException import hudson Extension import hudson FilePath import hudson PluginManager import jenkins model Jenkins import hudson model UpdateSite import hudson model UpdateSite Data import hudson util EditDistance import org kohsuke args4j Argument import org kohsuke args4j Option import java io File import java io IOException import java net URL import java net MalformedURLException import java util HashSet import java util List import java util ArrayList import java util Set Extension public class InstallPluginCommand extends CLICommand public String getShortDescription return Messages InstallPluginCommand ShortDescription Argument metaVar SOURCE required true usage If this points to a local file that file will be installed If this is an URL Jenkins downloads the URL and installs that as a plugin Otherwise the name is assumed to be the short name of the plugin in the existing update center like findbugs and the plugin will be installed from the update center public List String sources new ArrayList String Option name name usage If specified the plugin will be installed as this short name whereas normally the name is inferred from the source name automatically public String name Option name restart usage Restart Jenkins upon successful installation public boolean restart Option name deploy usage Deploy plugins right away without postponing them until the reboot public boolean dynamicLoad protected int run throws Exception Jenkins h Jenkins getActiveInstance h checkPermission PluginManager UPLOAD PLUGINS PluginManager pm h getPluginManager for String source sources is this a file if channel null FilePath f new FilePath channel source if f exists stdout println Messages InstallPluginCommand InstallingPluginFromLocalFile f if name null name f getBaseName f copyTo getTargetFilePath if dynamicLoad pm dynamicLoad getTargetFile continue is this an URL try URL u new URL source stdout println Messages InstallPluginCommand InstallingPluginFromUrl u if name null name u getPath name name substring name lastIndexOf 1 name name substring name lastIndexOf 1 int idx name lastIndexOf if idx 0 name name substring 0 idx getTargetFilePath copyFrom u if dynamicLoad pm dynamicLoad getTargetFile continue catch MalformedURLException e not an URL is this a plugin the update center UpdateSite Plugin p h getUpdateCenter getPlugin source if p null stdout println Messages InstallPluginCommand InstallingFromUpdateCenter source Throwable e p deploy dynamicLoad get getError if e null AbortException myException new AbortException Failed to install plugin source myException initCause e throw myException continue stdout println Messages InstallPluginCommand NotAValidSourceName source if source contains source contains source contains source contains looks like a short plugin name Why did we fail to find it in the update center if h getUpdateCenter getSites isEmpty stdout println Messages InstallPluginCommand NoUpdateCenterDefined else Set String candidates new HashSet String for UpdateSite s h getUpdateCenter getSites Data dt s getData if dt null stdout println Messages InstallPluginCommand NoUpdateDataRetrieved s getUrl else candidates addAll dt plugins keySet stdout println Messages InstallPluginCommand DidYouMean source EditDistance findNearest source candidates throw new AbortException Error occurred see previous output if restart h safeRestart return 0 all success private FilePath getTargetFilePath return new FilePath getTargetFile private File getTargetFile return new File Jenkins getActiveInstance getPluginManager rootDir name jpipackage hudson tools import hudson Extension import hudson util DescribableList import hudson model Descriptor import hudson model Saveable import org jenkinsci Symbol import org kohsuke stapler DataBoundConstructor import java util List import java io IOException public class InstallSourceProperty extends ToolProperty ToolInstallation TODO get the proper Saveable public final DescribableList ToolInstaller Descriptor ToolInstaller installers new DescribableList ToolInstaller Descriptor ToolInstaller Saveable NOOP DataBoundConstructor public InstallSourceProperty List extends ToolInstaller installers throws IOException if installers null this installers replaceBy installers Override public void setTool ToolInstallation t super setTool t for ToolInstaller installer installers installer setTool t public Class ToolInstallation type return ToolInstallation class Extension Symbol installSource public static class DescriptorImpl extends ToolPropertyDescriptor public String getDisplayName return Messages InstallSourceProperty DescriptorImpl displayNamepackage jenkins install import javax annotation CheckForNull import javax annotation Nonnull import hudson Extension import hudson ExtensionList import hudson ExtensionPoint import java util logging Level import java util logging Logger import jenkins model Jenkins import org apache commons lang StringUtils public class InstallState implements ExtensionPoint Extension public static final InstallState UNKNOWN new InstallState UNKNOWN true Extension public static final InstallState RUNNING new InstallState RUNNING true Extension public static final InstallState INITIAL SETUP COMPLETED new InstallState INITIAL SETUP COMPLETED true public void initializeState Jenkins j Jenkins getInstance try j getSetupWizard completeSetup catch Exception e throw new RuntimeException e j setInstallState RUNNING Extension public static final InstallState CREATE ADMIN USER new InstallState CREATE ADMIN USER false public void initializeState Jenkins j Jenkins getInstance Skip this state if not using the security defaults e g in an init script set up security already if j getSetupWizard isUsingSecurityDefaults InstallUtil proceedToNextStateFrom this Extension public static final InstallState INITIAL PLUGINS INSTALLING new InstallState INITIAL PLUGINS INSTALLING false Extension public static final InstallState INITIAL SECURITY SETUP new InstallState INITIAL SECURITY SETUP false public void initializeState try Jenkins getInstance getSetupWizard init true catch Exception e throw new RuntimeException e InstallUtil proceedToNextStateFrom INITIAL SECURITY SETUP Extension public static final InstallState NEW new InstallState NEW false Extension public static final InstallState RESTART new InstallState RESTART true public void initializeState InstallUtil saveLastExecVersion Extension public static final InstallState UPGRADE new UpgradeWizard Extension public static final InstallState DOWNGRADE new InstallState DOWNGRADE true public void initializeState InstallUtil saveLastExecVersion private static final Logger LOGGER Logger getLogger InstallState class getName public static final InstallState TEST new InstallState TEST true public static final InstallState DEVELOPMENT new InstallState DEVELOPMENT true private final boolean isSetupComplete private final String name public InstallState Nonnull String name boolean isSetupComplete this name name this isSetupComplete isSetupComplete public void initializeState public Object readResolve If we get invalid state from the configuration fallback to unknown if StringUtils isBlank name LOGGER log Level WARNING Read install state with blank name 0 It will be ignored name return UNKNOWN InstallState state InstallState valueOf name if state null LOGGER log Level WARNING Cannot locate an extension point for the state 0 It will be ignored name return UNKNOWN Otherwise we return the actual state return state public boolean isSetupComplete return isSetupComplete public String name return name Override public int hashCode return name hashCode Override public boolean equals Object obj if obj instanceof InstallState return name equals InstallState obj name return false Override public String toString return InstallState name CheckForNull public static InstallState valueOf Nonnull String name for InstallState state all if name equals state name return state return null static ExtensionList InstallState all return ExtensionList lookup InstallState classpackage jenkins install import java util List import javax inject Provider import hudson ExtensionList import hudson ExtensionPoint public abstract class InstallStateFilter implements ExtensionPoint public abstract InstallState getNextInstallState InstallState current Provider InstallState proceed public static List InstallStateFilter all return ExtensionList lookup InstallStateFilter classpackage hudson cli import hudson Extension import hudson AbortException import hudson EnvVars import jenkins model Jenkins import hudson model AbstractProject import hudson model Run import hudson model Executor import hudson model Node import hudson model Item import hudson util EditDistance import hudson util StreamTaskListener import hudson tools ToolDescriptor import hudson tools ToolInstallation import java util List import java util ArrayList import java io IOException import jenkins security MasterToSlaveCallable import org kohsuke args4j Argument Extension public class InstallToolCommand extends CLICommand Argument index 0 metaVar KIND usage The type of the tool to install such as Ant public String toolType Argument index 1 metaVar NAME usage The name of the tool to install as you ve entered in the Jenkins system configuration public String toolName public String getShortDescription return Messages InstallToolCommand ShortDescription protected int run throws Exception Jenkins h Jenkins getActiveInstance h checkPermission Jenkins READ where is this build running BuildIDs id checkChannel call new BuildIDs if id isComplete throw new IllegalStateException This command can be only invoked from a build executing inside Hudson AbstractProject p h getItemByFullName id job AbstractProject class if p null throw new IllegalStateException No such job found id job p checkPermission Item CONFIGURE List String toolTypes new ArrayList String for ToolDescriptor d ToolInstallation all toolTypes add d getDisplayName if d getDisplayName equals toolType List String toolNames new ArrayList String for ToolInstallation t d getInstallations toolNames add t getName if t getName equals toolName return install t id p didn t find the right tool name error toolNames toolName name didn t find the tool type error toolTypes toolType type will never be here throw new AssertionError private int error List String candidates String given String noun throws AbortException if given null throw new IllegalArgumentException No tool noun was specified Valid values are candidates toString else throw new IllegalArgumentException Unrecognized tool noun Perhaps you meant EditDistance findNearest given candidates private int install ToolInstallation t BuildIDs id AbstractProject p throws IOException InterruptedException Run b p getBuildByNumber Integer parseInt id number if b null throw new IllegalStateException No such build id number Executor exec b getExecutor if exec null throw new IllegalStateException b getFullDisplayName is not building Node node exec getOwner getNode if node null throw new IllegalStateException The node exec getOwner getDisplayName has been deleted t t translate node EnvVars getRemote checkChannel new StreamTaskListener stderr stdout println t getHome return 0 private static final class BuildIDs extends MasterToSlaveCallable BuildIDs IOException String job number id public BuildIDs call throws IOException job System getenv JOB NAME number System getenv BUILD NUMBER id System getenv BUILD ID return this boolean isComplete return job null number null id null private static final long serialVersionUID 1Lpackage hudson init impl import hudson init Initializer import jenkins model Jenkins import org kohsuke stapler WebApp import org kohsuke stapler compression CompressionFilter import org kohsuke stapler compression UncaughtExceptionHandler import javax servlet ServletContext import javax servlet ServletException import javax servlet http HttpServletRequest import javax servlet http HttpServletResponse import java io IOException import java util logging Level import java util logging Logger import org kohsuke stapler Stapler public class InstallUncaughtExceptionHandler Initializer public static void init final Jenkins j throws IOException CompressionFilter setUncaughtExceptionHandler j servletContext new UncaughtExceptionHandler Override public void reportException Throwable e ServletContext context HttpServletRequest req HttpServletResponse rsp throws ServletException IOException req setAttribute javax servlet error exception e try WebApp get j servletContext getSomeStapler invoke req rsp Jenkins getInstance oops catch ServletException IOException x if Stapler isSocketException x throw x try Thread setDefaultUncaughtExceptionHandler new DefaultUncaughtExceptionHandler DefaultUncaughtExceptionHandler LOGGER log Level FINE Successfully installed a global UncaughtExceptionHandler catch SecurityException ex DefaultUncaughtExceptionHandler LOGGER log Level SEVERE Failed to set the default UncaughtExceptionHandler If any threads die due to unhandled coding errors then there will be no logging of this information The lack of this diagnostic information will make it harder to track down issues which will reduce the supportability of Jenkins It is highly recomended that you consult the documentation that comes with you servlet container on how to allow the setDefaultUncaughtExceptionHandler permission and enable it ex private static class DefaultUncaughtExceptionHandler implements Thread UncaughtExceptionHandler private static final Logger LOGGER Logger getLogger InstallUncaughtExceptionHandler class getName Override public void uncaughtException Thread t Throwable ex if this was an OutOfMemoryError then all bets about logging are off but in the absence of anything else LOGGER log Level SEVERE A thread t getName t getId died unexpectedly due to an uncaught exception this may leave your Jenkins in a bad way and is usually indicative of a bug in the code expackage jenkins install import static java util logging Level SEVERE import static java util logging Level WARNING import java io File import java io IOException import java util ArrayList import java util HashMap import java util Iterator import java util List import java util Map import java util logging Logger import javax annotation CheckForNull import javax annotation Nonnull import javax inject Provider import org apache commons io FileUtils import org apache commons lang StringUtils import org kohsuke accmod Restricted import org kohsuke accmod restrictions NoExternalUse import com google common base Function import com thoughtworks xstream XStream import hudson Functions import hudson Main import hudson model UpdateCenter DownloadJob InstallationStatus import hudson model UpdateCenter DownloadJob Installing import hudson model UpdateCenter InstallationJob import hudson model UpdateCenter UpdateCenterJob import hudson util VersionNumber import jenkins model Jenkins import jenkins util SystemProperties import jenkins util xml XMLUtils Restricted NoExternalUse class public class InstallUtil private static final Logger LOGGER Logger getLogger InstallUtil class getName tests need this to be 1 0 private static final VersionNumber NEW INSTALL VERSION new VersionNumber 1 0 private static final VersionNumber FORCE NEW INSTALL VERSION new VersionNumber 0 0 private static class ProviderChain T implements Provider T private final Iterator Function Provider T T functions public ProviderChain Iterator Function Provider T T functions this functions functions Override public T get return functions next apply this public static void proceedToNextStateFrom InstallState prior InstallState next getNextInstallState prior if Main isDevelopmentMode LOGGER info Install state tranisitioning from prior to next if next null Jenkins getInstance setInstallState next static InstallState getNextInstallState final InstallState current List Function Provider InstallState InstallState installStateFilterChain new ArrayList for final InstallStateFilter setupExtension InstallStateFilter all installStateFilterChain add new Function Provider InstallState InstallState Override public InstallState apply Provider InstallState next return setupExtension getNextInstallState current next Terminal condition getNextState on the current install state installStateFilterChain add new Function Provider InstallState InstallState Override public InstallState apply Provider InstallState input Initially install state is unknown and needs to be determined if current null InstallState UNKNOWN equals current return getDefaultInstallState final Map InstallState InstallState states new HashMap InstallState InstallState states put InstallState CREATE ADMIN USER InstallState INITIAL SETUP COMPLETED states put InstallState INITIAL PLUGINS INSTALLING InstallState CREATE ADMIN USER states put InstallState INITIAL SECURITY SETUP InstallState NEW states put InstallState RESTART InstallState RUNNING states put InstallState UPGRADE InstallState INITIAL SETUP COMPLETED states put InstallState DOWNGRADE InstallState INITIAL SETUP COMPLETED states put InstallState INITIAL SETUP COMPLETED InstallState RUNNING return states get current ProviderChain InstallState chain new ProviderChain installStateFilterChain iterator return chain get private static InstallState getDefaultInstallState Support a simple state override Useful for testing String stateOverride System getProperty jenkins install state System getenv jenkins install state if stateOverride null try return InstallState valueOf stateOverride toUpperCase catch RuntimeException e throw new IllegalStateException Unknown install state override specified on the commandline stateOverride Support a 3 state flag for running or disabling the setup wizard String shouldRunFlag SystemProperties getString jenkins install runSetupWizard boolean shouldRun true equalsIgnoreCase shouldRunFlag boolean shouldNotRun false equalsIgnoreCase shouldRunFlag install wizard will always run if environment specified if shouldRun if Functions getIsUnitTest return InstallState TEST if SystemProperties getBoolean hudson Main development return InstallState DEVELOPMENT VersionNumber lastRunVersion new VersionNumber getLastExecVersion Neither the top level config or the lastExecVersionFile have a version stored in them which means it s a new install if FORCE NEW INSTALL VERSION equals lastRunVersion lastRunVersion compareTo NEW INSTALL VERSION 0 Jenkins j Jenkins getInstance Allow for skipping if shouldNotRun try InstallState INITIAL SETUP COMPLETED initializeState return j getInstallState catch RuntimeException e throw e catch Exception e throw new RuntimeException e if FORCE NEW INSTALL VERSION equals lastRunVersion Edge case used Jenkins 1 but did not save the system config page the version is not persisted and returns 1 0 so try to check if they actually did anything if j getItemMap isEmpty j getNodes isEmpty return InstallState UPGRADE return InstallState INITIAL SECURITY SETUP We have a last version VersionNumber currentRunVersion new VersionNumber getCurrentExecVersion if lastRunVersion isOlderThan currentRunVersion return InstallState UPGRADE else if lastRunVersion isNewerThan currentRunVersion return InstallState DOWNGRADE else Last running version was the same as this running version return InstallState RESTART public static void saveLastExecVersion if Jenkins VERSION equals Jenkins UNCOMPUTED VERSION This should never happen Only adding this check in case someone moves the call to this method to the wrong place throw new IllegalStateException Unexpected call to InstallUtil saveLastExecVersion Jenkins VERSION has not been initialized Call computeVersion first saveLastExecVersion Jenkins VERSION public static Nonnull String getLastExecVersion File lastExecVersionFile getLastExecVersionFile if lastExecVersionFile exists try String version FileUtils readFileToString lastExecVersionFile JENKINS 37438 blank will force the setup wizard regardless of current state of the system if StringUtils isBlank version return FORCE NEW INSTALL VERSION toString return version catch IOException e LOGGER log SEVERE Unexpected Error Unable to read lastExecVersionFile getAbsolutePath e LOGGER log WARNING Unable to determine the last running version see error above Treating this as a restart No plugins will be updated return getCurrentExecVersion else Backward compatibility Use the last version stored in the top level config xml Going to read the value directly from the config xml file Vs hoping that the Jenkins startup sequence has moved far enough along that it has loaded the global config It can t load the global config until well into the startup sequence because the unmarshal requires numerous objects to be created e g it requires the Plugin Manager It happens too late and it s too risky to change how it currently works File configFile getConfigFile if configFile exists try String lastVersion XMLUtils getValue hudson version configFile if lastVersion length 0 return lastVersion catch Exception e LOGGER log SEVERE Unexpected error reading global config xml e return NEW INSTALL VERSION toString static void saveLastExecVersion Nonnull String version File lastExecVersionFile getLastExecVersionFile try FileUtils write lastExecVersionFile version catch IOException e LOGGER log SEVERE Failed to save lastExecVersionFile getAbsolutePath e static File getConfigFile return new File Jenkins getInstance getRootDir config xml static File getLastExecVersionFile return new File Jenkins getInstance getRootDir jenkins install InstallUtil lastExecVersion static File getInstallingPluginsFile return new File Jenkins getInstance getRootDir jenkins install InstallUtil installingPlugins private static String getCurrentExecVersion if Jenkins VERSION equals Jenkins UNCOMPUTED VERSION This should never happen Only adding this check in case someone moves the call to this method to the wrong place throw new IllegalStateException Unexpected call to InstallUtil getCurrentExecVersion Jenkins VERSION has not been initialized Call computeVersion first return Jenkins VERSION SuppressWarnings unchecked public static synchronized CheckForNull Map String String getPersistedInstallStatus File installingPluginsFile getInstallingPluginsFile if installingPluginsFile null installingPluginsFile exists return null return Map String String new XStream fromXML installingPluginsFile public static synchronized void persistInstallStatus List UpdateCenterJob installingPlugins File installingPluginsFile getInstallingPluginsFile if installingPlugins null installingPlugins isEmpty installingPluginsFile delete return LOGGER fine Writing install state to installingPluginsFile getAbsolutePath Map String String statuses new HashMap String String for UpdateCenterJob j installingPlugins if j instanceof InstallationJob j getCorrelationId null only include install jobs with a correlation id directly selected InstallationJob ij InstallationJob j InstallationStatus status ij status String statusText status getType if status instanceof Installing flag currently installing plugins as pending statusText Pending statuses put ij plugin name statusText try String installingPluginXml new XStream toXML statuses FileUtils write installingPluginsFile installingPluginXml catch IOException e LOGGER log SEVERE Failed to save installingPluginsFile getAbsolutePath e public static void clearInstallStatus persistInstallStatus nullpackage jenkins model identity import hudson ExtensionList import hudson ExtensionPoint import java security KeyPair import java security PrivateKey import java security PublicKey import java security cert X509Certificate import java security interfaces DSAPrivateKey import java security interfaces DSAPublicKey import java security interfaces ECPrivateKey import java security interfaces ECPublicKey import java security interfaces RSAPrivateKey import java security interfaces RSAPublicKey import java util logging Level import java util logging Logger import javax annotation CheckForNull import javax annotation Nonnull public abstract class InstanceIdentityProvider PUB extends PublicKey PRIV extends PrivateKey implements ExtensionPoint private static final Logger LOGGER Logger getLogger InstanceIdentityProvider class getName public static final KeyTypes RSAPublicKey RSAPrivateKey RSA new KeyTypes RSAPublicKey class RSAPrivateKey class public static final KeyTypes DSAPublicKey DSAPrivateKey DSA new KeyTypes DSAPublicKey class DSAPrivateKey class public static final KeyTypes ECPublicKey ECPrivateKey EC new KeyTypes ECPublicKey class ECPrivateKey class CheckForNull protected abstract KeyPair getKeyPair SuppressWarnings unchecked CheckForNull protected PUB getPublicKey KeyPair keyPair getKeyPair return keyPair null null PUB keyPair getPublic SuppressWarnings unchecked CheckForNull protected PRIV getPrivateKey KeyPair keyPair getKeyPair return keyPair null null PRIV keyPair getPrivate CheckForNull protected abstract X509Certificate getCertificate public static final class KeyTypes PUB extends PublicKey PRIV extends PrivateKey private final Class PUB pubKeyType private final Class PRIV privKeyType private KeyTypes Class PUB pubKeyType Class PRIV privKeyType this pubKeyType pubKeyType this privKeyType privKeyType CheckForNull SuppressWarnings unchecked private static PUB extends PublicKey PRIV extends PrivateKey InstanceIdentityProvider PUB PRIV get Nonnull KeyTypes PUB PRIV type for InstanceIdentityProvider provider ExtensionList lookup InstanceIdentityProvider class try KeyPair keyPair provider getKeyPair if keyPair null type pubKeyType isInstance keyPair getPublic type privKeyType isInstance keyPair getPrivate return InstanceIdentityProvider PUB PRIV provider catch RuntimeException e LOGGER log Level WARNING Instance identity provider provider propagated a runtime exception e catch Error e LOGGER log Level INFO Encountered an error while consulting instance identity provider provider e throw e catch Throwable e LOGGER log Level SEVERE Instance identity provider provider propagated an uncaught exception e return null public Class PUB getPublicKeyClass return pubKeyType public Class PRIV getPrivateKeyClass return privKeyType CheckForNull public KeyPair getKeyPair InstanceIdentityProvider PUB PRIV provider get this try return provider null null provider getKeyPair catch RuntimeException e LOGGER log Level WARNING Instance identity provider provider propagated a runtime exception e return null catch Error e LOGGER log Level INFO Encountered an error while consulting instance identity provider provider e throw e catch Throwable e LOGGER log Level SEVERE Instance identity provider provider propagated an uncaught exception e return null CheckForNull public PUB getPublicKey InstanceIdentityProvider PUB PRIV provider get this try return provider null null provider getPublicKey catch RuntimeException e LOGGER log Level WARNING Instance identity provider provider propagated a runtime exception e return null catch Error e LOGGER log Level INFO Encountered an error while consulting instance identity provider provider e throw e catch Throwable e LOGGER log Level SEVERE Instance identity provider provider propagated an uncaught exception e return null CheckForNull public PRIV getPrivateKey InstanceIdentityProvider PUB PRIV provider get this try return provider null null provider getPrivateKey catch RuntimeException e LOGGER log Level WARNING Instance identity provider provider propagated a runtime exception e return null catch Error e LOGGER log Level INFO Encountered an error while consulting instance identity provider provider e throw e catch Throwable e LOGGER log Level SEVERE Instance identity provider provider propagated an uncaught exception e return null CheckForNull public X509Certificate getCertificate InstanceIdentityProvider PUB PRIV provider get this try return provider null null provider getCertificate catch RuntimeException e LOGGER log Level WARNING Instance identity provider provider propagated a runtime exception e return null catch Error e LOGGER log Level INFO Encountered an error while consulting instance identity provider provider e throw e catch Throwable e LOGGER log Level SEVERE Instance identity provider provider propagated an uncaught exception e return nullpackage hudson util import org kohsuke accmod Restricted import org kohsuke accmod restrictions NoExternalUse public class InsufficientPermissionDetected extends BootFailure Restricted NoExternalUse class Deprecated public final SecurityException exception public InsufficientPermissionDetected SecurityException e super e this exception epackage com twitter sdk android core import android content Context import android content Intent import android content pm PackageManager import android content pm ResolveInfo import java util List public class IntentUtils public static boolean isActivityAvailable Context context Intent intent final PackageManager packageManager context getPackageManager final List ResolveInfo activities packageManager queryIntentActivities intent 0 return activities isEmpty public static boolean safeStartActivity Context context Intent intent if isActivityAvailable context intent context startActivity intent return true return falsepackage com twitter sdk android core import android content Intent import io fabric sdk android FabricAndroidTestCase public class IntentUtilsTest extends FabricAndroidTestCase public void testIsActivityAvailable noActivitiesAvailable final Intent intent new Intent io fabric is awesome assertFalse IntentUtils isActivityAvailable getContext intent public void testIsActivityAvailable activitiesAvailable final Intent intent new Intent android provider Settings ACTION SETTINGS assertTrue IntentUtils isActivityAvailable getContext intent public void testSafeStartActivity final Intent intent new Intent io fabric is awesome assertFalse IntentUtils safeStartActivity getContext intentpackage jenkins util import com google common util concurrent ForwardingExecutorService import java util ArrayList import java util Collection import java util List import java util concurrent Callable import java util concurrent ExecutionException import java util concurrent ExecutorService import java util concurrent Future import java util concurrent TimeUnit import java util concurrent TimeoutException public abstract class InterceptingExecutorService extends ForwardingExecutorService private final ExecutorService base public InterceptingExecutorService ExecutorService base this base base protected abstract Runnable wrap Runnable r protected abstract V Callable V wrap Callable V r Override protected ExecutorService delegate return base Override public T Future T submit Callable T task return super submit wrap task Override public T Future T submit Runnable task T result return super submit wrap task result Override public Future submit Runnable task return super submit wrap task Override public T List Future T invokeAll Collection extends Callable T tasks throws InterruptedException return super invokeAll wrap tasks Override public T List Future T invokeAll Collection extends Callable T tasks long timeout TimeUnit unit throws InterruptedException return super invokeAll wrap tasks timeout unit Override public T T invokeAny Collection extends Callable T tasks throws InterruptedException ExecutionException return super invokeAny wrap tasks Override public T T invokeAny Collection extends Callable T tasks long timeout TimeUnit unit throws InterruptedException ExecutionException TimeoutException return super invokeAny wrap tasks timeout unit Override public void execute Runnable command super execute wrap command private T Collection Callable T wrap Collection extends Callable T callables List Callable T r new ArrayList Callable T for Callable T c callables r add wrap c return rpackage hudson util import java lang reflect Method import java lang reflect Proxy import java lang reflect InvocationHandler import java lang reflect InvocationTargetException public abstract class InterceptingProxy protected abstract Object call Object o Method m Object args throws Throwable public final T T wrap Class T type final T object return type cast Proxy newProxyInstance type getClassLoader new Class type new InvocationHandler public Object invoke Object proxy Method method Object args throws Throwable try return call object method args catch InvocationTargetException e throw e getTargetExceptionpackage jenkins model import com google common collect ImmutableList import hudson model InvisibleAction import hudson model Run import org kohsuke stapler export Exported import org kohsuke stapler export ExportedBean import java util Collection import java util List ExportedBean public class InterruptedBuildAction extends InvisibleAction private final List CauseOfInterruption causes public InterruptedBuildAction Collection extends CauseOfInterruption causes this causes ImmutableList CauseOfInterruption copyOf causes Exported public List CauseOfInterruption getCauses return causespackage com twitter sdk android tweetui internal util public class IntHashMap private Entry table private int count private int threshold private float loadFactor private static class Entry public final int hash SuppressWarnings unused public int key public Object value public Entry next protected Entry int hash int key Object value Entry next this hash hash this key key this value value this next next public IntHashMap this 20 0 75f public IntHashMap int initialCapacity this initialCapacity 0 75f public IntHashMap int initialCapacity float loadFactor super if initialCapacity 0 throw new IllegalArgumentException Illegal Capacity initialCapacity if loadFactor 0 throw new IllegalArgumentException Illegal Load loadFactor if initialCapacity 0 initialCapacity 1 this loadFactor loadFactor table new Entry initialCapacity threshold int initialCapacity loadFactor public int size return count public boolean isEmpty return count 0 public boolean contains Object value if value null throw new NullPointerException final Entry tab table for int i tab length i 0 for Entry e tab i e null e e next if e value equals value return true return false public boolean containsValue Object value return contains value public boolean containsKey int key final Entry tab table final int hash key final int index hash 0x7FFFFFFF tab length for Entry e tab index e null e e next if e hash hash return true return false public Object get int key final Entry tab table final int hash key final int index hash 0x7FFFFFFF tab length for Entry e tab index e null e e next if e hash hash return e value return null protected void rehash final int oldCapacity table length final Entry oldMap table final int newCapacity oldCapacity 2 1 final Entry newMap new Entry newCapacity threshold int newCapacity loadFactor table newMap for int i oldCapacity i 0 for Entry old oldMap i old null final Entry e old old old next final int index e hash 0x7FFFFFFF newCapacity e next newMap index newMap index e public Object put int key Object value Makes sure the key is not already in the hashtable Entry tab table final int hash key int index hash 0x7FFFFFFF tab length for Entry e tab index e null e e next if e hash hash final Object old e value e value value return old if count threshold Rehash the table if the threshold is exceeded rehash tab table index hash 0x7FFFFFFF tab length Creates the new entry final Entry e new Entry hash key value tab index tab index e count return null public Object remove int key final Entry tab table final int hash key final int index hash 0x7FFFFFFF tab length for Entry e tab index prev null e null prev e e e next if e hash hash if prev null prev next e next else tab index e next count final Object oldValue e value e value null return oldValue return null public synchronized void clear final Entry tab table for int index tab length index 0 tab index null count 0package hudson security import org acegisecurity Authentication import org acegisecurity context SecurityContext import org acegisecurity userdetails UserDetails import javax servlet http HttpSession import jenkins security NonSerializableSecurityContext Deprecated public interface InvalidatableUserDetails extends UserDetails boolean isInvalidpackage hudson model public abstract class InvisibleAction implements Action public final String getIconFileName return null public final String getDisplayName return null public final String getUrlName return nullpackage hudson util import java lang reflect Method import java lang reflect InvocationHandler public interface InvocationInterceptor Object invoke Object proxy Method method Object args InvocationHandler delegate throws Throwablepackage hudson util import java io IOException Deprecated public class IOException2 extends IOException public IOException2 Throwable cause super cause public IOException2 String s Throwable cause super s causepackage jenkins slaves import hudson Extension import hudson init Terminator import hudson model Computer import java io IOException import java util logging Level import java util logging Logger import org jenkinsci remoting protocol IOHub Extension public class IOHubProvider private static final Logger LOGGER Logger getLogger IOHubProvider class getName private IOHub hub public IOHubProvider try hub IOHub create Computer threadPoolForRemoting catch IOException e LOGGER log Level SEVERE Failed to launch IOHub e this hub null public IOHub getHub return hub Terminator public void cleanUp throws IOException if hub null hub close hub nullpackage hudson util import hudson Functions import hudson os PosixAPI import hudson os PosixException import org apache commons io LineIterator import java io import java util Collection import java util List import java util regex Pattern public class IOUtils public static void drain InputStream in throws IOException org apache commons io IOUtils copy in new NullStream in close public static void copy File src OutputStream out throws IOException FileInputStream in new FileInputStream src try org apache commons io IOUtils copy in out finally org apache commons io IOUtils closeQuietly in public static void copy InputStream in File out throws IOException FileOutputStream fos new FileOutputStream out try org apache commons io IOUtils copy in fos finally org apache commons io IOUtils closeQuietly fos public static File mkdirs File dir throws IOException if dir mkdirs dir exists return dir following Ant mkdir task to avoid possible race condition try Thread sleep 10 catch InterruptedException e ignore if dir mkdirs dir exists return dir throw new IOException Failed to create a directory at dir public static InputStream skip InputStream in long size throws IOException DataInputStream di new DataInputStream in while size 0 int chunk int Math min SKIP BUFFER length size di readFully SKIP BUFFER 0 chunk size chunk return in public static File absolutize File base String path if isAbsolute path return new File path return new File base path public static boolean isAbsolute String path Pattern DRIVE PATTERN Pattern compile A Za z return path startsWith DRIVE PATTERN matcher path matches public static int mode File f throws PosixException if Functions isWindows return 1 return PosixAPI jnr stat f getPath mode public static String readFirstLine InputStream is String encoding throws IOException try BufferedReader reader new BufferedReader encoding null new InputStreamReader is new InputStreamReader is encoding return reader readLine Deprecated public static final char DIR SEPARATOR UNIX org apache commons io IOUtils DIR SEPARATOR UNIX Deprecated public static final char DIR SEPARATOR WINDOWS org apache commons io IOUtils DIR SEPARATOR WINDOWS Deprecated public static final char DIR SEPARATOR org apache commons io IOUtils DIR SEPARATOR Deprecated public static final String LINE SEPARATOR UNIX org apache commons io IOUtils LINE SEPARATOR UNIX Deprecated public static final String LINE SEPARATOR WINDOWS org apache commons io IOUtils LINE SEPARATOR WINDOWS Deprecated public static final String LINE SEPARATOR static avoid security issues StringWriter buf new StringWriter 4 PrintWriter out new PrintWriter buf out println LINE SEPARATOR buf toString Deprecated public static void closeQuietly Reader input org apache commons io IOUtils closeQuietly input Deprecated public static void closeQuietly Writer output org apache commons io IOUtils closeQuietly output Deprecated public static void closeQuietly InputStream input org apache commons io IOUtils closeQuietly input Deprecated public static void closeQuietly OutputStream output org apache commons io IOUtils closeQuietly output Deprecated public static byte toByteArray InputStream input throws IOException return org apache commons io IOUtils toByteArray input Deprecated public static byte toByteArray Reader input throws IOException return org apache commons io IOUtils toByteArray input Deprecated public static byte toByteArray Reader input String encoding throws IOException return org apache commons io IOUtils toByteArray input encoding Deprecated public static byte toByteArray String input throws IOException return org apache commons io IOUtils toByteArray input Deprecated public static char toCharArray InputStream is throws IOException return org apache commons io IOUtils toCharArray is Deprecated public static char toCharArray InputStream is String encoding throws IOException return org apache commons io IOUtils toCharArray is encoding Deprecated public static char toCharArray Reader input throws IOException return org apache commons io IOUtils toCharArray input Deprecated public static String toString InputStream input throws IOException return org apache commons io IOUtils toString input Deprecated public static String toString InputStream input String encoding throws IOException return org apache commons io IOUtils toString input encoding Deprecated public static String toString Reader input throws IOException return org apache commons io IOUtils toString input Deprecated public static String toString byte input throws IOException return org apache commons io IOUtils toString input Deprecated public static String toString byte input String encoding throws IOException return org apache commons io IOUtils toString input encoding Deprecated public static List readLines InputStream input throws IOException return org apache commons io IOUtils readLines input Deprecated public static List readLines InputStream input String encoding throws IOException return org apache commons io IOUtils readLines input encoding Deprecated public static List readLines Reader input throws IOException return org apache commons io IOUtils readLines input Deprecated public static LineIterator lineIterator Reader reader return org apache commons io IOUtils lineIterator reader Deprecated public static LineIterator lineIterator InputStream input String encoding throws IOException return org apache commons io IOUtils lineIterator input encoding Deprecated public static InputStream toInputStream String input return org apache commons io IOUtils toInputStream input Deprecated public static InputStream toInputStream String input String encoding throws IOException return org apache commons io IOUtils toInputStream input encoding Deprecated public static void write byte data OutputStream output throws IOException org apache commons io IOUtils write data output Deprecated public static void write byte data Writer output throws IOException org apache commons io IOUtils write data output Deprecated public static void write byte data Writer output String encoding throws IOException org apache commons io IOUtils write data output encoding Deprecated public static void write char data Writer output throws IOException org apache commons io IOUtils write data output Deprecated public static void write char data OutputStream output throws IOException org apache commons io IOUtils write data output Deprecated public static void write char data OutputStream output String encoding throws IOException org apache commons io IOUtils write data output encoding Deprecated public static void write String data Writer output throws IOException org apache commons io IOUtils write data output Deprecated public static void write String data OutputStream output throws IOException org apache commons io IOUtils write data output Deprecated public static void write String data OutputStream output String encoding throws IOException org apache commons io IOUtils write data output encoding Deprecated public static void write StringBuffer data Writer output throws IOException org apache commons io IOUtils write data output Deprecated public static void write StringBuffer data OutputStream output throws IOException org apache commons io IOUtils write data output Deprecated public static void write StringBuffer data OutputStream output String encoding throws IOException org apache commons io IOUtils write data output encoding Deprecated public static void writeLines Collection lines String lineEnding OutputStream output throws IOException org apache commons io IOUtils writeLines lines lineEnding output Deprecated public static void writeLines Collection lines String lineEnding OutputStream output String encoding throws IOException org apache commons io IOUtils writeLines lines lineEnding output encoding Deprecated public static void writeLines Collection lines String lineEnding Writer writer throws IOException org apache commons io IOUtils writeLines lines lineEnding writer Deprecated public static int copy InputStream input OutputStream output throws IOException return org apache commons io IOUtils copy input output Deprecated public static long copyLarge InputStream input OutputStream output throws IOException return org apache commons io IOUtils copyLarge input output Deprecated public static void copy InputStream input Writer output throws IOException org apache commons io IOUtils copy input output Deprecated public static void copy InputStream input Writer output String encoding throws IOException org apache commons io IOUtils copy input output encoding Deprecated public static int copy Reader input Writer output throws IOException return org apache commons io IOUtils copy input output Deprecated public static long copyLarge Reader input Writer output throws IOException return org apache commons io IOUtils copyLarge input output Deprecated public static void copy Reader input OutputStream output throws IOException org apache commons io IOUtils copy input output Deprecated public static void copy Reader input OutputStream output String encoding throws IOException org apache commons io IOUtils copy input output encoding Deprecated public static boolean contentEquals InputStream input1 InputStream input2 throws IOException return org apache commons io IOUtils contentEquals input1 input2 Deprecated public static boolean contentEquals Reader input1 Reader input2 throws IOException return org apache commons io IOUtils contentEquals input1 input2 private static final byte SKIP BUFFER new byte 8192package hudson model import hudson Functions import jenkins util SystemProperties import hudson security PermissionScope import jenkins util io OnMaster import org kohsuke stapler StaplerRequest import java io IOException import java util Collection import hudson search SearchableModelObject import hudson security Permission import hudson security PermissionGroup import hudson security AccessControlled import hudson util Secret public interface Item extends PersistenceRoot SearchableModelObject AccessControlled OnMaster ItemGroup extends Item getParent Collection extends Job getAllJobs String getName String getFullName String getDisplayName String getFullDisplayName String getRelativeNameFrom ItemGroup g String getRelativeNameFrom Item item String getUrl String getShortUrl Deprecated String getAbsoluteUrl void onLoad ItemGroup extends Item parent String name throws IOException void onCopiedFrom Item src void onCreatedFromScratch void save throws IOException void delete throws IOException InterruptedException PermissionGroup PERMISSIONS new PermissionGroup Item class Messages Item Permissions Title Permission CREATE new Permission PERMISSIONS Create Messages Item CREATE description Permission CREATE PermissionScope ITEM GROUP Permission DELETE new Permission PERMISSIONS Delete Messages Item DELETE description Permission DELETE PermissionScope ITEM Permission CONFIGURE new Permission PERMISSIONS Configure Messages Item CONFIGURE description Permission CONFIGURE PermissionScope ITEM Permission READ new Permission PERMISSIONS Read Messages Item READ description Permission READ PermissionScope ITEM Permission DISCOVER new Permission PERMISSIONS Discover Messages AbstractProject DiscoverPermission Description READ PermissionScope ITEM Permission EXTENDED READ new Permission PERMISSIONS ExtendedRead Messages AbstractProject ExtendedReadPermission Description CONFIGURE SystemProperties getBoolean hudson security ExtendedReadPermission new PermissionScope PermissionScope ITEM TODO the following really belong in Job not Item but too late to move since the owner name is encoded in the ID Permission BUILD new Permission PERMISSIONS Build Messages AbstractProject BuildPermission Description Permission UPDATE PermissionScope ITEM Permission WORKSPACE new Permission PERMISSIONS Workspace Messages AbstractProject WorkspacePermission Description Permission READ PermissionScope ITEM Permission WIPEOUT new Permission PERMISSIONS WipeOut Messages AbstractProject WipeOutPermission Description null Functions isWipeOutPermissionEnabled new PermissionScope PermissionScope ITEM Permission CANCEL new Permission PERMISSIONS Cancel Messages AbstractProject CancelPermission Description BUILD PermissionScope ITEMpackage jenkins model item category import hudson Extension import hudson ExtensionList import hudson ExtensionPoint import hudson model TopLevelItemDescriptor import javax annotation Nonnull import org kohsuke accmod Restricted import org kohsuke accmod restrictions NoExternalUse public abstract class ItemCategory implements ExtensionPoint Restricted NoExternalUse class public static int MIN TOSHOW 1 private int order 1 public abstract String getId public abstract String getDescription public abstract String getDisplayName public abstract int getMinToShow private void setOrder int order this order order public int getOrder return order Nonnull public static ItemCategory getCategory TopLevelItemDescriptor descriptor int order 0 ExtensionList ItemCategory categories ExtensionList lookup ItemCategory class for ItemCategory category categories if category getId equals descriptor getCategoryId category setOrder order return category order return new UncategorizedCategory Extension ordinal Integer MIN VALUE public static final class UncategorizedCategory extends ItemCategory public static final String ID uncategorized Override public String getId return ID Override public String getDescription return Messages Uncategorized Description Override public String getDisplayName return Messages Uncategorized DisplayName Override public int getMinToShow return ItemCategory MIN TOSHOWpackage com kaku colorfulnews widget import android support v7 widget GridLayoutManager import android support v7 widget RecyclerView import android support v7 widget StaggeredGridLayoutManager import android support v7 widget helper ItemTouchHelper public class ItemDragHelperCallback extends ItemTouchHelper Callback private OnItemMoveListener mOnItemMoveListener private boolean mIsLongPressEnabled public void setLongPressEnabled boolean longPressEnabled mIsLongPressEnabled longPressEnabled public interface OnItemMoveListener boolean onItemMove int fromPosition int toPosition public ItemDragHelperCallback OnItemMoveListener onItemMoveListener mOnItemMoveListener onItemMoveListener Override public boolean isLongPressDragEnabled return mIsLongPressEnabled Override public int getMovementFlags RecyclerView recyclerView RecyclerView ViewHolder viewHolder int dragFlags setDragFlags recyclerView int swipeFlags 0 return makeMovementFlags dragFlags swipeFlags private int setDragFlags RecyclerView recyclerView int dragFlags RecyclerView LayoutManager layoutManager recyclerView getLayoutManager if layoutManager instanceof GridLayoutManager layoutManager instanceof StaggeredGridLayoutManager dragFlags ItemTouchHelper UP ItemTouchHelper DOWN ItemTouchHelper LEFT ItemTouchHelper RIGHT else dragFlags ItemTouchHelper UP ItemTouchHelper DOWN return dragFlags Override public boolean onMove RecyclerView recyclerView RecyclerView ViewHolder viewHolder RecyclerView ViewHolder target return isDifferentItemViewType viewHolder target mOnItemMoveListener onItemMove viewHolder getAdapterPosition target getAdapterPosition private boolean isDifferentItemViewType RecyclerView ViewHolder viewHolder RecyclerView ViewHolder target return viewHolder getItemViewType target getItemViewType Override public void clearView RecyclerView recyclerView RecyclerView ViewHolder viewHolder super clearView recyclerView viewHolder Override public void onSwiped RecyclerView ViewHolder viewHolder int directionpackage hudson model import java io IOException import java util Collection import java io File import javax annotation CheckForNull import org acegisecurity AccessDeniedException public interface ItemGroup T extends Item extends PersistenceRoot ModelObject String getFullName String getFullDisplayName Collection T getItems String getUrl String getUrlChildPrefix CheckForNull T getItem String name throws AccessDeniedException File getRootDirFor T child void onRenamed T item String oldName String newName throws IOException void onDeleted T item throws IOExceptionpackage hudson model import hudson Util import hudson XmlFile import hudson model listeners ItemListener import hudson security AccessControlled import hudson util CopyOnWriteMap import hudson util Function1 import hudson util Secret import jenkins model Jenkins import jenkins util xml XMLUtils import org kohsuke stapler StaplerRequest import org kohsuke stapler StaplerResponse import javax servlet ServletException import javax servlet http HttpServletResponse import javax xml transform Source import javax xml transform TransformerException import javax xml transform stream StreamResult import javax xml transform stream StreamSource import java io File import java io FileFilter import java io IOException import java io InputStream import java util Map import java util logging Level import java util logging Logger import java util regex Matcher import jenkins security NotReallyRoleSensitiveCallable import org acegisecurity AccessDeniedException import org xml sax SAXException public abstract class ItemGroupMixIn private final ItemGroup parent private final AccessControlled acl protected ItemGroupMixIn ItemGroup parent AccessControlled acl this parent parent this acl acl protected abstract void add TopLevelItem item protected abstract File getRootDirFor String name public static K V extends Item Map K V loadChildren ItemGroup parent File modulesDir Function1 extends K super V key modulesDir mkdirs make sure it exists File subdirs modulesDir listFiles new FileFilter public boolean accept File child return child isDirectory CopyOnWriteMap Tree K V configurations new CopyOnWriteMap Tree K V for File subdir subdirs try Try to retain the identity of an existing child object if we can V item V parent getItem subdir getName if item null XmlFile xmlFile Items getConfigFile subdir if xmlFile exists item V Items load parent subdir else Logger getLogger ItemGroupMixIn class getName log Level WARNING could not find file xmlFile getFile continue else item onLoad parent subdir getName configurations put key call item item catch Exception e Logger getLogger ItemGroupMixIn class getName log Level WARNING could not load subdir e return configurations public static final Function1 String Item KEYED BY NAME new Function1 String Item public String call Item item return item getName public synchronized TopLevelItem createTopLevelItem StaplerRequest req StaplerResponse rsp throws IOException ServletException acl checkPermission Item CREATE TopLevelItem result String requestContentType req getContentType String mode req getParameter mode if requestContentType null mode null mode equals copy throw new Failure No Content Type header set boolean isXmlSubmission requestContentType null requestContentType startsWith application xml requestContentType startsWith text xml String name req getParameter name if name null throw new Failure Query parameter name is required check if the name looks good Jenkins checkGoodName name name name trim if parent getItem name null throw new Failure Messages Hudson JobAlreadyExists name if mode null mode equals copy String from req getParameter from resolve a name to Item Item src Jenkins getInstance getItem from parent if src null if Util fixEmpty from null throw new Failure Specify which job to copy else throw new Failure No such job from if src instanceof TopLevelItem throw new Failure from cannot be copied result copy TopLevelItem src name else if isXmlSubmission result createProjectFromXML name req getInputStream rsp setStatus HttpServletResponse SC OK return result else if mode null throw new Failure No mode given TopLevelItemDescriptor descriptor Items all findByName mode if descriptor null throw new Failure No item type mode is known descriptor checkApplicableIn parent acl getACL checkCreatePermission parent descriptor create empty job and redirect to the project config screen result createProject descriptor name true rsp sendRedirect2 redirectAfterCreateItem req result return result protected String redirectAfterCreateItem StaplerRequest req TopLevelItem result throws IOException return req getContextPath result getUrl configure SuppressWarnings unchecked public synchronized T extends TopLevelItem T copy T src String name throws IOException acl checkPermission Item CREATE src checkPermission Item EXTENDED READ XmlFile srcConfigFile Items getConfigFile src if src hasPermission Item CONFIGURE Matcher matcher AbstractItem SECRET PATTERN matcher srcConfigFile asString while matcher find if Secret decrypt matcher group 1 null AccessDeniedException2 does not permit a custom message and anyway redirecting the user to the login screen is obviously pointless throw new AccessDeniedException Messages ItemGroupMixIn may not copy as it contains secrets and src getFullName Jenkins getAuthentication getName Item PERMISSIONS title Item EXTENDED READ name Item CONFIGURE name src getDescriptor checkApplicableIn parent acl getACL checkCreatePermission parent src getDescriptor T result T createProject src getDescriptor name false copy config Util copyFile srcConfigFile getFile Items getConfigFile result getFile reload from the new config final File rootDir result getRootDir result Items whileUpdatingByXml new NotReallyRoleSensitiveCallable T IOException Override public T call throws IOException return T Items load parent rootDir result onCopiedFrom src add result ItemListener fireOnCopied src result Jenkins getInstance rebuildDependencyGraphAsync return result public synchronized TopLevelItem createProjectFromXML String name InputStream xml throws IOException acl checkPermission Item CREATE Jenkins getInstance getProjectNamingStrategy checkName name if parent getItem name null throw new IllegalArgumentException parent getDisplayName already contains an item name TODO what if we have no DISCOVER permission on the existing job place it as config xml File configXml Items getConfigFile getRootDirFor name getFile final File dir configXml getParentFile dir mkdirs boolean success false try XMLUtils safeTransform Source new StreamSource xml new StreamResult configXml load it TopLevelItem result Items whileUpdatingByXml new NotReallyRoleSensitiveCallable TopLevelItem IOException Override public TopLevelItem call throws IOException return TopLevelItem Items load parent dir success acl getACL hasCreatePermission Jenkins getAuthentication parent result getDescriptor result getDescriptor isApplicableIn parent add result ItemListener fireOnCreated result Jenkins getInstance rebuildDependencyGraphAsync return result catch TransformerException e success false throw new IOException Failed to persist config xml e catch SAXException e success false throw new IOException Failed to persist config xml e catch IOException e success false throw e catch RuntimeException e success false throw e finally if success if anything fails delete the config file to avoid further confusion Util deleteRecursive dir public synchronized TopLevelItem createProject TopLevelItemDescriptor type String name boolean notify throws IOException acl checkPermission Item CREATE type checkApplicableIn parent acl getACL checkCreatePermission parent type Jenkins getInstance getProjectNamingStrategy checkName name if parent getItem name null throw new IllegalArgumentException Project of the name name already exists TODO problem with DISCOVER as noted above TopLevelItem item type newInstance parent name try callOnCreatedFromScratch item catch AbstractMethodError e ignore this error Must be older plugin that doesn t have this method item save add item Jenkins getInstance rebuildDependencyGraphAsync if notify ItemListener fireOnCreated item return item private void callOnCreatedFromScratch TopLevelItem item item onCreatedFromScratchpackage hudson model listeners import com google common base Function import hudson ExtensionPoint import hudson ExtensionList import hudson Extension import hudson model Item import hudson model ItemGroup import hudson model Items import hudson security ACL import java util List import java util logging Level import java util logging Logger import jenkins security NotReallyRoleSensitiveCallable public class ItemListener implements ExtensionPoint private static final Logger LOGGER Logger getLogger ItemListener class getName public void onCreated Item item public void onCopied Item src Item item onCreated item public void onLoaded public void onDeleted Item item public void onRenamed Item item String oldName String newName public void onLocationChanged Item item String oldFullName String newFullName public void onUpdated Item item public void onBeforeShutdown Deprecated public void register all add this public static ExtensionList ItemListener all return ExtensionList lookup ItemListener class TODO JENKINS 21224 generalize this to a method perhaps in ExtensionList and use consistently from all listeners private static void forAll final Function ItemListener Void consumer for ItemListener l all try consumer apply l catch RuntimeException x LOGGER log Level WARNING failed to send event to listener of l getClass x public static void fireOnCopied final Item src final Item result forAll new Function ItemListener Void Override public Void apply ItemListener l l onCopied src result return null public static void fireOnCreated final Item item forAll new Function ItemListener Void Override public Void apply ItemListener l l onCreated item return null public static void fireOnUpdated final Item item forAll new Function ItemListener Void Override public Void apply ItemListener l l onUpdated item return null public static void fireOnDeleted final Item item forAll new Function ItemListener Void Override public Void apply ItemListener l l onDeleted item return null public static void fireLocationChange final Item rootItem final String oldFullName String prefix rootItem getParent getFullName if prefix isEmpty prefix final String newFullName rootItem getFullName assert newFullName startsWith prefix int prefixS prefix length if oldFullName startsWith prefix oldFullName indexOf prefixS 1 final String oldName oldFullName substring prefixS final String newName rootItem getName assert newName equals newFullName substring prefixS forAll new Function ItemListener Void Override public Void apply ItemListener l l onRenamed rootItem oldName newName return null forAll new Function ItemListener Void Override public Void apply ItemListener l l onLocationChanged rootItem oldFullName newFullName return null if rootItem instanceof ItemGroup for final Item child ACL impersonate ACL SYSTEM new NotReallyRoleSensitiveCallable List Item RuntimeException Override public List Item call return Items getAllItems ItemGroup rootItem Item class final String childNew child getFullName assert childNew startsWith newFullName assert childNew charAt newFullName length final String childOld oldFullName childNew substring newFullName length forAll new Function ItemListener Void Override public Void apply ItemListener l l onLocationChanged child childOld childNew return nullpackage hudson model import com thoughtworks xstream XStream import hudson DescriptorExtensionList import hudson Extension import hudson XmlFile import hudson model listeners ItemListener import hudson remoting Callable import hudson security ACL import hudson security AccessControlled import hudson triggers Trigger import hudson util DescriptorList import hudson util EditDistance import hudson util XStream2 import jenkins model Jenkins import org acegisecurity Authentication import org apache commons lang StringUtils import java io File import java io IOException import java util ArrayList import java util Collection import java util Collections import java util Comparator import java util List import java util Stack import java util StringTokenizer import javax annotation CheckForNull import javax annotation Nonnull import jenkins model DirectlyModifiableTopLevelItemGroup import org apache commons io FileUtils public class Items Deprecated public static final List TopLevelItemDescriptor LIST List new DescriptorList TopLevelItem TopLevelItem class private static final ThreadLocal Boolean updatingByXml new ThreadLocal Boolean Override protected Boolean initialValue return false public static V T extends Throwable V whileUpdatingByXml Callable V T callable throws T updatingByXml set true try return callable call finally updatingByXml set false public static boolean currentlyUpdatingByXml return updatingByXml get public static DescriptorExtensionList TopLevelItem TopLevelItemDescriptor all return Jenkins getInstance TopLevelItem TopLevelItemDescriptor getDescriptorList TopLevelItem class public static List TopLevelItemDescriptor all ItemGroup c return all Jenkins getAuthentication c public static List TopLevelItemDescriptor all Authentication a ItemGroup c List TopLevelItemDescriptor result new ArrayList TopLevelItemDescriptor ACL acl if c instanceof AccessControlled acl AccessControlled c getACL else fall back to root acl Jenkins getInstance getACL for TopLevelItemDescriptor d all if acl hasCreatePermission a c d d isApplicableIn c result add d return result public static TopLevelItemDescriptor getDescriptor String fqcn return Descriptor find all fqcn public static String toNameList Collection extends Item items StringBuilder buf new StringBuilder for Item item items if buf length 0 buf append buf append item getFullName return buf toString Deprecated public static T extends Item List T fromNameList String list Class T type return fromNameList null list type public static T extends Item List T fromNameList ItemGroup context Nonnull String list Nonnull Class T type final Jenkins jenkins Jenkins getInstance List T r new ArrayList T if jenkins null return r StringTokenizer tokens new StringTokenizer list while tokens hasMoreTokens String fullName tokens nextToken trim if StringUtils isNotEmpty fullName T item jenkins getItem fullName context type if item null r add item return r public static String getCanonicalName ItemGroup context String path String c context getFullName split String p path split Stack String name new Stack String for int i 0 i c length i if i 0 c i equals continue name push c i for int i 0 i p length i if i 0 p i equals Absolute path starting with a name clear continue if p i equals if name size 0 throw new IllegalArgumentException String format Illegal relative path s within context s path context getFullName name pop continue if p i equals continue name push p i return StringUtils join name public static String computeRelativeNamesAfterRenaming String oldFullName String newFullName String relativeNames ItemGroup context StringTokenizer tokens new StringTokenizer relativeNames List String newValue new ArrayList String while tokens hasMoreTokens String relativeName tokens nextToken trim String canonicalName getCanonicalName context relativeName if canonicalName equals oldFullName canonicalName startsWith oldFullName String newCanonicalName newFullName canonicalName substring oldFullName length if relativeName startsWith newValue add newCanonicalName else newValue add getRelativeNameFrom newCanonicalName context getFullName else newValue add relativeName return StringUtils join newValue Had difficulty adapting the version in Functions to use no live items so rewrote it static String getRelativeNameFrom String itemFullName String groupFullName String itemFullNameA itemFullName isEmpty new String 0 itemFullName split String groupFullNameA groupFullName isEmpty new String 0 groupFullName split for int i 0 i if i itemFullNameA length if i groupFullNameA length itemFullName and groupFullName are identical return else itemFullName is an ancestor of groupFullName insert for rest of groupFullName StringBuilder b new StringBuilder for int j 0 j groupFullNameA length itemFullNameA length j if j 0 b append b append return b toString else if i groupFullNameA length groupFullName is an ancestor of itemFullName insert rest of itemFullName StringBuilder b new StringBuilder for int j i j itemFullNameA length j if j i b append b append itemFullNameA j return b toString else if itemFullNameA i equals groupFullNameA i identical up to this point continue else first mismatch insert for rest of groupFullName then rest of itemFullName StringBuilder b new StringBuilder for int j i j groupFullNameA length j if j i b append b append for int j i j itemFullNameA length j b append append itemFullNameA j return b toString public static Item load ItemGroup parent File dir throws IOException Item item Item getConfigFile dir read item onLoad parent dir getName return item public static XmlFile getConfigFile File dir return new XmlFile XSTREAM new File dir config xml public static XmlFile getConfigFile Item item return getConfigFile item getRootDir public static T extends Item List T getAllItems final ItemGroup root Class T type List T r new ArrayList T getAllItems root type r return r private static T extends Item void getAllItems final ItemGroup root Class T type List T r List Item items new ArrayList Item ItemGroup root getItems Collections sort items new Comparator Item Override public int compare Item i1 Item i2 return name i1 compareToIgnoreCase name i2 String name Item i String n i getName if i instanceof ItemGroup n return n for Item i items if type isInstance i if i hasPermission Item READ r add type cast i if i instanceof ItemGroup getAllItems ItemGroup i type r public static CheckForNull T extends Item T findNearest Class T type String name ItemGroup context List T projects Jenkins getInstance getAllItems type String names new String projects size for int i 0 i projects size i names i projects get i getRelativeNameFrom context String nearest EditDistance findNearest name names return Jenkins getInstance getItem nearest context type public static I extends AbstractItem TopLevelItem I move I item DirectlyModifiableTopLevelItemGroup destination throws IOException IllegalArgumentException DirectlyModifiableTopLevelItemGroup oldParent DirectlyModifiableTopLevelItemGroup item getParent if oldParent destination throw new IllegalArgumentException TODO verify that destination is to not equal to or inside item if destination canAdd item throw new IllegalArgumentException String name item getName if destination getItem name null throw new IllegalArgumentException name already exists String oldFullName item getFullName TODO AbstractItem renameTo has a more baroque implementation factor it out into a utility method perhaps File destDir destination getRootDirFor item FileUtils forceMkdir destDir getParentFile FileUtils moveDirectory item getRootDir destDir oldParent remove item I newItem destination add item name item movedTo destination newItem destDir ItemListener fireLocationChange newItem oldFullName return newItem public static final XStream XSTREAM new XStream2 public static final XStream2 XSTREAM2 XStream2 XSTREAM static XSTREAM alias project FreeStyleProject classpackage hudson model import jenkins model Jenkins public abstract class ItemVisitor public void onItemGroup ItemGroup group for Item i group getItems if i hasPermission Item READ onItem i public void onItem Item i if i instanceof ItemGroup onItemGroup ItemGroup i public final void walk onItemGroup Jenkins getInstancepackage hudson util import com google common base Predicates import com google common collect ImmutableList import java util Collections import java util Iterator import java util List import java util NoSuchElementException import java util ListIterator import java util AbstractList import java util Arrays import java util Set import java util HashSet public class Iterators public static T Iterator T empty return Collections T emptyList iterator public static abstract class FlattenIterator U T implements Iterator U private final Iterator extends T core private Iterator U cur protected FlattenIterator Iterator extends T core this core core cur Collections U emptyList iterator protected FlattenIterator Iterable extends T core this core iterator protected abstract Iterator U expand T t public boolean hasNext while cur hasNext if core hasNext return false cur expand core next return true public U next if hasNext throw new NoSuchElementException return cur next public void remove throw new UnsupportedOperationException public static abstract class FilterIterator T implements Iterator T private final Iterator extends T core private T next private boolean fetched protected FilterIterator Iterator extends T core this core core protected FilterIterator Iterable extends T core this core iterator private void fetch while fetched core hasNext T n core next if filter n next n fetched true protected abstract boolean filter T t public boolean hasNext fetch return fetched public T next fetch if fetched throw new NoSuchElementException fetched false return next public void remove core remove public static final class DuplicateFilterIterator T extends FilterIterator T private final Set T seen new HashSet T public DuplicateFilterIterator Iterator extends T core super core public DuplicateFilterIterator Iterable extends T core super core protected boolean filter T t return seen add t public static T Iterable T reverse final List T lst return new Iterable T public Iterator T iterator final ListIterator T itr lst listIterator lst size return new Iterator T public boolean hasNext return itr hasPrevious public T next return itr previous public void remove itr remove public static T Iterable T wrap final Iterable T base return new Iterable T public Iterator T iterator final Iterator T itr base iterator return new Iterator T public boolean hasNext return itr hasNext public T next return itr next public void remove itr remove public static List Integer sequence final int start int end final int step final int size end start step if size 0 throw new IllegalArgumentException List size is negative return new AbstractList Integer public Integer get int index if index 0 index size throw new IndexOutOfBoundsException return start index step public int size return size public static List Integer sequence int start int end return sequence start end 1 public static List Integer reverseSequence int start int end int step return sequence end 1 start 1 step public static List Integer reverseSequence int start int end return reverseSequence start end 1 SuppressWarnings unchecked public static T Iterator T cast Iterator extends T itr return Iterator itr SuppressWarnings unchecked public static T Iterable T cast Iterable extends T itr return Iterable itr SuppressWarnings unchecked public static U T extends U Iterator T subType Iterator U itr final Class T type return Iterator new FilterIterator U itr protected boolean filter U u return type isInstance u public static T Iterator T readOnly final Iterator T itr return new Iterator T public boolean hasNext return itr hasNext public T next return itr next public void remove throw new UnsupportedOperationException public static T Iterator T removeNull final Iterator T itr return com google common collect Iterators filter itr Predicates notNull SafeVarargs public static T Iterable T sequence final Iterable extends T iterables return new Iterable T public Iterator T iterator return new FlattenIterator T Iterable extends T ImmutableList copyOf iterables protected Iterator T expand Iterable extends T iterable return Iterators T cast iterable iterator public static T Iterator T removeDups Iterator T iterator return new FilterIterator T iterator final Set T found new HashSet T Override protected boolean filter T t return found add t public static T Iterable T removeDups final Iterable T base return new Iterable T public Iterator T iterator return removeDups base iterator SafeVarargs public static T Iterator T sequence Iterator extends T iterators return com google common collect Iterators T concat iterators public static T Iterator T limit final Iterator extends T base final CountingPredicate super T filter return new Iterator T private T next private boolean end private int index 0 public boolean hasNext fetch return next null public T next fetch T r next next null return r private void fetch if next null end if base hasNext next base next if filter apply index next next null end true else end true public void remove throw new UnsupportedOperationException public interface CountingPredicate T boolean apply int index T inputpackage hudson model import hudson util StreamTaskListener import hudson util NullStream import hudson util FormValidation import hudson Launcher import hudson Extension import hudson EnvVars import hudson slaves NodeSpecific import hudson tools ToolInstallation import hudson tools ToolDescriptor import hudson tools ToolProperty import hudson tools JDKInstaller import hudson util XStream2 import java io File import java io IOException import java util Map import java util List import java util Arrays import java util Collections import jenkins model Jenkins import org jenkinsci Symbol import org kohsuke stapler DataBoundConstructor import org kohsuke accmod Restricted import org kohsuke accmod restrictions NoExternalUse public final class JDK extends ToolInstallation implements NodeSpecific JDK EnvironmentSpecific JDK public static final String DEFAULT NAME System Restricted NoExternalUse class public static boolean isDefaultName String name if Default equals name DEFAULT NAME took this value prior to 1 598 return true return DEFAULT NAME equals name name null Deprecated kept for backward compatibility use getHome instead private transient String javaHome public JDK String name String javaHome super name javaHome Collections ToolProperty emptyList DataBoundConstructor public JDK String name String home List extends ToolProperty properties super name home properties Deprecated public String getJavaHome return getHome public File getBinDir return new File getHome bin private File getExecutable String execName File separatorChar java exe java return new File getHome bin execName public boolean getExists return getExecutable exists Deprecated public void buildEnvVars Map String String env String home getHome if home null return see EnvVars javadoc for why this adds PATH env put PATH JDK home bin env put JAVA HOME home Override public void buildEnvVars EnvVars env buildEnvVars Map env public JDK forNode Node node TaskListener log throws IOException InterruptedException return new JDK getName translateFor node log public JDK forEnvironment EnvVars environment return new JDK getName environment expand getHome public static boolean isDefaultJDKValid Node n try TaskListener listener new StreamTaskListener new NullStream Launcher launcher n createLauncher listener return launcher launch cmds java fullversion stdout listener join 0 catch IOException e return false catch InterruptedException e return false Extension Symbol jdk public static class DescriptorImpl extends ToolDescriptor JDK public String getDisplayName return JDK TODO I18N public Override JDK getInstallations return Jenkins getInstance getJDKs toArray new JDK 0 public Override void setInstallations JDK jdks Jenkins getInstance setJDKs Arrays asList jdks Override public List JDKInstaller getDefaultInstallers return Collections singletonList new JDKInstaller null false Override protected FormValidation checkHomeDirectory File value File toolsJar new File value lib tools jar File mac new File value lib dt jar JENKINS 25601 JDK 9 no longer has tools jar Keep the existing dt jar tools jar checks to be safe File javac new File value bin javac File javacExe new File value bin javac exe if toolsJar exists mac exists javac exists javacExe exists return FormValidation error Messages Hudson NotJDKDir value return FormValidation ok public static class ConverterImpl extends ToolConverter public ConverterImpl XStream2 xstream super xstream Override protected String oldHomeField ToolInstallation obj return JDK obj javaHomepackage hudson tools import hudson AbortException import hudson Extension import hudson FilePath import hudson Launcher import hudson Launcher ProcStarter import hudson ProxyConfiguration import hudson Util import hudson model DownloadService Downloadable import hudson model JDK import hudson model Job import hudson model Node import hudson model TaskListener import hudson util ArgumentListBuilder import hudson util FormValidation import hudson util HttpResponses import hudson util Secret import jenkins model Jenkins import jenkins security MasterToSlaveCallable import net sf json JSONObject import net sf json JsonConfig import org apache commons httpclient Cookie import org apache commons httpclient HttpClient import org apache commons httpclient HttpMethodBase import org apache commons httpclient UsernamePasswordCredentials import org apache commons httpclient auth AuthScope import org apache commons httpclient methods GetMethod import org apache commons httpclient methods PostMethod import org apache commons httpclient protocol Protocol import org apache commons io IOUtils import org jenkinsci Symbol import org kohsuke stapler DataBoundConstructor import org kohsuke stapler HttpResponse import org kohsuke stapler QueryParameter import org kohsuke stapler Stapler import javax servlet ServletException import java io ByteArrayInputStream import java io DataInputStream import java io File import java io FileOutputStream import java io IOException import java io InputStream import java io InputStreamReader import java io OutputStreamWriter import java io PrintStream import java net URL import java util ArrayList import java util Arrays import java util Iterator import java util LinkedList import java util List import java util Locale import java util logging Logger import java util regex Matcher import java util regex Pattern import static hudson tools JDKInstaller Preference public class JDKInstaller extends ToolInstaller static this socket factory will not attempt to bind to the client interface Protocol registerProtocol http new Protocol http new hudson util NoClientBindProtocolSocketFactory 80 Protocol registerProtocol https new Protocol https new hudson util NoClientBindSSLProtocolSocketFactory 443 public final String id public final boolean acceptLicense DataBoundConstructor public JDKInstaller String id boolean acceptLicense super null this id id this acceptLicense acceptLicense public FilePath performInstallation ToolInstallation tool Node node TaskListener log throws IOException InterruptedException FilePath expectedLocation preferredLocation tool node PrintStream out log getLogger try if acceptLicense out println Messages JDKInstaller UnableToInstallUntilLicenseAccepted return expectedLocation already installed FilePath marker expectedLocation child installedByHudson if marker exists marker readToString equals id return expectedLocation expectedLocation deleteRecursive expectedLocation mkdirs Platform p Platform of node URL url locate log p CPU of node out println Downloading url FilePath file expectedLocation child p bundleFileName file copyFrom url JDK6u13 on Windows doesn t like path representation like tmp foo so make it a strict platform native format by doing absolutize install node createLauncher log p new FilePathFileSystem node log expectedLocation absolutize getRemote file getRemote successfully installed file delete marker write id null catch DetectionFailedException e out println JDK installation skipped e getMessage return expectedLocation public void install Launcher launcher Platform p FileSystem fs TaskListener log String expectedLocation String jdkBundle throws IOException InterruptedException PrintStream out log getLogger out println Installing jdkBundle FilePath parent new FilePath launcher getChannel expectedLocation getParent switch p case LINUX case SOLARIS JDK on Unix up to 6 was distributed as shell script installer but in JDK7 it switched to a plain tgz so check if the file is gzipped and if so treat it accordingly byte header new byte 2 DataInputStream in new DataInputStream fs read jdkBundle try in readFully header finally IOUtils closeQuietly in ProcStarter starter if header 0 0x1F header 1 byte 0x8B gzip starter launcher launch cmds tar xvzf jdkBundle else fs chmod jdkBundle 0755 starter launcher launch cmds jdkBundle noregister int exit starter stdin new ByteArrayInputStream yes getBytes stdout out pwd new FilePath launcher getChannel expectedLocation join if exit 0 throw new AbortException Messages JDKInstaller FailedToInstallJDK exit JDK creates its own sub directory so pull them up List String paths fs listSubDirectories expectedLocation for Iterator String itr paths iterator itr hasNext String s itr next if s matches j 2s dk itr remove if paths size 1 throw new AbortException Failed to find the extracted JDKs paths remove the intermediate directory fs pullUp expectedLocation paths get 0 expectedLocation break case WINDOWS expectedLocation expectedLocation trim if expectedLocation endsWith Prevent a trailing slash from escaping quotes expectedLocation expectedLocation substring 0 expectedLocation length 1 String logFile parent createTempFile install log getRemote ArgumentListBuilder args new ArgumentListBuilder assert new File expectedLocation exists expectedLocation must exist otherwise L will cause the installer to fail with error 1622 if isJava15 isJava14 Installer uses InstallShield args add CMD EXE C see http docs oracle com javase 1 5 0 docs guide deployment deployment guide silent html CMD EXE C must be followed by a single parameter do not split it args add jdkBundle s v qn REBOOT ReallySuppress INSTALLDIR expectedLocation L logFile else Installed uses Windows Installer MSI args add jdkBundle s Create a private JRE by omitting PublicjreFeature see http docs oracle com javase 7 docs webnotes install windows jdk installation windows html jdk silent installation args add ADDLOCAL ToolsFeature REBOOT ReallySuppress INSTALLDIR expectedLocation L logFile int r launcher launch cmds args stdout out pwd new FilePath launcher getChannel expectedLocation join if r 0 out println Messages JDKInstaller FailedToInstallJDK r log file is in UTF 16 try InputStreamReader in new InputStreamReader fs read logFile UTF 16 IOUtils copy in new OutputStreamWriter out throw new AbortException fs delete logFile break case OSX Mount the DMG distribution bundle FilePath dmg parent createTempDir jdk dmg exit launcher launch cmds hdiutil attach puppetstrings mountpoint dmg getRemote jdkBundle stdout log join if exit 0 throw new AbortException Messages JDKInstaller FailedToInstallJDK exit expand the installation PKG FilePath list dmg list pkg if list length 1 log getLogger println JDK dmg bundle does not contain expected pkg installer throw new AbortException Messages JDKInstaller FailedToInstallJDK exit String installer list 0 getRemote FilePath pkg parent createTempDir jdk pkg pkg deleteRecursive pkgutil fails if target directory exists exit launcher launch cmds pkgutil expand installer pkg getRemote stdout log join if exit 0 throw new AbortException Messages JDKInstaller FailedToInstallJDK exit exit launcher launch cmds umount dmg getRemote stdout log join if exit 0 throw new AbortException Messages JDKInstaller FailedToInstallJDK exit We only want the actual JDK sub package which Payload is actually a tar gz archive list pkg list jdk pkg Payload if list length 1 log getLogger println JDK pkg installer does not contain expected JDK Payload archive throw new AbortException Messages JDKInstaller FailedToInstallJDK exit String payload list 0 getRemote exit launcher launch pwd parent cmds tar xzf payload stdout log join if exit 0 throw new AbortException Messages JDKInstaller FailedToInstallJDK exit parent child Contents Home moveAllChildrenTo new FilePath launcher getChannel expectedLocation parent child Contents deleteRecursive pkg deleteRecursive dmg deleteRecursive break private boolean isJava15 return id contains 1 5 private boolean isJava14 return id contains 1 4 public interface FileSystem void delete String file throws IOException InterruptedException void chmod String file int mode throws IOException InterruptedException InputStream read String file throws IOException InterruptedException List String listSubDirectories String dir throws IOException InterruptedException void pullUp String from String to throws IOException InterruptedException static final class FilePathFileSystem implements FileSystem private final Node node FilePathFileSystem Node node this node node public void delete String file throws IOException InterruptedException file delete public void chmod String file int mode throws IOException InterruptedException file chmod mode public InputStream read String file throws IOException InterruptedException return file read public List String listSubDirectories String dir throws IOException InterruptedException List String r new ArrayList String for FilePath f dir listDirectories r add f getName return r public void pullUp String from String to throws IOException InterruptedException from moveAllChildrenTo to private FilePath String file return node createPath file private File getLocalCacheFile Platform platform CPU cpu return new File Jenkins getInstance getRootDir cache jdks platform cpu id public URL locate TaskListener log Platform platform CPU cpu throws IOException File cache getLocalCacheFile platform cpu if cache exists cache length 1 1024 1024 return cache toURL if the file is too small don t trust it In the past the download site served error message in 200 status code log getLogger println Installing JDK id JDKFamilyList families JDKList all get JDKList class toList if families isEmpty throw new IOException JDK data is empty JDKRelease release families getRelease id if release null throw new IOException Unable to find JDK with ID id JDKFile primary null secondary null for JDKFile f release files String vcap f name toUpperCase Locale ENGLISH JDK files have either windows linux or solaris in its name so that allows us to throw away unapplicable stuff right away if platform is vcap continue switch cpu accept vcap case PRIMARY primary f break case SECONDARY secondary f break case UNACCEPTABLE break if primary null primary secondary if primary null throw new AbortException Couldn t find the right download for platform and cpu combination LOGGER fine Platform choice primary log getLogger println Downloading JDK from primary filepath HttpClient hc new HttpClient hc getParams setParameter http useragent Mozilla 5 0 Windows U MSIE 9 0 Windows NT 9 0 en US ProxyConfiguration jpc Jenkins getInstance proxy if jpc null hc getHostConfiguration setProxy jpc name jpc port if jpc getUserName null hc getState setProxyCredentials AuthScope ANY new UsernamePasswordCredentials jpc getUserName jpc getPassword int authCount 0 totalPageCount 0 counters for avoiding infinite loop HttpMethodBase m new GetMethod primary filepath hc getState addCookie new Cookie oracle com gpw e24 1 false hc getState addCookie new Cookie oracle com oraclelicense accept securebackup cookie 1 false try while true if totalPageCount 16 looping too much throw new IOException Unable to find the login form LOGGER fine Requesting m getURI int r hc executeMethod m if r 100 3 redirect String loc m getResponseHeader Location getValue m releaseConnection m new GetMethod loc continue if r 200 throw new IOException Failed to request m getURI exit code r if m getURI getHost equals login oracle com LOGGER fine Appears to be a login page String resp IOUtils toString m getResponseBodyAsStream m getResponseCharSet m releaseConnection Matcher pm Pattern compile form action form Pattern DOTALL matcher resp if pm find throw new IllegalStateException Unable to find a form in the response n resp String form pm group PostMethod post new PostMethod new URL new URL m getURI getURI pm group 1 toExternalForm String u getDescriptor getUsername Secret p getDescriptor getPassword if u null p null log hyperlink getCredentialPageUrl Oracle now requires Oracle account to download previous versions of JDK Please specify your Oracle account username password n throw new AbortException Unable to install JDK unless a valid Oracle account username password is provided in the system configuration for String fragment form split input String n extractAttribute fragment name String v extractAttribute fragment value if n null v null continue if n equals ssousername v u if n equals password v p getPlainText if authCount 3 log hyperlink getCredentialPageUrl Your Oracle account doesn t appear valid Please specify a valid username password n throw new AbortException Unable to install JDK unless a valid username password is provided post addParameter n v m post else log getLogger println Downloading m getResponseContentLength bytes download to a temporary file and rename it in to handle concurrency and failure correctly File tmp new File cache getPath tmp try tmp getParentFile mkdirs try FileOutputStream out new FileOutputStream tmp IOUtils copy m getResponseBodyAsStream out tmp renameTo cache return cache toURL finally tmp delete finally m releaseConnection private static String extractAttribute String s String name String h name int si s indexOf h if si 0 return null int ei s indexOf si h length return s substring si h length ei private String getCredentialPageUrl return getDescriptor getDescriptorUrl enterCredential public enum Preference PRIMARY SECONDARY UNACCEPTABLE public enum Platform LINUX jdk sh SOLARIS jdk sh WINDOWS jdk exe OSX jdk dmg public final String bundleFileName Platform String bundleFileName this bundleFileName bundleFileName public boolean is String line return line contains name public static Platform of Node n throws IOException InterruptedException DetectionFailedException return n getChannel call new GetCurrentPlatform public static Platform current throws DetectionFailedException String arch System getProperty os name toLowerCase Locale ENGLISH if arch contains linux return LINUX if arch contains windows return WINDOWS if arch contains sun arch contains solaris return SOLARIS if arch contains mac return OSX throw new DetectionFailedException Unknown CPU name arch static class GetCurrentPlatform extends MasterToSlaveCallable Platform DetectionFailedException private static final long serialVersionUID 1L public Platform call throws DetectionFailedException return current public enum CPU i386 amd64 Sparc Itanium public Preference accept String line switch this these two guys are totally incompatible with everything else so no fallback case Sparc return must line contains SPARC case Itanium return must line contains IA64 64bit Solaris Linux and Windows can all run 32bit executable so fall back to 32bit if 64bit bundle is not found case amd64 if line contains SPARC line contains IA64 return UNACCEPTABLE if line contains 64 return PRIMARY return SECONDARY case i386 if line contains 64 line contains SPARC line contains IA64 return UNACCEPTABLE return PRIMARY return UNACCEPTABLE private static Preference must boolean b return b PRIMARY UNACCEPTABLE public static CPU of Node n throws IOException InterruptedException DetectionFailedException return n getChannel call new GetCurrentCPU public static CPU current throws DetectionFailedException String arch System getProperty os arch toLowerCase Locale ENGLISH if arch contains sparc return Sparc if arch contains ia64 return Itanium if arch contains amd64 arch contains 86 64 return amd64 if arch contains 86 return i386 throw new DetectionFailedException Unknown CPU architecture arch static class GetCurrentCPU extends MasterToSlaveCallable CPU DetectionFailedException private static final long serialVersionUID 1L public CPU call throws DetectionFailedException return current private static final class DetectionFailedException extends Exception private DetectionFailedException String message super message public static final class JDKFamilyList public JDKFamily data new JDKFamily 0 public int version public boolean isEmpty for JDKFamily f data if f releases length 0 return false return true public JDKRelease getRelease String productCode for JDKFamily f data for JDKRelease r f releases if r matchesId productCode return r return null public static final class JDKFamily public String name public JDKRelease releases public static final class JDKRelease public JDKFile files public String licpath public String lictitle public String name public String title public boolean matchesId String rhs return rhs null rhs equals name rhs startsWith name public static final class JDKFile public String filepath public String name public String title Override public DescriptorImpl getDescriptor return DescriptorImpl super getDescriptor Extension Symbol jdkInstaller public static final class DescriptorImpl extends ToolInstallerDescriptor JDKInstaller private String username private Secret password public DescriptorImpl load public String getDisplayName return Messages JDKInstaller DescriptorImpl displayName Override public boolean isApplicable Class extends ToolInstallation toolType return toolType JDK class public String getUsername return username public Secret getPassword return password public FormValidation doCheckId QueryParameter String value if Util fixEmpty value null return FormValidation error Messages JDKInstaller DescriptorImpl doCheckId improve message return FormValidation ok public List JDKFamily getInstallableJDKs throws IOException return Arrays asList JDKList all get JDKList class toList data public FormValidation doCheckAcceptLicense QueryParameter boolean value if username null password null return FormValidation errorWithMarkup Messages JDKInstaller RequireOracleAccount Stapler getCurrentRequest getContextPath getDescriptorUrl enterCredential if value return FormValidation ok else return FormValidation error Messages JDKInstaller DescriptorImpl doCheckAcceptLicense public HttpResponse doPostCredential QueryParameter String username QueryParameter String password throws IOException ServletException this username username this password Secret fromString password save return HttpResponses redirectTo credentialOK Extension Symbol jdk public static final class JDKList extends Downloadable public JDKList super JDKInstaller class public JDKFamilyList toList throws IOException JSONObject d getData if d null return new JDKFamilyList return JDKFamilyList JSONObject toBean d JDKFamilyList class Override public JSONObject reduce List JSONObject jsonObjectList List JDKFamily reducedFamilies new LinkedList int version 0 JsonConfig jsonConfig new JsonConfig jsonConfig registerPropertyExclusion JDKFamilyList class empty jsonConfig setRootClass JDKFamilyList class collect all JDKFamily objects from the multiple json objects for JSONObject jsonJdkFamilyList jsonObjectList JDKFamilyList jdkFamilyList JDKFamilyList JSONObject toBean jsonJdkFamilyList jsonConfig if version 0 we set as version the version of the first update center version jdkFamilyList version JDKFamily jdkFamilies jdkFamilyList data reducedFamilies addAll Arrays asList jdkFamilies we iterate on the list and reduce it until there are no more duplicates this could be made recursive while hasDuplicates reducedFamilies name create a temporary list to store the tmp result List JDKFamily tmpReducedFamilies new LinkedList we need to skip the processed families boolean processed new boolean reducedFamilies size for int i 0 i reducedFamilies size i if processed i true continue JDKFamily data1 reducedFamilies get i boolean hasDuplicate false for int j i 1 j reducedFamilies size j JDKFamily data2 reducedFamilies get j if we found a duplicate we need to merge the families if data1 name equals data2 name hasDuplicate true processed j true JDKFamily reducedData reduceData data1 name new LinkedList JDKRelease Arrays asList data1 releases new LinkedList JDKRelease Arrays asList data2 releases tmpReducedFamilies add reducedData after the first duplicate has been found we break the loop since the duplicates are processed two by two break if no duplicate has been found we just insert the whole family in the tmp list if hasDuplicate tmpReducedFamilies add data1 reducedFamilies tmpReducedFamilies JDKFamilyList jdkFamilyList new JDKFamilyList jdkFamilyList version version jdkFamilyList data new JDKFamily reducedFamilies size reducedFamilies toArray jdkFamilyList data JSONObject reducedJdkFamilyList JSONObject fromObject jdkFamilyList jsonConfig return the list with no duplicates return reducedJdkFamilyList private JDKFamily reduceData String name List JDKRelease releases1 List JDKRelease releases2 LinkedList JDKRelease reducedReleases new LinkedList for Iterator JDKRelease iterator releases1 iterator iterator hasNext JDKRelease release1 iterator next boolean hasDuplicate false for Iterator JDKRelease iterator2 releases2 iterator iterator2 hasNext JDKRelease release2 iterator2 next if release1 name equals release2 name hasDuplicate true JDKRelease reducedRelease reduceReleases release1 new LinkedList JDKFile Arrays asList release1 files new LinkedList JDKFile Arrays asList release2 files iterator2 remove reducedReleases add reducedRelease we assume that in one release list there are no duplicates so we stop at the first one break if hasDuplicate reducedReleases add release1 reducedReleases addAll releases2 JDKFamily reducedFamily new JDKFamily reducedFamily name name reducedFamily releases new JDKRelease reducedReleases size reducedReleases toArray reducedFamily releases return reducedFamily private JDKRelease reduceReleases JDKRelease release List JDKFile files1 List JDKFile files2 LinkedList JDKFile reducedFiles new LinkedList for Iterator JDKFile iterator1 files1 iterator iterator1 hasNext JDKFile file1 iterator1 next for Iterator JDKFile iterator2 files2 iterator iterator2 hasNext JDKFile file2 iterator2 next if file1 name equals file2 name iterator2 remove we assume the in one file list there are no duplicates so we break after we find the first match break reducedFiles addAll files1 reducedFiles addAll files2 JDKRelease jdkRelease new JDKRelease jdkRelease files new JDKFile reducedFiles size reducedFiles toArray jdkRelease files jdkRelease name release name jdkRelease licpath release licpath jdkRelease lictitle release lictitle jdkRelease title release title return jdkRelease private static final Logger LOGGER Logger getLogger JDKInstaller class getNamepackage jenkins model import antlr ANTLRException import com google common collect ImmutableMap import com google common collect ImmutableSet import com google common collect Lists import com google inject Inject import com google inject Injector import com thoughtworks xstream XStream import hudson BulkChange import hudson DNSMultiCast import hudson DescriptorExtensionList import hudson Extension import hudson ExtensionComponent import hudson ExtensionFinder import hudson ExtensionList import hudson ExtensionPoint import hudson FilePath import hudson Functions import hudson Launcher import hudson Launcher LocalLauncher import hudson Lookup import hudson Main import hudson Plugin import hudson PluginManager import hudson PluginWrapper import hudson ProxyConfiguration import jenkins AgentProtocol import jenkins util SystemProperties import hudson TcpSlaveAgentListener import hudson UDPBroadcastThread import hudson Util import hudson WebAppMain import hudson XmlFile import hudson cli declarative CLIMethod import hudson cli declarative CLIResolver import hudson init InitMilestone import hudson init InitStrategy import hudson init TermMilestone import hudson init TerminatorFinder import hudson lifecycle Lifecycle import hudson lifecycle RestartNotSupportedException import hudson logging LogRecorderManager import hudson markup EscapedMarkupFormatter import hudson markup MarkupFormatter import hudson model AbstractCIBase import hudson model AbstractProject import hudson model Action import hudson model AdministrativeMonitor import hudson model AllView import hudson model Api import hudson model Computer import hudson model ComputerSet import hudson model DependencyGraph import hudson model Describable import hudson model Descriptor import hudson model Descriptor FormException import hudson model DescriptorByNameOwner import hudson model DirectoryBrowserSupport import hudson model Failure import hudson model Fingerprint import hudson model FingerprintCleanupThread import hudson model FingerprintMap import hudson model Hudson import hudson model Item import hudson model ItemGroup import hudson model ItemGroupMixIn import hudson model Items import hudson model JDK import hudson model Job import hudson model JobPropertyDescriptor import hudson model Label import hudson model ListView import hudson model LoadBalancer import hudson model LoadStatistics import hudson model ManagementLink import hudson model Messages import hudson model ModifiableViewGroup import hudson model NoFingerprintMatch import hudson model Node import hudson model OverallLoadStatistics import hudson model PaneStatusProperties import hudson model Project import hudson model Queue import hudson model Queue FlyweightTask import hudson model RestartListener import hudson model RootAction import hudson model Slave import hudson model TaskListener import hudson model TopLevelItem import hudson model TopLevelItemDescriptor import hudson model UnprotectedRootAction import hudson model UpdateCenter import hudson model User import hudson model View import hudson model ViewGroupMixIn import hudson model WorkspaceCleanupThread import hudson model labels LabelAtom import hudson model listeners ItemListener import hudson model listeners SCMListener import hudson model listeners SaveableListener import hudson remoting Callable import hudson remoting LocalChannel import hudson remoting VirtualChannel import hudson scm RepositoryBrowser import hudson scm SCM import hudson search CollectionSearchIndex import hudson search SearchIndexBuilder import hudson search SearchItem import hudson security ACL import hudson security AccessControlled import hudson security AuthorizationStrategy import hudson security BasicAuthenticationFilter import hudson security FederatedLoginService import hudson security FullControlOnceLoggedInAuthorizationStrategy import hudson security HudsonFilter import hudson security LegacyAuthorizationStrategy import hudson security LegacySecurityRealm import hudson security Permission import hudson security PermissionGroup import hudson security PermissionScope import hudson security SecurityMode import hudson security SecurityRealm import hudson security csrf CrumbIssuer import hudson slaves Cloud import hudson slaves ComputerListener import hudson slaves DumbSlave import hudson slaves NodeDescriptor import hudson slaves NodeList import hudson slaves NodeProperty import hudson slaves NodePropertyDescriptor import hudson slaves NodeProvisioner import hudson slaves OfflineCause import hudson slaves RetentionStrategy import hudson tasks BuildWrapper import hudson tasks Builder import hudson tasks Publisher import hudson triggers SafeTimerTask import hudson triggers Trigger import hudson triggers TriggerDescriptor import hudson util AdministrativeError import hudson util CaseInsensitiveComparator import hudson util ClockDifference import hudson util CopyOnWriteList import hudson util CopyOnWriteMap import hudson util DaemonThreadFactory import hudson util DescribableList import hudson util FormApply import hudson util FormValidation import hudson util Futures import hudson util HudsonIsLoading import hudson util HudsonIsRestarting import hudson util IOUtils import hudson util Iterators import hudson util JenkinsReloadFailed import hudson util Memoizer import hudson util MultipartFormDataParser import hudson util NamingThreadFactory import hudson util PluginServletFilter import hudson util RemotingDiagnostics import hudson util RemotingDiagnostics HeapDump import hudson util TextFile import hudson util TimeUnit2 import hudson util VersionNumber import hudson util XStream2 import hudson views DefaultMyViewsTabBar import hudson views DefaultViewsTabBar import hudson views MyViewsTabBar import hudson views ViewsTabBar import hudson widgets Widget import java util Objects import java util TimerTask import java util concurrent CountDownLatch import jenkins ExtensionComponentSet import jenkins ExtensionRefreshException import jenkins InitReactorRunner import jenkins install InstallState import jenkins install InstallUtil import jenkins install SetupWizard import jenkins model ProjectNamingStrategy DefaultProjectNamingStrategy import jenkins security ConfidentialKey import jenkins security ConfidentialStore import jenkins security SecurityListener import jenkins security MasterToSlaveCallable import jenkins slaves WorkspaceLocator import jenkins util JenkinsJVM import jenkins util Timer import jenkins util io FileBoolean import jenkins util io OnMaster import jenkins util xml XMLUtils import net jcip annotations GuardedBy import net sf json JSONObject import org acegisecurity AccessDeniedException import org acegisecurity AcegiSecurityException import org acegisecurity Authentication import org acegisecurity GrantedAuthority import org acegisecurity GrantedAuthorityImpl import org acegisecurity context SecurityContextHolder import org acegisecurity providers anonymous AnonymousAuthenticationToken import org acegisecurity ui AbstractProcessingFilter import org apache commons jelly JellyException import org apache commons jelly Script import org apache commons logging LogFactory import org jvnet hudson reactor Executable import org jvnet hudson reactor Milestone import org jvnet hudson reactor Reactor import org jvnet hudson reactor ReactorException import org jvnet hudson reactor ReactorListener import org jvnet hudson reactor Task import org jvnet hudson reactor TaskBuilder import org jvnet hudson reactor TaskGraphBuilder import org jvnet hudson reactor TaskGraphBuilder Handle import org kohsuke accmod Restricted import org kohsuke accmod restrictions NoExternalUse import org kohsuke args4j Argument import org kohsuke stapler HttpRedirect import org kohsuke stapler HttpResponse import org kohsuke stapler HttpResponses import org kohsuke stapler MetaClass import org kohsuke stapler QueryParameter import org kohsuke stapler Stapler import org kohsuke stapler StaplerFallback import org kohsuke stapler StaplerProxy import org kohsuke stapler StaplerRequest import org kohsuke stapler StaplerResponse import org kohsuke stapler WebApp import org kohsuke stapler export Exported import org kohsuke stapler export ExportedBean import org kohsuke stapler framework adjunct AdjunctManager import org kohsuke stapler interceptor RequirePOST import org kohsuke stapler jelly JellyClassLoaderTearOff import org kohsuke stapler jelly JellyRequestDispatcher import org xml sax InputSource import javax annotation CheckForNull import javax annotation Nonnull import javax annotation Nullable import javax crypto SecretKey import javax servlet RequestDispatcher import javax servlet ServletContext import javax servlet ServletException import javax servlet http Cookie import javax servlet http HttpServletResponse import java io File import java io IOException import java io InputStream import java io PrintWriter import java io StringWriter import java net BindException import java net HttpURLConnection import java net URL import java nio charset Charset import java security SecureRandom import java util ArrayList import java util Arrays import java util Collection import java util Collections import java util Comparator import java util HashMap import java util HashSet import java util Iterator import java util List import java util Map import java util Map Entry import java util Properties import java util Set import java util StringTokenizer import java util TreeSet import java util TreeMap import java util concurrent ConcurrentHashMap import java util concurrent CopyOnWriteArrayList import java util concurrent ExecutionException import java util concurrent Executor import java util concurrent ExecutorService import java util concurrent Future import java util concurrent LinkedBlockingQueue import java util concurrent ThreadPoolExecutor import java util concurrent TimeUnit import java util concurrent TimeoutException import java util concurrent atomic AtomicBoolean import java util logging Level import java util logging LogRecord import java util logging Logger import static hudson Util import static hudson init InitMilestone import hudson init Initializer import hudson util LogTaskListener import static java util logging Level import static javax servlet http HttpServletResponse import org kohsuke stapler WebMethod ExportedBean public class Jenkins extends AbstractCIBase implements DirectlyModifiableTopLevelItemGroup StaplerProxy StaplerFallback ModifiableViewGroup AccessControlled DescriptorByNameOwner ModelObjectWithContextMenu ModelObjectWithChildren OnMaster private transient final Queue queue public transient final Lookup lookup new Lookup this field needs to be at the very top so that other components can look at this value even during unmarshalling private String version 1 0 private transient InstallState installState InstallState UNKNOWN private transient SetupWizard setupWizard private int numExecutors 2 private Mode mode Mode NORMAL private Boolean useSecurity private volatile AuthorizationStrategy authorizationStrategy AuthorizationStrategy UNSECURED private volatile SecurityRealm securityRealm SecurityRealm NO AUTHENTICATION private volatile boolean disableRememberMe private ProjectNamingStrategy projectNamingStrategy DefaultProjectNamingStrategy DEFAULT NAMING STRATEGY private String workspaceDir ITEM ROOTDIR WORKSPACE DIRNAME private String buildsDir ITEM ROOTDIR builds private String systemMessage private MarkupFormatter markupFormatter public transient final File root private transient volatile InitMilestone initLevel InitMilestone STARTED transient final Map String TopLevelItem items new CopyOnWriteMap Tree String TopLevelItem CaseInsensitiveComparator INSTANCE private static Jenkins theInstance private transient volatile boolean isQuietingDown private transient volatile boolean terminating GuardedBy Jenkins class private transient boolean cleanUpStarted private volatile List JDK jdks new ArrayList JDK private transient volatile DependencyGraph dependencyGraph private final transient AtomicBoolean dependencyGraphDirty new AtomicBoolean private volatile ViewsTabBar viewsTabBar new DefaultViewsTabBar private volatile MyViewsTabBar myViewsTabBar new DefaultMyViewsTabBar private transient final Memoizer Class ExtensionList extensionLists new Memoizer Class ExtensionList public ExtensionList compute Class key return ExtensionList create Jenkins this key private transient final Memoizer Class DescriptorExtensionList descriptorLists new Memoizer Class DescriptorExtensionList public DescriptorExtensionList compute Class key return DescriptorExtensionList createDescriptorList Jenkins this key protected transient final Map Node Computer computers new CopyOnWriteMap Hash Node Computer public final Hudson CloudList clouds new Hudson CloudList this public static class CloudList extends DescribableList Cloud Descriptor Cloud public CloudList Jenkins h super h public CloudList needed for XStream deserialization public Cloud getByName String name for Cloud c this if c name equals name return c return null Override protected void onModified throws IOException super onModified Jenkins getInstance trimLabels Deprecated protected transient volatile NodeList slaves private transient final Nodes nodes new Nodes this Integer quietPeriod int scmCheckoutRetryCount private final CopyOnWriteArrayList View views new CopyOnWriteArrayList View private volatile String primaryView private transient final ViewGroupMixIn viewGroupMixIn new ViewGroupMixIn this protected List View views return views protected String primaryView return primaryView protected void primaryView String name primaryView name private transient final FingerprintMap fingerprintMap new FingerprintMap public transient final PluginManager pluginManager public transient volatile TcpSlaveAgentListener tcpSlaveAgentListener private transient final Object tcpSlaveAgentListenerLock new Object private transient UDPBroadcastThread udpBroadcastThread private transient DNSMultiCast dnsMultiCast private transient final CopyOnWriteList SCMListener scmListeners new CopyOnWriteList SCMListener private int slaveAgentPort getSlaveAgentPortInitialValue 0 private static int getSlaveAgentPortInitialValue int def return SystemProperties getInteger Jenkins class getName slaveAgentPort def private static final boolean SLAVE AGENT PORT ENFORCE SystemProperties getBoolean Jenkins class getName slaveAgentPortEnforce false CheckForNull private List String disabledAgentProtocols CheckForNull private List String enabledAgentProtocols private transient Set String agentProtocols private String label private volatile CrumbIssuer crumbIssuer private transient final ConcurrentHashMap String Label labels new ConcurrentHashMap String Label Exported public transient final OverallLoadStatistics overallLoad new OverallLoadStatistics Exported public transient final LoadStatistics unlabeledLoad new UnlabeledLoadStatistics public transient final NodeProvisioner unlabeledNodeProvisioner new NodeProvisioner null unlabeledLoad Restricted NoExternalUse class Deprecated public transient final NodeProvisioner overallNodeProvisioner unlabeledNodeProvisioner public transient final ServletContext servletContext private transient final List Action actions new CopyOnWriteArrayList Action private DescribableList NodeProperty NodePropertyDescriptor nodeProperties new DescribableList NodeProperty NodePropertyDescriptor this private DescribableList NodeProperty NodePropertyDescriptor globalNodeProperties new DescribableList NodeProperty NodePropertyDescriptor this public transient final List AdministrativeMonitor administrativeMonitors getExtensionList AdministrativeMonitor class private transient final List Widget widgets getExtensionList Widget class private transient final AdjunctManager adjuncts private transient final ItemGroupMixIn itemGroupMixIn new ItemGroupMixIn this this Override protected void add TopLevelItem item items put item getName item Override protected File getRootDirFor String name return Jenkins this getRootDirFor name public interface JenkinsHolder CheckForNull Jenkins getInstance static JenkinsHolder HOLDER new JenkinsHolder public CheckForNull Jenkins getInstance return theInstance Deprecated Nonnull public static Jenkins getActiveInstance throws IllegalStateException Jenkins instance HOLDER getInstance if instance null throw new IllegalStateException Jenkins has not been started or was already shut down return instance CheckForNull public static Jenkins getInstanceOrNull return HOLDER getInstance CLIResolver Nonnull public static Jenkins getInstance Jenkins instance HOLDER getInstance if instance null if SystemProperties getBoolean Jenkins class getName enableExceptionOnNullInstance TODO remove that second block around 2 20 that is 20 versions to battle test it See https github com jenkinsci jenkins pull 2297 issuecomment 216710150 throw new IllegalStateException Jenkins has not been started or was already shut down return instance private transient final String secretKey private transient final UpdateCenter updateCenter UpdateCenter createUpdateCenter null private Boolean noUsageStatistics public transient volatile ProxyConfiguration proxy private transient final LogRecorderManager log new LogRecorderManager private transient final boolean oldJenkinsJVM protected Jenkins File root ServletContext context throws IOException InterruptedException ReactorException this root context null edu umd cs findbugs annotations SuppressFBWarnings SC START IN CTOR bug in FindBugs It flags UDPBroadcastThread start call but that s for another class ST WRITE TO STATIC FROM INSTANCE METHOD Trigger timer protected Jenkins File root ServletContext context PluginManager pluginManager throws IOException InterruptedException ReactorException oldJenkinsJVM JenkinsJVM isJenkinsJVM capture to restore in cleanUp JenkinsJVMAccess setJenkinsJVM true set it for unit tests as they will not have gone through WebAppMain long start System currentTimeMillis As Jenkins is starting grant this process full control ACL impersonate ACL SYSTEM try this root root this servletContext context computeVersion context if theInstance null throw new IllegalStateException second instance theInstance this if new File root jobs exists if this is a fresh install use more modern default layout that s consistent with agents workspaceDir JENKINS HOME workspace ITEM FULLNAME doing this early allows InitStrategy to set environment upfront final InitStrategy is InitStrategy get Thread currentThread getContextClassLoader Trigger timer new java util Timer Jenkins cron thread queue new Queue LoadBalancer CONSISTENT HASH try dependencyGraph DependencyGraph EMPTY catch InternalError e if e getMessage contains window server throw new Error Looks like the server runs without X Please specify Djava awt headless true as JVM option e throw e get or create the secret TextFile secretFile new TextFile new File getRootDir secret key if secretFile exists secretKey secretFile readTrim else SecureRandom sr new SecureRandom byte random new byte 32 sr nextBytes random secretKey Util toHexString random secretFile write secretKey this marker indicates that the secret key is generated by the version of Jenkins post SECURITY 49 this indicates that there s no need to rewrite secrets on disk new FileBoolean new File root secret key not so secret on try proxy ProxyConfiguration load catch IOException e LOGGER log SEVERE Failed to load proxy configuration e if pluginManager null pluginManager PluginManager createDefault this this pluginManager pluginManager JSON binding needs to be able to see all the classes from all the plugins WebApp get servletContext setClassLoader pluginManager uberClassLoader adjuncts new AdjunctManager servletContext pluginManager uberClassLoader adjuncts SESSION HASH TimeUnit2 DAYS toMillis 365 initialization consists of executeReactor is pluginManager initTasks is loading and preparing plugins loadTasks load jobs InitMilestone ordering forced ordering among key milestones Ensure we reached the final initialization state Log the error otherwise if initLevel InitMilestone COMPLETED LOGGER log SEVERE Jenkins initialization has not reached the COMPLETED initialization milestone after the startup Current state 0 It may cause undefined incorrect behavior in Jenkins plugin relying on this state It is likely an issue with the Initialization task graph Example usage of Initializer after InitMilestone COMPLETED in a plugin JENKINS 37759 Please create a bug in Jenkins bugtracker initLevel if KILL AFTER LOAD System exit 0 setupWizard new SetupWizard InstallUtil proceedToNextStateFrom InstallState UNKNOWN launchTcpSlaveAgentListener if UDPBroadcastThread PORT 1 try udpBroadcastThread new UDPBroadcastThread this udpBroadcastThread start catch IOException e LOGGER log Level WARNING Failed to broadcast over UDP use Dhudson udp 1 to disable e dnsMultiCast new DNSMultiCast this Timer get scheduleAtFixedRate new SafeTimerTask Override protected void doRun throws Exception trimLabels TimeUnit2 MINUTES toMillis 5 TimeUnit2 MINUTES toMillis 5 TimeUnit MILLISECONDS updateComputerList master is online now Computer c toComputer if c null for ComputerListener cl ComputerListener all cl onOnline c new LogTaskListener LOGGER INFO for ItemListener l ItemListener all long itemListenerStart System currentTimeMillis try l onLoaded catch RuntimeException x LOGGER log Level WARNING null x if LOG STARTUP PERFORMANCE LOGGER info String format Took dms for item listener s startup System currentTimeMillis itemListenerStart l getClass getName if LOG STARTUP PERFORMANCE LOGGER info String format Took dms for complete Jenkins startup System currentTimeMillis start finally SecurityContextHolder clearContext SuppressWarnings unused private Object readResolve if jdks null jdks new ArrayList if SLAVE AGENT PORT ENFORCE slaveAgentPort getSlaveAgentPortInitialValue slaveAgentPort return this Nonnull Restricted NoExternalUse class public InstallState getInstallState if installState null installState name null return InstallState UNKNOWN return installState Restricted NoExternalUse class public void setInstallState Nonnull InstallState newState InstallState prior installState installState newState if prior equals newState newState initializeState private void executeReactor final InitStrategy is TaskBuilder builders throws IOException InterruptedException ReactorException Reactor reactor new Reactor builders Override protected void runTask Task task throws Exception if is null is skipInitTask task return ACL impersonate ACL SYSTEM full access in the initialization thread String taskName InitReactorRunner getDisplayName task Thread t Thread currentThread String name t getName if taskName null t setName taskName try long start System currentTimeMillis super runTask task if LOG STARTUP PERFORMANCE LOGGER info String format Took dms for s by s System currentTimeMillis start taskName name catch Exception Error x if containsLinkageError x LOGGER log Level WARNING taskName failed perhaps due to plugin dependency issues x else throw x finally t setName name SecurityContextHolder clearContext private boolean containsLinkageError Throwable x if x instanceof LinkageError return true Throwable x2 x getCause return x2 null containsLinkageError x2 new InitReactorRunner Override protected void onInitMilestoneAttained InitMilestone milestone initLevel milestone if milestone PLUGINS PREPARED set up Guice to enable injection as early as possible before this milestone ExtensionList ensureLoaded won t actually try to locate instances ExtensionList lookup ExtensionFinder class getComponents run reactor public TcpSlaveAgentListener getTcpSlaveAgentListener return tcpSlaveAgentListener public AdjunctManager getAdjuncts String dummy return adjuncts Exported public int getSlaveAgentPort return slaveAgentPort public boolean isSlaveAgentPortEnforced return Jenkins SLAVE AGENT PORT ENFORCE public void setSlaveAgentPort int port throws IOException if SLAVE AGENT PORT ENFORCE LOGGER log Level WARNING setSlaveAgentPort 0 call ignored because system property 1 is true new String Integer toString port Jenkins class getName slaveAgentPortEnforce else forceSetSlaveAgentPort port private void forceSetSlaveAgentPort int port throws IOException this slaveAgentPort port launchTcpSlaveAgentListener public Set String getAgentProtocols if agentProtocols null idempotent so don t care if we do this concurrently should all get same result Set String result new TreeSet Set String disabled new TreeSet for String p Util fixNull disabledAgentProtocols disabled add p trim Set String enabled new TreeSet for String p Util fixNull enabledAgentProtocols enabled add p trim for AgentProtocol p AgentProtocol all String name p getName if name null p isRequired disabled contains name p isOptIn enabled contains name result add name agentProtocols result return result return agentProtocols public void setAgentProtocols Set String protocols Set String disabled new TreeSet Set String enabled new TreeSet for AgentProtocol p AgentProtocol all String name p getName if name null p isRequired we want to record the protocols where the admin has made a conscious decision thus if a protocol is opt in we record the admin enabling it if a protocol is opt out we record the admin disabling it We should not transition rapidly from opt in opt out opt in the scenario we want to have work is 1 We introduce a new protocol it starts off as opt in Some admins decide to test and opt in 2 We decide that the protocol is ready for general use It gets marked as opt out Any admins that took part in early testing now have their config switched to not mention the new protocol at all when they save their config as the protocol is now opt out Any admins that want to disable it can do so and will have their preference recorded 3 We decide that the protocol needs to be retired It gets switched back to opt in At this point the initial opt in admins assuming they visited an upgrade to a master with step 2 will have the protocol disabled for them This is what we want If they didn t upgrade to a master with step 2 well there is not much we can do to differentiate them from somebody who is upgrading from a previous step 3 master and had needed to keep the protocol turned on What we should never do is flip flop opt in opt out opt in opt out as that will basically clear any preference that an admin has set but this should be ok as we only ever will be adding new protocols and retiring old ones if p isOptIn if protocols contains name enabled add name else if protocols contains name disabled add name disabledAgentProtocols disabled isEmpty null new ArrayList disabled enabledAgentProtocols enabled isEmpty null new ArrayList enabled agentProtocols null private void launchTcpSlaveAgentListener throws IOException synchronized tcpSlaveAgentListenerLock shutdown previous agent if the port has changed if tcpSlaveAgentListener null tcpSlaveAgentListener configuredPort slaveAgentPort tcpSlaveAgentListener shutdown tcpSlaveAgentListener null if slaveAgentPort 1 tcpSlaveAgentListener null final String administrativeMonitorId getClass getName tcpBind try tcpSlaveAgentListener new TcpSlaveAgentListener slaveAgentPort remove previous monitor in case of previous error AdministrativeMonitor toBeRemoved null ExtensionList AdministrativeMonitor all AdministrativeMonitor all for AdministrativeMonitor am all if administrativeMonitorId equals am id toBeRemoved am break all remove toBeRemoved catch BindException e LOGGER log Level WARNING String format Failed to listen to incoming agent connections through JNLP port s Change the JNLP port number slaveAgentPort e new AdministrativeError administrativeMonitorId Failed to listen to incoming agent connections through JNLP Failed to listen to incoming agent connections through JNLP a href configureSecurity Change the JNLP port number a to solve the problem e Extension Restricted NoExternalUse class public static class EnforceSlaveAgentPortAdministrativeMonitor extends AdministrativeMonitor Inject Jenkins j Override public String getDisplayName return jenkins model Messages EnforceSlaveAgentPortAdministrativeMonitor displayName public String getSystemPropertyName return Jenkins class getName slaveAgentPort public int getExpectedPort int slaveAgentPort j slaveAgentPort return Jenkins getSlaveAgentPortInitialValue slaveAgentPort public void doAct StaplerRequest req StaplerResponse rsp throws IOException j forceSetSlaveAgentPort getExpectedPort rsp sendRedirect2 req getContextPath manage Override public boolean isActivated int slaveAgentPort Jenkins getInstance slaveAgentPort return SLAVE AGENT PORT ENFORCE slaveAgentPort Jenkins getSlaveAgentPortInitialValue slaveAgentPort public void setNodeName String name throw new UnsupportedOperationException not allowed public String getNodeDescription return Messages Hudson NodeDescription Exported public String getDescription return systemMessage public PluginManager getPluginManager return pluginManager public UpdateCenter getUpdateCenter return updateCenter public boolean isUsageStatisticsCollected return noUsageStatistics null noUsageStatistics public void setNoUsageStatistics Boolean noUsageStatistics throws IOException this noUsageStatistics noUsageStatistics save public View People getPeople return new View People this public View AsynchPeople getAsynchPeople return new View AsynchPeople this Deprecated public boolean hasPeople return View People isApplicable items values public Api getApi return new Api this Deprecated public String getSecretKey return secretKey Deprecated public SecretKey getSecretKeyAsAES128 return Util toAes128Key secretKey SuppressWarnings deprecation public String getLegacyInstanceId return Util getDigestOf getSecretKey public Descriptor SCM getScm String shortClassName return findDescriptor shortClassName SCM all public Descriptor RepositoryBrowser getRepositoryBrowser String shortClassName return findDescriptor shortClassName RepositoryBrowser all public Descriptor Builder getBuilder String shortClassName return findDescriptor shortClassName Builder all public Descriptor BuildWrapper getBuildWrapper String shortClassName return findDescriptor shortClassName BuildWrapper all public Descriptor Publisher getPublisher String shortClassName return findDescriptor shortClassName Publisher all public TriggerDescriptor getTrigger String shortClassName return TriggerDescriptor findDescriptor shortClassName Trigger all public Descriptor RetentionStrategy getRetentionStrategy String shortClassName return findDescriptor shortClassName RetentionStrategy all public JobPropertyDescriptor getJobProperty String shortClassName combining these two lines triggers javac bug See issue 610 Descriptor d findDescriptor shortClassName JobPropertyDescriptor all return JobPropertyDescriptor d Deprecated public ComputerSet getComputer return new ComputerSet SuppressWarnings unchecked rawtypes too late to fix public Descriptor getDescriptor String id legacy descriptors that are reigstered manually doesn t show up in getExtensionList so check them explicitly Iterable Descriptor descriptors Iterators sequence getExtensionList Descriptor class DescriptorExtensionList listLegacyInstances for Descriptor d descriptors if d getId equals id return d Descriptor candidate null for Descriptor d descriptors String name d getId if name substring name lastIndexOf 1 equals id if candidate null candidate d else throw new IllegalArgumentException id is ambiguous matches both name and candidate getId return candidate public Descriptor getDescriptorByName String id return getDescriptor id CheckForNull public Descriptor getDescriptor Class extends Describable type for Descriptor d getExtensionList Descriptor class if d clazz type return d return null public Descriptor getDescriptorOrDie Class extends Describable type Descriptor d getDescriptor type if d null throw new AssertionError type is missing its descriptor return d public T extends Descriptor T getDescriptorByType Class T type for Descriptor d getExtensionList Descriptor class if d getClass type return type cast d return null public Descriptor SecurityRealm getSecurityRealms String shortClassName return findDescriptor shortClassName SecurityRealm all private T extends Describable T Descriptor T findDescriptor String shortClassName Collection extends Descriptor T descriptors String name shortClassName for Descriptor T d descriptors if d clazz getName endsWith name return d return null protected void updateComputerList updateComputerList AUTOMATIC SLAVE LAUNCH Deprecated public CopyOnWriteList SCMListener getSCMListeners return scmListeners public Plugin getPlugin String shortName PluginWrapper p pluginManager getPlugin shortName if p null return null return p getPlugin SuppressWarnings unchecked public P extends Plugin P getPlugin Class P clazz PluginWrapper p pluginManager getPlugin clazz if p null return null return P p getPlugin public P extends Plugin List P getPlugins Class P clazz List P result new ArrayList P for PluginWrapper w pluginManager getPlugins clazz result add P w getPlugin return Collections unmodifiableList result public String getSystemMessage return systemMessage public Nonnull MarkupFormatter getMarkupFormatter MarkupFormatter f markupFormatter return f null f new EscapedMarkupFormatter public void setMarkupFormatter MarkupFormatter f this markupFormatter f public void setSystemMessage String message throws IOException this systemMessage message save public FederatedLoginService getFederatedLoginService String name for FederatedLoginService fls FederatedLoginService all if fls getUrlName equals name return fls return null public List FederatedLoginService getFederatedLoginServices return FederatedLoginService all public Launcher createLauncher TaskListener listener return new LocalLauncher listener decorateFor this public String getFullName return public String getFullDisplayName return public List Action getActions return actions Exported name jobs public List TopLevelItem getItems if authorizationStrategy instanceof AuthorizationStrategy Unsecured authorizationStrategy instanceof FullControlOnceLoggedInAuthorizationStrategy return new ArrayList items values List TopLevelItem viewableItems new ArrayList TopLevelItem for TopLevelItem item items values if item hasPermission Item READ viewableItems add item return viewableItems public Map String TopLevelItem getItemMap return Collections unmodifiableMap items public T List T getItems Class T type List T r new ArrayList T for TopLevelItem i getItems if type isInstance i r add type cast i return r public T extends Item List T getAllItems Class T type return Items getAllItems this type public List Item getAllItems return getAllItems Item class Deprecated public List Project getProjects return Util createSubList items values Project class public Collection String getJobNames List String names new ArrayList String for Job j getAllItems Job class names add j getFullName return names public List Action getViewActions return getActions public Collection String getTopLevelItemNames List String names new ArrayList String for TopLevelItem j items values names add j getName return names public View getView String name return viewGroupMixIn getView name Exported public Collection View getViews return viewGroupMixIn getViews Override public void addView View v throws IOException viewGroupMixIn addView v even if we want to offer this atomic operation CopyOnWriteArrayList offers no such operation public void setViews Collection View views throws IOException BulkChange bc new BulkChange this try this views clear for View v views addView v finally bc commit public boolean canDelete View view return viewGroupMixIn canDelete view public synchronized void deleteView View view throws IOException viewGroupMixIn deleteView view public void onViewRenamed View view String oldName String newName viewGroupMixIn onViewRenamed view oldName newName Exported public View getPrimaryView return viewGroupMixIn getPrimaryView public void setPrimaryView View v this primaryView v getViewName public ViewsTabBar getViewsTabBar return viewsTabBar public void setViewsTabBar ViewsTabBar viewsTabBar this viewsTabBar viewsTabBar public Jenkins getItemGroup return this public MyViewsTabBar getMyViewsTabBar return myViewsTabBar public void setMyViewsTabBar MyViewsTabBar myViewsTabBar this myViewsTabBar myViewsTabBar public boolean isUpgradedFromBefore VersionNumber v try return new VersionNumber version isOlderThan v catch IllegalArgumentException e fail to parse this version number return false public Computer getComputers Computer r computers values toArray new Computer computers size Arrays sort r new Comparator Computer Override public int compare Computer lhs Computer rhs if lhs getNode Jenkins this return 1 if rhs getNode Jenkins this return 1 return lhs getName compareTo rhs getName return r CLIResolver public CheckForNull Computer getComputer Argument required true metaVar NAME usage Node name Nonnull String name if name equals master name for Computer c computers values if c getName equals name return c return null public Label getLabel String expr if expr null return null expr hudson util QuotedStringTokenizer unquote expr while true Label l labels get expr if l null return l non existent try labels putIfAbsent expr Label parseExpression expr catch ANTLRException e laxly accept it as a single label atom for backward compatibility return getLabelAtom expr public Nullable LabelAtom getLabelAtom CheckForNull String name if name null return null while true Label l labels get name if l null return LabelAtom l non existent LabelAtom la new LabelAtom name if labels putIfAbsent name la null la load public Set Label getLabels Set Label r new TreeSet Label for Label l labels values if l isEmpty r add l return r public Set LabelAtom getLabelAtoms Set LabelAtom r new TreeSet LabelAtom for Label l labels values if l isEmpty l instanceof LabelAtom r add LabelAtom l return r public Queue getQueue return queue Override public String getDisplayName return Messages Hudson DisplayName public List JDK getJDKs return jdks Restricted NoExternalUse class public void setJDKs Collection extends JDK jdks this jdks new ArrayList JDK jdks public JDK getJDK String name if name null if only one JDK is configured default JDK should mean that JDK List JDK jdks getJDKs if jdks size 1 return jdks get 0 return null for JDK j getJDKs if j getName equals name return j return null public CheckForNull Node getNode String name return nodes getNode name public Cloud getCloud String name return clouds getByName name protected Map Node Computer getComputerMap return computers public List Node getNodes return nodes getNodes Restricted NoExternalUse class public Nodes getNodesObject TODO replace this with something better when we properly expose Nodes return nodes public void addNode Node n throws IOException nodes addNode n public void removeNode Nonnull Node n throws IOException nodes removeNode n public boolean updateNode Node n throws IOException return nodes updateNode n public void setNodes final List extends Node n throws IOException nodes setNodes n public DescribableList NodeProperty NodePropertyDescriptor getNodeProperties return nodeProperties public DescribableList NodeProperty NodePropertyDescriptor getGlobalNodeProperties return globalNodeProperties void trimLabels for Iterator Label itr labels values iterator itr hasNext Label l itr next resetLabel l if l isEmpty itr remove public AdministrativeMonitor getAdministrativeMonitor String id for AdministrativeMonitor m administrativeMonitors if m id equals id return m return null public NodeDescriptor getDescriptor return DescriptorImpl INSTANCE public static final class DescriptorImpl extends NodeDescriptor Extension public static final DescriptorImpl INSTANCE new DescriptorImpl Override public boolean isInstantiable return false public FormValidation doCheckNumExecutors QueryParameter String value return FormValidation validateNonNegativeInteger value public FormValidation doCheckRawBuildsDir QueryParameter String value do essentially what expandVariablesForDirectory does without an Item String replacedValue expandVariablesForDirectory value doCheckRawBuildsDir Marker foo Jenkins getInstance getRootDir getPath jobs doCheckRawBuildsDir Marker foo File replacedFile new File replacedValue if replacedFile isAbsolute return FormValidation error value does not resolve to an absolute path if replacedValue contains doCheckRawBuildsDir Marker return FormValidation error value does not contain ITEM FULL NAME or ITEM ROOTDIR cannot distinguish between projects if replacedValue contains doCheckRawBuildsDir Marker foo make sure platform can handle colon try File tmp File createTempFile Jenkins doCheckRawBuildsDir foo bar tmp delete catch IOException e return FormValidation error value contains ITEM FULLNAME but your system does not support it JENKINS 12251 Use ITEM FULL NAME instead File d new File replacedValue if d isDirectory if dir does not exist almost guaranteed need to make sure nearest existing ancestor can be written to d d getParentFile while d exists d d getParentFile if d canWrite return FormValidation error value does not exist and probably cannot be created return FormValidation ok to route descriptor FQCN xxx to getDescriptor FQCN xxx public Object getDynamic String token return Jenkins getInstance getDescriptor token public int getQuietPeriod return quietPeriod null quietPeriod 5 public void setQuietPeriod Integer quietPeriod throws IOException this quietPeriod quietPeriod save public int getScmCheckoutRetryCount return scmCheckoutRetryCount public void setScmCheckoutRetryCount int scmCheckoutRetryCount throws IOException this scmCheckoutRetryCount scmCheckoutRetryCount save Override public String getSearchUrl return Override public SearchIndexBuilder makeSearchIndex return super makeSearchIndex add configure config configure add manage add log add new CollectionSearchIndex TopLevelItem protected SearchItem get String key return getItemByFullName key TopLevelItem class protected Collection TopLevelItem all return getAllItems TopLevelItem class add getPrimaryView makeSearchIndex add new CollectionSearchIndex for computers protected Computer get String key return getComputer key protected Collection Computer all return computers values add new CollectionSearchIndex for users protected User get String key return User get key false protected Collection User all return User getAll add new CollectionSearchIndex for views protected View get String key return getView key protected Collection View all return views public String getUrlChildPrefix return job public Nullable String getRootUrl String url JenkinsLocationConfiguration get getUrl if url null return Util ensureEndsWith url StaplerRequest req Stapler getCurrentRequest if req null return getRootUrlFromRequest return null public boolean isRootUrlSecure String url getRootUrl return url null url startsWith https public Nonnull String getRootUrlFromRequest StaplerRequest req Stapler getCurrentRequest if req null throw new IllegalStateException cannot call getRootUrlFromRequest from outside a request handling thread StringBuilder buf new StringBuilder String scheme getXForwardedHeader req X Forwarded Proto req getScheme buf append scheme append String host getXForwardedHeader req X Forwarded Host req getServerName int index host indexOf int port req getServerPort if index 1 Almost everyone else except Nginx put the host and port in separate headers buf append host else Nginx uses the same spec as for the Host header i e hostanme port buf append host substring 0 index if index 1 host length try port Integer parseInt host substring index 1 catch NumberFormatException e ignore but if a user has configured Nginx with an X Forwarded Port that will win out String forwardedPort getXForwardedHeader req X Forwarded Port null if forwardedPort null try port Integer parseInt forwardedPort catch NumberFormatException e ignore if port https equals scheme 443 80 buf append append port buf append req getContextPath append return buf toString private static String getXForwardedHeader StaplerRequest req String header String defaultValue String value req getHeader header if value null int index value indexOf return index 1 value trim value substring 0 index trim return defaultValue public File getRootDir return root public FilePath getWorkspaceFor TopLevelItem item for WorkspaceLocator l WorkspaceLocator all FilePath workspace l locate item this if workspace null return workspace return new FilePath expandVariablesForDirectory workspaceDir item public File getBuildDirFor Job job return expandVariablesForDirectory buildsDir job private File expandVariablesForDirectory String base Item item return new File expandVariablesForDirectory base item getFullName item getRootDir getPath Restricted NoExternalUse class static String expandVariablesForDirectory String base String itemFullName String itemRootDir return Util replaceMacro base ImmutableMap of JENKINS HOME Jenkins getInstance getRootDir getPath ITEM ROOTDIR itemRootDir ITEM FULLNAME itemFullName legacy deprecated ITEM FULL NAME itemFullName replace safe see JENKINS 12251 public String getRawWorkspaceDir return workspaceDir public String getRawBuildsDir return buildsDir Restricted NoExternalUse class public void setRawBuildsDir String buildsDir this buildsDir buildsDir Override public Nonnull FilePath getRootPath return new FilePath getRootDir Override public FilePath createPath String absolutePath return new FilePath VirtualChannel null absolutePath public ClockDifference getClockDifference return ClockDifference ZERO Override public Callable ClockDifference IOException getClockDifferenceCallable return new MasterToSlaveCallable ClockDifference IOException public ClockDifference call throws IOException return new ClockDifference 0 public LogRecorderManager getLog checkPermission ADMINISTER return log Exported public boolean isUseSecurity return securityRealm SecurityRealm NO AUTHENTICATION authorizationStrategy AuthorizationStrategy UNSECURED public boolean isUseProjectNamingStrategy return projectNamingStrategy DefaultProjectNamingStrategy DEFAULT NAMING STRATEGY Exported public boolean isUseCrumbs return crumbIssuer null public SecurityMode getSecurity fix the variable so that this code works under concurrent modification to securityRealm SecurityRealm realm securityRealm if realm SecurityRealm NO AUTHENTICATION return SecurityMode UNSECURED if realm instanceof LegacySecurityRealm return SecurityMode LEGACY return SecurityMode SECURED public SecurityRealm getSecurityRealm return securityRealm public void setSecurityRealm SecurityRealm securityRealm if securityRealm null securityRealm SecurityRealm NO AUTHENTICATION this useSecurity true IdStrategy oldUserIdStrategy this securityRealm null securityRealm getUserIdStrategy don t trigger rekey on Jenkins load this securityRealm getUserIdStrategy this securityRealm securityRealm reset the filters and proxies for the new SecurityRealm try HudsonFilter filter HudsonFilter get servletContext if filter null Fix for 3069 This filter is not necessarily initialized before the servlets when HudsonFilter does come back it ll initialize itself LOGGER fine HudsonFilter has not yet been initialized Can t perform security setup for now else LOGGER fine HudsonFilter has been previously initialized Setting security up filter reset securityRealm LOGGER fine Security is now fully set up if oldUserIdStrategy equals this securityRealm getUserIdStrategy User rekey catch ServletException e for binary compatibility this method cannot throw a checked exception throw new AcegiSecurityException Failed to configure filter e public void setAuthorizationStrategy AuthorizationStrategy a if a null a AuthorizationStrategy UNSECURED useSecurity true authorizationStrategy a public boolean isDisableRememberMe return disableRememberMe public void setDisableRememberMe boolean disableRememberMe this disableRememberMe disableRememberMe public void disableSecurity useSecurity null setSecurityRealm SecurityRealm NO AUTHENTICATION authorizationStrategy AuthorizationStrategy UNSECURED public void setProjectNamingStrategy ProjectNamingStrategy ns if ns null ns DefaultProjectNamingStrategy DEFAULT NAMING STRATEGY projectNamingStrategy ns public Lifecycle getLifecycle return Lifecycle get public Injector getInjector return lookup Injector class SuppressWarnings unchecked public T ExtensionList T getExtensionList Class T extensionType return extensionLists get extensionType public ExtensionList getExtensionList String extensionType throws ClassNotFoundException return getExtensionList pluginManager uberClassLoader loadClass extensionType SuppressWarnings unchecked public T extends Describable T D extends Descriptor T DescriptorExtensionList T D getDescriptorList Class T type return descriptorLists get type public void refreshExtensions throws ExtensionRefreshException ExtensionList ExtensionFinder finders getExtensionList ExtensionFinder class for ExtensionFinder ef finders if ef isRefreshable throw new ExtensionRefreshException ef doesn t support refresh List ExtensionComponentSet fragments Lists newArrayList for ExtensionFinder ef finders fragments add ef refresh ExtensionComponentSet delta ExtensionComponentSet union fragments filtered if we find a new ExtensionFinder we need it to list up all the extension points as well List ExtensionComponent ExtensionFinder newFinders Lists newArrayList delta find ExtensionFinder class while newFinders isEmpty ExtensionFinder f newFinders remove newFinders size 1 getInstance ExtensionComponentSet ecs ExtensionComponentSet allOf f filtered newFinders addAll ecs find ExtensionFinder class delta ExtensionComponentSet union delta ecs for ExtensionList el extensionLists values el refresh delta for ExtensionList el descriptorLists values el refresh delta TODO we need some generalization here so that extension points can be notified when a refresh happens for ExtensionComponent RootAction ea delta find RootAction class Action a ea getInstance if actions contains a actions add a Override public ACL getACL return authorizationStrategy getRootACL public AuthorizationStrategy getAuthorizationStrategy return authorizationStrategy public ProjectNamingStrategy getProjectNamingStrategy return projectNamingStrategy null ProjectNamingStrategy DEFAULT NAMING STRATEGY projectNamingStrategy Exported public boolean isQuietingDown return isQuietingDown public boolean isTerminating return terminating public InitMilestone getInitLevel return initLevel public void setNumExecutors int n throws IOException if this numExecutors n this numExecutors n updateComputerList save Override public TopLevelItem getItem String name throws AccessDeniedException if name null return null TopLevelItem item items get name if item null return null if item hasPermission Item READ if item hasPermission Item DISCOVER throw new AccessDeniedException Please login to access job name return null return item public Item getItem String pathName ItemGroup context if context null context this if pathName null return null if pathName startsWith absolute return getItemByFullName pathName Object ctx context StringTokenizer tokens new StringTokenizer pathName while tokens hasMoreTokens String s tokens nextToken if s equals if ctx instanceof Item ctx Item ctx getParent continue ctx null can t go up further break if s equals continue if ctx instanceof ItemGroup ItemGroup g ItemGroup ctx Item i g getItem s if i null i hasPermission Item READ TODO consider DISCOVER ctx null can t go up further break ctx i else return null if ctx instanceof Item return Item ctx fall back to the classic interpretation return getItemByFullName pathName public final Item getItem String pathName Item context return getItem pathName context null context getParent null public final T extends Item T getItem String pathName ItemGroup context Nonnull Class T type Item r getItem pathName context if type isInstance r return type cast r return null public final T extends Item T getItem String pathName Item context Class T type return getItem pathName context null context getParent null type public File getRootDirFor TopLevelItem child return getRootDirFor child getName private File getRootDirFor String name return new File new File getRootDir jobs name public CheckForNull T extends Item T getItemByFullName String fullName Class T type throws AccessDeniedException StringTokenizer tokens new StringTokenizer fullName ItemGroup parent this if tokens hasMoreTokens return null for example empty full name while true Item item parent getItem tokens nextToken if tokens hasMoreTokens if type isInstance item return type cast item else return null if item instanceof ItemGroup return null this item can t have any children if item hasPermission Item READ return null TODO consider DISCOVER parent ItemGroup item public CheckForNull Item getItemByFullName String fullName return getItemByFullName fullName Item class public CheckForNull User getUser String name return User get name hasPermission ADMINISTER public synchronized TopLevelItem createProject TopLevelItemDescriptor type String name throws IOException return createProject type name true public synchronized TopLevelItem createProject TopLevelItemDescriptor type String name boolean notify throws IOException return itemGroupMixIn createProject type name notify public synchronized void putItem TopLevelItem item throws IOException InterruptedException String name item getName TopLevelItem old items get name if old item return noop checkPermission Item CREATE if old null old delete items put name item ItemListener fireOnCreated item public synchronized T extends TopLevelItem T createProject Class T type String name throws IOException return type cast createProject TopLevelItemDescriptor getDescriptor type name public void onRenamed TopLevelItem job String oldName String newName throws IOException items remove oldName items put newName job For compatibility with old views for View v views v onJobRenamed job oldName newName public void onDeleted TopLevelItem item throws IOException ItemListener fireOnDeleted item items remove item getName For compatibility with old views for View v views v onJobRenamed item item getName null Override public boolean canAdd TopLevelItem item return true Override synchronized public I extends TopLevelItem I add I item String name throws IOException IllegalArgumentException if items containsKey name throw new IllegalArgumentException already an item name items put name item return item Override public void remove TopLevelItem item throws IOException IllegalArgumentException items remove item getName public FingerprintMap getFingerprintMap return fingerprintMap if no finger print matches display not found page public Object getFingerprint String md5sum throws IOException Fingerprint r fingerprintMap get md5sum if r null return new NoFingerprintMatch md5sum else return r public Fingerprint getFingerprint String md5sum throws IOException return fingerprintMap get md5sum private XmlFile getConfigFile return new XmlFile XSTREAM new File root config xml public int getNumExecutors return numExecutors public Mode getMode return mode public void setMode Mode m throws IOException this mode m save public String getLabelString return fixNull label trim Override public void setLabelString String label throws IOException this label label save Override public LabelAtom getSelfLabel return getLabelAtom master public Computer createComputer return new Hudson MasterComputer private void loadConfig throws IOException XmlFile cfg getConfigFile if cfg exists reset some data that may not exist in the disk file so that we can take a proper compensation action later primaryView null views clear load from disk cfg unmarshal Jenkins this private synchronized TaskBuilder loadTasks throws IOException File projectsDir new File root jobs if projectsDir getCanonicalFile isDirectory projectsDir mkdirs if projectsDir exists throw new IOException projectsDir is not a directory throw new IOException Unable to create projectsDir nPermission issue Please create this directory manually File subdirs projectsDir listFiles final Set String loadedNames Collections synchronizedSet new HashSet String TaskGraphBuilder g new TaskGraphBuilder Handle loadJenkins g requires EXTENSIONS AUGMENTED attains JOB LOADED add Loading global config new Executable public void run Reactor session throws Exception loadConfig if we are loading old data that doesn t have this field if slaves null slaves isEmpty nodes isLegacy nodes setNodes slaves slaves null else nodes load clouds setOwner Jenkins this for final File subdir subdirs g requires loadJenkins attains JOB LOADED notFatal add Loading job subdir getName new Executable public void run Reactor session throws Exception if Items getConfigFile subdir exists Does not have job config file so it is not a jenkins job hence skip it return TopLevelItem item TopLevelItem Items load Jenkins this subdir items put item getName item loadedNames add item getName g requires JOB LOADED add Cleaning up old builds new Executable public void run Reactor reactor throws Exception anything we didn t load from disk throw them away doing this after loading from disk allows newly loaded items to inspect what already existed in memory in case of reloading retainAll doesn t work well because of CopyOnWriteMap implementation so remove one by one hopefully there shouldn t be too many of them for String name items keySet if loadedNames contains name items remove name g requires JOB LOADED add Finalizing set up new Executable public void run Reactor session throws Exception rebuildDependencyGraph recompute label objects populates the labels mapping for Node slave nodes getNodes Note that not all labels are visible until the agents have connected slave getAssignedLabels getAssignedLabels initialize views by inserting the default view if necessary this is both for clean Jenkins and for backward compatibility if views size 0 primaryView null View v new AllView Messages Hudson ViewName setViewOwner v views add 0 v primaryView v getViewName if useSecurity null useSecurity forced reset to the unsecure mode this works as an escape hatch for people who locked themselves out authorizationStrategy AuthorizationStrategy UNSECURED setSecurityRealm SecurityRealm NO AUTHENTICATION else read in old data that doesn t have the security field set if authorizationStrategy null if useSecurity null authorizationStrategy AuthorizationStrategy UNSECURED else authorizationStrategy new LegacyAuthorizationStrategy if securityRealm null if useSecurity null setSecurityRealm SecurityRealm NO AUTHENTICATION else setSecurityRealm new LegacySecurityRealm else force the set to proxy setSecurityRealm securityRealm Initialize the filter with the crumb issuer setCrumbIssuer crumbIssuer auto register root actions for Action a getExtensionList RootAction class if actions contains a actions add a return g public synchronized void save throws IOException if BulkChange contains this return getConfigFile write this SaveableListener fireOnChange this getConfigFile edu umd cs findbugs annotations SuppressFBWarnings ST WRITE TO STATIC FROM INSTANCE METHOD public void cleanUp if theInstance this theInstance null LOGGER log Level WARNING This instance is no longer the singleton ignoring cleanUp return synchronized Jenkins class if cleanUpStarted LOGGER log Level WARNING Jenkins cleanUp already started ignoring repeated cleanUp return cleanUpStarted true try LOGGER log Level INFO Stopping Jenkins final List Throwable errors new ArrayList fireBeforeShutdown errors cleanUpRunTerminators errors terminating true final Set Future pending cleanUpDisconnectComputers errors cleanUpShutdownUDPBroadcast errors cleanUpCloseDNSMulticast errors cleanUpInterruptReloadThread errors cleanUpShutdownTriggers errors cleanUpShutdownTimer errors cleanUpShutdownTcpSlaveAgent errors cleanUpShutdownPluginManager errors cleanUpPersistQueue errors cleanUpShutdownThreadPoolForLoad errors cleanUpAwaitDisconnects errors pending cleanUpPluginServletFilters errors cleanUpReleaseAllLoggers errors LOGGER log Level INFO Jenkins stopped if errors isEmpty StringBuilder message new StringBuilder Unexpected issues encountered during cleanUp Iterator Throwable iterator errors iterator message append iterator next getMessage while iterator hasNext message append message append iterator next getMessage iterator errors iterator RuntimeException exception new RuntimeException message toString iterator next while iterator hasNext exception addSuppressed iterator next throw exception finally theInstance null if JenkinsJVM isJenkinsJVM JenkinsJVMAccess setJenkinsJVM oldJenkinsJVM private void fireBeforeShutdown List Throwable errors LOGGER log Level FINE Notifying termination for ItemListener l ItemListener all try l onBeforeShutdown catch OutOfMemoryError e we should just propagate this no point trying to log throw e catch LinkageError e LOGGER log Level WARNING ItemListener l e getMessage e safe to ignore and continue for this one catch Throwable e LOGGER log Level WARNING ItemListener l e getMessage e save for later errors add e private void cleanUpRunTerminators List Throwable errors try final TerminatorFinder tf new TerminatorFinder pluginManager null pluginManager uberClassLoader Thread currentThread getContextClassLoader new Reactor tf execute new Executor Override public void execute Runnable command command run new ReactorListener final Level level Level parse Configuration getStringConfigParameter termLogLevel FINE public void onTaskStarted Task t LOGGER log level Started 0 InitReactorRunner getDisplayName t public void onTaskCompleted Task t LOGGER log level Completed 0 InitReactorRunner getDisplayName t public void onTaskFailed Task t Throwable err boolean fatal LOGGER log SEVERE Failed InitReactorRunner getDisplayName t err public void onAttained Milestone milestone Level lv level String s Attained milestone toString if milestone instanceof TermMilestone lv Level INFO noteworthy milestones at least while we debug problems further s milestone toString LOGGER log lv s catch InterruptedException ReactorException IOException e LOGGER log SEVERE Failed to execute termination e errors add e catch OutOfMemoryError e we should just propagate this no point trying to log throw e catch LinkageError e LOGGER log SEVERE Failed to execute termination e safe to ignore and continue for this one catch Throwable e LOGGER log SEVERE Failed to execute termination e save for later errors add e private Set Future cleanUpDisconnectComputers final List Throwable errors LOGGER log Level INFO Starting node disconnection final Set Future pending new HashSet Future JENKINS 28840 we know we will be interrupting all the Computers so get the Queue lock once for all Queue withLock new Runnable Override public void run for Computer c computers values try c interrupt killComputer c pending add c disconnect null catch OutOfMemoryError e we should just propagate this no point trying to log throw e catch LinkageError e LOGGER log Level WARNING Could not disconnect c e getMessage e safe to ignore and continue for this one catch Throwable e LOGGER log Level WARNING Could not disconnect c e getMessage e save for later errors add e return pending private void cleanUpShutdownUDPBroadcast List Throwable errors if udpBroadcastThread null LOGGER log Level FINE Shutting down 0 udpBroadcastThread getName try udpBroadcastThread shutdown catch OutOfMemoryError e we should just propagate this no point trying to log throw e catch LinkageError e LOGGER log SEVERE Failed to shutdown UDP Broadcast Thread e safe to ignore and continue for this one catch Throwable e LOGGER log SEVERE Failed to shutdown UDP Broadcast Thread e save for later errors add e private void cleanUpCloseDNSMulticast List Throwable errors if dnsMultiCast null LOGGER log Level FINE Closing DNS Multicast service try dnsMultiCast close catch OutOfMemoryError e we should just propagate this no point trying to log throw e catch LinkageError e LOGGER log SEVERE Failed to close DNS Multicast service e safe to ignore and continue for this one catch Throwable e LOGGER log SEVERE Failed to close DNS Multicast service e save for later errors add e private void cleanUpInterruptReloadThread List Throwable errors LOGGER log Level FINE Interrupting reload thread try interruptReloadThread catch SecurityException e LOGGER log WARNING Not permitted to interrupt reload thread e errors add e catch OutOfMemoryError e we should just propagate this no point trying to log throw e catch LinkageError e LOGGER log SEVERE Failed to interrupt reload thread e safe to ignore and continue for this one catch Throwable e LOGGER log SEVERE Failed to interrupt reload thread e save for later errors add e private void cleanUpShutdownTriggers List Throwable errors LOGGER log Level FINE Shutting down triggers try final java util Timer timer Trigger timer if timer null final CountDownLatch latch new CountDownLatch 1 timer schedule new TimerTask Override public void run timer cancel latch countDown 0 if latch await 10 TimeUnit SECONDS LOGGER log Level FINE Triggers shut down successfully else timer cancel LOGGER log Level INFO Gave up waiting for triggers to finish running Trigger timer null catch OutOfMemoryError e we should just propagate this no point trying to log throw e catch LinkageError e LOGGER log SEVERE Failed to shut down triggers e safe to ignore and continue for this one catch Throwable e LOGGER log SEVERE Failed to shut down triggers e save for later errors add e private void cleanUpShutdownTimer List Throwable errors LOGGER log Level FINE Shutting down timer try Timer shutdown catch SecurityException e LOGGER log WARNING Not permitted to shut down Timer e errors add e catch OutOfMemoryError e we should just propagate this no point trying to log throw e catch LinkageError e LOGGER log SEVERE Failed to shut down Timer e safe to ignore and continue for this one catch Throwable e LOGGER log SEVERE Failed to shut down Timer e save for later errors add e private void cleanUpShutdownTcpSlaveAgent List Throwable errors if tcpSlaveAgentListener null LOGGER log FINE Shutting down TCP IP slave agent listener try tcpSlaveAgentListener shutdown catch OutOfMemoryError e we should just propagate this no point trying to log throw e catch LinkageError e LOGGER log SEVERE Failed to shut down TCP IP slave agent listener e safe to ignore and continue for this one catch Throwable e LOGGER log SEVERE Failed to shut down TCP IP slave agent listener e save for later errors add e private void cleanUpShutdownPluginManager List Throwable errors if pluginManager null be defensive there could be some ugly timing related issues LOGGER log Level INFO Stopping plugin manager try pluginManager stop catch OutOfMemoryError e we should just propagate this no point trying to log throw e catch LinkageError e LOGGER log SEVERE Failed to stop plugin manager e safe to ignore and continue for this one catch Throwable e LOGGER log SEVERE Failed to stop plugin manager e save for later errors add e private void cleanUpPersistQueue List Throwable errors if getRootDir exists if we are aborting because we failed to create JENKINS HOME don t try to save Issue 536 LOGGER log Level INFO Persisting build queue try getQueue save catch OutOfMemoryError e we should just propagate this no point trying to log throw e catch LinkageError e LOGGER log SEVERE Failed to persist build queue e safe to ignore and continue for this one catch Throwable e LOGGER log SEVERE Failed to persist build queue e save for later errors add e private void cleanUpShutdownThreadPoolForLoad List Throwable errors LOGGER log FINE Shuting down Jenkins load thread pool try threadPoolForLoad shutdown catch SecurityException e LOGGER log WARNING Not permitted to shut down Jenkins load thread pool e errors add e catch OutOfMemoryError e we should just propagate this no point trying to log throw e catch LinkageError e LOGGER log SEVERE Failed to shut down Jenkins load thread pool e safe to ignore and continue for this one catch Throwable e LOGGER log SEVERE Failed to shut down Jenkins load thread pool e save for later errors add e private void cleanUpAwaitDisconnects List Throwable errors Set Future pending if pending isEmpty LOGGER log Level INFO Waiting for node disconnection completion for Future f pending try f get 10 TimeUnit SECONDS if clean up operation didn t complete in time we fail the test catch InterruptedException e Thread currentThread interrupt break someone wants us to die now quick catch ExecutionException e LOGGER log Level WARNING Failed to shut down remote computer connection cleanly e catch TimeoutException e LOGGER log Level WARNING Failed to shut down remote computer connection within 10 seconds e catch OutOfMemoryError e we should just propagate this no point trying to log throw e catch LinkageError e LOGGER log Level WARNING Failed to shut down remote computer connection e catch Throwable e LOGGER log Level SEVERE Unexpected error while waiting for remote computer connection disconnect e errors add e private void cleanUpPluginServletFilters List Throwable errors LOGGER log Level FINE Stopping filters try PluginServletFilter cleanUp catch OutOfMemoryError e we should just propagate this no point trying to log throw e catch LinkageError e LOGGER log SEVERE Failed to stop filters e safe to ignore and continue for this one catch Throwable e LOGGER log SEVERE Failed to stop filters e save for later errors add e private void cleanUpReleaseAllLoggers List Throwable errors LOGGER log Level FINE Releasing all loggers try LogFactory releaseAll catch OutOfMemoryError e we should just propagate this no point trying to log throw e catch LinkageError e LOGGER log SEVERE Failed to release all loggers e safe to ignore and continue for this one catch Throwable e LOGGER log SEVERE Failed to release all loggers e save for later errors add e public Object getDynamic String token for Action a getActions String url a getUrlName if url null continue if url equals token url equals token return a for Action a getManagementLinks if Objects equals a getUrlName token return a return null actions public synchronized void doConfigSubmit StaplerRequest req StaplerResponse rsp throws IOException ServletException FormException BulkChange bc new BulkChange this try checkPermission ADMINISTER JSONObject json req getSubmittedForm workspaceDir json getString rawWorkspaceDir buildsDir json getString rawBuildsDir systemMessage Util nullify req getParameter system message boolean result true for Descriptor d Functions getSortedDescriptorsForGlobalConfigUnclassified result configureDescriptor req json d version VERSION save updateComputerList if result FormApply success req getContextPath generateResponse req rsp null else FormApply success configure generateResponse req rsp null back to config finally bc commit public CrumbIssuer getCrumbIssuer return crumbIssuer public void setCrumbIssuer CrumbIssuer issuer crumbIssuer issuer public synchronized void doTestPost StaplerRequest req StaplerResponse rsp throws IOException ServletException rsp sendRedirect foo private boolean configureDescriptor StaplerRequest req JSONObject json Descriptor d throws FormException collapse the structure to remain backward compatible with the JSON structure before 1 String name d getJsonSafeClassName JSONObject js json has name json getJSONObject name new JSONObject if it doesn t have the property the method returns invalid null object json putAll js return d configure req js RequirePOST public synchronized void doConfigExecutorsSubmit StaplerRequest req StaplerResponse rsp throws IOException ServletException FormException checkPermission ADMINISTER BulkChange bc new BulkChange this try JSONObject json req getSubmittedForm MasterBuildConfiguration mbc MasterBuildConfiguration all get MasterBuildConfiguration class if mbc null mbc configure req json getNodeProperties rebuild req json optJSONObject nodeProperties NodeProperty all finally bc commit updateComputerList rsp sendRedirect req getContextPath toComputer getUrl back to the computer page RequirePOST public synchronized void doSubmitDescription StaplerRequest req StaplerResponse rsp throws IOException ServletException getPrimaryView doSubmitDescription req rsp RequirePOST TODO does not seem to work on either overload public synchronized HttpRedirect doQuietDown throws IOException try return doQuietDown false 0 catch InterruptedException e throw new AssertionError impossible RequirePOST public HttpRedirect doQuietDown QueryParameter boolean block QueryParameter int timeout throws InterruptedException IOException synchronized this checkPermission ADMINISTER isQuietingDown true if block long waitUntil timeout if timeout 0 waitUntil System currentTimeMillis while isQuietingDown timeout 0 System currentTimeMillis waitUntil RestartListener isAllReady Thread sleep 1000 return new HttpRedirect RequirePOST TODO the cancel link needs to be updated accordingly public synchronized HttpRedirect doCancelQuietDown checkPermission ADMINISTER isQuietingDown false getQueue scheduleMaintenance return new HttpRedirect public HttpResponse doToggleCollapse throws ServletException IOException final StaplerRequest request Stapler getCurrentRequest final String paneId request getParameter paneId PaneStatusProperties forCurrentUser toggleCollapsed paneId return HttpResponses forwardToPreviousPage public void doClassicThreadDump StaplerResponse rsp throws IOException ServletException rsp sendRedirect2 threadDump public Map String Map String String getAllThreadDumps throws IOException InterruptedException checkPermission ADMINISTER issue the requests all at once Map String Future Map String String future new HashMap String Future Map String String for Computer c getComputers try future put c getName RemotingDiagnostics getThreadDumpAsync c getChannel catch Exception e LOGGER info Failed to get thread dump for node c getName e getMessage if toComputer null future put master RemotingDiagnostics getThreadDumpAsync FilePath localChannel if the result isn t available in 5 sec ignore that this is a precaution against hang nodes long endTime System currentTimeMillis 5000 Map String Map String String r new HashMap String Map String String for Entry String Future Map String String e future entrySet try r put e getKey e getValue get endTime System currentTimeMillis TimeUnit MILLISECONDS catch Exception x StringWriter sw new StringWriter x printStackTrace new PrintWriter sw true r put e getKey Collections singletonMap Failed to retrieve thread dump sw toString return Collections unmodifiableSortedMap new TreeMap String Map String String r RequirePOST public synchronized TopLevelItem doCreateItem StaplerRequest req StaplerResponse rsp throws IOException ServletException return itemGroupMixIn createTopLevelItem req rsp public TopLevelItem createProjectFromXML String name InputStream xml throws IOException return itemGroupMixIn createProjectFromXML name xml SuppressWarnings unchecked public T extends TopLevelItem T copy T src String name throws IOException return itemGroupMixIn copy src name a little more convenient overloading that assumes the caller gives us the right type or else it will fail with ClassCastException public T extends AbstractProject T copy T src String name throws IOException return T copy TopLevelItem src name RequirePOST public synchronized void doCreateView StaplerRequest req StaplerResponse rsp throws IOException ServletException FormException checkPermission View CREATE addView View create req rsp this public static void checkGoodName String name throws Failure if name null name length 0 throw new Failure Messages Hudson NoName if equals name trim throw new Failure Messages Jenkins NotAllowedName if equals name trim throw new Failure Messages Jenkins NotAllowedName for int i 0 i name length i char ch name charAt i if Character isISOControl ch throw new Failure Messages Hudson ControlCodeNotAllowed toPrintableName name if indexOf ch 1 throw new Failure Messages Hudson UnsafeChar ch looks good private static String toPrintableName String name StringBuilder printableName new StringBuilder for int i 0 i name length i char ch name charAt i if Character isISOControl ch printableName append u append int ch append else printableName append ch return printableName toString public void doSecured StaplerRequest req StaplerResponse rsp throws IOException ServletException TODO fire something in SecurityListener seems to be used only for REST calls when LegacySecurityRealm is active if req getUserPrincipal null authentication must have failed rsp setStatus HttpServletResponse SC UNAUTHORIZED return the user is now authenticated so send him back to the target String path req getContextPath req getOriginalRestOfPath String q req getQueryString if q null path q rsp sendRedirect2 path public void doLoginEntry StaplerRequest req StaplerResponse rsp throws IOException if req getUserPrincipal null rsp sendRedirect2 noPrincipal return TODO fire something in SecurityListener String from req getParameter from if from null from startsWith from equals loginError rsp sendRedirect2 from I m bit uncomfortable letting users redircted to other sites make sure the URL falls into this domain return String url AbstractProcessingFilter obtainFullRequestUrl req if url null if the login redirect is initiated by Acegi this should send the user back to where s he was from rsp sendRedirect2 url return rsp sendRedirect2 public void doLogout StaplerRequest req StaplerResponse rsp throws IOException ServletException String user getAuthentication getName securityRealm doLogout req rsp SecurityListener fireLoggedOut user public Slave JnlpJar getJnlpJars String fileName return new Slave JnlpJar fileName public Slave JnlpJar doJnlpJars StaplerRequest req return new Slave JnlpJar req getRestOfPath substring 1 RequirePOST public synchronized HttpResponse doReload throws IOException checkPermission ADMINISTER LOGGER log Level WARNING Reloading Jenkins as requested by 0 getAuthentication getName engage loading UI and then run the actual task in a separate thread servletContext setAttribute app new HudsonIsLoading new Thread Jenkins config reload thread Override public void run try ACL impersonate ACL SYSTEM reload catch Exception e LOGGER log SEVERE Failed to reload Jenkins config e new JenkinsReloadFailed e publish servletContext root start return HttpResponses redirectViaContextPath public void reload throws IOException InterruptedException ReactorException queue save executeReactor null loadTasks Ensure we reached the final initialization state Log the error otherwise if initLevel InitMilestone COMPLETED LOGGER log SEVERE Jenkins initialization has not reached the COMPLETED initialization milestone after the configuration reload Current state 0 It may cause undefined incorrect behavior in Jenkins plugin relying on this state It is likely an issue with the Initialization task graph Example usage of Initializer after InitMilestone COMPLETED in a plugin JENKINS 37759 Please create a bug in Jenkins bugtracker initLevel User reload queue load servletContext setAttribute app this public void doDoFingerprintCheck StaplerRequest req StaplerResponse rsp throws IOException ServletException Parse the request MultipartFormDataParser p new MultipartFormDataParser req if isUseCrumbs getCrumbIssuer validateCrumb req p rsp sendError HttpServletResponse SC FORBIDDEN No crumb found try rsp sendRedirect2 req getContextPath fingerprint Util getDigestOf p getFileItem name getInputStream finally p cleanUp edu umd cs findbugs annotations SuppressFBWarnings DM GC RequirePOST public void doGc StaplerResponse rsp throws IOException checkPermission Jenkins ADMINISTER System gc rsp setStatus HttpServletResponse SC OK rsp setContentType text plain rsp getWriter println GCed public void doException throw new RuntimeException public ContextMenu doContextMenu StaplerRequest request StaplerResponse response throws IOException JellyException ContextMenu menu new ContextMenu from this request response for MenuItem i menu items if i url equals request getContextPath manage add Manage Jenkins subitems i subMenu new ContextMenu from this request response manage return menu public ContextMenu doChildrenContextMenu StaplerRequest request StaplerResponse response throws Exception ContextMenu menu new ContextMenu for View view getViews menu add view getViewUrl view getDisplayName return menu public HeapDump getHeapDump throws IOException return new HeapDump this FilePath localChannel RequirePOST public void doSimulateOutOfMemory throws IOException checkPermission ADMINISTER System out println Creating artificial OutOfMemoryError situation List Object args new ArrayList Object while true args add new byte 1024 1024 public DirectoryBrowserSupport doUserContent return new DirectoryBrowserSupport this getRootPath child userContent User content folder png true CLIMethod name restart public void doRestart StaplerRequest req StaplerResponse rsp throws IOException ServletException RestartNotSupportedException checkPermission ADMINISTER if req null req getMethod equals GET req getView this restart jelly forward req rsp return restart if rsp null null for CLI rsp sendRedirect2 CLIMethod name safe restart public HttpResponse doSafeRestart StaplerRequest req throws IOException ServletException RestartNotSupportedException checkPermission ADMINISTER if req null req getMethod equals GET return HttpResponses forwardToView this safeRestart jelly safeRestart return HttpResponses redirectToDot public void restart throws RestartNotSupportedException final Lifecycle lifecycle Lifecycle get lifecycle verifyRestartable verify that Jenkins is restartable servletContext setAttribute app new HudsonIsRestarting new Thread restart thread final String exitUser getAuthentication getName Override public void run try ACL impersonate ACL SYSTEM give some time for the browser to load the reloading page Thread sleep 5000 LOGGER severe String format Restarting VM as requested by s exitUser for RestartListener listener RestartListener all listener onRestart lifecycle restart catch InterruptedException IOException e LOGGER log Level WARNING Failed to restart Jenkins e start public void safeRestart throws RestartNotSupportedException final Lifecycle lifecycle Lifecycle get lifecycle verifyRestartable verify that Jenkins is restartable Quiet down so that we won t launch new builds isQuietingDown true new Thread safe restart thread final String exitUser getAuthentication getName Override public void run try ACL impersonate ACL SYSTEM Wait til we have no active executors doQuietDown true 0 Make sure isQuietingDown is still true if isQuietingDown servletContext setAttribute app new HudsonIsRestarting give some time for the browser to load the reloading page LOGGER info Restart in 10 seconds Thread sleep 10000 LOGGER severe String format Restarting VM as requested by s exitUser for RestartListener listener RestartListener all listener onRestart lifecycle restart else LOGGER info Safe restart mode cancelled catch Throwable e LOGGER log Level WARNING Failed to restart Jenkins e start Extension Restricted NoExternalUse class public static class MasterRestartNotifyier extends RestartListener Override public void onRestart Computer computer Jenkins getInstance toComputer if computer null return RestartCause cause new RestartCause for ComputerListener listener ComputerListener all listener onOffline computer cause Override public boolean isReadyToRestart throws IOException InterruptedException return true private static class RestartCause extends OfflineCause SimpleOfflineCause protected RestartCause super Messages Jenkins IsRestarting CLIMethod name shutdown RequirePOST public void doExit StaplerRequest req StaplerResponse rsp throws IOException checkPermission ADMINISTER LOGGER severe String format Shutting down VM as requested by s from s getAuthentication getName req null req getRemoteAddr if rsp null rsp setStatus HttpServletResponse SC OK rsp setContentType text plain try PrintWriter w rsp getWriter w println Shutting down System exit 0 CLIMethod name safe shutdown RequirePOST public HttpResponse doSafeExit StaplerRequest req throws IOException checkPermission ADMINISTER isQuietingDown true final String exitUser getAuthentication getName final String exitAddr req null req getRemoteAddr unknown new Thread safe exit thread Override public void run try ACL impersonate ACL SYSTEM LOGGER severe String format Shutting down VM as requested by s from s exitUser exitAddr Wait til we have no active executors doQuietDown true 0 Make sure isQuietingDown is still true if isQuietingDown cleanUp System exit 0 catch Exception e LOGGER log Level WARNING Failed to shut down Jenkins e start return HttpResponses plainText Shutting down as soon as all jobs are complete public static Nonnull Authentication getAuthentication Authentication a SecurityContextHolder getContext getAuthentication on Tomcat while serving the login page this is null despite the fact that we have filters Looking at the stack trace Tomcat doesn t seem to run the request through filters when this is the login request see http www nabble com Matrix authorization problem tp14602081p14886312 html if a null a ANONYMOUS return a public void doScript StaplerRequest req StaplerResponse rsp throws IOException ServletException doScript req rsp req getView this script jelly FilePath localChannel getACL public void doScriptText StaplerRequest req StaplerResponse rsp throws IOException ServletException doScript req rsp req getView this scriptText jelly FilePath localChannel getACL public static void doScript StaplerRequest req StaplerResponse rsp RequestDispatcher view VirtualChannel channel ACL acl throws IOException ServletException ability to run arbitrary script is dangerous acl checkPermission RUN SCRIPTS String text req getParameter script if text null if POST equals req getMethod throw HttpResponses error HttpURLConnection HTTP BAD METHOD requires POST if channel null throw HttpResponses error HttpURLConnection HTTP NOT FOUND Node is offline try req setAttribute output RemotingDiagnostics executeGroovy text channel catch InterruptedException e throw new ServletException e view forward req rsp RequirePOST public void doEval StaplerRequest req StaplerResponse rsp throws IOException ServletException checkPermission RUN SCRIPTS try MetaClass mc WebApp getCurrent getMetaClass getClass Script script mc classLoader loadTearOff JellyClassLoaderTearOff class createContext compileScript new InputSource req getReader new JellyRequestDispatcher this script forward req rsp catch JellyException e throw new ServletException e public void doSignup StaplerRequest req StaplerResponse rsp throws IOException ServletException if getSecurityRealm allowsSignup req getView getSecurityRealm signup jelly forward req rsp return req getView SecurityRealm class signup jelly forward req rsp public void doIconSize StaplerRequest req StaplerResponse rsp throws IOException ServletException String qs req getQueryString if qs null throw new ServletException Cookie cookie new Cookie iconSize Functions validateIconSize qs cookie setMaxAge 9999999 762 rsp addCookie cookie String ref req getHeader Referer if ref null ref rsp sendRedirect2 ref RequirePOST public void doFingerprintCleanup StaplerResponse rsp throws IOException FingerprintCleanupThread invoke rsp setStatus HttpServletResponse SC OK rsp setContentType text plain rsp getWriter println Invoked RequirePOST public void doWorkspaceCleanup StaplerResponse rsp throws IOException WorkspaceCleanupThread invoke rsp setStatus HttpServletResponse SC OK rsp setContentType text plain rsp getWriter println Invoked public FormValidation doDefaultJDKCheck StaplerRequest request QueryParameter String value if JDK isDefaultName value assume the user configured named ones properly in system config or else system config should have reported form field validation errors return FormValidation ok default JDK selected Does such java really exist if JDK isDefaultJDKValid Jenkins this return FormValidation ok else return FormValidation errorWithMarkup Messages Hudson NoJavaInPath request getContextPath public FormValidation doCheckViewName QueryParameter String value checkPermission View CREATE String name fixEmpty value if name null return FormValidation ok already exists if getView name null return FormValidation error Messages Hudson ViewAlreadyExists name good view name try checkGoodName name catch Failure e return FormValidation error e getMessage return FormValidation ok Deprecated public FormValidation doViewExistsCheck QueryParameter String value checkPermission View CREATE String view fixEmpty value if view null return FormValidation ok if getView view null return FormValidation ok else return FormValidation error Messages Hudson ViewAlreadyExists view public void doResources StaplerRequest req StaplerResponse rsp throws IOException ServletException String path req getRestOfPath cut off the portion of resources path to file as this is only used to make path unique which in turn allows us to set a long expiration date path path substring path indexOf 1 1 int idx path lastIndexOf String extension path substring idx 1 if ALLOWED RESOURCE EXTENSIONS contains extension URL url pluginManager uberClassLoader getResource path if url null long expires MetaClass NO CACHE 0 365L 24 60 60 1000 rsp serveFile req url expires return rsp sendError HttpServletResponse SC NOT FOUND public static final Set String ALLOWED RESOURCE EXTENSIONS new HashSet String Arrays asList js css jpeg jpg png gif html htm split public FormValidation doCheckURIEncoding StaplerRequest request throws IOException expected is non ASCII String final String expected u57f7 u4e8b final String value fixEmpty request getParameter value if expected equals value return FormValidation warningWithMarkup Messages Hudson NotUsesUTF8ToDecodeURL return FormValidation ok public static boolean isCheckURIEncodingEnabled return ISO 8859 1 equalsIgnoreCase System getProperty file encoding public void rebuildDependencyGraph DependencyGraph graph new DependencyGraph graph build volatile acts a as a memory barrier here and therefore guarantees that graph is fully build before it s visible to other threads dependencyGraph graph dependencyGraphDirty set false public Future DependencyGraph rebuildDependencyGraphAsync dependencyGraphDirty set true return Timer get schedule new java util concurrent Callable DependencyGraph Override public DependencyGraph call throws Exception if dependencyGraphDirty get rebuildDependencyGraph return dependencyGraph 500 TimeUnit MILLISECONDS public DependencyGraph getDependencyGraph return dependencyGraph for Jelly public List ManagementLink getManagementLinks return ManagementLink all Restricted NoExternalUse class public SetupWizard getSetupWizard return setupWizard public User getMe User u User current if u null throw new AccessDeniedException me is not available when not logged in return u public List Widget getWidgets return widgets public Object getTarget try checkPermission READ catch AccessDeniedException e String rest Stapler getCurrentRequest getRestOfPath for String name ALWAYS READABLE PATHS if rest startsWith name return this for String name getUnprotectedRootActions if rest startsWith name rest equals name return this TODO SlaveComputer doSlaveAgentJnlp there should be an annotation to request unprotected access if rest matches computer slave agent jnlp true equals Stapler getCurrentRequest getParameter encrypt return this throw e return this public Collection String getUnprotectedRootActions Set String names new TreeSet String names add jnlpJars TODO cleaner to refactor doJnlpJars into a URA TODO consider caching expiring cache when actions changes for Action a getActions if a instanceof UnprotectedRootAction String url a getUrlName if url null continue names add url return names public View getStaplerFallback return getPrimaryView boolean isDisplayNameUnique String displayName String currentJobName Collection TopLevelItem itemCollection items values if there are a lot of projects we ll have to store their display names in a HashSet or something for a quick check for TopLevelItem item itemCollection if item getName equals currentJobName we won t compare the candidate displayName against the current item This is to prevent an validation warning if the user sets the displayName to what the existing display name is continue else if displayName equals item getDisplayName return false return true boolean isNameUnique String name String currentJobName Item item getItem name if null item the candidate name didn t return any items so the name is unique return true else if item getName equals currentJobName the candidate name returned an item but the item is the item that the user is configuring so this is ok return true else the candidate name returned an item so it is not unique return false public FormValidation doCheckDisplayName QueryParameter String displayName QueryParameter String jobName displayName displayName trim if LOGGER isLoggable Level FINE LOGGER log Level FINE Current job name is jobName if isNameUnique displayName jobName return FormValidation warning Messages Jenkins CheckDisplayName NameNotUniqueWarning displayName else if isDisplayNameUnique displayName jobName return FormValidation warning Messages Jenkins CheckDisplayName DisplayNameNotUniqueWarning displayName else return FormValidation ok public static class MasterComputer extends Computer protected MasterComputer super Jenkins getInstance Override public String getName return Override public boolean isConnecting return false Override public String getDisplayName return Messages Hudson Computer DisplayName Override public String getCaption return Messages Hudson Computer Caption Override public String getUrl return computer master public RetentionStrategy getRetentionStrategy return RetentionStrategy NOOP Override protected boolean isAlive return true Override public Boolean isUnix return Functions isWindows Override public HttpResponse doDoDelete throws IOException throw HttpResponses status SC BAD REQUEST Override public void doConfigSubmit StaplerRequest req StaplerResponse rsp throws IOException ServletException FormException Jenkins getInstance doConfigExecutorsSubmit req rsp WebMethod name config xml Override public void doConfigDotXml StaplerRequest req StaplerResponse rsp throws IOException ServletException throw HttpResponses status SC BAD REQUEST Override public boolean hasPermission Permission permission no one should be allowed to delete the master this hides the delete link from the computer master page if permission Computer DELETE return false Configuration of master node requires ADMINISTER permission return super hasPermission permission Computer CONFIGURE Jenkins ADMINISTER permission Override public VirtualChannel getChannel return FilePath localChannel Override public Charset getDefaultCharset return Charset defaultCharset public List LogRecord getLogRecords throws IOException InterruptedException return logRecords RequirePOST public void doLaunchSlaveAgent StaplerRequest req StaplerResponse rsp throws IOException ServletException this computer never returns null from channel so this method shall never be invoked rsp sendError SC NOT FOUND protected Future connect boolean forceReconnect return Futures precomputed null Deprecated public static final LocalChannel localChannel FilePath localChannel public static CheckForNull T T lookup Class T type Jenkins j Jenkins getInstanceOrNull return j null j lookup get type null public static List LogRecord logRecords Collections emptyList initialized to dummy value to avoid NPE public static final XStream XSTREAM public static final XStream2 XSTREAM2 private static final int TWICE CPU NUM Math max 4 Runtime getRuntime availableProcessors 2 transient final ExecutorService threadPoolForLoad new ThreadPoolExecutor TWICE CPU NUM TWICE CPU NUM 5L TimeUnit SECONDS new LinkedBlockingQueue Runnable new NamingThreadFactory new DaemonThreadFactory Jenkins load private static void computeVersion ServletContext context set the version Properties props new Properties InputStream is null try is Jenkins class getResourceAsStream jenkins version properties if is null props load is catch IOException e e printStackTrace if the version properties is missing that s OK finally IOUtils closeQuietly is String ver props getProperty version if ver null ver UNCOMPUTED VERSION if Main isDevelopmentMode build version equals ver in dev mode unable to get version ahem Eclipse try File dir new File getAbsoluteFile while dir null File pom new File dir pom xml if pom exists pom equals XMLUtils getValue project artifactId pom pom pom getCanonicalFile LOGGER info Reading version from pom getAbsolutePath ver XMLUtils getValue project version pom break dir dir getParentFile LOGGER info Jenkins is in dev mode using version ver catch Exception e LOGGER log Level WARNING Unable to read Jenkins version e getMessage e VERSION ver context setAttribute version ver VERSION HASH Util getDigestOf ver substring 0 8 SESSION HASH Util getDigestOf ver System currentTimeMillis substring 0 8 if ver equals UNCOMPUTED VERSION SystemProperties getBoolean hudson script noCache RESOURCE PATH else RESOURCE PATH static SESSION HASH VIEW RESOURCE PATH resources SESSION HASH Restricted NoExternalUse class public static final String UNCOMPUTED VERSION public static String VERSION UNCOMPUTED VERSION public CheckForNull static VersionNumber getVersion return toVersion VERSION Restricted NoExternalUse class public CheckForNull static VersionNumber getStoredVersion return toVersion Jenkins getActiveInstance version private static CheckForNull VersionNumber toVersion CheckForNull String versionString if versionString null return null try return new VersionNumber versionString catch NumberFormatException e try for non released version of Jenkins this looks like 1 345 private foobar so try to approximate int idx versionString indexOf if idx 0 return new VersionNumber versionString substring 0 idx catch NumberFormatException fall through totally unparseable return null catch IllegalArgumentException e totally unparseable return null public static String VERSION HASH public static String SESSION HASH public static String RESOURCE PATH public static String VIEW RESOURCE PATH resources TBD public static boolean PARALLEL LOAD Configuration getBooleanConfigParameter parallelLoad true public static boolean KILL AFTER LOAD Configuration getBooleanConfigParameter killAfterLoad false Deprecated public static boolean FLYWEIGHT SUPPORT true Restricted NoExternalUse class Deprecated public static boolean CONCURRENT BUILD true private static final String WORKSPACE DIRNAME Configuration getStringConfigParameter workspaceDirName workspace public static boolean AUTOMATIC SLAVE LAUNCH true private static final Logger LOGGER Logger getLogger Jenkins class getName public static final PermissionGroup PERMISSIONS Permission HUDSON PERMISSIONS public static final Permission ADMINISTER Permission HUDSON ADMINISTER public static final Permission READ new Permission PERMISSIONS Read Messages Hudson ReadPermission Description Permission READ PermissionScope JENKINS public static final Permission RUN SCRIPTS new Permission PERMISSIONS RunScripts Messages Hudson RunScriptsPermission Description ADMINISTER PermissionScope JENKINS private static final ImmutableSet String ALWAYS READABLE PATHS ImmutableSet of login logout accessDenied adjuncts error oops signup tcpSlaveAgentListener federatedLoginService securityRealm instance identity public static final Authentication ANONYMOUS static try ANONYMOUS new AnonymousAuthenticationToken anonymous anonymous new GrantedAuthority new GrantedAuthorityImpl anonymous XSTREAM XSTREAM2 new XStream2 XSTREAM alias jenkins Jenkins class XSTREAM alias slave DumbSlave class XSTREAM alias jdk JDK class for backward compatibility with 1 75 recognize the tag name view as well XSTREAM alias view ListView class XSTREAM alias listView ListView class XSTREAM addImplicitCollection Jenkins class disabledAgentProtocols disabledAgentProtocol String class XSTREAM addImplicitCollection Jenkins class enabledAgentProtocols enabledAgentProtocol String class XSTREAM2 addCriticalField Jenkins class securityRealm XSTREAM2 addCriticalField Jenkins class authorizationStrategy this seems to be necessary to force registration of converter early enough Mode class getEnumConstants double check that initialization order didn t do any harm assert PERMISSIONS null assert ADMINISTER null catch RuntimeException Error e when loaded on an agent and this fails subsequent NoClassDefFoundError will fail to chain the cause see http bugs java com bugdatabase view bug do bug id 8051847 As we don t know where the first exception will go let s also send this to logging so that we have a known place to look at LOGGER log SEVERE Failed to load Jenkins class e throw e private static final class JenkinsJVMAccess extends JenkinsJVM private static void setJenkinsJVM boolean jenkinsJVM JenkinsJVM setJenkinsJVM jenkinsJVMpackage jenkins import jenkins util HttpSessionListener import org kohsuke accmod Restricted import org kohsuke accmod restrictions NoExternalUse import javax servlet http HttpSessionEvent import java util logging Level import java util logging Logger Restricted NoExternalUse class public final class JenkinsHttpSessionListener implements javax servlet http HttpSessionListener TODO Seems like classes like this should live in the war src java But that applies to a number of other classes too and it has never happened so will not do it with this class for now anyway private static final Logger LOGGER Logger getLogger JenkinsHttpSessionListener class getName Override public void sessionCreated HttpSessionEvent httpSessionEvent for HttpSessionListener listener HttpSessionListener all try listener sessionCreated httpSessionEvent catch Exception e LOGGER log Level SEVERE Error calling HttpSessionListener ExtensionPoint sessionCreated e Override public void sessionDestroyed HttpSessionEvent httpSessionEvent for HttpSessionListener listener HttpSessionListener all try listener sessionDestroyed httpSessionEvent catch Exception e LOGGER log Level SEVERE Error calling HttpSessionListener ExtensionPoint sessionDestroyed epackage jenkins util import hudson WebAppMain import javax servlet ServletContextEvent import jenkins model Jenkins import org kohsuke accmod Restricted import org kohsuke accmod restrictions NoExternalUse public class JenkinsJVM private static boolean jenkinsJVM Restricted NoExternalUse class protected JenkinsJVM throw new IllegalAccessError Utility class public static boolean isJenkinsJVM return jenkinsJVM public static void checkJenkinsJVM if isJenkinsJVM throw new IllegalStateException Not running on the Jenkins master JVM public static void checkNotJenkinsJVM if isJenkinsJVM throw new IllegalStateException Running on the Jenkins master JVM Restricted NoExternalUse class protected static void setJenkinsJVM boolean jenkinsJVM JenkinsJVM jenkinsJVM jenkinsJVMpackage jenkins model import hudson Extension import hudson Util import hudson XmlFile import hudson util FormValidation import hudson util XStream2 import org jenkinsci Symbol import org kohsuke stapler QueryParameter import javax mail internet AddressException import javax mail internet InternetAddress import javax servlet ServletContext import java io File import java io IOException import java lang reflect InvocationTargetException import java lang reflect Method import java util logging Level import java util logging Logger import static hudson Util fixNull import javax annotation CheckForNull import javax annotation Nonnull Extension Symbol location public class JenkinsLocationConfiguration extends GlobalConfiguration Deprecated private transient String hudsonUrl private String adminAddress private String jenkinsUrl just to suppress warnings private transient String charset useSsl public static CheckForNull JenkinsLocationConfiguration get return GlobalConfiguration all get JenkinsLocationConfiguration class public JenkinsLocationConfiguration load Override public synchronized void load for backward compatibility if we don t have our own data yet then load from Mailer XmlFile file getConfigFile if file exists XStream2 xs new XStream2 xs addCompatibilityAlias hudson tasks Mailer DescriptorImpl JenkinsLocationConfiguration class file new XmlFile xs new File Jenkins getInstance getRootDir hudson tasks Mailer xml if file exists try file unmarshal this if jenkinsUrl null jenkinsUrl hudsonUrl catch IOException e LOGGER log Level WARNING Failed to load file e else super load updateSecureSessionFlag public Nonnull String getAdminAddress String v adminAddress if v null v Messages Mailer Address Not Configured return v public void setAdminAddress CheckForNull String adminAddress String address Util nullify adminAddress if address null address startsWith address endsWith some users apparently quote the whole thing Don t know why anyone does this but it s a machine s job to forgive human mistake address address substring 1 address length 1 this adminAddress address save public CheckForNull String getUrl return jenkinsUrl public void setUrl CheckForNull String jenkinsUrl String url Util nullify jenkinsUrl if url null url endsWith url this jenkinsUrl url save updateSecureSessionFlag private void updateSecureSessionFlag try ServletContext context Jenkins getInstance servletContext Method m try m context getClass getMethod getSessionCookieConfig catch NoSuchMethodException x 3 0 LOGGER log Level FINE Failed to set secure cookie flag x return Object sessionCookieConfig m invoke context Class scc Class forName javax servlet SessionCookieConfig Method setSecure scc getMethod setSecure boolean class boolean v fixNull jenkinsUrl startsWith https setSecure invoke sessionCookieConfig v catch InvocationTargetException e if e getTargetException instanceof IllegalStateException servlet 3 0 spec seems to prohibit this from getting set at runtime though Winstone is happy to accept i see JENKINS 25019 return LOGGER log Level WARNING Failed to set secure cookie flag e catch Exception e LOGGER log Level WARNING Failed to set secure cookie flag e public FormValidation doCheckUrl QueryParameter String value if value startsWith http localhost return FormValidation warning Messages Mailer Localhost Error return FormValidation ok public FormValidation doCheckAdminAddress QueryParameter String value try new InternetAddress value return FormValidation ok catch AddressException e return FormValidation error e getMessage private static final Logger LOGGER Logger getLogger JenkinsLocationConfiguration class getNamepackage hudson util import org kohsuke accmod Restricted import org kohsuke accmod restrictions NoExternalUse public class JenkinsReloadFailed extends BootFailure Restricted NoExternalUse class Deprecated public final Throwable cause public JenkinsReloadFailed Throwable cause super cause this cause causepackage hudson util public class JNADoublyLoaded extends HudsonFailedToLoad public JNADoublyLoaded Throwable exception super exceptionpackage hudson util jna import hudson Util public class JnaException extends RuntimeException private final int errorCode public JnaException int errorCode super Win32 error errorCode Util getWin32ErrorMessage errorCode this errorCode errorCode public int getErrorCode return errorCodepackage jenkins slaves import hudson ExtensionList import hudson ExtensionPoint import hudson Util import hudson model Slave import java security SecureRandom import javax annotation Nonnull import org jenkinsci remoting engine JnlpClientDatabase import org jenkinsci remoting engine JnlpConnectionStateListener public abstract class JnlpAgentReceiver extends JnlpConnectionStateListener implements ExtensionPoint private static final SecureRandom secureRandom new SecureRandom public static final JnlpClientDatabase DATABASE new JnlpAgentDatabase public static ExtensionList JnlpAgentReceiver all return ExtensionList lookup JnlpAgentReceiver class public static boolean exists String clientName for JnlpAgentReceiver receiver all if receiver owns clientName return true return false protected abstract boolean owns String clientName public static String generateCookie byte cookie new byte 32 secureRandom nextBytes cookie return Util toHexString cookie private static class JnlpAgentDatabase extends JnlpClientDatabase Override public boolean exists String clientName return JnlpAgentReceiver exists clientName Override public String getSecretOf Nonnull String clientName return JnlpSlaveAgentProtocol SLAVE SECRET mac clientNamepackage hudson slaves import hudson Extension import hudson Util import hudson model Descriptor import hudson model DescriptorVisibilityFilter import hudson model TaskListener import javax annotation CheckForNull import javax annotation Nonnull import jenkins model Jenkins import org jenkinsci Symbol import org kohsuke stapler DataBoundConstructor public class JNLPLauncher extends ComputerLauncher public final String tunnel public final String vmargs DataBoundConstructor public JNLPLauncher String tunnel String vmargs this tunnel Util fixEmptyAndTrim tunnel this vmargs Util fixEmptyAndTrim vmargs public JNLPLauncher this null null Override public boolean isLaunchSupported return false Override public void launch SlaveComputer computer TaskListener listener do nothing as we cannot self start public static Descriptor ComputerLauncher DESCRIPTOR Extension Symbol jnlp public static class DescriptorImpl extends Descriptor ComputerLauncher public DescriptorImpl DESCRIPTOR this public String getDisplayName return Messages JNLPLauncher displayName Extension public static class DescriptorVisibilityFilterImpl extends DescriptorVisibilityFilter Override public boolean filter CheckForNull Object context Nonnull Descriptor descriptor return descriptor clazz JNLPLauncher class Jenkins getInstance getTcpSlaveAgentListener null Override public boolean filterType Nonnull Class contextClass Nonnull Descriptor descriptor return descriptor clazz JNLPLauncher class Jenkins getInstance getTcpSlaveAgentListener nullpackage jenkins slaves import hudson Extension import hudson ExtensionList import hudson Util import hudson model Computer import java io IOException import java net Socket import java util Collections import java util HashMap import java util logging Logger import javax annotation Nonnull import javax inject Inject import jenkins AgentProtocol import jenkins model Jenkins import jenkins security HMACConfidentialKey import org jenkinsci Symbol import org jenkinsci remoting engine JnlpClientDatabase import org jenkinsci remoting engine JnlpConnectionState import org jenkinsci remoting engine JnlpProtocol1Handler Extension Symbol jnlp public class JnlpSlaveAgentProtocol extends AgentProtocol private static final Logger LOGGER Logger getLogger JnlpSlaveAgentProtocol class getName public static final HMACConfidentialKey SLAVE SECRET new HMACConfidentialKey JnlpSlaveAgentProtocol class secret private NioChannelSelector hub private JnlpProtocol1Handler handler Inject public void setHub NioChannelSelector hub this hub hub this handler new JnlpProtocol1Handler JnlpAgentReceiver DATABASE Computer threadPoolForRemoting hub getHub true Override public boolean isOptIn return OPT IN Override public String getName return handler isEnabled handler getName null Override public String getDisplayName return Messages JnlpSlaveAgentProtocol displayName Override public void handle Socket socket throws IOException InterruptedException handler handle socket Collections singletonMap JnlpConnectionState COOKIE KEY JnlpAgentReceiver generateCookie ExtensionList lookup JnlpAgentReceiver class private static final boolean OPT IN static byte hash Util fromHexString Jenkins getInstance getLegacyInstanceId 0 OPT IN hash 10 0package jenkins slaves import hudson Extension import hudson ExtensionList import hudson model Computer import java io IOException import java net Socket import java util Collections import java util HashMap import javax annotation Nonnull import javax inject Inject import jenkins AgentProtocol import org jenkinsci Symbol import org jenkinsci remoting engine JnlpClientDatabase import org jenkinsci remoting engine JnlpConnectionState import org jenkinsci remoting engine JnlpProtocol2Handler Extension Symbol jnlp2 public class JnlpSlaveAgentProtocol2 extends AgentProtocol private NioChannelSelector hub private JnlpProtocol2Handler handler Inject public void setHub NioChannelSelector hub this hub hub this handler new JnlpProtocol2Handler JnlpAgentReceiver DATABASE Computer threadPoolForRemoting hub getHub true Override public String getName return handler isEnabled handler getName null Override public boolean isOptIn return false Override public String getDisplayName return Messages JnlpSlaveAgentProtocol2 displayName Override public void handle Socket socket throws IOException InterruptedException handler handle socket Collections singletonMap JnlpConnectionState COOKIE KEY JnlpAgentReceiver generateCookie ExtensionList lookup JnlpAgentReceiver classpackage jenkins slaves import edu umd cs findbugs annotations SuppressFBWarnings import hudson Extension import hudson ExtensionList import hudson Util import hudson model Computer import java io IOException import java net Socket import java util Collections import java util HashMap import javax annotation Nonnull import javax inject Inject import jenkins AgentProtocol import jenkins model Jenkins import jenkins util SystemProperties import org jenkinsci remoting engine JnlpClientDatabase import org jenkinsci remoting engine JnlpConnectionState import org jenkinsci remoting engine JnlpProtocol3Handler import org kohsuke accmod Restricted import org kohsuke accmod restrictions NoExternalUse Deprecated Extension public class JnlpSlaveAgentProtocol3 extends AgentProtocol private NioChannelSelector hub private JnlpProtocol3Handler handler Inject public void setHub NioChannelSelector hub this hub hub this handler new JnlpProtocol3Handler JnlpAgentReceiver DATABASE Computer threadPoolForRemoting hub getHub true Override public boolean isOptIn return ENABLED Override public String getName we only want to force the protocol off for users that have explicitly banned it via system property everyone on the A B test will just have the opt in flag toggled TODO strip all this out and hardcode OptIn TRUE once JENKINS 36871 is merged return forceEnabled Boolean FALSE handler getName null Override public String getDisplayName return Messages JnlpSlaveAgentProtocol3 displayName Override public void handle Socket socket throws IOException InterruptedException handler handle socket Collections singletonMap JnlpConnectionState COOKIE KEY JnlpAgentReceiver generateCookie ExtensionList lookup JnlpAgentReceiver class Restricted NoExternalUse class SuppressFBWarnings value MS SHOULD BE REFACTORED TO BE FINAL justification Part of the administrative API for System Groovy scripts public static boolean ENABLED private static final Boolean forceEnabled static forceEnabled SystemProperties optBoolean JnlpSlaveAgentProtocol3 class getName enabled if forceEnabled null ENABLED forceEnabled else byte hash Util fromHexString Jenkins getActiveInstance getLegacyInstanceId 0 ENABLED hash 10 0package jenkins slaves import hudson Extension import hudson ExtensionList import hudson model Computer import java io IOException import java net Socket import java security KeyManagementException import java security KeyStore import java security KeyStoreException import java security NoSuchAlgorithmException import java security UnrecoverableKeyException import java security cert CertificateException import java security cert X509Certificate import java security interfaces RSAPrivateKey import java util Collections import java util HashMap import java util concurrent ExecutionException import java util concurrent TimeUnit import java util logging Level import java util logging Logger import javax inject Inject import javax net ssl KeyManagerFactory import javax net ssl SSLContext import javax net ssl TrustManager import jenkins AgentProtocol import jenkins model identity InstanceIdentityProvider import org jenkinsci remoting engine JnlpConnectionState import org jenkinsci remoting engine JnlpProtocol4Handler import org jenkinsci remoting protocol IOHub import org jenkinsci remoting protocol cert PublicKeyMatchingX509ExtendedTrustManager Extension public class JnlpSlaveAgentProtocol4 extends AgentProtocol private static final Logger LOGGER Logger getLogger JnlpSlaveAgentProtocol4 class getName private final KeyStore keyStore private final TrustManager trustManager private IOHubProvider hub private JnlpProtocol4Handler handler private SSLContext sslContext public JnlpSlaveAgentProtocol4 throws KeyStoreException KeyManagementException IOException prepare our local identity and certificate X509Certificate identityCertificate InstanceIdentityProvider RSA getCertificate RSAPrivateKey privateKey InstanceIdentityProvider RSA getPrivateKey prepare our keyStore so we can provide our authentication keyStore KeyStore getInstance JKS char password password toCharArray try keyStore load null password catch IOException e throw new IllegalStateException Specification says this should not happen as we are not doing I O e catch NoSuchAlgorithmException CertificateException e throw new IllegalStateException Specification says this should not happen as we are not loading keys e keyStore setKeyEntry jenkins privateKey password new X509Certificate identityCertificate prepare our keyManagers to provide to the SSLContext KeyManagerFactory kmf try kmf KeyManagerFactory getInstance KeyManagerFactory getDefaultAlgorithm kmf init keyStore password catch NoSuchAlgorithmException e throw new IllegalStateException Specification says the default algorithm should exist e catch UnrecoverableKeyException e throw new IllegalStateException The key was just inserted with this exact password e prepare our trustManagers trustManager new PublicKeyMatchingX509ExtendedTrustManager false true TrustManager trustManagers trustManager prepare our SSLContext try sslContext SSLContext getInstance TLS catch NoSuchAlgorithmException e throw new IllegalStateException Java runtime specification requires support for TLS algorithm e sslContext init kmf getKeyManagers trustManagers null Inject public void setHub IOHubProvider hub this hub hub handler new JnlpProtocol4Handler JnlpAgentReceiver DATABASE Computer threadPoolForRemoting hub getHub sslContext false true Override public boolean isOptIn return true Override public String getDisplayName return Messages JnlpSlaveAgentProtocol4 displayName Override public String getName return handler getName Override public void handle Socket socket throws IOException InterruptedException try X509Certificate certificate X509Certificate keyStore getCertificate jenkins if certificate null certificate getNotAfter getTime System currentTimeMillis TimeUnit DAYS toMillis 1 LOGGER log Level INFO Updating 0 TLS certificate to retain validity getName X509Certificate identityCertificate InstanceIdentityProvider RSA getCertificate RSAPrivateKey privateKey InstanceIdentityProvider RSA getPrivateKey char password password toCharArray keyStore setKeyEntry jenkins privateKey password new X509Certificate identityCertificate catch KeyStoreException e LOGGER log Level FINEST Ignored e handler handle socket Collections singletonMap JnlpConnectionState COOKIE KEY JnlpAgentReceiver generateCookie ExtensionList lookup JnlpAgentReceiver classpackage jenkins slaves restarter import hudson Extension import hudson model Computer import hudson model TaskListener import hudson remoting Engine import hudson remoting EngineListener import hudson remoting EngineListenerAdapter import hudson remoting VirtualChannel import hudson slaves ComputerListener import jenkins model Jenkins MasterComputer import java io IOException import java io Serializable import java util ArrayList import java util Iterator import java util List import java util logging Logger import static java util logging Level import jenkins security MasterToSlaveCallable Extension public class JnlpSlaveRestarterInstaller extends ComputerListener implements Serializable Override public void onOnline final Computer c final TaskListener listener throws IOException InterruptedException MasterComputer threadPoolForRemoting submit new java util concurrent Callable Void Override public Void call throws Exception install c listener return null private void install Computer c TaskListener listener try final List SlaveRestarter restarters new ArrayList SlaveRestarter SlaveRestarter all VirtualChannel ch c getChannel if ch null return defensive check List SlaveRestarter effective ch call new MasterToSlaveCallable List SlaveRestarter IOException public List SlaveRestarter call throws IOException Engine e Engine current if e null return null not running under Engine try Engine class getMethod addListener EngineListener class catch NoSuchMethodException return null running with older version of remoting that doesn t support adding listener filter out ones that doesn t apply for Iterator SlaveRestarter itr restarters iterator itr hasNext SlaveRestarter r itr next if r canWork itr remove e addListener new EngineListenerAdapter Override public void onReconnect try for SlaveRestarter r restarters try LOGGER info Restarting agent via r r restart catch Exception x LOGGER log SEVERE Failed to restart agent with r x finally if we move on to the reconnection without restart don t let the current implementations kick in when the agent loses connection again restarters clear return restarters LOGGER log FINE Effective SlaveRestarter on 0 1 new Object c getName effective catch Throwable e e printStackTrace listener error Failed to install restarter private static final Logger LOGGER Logger getLogger JnlpSlaveRestarterInstaller class getName private static final long serialVersionUID 1Lpackage hudson model import com infradna tool bridge method injector WithBridgeMethods import hudson BulkChange import hudson EnvVars import hudson Extension import hudson ExtensionPoint import hudson PermalinkList import hudson Util import hudson cli declarative CLIResolver import hudson model Descriptor FormException import hudson model Fingerprint Range import hudson model Fingerprint RangeSet import hudson model PermalinkProjectAction Permalink import hudson model listeners ItemListener import hudson search QuickSilver import hudson search SearchIndex import hudson search SearchIndexBuilder import hudson search SearchItem import hudson search SearchItems import hudson security ACL import hudson tasks LogRotator import hudson util AlternativeUiTextProvider import hudson util ChartUtil import hudson util ColorPalette import hudson util CopyOnWriteList import hudson util DataSetBuilder import hudson util DescribableList import hudson util FormApply import hudson util Graph import hudson util ProcessTree import hudson util QuotedStringTokenizer import hudson util RunList import hudson util ShiftedCategoryAxis import hudson util StackedAreaRenderer2 import hudson util TextFile import hudson widgets HistoryWidget import hudson widgets HistoryWidget Adapter import hudson widgets Widget import java awt Color import java awt Paint import java io File import java io IOException import java net URLEncoder import java util ArrayList import java util Calendar import java util Collection import java util Collections import java util GregorianCalendar import java util LinkedList import java util List import java util Map import java util SortedMap import java util logging Level import java util logging Logger import javax annotation CheckForNull import javax annotation Nonnull import javax servlet ServletException import jenkins model BuildDiscarder import jenkins model BuildDiscarderProperty import jenkins model DirectlyModifiableTopLevelItemGroup import jenkins model Jenkins import jenkins model ModelObjectWithChildren import jenkins model ProjectNamingStrategy import jenkins model RunIdMigrator import jenkins model lazy LazyBuildMixIn import jenkins security HexStringConfidentialKey import jenkins util io OnMaster import net sf json JSONException import net sf json JSONObject import org apache commons io FileUtils import org jfree chart ChartFactory import org jfree chart JFreeChart import org jfree chart axis CategoryAxis import org jfree chart axis CategoryLabelPositions import org jfree chart axis NumberAxis import org jfree chart plot CategoryPlot import org jfree chart plot PlotOrientation import org jfree chart renderer category StackedAreaRenderer import org jfree data category CategoryDataset import org jfree ui RectangleInsets import org jvnet localizer Localizable import org kohsuke accmod Restricted import org kohsuke accmod restrictions NoExternalUse import org kohsuke args4j Argument import org kohsuke args4j CmdLineException import org kohsuke stapler StaplerOverridable import org kohsuke stapler StaplerRequest import org kohsuke stapler StaplerResponse import org kohsuke stapler export Exported import org kohsuke stapler interceptor RequirePOST import static javax servlet http HttpServletResponse SC BAD REQUEST import static javax servlet http HttpServletResponse SC NO CONTENT public abstract class Job JobT extends Job JobT RunT RunT extends Run JobT RunT extends AbstractItem implements ExtensionPoint StaplerOverridable ModelObjectWithChildren private static final Logger LOGGER Logger getLogger Job class getName protected transient volatile int nextBuildNumber 1 private transient volatile boolean holdOffBuildUntilSave private transient volatile boolean holdOffBuildUntilUserSave private volatile BuildDiscarder logRotator private transient Integer cachedBuildHealthReportsBuildNumber null private transient List HealthReport cachedBuildHealthReports null boolean keepDependencies this should have been DescribableList but now it s too late protected CopyOnWriteList JobProperty super JobT properties new CopyOnWriteList JobProperty super JobT Restricted NoExternalUse class public transient RunIdMigrator runIdMigrator protected Job ItemGroup parent String name super parent name Override public synchronized void save throws IOException super save holdOffBuildUntilSave holdOffBuildUntilUserSave Override public void onCreatedFromScratch super onCreatedFromScratch runIdMigrator new RunIdMigrator runIdMigrator created getBuildDir Override public void onLoad ItemGroup extends Item parent String name throws IOException super onLoad parent name File buildDir getBuildDir runIdMigrator new RunIdMigrator runIdMigrator migrate buildDir Jenkins getInstance getRootDir TextFile f getNextBuildNumberFile if f exists starting 1 28 we store nextBuildNumber in a separate file but old Hudson didn t do it so if the file doesn t exist assume that nextBuildNumber was read from config xml try synchronized this this nextBuildNumber Integer parseInt f readTrim catch NumberFormatException e LOGGER log Level WARNING Corruption in 0 1 new Object f e if this instanceof LazyBuildMixIn LazyLoadingJob allow LazyBuildMixIn onLoad to fix it else RunT lB getLastBuild synchronized this this nextBuildNumber lB null lB getNumber 1 1 saveNextBuildNumber else From the old Hudson or doCreateItem Create this file now saveNextBuildNumber if properties null didn t exist 1 72 properties new CopyOnWriteList JobProperty super JobT for JobProperty p properties p setOwner this Override public void onCopiedFrom Item src super onCopiedFrom src synchronized this this nextBuildNumber 1 reset the next build number this holdOffBuildUntilUserSave true this holdOffBuildUntilSave this holdOffBuildUntilUserSave Extension ordinal Double MAX VALUE public static class LastItemListener extends ItemListener Override public void onCopied Item src Item item If any of the other ItemListeners modify the job they effect a save which will clear the holdOffBuildUntilUserSave and causing a regression of JENKINS 2494 if item instanceof Job Job job Job item synchronized job job holdOffBuildUntilUserSave false Override protected void performDelete throws IOException InterruptedException if a build is in progress Cancel it RunT lb getLastBuild if lb null Executor e lb getExecutor if e null e interrupt should we block until the build is cancelled super performDelete TextFile getNextBuildNumberFile return new TextFile new File this getRootDir nextBuildNumber public synchronized boolean isHoldOffBuildUntilSave return holdOffBuildUntilSave protected synchronized void saveNextBuildNumber throws IOException if nextBuildNumber 0 3361 nextBuildNumber 1 getNextBuildNumberFile write String valueOf nextBuildNumber n Exported public boolean isInQueue return false Exported public Queue Item getQueueItem return null public boolean isBuilding RunT b getLastBuild return b null b isBuilding public boolean isLogUpdated RunT b getLastBuild return b null b isLogUpdated Override public String getPronoun return AlternativeUiTextProvider get PRONOUN this Messages Job Pronoun public boolean isNameEditable return true Exported public boolean isKeepDependencies return keepDependencies public synchronized int assignBuildNumber throws IOException int r nextBuildNumber saveNextBuildNumber return r Exported public int getNextBuildNumber return nextBuildNumber public EnvVars getCharacteristicEnvVars EnvVars env new EnvVars env put JENKINS SERVER COOKIE SERVER COOKIE get env put HUDSON SERVER COOKIE SERVER COOKIE get Legacy compatibility env put JOB NAME getFullName env put JOB BASE NAME getName return env public Nonnull EnvVars getEnvironment CheckForNull Node node Nonnull TaskListener listener throws IOException InterruptedException EnvVars env if node null final Computer computer node toComputer env computer null computer buildEnvironment listener new EnvVars else env new EnvVars env putAll getCharacteristicEnvVars servlet container may have set CLASSPATH in its launch script so don t let that inherit to the new child process see http www nabble com Run Job with JDK 1 4 2 tf4468601 html env put CLASSPATH apply them in a reverse order so that higher ordinal ones can modify values added by lower ordinal ones for EnvironmentContributor ec EnvironmentContributor all reverseView ec buildEnvironmentFor this env listener return env public synchronized void updateNextBuildNumber int next throws IOException RunT lb getLastBuild if lb null next lb getNumber next 0 this nextBuildNumber next saveNextBuildNumber public synchronized BuildDiscarder getBuildDiscarder BuildDiscarderProperty prop getProperty BuildDiscarderProperty class return prop null prop getStrategy logRotator public synchronized void setBuildDiscarder BuildDiscarder bd throws IOException try BulkChange bc new BulkChange this removeProperty BuildDiscarderProperty class if bd null addProperty new BuildDiscarderProperty bd bc commit Deprecated public LogRotator getLogRotator BuildDiscarder buildDiscarder getBuildDiscarder return buildDiscarder instanceof LogRotator LogRotator buildDiscarder null Deprecated public void setLogRotator LogRotator logRotator throws IOException setBuildDiscarder logRotator public void logRotate throws IOException InterruptedException BuildDiscarder bd getBuildDiscarder if bd null bd perform this public boolean supportsLogRotator return true Override protected SearchIndexBuilder makeSearchIndex return super makeSearchIndex add new SearchIndex public void find String token List SearchItem result try if token startsWith token token substring 1 ignore leading int n Integer parseInt token Run b getBuildByNumber n if b null return no such build result add SearchItems create n n b catch NumberFormatException e not a number public void suggest String token List SearchItem result find token result add configure config configure public Collection extends Job getAllJobs return Collections Job singleton this public void addProperty JobProperty super JobT jobProp throws IOException JobProperty jobProp setOwner this properties add jobProp save public void removeProperty JobProperty super JobT jobProp throws IOException properties remove jobProp save public T extends JobProperty T removeProperty Class T clazz throws IOException for JobProperty super JobT p properties if clazz isInstance p removeProperty p return clazz cast p return null SuppressWarnings unchecked rawtypes public Map JobPropertyDescriptor JobProperty super JobT getProperties Map result Descriptor toMap Iterable properties if logRotator null result put Jenkins getActiveInstance getDescriptorByType BuildDiscarderProperty DescriptorImpl class new BuildDiscarderProperty logRotator return result Exported name property inline true public List JobProperty super JobT getAllProperties return properties getView public T extends JobProperty T getProperty Class T clazz if clazz BuildDiscarderProperty class logRotator null return clazz cast new BuildDiscarderProperty logRotator return getProperty clazz private T extends JobProperty T getProperty Class T clazz for JobProperty p properties if clazz isInstance p return clazz cast p return null public JobProperty getProperty String className for JobProperty p properties if p getClass getName equals className return p return null public Collection getOverrides List Object r new ArrayList Object for JobProperty super JobT p properties r addAll p getJobOverrides return r public List Widget getWidgets ArrayList Widget r new ArrayList Widget r add createHistoryWidget return r protected HistoryWidget createHistoryWidget return new HistoryWidget Job RunT this getBuilds HISTORY ADAPTER public static final HistoryWidget Adapter Run HISTORY ADAPTER new Adapter Run public int compare Run record String key try int k Integer parseInt key return record getNumber k catch NumberFormatException nfe return String valueOf record getNumber compareTo key public String getKey Run record return String valueOf record getNumber public boolean isBuilding Run record return record isBuilding public String getNextKey String key try int k Integer parseInt key return String valueOf k 1 catch NumberFormatException nfe return unable to determine next key Override public void renameTo String newName throws IOException File oldBuildDir getBuildDir super renameTo newName File newBuildDir getBuildDir if oldBuildDir isDirectory newBuildDir isDirectory if newBuildDir getParentFile isDirectory newBuildDir getParentFile mkdirs if oldBuildDir renameTo newBuildDir throw new IOException failed to rename oldBuildDir to newBuildDir Override public void movedTo DirectlyModifiableTopLevelItemGroup destination AbstractItem newItem File destDir throws IOException Job newJob Job newItem Missing covariant parameters type here File oldBuildDir getBuildDir super movedTo destination newItem destDir File newBuildDir getBuildDir if oldBuildDir isDirectory FileUtils moveDirectory oldBuildDir newBuildDir Override public void delete throws IOException InterruptedException super delete Util deleteRecursive getBuildDir Exported public abstract boolean isBuildable Exported name allBuilds visibility 2 WithBridgeMethods List class public RunList RunT getBuilds return RunList RunT fromRuns getRuns values Exported name builds public RunList RunT getNewBuilds return getBuilds limit 100 public synchronized List RunT getBuilds RangeSet rs List RunT builds new LinkedList RunT for Range r rs getRanges for RunT b getNearestBuild r start b null b getNumber r end b b getNextBuild builds add b return builds public SortedMap Integer RunT getBuildsAsMap return Collections Integer RunT unmodifiableSortedMap getRuns public RunT getBuild String id for RunT r getRuns values if r getId equals id return r return null public RunT getBuildByNumber int n return getRuns get n WithBridgeMethods List class Deprecated public RunList RunT getBuildsByTimestamp long start long end return getBuilds byTimestamp start end CLIResolver public RunT getBuildForCLI Argument required true metaVar BUILD usage Build number String id throws CmdLineException try int n Integer parseInt id RunT r getBuildByNumber n if r null throw new CmdLineException null No such build n exists return r catch NumberFormatException e throw new CmdLineException null id is not a number public RunT getNearestBuild int n SortedMap Integer extends RunT m getRuns headMap n 1 the map should include n so n 1 if m isEmpty return null return m get m lastKey public RunT getNearestOldBuild int n SortedMap Integer extends RunT m getRuns tailMap n if m isEmpty return null return m get m firstKey Override public Object getDynamic String token StaplerRequest req StaplerResponse rsp try try to interpret the token as build number return getBuildByNumber Integer parseInt token catch NumberFormatException e try to map that to widgets for Widget w getWidgets if w getUrlName equals token return w is this a permalink for Permalink p getPermalinks if p getId equals token return p resolve this return super getDynamic token req rsp public File getBuildDir we use the null check variant so that people can write true unit tests with a mock ItemParent and without a JenkinsRule Such tests are of limited utility as there is a high risk of hitting some code that needs the singleton but for persistence migration test cases it makes sense to permit Jenkins j Jenkins getInstanceOrNull if j null return new File getRootDir builds return j getBuildDirFor this protected abstract SortedMap Integer extends RunT getRuns protected abstract void removeRun RunT run Exported QuickSilver public RunT getLastBuild SortedMap Integer extends RunT runs getRuns if runs isEmpty return null return runs get runs firstKey Exported QuickSilver public RunT getFirstBuild SortedMap Integer extends RunT runs getRuns if runs isEmpty return null return runs get runs lastKey Exported QuickSilver public RunT getLastSuccessfulBuild return RunT Permalink LAST SUCCESSFUL BUILD resolve this Exported QuickSilver public RunT getLastUnsuccessfulBuild return RunT Permalink LAST UNSUCCESSFUL BUILD resolve this Exported QuickSilver public RunT getLastUnstableBuild return RunT Permalink LAST UNSTABLE BUILD resolve this Exported QuickSilver public RunT getLastStableBuild return RunT Permalink LAST STABLE BUILD resolve this Exported QuickSilver public RunT getLastFailedBuild return RunT Permalink LAST FAILED BUILD resolve this Exported QuickSilver public RunT getLastCompletedBuild RunT r getLastBuild while r null r isBuilding r r getPreviousBuild return r public List RunT getLastBuildsOverThreshold int numberOfBuilds Result threshold List RunT result new ArrayList RunT numberOfBuilds RunT r getLastBuild while r null result size numberOfBuilds if r isBuilding r getResult null r getResult isBetterOrEqualTo threshold result add r r r getPreviousBuild return result SuppressWarnings unchecked protected List RunT getEstimatedDurationCandidates List RunT candidates new ArrayList RunT 3 RunT lastSuccessful getLastSuccessfulBuild int lastSuccessfulNumber 1 if lastSuccessful null candidates add lastSuccessful lastSuccessfulNumber lastSuccessful getNumber int i 0 RunT r getLastBuild List RunT fallbackCandidates new ArrayList RunT 3 while r null candidates size 3 i 6 if r isBuilding r getResult null r getNumber lastSuccessfulNumber Result result r getResult if result isBetterOrEqualTo Result UNSTABLE candidates add r else if result isCompleteBuild fallbackCandidates add r i r r getPreviousBuild while candidates size 3 if fallbackCandidates isEmpty break RunT run fallbackCandidates remove 0 candidates add run return candidates public long getEstimatedDuration List RunT builds getEstimatedDurationCandidates if builds isEmpty return 1 long totalDuration 0 for RunT b builds totalDuration b getDuration if totalDuration 0 return 1 return Math round double totalDuration builds size public PermalinkList getPermalinks TODO shall we cache this PermalinkList permalinks new PermalinkList Permalink BUILTIN for PermalinkProjectAction ppa getActions PermalinkProjectAction class permalinks addAll ppa getPermalinks return permalinks Override public ContextMenu doChildrenContextMenu StaplerRequest request StaplerResponse response throws Exception not sure what would be really useful here This needs more thoughts for the time being I m starting with permalinks ContextMenu menu new ContextMenu for Permalink p getPermalinks if p resolve this null menu add p getId p getDisplayName return menu Exported visibility 2 name color public BallColor getIconColor RunT lastBuild getLastBuild while lastBuild null lastBuild hasntStartedYet lastBuild lastBuild getPreviousBuild if lastBuild null return lastBuild getIconColor else return BallColor NOTBUILT public HealthReport getBuildHealth List HealthReport reports getBuildHealthReports return reports isEmpty new HealthReport reports get 0 Exported name healthReport public List HealthReport getBuildHealthReports List HealthReport reports new ArrayList HealthReport RunT lastBuild getLastBuild if lastBuild null lastBuild isBuilding show the previous build s report until the current one is finished building lastBuild lastBuild getPreviousBuild check the cache if cachedBuildHealthReportsBuildNumber null cachedBuildHealthReports null lastBuild null cachedBuildHealthReportsBuildNumber intValue lastBuild getNumber reports addAll cachedBuildHealthReports else if lastBuild null for HealthReportingAction healthReportingAction lastBuild getActions HealthReportingAction class final HealthReport report healthReportingAction getBuildHealth if report null if report isAggregateReport reports addAll report getAggregatedReports else reports add report final HealthReport report getBuildStabilityHealthReport if report null if report isAggregateReport reports addAll report getAggregatedReports else reports add report Collections sort reports store the cache cachedBuildHealthReportsBuildNumber lastBuild getNumber cachedBuildHealthReports new ArrayList HealthReport reports return reports private HealthReport getBuildStabilityHealthReport we can give a simple view of build health from the last five builds int failCount 0 int totalCount 0 RunT i getLastBuild RunT u getLastFailedBuild if i null u null no failures like ever return new HealthReport 100 Messages Job BuildStability Messages Job NoRecentBuildFailed if i null u getNumber i getNumber SortedMap Integer extends RunT runs getRuns if runs instanceof RunMap RunMap RunT runMap RunMap RunT runs for int index i getNumber index u getNumber totalCount 5 index if runMap runExists index totalCount if totalCount 5 start loading from the first failure as we counted the rest i u while totalCount 5 i null switch i getIconColor case BLUE case YELLOW failCount stays the same totalCount break case RED failCount totalCount break default do nothing as these are inconclusive statuses break i i getPreviousBuild if totalCount 0 int score int 100 0 totalCount failCount totalCount Localizable description if failCount 0 description Messages Job NoRecentBuildFailed else if totalCount failCount this should catch the case where totalCount 1 as failCount must be between 0 and totalCount and we can t get here if failCount 0 description Messages Job AllRecentBuildFailed else description Messages Job NOfMFailed failCount totalCount return new HealthReport score Messages Job BuildStability description return null actions RequirePOST public synchronized void doConfigSubmit StaplerRequest req StaplerResponse rsp throws IOException ServletException FormException checkPermission CONFIGURE description req getParameter description JSONObject json req getSubmittedForm try setDisplayName json optString displayNameOrNull logRotator null DescribableList JobProperty JobPropertyDescriptor t new DescribableList JobProperty JobPropertyDescriptor NOOP getAllProperties JSONObject jsonProperties json optJSONObject properties if jsonProperties null This handles the situation when Parameterized build checkbox is checked but no parameters are selected User will be redirected to an error page with proper error message Job checkForEmptyParameters jsonProperties t rebuild req jsonProperties JobPropertyDescriptor getPropertyDescriptors Job this getClass else t clear properties clear for JobProperty p t p setOwner this properties add p submit req rsp save ItemListener fireOnUpdated this String newName req getParameter name final ProjectNamingStrategy namingStrategy Jenkins getInstance getProjectNamingStrategy if validRename name newName newName newName trim check this error early to avoid HTTP response splitting Jenkins checkGoodName newName namingStrategy checkName newName if FormApply isApply req FormApply applyResponse notificationBar show QuotedStringTokenizer quote Messages Job you must use the save button if you wish notificationBar WARNING generateResponse req rsp null else rsp sendRedirect rename newName URLEncoder encode newName UTF 8 else if namingStrategy isForceExistingJobs namingStrategy checkName name FormApply success generateResponse req rsp null catch JSONException e LOGGER log Level WARNING failed to parse json e sendError e req rsp private boolean validRename String oldName String newName if newName null return false boolean noChange oldName equals newName boolean spaceAdded oldName equals newName trim return noChange spaceAdded protected void submit StaplerRequest req StaplerResponse rsp throws IOException ServletException FormException public void doDescription StaplerRequest req StaplerResponse rsp throws IOException if req getMethod equals GET read rsp setContentType text plain charset UTF 8 rsp getWriter write Util fixNull this getDescription return if req getMethod equals POST checkPermission CONFIGURE submission if req getParameter description null this setDescription req getParameter description rsp sendError SC NO CONTENT return huh rsp sendError SC BAD REQUEST public void doBuildStatus StaplerRequest req StaplerResponse rsp throws IOException rsp sendRedirect2 req getContextPath images 48x48 getBuildStatusUrl public String getBuildStatusUrl return getIconColor getImage public String getBuildStatusIconClassName return getIconColor getIconClassName public Graph getBuildTimeGraph return new Graph getLastBuildTime 500 400 Override protected JFreeChart createGraph class ChartLabel implements Comparable ChartLabel final Run run public ChartLabel Run r this run r public int compareTo ChartLabel that return this run number that run number Override public boolean equals Object o HUDSON 2682 workaround for Eclipse compilation bug on c instanceof ChartLabel if o null ChartLabel class isAssignableFrom o getClass return false ChartLabel that ChartLabel o return run that run public Color getColor TODO consider gradation See http www javadrive jp java2d shape index9 html Result r run getResult if r Result FAILURE return ColorPalette RED else if r Result UNSTABLE return ColorPalette YELLOW else if r Result ABORTED r Result NOT BUILT return ColorPalette GREY else return ColorPalette BLUE Override public int hashCode return run hashCode Override public String toString String l run getDisplayName if run instanceof Build String s Build run getBuiltOnStr if s null l s return l DataSetBuilder String ChartLabel data new DataSetBuilder String ChartLabel for Run r getNewBuilds if r isBuilding continue data add double r getDuration 1000 60 min new ChartLabel r final CategoryDataset dataset data build final JFreeChart chart ChartFactory createStackedAreaChart null chart title null unused Messages Job minutes range axis label dataset data PlotOrientation VERTICAL orientation false include legend true tooltips false urls chart setBackgroundPaint Color white final CategoryPlot plot chart getCategoryPlot plot setAxisOffset new Spacer Spacer ABSOLUTE 5 0 5 0 5 0 5 0 plot setBackgroundPaint Color WHITE plot setOutlinePaint null plot setForegroundAlpha 0 8f plot setDomainGridlinesVisible true plot setDomainGridlinePaint Color white plot setRangeGridlinesVisible true plot setRangeGridlinePaint Color black CategoryAxis domainAxis new ShiftedCategoryAxis null plot setDomainAxis domainAxis domainAxis setCategoryLabelPositions CategoryLabelPositions UP 90 domainAxis setLowerMargin 0 0 domainAxis setUpperMargin 0 0 domainAxis setCategoryMargin 0 0 final NumberAxis rangeAxis NumberAxis plot getRangeAxis ChartUtil adjustChebyshev dataset rangeAxis rangeAxis setStandardTickUnits NumberAxis createIntegerTickUnits StackedAreaRenderer ar new StackedAreaRenderer2 Override public Paint getItemPaint int row int column ChartLabel key ChartLabel dataset getColumnKey column return key getColor Override public String generateURL CategoryDataset dataset int row int column ChartLabel label ChartLabel dataset getColumnKey column return String valueOf label run number Override public String generateToolTip CategoryDataset dataset int row int column ChartLabel label ChartLabel dataset getColumnKey column return label run getDisplayName label run getDurationString plot setRenderer ar crop extra space around the graph plot setInsets new RectangleInsets 0 0 0 5 0 return chart private Calendar getLastBuildTime final RunT lastBuild getLastBuild if lastBuild null final GregorianCalendar neverBuiltCalendar new GregorianCalendar neverBuiltCalendar setTimeInMillis 0 return neverBuiltCalendar return lastBuild getTimestamp RequirePOST publicvoid doDoRename StaplerRequest req StaplerResponse rsp throws IOException ServletException if hasPermission CONFIGURE rename is essentially delete followed by a create checkPermission CREATE checkPermission DELETE String newName req getParameter newName Jenkins checkGoodName newName if isBuilding redirect to page explaining that we can t rename now rsp sendRedirect rename newName URLEncoder encode newName UTF 8 return renameTo newName send to the new job page note we can t use getUrl because that would pick up old name in the Ancestor getUrl rsp sendRedirect2 newName public void doRssAll StaplerRequest req StaplerResponse rsp throws IOException ServletException rss req rsp all builds getBuilds public void doRssFailed StaplerRequest req StaplerResponse rsp throws IOException ServletException rss req rsp failed builds getBuilds failureOnly private void rss StaplerRequest req StaplerResponse rsp String suffix RunList runs throws IOException ServletException RSS forwardToRss getDisplayName suffix getUrl runs newBuilds Run FEED ADAPTER req rsp Override public ACL getACL return Jenkins getInstance getAuthorizationStrategy getACL this public BuildTimelineWidget getTimeline return new BuildTimelineWidget getBuilds private final static HexStringConfidentialKey SERVER COOKIE new HexStringConfidentialKey Job class serverCookie 16 private static void checkForEmptyParameters JSONObject jsonProperties throws FormException JSONObject parameterDefinitionProperty jsonProperties getJSONObject hudson model ParametersDefinitionProperty if parameterDefinitionProperty getBoolean specified true parameterDefinitionProperty has parameterDefinitions throw new FormException Messages Hudson NoParamsSpecified parameterDefinitionspackage hudson views import hudson Extension import hudson model Item import org jenkinsci Symbol import org kohsuke stapler DataBoundConstructor public class JobColumn extends ListViewColumn DataBoundConstructor public JobColumn put this in the middle of icons and properties Extension ordinal DEFAULT COLUMNS ORDINAL ICON END 1 Symbol jobName public static class DescriptorImpl extends ListViewColumnDescriptor Override public String getDisplayName return Messages JobColumn DisplayNamepackage hudson cli handlers import hudson model Job import org kohsuke args4j CmdLineParser import org kohsuke args4j OptionDef import org kohsuke args4j spi Setter import org kohsuke MetaInfServices import org kohsuke args4j spi OptionHandler MetaInfServices OptionHandler class SuppressWarnings rawtypes public class JobOptionHandler extends GenericItemOptionHandler Job public JobOptionHandler CmdLineParser parser OptionDef option Setter Job setter super parser option setter Override protected Class Job type return Job class Override public String getDefaultMetaVariable return JOBpackage hudson model import jenkins model Jenkins import net sf json JSONObject import org kohsuke stapler DataBoundConstructor import org kohsuke stapler StaplerRequest public class JobParameterDefinition extends SimpleParameterDefinition DataBoundConstructor public JobParameterDefinition String name super name Extension not live yet public static class DescriptorImpl extends ParameterDescriptor Override public String getDisplayName return Project Parameter Override public ParameterDefinition newInstance StaplerRequest req JSONObject formData throws FormException return req bindJSON JobParameterDefinition class formData Override public ParameterValue createValue StaplerRequest req JSONObject jo return req bindJSON JobParameterValue class jo public ParameterValue createValue String value return new JobParameterValue getName Jenkins getInstance getItemByFullName value Job classpackage hudson model import hudson EnvVars import org kohsuke stapler DataBoundConstructor import java util Locale public class JobParameterValue extends ParameterValue public final Job job DataBoundConstructor public JobParameterValue String name Job job super name this job job Override public Job getValue return job Override public void buildEnvironment Run build EnvVars env TODO check with Tom if this is really what he had in mind env put name job toString env put name toUpperCase Locale ENGLISH job toString backward compatibility pre 1 345 Override public String getShortDescription return name job getFullDisplayNamepackage hudson model import hudson ExtensionPoint import hudson Launcher import hudson model Descriptor FormException import hudson model queue SubTask import hudson tasks BuildStep import hudson tasks Builder import hudson tasks Publisher import hudson tasks BuildStepMonitor import java io IOException import java util Collection import java util Collections import jenkins model Jenkins import jenkins model OptionalJobProperty import net sf json JSONObject import org kohsuke stapler StaplerRequest import org kohsuke stapler export ExportedBean import javax annotation Nonnull ExportedBean public abstract class JobProperty J extends Job implements ReconfigurableDescribable JobProperty BuildStep ExtensionPoint protected transient J owner protected void setOwner J owner this owner owner Override public JobPropertyDescriptor getDescriptor return JobPropertyDescriptor Jenkins getInstance getDescriptorOrDie getClass Deprecated public Action getJobAction J job return null Nonnull public Collection extends Action getJobActions J job delegate to getJobAction singular for backward compatible behavior Action a getJobAction job if a null return Collections emptyList return Collections singletonList a default no op implementation public boolean prebuild AbstractBuild build BuildListener listener return true Override public boolean perform AbstractBuild build Launcher launcher BuildListener listener throws InterruptedException IOException return true public BuildStepMonitor getRequiredMonitorService return BuildStepMonitor NONE public final Action getProjectAction AbstractProject project return getJobAction J project Nonnull public final Collection extends Action getProjectActions AbstractProject project return getJobActions J project public Collection getJobOverrides return Collections emptyList public JobProperty reconfigure StaplerRequest req JSONObject form throws FormException return form null null getDescriptor newInstance req form public Collection extends SubTask getSubTasks return Collections emptyListpackage hudson model import jenkins model Jenkins import org kohsuke stapler StaplerRequest import org jvnet tiger types Types import java util List import java util ArrayList import java util Collection import java lang reflect Type import java lang reflect ParameterizedType import jenkins model OptionalJobProperty import net sf json JSONObject public abstract class JobPropertyDescriptor extends Descriptor JobProperty protected JobPropertyDescriptor Class extends JobProperty clazz super clazz protected JobPropertyDescriptor Override public JobProperty newInstance StaplerRequest req JSONObject formData throws FormException JobPropertyDescriptors are bit different in that we allow them even without any user visible configuration parameter so replace the lack of form data by an empty one if formData isNullObject formData new JSONObject return super newInstance req formData public boolean isApplicable Class extends Job jobType Type parameterization Types getBaseClass clazz JobProperty class if parameterization instanceof ParameterizedType ParameterizedType pt ParameterizedType parameterization Class applicable Types erasure Types getTypeArgument pt 0 return applicable isAssignableFrom jobType else throw new AssertionError clazz doesn t properly parameterize JobProperty The isApplicable method must be overriden public static List JobPropertyDescriptor getPropertyDescriptors Class extends Job clazz List JobPropertyDescriptor r new ArrayList JobPropertyDescriptor for JobPropertyDescriptor p all if p isApplicable clazz r add p return r public static Collection JobPropertyDescriptor all return Collection Jenkins getInstance getDescriptorList JobProperty classpackage hudson model import hudson util DescriptorList import hudson Extension import java util List Deprecated public class Jobs Deprecated public static final List JobPropertyDescriptor PROPERTIES List new DescriptorList JobProperty Class JobProperty classpackage jenkins util import com trilead ssh2 crypto Base64 import hudson util FormValidation import jenkins model Jenkins import net sf json JSONObject import org apache commons io output NullOutputStream import org apache commons io output TeeOutputStream import org jvnet hudson crypto CertificateUtil import org jvnet hudson crypto SignatureOutputStream import java io ByteArrayInputStream import java io File import java io FileInputStream import java io IOException import java io InputStream import java io OutputStreamWriter import java security DigestOutputStream import java security GeneralSecurityException import java security MessageDigest import java security Signature import java security cert Certificate import java security cert CertificateException import java security cert CertificateExpiredException import java security cert CertificateFactory import java security cert CertificateNotYetValidException import java security cert TrustAnchor import java security cert X509Certificate import java util ArrayList import java util HashSet import java util List import java util Set import java util logging Level import java util logging Logger public class JSONSignatureValidator private final String name public JSONSignatureValidator String name this name name public FormValidation verifySignature JSONObject o throws IOException try FormValidation warning null JSONObject signature o getJSONObject signature if signature isNullObject return FormValidation error No signature block found in name o remove signature List X509Certificate certs new ArrayList X509Certificate load and verify certificates CertificateFactory cf CertificateFactory getInstance X509 for Object cert signature getJSONArray certificates X509Certificate c X509Certificate cf generateCertificate new ByteArrayInputStream Base64 decode cert toString toCharArray try c checkValidity catch CertificateExpiredException e even if the certificate isn t valid yet we ll proceed it anyway warning FormValidation warning e String format Certificate s has expired in s cert toString name catch CertificateNotYetValidException e warning FormValidation warning e String format Certificate s is not yet valid in s cert toString name LOGGER log Level FINE Add certificate found in json doc r n tsubjectDN 0 r n tissuer 1 new Object c getSubjectDN c getIssuerDN certs add c CertificateUtil validatePath certs loadTrustAnchors cf this is for computing a digest to check sanity MessageDigest sha1 MessageDigest getInstance SHA1 DigestOutputStream dos new DigestOutputStream new NullOutputStream sha1 this is for computing a signature Signature sig Signature getInstance SHA1withRSA if certs isEmpty return FormValidation error No certificate found in s Cannot verify the signature name else sig initVerify certs get 0 SignatureOutputStream sos new SignatureOutputStream sig until JENKINS 11110 fix UC used to serve invalid digest and therefore unverifiable signature that only covers the earlier portion of the file This was caused by the lack of close call in the canonical writing which apparently leave some bytes somewhere that s not flushed to the digest output stream This affects Jenkins 1 424 1 431 Jenkins 1 432 shipped with the fix 1eb0c64abb3794edce29cbb1de50c93fa03a8229 that made it compute the correct digest but it breaks all the existing UC json metadata out there We then quickly discovered ourselves in the catch 22 situation If we generate UC with the correct signature it ll cut off 1 424 1 431 from the UC But if we don t we ll cut off 1 432 In 1 433 we revisited 1eb0c64abb3794edce29cbb1de50c93fa03a8229 so that the original digest signature pair continues to be generated in a buggy form while correct digest correct signature are generated correctly Jenkins should ignore digest signature pair Accepting it creates a vulnerability that allows the attacker to inject a fragment at the end of the json o writeCanonical new OutputStreamWriter new TeeOutputStream dos sos UTF 8 close did the digest match this is not a part of the signature validation but if we have a bug in the c14n which is more likely than someone tampering with update center we can tell String computedDigest new String Base64 encode sha1 digest String providedDigest signature optString correct digest if providedDigest null return FormValidation error No correct digest parameter in name This metadata appears to be old if computedDigest equalsIgnoreCase providedDigest String msg Digest mismatch computed computedDigest vs expected providedDigest in name if LOGGER isLoggable Level SEVERE LOGGER severe msg LOGGER severe o toString 2 return FormValidation error msg String providedSignature signature getString correct signature if sig verify Base64 decode providedSignature toCharArray return FormValidation error Signature in the update center doesn t match with the certificate in name if warning null return warning return FormValidation ok catch GeneralSecurityException e return FormValidation error e Signature verification failed in name protected Set TrustAnchor loadTrustAnchors CertificateFactory cf throws IOException if we trust default root CAs we end up trusting anyone who has a valid certificate which isn t useful at all Set TrustAnchor anchors new HashSet TrustAnchor CertificateUtil getDefaultRootCAs Jenkins j Jenkins getInstance for String cert Set String j servletContext getResourcePaths WEB INF update center rootCAs if cert endsWith cert endsWith txt continue skip directories also any text files that are meant to be documentation Certificate certificate try InputStream in j servletContext getResourceAsStream cert if in null continue our test for paths ending in should prevent this from happening certificate cf generateCertificate in catch CertificateException e LOGGER log Level WARNING String format Webapp resources in WEB INF update center rootCAs are expected to be either certificates or txt files documenting the certificates but s did not parse as a certificate Skipping this resource for now cert e continue try TrustAnchor certificateAuthority new TrustAnchor X509Certificate certificate null LOGGER log Level FINE Add Certificate Authority 0 1 new Object cert certificateAuthority getTrustedCert null null certificateAuthority getTrustedCert getSubjectDN anchors add certificateAuthority catch IllegalArgumentException e LOGGER log Level WARNING String format The name constraints in the certificate resource s could not be decoded Skipping this resource for now cert e File cas new File j root update center rootCAs listFiles if cas null for File cert cas if cert isDirectory cert getName endsWith txt continue skip directories also any text files that are meant to be documentation FileInputStream in new FileInputStream cert Certificate certificate try certificate cf generateCertificate in catch CertificateException e LOGGER log Level WARNING String format Files in s are expected to be either certificates or txt files documenting the certificates but s did not parse as a certificate Skipping this file for now cert getParentFile getAbsolutePath cert getAbsolutePath e continue finally in close try TrustAnchor certificateAuthority new TrustAnchor X509Certificate certificate null LOGGER log Level FINE Add Certificate Authority 0 1 new Object cert certificateAuthority getTrustedCert null null certificateAuthority getTrustedCert getSubjectDN anchors add certificateAuthority catch IllegalArgumentException e LOGGER log Level WARNING String format The name constraints in the certificate file s could not be decoded Skipping this file for now cert getAbsolutePath e return anchors private static final Logger LOGGER Logger getLogger JSONSignatureValidator class getNamepackage hudson util import hudson FilePath import hudson Launcher import hudson Launcher ProcStarter import java io File import java io Serializable import java util Map import java util TreeMap public class JVMBuilder implements Serializable private final ClasspathBuilder classpath new ClasspathBuilder private final Map String String systemProperties new TreeMap String String private final ArgumentListBuilder args new ArgumentListBuilder private final ArgumentListBuilder vmopts new ArgumentListBuilder private FilePath pwd private String mainClass public ClasspathBuilder classpath return classpath public JVMBuilder systemProperty String key String value this systemProperties put key value return this public Map String String systemProperties return this systemProperties public JVMBuilder systemProperties Map String String props if props null this systemProperties putAll props return this public ArgumentListBuilder args return args public ArgumentListBuilder vmopts return vmopts public JVMBuilder pwd FilePath pwd this pwd pwd return this public JVMBuilder debug int port vmopts add Xrunjdwp transport dt socket server y address port return this public JVMBuilder pwd File pwd return pwd new FilePath pwd public JVMBuilder mainClass String fullyQualifiedClassName this mainClass fullyQualifiedClassName return this public JVMBuilder mainClass Class mainClass return mainClass mainClass getName public ArgumentListBuilder toFullArguments ArgumentListBuilder args new ArgumentListBuilder args add new File System getProperty java home bin java TODO if we are to support a remote launch JVM would be on a different path args addKeyValuePairs D systemProperties args add cp add classpath toString args add this vmopts toCommandArray args add mainClass args add this args toCommandArray return args public ProcStarter launch Launcher launcher return launcher launch cmds toFullArguments pwd pwd private static final long serialVersionUID 1Lpackage hudson util jna import com sun jna Pointer import com sun jna ptr IntByReference import com sun jna win32 StdCallLibrary import com sun jna WString public interface Kernel32 extends StdCallLibrary Kernel32 INSTANCE Kernel32Utils load boolean MoveFileExA String existingFileName String newFileName int flags int MOVEFILE COPY ALLOWED 2 int MOVEFILE CREATE HARDLINK 16 int MOVEFILE DELAY UNTIL REBOOT 4 int MOVEFILE FAIL IF NOT TRACKABLE 32 int MOVEFILE REPLACE EXISTING 1 int MOVEFILE WRITE THROUGH 8 int FILE ATTRIBUTE REPARSE POINT 0x400 int WaitForSingleObject Pointer handle int milliseconds int GetFileAttributesW WString lpFileName boolean GetExitCodeProcess Pointer handle IntByReference r boolean CreateSymbolicLinkW WString lpSymlinkFileName WString lpTargetFileName int dwFlags int SYMBOLIC LINK FLAG DIRECTORY 1 int STILL ACTIVE 259 int GetTempPathW int nBuffer Pointer lpBuffer DWORD intpackage hudson util jna import java io import java util logging Level import java util logging Logger import com sun jna Memory import com sun jna Native import com sun jna Pointer import com sun jna ptr IntByReference import com sun jna WString public class Kernel32Utils public static int waitForExitProcess Pointer hProcess throws InterruptedException while true if Thread interrupted throw new InterruptedException Kernel32 INSTANCE WaitForSingleObject hProcess 1000 IntByReference exitCode new IntByReference exitCode setValue 1 Kernel32 INSTANCE GetExitCodeProcess hProcess exitCode int v exitCode getValue if v Kernel32 STILL ACTIVE return v public static int getWin32FileAttributes File file throws IOException allow lookup of paths longer than MAX PATH http msdn microsoft com en us library aa365247 v VS 85 aspx String canonicalPath file getCanonicalPath String path if canonicalPath length 260 path is short use as is path canonicalPath else if canonicalPath startsWith network share server share UNC server share path UNC canonicalPath substring 2 else prefix canonical path should be normalized and absolute so this should work path canonicalPath return Kernel32 INSTANCE GetFileAttributesW new WString path public static void createSymbolicLink File symlink String target boolean dirLink throws IOException if Kernel32 INSTANCE CreateSymbolicLinkW new WString symlink getPath new WString target dirLink Kernel32 SYMBOLIC LINK FLAG DIRECTORY 0 throw new WinIOException Failed to create a symlink symlink to target public static boolean isJunctionOrSymlink File file throws IOException return file exists Kernel32 FILE ATTRIBUTE REPARSE POINT getWin32FileAttributes file 0 public static File getTempDir Memory buf new Memory 1024 if Kernel32 INSTANCE GetTempPathW 512 buf 0 the first arg is number of wchar return new File buf getString 0 true else return null static Kernel32 load try return Kernel32 Native loadLibrary kernel32 Kernel32 class catch Throwable e LOGGER log Level SEVERE Failed to load Kernel32 e return InitializationErrorInvocationHandler create Kernel32 class e private static final Logger LOGGER Logger getLogger Kernel32Utils class getNamepackage hudson util import hudson model Fingerprint import hudson model FingerprintMap import java io IOException import java lang ref SoftReference import java text MessageFormat import java util concurrent ConcurrentHashMap import java util concurrent atomic AtomicInteger import javax annotation CheckForNull import javax annotation Nonnull public abstract class KeyedDataStorage T P private final ConcurrentHashMap String Object core new ConcurrentHashMap String Object private static class Loading T private CheckForNull T value private boolean set public synchronized void set CheckForNull T value this set true this value value notifyAll public synchronized CheckForNull T get try while set wait return value catch InterruptedException e assume the loading failed but make sure we process interruption properly later Thread currentThread interrupt return null public Nonnull T getOrCreate String key P createParams throws IOException return get key true createParams public CheckForNull T get String key throws IOException return get key false null protected CheckForNull T get Nonnull String key boolean createIfNotExist P createParams throws IOException while true totalQuery incrementAndGet Object value core get key if value instanceof SoftReference SoftReference T wfp SoftReference T value T t wfp get if t null cacheHit incrementAndGet return t found it weakRefLost incrementAndGet if value instanceof Loading another thread is loading it get the value from there T t Loading T value get if t null createIfNotExist return t found it t null or we are just get createIfNotExist the fingerprint doesn t seem to be loaded thus far so let s load it now the care needs to be taken that other threads might be trying to do the same Loading T l new Loading T if value null core putIfAbsent key l null core replace key value l the value has changed since then another thread is attempting to do the same go back to square 1 and try it again continue T t null try t load key if t null createIfNotExist t create key createParams create the new data if t null throw new IllegalStateException Bug in the derived class bug in the derived classes catch IOException e loadFailure incrementAndGet throw e finally let other threads know that the value is available now when the original thread failed to load this should set it to null l set t the map needs to be updated to reflect the result of loading if t null core put key new SoftReference T t else core remove key return t protected abstract CheckForNull T load String key throws IOException protected abstract Nonnull T create Nonnull String key Nonnull P createParams throws IOException public void resetPerformanceStats totalQuery set 0 cacheHit set 0 weakRefLost set 0 loadFailure set 0 public String getPerformanceStats int total totalQuery get int hit cacheHit get int weakRef weakRefLost get int failure loadFailure get int miss total hit weakRef return MessageFormat format total 0 hit 1 lostRef 2 failure 3 miss 4 total hit weakRef failure miss public final AtomicInteger totalQuery new AtomicInteger public final AtomicInteger cacheHit new AtomicInteger public final AtomicInteger weakRefLost new AtomicInteger public final AtomicInteger loadFailure new AtomicIntegerpackage hudson model import antlr ANTLRException import static hudson Util fixNull import hudson model labels LabelAtom import hudson model labels LabelExpression import hudson model labels LabelExpression And import hudson model labels LabelExpression Binary import hudson model labels LabelExpression Iff import hudson model labels LabelExpression Implies import hudson model labels LabelExpression Not import hudson model labels LabelExpression Or import hudson model labels LabelExpression Paren import hudson model labels LabelExpressionLexer import hudson model labels LabelExpressionParser import hudson model labels LabelOperatorPrecedence import hudson model labels LabelVisitor import hudson model queue SubTask import hudson security ACL import hudson slaves NodeProvisioner import hudson slaves Cloud import hudson util QuotedStringTokenizer import hudson util VariableResolver import jenkins model Jenkins import jenkins model ModelObjectWithChildren import org acegisecurity context SecurityContext import org acegisecurity context SecurityContextHolder import org kohsuke stapler StaplerRequest import org kohsuke stapler StaplerResponse import org kohsuke stapler export Exported import org kohsuke stapler export ExportedBean import java io StringReader import java util ArrayList import java util Collections import java util HashSet import java util List import java util Set import java util Collection import java util Stack import java util TreeSet import com thoughtworks xstream converters Converter import com thoughtworks xstream converters MarshallingContext import com thoughtworks xstream converters UnmarshallingContext import com thoughtworks xstream io HierarchicalStreamWriter import com thoughtworks xstream io HierarchicalStreamReader ExportedBean public abstract class Label extends Actionable implements Comparable Label ModelObjectWithChildren protected transient final String name private transient volatile Set Node nodes private transient volatile Set Cloud clouds private transient volatile int tiedJobsCount Exported public transient final LoadStatistics loadStatistics public transient final NodeProvisioner nodeProvisioner public Label String name this name name passing these causes an infinite loop getTotalExecutors getBusyExecutors this loadStatistics new LoadStatistics 0 0 Override public int computeIdleExecutors return Label this getIdleExecutors Override public int computeTotalExecutors return Label this getTotalExecutors Override public int computeQueueLength return Jenkins getInstance getQueue countBuildableItemsFor Label this Override protected Set Node getNodes return Label this getNodes Override protected boolean matches Queue Item item SubTask subTask final Label l item getAssignedLabelFor subTask return l null Label this matches l name this nodeProvisioner new NodeProvisioner this loadStatistics Exported public final String getName return getDisplayName public String getDisplayName return name public abstract String getExpression public String getUrl return label name public String getSearchUrl return getUrl public boolean isAtom return false public abstract boolean matches VariableResolver Boolean resolver public final boolean matches final Collection LabelAtom labels return matches new VariableResolver Boolean public Boolean resolve String name for LabelAtom a labels if a getName equals name return true return false public final boolean matches Node n return matches n getAssignedLabels public boolean isSelfLabel Set Node nodes getNodes return nodes size 1 nodes iterator next getSelfLabel this Exported public Set Node getNodes Set Node nodes this nodes if nodes null return nodes Set Node r new HashSet Node Jenkins h Jenkins getInstance if this matches h r add h for Node n h getNodes if this matches n r add n return this nodes Collections unmodifiableSet r Exported public Set Cloud getClouds if clouds null Set Cloud r new HashSet Cloud Jenkins h Jenkins getInstance for Cloud c h clouds if c canProvision this r add c clouds Collections unmodifiableSet r return clouds public boolean isAssignable for Node n getNodes if n getNumExecutors 0 return true return getClouds isEmpty public int getTotalConfiguredExecutors int r 0 for Node n getNodes r n getNumExecutors return r Exported public int getTotalExecutors int r 0 for Node n getNodes Computer c n toComputer if c null c isOnline r c countExecutors return r Exported public int getBusyExecutors int r 0 for Node n getNodes Computer c n toComputer if c null c isOnline r c countBusy return r Exported public int getIdleExecutors int r 0 for Node n getNodes Computer c n toComputer if c null c isOnline c isConnecting c isAcceptingTasks r c countIdle return r Exported public boolean isOffline for Node n getNodes Computer c n toComputer if c null c isOffline return false return true Exported public String getDescription Set Node nodes getNodes if nodes isEmpty Set Cloud clouds getClouds if clouds isEmpty return Messages Label InvalidLabel return Messages Label ProvisionedFrom toString clouds if nodes size 1 return nodes iterator next getNodeDescription return Messages Label GroupOf toString nodes private String toString Collection extends ModelObject model boolean first true StringBuilder buf new StringBuilder for ModelObject c model if buf length 80 buf append break if first buf append else first false buf append c getDisplayName return buf toString Exported public List AbstractProject getTiedJobs List AbstractProject r new ArrayList AbstractProject for AbstractProject p Jenkins getInstance getAllItems AbstractProject class if p instanceof TopLevelItem this equals p getAssignedLabel r add p return r public int getTiedJobCount if tiedJobsCount 1 return tiedJobsCount denormalize for performance we don t need to respect security as much when returning a simple count SecurityContext context ACL impersonate ACL SYSTEM try int result 0 top level gives the map without checking security of items in the map therefore best performance for TopLevelItem topLevelItem Jenkins getInstance getItemMap values if topLevelItem instanceof AbstractProject final AbstractProject project AbstractProject topLevelItem if matches project getAssignedLabelString result if topLevelItem instanceof ItemGroup Stack ItemGroup q new Stack ItemGroup q push ItemGroup topLevelItem while q isEmpty ItemGroup parent q pop we run the risk of permissions checks in ItemGroup getItems not much we can do here though for Item i parent getItems if i instanceof AbstractProject final AbstractProject project AbstractProject i if matches project getAssignedLabelString result if i instanceof ItemGroup q push ItemGroup i return tiedJobsCount result finally SecurityContextHolder setContext context public boolean contains Node node return getNodes contains node public boolean isEmpty return getNodes isEmpty getClouds isEmpty void reset nodes null clouds null tiedJobsCount 1 public Api getApi return new Api this public abstract V P V accept LabelVisitor V P visitor P param public Set LabelAtom listAtoms Set LabelAtom r new HashSet LabelAtom accept ATOM COLLECTOR r return r public Label and Label rhs return new LabelExpression And this rhs public Label or Label rhs return new LabelExpression Or this rhs public Label iff Label rhs return new LabelExpression Iff this rhs public Label implies Label rhs return new LabelExpression Implies this rhs public Label not return new LabelExpression Not this public Label paren return new LabelExpression Paren this public abstract LabelOperatorPrecedence precedence Override public final boolean equals Object that if this that return true if that null getClass that getClass return false return matches Label that name Override public final int hashCode return name hashCode public final int compareTo Label that return this name compareTo that name private final boolean matches String name return this name equals name Override public String toString return name public ContextMenu doChildrenContextMenu StaplerRequest request StaplerResponse response throws Exception ContextMenu menu new ContextMenu for Node node getNodes menu add node return menu public static final class ConverterImpl implements Converter public ConverterImpl public boolean canConvert Class type return Label class isAssignableFrom type public void marshal Object source HierarchicalStreamWriter writer MarshallingContext context Label src Label source writer setValue src getExpression public Object unmarshal HierarchicalStreamReader reader final UnmarshallingContext context return Jenkins getInstance getLabel reader getValue public static Set LabelAtom parse String labels Set LabelAtom r new TreeSet LabelAtom labels fixNull labels if labels length 0 for String l new QuotedStringTokenizer labels toArray r add Jenkins getInstance getLabelAtom l return r public static Label get String l return Jenkins getInstance getLabel l public static Label parseExpression String labelExpression throws ANTLRException LabelExpressionLexer lexer new LabelExpressionLexer new StringReader labelExpression return new LabelExpressionParser lexer expr private static final LabelVisitor Void Set LabelAtom ATOM COLLECTOR new LabelVisitor Void Set LabelAtom Override public Void onAtom LabelAtom a Set LabelAtom param param add a return null Override public Void onParen Paren p Set LabelAtom param return p base accept this param Override public Void onNot Not p Set LabelAtom param return p base accept this param Override public Void onAnd And p Set LabelAtom param return onBinary p param Override public Void onOr Or p Set LabelAtom param return onBinary p param Override public Void onIff Iff p Set LabelAtom param return onBinary p param Override public Void onImplies Implies p Set LabelAtom param return onBinary p param private Void onBinary Binary b Set LabelAtom param b lhs accept this param b rhs accept this param return nullpackage hudson model import hudson Extension import hudson ExtensionList import hudson ExtensionPoint import hudson model labels LabelAtom import java util Collection public abstract class LabelFinder implements ExtensionPoint public static ExtensionList LabelFinder all return ExtensionList lookup LabelFinder class public abstract Collection LabelAtom findLabels Node nodepackage hudson model import hudson util ByteBuffer import hudson util CharSpool import hudson util LineEndNormalizingWriter import org apache commons fileupload util Closeable import org kohsuke stapler StaplerRequest import org kohsuke stapler StaplerResponse import org kohsuke stapler framework io WriterOutputStream import org apache commons io output CountingOutputStream import javax servlet http HttpServletResponse import java io File import java io IOException import java io InputStream import java io OutputStream import java io RandomAccessFile import java io Writer import java io Reader import java io InputStreamReader Deprecated public class LargeText private interface Source Session open throws IOException long length boolean exists private final Source source private volatile boolean completed public LargeText final File file boolean completed this source new Source public Session open throws IOException return new FileSession file public long length return file length public boolean exists return file exists this completed completed public LargeText final ByteBuffer memory boolean completed this source new Source public Session open throws IOException return new BufferSession memory public long length return memory length public boolean exists return true this completed completed public void markAsComplete completed true public boolean isComplete return completed public Reader readAll throws IOException return new InputStreamReader new InputStream final Session session source open public int read throws IOException byte buf new byte 1 int n session read buf if n 1 return buf 0 else return 1 EOF public int read byte buf int off int len throws IOException return session read buf off len public void close throws IOException session close public long writeLogTo long start Writer w throws IOException CountingOutputStream os new CountingOutputStream new WriterOutputStream w try Session f source open f skip start if completed write everything till EOF byte buf new byte 1024 int sz while sz f read buf 0 os write buf 0 sz else ByteBuf buf new ByteBuf null f HeadMark head new HeadMark buf TailMark tail new TailMark buf while tail moveToNextLine f head moveTo tail os head finish os os flush return os getCount start public void doProgressText StaplerRequest req StaplerResponse rsp throws IOException rsp setContentType text plain rsp setStatus HttpServletResponse SC OK if source exists file doesn t exist yet rsp addHeader X Text Size 0 rsp addHeader X More Data true return long start 0 String s req getParameter start if s null start Long parseLong s if source length start start 0 text rolled over CharSpool spool new CharSpool long r writeLogTo start spool rsp addHeader X Text Size String valueOf r if completed rsp addHeader X More Data true when sending big text try compression don t bother if it s small Writer w if r start 4096 w rsp getCompressedWriter req else w rsp getWriter spool writeTo new LineEndNormalizingWriter w w close private static class Mark protected ByteBuf buf protected int pos public Mark ByteBuf buf this buf buf private static final class HeadMark extends Mark public HeadMark ByteBuf buf super buf void moveTo Mark that OutputStream os throws IOException while this buf that buf os write buf buf 0 buf size buf buf next pos 0 this pos that pos void finish OutputStream os throws IOException os write buf buf 0 pos private static final class TailMark extends Mark public TailMark ByteBuf buf super buf boolean moveToNextLine Session f throws IOException while true while pos buf size if buf isFull read until EOF return false else read into the next buffer buf new ByteBuf buf f pos 0 byte b buf buf pos if b r b n return true private static final class ByteBuf private final byte buf new byte 1024 private int size 0 private ByteBuf next public ByteBuf ByteBuf previous Session f throws IOException if previous null assert previous next null previous next this while this isFull int chunk f read buf size buf length size if chunk 1 return size chunk public boolean isFull return buf length size private interface Session extends AutoCloseable void close throws IOException void skip long start throws IOException int read byte buf throws IOException int read byte buf int offset int length throws IOException private static final class FileSession implements Session private final RandomAccessFile file public FileSession File file throws IOException this file new RandomAccessFile file r public void close throws IOException file close public void skip long start throws IOException file seek file getFilePointer start public int read byte buf throws IOException return file read buf public int read byte buf int offset int length throws IOException return file read buf offset length private static final class BufferSession implements Session private final InputStream in public BufferSession ByteBuffer buf this in buf newInputStream public void close throws IOException in close public void skip long n throws IOException while n 0 n in skip n public int read byte buf throws IOException return in read buf public int read byte buf int offset int length throws IOException return in read buf offset lengthpackage hudson views import hudson Extension import org jenkinsci Symbol import org kohsuke stapler DataBoundConstructor public class LastDurationColumn extends ListViewColumn DataBoundConstructor public LastDurationColumn Extension ordinal DEFAULT COLUMNS ORDINAL PROPERTIES START 4 Symbol lastDuration public static class DescriptorImpl extends ListViewColumnDescriptor Override public String getDisplayName return Messages LastDurationColumn DisplayNamepackage hudson views import hudson Extension import org jenkinsci Symbol import org kohsuke stapler DataBoundConstructor public class LastFailureColumn extends ListViewColumn DataBoundConstructor public LastFailureColumn Extension ordinal DEFAULT COLUMNS ORDINAL PROPERTIES START 2 Symbol lastFailure public static class DescriptorImpl extends ListViewColumnDescriptor Override public String getDisplayName return Messages LastFailureColumn DisplayNamepackage jenkins security import hudson Extension import hudson model Descriptor FormException import hudson model User import hudson model UserProperty import hudson model UserPropertyDescriptor import hudson security SecurityRealm import jenkins model Jenkins import net sf json JSONObject import org acegisecurity Authentication import org acegisecurity GrantedAuthority import org acegisecurity GrantedAuthorityImpl import org acegisecurity userdetails UserDetails import org jenkinsci Symbol import org kohsuke stapler StaplerRequest import javax annotation Nonnull import java io IOException import java util ArrayList import java util Arrays import java util List import java util logging Level import java util logging Logger public class LastGrantedAuthoritiesProperty extends UserProperty private volatile String roles private long timestamp Override public UserProperty reconfigure StaplerRequest req JSONObject form throws FormException req bindJSON this form return this public GrantedAuthority getAuthorities String roles this roles capture to a variable for immutability GrantedAuthority r new GrantedAuthority roles null 1 roles length 1 r 0 SecurityRealm AUTHENTICATED AUTHORITY if roles null for int i 1 i r length i r i new GrantedAuthorityImpl roles i 1 return r public void update Nonnull Authentication auth throws IOException List String roles new ArrayList String for GrantedAuthority ga auth getAuthorities roles add ga getAuthority String a roles toArray new String roles size if Arrays equals this roles a this roles a this timestamp System currentTimeMillis user save public void invalidate throws IOException if roles null roles null timestamp System currentTimeMillis user save Extension public static class SecurityListenerImpl extends SecurityListener Override protected void authenticated Nonnull UserDetails details Override protected void failedToAuthenticate Nonnull String username Override protected void loggedIn Nonnull String username try user should have been created but may not have been saved for some realms but as this is a callback of a successful login we can safely create the user User u User getById username true LastGrantedAuthoritiesProperty o u getProperty LastGrantedAuthoritiesProperty class if o null u addProperty o new LastGrantedAuthoritiesProperty Authentication a Jenkins getAuthentication if a null a getName equals username o update a just for defensive sanity checking catch IOException e LOGGER log Level WARNING Failed to record granted authorities e Override protected void failedToLogIn Nonnull String username while this initially seemed like a good idea to avoid allowing wrong impersonation for too long doing this means a malicious user can break the impersonation capability just by failing to login See ApiTokenFilter that does the following which seems better try User u User getById username false LastGrantedAuthoritiesProperty o u getProperty LastGrantedAuthoritiesProperty class if o null o invalidate catch IOException e LOGGER log Level WARNING Failed to record granted authorities e Override protected void loggedOut Nonnull String username Extension Symbol lastGrantedAuthorities public static final class DescriptorImpl extends UserPropertyDescriptor Override public boolean isEnabled return false public UserProperty newInstance User user return null private static final Logger LOGGER Logger getLogger LastGrantedAuthoritiesProperty class getNamepackage hudson views import hudson Extension import org jenkinsci Symbol import org kohsuke stapler DataBoundConstructor public class LastStableColumn extends ListViewColumn DataBoundConstructor public LastStableColumn Extension ordinal DEFAULT COLUMNS ORDINAL PROPERTIES START 3 Symbol lastStable public static class DescriptorImpl extends ListViewColumnDescriptor Override public String getDisplayName return Messages LastStableColumn DisplayName Override public boolean shownByDefault return falsepackage hudson views import hudson Extension import org jenkinsci Symbol import org kohsuke stapler DataBoundConstructor public class LastSuccessColumn extends ListViewColumn DataBoundConstructor public LastSuccessColumn Extension ordinal DEFAULT COLUMNS ORDINAL PROPERTIES START 1 Symbol lastSuccess public static class DescriptorImpl extends ListViewColumnDescriptor Override public String getDisplayName return Messages LastSuccessColumn DisplayNamepackage hudson model queue import hudson AbortException class Latch private final int n private int i 0 private Exception interrupted public Latch int n this n n public synchronized void abort Throwable cause interrupted new AbortException if cause null interrupted initCause cause notifyAll public synchronized void synchronize throws InterruptedException check n try onCriteriaMet catch Error e abort e throw e catch RuntimeException e abort e throw e check n 2 private void check int threshold throws InterruptedException i if i threshold notifyAll else while i threshold interrupted null try wait catch InterruptedException e interrupted e notifyAll throw e all of us either leave normally or get interrupted if interrupted null throw InterruptedException new InterruptedException initCause interrupted protected void onCriteriaMet throws InterruptedExceptionpackage hudson import hudson Proc LocalProc import hudson model Computer import hudson util QuotedStringTokenizer import jenkins model Jenkins import hudson model TaskListener import hudson model Node import hudson remoting Channel import hudson remoting Pipe import hudson remoting RemoteInputStream import hudson remoting RemoteOutputStream import hudson remoting VirtualChannel import hudson util StreamCopyThread import hudson util ArgumentListBuilder import hudson util ProcessTree import jenkins security MasterToSlaveCallable import org apache commons io input NullInputStream import org kohsuke accmod Restricted import org kohsuke accmod restrictions NoExternalUse import java io BufferedOutputStream import java io File import java io IOException import java io InputStream import java io InterruptedIOException import java io OutputStream import java io Serializable import java util Arrays import java util Map import java util List import java util ArrayList import java util logging Level import java util logging Logger import static org apache commons io output NullOutputStream NULL OUTPUT STREAM public abstract class Launcher protected final TaskListener listener protected final VirtualChannel channel public Launcher TaskListener listener VirtualChannel channel this listener listener this channel channel protected Launcher Launcher launcher this launcher listener launcher channel public VirtualChannel getChannel return channel public TaskListener getListener return listener Deprecated public Computer getComputer for Computer c Jenkins getInstance getComputers if c getChannel channel return c return null public final class ProcStarter protected List String commands protected boolean masks private boolean quiet protected FilePath pwd protected OutputStream stdout NULL OUTPUT STREAM stderr protected InputStream stdin NULL INPUT STREAM protected String envs protected boolean reverseStdin reverseStdout reverseStderr public ProcStarter cmdAsSingleString String s return cmds QuotedStringTokenizer tokenize s public ProcStarter cmds String args return cmds Arrays asList args public ProcStarter cmds File program String args commands new ArrayList String args length 1 commands add program getPath commands addAll Arrays asList args return this public ProcStarter cmds List String args commands new ArrayList String args return this public ProcStarter cmds ArgumentListBuilder args commands args toList masks args toMaskArray return this public List String cmds return commands public ProcStarter masks boolean masks this masks masks return this public boolean masks return masks public ProcStarter quiet boolean quiet this quiet quiet return this public boolean quiet return quiet public ProcStarter pwd FilePath workDir this pwd workDir return this public ProcStarter pwd File workDir return pwd new FilePath workDir public ProcStarter pwd String workDir return pwd new File workDir public FilePath pwd return pwd public ProcStarter stdout OutputStream out this stdout out return this public ProcStarter stdout TaskListener out return stdout out getLogger public OutputStream stdout return stdout public ProcStarter stderr OutputStream err this stderr err return this public OutputStream stderr return stderr public ProcStarter stdin InputStream in this stdin in return this public InputStream stdin return stdin public ProcStarter envs Map String String overrides this envs Util mapToEnv overrides return this public ProcStarter envs String overrides if overrides null for String override overrides if override indexOf 1 throw new IllegalArgumentException override this envs overrides return this public String envs return envs null envs clone new String 0 public ProcStarter readStdout reverseStdout true stdout stderr null return this public ProcStarter readStderr reverseStdout true reverseStderr true return this public ProcStarter writeStdin reverseStdin true stdin null return this public Proc start throws IOException return launch this public int join throws IOException InterruptedException return start join public ProcStarter copy ProcStarter rhs new ProcStarter cmds commands pwd pwd masks masks stdin stdin stdout stdout stderr stderr envs envs quiet quiet rhs reverseStdin this reverseStdin rhs reverseStderr this reverseStderr rhs reverseStdout this reverseStdout return rhs public final ProcStarter launch return new ProcStarter Deprecated public final Proc launch String cmd Map String String env OutputStream out FilePath workDir throws IOException return launch cmd Util mapToEnv env out workDir Deprecated public final Proc launch String cmd Map String String env OutputStream out FilePath workDir throws IOException return launch cmd Util mapToEnv env out workDir Deprecated public final Proc launch String cmd Map String String env InputStream in OutputStream out throws IOException return launch cmd Util mapToEnv env in out Deprecated public final Proc launch String cmd boolean mask Map String String env OutputStream out FilePath workDir throws IOException return launch cmd mask Util mapToEnv env out workDir Deprecated public final Proc launch String cmd boolean mask Map String String env InputStream in OutputStream out throws IOException return launch cmd mask Util mapToEnv env in out Deprecated public final Proc launch String cmd String env OutputStream out FilePath workDir throws IOException return launch Util tokenize cmd env out workDir Deprecated public final Proc launch String cmd String env OutputStream out FilePath workDir throws IOException return launch cmd env null out workDir Deprecated public final Proc launch String cmd String env InputStream in OutputStream out throws IOException return launch cmd env in out null Deprecated public final Proc launch String cmd boolean mask String env OutputStream out FilePath workDir throws IOException return launch cmd mask env null out workDir Deprecated public final Proc launch String cmd boolean mask String env InputStream in OutputStream out throws IOException return launch cmd mask env in out null Deprecated public Proc launch String cmd String env InputStream in OutputStream out FilePath workDir throws IOException return launch launch cmds cmd envs env stdin in stdout out pwd workDir Deprecated public Proc launch String cmd boolean mask String env InputStream in OutputStream out FilePath workDir throws IOException return launch launch cmds cmd masks mask envs env stdin in stdout out pwd workDir public abstract Proc launch ProcStarter starter throws IOException public abstract Channel launchChannel String cmd OutputStream out FilePath workDir Map String String envVars throws IOException InterruptedException public boolean isUnix return File pathSeparatorChar public abstract void kill Map String String modelEnvVars throws IOException InterruptedException protected final void printCommandLine String cmd FilePath workDir StringBuilder buf new StringBuilder if workDir null buf append if showFullPath buf append workDir getRemote else buf append workDir getRemote replaceFirst buf append buf append for String c cmd buf append if c indexOf 0 if c indexOf 0 buf append append c append else buf append append c append else buf append c listener getLogger println buf toString protected final void maskedPrintCommandLine List String cmd boolean mask FilePath workDir if mask null printCommandLine cmd toArray new String cmd size workDir return assert mask length cmd size final String masked new String cmd size for int i 0 i cmd size i if mask i masked i else masked i cmd get i printCommandLine masked workDir protected final void maskedPrintCommandLine String cmd boolean mask FilePath workDir maskedPrintCommandLine Arrays asList cmd mask workDir public final Launcher decorateFor Node node Launcher l this for LauncherDecorator d LauncherDecorator all l d decorate l node return l public final Launcher decorateByPrefix final String prefix final Launcher outer this return new Launcher outer Override public boolean isUnix return outer isUnix Override public Proc launch ProcStarter starter throws IOException starter commands addAll 0 Arrays asList prefix if starter masks null starter masks prefix starter masks return outer launch starter Override public Channel launchChannel String cmd OutputStream out FilePath workDir Map String String envVars throws IOException InterruptedException return outer launchChannel prefix cmd out workDir envVars Override public void kill Map String String modelEnvVars throws IOException InterruptedException outer kill modelEnvVars private String prefix String args String newArgs new String args length prefix length System arraycopy prefix 0 newArgs 0 prefix length System arraycopy args 0 newArgs prefix length args length return newArgs private boolean prefix boolean args boolean newArgs new boolean args length prefix length System arraycopy args 0 newArgs prefix length args length return newArgs public final Launcher decorateByEnv EnvVars env final EnvVars env new EnvVars env final Launcher outer this return new Launcher outer Override public boolean isUnix return outer isUnix Override public Proc launch ProcStarter starter throws IOException EnvVars e new EnvVars env if starter envs null for String env starter envs e addLine env starter envs Util mapToEnv e return outer launch starter Override public Channel launchChannel String cmd OutputStream out FilePath workDir Map String String envVars throws IOException InterruptedException EnvVars e new EnvVars env e putAll envVars return outer launchChannel cmd out workDir e Override public void kill Map String String modelEnvVars throws IOException InterruptedException outer kill modelEnvVars public static class LocalLauncher extends Launcher public LocalLauncher TaskListener listener this listener FilePath localChannel public LocalLauncher TaskListener listener VirtualChannel channel super listener channel Override public Proc launch ProcStarter ps throws IOException if ps quiet maskedPrintCommandLine ps commands ps masks ps pwd EnvVars jobEnv inherit ps envs replace variables in command line String jobCmd new String ps commands size for int idx 0 idx jobCmd length idx jobCmd idx jobEnv expand ps commands get idx return new LocalProc jobCmd Util mapToEnv jobEnv ps reverseStdin LocalProc SELFPUMP INPUT ps stdin ps reverseStdout LocalProc SELFPUMP OUTPUT ps stdout ps reverseStderr LocalProc SELFPUMP OUTPUT ps stderr toFile ps pwd private File toFile FilePath f return f null null new File f getRemote public Channel launchChannel String cmd OutputStream out FilePath workDir Map String String envVars throws IOException printCommandLine cmd workDir ProcessBuilder pb new ProcessBuilder cmd pb directory toFile workDir if envVars null pb environment putAll envVars return launchChannel out pb Override public void kill Map String String modelEnvVars throws InterruptedException ProcessTree get killAll modelEnvVars public Channel launchChannel OutputStream out ProcessBuilder pb throws IOException final EnvVars cookie EnvVars createCookie pb environment putAll cookie final Process proc pb start final Thread t2 new StreamCopyThread pb command stderr copier proc getErrorStream out t2 start return new Channel locally launched channel on pb command Computer threadPoolForRemoting proc getInputStream proc getOutputStream out Override public synchronized void terminate IOException e super terminate e ProcessTree pt ProcessTree get try pt killAll proc cookie catch InterruptedException x LOGGER log Level INFO Interrupted x Override public synchronized void close throws IOException super close wait for all the output from the process to be picked up try t2 join catch InterruptedException e process the interrupt later Thread currentThread interrupt Restricted NoExternalUse class public static class DummyLauncher extends Launcher public DummyLauncher TaskListener listener super listener null Override public Proc launch ProcStarter starter throws IOException throw new IOException Can not call launch on a dummy launcher Override public Channel launchChannel String cmd OutputStream out FilePath workDir Map String String envVars throws IOException InterruptedException throw new IOException Can not call launchChannel on a dummy launcher Override public void kill Map String String modelEnvVars throws IOException InterruptedException Kill method should do nothing public static class RemoteLauncher extends Launcher private final boolean isUnix public RemoteLauncher TaskListener listener VirtualChannel channel boolean isUnix super listener channel this isUnix isUnix public Proc launch ProcStarter ps throws IOException final OutputStream out ps stdout null null new RemoteOutputStream new CloseProofOutputStream ps stdout final OutputStream err ps stderr null null new RemoteOutputStream new CloseProofOutputStream ps stderr final InputStream in ps stdin null ps stdin NULL INPUT STREAM null new RemoteInputStream ps stdin false final String workDir ps pwd null null ps pwd getRemote try return new ProcImpl getChannel call new RemoteLaunchCallable ps commands ps masks ps envs in ps reverseStdin out ps reverseStdout err ps reverseStderr ps quiet workDir listener catch InterruptedException e throw IOException new InterruptedIOException initCause e public Channel launchChannel String cmd OutputStream err FilePath workDir Map String String envOverrides throws IOException InterruptedException printCommandLine cmd workDir Pipe out Pipe createRemoteToLocal final String workDir workDir null null workDir getRemote OutputStream os getChannel call new RemoteChannelLaunchCallable cmd out err workDir envOverrides return new Channel remotely launched channel on channel Computer threadPoolForRemoting out getIn new BufferedOutputStream os Override public boolean isUnix return isUnix Override public void kill final Map String String modelEnvVars throws IOException InterruptedException getChannel call new KillTask modelEnvVars private static final class KillTask extends MasterToSlaveCallable Void RuntimeException private final Map String String modelEnvVars public KillTask Map String String modelEnvVars this modelEnvVars modelEnvVars public Void call throws RuntimeException try ProcessTree get killAll modelEnvVars catch InterruptedException e we are asked to terminate early by the caller so no need to do anything return null private static final long serialVersionUID 1L public static final class ProcImpl extends Proc private final RemoteProcess process private final IOTriplet io public ProcImpl RemoteProcess process this process process this io process getIOtriplet Override public void kill throws IOException InterruptedException process kill Override public int join throws IOException InterruptedException return process join Override public boolean isAlive throws IOException InterruptedException return process isAlive Override public InputStream getStdout return io stdout Override public InputStream getStderr return io stderr Override public OutputStream getStdin return io stdin public static class DecoratedLauncher extends Launcher private Launcher inner null public DecoratedLauncher Launcher inner super inner this inner inner Override public Proc launch ProcStarter starter throws IOException return inner launch starter Override public Channel launchChannel String cmd OutputStream out FilePath workDir Map String String envVars throws IOException InterruptedException return inner launchChannel cmd out workDir envVars Override public void kill Map String String modelEnvVars throws IOException InterruptedException inner kill modelEnvVars Override public boolean isUnix return inner isUnix Override public Proc launch String cmd boolean mask String env InputStream in OutputStream out FilePath workDir throws IOException return inner launch cmd mask env in out workDir Override public Computer getComputer return inner getComputer Override public TaskListener getListener return inner getListener Override public String toString return super toString decorates inner toString Override public VirtualChannel getChannel return inner getChannel Override public Proc launch String cmd String env InputStream in OutputStream out FilePath workDir throws IOException return inner launch cmd env in out workDir public Launcher getInner return inner public static class IOTriplet implements Serializable InputStream stdout stderr OutputStream stdin private static final long serialVersionUID 1L public interface RemoteProcess int join throws InterruptedException IOException void kill throws IOException InterruptedException boolean isAlive throws IOException InterruptedException IOTriplet getIOtriplet private static class RemoteLaunchCallable extends MasterToSlaveCallable RemoteProcess IOException private final List String cmd private final boolean masks private final String env private final InputStream in private final OutputStream out private final OutputStream err private final String workDir private final TaskListener listener private final boolean reverseStdin reverseStdout reverseStderr private final boolean quiet RemoteLaunchCallable List String cmd boolean masks String env InputStream in boolean reverseStdin OutputStream out boolean reverseStdout OutputStream err boolean reverseStderr boolean quiet String workDir TaskListener listener this cmd new ArrayList String cmd this masks masks this env env this in in this out out this err err this workDir workDir this listener listener this reverseStdin reverseStdin this reverseStdout reverseStdout this reverseStderr reverseStderr this quiet quiet public RemoteProcess call throws IOException Launcher ProcStarter ps new LocalLauncher listener launch ps cmds cmd masks masks envs env stdin in stdout out stderr err quiet quiet if workDir null ps pwd workDir if reverseStdin ps writeStdin if reverseStdout ps readStdout if reverseStderr ps readStderr final Proc p ps start return Channel current export RemoteProcess class new RemoteProcess public int join throws InterruptedException IOException try return p join finally make sure I O is delivered to the remote before we return try Channel current syncIO catch Throwable this includes a failure to sync slave jar too old etc public void kill throws IOException InterruptedException p kill public boolean isAlive throws IOException InterruptedException return p isAlive public IOTriplet getIOtriplet IOTriplet r new IOTriplet if reverseStdout r stdout new RemoteInputStream p getStdout if reverseStderr r stderr new RemoteInputStream p getStderr if reverseStdin r stdin new RemoteOutputStream p getStdin return r private static final long serialVersionUID 1L private static class RemoteChannelLaunchCallable extends MasterToSlaveCallable OutputStream IOException private final String cmd private final Pipe out private final String workDir private final OutputStream err private final Map String String envOverrides public RemoteChannelLaunchCallable String cmd Pipe out OutputStream err String workDir Map String String envOverrides this cmd cmd this out out this err new RemoteOutputStream err this workDir workDir this envOverrides envOverrides public OutputStream call throws IOException Process p Runtime getRuntime exec cmd Util mapToEnv inherit envOverrides workDir null null new File workDir List String cmdLines Arrays asList cmd new StreamCopyThread stdin copier for remote agent on cmdLines p getInputStream out getOut start new StreamCopyThread stderr copier for remote agent on cmdLines p getErrorStream err start TODO don t we need to join return new RemoteOutputStream p getOutputStream private static final long serialVersionUID 1L private static EnvVars inherit String env convert String to Map first EnvVars m new EnvVars if env null for String e env int index e indexOf m put e substring 0 index e substring index 1 then do the inheritance return inherit m private static EnvVars inherit Map String String overrides EnvVars m new EnvVars EnvVars masterEnvVars m overrideExpandingAll overrides return m public static boolean showFullPath false private static final NullInputStream NULL INPUT STREAM new NullInputStream 0 private static final Logger LOGGER Logger getLogger Launcher class getNamepackage hudson import hudson model Node import hudson model Executor import hudson tasks BuildWrapper public abstract class LauncherDecorator implements ExtensionPoint public abstract Launcher decorate Launcher launcher Node node public static ExtensionList LauncherDecorator all return ExtensionList lookup LauncherDecorator classpackage jenkins model lazy import hudson Extension import hudson model AbstractItem import hudson model Item import hudson model ItemGroup import hudson model Job import hudson model Queue import hudson model Run import hudson model RunMap import hudson model listeners ItemListener import hudson model queue SubTask import hudson widgets BuildHistoryWidget import hudson widgets HistoryWidget import java io File import java io IOException import java lang reflect InvocationTargetException import java util logging Level import java util logging Logger import javax annotation CheckForNull import javax annotation Nonnull import org kohsuke accmod Restricted import org kohsuke accmod restrictions DoNotUse import static java util logging Level FINER import jenkins model RunIdMigrator SuppressWarnings unchecked rawtypes BuildHistoryWidget and AbstractItem getParent public abstract class LazyBuildMixIn JobT extends Job JobT RunT Queue Task LazyBuildMixIn LazyLoadingJob JobT RunT RunT extends Run JobT RunT LazyBuildMixIn LazyLoadingRun JobT RunT private static final Logger LOGGER Logger getLogger LazyBuildMixIn class getName SuppressWarnings deprecation JENKINS 15156 builds accessed before onLoad or onCreatedFromScratch called private Nonnull RunMap RunT builds new RunMap RunT protected LazyBuildMixIn protected abstract JobT asJob public final Nonnull RunMap RunT getRunMap return builds public final RunMap RunT getRuns assert builds baseDirInitialized neither onCreatedFromScratch nor onLoad called on asJob yet return builds public final void onCreatedFromScratch builds createBuildRunMap SuppressWarnings unchecked public void onLoad ItemGroup extends Item parent String name throws IOException RunMap RunT builds createBuildRunMap int max builds maxNumberOnDisk int next asJob getNextBuildNumber if next max LOGGER log Level WARNING JENKINS 27530 improper nextBuildNumber 0 detected in 1 with highest build number 2 adjusting new Object next asJob max asJob updateNextBuildNumber max 1 RunMap RunT currentBuilds this builds if parent null are we overwriting what currently exist this is primarily when Jenkins is getting reloaded Item current try current parent getItem name catch RuntimeException x LOGGER log Level WARNING failed to look up name in parent x current null if current null current getClass asJob getClass currentBuilds RunMap RunT LazyLoadingJob current getLazyBuildMixIn builds if currentBuilds null if we are reloading keep all those that are still building intact for RunT r currentBuilds getLoadedBuilds values if r isBuilding Do not use RunMap put Run builds put r getNumber r LOGGER log Level FINE keeping reloaded 0 r this builds builds private RunMap RunT createBuildRunMap RunMap RunT r new RunMap RunT asJob getBuildDir new RunMap Constructor RunT Override public RunT create File dir throws IOException return loadBuild dir RunIdMigrator runIdMigrator asJob runIdMigrator assert runIdMigrator null r runIdMigrator runIdMigrator return r protected abstract Class RunT getBuildClass public RunT loadBuild File dir throws IOException try return getBuildClass getConstructor asJob getClass File class newInstance asJob dir catch InstantiationException e throw new Error e catch IllegalAccessException e throw new Error e catch InvocationTargetException e throw handleInvocationTargetException e catch NoSuchMethodException e throw new Error e public final synchronized RunT newBuild throws IOException try RunT lastBuild getBuildClass getConstructor asJob getClass newInstance asJob builds put lastBuild lastBuild getPreviousBuild JENKINS 20662 create connection to previous build return lastBuild catch InvocationTargetException e LOGGER log Level WARNING String format A new build could not be created in job s asJob getFullName e throw handleInvocationTargetException e catch ReflectiveOperationException IllegalStateException e LOGGER log Level WARNING String format A new build could not be created in job s asJob getFullName e throw new Error e private IOException handleInvocationTargetException InvocationTargetException e Throwable t e getTargetException if t instanceof Error throw Error t if t instanceof RuntimeException throw RuntimeException t if t instanceof IOException return IOException t throw new Error t public final void removeRun RunT run if builds remove run LOGGER log Level WARNING 0 did not contain 1 to begin with new Object asJob run public final RunT getBuild String id return builds getById id public final RunT getBuildByNumber int n return builds getByNumber n public final RunT getFirstBuild return builds oldestBuild public final CheckForNull RunT getLastBuild return builds newestBuild public final RunT getNearestBuild int n return builds search n AbstractLazyLoadRunMap Direction ASC public final RunT getNearestOldBuild int n return builds search n AbstractLazyLoadRunMap Direction DESC public final HistoryWidget createHistoryWidget return new BuildHistoryWidget asJob builds Job HISTORY ADAPTER public interface LazyLoadingJob JobT extends Job JobT RunT Queue Task LazyBuildMixIn LazyLoadingJob JobT RunT RunT extends Run JobT RunT LazyLoadingRun JobT RunT LazyBuildMixIn JobT RunT getLazyBuildMixIn public interface LazyLoadingRun JobT extends Job JobT RunT Queue Task LazyBuildMixIn LazyLoadingJob JobT RunT RunT extends Run JobT RunT LazyLoadingRun JobT RunT RunMixIn JobT RunT getRunMixIn public static abstract class RunMixIn JobT extends Job JobT RunT Queue Task LazyBuildMixIn LazyLoadingJob JobT RunT RunT extends Run JobT RunT LazyLoadingRun JobT RunT private volatile BuildReference RunT previousBuildR nextBuildR SuppressWarnings unchecked rawtypes private static final BuildReference NONE new BuildReference NONE null SuppressWarnings unchecked private BuildReference RunT none return NONE private BuildReference RunT selfReference protected RunMixIn protected abstract RunT asRun public final synchronized BuildReference RunT createReference if selfReference null selfReference new BuildReference RunT asRun getId asRun return selfReference public final void dropLinks if nextBuildR null RunT nb nextBuildR get if nb null nb getRunMixIn previousBuildR previousBuildR if previousBuildR null RunT pb previousBuildR get if pb null pb getRunMixIn nextBuildR nextBuildR make this build object unreachable by other Runs createReference clear public final RunT getPreviousBuild while true BuildReference RunT r previousBuildR capture the value once if r null having two neighbors pointing to each other is important to make RunMap removeValue work JobT parent asRun getParent if parent null throw new IllegalStateException no parent for asRun number RunT pb parent getLazyBuildMixIn getRuns search asRun number 1 AbstractLazyLoadRunMap Direction DESC if pb null pb getRunMixIn nextBuildR createReference establish bi di link this previousBuildR pb getRunMixIn createReference LOGGER log FINER Linked 0 1 in getPreviousBuild new Object this pb return pb else this previousBuildR none return null if r none return null RunT referent r get if referent null return referent the reference points to a GC ed object drop the reference and do it again this previousBuildR null public final RunT getNextBuild while true BuildReference RunT r nextBuildR capture the value once if r null having two neighbors pointing to each other is important to make RunMap removeValue work RunT nb asRun getParent getLazyBuildMixIn getRuns search asRun number 1 AbstractLazyLoadRunMap Direction ASC if nb null nb getRunMixIn previousBuildR createReference establish bi di link this nextBuildR nb getRunMixIn createReference LOGGER log FINER Linked 0 1 in getNextBuild new Object this nb return nb else this nextBuildR none return null if r none return null RunT referent r get if referent null return referent the reference points to a GC ed object drop the reference and do it again this nextBuildR null Restricted DoNotUse class Extension public static final class ItemListenerImpl extends ItemListener Override public void onLocationChanged Item item String oldFullName String newFullName if item instanceof LazyLoadingJob RunMap builds LazyLoadingJob item getLazyBuildMixIn builds builds updateBaseDir Job item getBuildDirpackage jenkins model lazy import jenkins model lazy AbstractLazyLoadRunMap Direction import java util AbstractMap SimpleImmutableEntry import java util AbstractSet import java util Iterator import java util Map Entry import java util NoSuchElementException import java util Set class LazyLoadRunMapEntrySet R extends AbstractSet Entry Integer R private final AbstractLazyLoadRunMap R owner private Set Entry Integer R all LazyLoadRunMapEntrySet AbstractLazyLoadRunMap R owner this owner owner private synchronized Set Entry Integer R all if all null all new BuildReferenceMapAdapter R owner owner all entrySet return all synchronized void clearCache all null Override public int size return all size Override public boolean isEmpty return owner newestBuild null Override public boolean contains Object o if o instanceof Entry Entry e Entry o Object k e getKey if k instanceof Integer return owner getByNumber Integer k equals e getValue return false Override public Iterator Entry Integer R iterator return new Iterator Entry Integer R R last null R next owner newestBuild public boolean hasNext return next null public Entry Integer R next last next if last null next owner search owner getNumberOf last 1 Direction DESC else throw new NoSuchElementException return entryOf last private Entry Integer R entryOf R r return new SimpleImmutableEntry Integer R owner getNumberOf r r public void remove if last null throw new UnsupportedOperationException owner removeValue last Override public Object toArray return all toArray Override public T T toArray T a return all toArray a Override public boolean add Entry Integer R integerREntry throw new UnsupportedOperationException Override public boolean remove Object o if o instanceof Entry Entry e Entry o return owner removeValue R e getValue return falsepackage hudson security import hudson Extension import hudson model Descriptor import jenkins model Jenkins import org acegisecurity acls sid GrantedAuthoritySid import org jenkinsci Symbol import org kohsuke stapler DataBoundConstructor import java util Collection import java util Collections public final class LegacyAuthorizationStrategy extends AuthorizationStrategy private static final ACL LEGACY ACL new SparseACL null add EVERYONE Permission READ true add new GrantedAuthoritySid admin Jenkins ADMINISTER true DataBoundConstructor public LegacyAuthorizationStrategy public ACL getRootACL return LEGACY ACL public Collection String getGroups return Collections singleton admin Extension Symbol legacy public static final class DescriptorImpl extends Descriptor AuthorizationStrategy public String getDisplayName return Messages LegacyAuthorizationStrategy DisplayNamepackage hudson security import org acegisecurity AuthenticationManager import org acegisecurity Authentication import org acegisecurity AuthenticationException import org jenkinsci Symbol import org kohsuke accmod Restricted import org kohsuke accmod restrictions NoExternalUse import org springframework web context WebApplicationContext import org kohsuke stapler StaplerRequest import groovy lang Binding import hudson model Descriptor import hudson util spring BeanBuilder import hudson Extension import net sf json JSONObject import javax servlet Filter import javax servlet FilterConfig public final class LegacySecurityRealm extends SecurityRealm implements AuthenticationManager public SecurityComponents createSecurityComponents return new SecurityComponents this public Authentication authenticate Authentication authentication throws AuthenticationException if authentication instanceof ContainerAuthentication return authentication else return null Override public String getAuthenticationGatewayUrl return j security check Override public String getLoginUrl return loginEntry Override public Filter createFilter FilterConfig filterConfig Binding binding new Binding SecurityComponents sc this createSecurityComponents binding setVariable securityComponents sc binding setVariable securityRealm this BeanBuilder builder new BeanBuilder builder parse filterConfig getServletContext getResourceAsStream WEB INF security SecurityFilters groovy binding WebApplicationContext context builder createApplicationContext return Filter context getBean legacy Restricted NoExternalUse class public static Descriptor SecurityRealm DESCRIPTOR Extension Symbol legacy public static class DescriptorImpl extends Descriptor SecurityRealm public DescriptorImpl DESCRIPTOR this public SecurityRealm newInstance StaplerRequest req JSONObject formData throws FormException return new LegacySecurityRealm public String getDisplayName return Messages LegacySecurityRealm Displaynamepackage hudson lifecycle import hudson ExtensionPoint import hudson Functions import jenkins util SystemProperties import hudson Util import jenkins model Jenkins import java io File import java io IOException import java util logging Logger import java util logging Level import org apache commons io FileUtils public abstract class Lifecycle implements ExtensionPoint private static Lifecycle INSTANCE null public synchronized static Lifecycle get if INSTANCE null Lifecycle instance String p SystemProperties getString hudson lifecycle if p null try ClassLoader cl Jenkins getInstance getPluginManager uberClassLoader instance Lifecycle cl loadClass p newInstance catch InstantiationException e InstantiationError x new InstantiationError e getMessage x initCause e throw x catch IllegalAccessException e IllegalAccessError x new IllegalAccessError e getMessage x initCause e throw x catch ClassNotFoundException e NoClassDefFoundError x new NoClassDefFoundError e getMessage x initCause e throw x else if Functions isWindows instance new Lifecycle Override public void verifyRestartable throws RestartNotSupportedException throw new RestartNotSupportedException Default Windows lifecycle does not support restart else if System getenv SMF FMRI null System getenv SMF RESTARTER null when we are run by Solaris SMF these environment variables are set instance new SolarisSMFLifecycle else if run on Unix we can do restart try instance new UnixLifecycle catch final IOException e LOGGER log Level WARNING Failed to install embedded lifecycle implementation e instance new Lifecycle Override public void verifyRestartable throws RestartNotSupportedException throw new RestartNotSupportedException Failed to install embedded lifecycle implementation so cannot restart e e assert instance null INSTANCE instance return INSTANCE public File getHudsonWar String war SystemProperties getString executable war if war null new File war exists return new File war return null public void rewriteHudsonWar File by throws IOException File dest getHudsonWar this should be impossible given the canRewriteHudsonWar method but let s be defensive if dest null throw new IOException jenkins war location is not known backing up the old jenkins war before it gets lost due to upgrading newly downloaded jenkins war and backup jenkins war tmp are the same files unless we are trying to rewrite jenkins war by a backup itself File bak new File dest getPath bak if by equals bak FileUtils copyFile dest bak FileUtils copyFile by dest we don t want to keep backup if we are downgrading if by equals bak bak exists bak delete public boolean canRewriteHudsonWar if we don t know where jenkins war is it s impossible to replace File f getHudsonWar if f null f canWrite return false File parent f getParentFile if parent null parent canWrite return false return true public void restart throws IOException InterruptedException throw new UnsupportedOperationException public void verifyRestartable throws RestartNotSupportedException the rewriteHudsonWar method isn t overridden if Util isOverridden Lifecycle class getClass restart throw new RestartNotSupportedException Restart is not supported in this running mode getClass getName public boolean canRestart try verifyRestartable return true catch RestartNotSupportedException e return false private static final Logger LOGGER Logger getLogger Lifecycle class getNamepackage com twitter sdk android tweetui import android view View import com twitter sdk android core Callback import com twitter sdk android core Result import com twitter sdk android core TwitterApiException import com twitter sdk android core TwitterException import com twitter sdk android core internal TwitterApiConstants import com twitter sdk android core models Tweet import com twitter sdk android core models TweetBuilder class LikeTweetAction extends BaseTweetAction implements View OnClickListener final Tweet tweet final TweetRepository tweetRepository final TweetUi tweetUi final TweetScribeClient tweetScribeClient LikeTweetAction Tweet tweet TweetUi tweetUi Callback Tweet cb this tweet tweetUi cb new TweetScribeClientImpl tweetUi For testing only LikeTweetAction Tweet tweet TweetUi tweetUi Callback Tweet cb TweetScribeClient tweetScribeClient super cb this tweet tweet this tweetUi tweetUi this tweetScribeClient tweetScribeClient this tweetRepository tweetUi getTweetRepository Override public void onClick View view if view instanceof ToggleImageButton final ToggleImageButton toggleImageButton ToggleImageButton view if tweet favorited scribeUnFavoriteAction tweetRepository unfavorite tweet id new LikeCallback toggleImageButton tweet getActionCallback else scribeFavoriteAction tweetRepository favorite tweet id new LikeCallback toggleImageButton tweet getActionCallback void scribeFavoriteAction tweetScribeClient favorite tweet void scribeUnFavoriteAction tweetScribeClient unfavorite tweet static class LikeCallback extends Callback Tweet ToggleImageButton button Tweet tweet Callback Tweet cb LikeCallback ToggleImageButton button Tweet tweet Callback Tweet cb this button button this tweet tweet this cb cb Override public void success Result Tweet result cb success result Override public void failure TwitterException exception if exception instanceof TwitterApiException final TwitterApiException apiException TwitterApiException exception final int errorCode apiException getErrorCode switch errorCode case TwitterApiConstants Errors ALREADY FAVORITED final Tweet favorited new TweetBuilder copy tweet setFavorited true build cb success new Result favorited null return case TwitterApiConstants Errors ALREADY UNFAVORITED final Tweet unfavorited new TweetBuilder copy tweet setFavorited false build cb success new Result unfavorited null return default reset the toggle state back to match the Tweet button setToggledOn tweet favorited cb failure exception return reset the toggle state back to match the Tweet button setToggledOn tweet favorited cb failure exceptionpackage hudson util public class LineEndingConversion public enum EOLType CR CRLF LF LFCR Mac Unix Windows public static String convertEOL String input EOLType type if null input 0 input length return input Convert line endings to Unix LF which also sets up the string for other conversions input input replace r n n input input replace r n switch type case CR case Mac Convert line endings to CR input input replace n r break case CRLF case Windows Convert line endings to Windows CR LF input input replace n r n break default case LF case Unix Conversion already completed return input case LFCR Convert line endings to LF CR input input replace n n r break return inputpackage hudson util import java io FilterWriter import java io Writer import java io IOException Deprecated public class LineEndNormalizingWriter extends FilterWriter private boolean seenCR public LineEndNormalizingWriter Writer out super out public void write char cbuf throws IOException write cbuf 0 cbuf length public void write String str throws IOException write str 0 str length public void write int c throws IOException if seenCR c LF super write r n else super write c seenCR c CR public void write char cbuf int off int len throws IOException int end off len int writeBegin off for int i off i end i char ch cbuf i if seenCR ch LF write up to the char before LF super write cbuf writeBegin i writeBegin super write r n writeBegin i 1 seenCR ch CR super write cbuf writeBegin end writeBegin public void write String str int off int len throws IOException int end off len int writeBegin off for int i off i end i char ch str charAt i if seenCR ch LF write up to the char before LF super write str writeBegin i writeBegin super write r n writeBegin i 1 seenCR ch CR super write str writeBegin end writeBegin private static final int CR 0x0D private static final int LF 0x0Apackage hudson console import hudson util ByteArrayOutputStream2 import java io IOException import java io OutputStream public abstract class LineTransformationOutputStream extends OutputStream private ByteArrayOutputStream2 buf new ByteArrayOutputStream2 protected abstract void eol byte b int len throws IOException public void write int b throws IOException buf write b if b LF eol private void eol throws IOException eol buf getBuffer buf size reuse the buffer under normal circumstances but don t let the line buffer grow unbounded if buf size 4096 buf new ByteArrayOutputStream2 else buf reset Override public void write byte b int off int len throws IOException int end off len for int i off i end i write b i Override public void close throws IOException forceEol public void forceEol throws IOException if buf size 0 eol protected String trimEOL String line int slen line length while slen 0 char ch line charAt slen 1 if ch r ch n slen continue break line line substring 0 slen return line private static final int LF 0x0Apackage com twitter sdk android tweetui import com twitter sdk android core models MediaEntity interface LinkClickListener void onUrlClicked String url void onPhotoClicked MediaEntity mediaEntitypackage hudson util import hudson model ModelObject import org kohsuke stapler HttpResponse import org kohsuke stapler StaplerRequest import org kohsuke stapler StaplerResponse import org kohsuke stapler export Exported import org kohsuke stapler export ExportedBean import org kohsuke stapler export Flavor import javax servlet ServletException import java io IOException import java util ArrayList import java util Arrays import java util Collection ExportedBean public class ListBoxModel extends ArrayList ListBoxModel Option implements HttpResponse ExportedBean defaultVisibility 999 public static final class Option Exported public String name Exported public String value Exported public boolean selected public Option String name String value this name value false public Option String name this name name false public Option String name String value boolean selected this name name this value value this selected selected Override public String toString return name value selected selected public ListBoxModel int initialCapacity super initialCapacity public ListBoxModel public ListBoxModel Collection Option c super c public ListBoxModel Option data super Arrays asList data public void add String displayName String value add new Option displayName value public void add ModelObject usedForDisplayName String value add usedForDisplayName getDisplayName value public ListBoxModel add String nameAndValue add nameAndValue nameAndValue return this public void writeTo StaplerRequest req StaplerResponse rsp throws IOException ServletException rsp serveExposedBean req this Flavor JSON public void generateResponse StaplerRequest req StaplerResponse rsp Object node throws IOException ServletException writeTo req rsp Exported Deprecated public Option values return toArray new Option sizepackage hudson cli import hudson Extension import hudson model AbstractBuild import hudson scm ChangeLogSet import hudson scm ChangeLogSet Entry import hudson util QuotedStringTokenizer import org kohsuke args4j Option import org kohsuke stapler export Flavor import org kohsuke stapler export Model import org kohsuke stapler export ModelBuilder import java io IOException import java io PrintWriter import java util List Extension public class ListChangesCommand extends AbstractBuildRangeCommand Override public String getShortDescription return Messages ListChangesCommand ShortDescription Override protected void printUsageSummary PrintStream stderr TODO enum Format XML CSV PLAIN Option name format usage Controls how the output from this command is printed public Format format Format PLAIN Override protected int act List AbstractBuild builds throws IOException Loading job for this CLI command requires Item READ permission No other permission check needed switch format case XML PrintWriter w new PrintWriter stdout w println changes for AbstractBuild build builds w println build number build getNumber ChangeLogSet cs build getChangeSet Model p new ModelBuilder get cs getClass p writeTo cs Flavor XML createDataWriter cs w w println build w println changes w flush break case CSV for AbstractBuild build builds ChangeLogSet cs build getChangeSet for Entry e cs stdout printf s s n QuotedStringTokenizer quote e getAuthor getId QuotedStringTokenizer quote e getMsg break case PLAIN for AbstractBuild build builds ChangeLogSet cs build getChangeSet for Entry e cs stdout printf s t s n e getAuthor e getMsg for String p e getAffectedPaths stdout println p break return 0package hudson cli import java util Collection import hudson model Item import hudson model Items import hudson model TopLevelItem import hudson model View import hudson Extension import jenkins model ModifiableTopLevelItemGroup import jenkins model Jenkins import org kohsuke args4j Argument Extension public class ListJobsCommand extends CLICommand Override public String getShortDescription return Messages ListJobsCommand ShortDescription Argument metaVar NAME usage Name of the view required false public String name protected int run throws Exception Jenkins h Jenkins getActiveInstance final Collection TopLevelItem jobs If name is given retrieve jobs for the given view if name null View view h getView name if view null jobs view getAllItems If no view was found try with an item group else final Item item h getItemByFullName name If item group was found use it s jobs if item instanceof ModifiableTopLevelItemGroup jobs Items getAllItems ModifiableTopLevelItemGroup item TopLevelItem class No view and no item group with the given name found else throw new IllegalArgumentException No view or item group with the given name name found Fallback to listing all jobs else jobs h getItems Print all jobs for TopLevelItem item jobs stdout println item getName return 0package hudson cli import java util List import hudson Extension import hudson PluginManager import hudson PluginWrapper import hudson model UpdateSite import jenkins model Jenkins import org kohsuke args4j Argument Extension public class ListPluginsCommand extends CLICommand Override public String getShortDescription return Messages ListPluginsCommand ShortDescription Argument metaVar NAME usage Name of a specific plugin required false public String name protected int run Jenkins h Jenkins getActiveInstance PluginManager pluginManager h getPluginManager if this name null PluginWrapper plugin pluginManager getPlugin this name if plugin null printPlugin plugin plugin getShortName length plugin getDisplayName length else throw new IllegalArgumentException No plugin with the name name found else int colWidthShortName 1 int colWidthDisplayName 1 List PluginWrapper plugins pluginManager getPlugins if plugins null for PluginWrapper plugin plugins colWidthShortName Math max colWidthShortName plugin getShortName length colWidthDisplayName Math max colWidthDisplayName plugin getDisplayName length for PluginWrapper plugin plugins printPlugin plugin colWidthShortName colWidthDisplayName return 0 private void printPlugin PluginWrapper plugin int colWidthShortName int colWidthDisplayName final String version if plugin hasUpdate UpdateSite Plugin updateInfo plugin getUpdateInfo version String format s s plugin getVersion updateInfo version else version plugin getVersion String formatString String format ds ds s colWidthShortName colWidthDisplayName stdout println String format formatString plugin getShortName plugin getDisplayName versionpackage com twitter sdk android core services import com twitter sdk android core models Tweet import java util List import retrofit2 Call import retrofit2 http GET import retrofit2 http Query public interface ListService GET 1 1 lists statuses json tweet mode extended include cards true cards platform TwitterKit 13 Call List Tweet statuses Query list id Long listId Query slug String slug Query owner screen name String ownerScreenName Query owner id Long ownerId Query since id Long sinceId Query max id Long maxId Query count Integer count Query include entities Boolean includeEntities Query include rts Boolean includeRetweetspackage hudson model import hudson Extension import hudson Util import hudson diagnosis OldDataMonitor import hudson model Descriptor FormException import hudson model listeners ItemListener import hudson security ACL import hudson security ACLContext import hudson util CaseInsensitiveComparator import hudson util DescribableList import hudson util FormValidation import hudson util HttpResponses import hudson views ListViewColumn import hudson views ViewJobFilter import java io IOException import java util import java util logging Level import java util logging Logger import java util regex Pattern import java util regex PatternSyntaxException import javax annotation concurrent GuardedBy import javax servlet ServletException import jenkins model Jenkins import net sf json JSONObject import org jenkinsci Symbol import org kohsuke accmod Restricted import org kohsuke accmod restrictions NoExternalUse import org kohsuke stapler DataBoundConstructor import org kohsuke stapler DataBoundSetter import org kohsuke stapler HttpResponse import org kohsuke stapler QueryParameter import org kohsuke stapler StaplerRequest import org kohsuke stapler StaplerResponse import org kohsuke stapler interceptor RequirePOST public class ListView extends View implements DirectlyModifiableView GuardedBy this SortedSet String jobNames new TreeSet String CaseInsensitiveComparator INSTANCE private DescribableList ViewJobFilter Descriptor ViewJobFilter jobFilters private DescribableList ListViewColumn Descriptor ListViewColumn columns private String includeRegex private boolean recurse private transient Pattern includePattern private Boolean statusFilter DataBoundConstructor public ListView String name super name initColumns initJobFilters public ListView String name ViewGroup owner this name this owner owner DataBoundSetter public void setColumns List ListViewColumn columns throws IOException this columns replaceBy columns private Object readResolve if includeRegex null try includePattern Pattern compile includeRegex catch PatternSyntaxException x includeRegex null OldDataMonitor report this Collections Throwable singleton x synchronized this if jobNames null jobNames new TreeSet String CaseInsensitiveComparator INSTANCE initColumns initJobFilters return this protected void initColumns if columns null columns new DescribableList ListViewColumn Descriptor ListViewColumn this ListViewColumn createDefaultInitialColumnList protected void initJobFilters if jobFilters null jobFilters new DescribableList ViewJobFilter Descriptor ViewJobFilter this public boolean hasJobFilterExtensions return ViewJobFilter all isEmpty public DescribableList ViewJobFilter Descriptor ViewJobFilter getJobFilters return jobFilters Override public DescribableList ListViewColumn Descriptor ListViewColumn getColumns return columns Override public List TopLevelItem getItems SortedSet String names List TopLevelItem items new ArrayList TopLevelItem synchronized this names new TreeSet String jobNames ItemGroup extends TopLevelItem parent getOwnerItemGroup List TopLevelItem parentItems new ArrayList TopLevelItem parent getItems includeItems parent parentItems names Boolean statusFilter this statusFilter capture the value to isolate us from concurrent update Iterable extends TopLevelItem candidates if recurse candidates Items getAllItems parent TopLevelItem class else candidates parent getItems for TopLevelItem item candidates if names contains item getRelativeNameFrom getOwnerItemGroup continue Add if no status filter or filter matches enabled disabled status if statusFilter null item instanceof AbstractProject AbstractProject item isDisabled statusFilter items add item check the filters Iterable ViewJobFilter jobFilters getJobFilters List TopLevelItem allItems new ArrayList TopLevelItem parentItems if recurse allItems expand allItems new ArrayList TopLevelItem for ViewJobFilter jobFilter jobFilters items jobFilter filter items allItems this for sanity trim off duplicates items new ArrayList TopLevelItem new LinkedHashSet TopLevelItem items return items private List TopLevelItem expand Collection TopLevelItem items List TopLevelItem allItems for TopLevelItem item items if item instanceof ItemGroup ItemGroup extends Item ig ItemGroup extends Item item expand Util filter ig getItems TopLevelItem class allItems allItems add item return allItems Override public boolean contains TopLevelItem item return getItems contains item private void includeItems ItemGroup extends TopLevelItem root Collection extends Item parentItems SortedSet String names if includePattern null for Item item parentItems if recurse item instanceof ItemGroup ItemGroup ig ItemGroup item includeItems root ig getItems names if item instanceof TopLevelItem String itemName item getRelativeNameFrom root if includePattern matcher itemName matches names add itemName public synchronized boolean jobNamesContains TopLevelItem item if item null return false return jobNames contains item getRelativeNameFrom getOwnerItemGroup Override public void add TopLevelItem item throws IOException synchronized this jobNames add item getRelativeNameFrom getOwnerItemGroup save Override public boolean remove TopLevelItem item throws IOException synchronized this String name item getRelativeNameFrom getOwnerItemGroup if jobNames remove name return false save return true public String getIncludeRegex return includeRegex public boolean isRecurse return recurse public void setRecurse boolean recurse this recurse recurse public Boolean getStatusFilter return statusFilter Restricted NoExternalUse class called from newJob button bar view SuppressWarnings unused called from newJob button bar view public boolean isAddToCurrentView synchronized this return jobNames isEmpty There are already items in this view specified by name jobFilters isEmpty includePattern null No other way to include items is used Override RequirePOST public Item doCreateItem StaplerRequest req StaplerResponse rsp throws IOException ServletException JSONObject form req getSubmittedForm boolean addToCurrentView form has addToCurrentView form getBoolean addToCurrentView ItemGroup extends TopLevelItem ig getOwnerItemGroup if ig instanceof ModifiableItemGroup TopLevelItem item ModifiableItemGroup extends TopLevelItem ig doCreateItem req rsp if item null if addToCurrentView synchronized this jobNames add item getRelativeNameFrom getOwnerItemGroup owner save return item return null Override RequirePOST public HttpResponse doAddJobToView QueryParameter String name throws IOException ServletException checkPermission View CONFIGURE if name null throw new Failure Query parameter name is required TopLevelItem item resolveName name if item null throw new Failure Query parameter name does not correspond to a known item if contains item return HttpResponses ok add item owner save return HttpResponses ok Override RequirePOST public HttpResponse doRemoveJobFromView QueryParameter String name throws IOException ServletException checkPermission View CONFIGURE if name null throw new Failure Query parameter name is required TopLevelItem item resolveName name if remove item owner save return HttpResponses ok private TopLevelItem resolveName String name TopLevelItem item getOwnerItemGroup getItem name if item null name Items getCanonicalName getOwnerItemGroup name item Jenkins getInstance getItemByFullName name TopLevelItem class return item Override protected void submit StaplerRequest req throws ServletException FormException IOException JSONObject json req getSubmittedForm synchronized this recurse json optBoolean recurse true jobNames clear Iterable extends TopLevelItem items if recurse items Items getAllItems getOwnerItemGroup TopLevelItem class else items getOwnerItemGroup getItems for TopLevelItem item items String relativeNameFrom item getRelativeNameFrom getOwnerItemGroup if req getParameter relativeNameFrom null jobNames add relativeNameFrom setIncludeRegex req getParameter useincluderegex null req getParameter includeRegex null if columns null columns new DescribableList ListViewColumn Descriptor ListViewColumn this columns rebuildHetero req json ListViewColumn all columns if jobFilters null jobFilters new DescribableList ViewJobFilter Descriptor ViewJobFilter this jobFilters rebuildHetero req json ViewJobFilter all jobFilters String filter Util fixEmpty req getParameter statusFilter statusFilter filter null 1 equals filter null public void setIncludeRegex String includeRegex this includeRegex Util nullify includeRegex if this includeRegex null this includePattern null else this includePattern Pattern compile includeRegex Extension Symbol list public static class DescriptorImpl extends ViewDescriptor Override public String getDisplayName return Messages ListView DisplayName public FormValidation doCheckIncludeRegex QueryParameter String value throws IOException ServletException InterruptedException String v Util fixEmpty value if v null try Pattern compile v catch PatternSyntaxException pse return FormValidation error pse getMessage return FormValidation ok Deprecated public static List ListViewColumn getDefaultColumns return ListViewColumn createDefaultInitialColumnList Restricted NoExternalUse class Extension public static final class Listener extends ItemListener Override public void onLocationChanged final Item item final String oldFullName final String newFullName try ACLContext ACL as ACL SYSTEM locationChanged item oldFullName newFullName private void locationChanged Item item String oldFullName String newFullName final Jenkins jenkins Jenkins getInstance for View view jenkins getViews if view instanceof ListView renameViewItem oldFullName newFullName jenkins ListView view for Item g jenkins getAllItems if g instanceof ViewGroup ViewGroup vg ViewGroup g for View v vg getViews if v instanceof ListView renameViewItem oldFullName newFullName vg ListView v private void renameViewItem String oldFullName String newFullName ViewGroup vg ListView lv boolean needsSave synchronized lv Set String oldJobNames new HashSet String lv jobNames lv jobNames clear for String oldName oldJobNames lv jobNames add Items computeRelativeNamesAfterRenaming oldFullName newFullName oldName vg getItemGroup needsSave oldJobNames equals lv jobNames if needsSave do not hold ListView lock at the time try lv save catch IOException x Logger getLogger ListView class getName log Level WARNING null x Override public void onDeleted final Item item try ACLContext ACL as ACL SYSTEM deleted item private void deleted Item item final Jenkins jenkins Jenkins getInstance for View view jenkins getViews if view instanceof ListView deleteViewItem item jenkins ListView view for Item g jenkins getAllItems if g instanceof ViewGroup ViewGroup vg ViewGroup g for View v vg getViews if v instanceof ListView deleteViewItem item vg ListView v private void deleteViewItem Item item ViewGroup vg ListView lv boolean needsSave synchronized lv needsSave lv jobNames remove item getRelativeNameFrom vg getItemGroup if needsSave try lv save catch IOException x Logger getLogger ListView class getName log Level WARNING null xpackage hudson views import hudson DescriptorExtensionList import hudson Extension import hudson ExtensionPoint import hudson model Describable import hudson model Descriptor import hudson model Descriptor FormException import jenkins model Jenkins import hudson model Item import hudson model ItemGroup import hudson model ListView import hudson model View import hudson util DescriptorList import org kohsuke stapler export Exported import java util ArrayList import java util List import java util logging Level import java util logging Logger import net sf json JSONObject public abstract class ListViewColumn implements ExtensionPoint Describable ListViewColumn Exported public String getColumnCaption return getDescriptor getDisplayName public static DescriptorExtensionList ListViewColumn Descriptor ListViewColumn all return Jenkins getInstance ListViewColumn Descriptor ListViewColumn getDescriptorList ListViewColumn class Deprecated public static final DescriptorList ListViewColumn LIST new DescriptorList ListViewColumn ListViewColumn class Deprecated public boolean shownByDefault return true public Descriptor ListViewColumn getDescriptor return Jenkins getInstance getDescriptorOrDie getClass public static List ListViewColumn createDefaultInitialColumnList OK set up default list of columns create all instances ArrayList ListViewColumn r new ArrayList ListViewColumn final JSONObject emptyJSON new JSONObject for Descriptor ListViewColumn d ListViewColumn all try if d instanceof ListViewColumnDescriptor ListViewColumnDescriptor ld ListViewColumnDescriptor d if ld shownByDefault continue skip this ListViewColumn lvc d newInstance null emptyJSON if lvc shownByDefault continue skip this r add lvc catch FormException e LOGGER log Level WARNING Failed to instantiate d clazz e return r private static final Logger LOGGER Logger getLogger ListViewColumn class getName public static final double DEFAULT COLUMNS ORDINAL ICON START 60 public static final double DEFAULT COLUMNS ORDINAL ICON END 50 public static final double DEFAULT COLUMNS ORDINAL PROPERTIES START 40 public static final double DEFAULT COLUMNS ORDINAL PROPERTIES END 30 public static final double DEFAULT COLUMNS ORDINAL ACTIONS START 20 public static final double DEFAULT COLUMNS ORDINAL ACTIONS END 10package hudson views import hudson model Descriptor import hudson model ListView import org kohsuke stapler DataBoundConstructor public abstract class ListViewColumnDescriptor extends Descriptor ListViewColumn public boolean shownByDefault return truepackage hudson model import com google common collect Maps import hudson Extension import hudson ExtensionPoint import hudson model Queue Task import hudson model queue MappingWorksheet import hudson model queue MappingWorksheet ExecutorChunk import hudson model queue MappingWorksheet Mapping import hudson util ConsistentHash import hudson util ConsistentHash Hash import java util ArrayList import java util List import java util Map public abstract class LoadBalancer implements ExtensionPoint public abstract Mapping map Task task MappingWorksheet worksheet public static final LoadBalancer CONSISTENT HASH new LoadBalancer Override public Mapping map Task task MappingWorksheet ws build consistent hash for each work chunk List ConsistentHash ExecutorChunk hashes new ArrayList ConsistentHash ExecutorChunk ws works size for int i 0 i ws works size i ConsistentHash ExecutorChunk hash new ConsistentHash ExecutorChunk new Hash ExecutorChunk public String hash ExecutorChunk node return node getName Build a Map to pass in rather than repeatedly calling hash add because each call does lots of expensive work List ExecutorChunk chunks ws works i applicableExecutorChunks Map ExecutorChunk Integer toAdd Maps newHashMapWithExpectedSize chunks size for ExecutorChunk ec chunks toAdd put ec ec size 100 hash addAll toAdd hashes add hash do a greedy assignment Mapping m ws new Mapping assert m size ws works size just so that you the reader of the source code don t get confused with the for loop index if assignGreedily m task hashes 0 assert m isCompletelyValid return m else return null private boolean assignGreedily Mapping m Task task List ConsistentHash ExecutorChunk hashes int i if i hashes size return true fully assigned String key task getFullDisplayName i 0 String valueOf i for ExecutorChunk ec hashes get i list key let s attempt this assignment m assign i ec if m isPartiallyValid assignGreedily m task hashes i 1 return true successful greedily allocation otherwise ec wasn t a good fit for us try next every attempt failed m assign i null return false Deprecated public static final LoadBalancer DEFAULT CONSISTENT HASH protected LoadBalancer sanitize final LoadBalancer base this return new LoadBalancer Override public Mapping map Task task MappingWorksheet worksheet if Queue isBlockedByShutdown task if we are quieting down don t start anything new so that all executors will be eventually free return null return base map task worksheet Override protected LoadBalancer sanitize return thispackage com kaku colorfulnews common import android support annotation IntDef import java lang annotation Retention import java lang annotation RetentionPolicy public class LoadNewsType public static final int TYPE REFRESH SUCCESS 1 public static final int TYPE REFRESH ERROR 2 public static final int TYPE LOAD MORE SUCCESS 3 public static final int TYPE LOAD MORE ERROR 4 IntDef TYPE REFRESH SUCCESS TYPE REFRESH ERROR TYPE LOAD MORE SUCCESS TYPE LOAD MORE ERROR Retention RetentionPolicy SOURCE public interface checkerpackage hudson model queue import hudson Extension import hudson ExtensionList import hudson ExtensionPoint import hudson model Computer import hudson model Executor import java util ArrayList import java util Collections import java util List public abstract class LoadPredictor implements ExtensionPoint public Iterable FutureLoad predict MappingWorksheet plan Computer computer long start long end maintain backward compatibility by calling the old signature return predict computer start end Deprecated public Iterable FutureLoad predict Computer computer long start long end return Collections emptyList public static ExtensionList LoadPredictor all return ExtensionList lookup LoadPredictor class Extension public static class CurrentlyRunningTasks extends LoadPredictor Override public Iterable FutureLoad predict MappingWorksheet plan final Computer computer long start long eternity long now System currentTimeMillis List FutureLoad fl new ArrayList FutureLoad for Executor e computer getExecutors if e isIdle continue long eta e getEstimatedRemainingTimeMillis long end eta 0 eternity now eta when does this task end if end start continue should be over by the start time fl add new FutureLoad start end start 1 return flpackage hudson model import hudson Extension import jenkins util SystemProperties import hudson model MultiStageTimeSeries TimeScale import hudson model MultiStageTimeSeries TrendChart import hudson model queue SubTask import hudson model queue Tasks import hudson util ColorPalette import hudson util NoOverlapCategoryAxis import jenkins model Jenkins import org jenkinsci Symbol import org jfree chart ChartFactory import org jfree chart JFreeChart import org jfree chart axis CategoryAxis import org jfree chart axis CategoryLabelPositions import org jfree chart axis NumberAxis import org jfree chart plot CategoryPlot import org jfree chart plot PlotOrientation import org jfree chart renderer category LineAndShapeRenderer import org jfree data category CategoryDataset import org jfree ui RectangleInsets import org kohsuke stapler QueryParameter import org kohsuke stapler export ExportedBean import org kohsuke stapler export Exported import java awt import java io IOException import java io Serializable import java lang reflect Method import java lang reflect Modifier import java util List import javax annotation CheckForNull ExportedBean public abstract class LoadStatistics private final boolean modern Exported public final MultiStageTimeSeries definedExecutors Exported public final MultiStageTimeSeries onlineExecutors Exported public final MultiStageTimeSeries connectingExecutors Exported public final MultiStageTimeSeries busyExecutors Exported public final MultiStageTimeSeries idleExecutors Exported public final MultiStageTimeSeries availableExecutors Exported Deprecated public final MultiStageTimeSeries totalExecutors Exported public final MultiStageTimeSeries queueLength protected LoadStatistics int initialOnlineExecutors int initialBusyExecutors this definedExecutors new MultiStageTimeSeries Messages LoadStatistics Legends DefinedExecutors ColorPalette YELLOW initialOnlineExecutors DECAY this onlineExecutors new MultiStageTimeSeries Messages LoadStatistics Legends OnlineExecutors ColorPalette BLUE initialOnlineExecutors DECAY this connectingExecutors new MultiStageTimeSeries Messages LoadStatistics Legends ConnectingExecutors ColorPalette YELLOW 0 DECAY this busyExecutors new MultiStageTimeSeries Messages LoadStatistics Legends BusyExecutors ColorPalette RED initialBusyExecutors DECAY this idleExecutors new MultiStageTimeSeries Messages LoadStatistics Legends IdleExecutors ColorPalette YELLOW initialOnlineExecutors initialBusyExecutors DECAY this availableExecutors new MultiStageTimeSeries Messages LoadStatistics Legends AvailableExecutors ColorPalette YELLOW initialOnlineExecutors initialBusyExecutors DECAY this queueLength new MultiStageTimeSeries Messages LoadStatistics Legends QueueLength ColorPalette GREY 0 DECAY this totalExecutors onlineExecutors modern isModern getClass static boolean isModern Class extends LoadStatistics clazz cannot use Util isOverridden as these are protected methods boolean hasGetNodes false boolean hasMatches false while clazz LoadStatistics class clazz null hasGetNodes hasMatches if hasGetNodes try final Method getNodes clazz getDeclaredMethod getNodes hasGetNodes Modifier isAbstract getNodes getModifiers catch NoSuchMethodException e ignore if hasMatches try final Method getNodes clazz getDeclaredMethod matches Queue Item class SubTask class hasMatches Modifier isAbstract getNodes getModifiers catch NoSuchMethodException e ignore if hasGetNodes hasMatches LoadStatistics class isAssignableFrom clazz getSuperclass clazz Class extends LoadStatistics clazz getSuperclass return hasGetNodes hasMatches Deprecated public float getLatestIdleExecutors TimeScale timeScale return idleExecutors pick timeScale getLatest Deprecated public abstract int computeIdleExecutors Deprecated public abstract int computeTotalExecutors Deprecated public abstract int computeQueueLength public JFreeChart createChart CategoryDataset ds final JFreeChart chart ChartFactory createLineChart null chart title null unused null range axis label ds data PlotOrientation VERTICAL orientation true include legend true tooltips false urls chart setBackgroundPaint Color white final CategoryPlot plot chart getCategoryPlot plot setBackgroundPaint Color WHITE plot setOutlinePaint null plot setRangeGridlinesVisible true plot setRangeGridlinePaint Color black final LineAndShapeRenderer renderer LineAndShapeRenderer plot getRenderer renderer setBaseStroke new BasicStroke 3 configureRenderer renderer final CategoryAxis domainAxis new NoOverlapCategoryAxis null plot setDomainAxis domainAxis domainAxis setCategoryLabelPositions CategoryLabelPositions UP 90 domainAxis setLowerMargin 0 0 domainAxis setUpperMargin 0 0 domainAxis setCategoryMargin 0 0 final NumberAxis rangeAxis NumberAxis plot getRangeAxis rangeAxis setStandardTickUnits NumberAxis createIntegerTickUnits crop extra space around the graph plot setInsets new RectangleInsets 0 0 0 5 0 return chart protected void configureRenderer LineAndShapeRenderer renderer renderer setSeriesPaint 0 ColorPalette BLUE online renderer setSeriesPaint 1 ColorPalette RED busy renderer setSeriesPaint 2 ColorPalette GREY queue renderer setSeriesPaint 3 ColorPalette YELLOW available public TrendChart createTrendChart TimeScale timeScale return MultiStageTimeSeries createTrendChart timeScale onlineExecutors busyExecutors queueLength availableExecutors public TrendChart doGraph QueryParameter String type throws IOException return createTrendChart TimeScale parse type public Api getApi return new Api this Deprecated protected void updateExecutorCounts updateCounts computeSnapshot protected void updateCounts LoadStatisticsSnapshot current definedExecutors update current getDefinedExecutors onlineExecutors update current getOnlineExecutors connectingExecutors update current getConnectingExecutors busyExecutors update current getBusyExecutors idleExecutors update current getIdleExecutors availableExecutors update current getAvailableExecutors queueLength update current getQueueLength protected abstract Iterable Node getNodes protected abstract boolean matches Queue Item item SubTask subTask public LoadStatisticsSnapshot computeSnapshot if modern return computeSnapshot Jenkins getInstance getQueue getBuildableItems else int t computeTotalExecutors int i computeIdleExecutors return new LoadStatisticsSnapshot t t Math max i t 0 Math max t i 0 i i computeQueueLength protected LoadStatisticsSnapshot computeSnapshot Iterable Queue BuildableItem queue final LoadStatisticsSnapshot Builder builder LoadStatisticsSnapshot builder final Iterable Node nodes getNodes if nodes null for Node node nodes builder with node int q 0 if queue null for Queue BuildableItem item queue for SubTask st item task getSubTasks if matches item st q return builder withQueueLength q build public static final float DECAY Float parseFloat SystemProperties getString LoadStatistics class getName decay 0 9 public static int CLOCK SystemProperties getInteger LoadStatistics class getName clock 10 1000 Extension Symbol loadStatistics public static class LoadStatisticsUpdater extends PeriodicWork public long getRecurrencePeriod return CLOCK protected void doRun Jenkins j Jenkins getInstance List Queue BuildableItem bis j getQueue getBuildableItems update statistics on agents for Label l j getLabels l loadStatistics updateCounts l loadStatistics computeSnapshot bis update statistics of the entire system j unlabeledLoad updateCounts j unlabeledLoad computeSnapshot bis j overallLoad updateCounts j overallLoad computeSnapshot bis private int count List Queue BuildableItem bis Label l int q 0 for Queue BuildableItem bi bis for SubTask st Tasks getSubTasksOf bi task if bi getAssignedLabelFor st l q return q ExportedBean public static class LoadStatisticsSnapshot implements Serializable private static final long serialVersionUID 1L private final int definedExecutors private final int onlineExecutors private final int connectingExecutors private final int busyExecutors private final int idleExecutors private final int availableExecutors private final int queueLength private LoadStatisticsSnapshot int definedExecutors int onlineExecutors int connectingExecutors int busyExecutors int idleExecutors int availableExecutors int queueLength this definedExecutors definedExecutors this onlineExecutors onlineExecutors this connectingExecutors connectingExecutors assert definedExecutors onlineExecutors connectingExecutors this busyExecutors busyExecutors this idleExecutors idleExecutors assert onlineExecutors busyExecutors idleExecutors this availableExecutors availableExecutors assert availableExecutors idleExecutors this queueLength queueLength Exported public int getDefinedExecutors return definedExecutors Exported public int getOnlineExecutors return onlineExecutors Exported public int getConnectingExecutors return connectingExecutors Exported public int getBusyExecutors return busyExecutors Exported public int getIdleExecutors return idleExecutors Exported public int getAvailableExecutors return availableExecutors Exported public int getQueueLength return queueLength Override public boolean equals Object o if this o return true if o null getClass o getClass return false LoadStatisticsSnapshot that LoadStatisticsSnapshot o if availableExecutors that availableExecutors return false if busyExecutors that busyExecutors return false if connectingExecutors that connectingExecutors return false if definedExecutors that definedExecutors return false if idleExecutors that idleExecutors return false if onlineExecutors that onlineExecutors return false if queueLength that queueLength return false return true Override public int hashCode int result definedExecutors result 31 result onlineExecutors result 31 result connectingExecutors result 31 result busyExecutors result 31 result idleExecutors result 31 result availableExecutors result 31 result queueLength return result Override public String toString final StringBuilder sb new StringBuilder LoadStatisticsSnapshot sb append definedExecutors append definedExecutors sb append onlineExecutors append onlineExecutors sb append connectingExecutors append connectingExecutors sb append busyExecutors append busyExecutors sb append idleExecutors append idleExecutors sb append availableExecutors append availableExecutors sb append queueLength append queueLength sb append return sb toString public static class Builder private int definedExecutors private int onlineExecutors private int connectingExecutors private int busyExecutors private int idleExecutors private int availableExecutors private int queueLength public LoadStatisticsSnapshot build return new LoadStatisticsSnapshot definedExecutors onlineExecutors connectingExecutors busyExecutors idleExecutors availableExecutors queueLength public Builder withQueueLength int queueLength this queueLength queueLength return this public Builder with CheckForNull Node node if node null return with node toComputer return this public Builder with CheckForNull Computer computer if computer null return this if computer isOnline final List Executor executors computer getExecutors final boolean acceptingTasks computer isAcceptingTasks for Executor e executors definedExecutors onlineExecutors if e getCurrentWorkUnit null busyExecutors else idleExecutors if acceptingTasks availableExecutors else final int numExecutors computer getNumExecutors definedExecutors numExecutors if computer isConnecting connectingExecutors numExecutors return this public static Builder builder return new Builderpackage hudson import edu umd cs findbugs annotations CheckForNull import edu umd cs findbugs annotations NonNull import jenkins util SystemProperties import jenkins model Jenkins import javax servlet ServletContext import java io File import java util Collection import java util Collections import java util logging Logger public class LocalPluginManager extends PluginManager public LocalPluginManager CheckForNull ServletContext context NonNull File rootDir super context new File rootDir plugins public LocalPluginManager NonNull Jenkins jenkins this jenkins servletContext jenkins getRootDir public LocalPluginManager NonNull File rootDir this null rootDir Override protected Collection String loadBundledPlugins this is used in tests when we want to override the default bundled plugins with jpl or hpl versions if SystemProperties getString hudson bundled plugins null return Collections emptySet try return loadPluginsFromWar WEB INF plugins finally loadDetachedPlugins private static final Logger LOGGER Logger getLogger LocalPluginManager class getNamepackage com twitter sdk android tweetui import com twitter sdk android core Callback import com twitter sdk android core TwitterException import io fabric sdk android Logger abstract class LoggingCallback T extends Callback T Wrapped cb generic type is unknown concrete subclass responsible for implementing success Result T result and unpacking result to call cb with proper type checking private final Callback cb private final Logger logger LoggingCallback Callback cb Logger logger this cb cb this logger logger Override public void failure TwitterException exception logger e TweetUi LOGTAG exception getMessage exception if cb null cb failure exceptionpackage com twitter sdk android unity import android app Activity import android content Intent import android os Bundle import com twitter sdk android core Callback import com twitter sdk android core Result import com twitter sdk android core TwitterException import com twitter sdk android core TwitterSession import com twitter sdk android core TwitterSessionHelper import com twitter sdk android core identity TwitterAuthClient public class LoginActivity extends Activity TwitterAuthClient authClient Override public void onCreate Bundle savedInstanceState super onCreate savedInstanceState authClient new TwitterAuthClient authClient authorize this new Callback TwitterSession Override public void success Result TwitterSession result final String session TwitterSessionHelper serialize result data final UnityMessage message new UnityMessage Builder setMethod LoginComplete setData session build message send finish Override public void failure TwitterException ex final String error new ApiError Serializer serialize new ApiError 0 ex getMessage final UnityMessage message new UnityMessage Builder setMethod LoginFailed setData error build message send finish Override protected void onActivityResult int requestCode int resultCode Intent data super onActivityResult requestCode resultCode data authClient onActivityResult requestCode resultCode datapackage hudson cli import hudson Extension import jenkins model Jenkins import org acegisecurity Authentication import org kohsuke args4j CmdLineException Extension public class LoginCommand extends CLICommand Override public String getShortDescription return Messages LoginCommand ShortDescription Override protected Authentication loadStoredAuthentication throws InterruptedException return Jenkins ANONYMOUS Override protected int run throws Exception Authentication a Jenkins getAuthentication if a Jenkins ANONYMOUS throw new CmdLineException No credentials specified this causes CLI to show the command line options ClientAuthenticationCache store new ClientAuthenticationCache checkChannel store set a return 0package hudson cli import hudson Extension Extension public class LogoutCommand extends CLICommand Override public String getShortDescription return Messages LogoutCommand ShortDescription Override protected int run throws Exception ClientAuthenticationCache store new ClientAuthenticationCache checkChannel store remove return 0package hudson logging import com thoughtworks xstream XStream import hudson BulkChange import hudson Extension import hudson FilePath import hudson Util import hudson XmlFile import hudson model import hudson util HttpResponses import jenkins model Jenkins import hudson model listeners SaveableListener import hudson remoting Channel import hudson remoting VirtualChannel import hudson slaves ComputerListener import hudson util CopyOnWriteList import hudson util RingBufferLogHandler import hudson util XStream2 import jenkins security MasterToSlaveCallable import net sf json JSONObject import org kohsuke stapler import org kohsuke stapler interceptor RequirePOST import javax servlet ServletException import java io File import java io IOException import java text Collator import java util import java util logging Level import java util logging LogManager import java util logging LogRecord import java util logging Logger import org kohsuke accmod Restricted import org kohsuke accmod restrictions NoExternalUse public class LogRecorder extends AbstractModelObject implements Saveable private volatile String name public final CopyOnWriteList Target targets new CopyOnWriteList Target Restricted NoExternalUse class Target orderedTargets will contain targets ordered by reverse name length place specific targets at the beginning Target ts targets toArray new Target Arrays sort ts new Comparator Target public int compare Target left Target right return right getName length left getName length return ts Restricted NoExternalUse class public AutoCompletionCandidates doAutoCompleteLoggerName QueryParameter String value AutoCompletionCandidates candidates new AutoCompletionCandidates Enumeration String loggerNames LogManager getLogManager getLoggerNames while loggerNames hasMoreElements String loggerName loggerNames nextElement if loggerName toLowerCase Locale ENGLISH contains value toLowerCase Locale ENGLISH candidates add loggerName return candidates Restricted NoExternalUse class transient RingBufferLogHandler handler new RingBufferLogHandler Override public void publish LogRecord record for Target t orderedTargets Boolean match t matches record if match null domain does not match so continue looking continue if match booleanValue most specific logger matches so publish super publish record most specific logger does not match so don t publish allows reducing log level for more specific loggers return public static final class Target public final String name private final int level private transient Logger logger public Target String name Level level this name level intValue public Target String name int level this name name this level level DataBoundConstructor public Target String name String level this name Level parse level public Level getLevel return Level parse String valueOf level public String getName return name Deprecated public boolean includes LogRecord r if r getLevel intValue level return false below the threshold if name length 0 return true like root logger includes everything String logName r getLoggerName if logName null logName startsWith name return false not within this logger String rest logName substring name length return rest startsWith rest length 0 public Boolean matches LogRecord r boolean levelSufficient r getLevel intValue level if name length 0 return Boolean valueOf levelSufficient include if level matches String logName r getLoggerName if logName null logName startsWith name return null not in the domain of this logger String rest logName substring name length if rest startsWith rest length 0 return Boolean valueOf levelSufficient include if level matches return null public Logger getLogger if logger null logger Logger getLogger name return logger public void enable Logger l getLogger if l isLoggable getLevel l setLevel getLevel new SetLevel name getLevel broadcast public void disable getLogger setLevel null new SetLevel name null broadcast private static final class SetLevel extends MasterToSlaveCallable Void Error SuppressWarnings MismatchedQueryAndUpdateOfCollection private static final Set Logger loggers new HashSet Logger private final String name private final Level level SetLevel String name Level level this name name this level level Override public Void call throws Error Logger logger Logger getLogger name loggers add logger logger setLevel level return null void broadcast for Computer c Jenkins getInstance getComputers if c getName length 0 i e not master VirtualChannel ch c getChannel if ch null try ch call this catch Exception x Logger getLogger LogRecorder class getName log Level WARNING could not set up logging on c x Extension Restricted NoExternalUse class public static final class ComputerLogInitializer extends ComputerListener Override public void preOnline Computer c Channel channel FilePath root TaskListener listener throws IOException InterruptedException for LogRecorder recorder Jenkins getInstance getLog logRecorders values for Target t recorder targets channel call new SetLevel t name t getLevel public LogRecorder String name this name name register it only once when constructed and when this object dies WeakLogHandler will remove it new WeakLogHandler handler Logger getLogger public String getDisplayName return name public String getSearchUrl return Util rawEncode name public String getName return name public LogRecorderManager getParent return Jenkins getInstance getLog RequirePOST public synchronized void doConfigSubmit StaplerRequest req StaplerResponse rsp throws IOException ServletException JSONObject src req getSubmittedForm String newName src getString name redirect XmlFile oldFile null if name equals newName Jenkins checkGoodName newName oldFile getConfigFile rename getParent logRecorders remove name this name newName getParent logRecorders put name this redirect Util rawEncode newName List Target newTargets req bindJSONToList Target class src get targets for Target t newTargets t enable targets replaceBy newTargets save if oldFile null oldFile delete rsp sendRedirect2 redirect RequirePOST public HttpResponse doClear throws IOException handler clear return HttpResponses redirectToDot public synchronized void load throws IOException getConfigFile unmarshal this for Target t targets t enable public synchronized void save throws IOException if BulkChange contains this return getConfigFile write this SaveableListener fireOnChange this getConfigFile RequirePOST public synchronized void doDoDelete StaplerResponse rsp throws IOException ServletException getConfigFile delete getParent logRecorders remove name Disable logging for all our targets then reenable all other loggers in case any also log the same targets for Target t targets t disable for LogRecorder log getParent logRecorders values for Target t log targets t enable rsp sendRedirect2 public void doRss StaplerRequest req StaplerResponse rsp throws IOException ServletException LogRecorderManager doRss req rsp getLogRecords private XmlFile getConfigFile return new XmlFile XSTREAM new File LogRecorderManager configDir name xml public List LogRecord getLogRecords return handler getView public Map Computer List LogRecord getSlaveLogRecords Map Computer List LogRecord result new TreeMap Computer List LogRecord new Comparator Computer final Collator COLL Collator getInstance public int compare Computer c1 Computer c2 return COLL compare c1 getDisplayName c2 getDisplayName for Computer c Jenkins getInstance getComputers if c getName length 0 continue master List LogRecord recs new ArrayList LogRecord try for LogRecord rec c getLogRecords for Target t targets if t includes rec recs add rec break catch IOException x continue catch InterruptedException x continue if recs isEmpty result put c recs return result public static final XStream XSTREAM new XStream2 static XSTREAM alias log LogRecorder class XSTREAM alias target Target class public static List Level LEVELS Arrays asList Level ALL Level FINEST Level FINER Level FINE Level CONFIG Level INFO Level WARNING Level SEVEREpackage hudson logging import hudson FeedAdapter import hudson Functions import hudson init Initializer import static hudson init InitMilestone PLUGINS PREPARED import hudson model AbstractModelObject import jenkins model Jenkins import hudson model RSS import hudson util CopyOnWriteMap import jenkins model JenkinsLocationConfiguration import jenkins model ModelObjectWithChildren import jenkins model ModelObjectWithContextMenu ContextMenu import org apache commons io filefilter WildcardFileFilter import org kohsuke stapler QueryParameter import org kohsuke stapler StaplerRequest import org kohsuke stapler StaplerResponse import org kohsuke stapler HttpResponse import org kohsuke stapler HttpRedirect import org kohsuke stapler interceptor RequirePOST import javax servlet ServletException import java io File import java io FileFilter import java io IOException import java util ArrayList import java util Calendar import java util GregorianCalendar import java util List import java util Locale import java util Map import java util logging Level import java util logging LogRecord import java util logging Logger public class LogRecorderManager extends AbstractModelObject implements ModelObjectWithChildren public transient final Map String LogRecorder logRecorders new CopyOnWriteMap Tree String LogRecorder public String getDisplayName return Messages LogRecorderManager DisplayName public String getSearchUrl return log public LogRecorder getDynamic String token return getLogRecorder token public LogRecorder getLogRecorder String token return logRecorders get token static File configDir return new File Jenkins getInstance getRootDir log public void load throws IOException logRecorders clear File dir configDir File files dir listFiles FileFilter new WildcardFileFilter xml if files null return for File child files String name child getName name name substring 0 name length 4 cut off xml LogRecorder lr new LogRecorder name lr load logRecorders put name lr RequirePOST public HttpResponse doNewLogRecorder QueryParameter String name Jenkins checkGoodName name logRecorders put name new LogRecorder name redirect to the config screen return new HttpRedirect name configure public ContextMenu doChildrenContextMenu StaplerRequest request StaplerResponse response throws Exception ContextMenu menu new ContextMenu menu add all All Jenkins Logs for LogRecorder lr logRecorders values menu add lr getSearchUrl lr getDisplayName return menu edu umd cs findbugs annotations SuppressFBWarnings LG LOST LOGGER DUE TO WEAK REFERENCE public HttpResponse doConfigLogger QueryParameter String name QueryParameter String level Jenkins getInstance checkPermission Jenkins ADMINISTER Level lv if level equals inherit lv null else lv Level parse level toUpperCase Locale ENGLISH Logger getLogger name setLevel lv return new HttpRedirect levels public void doRss StaplerRequest req StaplerResponse rsp throws IOException ServletException doRss req rsp Jenkins logRecords static void doRss StaplerRequest req StaplerResponse rsp List LogRecord logs throws IOException ServletException filter log records based on the log level String level req getParameter level if level null Level threshold Level parse level List LogRecord filtered new ArrayList LogRecord for LogRecord r logs if r getLevel intValue threshold intValue filtered add r logs filtered RSS forwardToRss Hudson log logs new FeedAdapter LogRecord public String getEntryTitle LogRecord entry return entry getMessage public String getEntryUrl LogRecord entry return log TODO one URL for one log entry public String getEntryID LogRecord entry return String valueOf entry getSequenceNumber public String getEntryDescription LogRecord entry return Functions printLogRecord entry public Calendar getEntryTimestamp LogRecord entry GregorianCalendar cal new GregorianCalendar cal setTimeInMillis entry getMillis return cal public String getEntryAuthor LogRecord entry return JenkinsLocationConfiguration get getAdminAddress req rsp Initializer before PLUGINS PREPARED public static void init Jenkins h throws IOException h getLog loadpackage hudson tasks import com google common collect Lists import hudson Extension import hudson model Job import hudson model Run import jenkins model BuildDiscarder import jenkins model BuildDiscarderDescriptor import org jenkinsci Symbol import org kohsuke stapler DataBoundConstructor import java io IOException import java util Calendar import java util Collection import java util GregorianCalendar import java util List import java util logging Logger import static java util logging Level public class LogRotator extends BuildDiscarder private final int daysToKeep private final int numToKeep private final Integer artifactDaysToKeep private final Integer artifactNumToKeep DataBoundConstructor public LogRotator String daysToKeepStr String numToKeepStr String artifactDaysToKeepStr String artifactNumToKeepStr this parse daysToKeepStr parse numToKeepStr parse artifactDaysToKeepStr parse artifactNumToKeepStr public static int parse String p if p null return 1 try return Integer parseInt p catch NumberFormatException e return 1 Deprecated public LogRotator int daysToKeep int numToKeep this daysToKeep numToKeep 1 1 public LogRotator int daysToKeep int numToKeep int artifactDaysToKeep int artifactNumToKeep this daysToKeep daysToKeep this numToKeep numToKeep this artifactDaysToKeep artifactDaysToKeep this artifactNumToKeep artifactNumToKeep SuppressWarnings rawtypes public void perform Job job throws IOException InterruptedException LOGGER log FINE Running the log rotation for 0 with numToKeep 1 daysToKeep 2 artifactNumToKeep 3 artifactDaysToKeep 4 new Object job numToKeep daysToKeep artifactNumToKeep artifactDaysToKeep always keep the last successful and the last stable builds Run lsb job getLastSuccessfulBuild Run lstb job getLastStableBuild if numToKeep 1 Note that RunList size is deprecated and indeed here we are loading all the builds of the job However we would need to load the first numToKeep anyway just to skip over them and we would need to load the rest anyway to delete them Using RunMap headMap would not suffice since we do not know if some recent builds have been deleted for other reasons so simply subtracting numToKeep from the currently last build number might cause us to delete too many List extends Run builds job getBuilds for Run r copy builds subList Math min builds size numToKeep builds size if shouldKeepRun r lsb lstb continue LOGGER log FINE 0 is to be removed r r delete if daysToKeep 1 Calendar cal new GregorianCalendar cal add Calendar DAY OF YEAR daysToKeep Run r job getFirstBuild while r null if tooNew r cal break if shouldKeepRun r lsb lstb LOGGER log FINE 0 is to be removed r r delete r r getNextBuild if artifactNumToKeep null artifactNumToKeep 1 List extends Run builds job getBuilds for Run r copy builds subList Math min builds size artifactNumToKeep builds size if shouldKeepRun r lsb lstb continue LOGGER log FINE 0 is to be purged of artifacts r r deleteArtifacts if artifactDaysToKeep null artifactDaysToKeep 1 Calendar cal new GregorianCalendar cal add Calendar DAY OF YEAR artifactDaysToKeep Run r job getFirstBuild while r null if tooNew r cal break if shouldKeepRun r lsb lstb LOGGER log FINE 0 is to be purged of artifacts r r deleteArtifacts r r getNextBuild private boolean shouldKeepRun Run r Run lsb Run lstb if r isKeepLog LOGGER log FINER 0 is not to be removed or purged of artifacts because it s marked as a keeper r return true if r lsb LOGGER log FINER 0 is not to be removed or purged of artifacts because it s the last successful build r return true if r lstb LOGGER log FINER 0 is not to be removed or purged of artifacts because it s the last stable build r return true if r isBuilding LOGGER log FINER 0 is not to be removed or purged of artifacts because it s still building r return true return false private boolean tooNew Run r Calendar cal if r getTimestamp before cal LOGGER log FINER 0 is not to be removed or purged of artifacts because it s still new r return true else return false private R Collection R copy Iterable R src return Lists newArrayList src public int getDaysToKeep return daysToKeep public int getNumToKeep return numToKeep public int getArtifactDaysToKeep return unbox artifactDaysToKeep public int getArtifactNumToKeep return unbox artifactNumToKeep public String getDaysToKeepStr return toString daysToKeep public String getNumToKeepStr return toString numToKeep public String getArtifactDaysToKeepStr return toString artifactDaysToKeep public String getArtifactNumToKeepStr return toString artifactNumToKeep private int unbox Integer i return i null 1 i private String toString Integer i if i null i 1 return return String valueOf i Extension Symbol logRotator public static final class LRDescriptor extends BuildDiscarderDescriptor public String getDisplayName return Log Rotation private static final Logger LOGGER Logger getLogger LogRotator class getNamepackage hudson util import hudson console ConsoleNote import hudson model TaskListener import java io ByteArrayOutputStream import java io IOException import java io OutputStream import java io PrintStream import java io PrintWriter import java io Serializable import java util logging Level import java util logging LogRecord import java util logging Logger public class LogTaskListener extends AbstractTaskListener implements Serializable private final TaskListener delegate public LogTaskListener Logger logger Level level delegate new StreamTaskListener new LogOutputStream logger level new Throwable getStackTrace 1 public PrintStream getLogger return delegate getLogger public PrintWriter error String msg return delegate error msg public PrintWriter error String format Object args return delegate error format args public PrintWriter fatalError String msg return delegate fatalError msg public PrintWriter fatalError String format Object args return delegate fatalError format args public void annotate ConsoleNote ann no annotation support public void close delegate getLogger close private static class LogOutputStream extends OutputStream private final Logger logger private final Level level private final StackTraceElement caller private final ByteArrayOutputStream baos new ByteArrayOutputStream public LogOutputStream Logger logger Level level StackTraceElement caller this logger logger this level level this caller caller public void write int b throws IOException if b r b n flush else baos write b Override public void flush throws IOException if baos size 0 LogRecord lr new LogRecord level baos toString lr setLoggerName logger getName lr setSourceClassName caller getClassName lr setSourceMethodName caller getMethodName logger log lr baos reset Override public void close throws IOException flush private static final long serialVersionUID 1Lpackage hudson import java util concurrent ConcurrentHashMap public class Lookup private final ConcurrentHashMap Class Object data new ConcurrentHashMap Class Object public T T get Class T type return type cast data get type public T T set Class T type T instance return type cast data put type instance public T T setIfNull Class T type T instance Object o data putIfAbsent type instance if o null return type cast o return instancepackage hudson util import com thoughtworks xstream converters basic AbstractSingleValueConverter import com thoughtworks xstream converters basic StringConverter import org apache commons collections map LRUMap import java util Collections import java util HashMap import java util Map public class LRUStringConverter extends AbstractSingleValueConverter private final Map String String cache public LRUStringConverter this 1000 public LRUStringConverter int size cache Collections synchronizedMap new LRUMap size public boolean canConvert final Class type return type equals String class public Object fromString final String str String s cache get str if s null cache put str str s str return spackage hudson import jenkins util SystemProperties import hudson util DualOutputStream import hudson util EncodingStream import com thoughtworks xstream core util Base64Encoder import hudson util IOUtils import java io File import java io FileInputStream import java io FileOutputStream import java io IOException import java io OutputStreamWriter import java io Writer import java net HttpRetryException import java net HttpURLConnection import java net URL import java util ArrayList import java util List import java nio charset Charset public class Main public static void main String args try System exit run args catch Exception e e printStackTrace System exit 1 public static int run String args throws Exception String home getHudsonHome if home null System err println JENKINS HOME is not set return 1 if args length 2 System err println Usage job name command args return 1 return remotePost args private static String getHudsonHome String home EnvVars masterEnvVars get JENKINS HOME if home null return home return EnvVars masterEnvVars get HUDSON HOME public static int remotePost String args throws Exception String projectName args 0 String home getHudsonHome if home endsWith home home make sure it ends with check for authentication info String auth new URL home getUserInfo if auth null auth Basic new Base64Encoder encode auth getBytes UTF 8 check if the home is set correctly HttpURLConnection con open new URL home if auth null con setRequestProperty Authorization auth con connect if con getResponseCode 200 con getHeaderField X Hudson null System err println home is not Hudson con getResponseMessage return 1 URL jobURL new URL home job Util encode projectName replace job check if the job name is correct HttpURLConnection con open new URL jobURL acceptBuildResult if auth null con setRequestProperty Authorization auth con connect if con getResponseCode 200 System err println jobURL is not a valid external job con getResponseCode con getResponseMessage return 1 get a crumb to pass the csrf check String crumbField null crumbValue null try HttpURLConnection con open new URL home crumbIssuer api xml xpath concat crumbRequestField crumb if auth null con setRequestProperty Authorization auth String line IOUtils readFirstLine con getInputStream UTF 8 String components line split if components length 2 crumbField components 0 crumbValue components 1 catch IOException e presumably this Hudson doesn t use CSRF protection write the output to a temporary file first File tmpFile File createTempFile hudson log try FileOutputStream os new FileOutputStream tmpFile Writer w new OutputStreamWriter os UTF 8 int ret try w write xml version 1 0 encoding UTF 8 w write run log encoding hexBinary content encoding Charset defaultCharset name w flush run the command long start System currentTimeMillis List String cmd new ArrayList String for int i 1 i args length i cmd add args i Proc proc new Proc LocalProc cmd toArray new String 0 String null System in new DualOutputStream System out new EncodingStream os ret proc join w write log result ret result duration System currentTimeMillis start duration run finally IOUtils closeQuietly w URL location new URL jobURL postBuildResult while true try start a remote connection HttpURLConnection con open location if auth null con setRequestProperty Authorization auth if crumbField null crumbValue null con setRequestProperty crumbField crumbValue con setDoOutput true this tells HttpURLConnection not to buffer the whole thing con setFixedLengthStreamingMode int tmpFile length con connect send the data FileInputStream in new FileInputStream tmpFile try Util copyStream in con getOutputStream finally IOUtils closeQuietly in if con getResponseCode 200 Util copyStream con getErrorStream System err return ret catch HttpRetryException e if e getLocation null retry with the new location location new URL e getLocation continue otherwise failed for reasons beyond us throw e finally tmpFile delete private static HttpURLConnection open URL url throws IOException HttpURLConnection c HttpURLConnection url openConnection c setReadTimeout TIMEOUT c setConnectTimeout TIMEOUT return c public static boolean isUnitTest false public static boolean isDevelopmentMode SystemProperties getBoolean Main class getName development public static final int TIMEOUT SystemProperties getInteger Main class getName timeout 15000package com zxy recovery test import android app Activity import android content Intent import android os Bundle import android view View public class MainActivity extends BaseActivity Override protected void onCreate Bundle savedInstanceState super onCreate savedInstanceState setContentView R layout activity main public void onClick View view if view getId R id btn Activity activity null activity finish else if view getId R id btn2 Intent intent new Intent MainActivity this TestActivity class startActivity intentpackage hudson model import hudson Extension import jenkins model Jenkins import org jenkinsci Symbol Extension ordinal 100 Symbol manageJenkins public class ManageJenkinsAction implements RootAction public String getIconFileName if Jenkins getInstance hasPermission Jenkins ADMINISTER return gear2 png else return null public String getDisplayName return Messages ManageJenkinsAction DisplayName public String getUrlName return managepackage hudson model import hudson ExtensionPoint import hudson ExtensionListView import hudson Extension import hudson ExtensionList import hudson security Permission import jenkins model Jenkins import java util List import org kohsuke stapler interceptor RequirePOST import javax annotation CheckForNull import javax annotation Nonnull public abstract class ManagementLink implements ExtensionPoint Action public abstract CheckForNull String getIconFileName public String getDescription return Override public abstract CheckForNull String getUrlName public boolean getRequiresConfirmation return false Deprecated public static final List ManagementLink LIST ExtensionListView createList ManagementLink class public static Nonnull ExtensionList ManagementLink all return ExtensionList lookup ManagementLink class public CheckForNull Permission getRequiredPermission return null public boolean getRequiresPOST return falsepackage hudson util xstream import com thoughtworks xstream XStream import com thoughtworks xstream converters Converter import com thoughtworks xstream converters SingleValueConverter import com thoughtworks xstream mapper Mapper import com thoughtworks xstream mapper MapperWrapper public class MapperDelegate extends MapperWrapper protected Mapper delegate public MapperDelegate Mapper delegate super null this delegate delegate public String serializedClass Class type return delegate serializedClass type public Class realClass String elementName return delegate realClass elementName public String serializedMember Class type String memberName return delegate serializedMember type memberName public String realMember Class type String serialized return delegate realMember type serialized public boolean isImmutableValueType Class type return delegate isImmutableValueType type public Class defaultImplementationOf Class type return delegate defaultImplementationOf type public String aliasForAttribute String attribute return delegate aliasForAttribute attribute public String attributeForAlias String alias return delegate attributeForAlias alias public String aliasForSystemAttribute String attribute return delegate aliasForSystemAttribute attribute public String getFieldNameForItemTypeAndName Class definedIn Class itemType String itemFieldName return delegate getFieldNameForItemTypeAndName definedIn itemType itemFieldName public Class getItemTypeForItemFieldName Class definedIn String itemFieldName return delegate getItemTypeForItemFieldName definedIn itemFieldName public ImplicitCollectionMapping getImplicitCollectionDefForFieldName Class itemType String fieldName return delegate getImplicitCollectionDefForFieldName itemType fieldName public boolean shouldSerializeMember Class definedIn String fieldName return delegate shouldSerializeMember definedIn fieldName Deprecated public SingleValueConverter getConverterFromItemType String fieldName Class type return delegate getConverterFromItemType fieldName type Deprecated public SingleValueConverter getConverterFromItemType Class type return delegate getConverterFromItemType type Deprecated public SingleValueConverter getConverterFromAttribute String name return delegate getConverterFromAttribute name public Converter getLocalConverter Class definedIn String fieldName return delegate getLocalConverter definedIn fieldName public Mapper lookupMapperOfType Class type return type isAssignableFrom getClass this delegate lookupMapperOfType type public SingleValueConverter getConverterFromItemType String fieldName Class type Class definedIn return delegate getConverterFromItemType fieldName type definedIn Deprecated public String aliasForAttribute Class definedIn String fieldName return delegate aliasForAttribute definedIn fieldName Deprecated public String attributeForAlias Class definedIn String alias return delegate attributeForAlias definedIn alias Deprecated public SingleValueConverter getConverterFromAttribute Class type String attribute return delegate getConverterFromAttribute type attribute public SingleValueConverter getConverterFromAttribute Class definedIn String attribute Class type return delegate getConverterFromAttribute definedIn attribute typepackage hudson model queue import com google common collect ImmutableList import com google common collect Iterables import hudson model Computer import hudson model Executor import hudson model Label import hudson model LoadBalancer import hudson model Node import hudson model Queue BuildableItem import hudson model Queue Executable import hudson model Queue JobOffer import hudson model Queue Task import hudson model labels LabelAssignmentAction import hudson security ACL import java util AbstractList import java util ArrayList import java util Collection import java util HashMap import java util LinkedHashMap import java util List import java util Map import java util Map Entry import static java lang Math public class MappingWorksheet public final List ExecutorChunk executors public final List WorkChunk works public final BuildableItem item private static class ReadOnlyList E extends AbstractList E protected final List E base ReadOnlyList List E base this base base public E get int index return base get index public int size return base size public final class ExecutorChunk extends ReadOnlyList ExecutorSlot public final int index public final Computer computer public final Node node public final ACL nodeAcl private ExecutorChunk List ExecutorSlot base int index super base this index index assert base isEmpty computer base get 0 getExecutor getOwner node computer getNode nodeAcl node getACL public boolean canAccept WorkChunk c if this size c size return false too small compared towork if c assignedLabel null c assignedLabel contains node return false label mismatch if nodeAcl hasPermission item authenticate Computer BUILD return false tasks don t have a permission to run on this node return true public String getName return node getNodeName public int capacity return size private void execute WorkChunk wc WorkUnitContext wuc assert capacity wc size int e 0 for SubTask s wc while get e isAvailable e get e set wuc createWorkUnit s public class WorkChunk extends ReadOnlyList SubTask public final int index the main should be always at position 0 public final boolean isMain public final Label assignedLabel public final ExecutorChunk lastBuiltOn private WorkChunk List SubTask base int index super base assert base isEmpty this index index this assignedLabel getAssignedLabel base get 0 Node lbo base get 0 getLastBuiltOn for ExecutorChunk ec executors if ec node lbo lastBuiltOn ec return lastBuiltOn null private Label getAssignedLabel SubTask task for LabelAssignmentAction laa item getActions LabelAssignmentAction class Label l laa getAssignedLabel task if l null return l return task getAssignedLabel public List ExecutorChunk applicableExecutorChunks List ExecutorChunk r new ArrayList ExecutorChunk executors size for ExecutorChunk e executors if e canAccept this r add e return r public final class Mapping for each WorkChunk identify ExecutorChunk where it is assigned to private final ExecutorChunk mapping new ExecutorChunk works size public ExecutorChunk assigned int n return mapping n public WorkChunk get int n return works get n public ExecutorChunk assign int index ExecutorChunk element ExecutorChunk o mapping index mapping index element return o public int size return mapping length public Map WorkChunk ExecutorChunk toMap Map WorkChunk ExecutorChunk r new HashMap WorkChunk ExecutorChunk for int i 0 i size i r put get i assigned i return r public boolean isPartiallyValid int used new int executors size for int i 0 i mapping length i ExecutorChunk ec mapping i if ec null continue if ec canAccept works i return false invalid assignment if used ec index works i size ec capacity return false return true public boolean isCompletelyValid for ExecutorChunk ec mapping if ec null return false unassigned return isPartiallyValid public void execute WorkUnitContext wuc if isCompletelyValid throw new IllegalStateException for int i 0 i size i assigned i execute get i wuc public MappingWorksheet BuildableItem item List extends ExecutorSlot offers this item offers LoadPredictor all public MappingWorksheet BuildableItem item List extends ExecutorSlot offers Collection extends LoadPredictor loadPredictors this item item group executors by their computers Map Computer List ExecutorSlot j new HashMap Computer List ExecutorSlot for ExecutorSlot o offers Computer c o getExecutor getOwner List ExecutorSlot l j get c if l null j put c l new ArrayList ExecutorSlot l add o take load prediction into account and reduce the available executor pool size accordingly long duration item task getEstimatedDuration if duration 0 long now System currentTimeMillis for Entry Computer List ExecutorSlot e j entrySet final List ExecutorSlot list e getValue final int max e getKey countExecutors build up the prediction model cut the chase if we hit the max Timeline timeline new Timeline int peak 0 OUTER for LoadPredictor lp loadPredictors for FutureLoad fl Iterables limit lp predict this e getKey now now duration 100 peak max peak timeline insert fl startTime fl startTime fl duration fl numExecutors if peak max break OUTER int minIdle max peak minimum number of idle nodes during this time period total predicted load could exceed available executors JENKINS 8882 if minIdle 0 Should we toss a warning info message minIdle 0 if minIdle list size e setValue list subList 0 minIdle build into the final shape List ExecutorChunk executors new ArrayList ExecutorChunk for List ExecutorSlot group j values if group isEmpty continue evict empty group ExecutorChunk ec new ExecutorChunk group executors size if ec node null continue evict out of sync node executors add ec this executors ImmutableList copyOf executors group execution units into chunks use of LinkedHashMap ensures that the main work comes at the top Map Object List SubTask m new LinkedHashMap Object List SubTask for SubTask meu Tasks getSubTasksOf item task Object c Tasks getSameNodeConstraintOf meu if c null c new Object List SubTask l m get c if l null m put c l new ArrayList SubTask l add meu build into the final shape List WorkChunk works new ArrayList WorkChunk for List SubTask group m values works add new WorkChunk group works size this works ImmutableList copyOf works public WorkChunk works int index return works get index public ExecutorChunk executors int index return executors get index public static abstract class ExecutorSlot public abstract Executor getExecutor public abstract boolean isAvailable protected abstract void set WorkUnit p throws UnsupportedOperationExceptionpackage jenkins util import java io IOException import java io OutputStream import java io UnsupportedEncodingException public abstract class MarkFindingOutputStream extends OutputStream private final OutputStream base public MarkFindingOutputStream OutputStream base this base base private int match 0 public synchronized void write int b throws IOException if MBYTES match b another byte matched Good Keep going match if match MBYTES length don t send MARK to the output but instead notify the callback onMarkFound match 0 else if match 0 only matched partially send the partial match that we held off down the pipe base write MBYTES 0 match match 0 this might match the first byte in MARK so retry write b else base write b public void write byte b int off int len throws IOException final int start off final int end off len for int i off i end if MBYTES match b i another byte matched Good Keep going match i if match MBYTES length base write b off i off MBYTES length flush the portion up to MARK don t send MARK to the output but instead notify the callback onMarkFound match 0 off i len end i else if match 0 only matched partially if a part of the partial match spans into the previous write we need to fake that write int extra match i start if extra 0 base write MBYTES 0 extra match 0 this b i might be a fast byte in MARK so we ll retry else irrelevant byte i if we are partially matching can t send that portion yet if len match 0 base write b off len match public void flush throws IOException flushPartialMatch base flush public void close throws IOException flushPartialMatch base close private void flushPartialMatch throws IOException if match 0 base write MBYTES 0 match match 0 protected abstract void onMarkFound having a new line in the end makes it work better with line buffering transformation public static final String MARK Jenkins SYNC MARK n private static final byte MBYTES toUTF8 MARK private static byte toUTF8 String s try return s getBytes UTF 8 catch UnsupportedEncodingException e throw new AssertionError epackage hudson markup import hudson ExtensionPoint import hudson model AbstractDescribableImpl import hudson util HttpResponses import java io IOException import java io StringWriter import java io Writer import javax annotation CheckForNull import javax annotation Nonnull import org kohsuke stapler HttpResponse import org kohsuke stapler QueryParameter public abstract class MarkupFormatter extends AbstractDescribableImpl MarkupFormatter implements ExtensionPoint public abstract void translate CheckForNull String markup Nonnull Writer output throws IOException public final Nonnull String translate CheckForNull String markup throws IOException StringWriter w new StringWriter translate markup w return w toString public String getHelpUrl return getDescriptor getHelpFile syntax Override public MarkupFormatterDescriptor getDescriptor return MarkupFormatterDescriptor super getDescriptor public HttpResponse doPreviewDescription QueryParameter String text throws IOException StringWriter w new StringWriter translate text w return HttpResponses html w toStringpackage hudson markup import hudson DescriptorExtensionList import hudson model Descriptor import jenkins model Jenkins public abstract class MarkupFormatterDescriptor extends Descriptor MarkupFormatter public static DescriptorExtensionList MarkupFormatter MarkupFormatterDescriptor all return Jenkins getInstance MarkupFormatter MarkupFormatterDescriptor getDescriptorList MarkupFormatter classpackage hudson import java util ArrayList import java util Collections import java util List import java util regex Matcher import java util regex Pattern public class MarkupText extends AbstractMarkupText private final String text private final List Tag tags new ArrayList Tag private static final class Tag implements Comparable Tag private final int pos private final String markup public Tag int pos String markup this pos pos this markup markup public int compareTo Tag that return this pos that pos public final class SubText extends AbstractMarkupText private final int start end private final int groups public SubText Matcher m int textOffset start m start textOffset end m end textOffset int cnt m groupCount groups new int cnt 2 for int i 0 i cnt i groups i 2 m start i 1 textOffset groups i 2 1 m end i 1 textOffset public SubText int start int end this start start this end end groups new int 0 Override public SubText subText int start int end return MarkupText this subText this start start end 0 this end 1 end this start end Override public String getText return text substring start end Override public void addMarkup int startPos int endPos String startTag String endTag MarkupText this addMarkup startPos start endPos start startTag endTag public void surroundWith String startTag String endTag addMarkup 0 length replace startTag replace endTag public void surroundWithLiteral String startTag String endTag addMarkup 0 length startTag endTag public void href String url addHyperlink 0 length url public int start int groupIndex if groupIndex 0 return start return groups groupIndex 2 2 public int start return start public int end int groupIndex if groupIndex 0 return end return groups groupIndex 2 1 public int end return end public String group int groupIndex if start groupIndex 1 return null return text substring start groupIndex end groupIndex public int groupCount return groups length 2 public String replace String s StringBuilder buf new StringBuilder s length 10 for int i 0 i s length i char ch s charAt i if ch escape char i buf append s charAt i else if ch replace by group i ch s charAt i get the group number int groupId ch 0 if groupId 0 groupId 9 buf append append ch else add the group text String group group groupId if group null buf append group else other chars buf append ch return buf toString Override protected SubText createSubText Matcher m return new SubText m start public MarkupText String text this text text Override public String getText return text public SubText subText int start int end return new SubText start end 0 text length 1 end end Override public void addMarkup int startPos int endPos String startTag String endTag rangeCheck startPos rangeCheck endPos if startPos endPos throw new IndexOutOfBoundsException when multiple tags are added to the same range we want them to show up like b i abc i b not b i abc b i Also we d like b abc b i def i not b abc i b def i Do this by inserting them to different places tags add new Tag startPos startTag tags add 0 new Tag endPos endTag public void addMarkup int pos String tag rangeCheck pos tags add new Tag pos tag private void rangeCheck int pos if pos 0 pos text length throw new IndexOutOfBoundsException Override Deprecated public String toString return toString false public String toString boolean preEscape if tags isEmpty return preEscape Util xmlEscape text Util escape text the most common case Collections sort tags StringBuilder buf new StringBuilder int copied 0 of chars already copied from text to buf for Tag tag tags if copied tag pos String portion text substring copied tag pos buf append preEscape Util xmlEscape portion Util escape portion copied tag pos buf append tag markup if copied text length String portion text substring copied text length buf append preEscape Util xmlEscape portion Util escape portion return buf toString perhaps this method doesn t need to be here to remain binary compatible with past versions but having this seems to be safer Override public List SubText findTokens Pattern pattern return super findTokens pattern Override protected SubText createSubText Matcher m return new SubText m 0package hudson util import java io IOException import java net URL import java util Arrays import java util Collection import java util List import java util Enumeration import java util Collections import java util concurrent CopyOnWriteArrayList public class MaskingClassLoader extends ClassLoader private final List String masksClasses new CopyOnWriteArrayList private final List String masksResources new CopyOnWriteArrayList public MaskingClassLoader ClassLoader parent String masks this parent Arrays asList masks public MaskingClassLoader ClassLoader parent Collection String masks super parent this masksClasses addAll masks for String mask masks masksResources add mask replace Override protected Class loadClass String name boolean resolve throws ClassNotFoundException for String mask masksClasses if name startsWith mask throw new ClassNotFoundException return super loadClass name resolve Override public URL getResource String name if isMasked name return null return super getResource name Override public Enumeration URL getResources String name throws IOException if isMasked name return Collections emptyEnumeration return super getResources name public void add String prefix masksClasses add prefix if prefix null masksResources add prefix replace private boolean isMasked String name for String mask masksResources if name startsWith mask return true return falsepackage jenkins model import hudson Extension import hudson model Node Mode import net sf json JSONObject import org jenkinsci Symbol import org kohsuke stapler StaplerRequest import java io IOException Extension ordinal 500 Symbol masterBuild public class MasterBuildConfiguration extends GlobalConfiguration public int getNumExecutors return Jenkins getInstance getNumExecutors public String getLabelString return Jenkins getInstance getLabelString Override public boolean configure StaplerRequest req JSONObject json throws FormException Jenkins j Jenkins getInstance try for compatibility reasons this value is stored in Jenkins j setNumExecutors json getInt numExecutors if req hasParameter master mode j setMode Mode valueOf req getParameter master mode else j setMode Mode NORMAL j setLabelString json optString labelString return true catch IOException e throw new FormException e numExecutorspackage jenkins security s2m import hudson Extension import javax inject Inject import jenkins model GlobalConfiguration import jenkins model GlobalConfigurationCategory import jenkins model Jenkins import net sf json JSONObject import org kohsuke stapler StaplerRequest Extension public class MasterKillSwitchConfiguration extends GlobalConfiguration Inject AdminWhitelistRule rule Inject Jenkins jenkins Override public GlobalConfigurationCategory getCategory return GlobalConfigurationCategory get GlobalConfigurationCategory Security class public boolean getMasterToSlaveAccessControl return rule getMasterKillSwitch Override public boolean configure StaplerRequest req JSONObject json throws FormException if isRelevant don t record on off unless this becomes relevant so that we can differentiate those who have disabled vs those who haven t cared rule setMasterKillSwitch json has masterToSlaveAccessControl return true public boolean isRelevant return jenkins hasPermission Jenkins RUN SCRIPTS jenkins isUseSecuritypackage jenkins security s2m import hudson Extension import hudson model AdministrativeMonitor import org kohsuke stapler HttpResponse import org kohsuke stapler HttpResponses import org kohsuke stapler QueryParameter import javax inject Inject import java io IOException Extension public class MasterKillSwitchWarning extends AdministrativeMonitor Inject AdminWhitelistRule rule Inject MasterKillSwitchConfiguration config Override public boolean isActivated return rule getMasterKillSwitch config isRelevant Override public String getDisplayName return Messages MasterKillSwitchWarning DisplayName public HttpResponse doAct QueryParameter String dismiss throws IOException if dismiss null disable true return HttpResponses redirectViaContextPath manage else return HttpResponses redirectViaContextPath configureSecuritypackage jenkins security import hudson remoting Callable import org jenkinsci remoting RoleChecker public abstract class MasterToSlaveCallable V T extends Throwable implements Callable V T Override public void checkRoles RoleChecker checker throws SecurityException checker check this Roles SLAVE private static final long serialVersionUID 1Lpackage jenkins import hudson FilePath FileCallable import jenkins security Roles import org jenkinsci remoting RoleChecker public abstract class MasterToSlaveFileCallable T implements FileCallable T Override public void checkRoles RoleChecker checker throws SecurityException checker check this Roles SLAVE private static final long serialVersionUID 1Lpackage hudson tasks import hudson Extension import jenkins MasterToSlaveFileCallable import hudson Launcher import hudson Functions import hudson EnvVars import hudson Util import hudson CopyOnWrite import hudson Launcher LocalLauncher import hudson model AbstractBuild import hudson model AbstractProject import hudson model BuildListener import hudson model Computer import hudson model EnvironmentSpecific import hudson model Node import jenkins model Jenkins import jenkins mvn GlobalMavenConfig import jenkins mvn GlobalSettingsProvider import jenkins mvn SettingsProvider import hudson model TaskListener import hudson remoting VirtualChannel import hudson slaves NodeSpecific import hudson tasks maven MavenConsoleAnnotator import hudson tools ToolDescriptor import hudson tools ToolInstallation import hudson tools DownloadFromUrlInstaller import hudson tools ToolInstaller import hudson tools ToolProperty import hudson util ArgumentListBuilder import hudson util NullStream import hudson util StreamTaskListener import hudson util VariableResolver import hudson util VariableResolver ByMap import hudson util VariableResolver Union import hudson util FormValidation import hudson util XStream2 import jenkins security MasterToSlaveCallable import net sf json JSONObject import org apache commons lang StringUtils import org kohsuke accmod Restricted import org kohsuke accmod restrictions NoExternalUse import org jenkinsci Symbol import org kohsuke stapler DataBoundConstructor import org kohsuke stapler StaplerRequest import javax annotation Nonnull import java io File import java io IOException import java io ObjectStreamException import java util ArrayList import java util Properties import java util StringTokenizer import java util List import java util Collections import java util Set import java util jar Attributes import java util jar JarFile import java util jar Manifest import java util regex Pattern public class Maven extends Builder public final String targets public final String mavenName public final String jvmOptions public final String pom public final String properties public boolean usePrivateRepository false private SettingsProvider settings private GlobalSettingsProvider globalSettings private Nonnull Boolean injectBuildVariables private final static String MAVEN 1 INSTALLATION COMMON FILE bin maven private final static String MAVEN 2 INSTALLATION COMMON FILE bin mvn private static final Pattern S PATTERN Pattern compile s private static final Pattern GS PATTERN Pattern compile gs public Maven String targets String name this targets name null null null false null null public Maven String targets String name String pom String properties String jvmOptions this targets name pom properties jvmOptions false null null public Maven String targets String name String pom String properties String jvmOptions boolean usePrivateRepository this targets name pom properties jvmOptions usePrivateRepository null null public Maven String targets String name String pom String properties String jvmOptions boolean usePrivateRepository SettingsProvider settings GlobalSettingsProvider globalSettings this targets name pom properties jvmOptions usePrivateRepository settings globalSettings false DataBoundConstructor public Maven String targets String name String pom String properties String jvmOptions boolean usePrivateRepository SettingsProvider settings GlobalSettingsProvider globalSettings boolean injectBuildVariables this targets targets this mavenName name this pom Util fixEmptyAndTrim pom this properties Util fixEmptyAndTrim properties this jvmOptions Util fixEmptyAndTrim jvmOptions this usePrivateRepository usePrivateRepository this settings settings null settings GlobalMavenConfig get getSettingsProvider this globalSettings globalSettings null globalSettings GlobalMavenConfig get getGlobalSettingsProvider this injectBuildVariables injectBuildVariables public String getTargets return targets public SettingsProvider getSettings return settings null settings GlobalMavenConfig get getSettingsProvider protected void setSettings SettingsProvider settings this settings settings public GlobalSettingsProvider getGlobalSettings return globalSettings null globalSettings GlobalMavenConfig get getGlobalSettingsProvider protected void setGlobalSettings GlobalSettingsProvider globalSettings this globalSettings globalSettings public void setUsePrivateRepository boolean usePrivateRepository this usePrivateRepository usePrivateRepository public boolean usesPrivateRepository return usePrivateRepository Restricted NoExternalUse class Exposed for view public boolean isInjectBuildVariables return injectBuildVariables public MavenInstallation getMaven for MavenInstallation i getDescriptor getInstallations if mavenName null mavenName equals i getName return i return null private Object readResolve throws ObjectStreamException if injectBuildVariables null injectBuildVariables true return this private static final class DecideDefaultMavenCommand extends MasterToSlaveFileCallable String private static final long serialVersionUID 2327576423452215146L command line arguments private final String arguments public DecideDefaultMavenCommand String arguments this arguments arguments public String invoke File ws VirtualChannel channel throws IOException String seed null check for the f option StringTokenizer tokens new StringTokenizer arguments while tokens hasMoreTokens String t tokens nextToken if t equals f tokens hasMoreTokens File file new File ws tokens nextToken if file exists continue looks like an error but let the execution fail later seed file isDirectory maven mvn break if seed null as of 1 212 2008 April I think Maven2 mostly replaced Maven1 so switching to err on M2 side seed new File ws project xml exists maven mvn return seed Override public boolean perform AbstractBuild build Launcher launcher BuildListener listener throws IOException InterruptedException VariableResolver String vr build getBuildVariableResolver EnvVars env build getEnvironment listener String targets Util replaceMacro this targets vr targets env expand targets String pom env expand this pom int startIndex 0 int endIndex do split targets into multiple invokations of maven separated by endIndex targets indexOf startIndex if 1 endIndex endIndex targets length String normalizedTarget targets substring startIndex endIndex replaceAll t r n ArgumentListBuilder args new ArgumentListBuilder MavenInstallation mi getMaven if mi null String execName build getWorkspace act new DecideDefaultMavenCommand normalizedTarget args add execName else mi mi forNode Computer currentComputer getNode listener mi mi forEnvironment env String exec mi getExecutable launcher if exec null listener fatalError Messages Maven NoExecutable mi getHome return false args add exec if pom null args add f pom if S PATTERN matcher targets find check the given target goals do not contain settings parameter already String settingsPath SettingsProvider getSettingsRemotePath getSettings build listener if StringUtils isNotBlank settingsPath args add s settingsPath if GS PATTERN matcher targets find String settingsPath GlobalSettingsProvider getSettingsRemotePath getGlobalSettings build listener if StringUtils isNotBlank settingsPath args add gs settingsPath if isInjectBuildVariables Set String sensitiveVars build getSensitiveBuildVariables args addKeyValuePairs D build getBuildVariables sensitiveVars final VariableResolver String resolver new Union String new ByMap String env vr args addKeyValuePairsFromPropertyString D this properties resolver sensitiveVars if usesPrivateRepository args add Dmaven repo local build getWorkspace child repository args addTokenized normalizedTarget wrapUpArguments args normalizedTarget build launcher listener buildEnvVars env mi if launcher isUnix args args toWindowsCommand try MavenConsoleAnnotator mca new MavenConsoleAnnotator listener getLogger build getCharset int r launcher launch cmds args envs env stdout mca pwd build getModuleRoot join if 0 r return false catch IOException e Util displayIOException e listener e printStackTrace listener fatalError Messages Maven ExecFailed return false startIndex endIndex 1 while startIndex targets length return true protected void wrapUpArguments ArgumentListBuilder args String normalizedTarget AbstractBuild build Launcher launcher BuildListener listener throws IOException InterruptedException protected void buildEnvVars EnvVars env MavenInstallation mi throws IOException InterruptedException if mi null if somebody has use M2 HOME they will get a classloading error when M2 HOME points to a different version of Maven2 from MAVEN HOME as Maven 2 gives M2 HOME priority The other solution would be to set M2 HOME if we are calling Maven2 and MAVEN HOME for Maven1 only of use for strange people that are calling Maven2 from Maven1 mi buildEnvVars env just as a precaution see http maven apache org continuum faqs html how does continuum detect a successful build env put MAVEN TERMINATE CMD on String jvmOptions env expand this jvmOptions if jvmOptions null env put MAVEN OPTS jvmOptions replaceAll t r n Override public DescriptorImpl getDescriptor return DescriptorImpl super getDescriptor Deprecated public static DescriptorImpl DESCRIPTOR Extension Symbol maven public static final class DescriptorImpl extends BuildStepDescriptor Builder CopyOnWrite private volatile MavenInstallation installations new MavenInstallation 0 public DescriptorImpl DESCRIPTOR this load public boolean isApplicable Class extends AbstractProject jobType return true Override public String getHelpFile String fieldName if fieldName null fieldName equals globalSettings fieldName settings same help file return super getHelpFile fieldName public String getDisplayName return Messages Maven DisplayName public GlobalSettingsProvider getDefaultGlobalSettingsProvider return GlobalMavenConfig get getGlobalSettingsProvider public SettingsProvider getDefaultSettingsProvider return GlobalMavenConfig get getSettingsProvider public MavenInstallation getInstallations return installations public void setInstallations MavenInstallation installations List MavenInstallation tmpList new ArrayList Maven MavenInstallation remote empty Maven installation if installations null Collections addAll tmpList installations for MavenInstallation installation installations if Util fixEmptyAndTrim installation getName null tmpList remove installation this installations tmpList toArray new MavenInstallation tmpList size save Override public Builder newInstance StaplerRequest req JSONObject formData throws FormException if req null This state is prohibited according to the Javadoc of the super method throw new FormException Maven Build Step new instance method is called for null Stapler request Such call is prohibited req return req bindJSON Maven class formData public static final class MavenInstallation extends ToolInstallation implements EnvironmentSpecific MavenInstallation NodeSpecific MavenInstallation public static final int MAVEN 20 0 public static final int MAVEN 21 1 public static final int MAVEN 30 2 Deprecated kept for backward compatibility use getHome private transient String mavenHome Deprecated public MavenInstallation String name String home super name home DataBoundConstructor public MavenInstallation String name String home List extends ToolProperty properties super Util fixEmptyAndTrim name Util fixEmptyAndTrim home properties Deprecated public String getMavenHome return getHome public File getHomeDir return new File getHome Override public void buildEnvVars EnvVars env String home getHome if home null return env put M2 HOME home env put MAVEN HOME home env put PATH MAVEN home bin public boolean meetsMavenReqVersion Launcher launcher int mavenReqVersion throws IOException InterruptedException FIXME using similar stuff as in the maven plugin could be better olamy but will add a dependency on maven in core so not so good String mavenVersion launcher getChannel call new MasterToSlaveCallable String IOException private static final long serialVersionUID 4143159957567745621L public String call throws IOException File jars new File getHomeDir lib listFiles if jars null be defensive for File jar jars if jar getName startsWith maven JarFile jf null try jf new JarFile jar Manifest manifest jf getManifest String version manifest getMainAttributes getValue Attributes Name IMPLEMENTATION VERSION if version null return version finally if jf null jf close return if mavenVersion equals if mavenReqVersion MAVEN 20 if mavenVersion startsWith 2 return true else if mavenReqVersion MAVEN 21 if mavenVersion startsWith 2 mavenVersion startsWith 2 0 return true else if mavenReqVersion MAVEN 30 if mavenVersion startsWith 3 return true return false public boolean isMaven2 1 Launcher launcher throws IOException InterruptedException return meetsMavenReqVersion launcher MAVEN 21 public String getExecutable Launcher launcher throws IOException InterruptedException return launcher getChannel call new MasterToSlaveCallable String IOException private static final long serialVersionUID 2373163112639943768L public String call throws IOException File exe getExeFile mvn if exe exists return exe getPath exe getExeFile maven if exe exists return exe getPath return null private File getExeFile String execName String m2Home Util replaceMacro getHome EnvVars masterEnvVars if Functions isWindows File exeFile new File m2Home bin execName bat since Maven 3 3 bat files are replaced with cmd if exeFile exists return new File m2Home bin execName cmd return exeFile else return new File m2Home bin execName public boolean getExists try return getExecutable new LocalLauncher new StreamTaskListener new NullStream null catch IOException InterruptedException e return false private static final long serialVersionUID 1L public MavenInstallation forEnvironment EnvVars environment return new MavenInstallation getName environment expand getHome getProperties toList public MavenInstallation forNode Node node TaskListener log throws IOException InterruptedException return new MavenInstallation getName translateFor node log getProperties toList Extension Symbol maven public static class DescriptorImpl extends ToolDescriptor MavenInstallation Override public String getDisplayName return Maven Override public List extends ToolInstaller getDefaultInstallers return Collections singletonList new MavenInstaller null overriding them for backward compatibility newer code need not do this Override public MavenInstallation getInstallations return Jenkins getInstance getDescriptorByType Maven DescriptorImpl class getInstallations overriding them for backward compatibility newer code need not do this Override public void setInstallations MavenInstallation installations Jenkins getInstance getDescriptorByType Maven DescriptorImpl class setInstallations installations Override protected FormValidation checkHomeDirectory File value File maven1File new File value MAVEN 1 INSTALLATION COMMON FILE File maven2File new File value MAVEN 2 INSTALLATION COMMON FILE if maven1File exists maven2File exists return FormValidation error Messages Maven NotMavenDirectory value return FormValidation ok public static class ConverterImpl extends ToolConverter public ConverterImpl XStream2 xstream super xstream Override protected String oldHomeField ToolInstallation obj return MavenInstallation obj mavenHome public static class MavenInstaller extends DownloadFromUrlInstaller DataBoundConstructor public MavenInstaller String id super id Extension Symbol maven public static final class DescriptorImpl extends DownloadFromUrlInstaller DescriptorImpl MavenInstaller public String getDisplayName return Messages InstallFromApache Override public boolean isApplicable Class extends ToolInstallation toolType return toolType MavenInstallation class public interface ProjectWithMaven MavenInstallation inferMavenInstallationpackage hudson tasks maven import hudson Extension import hudson MarkupText import hudson console ConsoleAnnotationDescriptor import hudson console ConsoleAnnotator import hudson console ConsoleNote import org jenkinsci Symbol import java util regex Pattern public class Maven3MojoNote extends ConsoleNote public Maven3MojoNote Override public ConsoleAnnotator annotate Object context MarkupText text int charPos text addMarkup 7 text length b class maven mojo b return null Extension Symbol maven3Mojos public static final class DescriptorImpl extends ConsoleAnnotationDescriptor public String getDisplayName return Maven 3 Mojos public static Pattern PATTERN Pattern compile INFO pluginpackage hudson tasks maven import hudson console LineTransformationOutputStream import java io IOException import java io OutputStream import java nio ByteBuffer import java nio charset Charset import java util regex Matcher public class MavenConsoleAnnotator extends LineTransformationOutputStream private final OutputStream out private final Charset charset public MavenConsoleAnnotator OutputStream out Charset charset this out out this charset charset Override protected void eol byte b int len throws IOException String line charset decode ByteBuffer wrap b 0 len toString trim off CR LF from the end line trimEOL line TODO we need more support for conveniently putting annotations in the middle of the line not just at the beginning we also need the ability for an extension point to have notes hook into the processing Matcher m MavenMojoNote PATTERN matcher line if m matches new MavenMojoNote encodeTo out m Maven3MojoNote PATTERN matcher line if m matches new Maven3MojoNote encodeTo out m MavenWarningNote PATTERN matcher line if m find new MavenWarningNote encodeTo out m MavenErrorNote PATTERN matcher line if m find new MavenErrorNote encodeTo out out write b 0 len Override public void close throws IOException super close out closepackage hudson tasks maven import hudson Extension import hudson MarkupText import hudson console ConsoleAnnotationDescriptor import hudson console ConsoleAnnotator import hudson console ConsoleNote import org jenkinsci Symbol import java util regex Pattern public class MavenErrorNote extends ConsoleNote public MavenErrorNote Override public ConsoleAnnotator annotate Object context MarkupText text int charPos text addMarkup 0 text length span class error inline span return null Extension Symbol mavenErrors public static final class DescriptorImpl extends ConsoleAnnotationDescriptor public String getDisplayName return Maven Errors public static Pattern PATTERN Pattern compile ERRORpackage hudson tasks maven import hudson Extension import hudson MarkupText import hudson console ConsoleAnnotationDescriptor import hudson console ConsoleAnnotator import hudson console ConsoleNote import org jenkinsci Symbol import java util regex Pattern public class MavenMojoNote extends ConsoleNote public MavenMojoNote Override public ConsoleAnnotator annotate Object context MarkupText text int charPos text addMarkup 7 text length b class maven mojo b return null Extension Symbol mavenMojos public static final class DescriptorImpl extends ConsoleAnnotationDescriptor public String getDisplayName return Maven Mojos public static Pattern PATTERN Pattern compile INFO A Za z0 9 A Za z0 9 execution A Za z0 9package hudson tasks maven import hudson Extension import hudson MarkupText import hudson console ConsoleAnnotationDescriptor import hudson console ConsoleAnnotator import hudson console ConsoleNote import org jenkinsci Symbol import java util regex Pattern public class MavenWarningNote extends ConsoleNote public MavenWarningNote Override public ConsoleAnnotator annotate Object context MarkupText text int charPos text addMarkup 0 text length span class warning inline span return null Extension Symbol mavenWarnings public static final class DescriptorImpl extends ConsoleAnnotationDescriptor public String getDisplayName return Maven Warnings public static Pattern PATTERN Pattern compile WARNINGpackage com twitter sdk android core models import com google gson annotations SerializedName public class Media SerializedName media id public final long mediaId SerializedName media id string public final String mediaIdString SerializedName size public final long size SerializedName image public final Image image public Media long mediaID String mediaIdString long size Image image this mediaId mediaID this mediaIdString mediaIdString this size size this image imagepackage com twitter sdk android tweetui internal import android content Context import android graphics drawable Drawable import android util AttributeSet import android view LayoutInflater import android view View import android widget FrameLayout import android widget ImageView import android widget TextView import com twitter sdk android core internal VineCardUtils import com twitter sdk android core models Card import com twitter sdk android core models MediaEntity import com twitter sdk android tweetui R public class MediaBadgeView extends FrameLayout TextView videoDuration ImageView badge public MediaBadgeView Context context this context null public MediaBadgeView Context context AttributeSet attrs this context attrs 0 public MediaBadgeView Context context AttributeSet attrs int defStyleAttr super context attrs defStyleAttr initSubViews context void initSubViews Context context final LayoutInflater inflater LayoutInflater context getSystemService Context LAYOUT INFLATER SERVICE final View view inflater inflate R layout tw media badge this true videoDuration TextView view findViewById R id tw video duration badge ImageView view findViewById R id tw gif badge public void setMediaEntity MediaEntity entity if TweetMediaUtils GIF TYPE equals entity type setBadge getResources getDrawable R drawable tw gif badge else if TweetMediaUtils VIDEO TYPE equals entity type final long duration entity videoInfo null 0 entity videoInfo durationMillis setText duration else setEmpty public void setCard Card card if VineCardUtils isVine card setBadge getResources getDrawable R drawable tw vine badge else setEmpty void setText long duration videoDuration setVisibility View VISIBLE badge setVisibility View GONE videoDuration setText MediaTimeUtils getPlaybackTime duration void setBadge Drawable drawable badge setVisibility View VISIBLE videoDuration setVisibility View GONE badge setImageDrawable drawable void setEmpty videoDuration setVisibility View GONE badge setVisibility View GONEpackage com twitter sdk android core models import com google gson annotations SerializedName import java io Serializable public class MediaEntity extends UrlEntity SerializedName id public final long id SerializedName id str public final String idStr SerializedName media url public final String mediaUrl SerializedName media url https public final String mediaUrlHttps SerializedName sizes public final Sizes sizes SerializedName source status id public final long sourceStatusId SerializedName source status id str public final String sourceStatusIdStr SerializedName type public final String type SerializedName video info public final VideoInfo videoInfo SerializedName ext alt text public final String altText public MediaEntity String url String expandedUrl String displayUrl int start int end long id String idStr String mediaUrl String mediaUrlHttps Sizes sizes long sourceStatusId String sourceStatusIdStr String type VideoInfo videoInfo String altText super url expandedUrl displayUrl start end this id id this idStr idStr this mediaUrl mediaUrl this mediaUrlHttps mediaUrlHttps this sizes sizes this sourceStatusId sourceStatusId this sourceStatusIdStr sourceStatusIdStr this type type this videoInfo videoInfo this altText altText public static class Sizes implements Serializable SerializedName medium public final Size medium SerializedName thumb public final Size thumb SerializedName small public final Size small SerializedName large public final Size large public Sizes Size thumb Size small Size medium Size large this thumb thumb this small small this medium medium this large large public static class Size implements Serializable SerializedName w public final int w SerializedName h public final int h SerializedName resize public final String resize public Size int w int h String resize this w w this h h this resize resizepackage com twitter sdk android core services import com twitter sdk android core models Media import okhttp3 RequestBody import retrofit2 Call import retrofit2 http Multipart import retrofit2 http POST import retrofit2 http Part public interface MediaService Multipart POST https upload twitter com 1 1 media upload json Call Media upload Part media RequestBody media Part media data RequestBody mediaData Part additional owners RequestBody additionalOwnerspackage com twitter sdk android tweetui internal import java util Locale final class MediaTimeUtils private static final String TIME FORMAT LONG 1 d 2 02d 3 02d private static final String TIME FORMAT SHORT 1 d 2 02d private MediaTimeUtils static String getPlaybackTime long timeMillis final int timeSeconds int timeMillis 1000 final int seconds timeSeconds 60 final int minutes timeSeconds 60 60 final int hours timeSeconds 3600 if hours 0 return String format Locale getDefault TIME FORMAT LONG hours minutes seconds else return String format Locale getDefault TIME FORMAT SHORT minutes secondspackage hudson util import java util concurrent ConcurrentHashMap public abstract class Memoizer K V private final ConcurrentHashMap K V store new ConcurrentHashMap K V public V get K key V v store get key if v null return v TODO if we want to we can avoid locking altogether by putting a sentinel value that represents the value is being computed FingerprintMap does this synchronized this v store get key if v null return v v compute key store put key v return v public abstract V compute K key public void clear store clear public Iterable V values return store valuespackage hudson diagnosis import hudson util TimeUnit2 import hudson util ColorPalette import hudson Extension import hudson model PeriodicWork import hudson model MultiStageTimeSeries import hudson model MultiStageTimeSeries TrendChart import hudson model MultiStageTimeSeries TimeScale import java lang management MemoryPoolMXBean import java lang management MemoryType import java lang management MemoryUsage import java lang management ManagementFactory import java util List import java util ArrayList import java io IOException import org jenkinsci Symbol import org kohsuke stapler QueryParameter Extension Symbol memoryUsage public final class MemoryUsageMonitor extends PeriodicWork public final class MemoryGroup private final List MemoryPoolMXBean pools new ArrayList MemoryPoolMXBean public final MultiStageTimeSeries used new MultiStageTimeSeries Messages MemoryUsageMonitor USED ColorPalette RED 0 0 public final MultiStageTimeSeries max new MultiStageTimeSeries Messages MemoryUsageMonitor TOTAL ColorPalette BLUE 0 0 private MemoryGroup List MemoryPoolMXBean pools MemoryType type for MemoryPoolMXBean pool pools if pool getType type this pools add pool private void update long used 0 long max 0 long cur 0 for MemoryPoolMXBean pool pools MemoryUsage usage pool getCollectionUsage if usage null continue not available used usage getUsed max usage getMax usage pool getUsage if usage null continue not available cur usage getUsed B KB used 1024 max 1024 cur 1024 this used update used this max update max return String format d d d d used cur max used 100 max public TrendChart doGraph QueryParameter String type throws IOException return MultiStageTimeSeries createTrendChart TimeScale parse type used max public final MemoryGroup heap public final MemoryGroup nonHeap public MemoryUsageMonitor List MemoryPoolMXBean pools ManagementFactory getMemoryPoolMXBeans heap new MemoryGroup pools MemoryType HEAP nonHeap new MemoryGroup pools MemoryType NON HEAP public long getRecurrencePeriod return TimeUnit2 SECONDS toMillis 10 protected void doRun heap update nonHeap updatepackage com twitter sdk android core models import com google gson annotations SerializedName public class MentionEntity extends Entity SerializedName id public final long id SerializedName id str public final String idStr SerializedName name public final String name SerializedName screen name public final String screenName public MentionEntity long id String idStr String name String screenName int start int end super start end this id id this idStr idStr this name name this screenName screenNamepackage hudson cli declarative import hudson cli CLICommand import hudson util ReflectionUtils import hudson util ReflectionUtils Parameter import org kohsuke args4j Argument import org kohsuke args4j CmdLineException import org kohsuke args4j CmdLineParser import org kohsuke args4j Option import org kohsuke args4j spi FieldSetter import org kohsuke args4j spi Setter import org kohsuke args4j spi OptionHandler import java lang annotation Annotation import java lang reflect AnnotatedElement import java lang reflect InvocationTargetException import java lang reflect Method import java util List class MethodBinder private final CLICommand command private final Method method private final Object arguments public MethodBinder Method method CLICommand command CmdLineParser parser this method method this command command List Parameter params ReflectionUtils getParameters method arguments new Object params size to work in cooperation with earlier arguments add bias to all the ones that this one defines final int bias parser getArguments size for final Parameter p params final int index p index TODO collection and map support Setter setter new Setter public void addValue Object value throws CmdLineException arguments index value public Class getType return p type public boolean isMultiValued return false Override public FieldSetter asFieldSetter return null Override public AnnotatedElement asAnnotatedElement return p Option option p annotation Option class if option null parser addOption setter option Argument arg p annotation Argument class if arg null if bias 0 arg new ArgumentImpl arg bias parser addArgument setter arg if p type CLICommand class arguments index command if p type isPrimitive arguments index ReflectionUtils getVmDefaultValueForPrimitiveType p type public Object call Object instance throws Exception try return method invoke instance arguments catch InvocationTargetException e Throwable t e getTargetException if t instanceof Exception throw Exception t throw e SuppressWarnings ClassExplicitlyAnnotation private static final class ArgumentImpl implements Argument private final Argument base private final int bias private ArgumentImpl Argument base int bias this base base this bias bias public String usage return base usage public String metaVar return base metaVar public boolean required return base required public Class extends OptionHandler handler return base handler public int index return base index bias public boolean multiValued return base multiValued public Class extends Annotation annotationType return base annotationType Override public boolean hidden return base hiddenpackage com twitter sdk android core internal import android content Context import java io File import java io FilenameFilter import java util Arrays import java util Comparator public class MigrationHelper private static final String SHARED PREFS DIR shared prefs public void migrateSessionStore Context context String prefixMatch String expectedFileName final File sharedPrefsDir getSharedPreferencesDir context shared prefs dir has not been created do nothing if sharedPrefsDir exists sharedPrefsDir isDirectory return if shared prefs already exist do nothing final File expectedSharedPrefsFile new File sharedPrefsDir expectedFileName if expectedSharedPrefsFile exists return rename latest final File oldPrefsharedPrefsFile getLatestFile sharedPrefsDir prefixMatch if oldPrefsharedPrefsFile null oldPrefsharedPrefsFile renameTo expectedSharedPrefsFile File getSharedPreferencesDir Context context return new File context getApplicationInfo dataDir SHARED PREFS DIR File getLatestFile File sharedPrefsDir String prefix final File files sharedPrefsDir listFiles new PrefixFileNameFilter prefix Arrays sort files new FileLastModifiedComparator return files length 0 files 0 null static class FileLastModifiedComparator implements Comparator File Override public int compare File file1 File file2 return Long valueOf file2 lastModified compareTo file1 lastModified static class PrefixFileNameFilter implements FilenameFilter final String prefix public PrefixFileNameFilter String prefix this prefix prefix Override public boolean accept File file String filename return filename startsWith prefixpackage com twitter sdk android core internal import android content Context import com twitter sdk android core TwitterCoreTest import java io File import java io FilenameFilter import java io IOException import java util Comparator import static org mockito Mockito mock import static org mockito Mockito when public class MigrationHelperTests extends TwitterCoreTest private static final String SHARED PREFS DIR shared prefs private static final String KIT IDENTIFIER com foo test test private static final String EXPECTED PREFERENCE KIT IDENTIFIER test xml private static final String TEST PREFERENCE KIT IDENTIFIER a b c xml MigrationHelper migrationHelper Override public void setUp throws Exception super setUp migrationHelper new MigrationHelper public void testMigrateSessionStore emptyDirectory throws Exception final File sharedPrefsDir getSharedPreferencesDir getContext clearSharePrefs sharedPrefsDir createSharedPrefsFolder sharedPrefsDir migrationHelper migrateSessionStore getContext KIT IDENTIFIER EXPECTED PREFERENCE assertEquals 0 sharedPrefsDir listFiles length public void testMigrateSessionStore noSharedPrefDirectory throws Exception final File sharedPrefsDir getSharedPreferencesDir getContext clearSharePrefs sharedPrefsDir deleteSharedPrefsFolder sharedPrefsDir migrationHelper migrateSessionStore getContext KIT IDENTIFIER EXPECTED PREFERENCE assertFalse sharedPrefsDir exists public void testMigrateSessionStore notMigrated throws Exception final File sharedPrefsDir getSharedPreferencesDir getContext clearSharePrefs sharedPrefsDir createSharedPrefsFolder sharedPrefsDir createFile sharedPrefsDir TEST PREFERENCE migrationHelper migrateSessionStore getContext KIT IDENTIFIER EXPECTED PREFERENCE final File expected new File sharedPrefsDir EXPECTED PREFERENCE assertTrue expected exists final File oldPrefFile new File sharedPrefsDir TEST PREFERENCE assertFalse oldPrefFile exists public void testMigrateSessionStore alreadyMigrated throws Exception final File sharedPrefsDir getSharedPreferencesDir getContext clearSharePrefs sharedPrefsDir createSharedPrefsFolder sharedPrefsDir createFile sharedPrefsDir TEST PREFERENCE createFile sharedPrefsDir EXPECTED PREFERENCE migrationHelper migrateSessionStore getContext KIT IDENTIFIER EXPECTED PREFERENCE final File expected new File sharedPrefsDir EXPECTED PREFERENCE assertTrue expected exists final File oldPrefFile new File sharedPrefsDir TEST PREFERENCE assertTrue oldPrefFile exists public void testPrefixFileNameFilter throws Exception final FilenameFilter filter new MigrationHelper PrefixFileNameFilter KIT IDENTIFIER assertFalse filter accept null foo xml assertTrue filter accept null KIT IDENTIFIER foo xml public void testFileLastModifiedComparator final Comparator File comparator new MigrationHelper FileLastModifiedComparator final File file1 mock File class when file1 lastModified thenReturn 100L final File file2 mock File class when file2 lastModified thenReturn 200L assertEquals 1 comparator compare file1 file2 assertEquals 1 comparator compare file2 file1 private void clearSharePrefs File sharedPrefsFolder final File files sharedPrefsFolder listFiles if files null return for File file files file delete private void createSharedPrefsFolder File sharedPrefsFolder if sharedPrefsFolder exists sharedPrefsFolder mkdir private void deleteSharedPrefsFolder File sharedPrefsFolder if sharedPrefsFolder exists sharedPrefsFolder delete private File getSharedPreferencesDir Context context return new File context getApplicationInfo dataDir SHARED PREFS DIR private File createFile File sharedPrefsFolder String name final File result new File sharedPrefsFolder name try result createNewFile catch IOException e Ignore return resultpackage jenkins import java io IOException import java util List import hudson PluginWrapper Dependency import hudson Util public class MissingDependencyException extends IOException private String pluginShortName private List Dependency missingDependencies public MissingDependencyException String pluginShortName List Dependency missingDependencies super One or more dependencies could not be resolved for pluginShortName Util join missingDependencies this pluginShortName pluginShortName this missingDependencies missingDependencies public List Dependency getMissingDependencies return missingDependencies public String getPluginShortName return pluginShortNamepackage hudson console import hudson Extension import hudson model import jenkins model Jenkins import org jenkinsci Symbol import java io IOException import java util logging Level import java util logging Logger import javax annotation Nonnull public class ModelHyperlinkNote extends HyperlinkNote public ModelHyperlinkNote String url int length super url length Override protected String extraAttributes return class model link public static String encodeTo Nonnull User u return encodeTo u u getDisplayName public static String encodeTo User u String text return encodeTo u getUrl text public static String encodeTo Item item return encodeTo item item getFullDisplayName public static String encodeTo Item item String text return encodeTo item getUrl text public static String encodeTo Run r return encodeTo r getUrl r getDisplayName public static String encodeTo Node node Computer c node toComputer if c null return encodeTo c getUrl node getDisplayName String nodePath node Jenkins getInstance master node getNodeName return encodeTo computer nodePath node getDisplayName public static String encodeTo String url String text try return new ModelHyperlinkNote url text length encode text catch IOException e impossible but don t make this a fatal problem LOGGER log Level WARNING Failed to serialize ModelHyperlinkNote class e return text Extension Symbol hyperlinkToModels public static class DescriptorImpl extends HyperlinkNote DescriptorImpl public String getDisplayName return Hyperlinks to models private static final long serialVersionUID 1L private static final Logger LOGGER Logger getLogger ModelHyperlinkNote class getNamepackage hudson model public interface ModelObject String getDisplayNamepackage jenkins model import hudson model ModelObject import jenkins model ModelObjectWithContextMenu ContextMenu import org kohsuke stapler StaplerRequest import org kohsuke stapler StaplerResponse public interface ModelObjectWithChildren extends ModelObject public ContextMenu doChildrenContextMenu StaplerRequest request StaplerResponse response throws Exceptionpackage jenkins model import hudson Functions import hudson Util import hudson model Action import hudson model Actionable import hudson model BallColor import hudson model Computer import hudson model Job import hudson model ModelObject import hudson model Node import org apache commons jelly JellyContext import org apache commons jelly JellyException import org apache commons jelly JellyTagException import org apache commons jelly Script import org apache commons jelly XMLOutput import org kohsuke stapler HttpResponse import org kohsuke stapler Stapler import org kohsuke stapler StaplerRequest import org kohsuke stapler StaplerResponse import org kohsuke stapler WebApp import org kohsuke stapler export Exported import org kohsuke stapler export ExportedBean import org kohsuke stapler export Flavor import org kohsuke stapler jelly JellyClassTearOff import org kohsuke stapler jelly JellyFacet import org xml sax helpers DefaultHandler import javax servlet ServletException import java io IOException import java net URI import java net URISyntaxException import java util ArrayList import java util Collection import java util List public interface ModelObjectWithContextMenu extends ModelObject public ContextMenu doContextMenu StaplerRequest request StaplerResponse response throws Exception ExportedBean public class ContextMenu implements HttpResponse Exported inline true public final List MenuItem items new ArrayList MenuItem public void generateResponse StaplerRequest req StaplerResponse rsp Object o throws IOException ServletException rsp serveExposedBean req this Flavor JSON public ContextMenu add String url String text items add new MenuItem url null text return this public ContextMenu addAll Collection extends Action actions for Action a actions add a return this public ContextMenu add Action a if Functions isContextMenuVisible a return this StaplerRequest req Stapler getCurrentRequest String text a getDisplayName String base Functions getIconFilePath a if base null return this String icon Stapler getCurrentRequest getContextPath base startsWith images Functions getResourcePath base String url Functions getActionUrl req findAncestor ModelObject class getUrl a return add url icon text public ContextMenu add String url String icon String text if text null icon null url null items add new MenuItem url icon text return this public ContextMenu add String url String icon String text boolean post if text null icon null url null MenuItem item new MenuItem url icon text item post post items add item return this public ContextMenu add String url String icon String text boolean post boolean requiresConfirmation if text null icon null url null MenuItem item new MenuItem url icon text item post post item requiresConfirmation requiresConfirmation items add item return this public ContextMenu add MenuItem item items add item return this public ContextMenu add Node n Computer c n toComputer return add new MenuItem withDisplayName n getDisplayName withStockIcon c null computer png c getIcon withContextRelativeUrl n getSearchUrl public ContextMenu add Computer c return add new MenuItem withDisplayName c getDisplayName withStockIcon c getIcon withContextRelativeUrl c getUrl public ContextMenu add Job job return add new MenuItem withDisplayName job getDisplayName withIcon job getIconColor withUrl job getSearchUrl public ContextMenu from ModelObjectWithContextMenu self StaplerRequest request StaplerResponse response throws JellyException IOException return from self request response sidepanel public ContextMenu from ModelObjectWithContextMenu self StaplerRequest request StaplerResponse response String view throws JellyException IOException WebApp webApp WebApp getCurrent final Script s webApp getMetaClass self getTearOff JellyClassTearOff class findScript view if s null JellyFacet facet webApp getFacet JellyFacet class request setAttribute taskTags this l task will look for this variable and populate us request setAttribute mode side panel run sidepanel but ignore generated HTML facet scriptInvoker invokeScript request response new Script public Script compile throws JellyException return this public void run JellyContext context XMLOutput output throws JellyTagException Functions initPageVariables context s run context output self new XMLOutput new DefaultHandler else if self instanceof Actionable fallback this addAll Actionable self getAllActions return this ExportedBean public class MenuItem Exported public String url Exported public String displayName Exported public String icon Exported public boolean post Exported public boolean requiresConfirmation Exported inline true public ContextMenu subMenu public MenuItem String url String icon String displayName withUrl url withIcon icon withDisplayName displayName public MenuItem public MenuItem withUrl String url try this url new URI Stapler getCurrentRequest getRequestURI resolve new URI url toString catch URISyntaxException x throw new IllegalArgumentException Bad URI from Stapler getCurrentRequest getRequestURI vs url x return this public MenuItem withContextRelativeUrl String url if url startsWith url url this url Stapler getCurrentRequest getContextPath url return this public MenuItem withIcon String icon this icon icon return this public MenuItem withIcon BallColor color return withStockIcon color getImage public MenuItem withStockIcon String icon this icon Stapler getCurrentRequest getContextPath Jenkins RESOURCE PATH images 24x24 icon return this public MenuItem withDisplayName String displayName this displayName Util escape displayName return this public MenuItem withDisplayName ModelObject o return withDisplayName o getDisplayName interface ContextMenuVisibility extends Action boolean isVisiblepackage hudson model import org kohsuke stapler StaplerRequest import org kohsuke stapler StaplerResponse import javax servlet ServletException import java io IOException public interface ModifiableItemGroup T extends Item extends ItemGroup T T doCreateItem StaplerRequest req StaplerResponse rsp throws IOException ServletExceptionpackage jenkins model import hudson model ModifiableItemGroup import hudson model TopLevelItem import hudson model TopLevelItemDescriptor import java io IOException import java io InputStream public interface ModifiableTopLevelItemGroup extends ModifiableItemGroup TopLevelItem T extends TopLevelItem T copy T src String name throws IOException TopLevelItem createProjectFromXML String name InputStream xml throws IOException TopLevelItem createProject TopLevelItemDescriptor type String name boolean notify throws IOExceptionpackage hudson model import java io IOException import javax annotation Nonnull public interface ModifiableViewGroup extends ViewGroup public void addView Nonnull View view throws IOExceptionimport java util Date import org apache axis client Call import org apache axis client Stub import com adyen services common Amount import com adyen services payment AnyType2AnyTypeMapEntry import com adyen services payment Card import com adyen services payment ModificationRequest import com adyen services payment ModificationResult import com adyen services payment PaymentLocator import com adyen services payment PaymentPortType import com adyen services payment PaymentRequest import com adyen services payment PaymentResult import com adyen services payment Recurring public class Modification public static void main String args try PaymentPortType ws new PaymentLocator getPaymentHttpPort new java net URL Credentials test address Basic HTTP Authentication Stub ws setProperty Call USERNAME PROPERTY Credentials ws user Stub ws setProperty Call PASSWORD PROPERTY Credentials pwd user Cancel or Refund request ModificationRequest request new ModificationRequest request setMerchantAccount Credentials merchant account request setOriginalReference 8513769158577019 ModificationResult result ws cancelOrRefund request System out println new Date System out println result getPspReference System out println result getResponse catch Exception ex ex printStackTracepackage hudson node monitors import hudson model AdministrativeMonitor import hudson Extension Extension public class MonitorMarkedNodeOffline extends AdministrativeMonitor Override public String getDisplayName return Messages MonitorMarkedNodeOffline DisplayName public boolean active false public boolean isActivated return activepackage hudson node monitors import javax annotation Nonnull import hudson slaves OfflineCause public abstract class MonitorOfflineCause extends OfflineCause public abstract Nonnull Class extends NodeMonitor getTriggerpackage hudson util jelly import org apache commons jelly JellyContext import org apache commons jelly JellyException import org apache commons jelly JellyTagException import org apache commons jelly Tag import org apache commons jelly TagLibrary import org apache commons jelly XMLOutput import org apache commons jelly expression Expression import org apache commons jelly impl ExpressionAttribute import org apache commons jelly impl TagScript import org xml sax Attributes import org xml sax SAXException import org xml sax helpers AttributesImpl import java util Arrays import java util Collection import java util Collections import java util Map public class MorphTagLibrary extends TagLibrary Override public Tag createTag final String name Attributes attributes throws JellyException return null Override public TagScript createTagScript final String tagName Attributes attributes throws JellyException return new TagScript private Object evalAttribute String name JellyContext context ExpressionAttribute e attributes get name if e null return null return e exp evaluate context private Collection getExclusions JellyContext context Object exclusion evalAttribute EXCEPT ATTRIBUTES context if exclusion null return Collections emptySet if exclusion instanceof String return Arrays asList exclusion toString split s split by whitespace if exclusion instanceof Collection return Collection exclusion throw new IllegalArgumentException Expected collection for exclusion but found exclusion Override public void run JellyContext context XMLOutput output throws JellyTagException AttributesImpl actual new AttributesImpl Collection exclusions getExclusions context Map String meta Map evalAttribute META ATTRIBUTES context if meta null for Map Entry String e meta entrySet String key e getKey see jelly impl DynamicTag setAttribute attrs has duplicates with Attr suffix if key endsWith Attr meta containsKey key substring 0 key length 4 continue see http github com jenkinsci jelly commit 4ae67d15957b5b4d32751619997a3cb2a6ad56ed if key equals ownerTag continue if exclusions contains key Object v e getValue if v null actual addAttribute key key CDATA v toString else meta Collections emptyMap for Map Entry String ExpressionAttribute e attributes entrySet String name e getKey if name equals META ATTRIBUTES name equals EXCEPT ATTRIBUTES continue already handled if meta containsKey name if the explicit value is also generated by a map delete it first this is O N operation but we don t expect there to be a lot of collisions int idx actual getIndex name if idx 0 actual removeAttribute idx Expression expression e getValue exp actual addAttribute name name CDATA expression evaluateAsString context try output startElement tagName actual getTagBody run context output output endElement tagName catch SAXException x throw new JellyTagException x private static final String META ATTRIBUTES ATTRIBUTES private static final String EXCEPT ATTRIBUTES EXCEPTpackage hudson util import org apache commons fileupload servlet ServletFileUpload import org apache commons fileupload disk DiskFileItemFactory import org apache commons fileupload FileItem import org apache commons fileupload FileUploadException import javax annotation CheckForNull import javax servlet http HttpServletRequest import javax servlet ServletException import java util List import java util Map import java util HashMap public class MultipartFormDataParser private final ServletFileUpload upload new ServletFileUpload new DiskFileItemFactory private final Map String FileItem byName new HashMap String FileItem public MultipartFormDataParser HttpServletRequest request throws ServletException try for FileItem fi List FileItem upload parseRequest request byName put fi getFieldName fi catch FileUploadException e throw new ServletException e public String get String key FileItem fi byName get key if fi null return null return fi getString public FileItem getFileItem String key return byName get key public void cleanUp for FileItem item byName values item delete public static boolean isMultiPartForm CheckForNull String contentType if contentType null return false String parts contentType split if parts length 0 return false for int i 0 i parts length i if multipart form data equals parts i return true return falsepackage hudson model import hudson util TimeUnit2 import hudson util NoOverlapCategoryAxis import hudson util ChartUtil import java io Serializable import java text DateFormat import java text SimpleDateFormat import java util Date import java util Arrays import java util ArrayList import java util List import java io IOException import java awt import java util Locale import org jfree data category DefaultCategoryDataset import org jfree chart JFreeChart import org jfree chart ChartFactory import org jfree chart axis CategoryAxis import org jfree chart axis CategoryLabelPositions import org jfree chart axis NumberAxis import org jfree chart renderer category LineAndShapeRenderer import org jfree chart plot PlotOrientation import org jfree chart plot CategoryPlot import org jfree ui RectangleInsets import org jvnet localizer Localizable import org kohsuke stapler HttpResponse import org kohsuke stapler StaplerRequest import org kohsuke stapler StaplerResponse import org kohsuke stapler export Exported import org kohsuke stapler export ExportedBean import javax servlet ServletException ExportedBean public class MultiStageTimeSeries implements Serializable public final Localizable title public final Color color Exported public final TimeSeries sec10 Exported public final TimeSeries min Exported public final TimeSeries hour private int counter private static final Font CHART FONT Font getFont MultiStageTimeSeries class getName chartFont new Font Font SANS SERIF Font PLAIN 10 public MultiStageTimeSeries Localizable title Color color float initialValue float decay this title title this color color this sec10 new TimeSeries initialValue decay 6 60 this min new TimeSeries initialValue decay 60 24 this hour new TimeSeries initialValue decay 28 24 Deprecated public MultiStageTimeSeries float initialValue float decay this Messages MultiStageTimeSeries EMPTY STRING Color WHITE initialValue decay public void update float f counter counter 1 360 1hour 10sec 60mins 10sec 3600secs 10sec 360 sec10 update f if counter 6 0 min update f if counter 0 hour update f public TimeSeries pick TimeScale timeScale switch timeScale case HOUR return hour case MIN return min case SEC10 return sec10 default throw new AssertionError public float getLatest TimeScale timeScale return pick timeScale getLatest public Api getApi return new Api this public enum TimeScale SEC10 TimeUnit2 SECONDS toMillis 10 MIN TimeUnit2 MINUTES toMillis 1 HOUR TimeUnit2 HOURS toMillis 1 public final long tick TimeScale long tick this tick tick public DateFormat createDateFormat switch this case HOUR return new SimpleDateFormat MMM dd HH case MIN return new SimpleDateFormat HH mm case SEC10 return new SimpleDateFormat HH mm ss default throw new AssertionError public static TimeScale parse String type if type null return TimeScale MIN return Enum valueOf TimeScale class type toUpperCase Locale ENGLISH public static class TrendChart implements HttpResponse public final TimeScale timeScale public final List MultiStageTimeSeries series public final DefaultCategoryDataset dataset public TrendChart TimeScale timeScale MultiStageTimeSeries series this timeScale timeScale this series new ArrayList MultiStageTimeSeries Arrays asList series this dataset createDataset protected DefaultCategoryDataset createDataset float dataPoints new float series size for int i 0 i series size i dataPoints i series get i pick timeScale getHistory int dataLength dataPoints 0 length for float dataPoint dataPoints assert dataLength dataPoint length DefaultCategoryDataset ds new DefaultCategoryDataset DateFormat format timeScale createDateFormat Date dt new Date System currentTimeMillis timeScale tick dataLength for int i dataLength 1 i 0 i dt new Date dt getTime timeScale tick String l format format dt for int j 0 j dataPoints length j ds addValue dataPoints j i series get j title toString l return ds public JFreeChart createChart final JFreeChart chart ChartFactory createLineChart null chart title null unused null range axis label dataset data PlotOrientation VERTICAL orientation true include legend true tooltips false urls chart setBackgroundPaint Color white chart getLegend setItemFont CHART FONT final CategoryPlot plot chart getCategoryPlot configurePlot plot configureRangeAxis NumberAxis plot getRangeAxis crop plot return chart protected void configureRangeAxis NumberAxis rangeAxis rangeAxis setStandardTickUnits NumberAxis createIntegerTickUnits rangeAxis setTickLabelFont CHART FONT rangeAxis setLabelFont CHART FONT protected void crop CategoryPlot plot crop extra space around the graph plot setInsets new RectangleInsets 0 0 0 5 0 protected CategoryAxis configureDomainAxis CategoryPlot plot final CategoryAxis domainAxis new NoOverlapCategoryAxis null plot setDomainAxis domainAxis domainAxis setCategoryLabelPositions CategoryLabelPositions UP 90 domainAxis setLowerMargin 0 0 domainAxis setUpperMargin 0 0 domainAxis setCategoryMargin 0 0 domainAxis setLabelFont CHART FONT domainAxis setTickLabelFont CHART FONT return domainAxis protected void configureRenderer LineAndShapeRenderer renderer renderer setBaseStroke new BasicStroke 3 for int i 0 i series size i renderer setSeriesPaint i series get i color protected void configurePlot CategoryPlot plot plot setBackgroundPaint Color WHITE plot setOutlinePaint null plot setRangeGridlinesVisible true plot setRangeGridlinePaint Color black configureRenderer LineAndShapeRenderer plot getRenderer configureDomainAxis plot public void generateResponse StaplerRequest req StaplerResponse rsp Object node throws IOException ServletException ChartUtil generateGraph req rsp createChart 500 400 public static TrendChart createTrendChart TimeScale scale MultiStageTimeSeries data return new TrendChart scale data private static final long serialVersionUID 1Lpackage com twitter sdk android tweetui internal import android animation ValueAnimator import android content Context import android graphics Matrix import android graphics RectF import android graphics drawable Drawable import android util AttributeSet import android view GestureDetector import android view MotionEvent import android view ScaleGestureDetector import android view animation AccelerateDecelerateInterpolator import android widget ImageView public class MultiTouchImageView extends ImageView private final static long SCALE ANIMATION DURATION 300L private final static float DOUBLE TAP SCALE FACTOR 2 0f private final static float MINIMUM SCALE FACTOR 1 0f final ScaleGestureDetector scaleGestureDetector final GestureDetector gestureDetector final Matrix drawMatrix new Matrix final Matrix baseMatrix new Matrix final Matrix updateMatrix new Matrix final RectF viewRect new RectF Used to avoid allocating new objects final RectF drawRect new RectF final float matrixValues new float 9 public MultiTouchImageView Context context this context null public MultiTouchImageView Context context AttributeSet attrs this context attrs 0 public MultiTouchImageView Context context AttributeSet attrs int defStyleAttr super context attrs defStyleAttr scaleGestureDetector new ScaleGestureDetector context new ScaleGestureDetector SimpleOnScaleGestureListener Override public boolean onScale ScaleGestureDetector scaleGestureDetector setScale scaleGestureDetector getScaleFactor scaleGestureDetector getFocusX scaleGestureDetector getFocusY setImageMatrix return true Override public void onScaleEnd ScaleGestureDetector detector if getScale MINIMUM SCALE FACTOR reset setImageMatrix gestureDetector new GestureDetector context new GestureDetector SimpleOnGestureListener Override public boolean onScroll MotionEvent e1 MotionEvent e2 float dx float dy setTranslate dx dy setImageMatrix return true Override public boolean onDoubleTap MotionEvent e if getScale MINIMUM SCALE FACTOR animateScale getScale MINIMUM SCALE FACTOR e getX e getY else animateScale getScale DOUBLE TAP SCALE FACTOR e getX e getY return true boolean isInitializationComplete final Drawable drawable getDrawable return drawable null drawable getIntrinsicWidth 0 Override protected void onLayout boolean changed int left int top int right int bottom super onLayout changed left top right bottom if isInitializationComplete initializeViewRect initializeBaseMatrix getDrawable setImageMatrix void initializeViewRect viewRect set getPaddingLeft getPaddingTop getWidth getPaddingRight getHeight getPaddingBottom void initializeBaseMatrix Drawable drawable final int drawableWidth drawable getIntrinsicWidth final int drawableHeight drawable getIntrinsicHeight final RectF srcRect new RectF 0 0 drawableWidth drawableHeight baseMatrix reset baseMatrix setRectToRect srcRect viewRect Matrix ScaleToFit CENTER Override public boolean onTouchEvent MotionEvent event if isInitializationComplete return false Do not allow touch events to be intercepted usually for gallery swipes by default getParent requestDisallowInterceptTouchEvent true boolean retVal scaleGestureDetector onTouchEvent event retVal gestureDetector onTouchEvent event retVal return retVal super onTouchEvent event void setScale float ds float px float py updateMatrix postScale ds ds px py float getScale updateMatrix getValues matrixValues return matrixValues Matrix MSCALE X void setTranslate float dx float dy updateMatrix postTranslate dx dy void reset updateMatrix reset void updateMatrixBounds final RectF rect getDrawRect getDrawMatrix float dy 0 float dx 0 if rect height viewRect height dy viewRect height rect height 2 rect top else if rect top 0 dy rect top else if rect bottom viewRect height dy viewRect height rect bottom if rect width viewRect width dx viewRect width rect width 2 rect left else if rect left 0 dx rect left else if rect right viewRect width dx viewRect width rect right setTranslate dx dy RectF getDrawRect Matrix matrix final Drawable drawable getDrawable if drawable null drawRect set 0 0 drawable getIntrinsicWidth drawable getIntrinsicHeight matrix mapRect drawRect return drawRect Matrix getDrawMatrix drawMatrix set baseMatrix drawMatrix postConcat updateMatrix return drawMatrix void setImageMatrix updateMatrixBounds setScaleType ScaleType MATRIX setImageMatrix getDrawMatrix void animateScale float start float end final float px final float py final ValueAnimator animator ValueAnimator ofFloat start end animator setDuration SCALE ANIMATION DURATION animator setInterpolator new AccelerateDecelerateInterpolator animator addUpdateListener new ValueAnimator AnimatorUpdateListener Override public void onAnimationUpdate ValueAnimator valueAnimator final float scale float valueAnimator getAnimatedValue final float ds scale getScale setScale ds px py setImageMatrix animator startpackage com kaku colorfulnews utils import android app Activity import android content Context import android content SharedPreferences import android support design widget TabLayout import android view View import android view ViewGroup import android view inputmethod InputMethodManager import com kaku colorfulnews App import com kaku colorfulnews R import com kaku colorfulnews common Constants import com socks library KLog import java lang reflect Field import java text ParseException import java text SimpleDateFormat import java util Date import java util Locale import retrofit2 adapter rxjava HttpException import rx Subscription public class MyUtils public static boolean isNightMode SharedPreferences preferences App getAppContext getSharedPreferences Constants SHARES COLOURFUL NEWS Activity MODE PRIVATE return preferences getBoolean Constants NIGHT THEME MODE false public static void saveTheme boolean isNight SharedPreferences preferences App getAppContext getSharedPreferences Constants SHARES COLOURFUL NEWS Activity MODE PRIVATE SharedPreferences Editor editor preferences edit editor putBoolean Constants NIGHT THEME MODE isNight editor apply public static SharedPreferences getSharedPreferences return App getAppContext getSharedPreferences Constants SHARES COLOURFUL NEWS Context MODE PRIVATE public static String formatDate String before String after try Date date new SimpleDateFormat yyyy MM dd HH mm ss Locale getDefault parse before after new SimpleDateFormat MM dd HH mm Locale getDefault format date catch ParseException e KLog e e toString return before return after public static int getStatusBarHeight Activity activity int height 0 int resourceId activity getResources getIdentifier status bar height dimen android if resourceId 0 height activity getResources getDimensionPixelSize resourceId return height public static void dynamicSetTabLayoutMode TabLayout tabLayout int tabWidth calculateTabWidth tabLayout int screenWidth getScreenWith if tabWidth screenWidth tabLayout setTabMode TabLayout MODE FIXED else tabLayout setTabMode TabLayout MODE SCROLLABLE private static int calculateTabWidth TabLayout tabLayout int tabWidth 0 for int i 0 i tabLayout getChildCount i final View view tabLayout getChildAt i view measure 0 0 view tabWidth view getMeasuredWidth return tabWidth public static int getScreenWith return App getAppContext getResources getDisplayMetrics widthPixels public static int getColor int nightColor int dayColor int color if MyUtils isNightMode color nightColor else color dayColor return color public static String analyzeNetworkError Throwable e String errMsg App getAppContext getString R string load error if e instanceof HttpException int state HttpException e code if state 403 errMsg App getAppContext getString R string retry after return errMsg public static void cancelSubscription Subscription subscription if subscription null subscription isUnsubscribed subscription unsubscribe public static void fixInputMethodManagerLeak Context destContext if destContext null return InputMethodManager imm InputMethodManager destContext getSystemService Context INPUT METHOD SERVICE if imm null return String arr new String mCurRootView mServedView mNextServedView Field f Object obj get for String param arr try f imm getClass getDeclaredField param if f isAccessible f setAccessible true author sodino mail sodino qq com obj get f get imm if obj get null obj get instanceof View View v get View obj get if v get getContext destContext InputMethodManager context f set imm null path to gc else for break catch Throwable t t printStackTrace public static View getRootView Activity context return ViewGroup context findViewById android R id content getChildAt 0package hudson model import java io IOException import java util ArrayList import java util Collection import java util Collections import java util List import javax servlet ServletException import jenkins model Jenkins import org jenkinsci Symbol import org kohsuke stapler StaplerRequest import org kohsuke stapler StaplerResponse import org kohsuke stapler DataBoundConstructor import hudson model Descriptor FormException import hudson Extension import org kohsuke stapler interceptor RequirePOST public class MyView extends View DataBoundConstructor public MyView String name super name public MyView String name ViewGroup owner this name this owner owner Override public boolean contains TopLevelItem item return item hasPermission Item CONFIGURE RequirePOST Override public TopLevelItem doCreateItem StaplerRequest req StaplerResponse rsp throws IOException ServletException ItemGroup extends TopLevelItem ig getOwnerItemGroup if ig instanceof ModifiableItemGroup return ModifiableItemGroup extends TopLevelItem ig doCreateItem req rsp return null Override public Collection TopLevelItem getItems List TopLevelItem items new ArrayList TopLevelItem for TopLevelItem item getOwnerItemGroup getItems if item hasPermission Item CONFIGURE items add item return Collections unmodifiableList items Override public String getPostConstructLandingPage return there s no configuration page Override protected void submit StaplerRequest req throws IOException ServletException FormException noop Extension Symbol myView public static final class DescriptorImpl extends ViewDescriptor Override public boolean isInstantiable return Jenkins getInstance isUseSecurity public String getDisplayName return Messages MyView DisplayNamepackage hudson model import hudson Extension import hudson Util import hudson model Descriptor FormException import hudson security ACL import hudson security Permission import hudson util FormValidation import hudson views MyViewsTabBar import hudson views ViewsTabBar import java io IOException import java text ParseException import java util Collection import java util Collections import java util List import java util concurrent CopyOnWriteArrayList import javax servlet ServletException import jenkins model Jenkins import net sf json JSONObject import org acegisecurity AccessDeniedException import org jenkinsci Symbol import org kohsuke stapler DataBoundConstructor import org kohsuke stapler HttpRedirect import org kohsuke stapler HttpResponse import org kohsuke stapler QueryParameter import org kohsuke stapler StaplerFallback import org kohsuke stapler StaplerRequest import org kohsuke stapler StaplerResponse public class MyViewsProperty extends UserProperty implements ModifiableViewGroup Action StaplerFallback private String primaryViewName private CopyOnWriteArrayList View views new CopyOnWriteArrayList View private transient ViewGroupMixIn viewGroupMixIn DataBoundConstructor public MyViewsProperty String primaryViewName this primaryViewName primaryViewName private MyViewsProperty readResolve public Object readResolve if views null this shouldn t happen but an error in 1 319 meant the last view could be deleted views new CopyOnWriteArrayList View if views isEmpty preserve the non empty invariant views add new AllView Messages Hudson ViewName this viewGroupMixIn new ViewGroupMixIn this protected List View views return views protected String primaryView return primaryViewName protected void primaryView String name primaryViewName name return this public String getPrimaryViewName return primaryViewName public void setPrimaryViewName String primaryViewName this primaryViewName primaryViewName public User getUser return user ViewGroup methods public String getUrl return user getUrl my views public void save throws IOException user save public Collection View getViews return viewGroupMixIn getViews public View getView String name return viewGroupMixIn getView name public boolean canDelete View view return viewGroupMixIn canDelete view public void deleteView View view throws IOException viewGroupMixIn deleteView view public void onViewRenamed View view String oldName String newName viewGroupMixIn onViewRenamed view oldName newName Override public void addView View view throws IOException viewGroupMixIn addView view public View getPrimaryView return viewGroupMixIn getPrimaryView public HttpResponse doIndex return new HttpRedirect view Util rawEncode getPrimaryView getViewName public synchronized void doCreateView StaplerRequest req StaplerResponse rsp throws IOException ServletException ParseException FormException checkPermission View CREATE addView View create req rsp this public FormValidation doViewExistsCheck QueryParameter String value QueryParameter boolean exists checkPermission View CREATE String view Util fixEmpty value if view null return FormValidation ok if exists return getView view null FormValidation ok FormValidation error Messages MyViewsProperty ViewExistsCheck NotExist view else return getView view null FormValidation ok FormValidation error Messages MyViewsProperty ViewExistsCheck AlreadyExists view public ACL getACL return user getACL public void checkPermission Permission permission throws AccessDeniedException getACL checkPermission permission public boolean hasPermission Permission permission return getACL hasPermission permission Action methods public String getDisplayName return Messages MyViewsProperty DisplayName public String getIconFileName return user png public String getUrlName return my views Extension Symbol myView public static class DescriptorImpl extends UserPropertyDescriptor Override public String getDisplayName return Messages MyViewsProperty DisplayName Override public UserProperty newInstance User user return new MyViewsProperty Override public UserProperty reconfigure StaplerRequest req JSONObject form throws FormException req bindJSON this form return this public ViewsTabBar getViewsTabBar return Jenkins getInstance getViewsTabBar public ItemGroup extends TopLevelItem getItemGroup return Jenkins getInstance public List Action getViewActions Jenkins getInstance getViewActions are tempting but they are in a wrong scope return Collections emptyList public Object getStaplerFallback return getPrimaryView public MyViewsTabBar getMyViewsTabBar return Jenkins getInstance getMyViewsTabBar Extension Symbol myView public static class GlobalAction implements RootAction public String getDisplayName return Messages MyViewsProperty GlobalAction DisplayName public String getIconFileName do not show when not logged in if User current null return null return user png public String getUrlName return me my viewspackage hudson views import hudson DescriptorExtensionList import hudson Extension import hudson ExtensionPoint import hudson model AbstractDescribableImpl import hudson model Descriptor import jenkins model GlobalConfiguration import jenkins model Jenkins import hudson model MyViewsProperty import net sf json JSONObject import org jenkinsci Symbol import org kohsuke stapler StaplerRequest public abstract class MyViewsTabBar extends AbstractDescribableImpl MyViewsTabBar implements ExtensionPoint public static DescriptorExtensionList MyViewsTabBar Descriptor MyViewsTabBar all return Jenkins getInstance MyViewsTabBar Descriptor MyViewsTabBar getDescriptorList MyViewsTabBar class public MyViewsTabBarDescriptor getDescriptor return MyViewsTabBarDescriptor super getDescriptor Extension ordinal 305 Symbol myView public static class GlobalConfigurationImpl extends GlobalConfiguration public MyViewsTabBar getMyViewsTabBar return Jenkins getInstance getMyViewsTabBar Override public boolean configure StaplerRequest req JSONObject json throws FormException for compatibility reasons the actual value is stored in Jenkins Jenkins j Jenkins getInstance if json has myViewsTabBar j setMyViewsTabBar req bindJSON MyViewsTabBar class json getJSONObject myViewsTabBar else j setMyViewsTabBar new DefaultMyViewsTabBar return truepackage hudson views import hudson model Descriptor public abstract class MyViewsTabBarDescriptor extends Descriptor MyViewsTabBar so far nothing different from plain Descriptor but it may prove useful for future expansionpackage hudson util import java util concurrent ThreadFactory import java util concurrent atomic AtomicInteger public final class NamingThreadFactory implements ThreadFactory private final AtomicInteger threadNum new AtomicInteger private final ThreadFactory delegate private final String name public NamingThreadFactory ThreadFactory delegate String name this delegate delegate this name name TODO consider uniquifying this Override public Thread newThread Runnable r Thread t delegate newThread r t setName name threadNum incrementAndGet return tpackage jenkins model item category import hudson Extension import org kohsuke accmod Restricted import org kohsuke accmod restrictions DoNotUse Restricted DoNotUse class Extension ordinal 100 public class NestedProjectsCategory extends ItemCategory private static final String ID nested projects Override public String getId return ID Override public String getDescription return Messages NestedProjects Description Override public String getDisplayName return Messages NestedProjects DisplayName Override public int getMinToShow return ItemCategory MIN TOSHOWpackage com kaku colorfulnews utils import android content Context import android net ConnectivityManager import android net NetworkInfo import android widget Toast import com kaku colorfulnews App import com kaku colorfulnews R public class NetUtil public static boolean isNetworkAvailable ConnectivityManager connectivityManager ConnectivityManager App getAppContext getSystemService Context CONNECTIVITY SERVICE if connectivityManager null NetworkInfo info connectivityManager getActiveNetworkInfo if info null info isConnected if info getState NetworkInfo State CONNECTED return true return false public static boolean isNetworkErrThenShowMsg if isNetworkAvailable TODO app Snackbar why Toast makeText App getAppContext App getAppContext getString R string internet error Toast LENGTH SHORT show return true return falsepackage com kaku colorfulnews mvp presenter impl import com kaku colorfulnews greendao NewsChannelTable import com kaku colorfulnews mvp interactor NewsInteractor import com kaku colorfulnews mvp interactor impl NewsInteractorImpl import com kaku colorfulnews mvp presenter NewsPresenter import com kaku colorfulnews mvp presenter base BasePresenterImpl import com kaku colorfulnews mvp view NewsView import java util List import javax inject Inject public class NewPresenterImpl extends BasePresenterImpl NewsView List NewsChannelTable implements NewsPresenter private NewsInteractor List NewsChannelTable mNewsInteractor Inject public NewPresenterImpl NewsInteractorImpl newsInteractor mNewsInteractor newsInteractor Override public void onCreate super onCreate loadNewsChannels private void loadNewsChannels mSubscription mNewsInteractor lodeNewsChannels this Override public void success List NewsChannelTable data super success data mView initViewPager data Override public void onChannelDbChanged loadNewsChannelspackage com kaku colorfulnews mvp ui activities import android content Intent import android os Bundle import android support design widget FloatingActionButton import android support design widget NavigationView import android support design widget Snackbar import android support design widget TabLayout import android support v4 app Fragment import android support v4 view ViewPager import android support v4 widget DrawerLayout import android support v7 widget Toolbar import android view View import com kaku colorfulnews R import com kaku colorfulnews common Constants import com kaku colorfulnews event ChannelChangeEvent import com kaku colorfulnews event ScrollToTopEvent import com kaku colorfulnews greendao NewsChannelTable import com kaku colorfulnews mvp presenter impl NewPresenterImpl import com kaku colorfulnews mvp ui activities base BaseActivity import com kaku colorfulnews mvp ui adapter PagerAdapter NewsFragmentPagerAdapter import com kaku colorfulnews mvp ui fragment NewsListFragment import com kaku colorfulnews mvp view NewsView import com kaku colorfulnews utils MyUtils import com kaku colorfulnews utils RxBus import java util ArrayList import java util List import javax inject Inject import butterknife BindView import butterknife OnClick import rx functions Action1 public class NewsActivity extends BaseActivity implements NewsView private String mCurrentViewPagerName private List String mChannelNames BindView R id toolbar Toolbar mToolbar BindView R id tabs TabLayout mTabs BindView R id view pager ViewPager mViewPager BindView R id nav view NavigationView mNavView BindView R id fab FloatingActionButton mFab BindView R id drawer layout DrawerLayout mDrawerLayout Inject NewPresenterImpl mNewsPresenter private List Fragment mNewsFragmentList new ArrayList Override protected void onCreate Bundle savedInstanceState super onCreate savedInstanceState mSubscription RxBus getInstance toObservable ChannelChangeEvent class subscribe new Action1 ChannelChangeEvent Override public void call ChannelChangeEvent channelChangeEvent mNewsPresenter onChannelDbChanged Override public int getLayoutId return R layout activity news Override public void initInjector mActivityComponent inject this Override public void initViews mIsHasNavigationView true mBaseNavView mNavView mPresenter mNewsPresenter mPresenter attachView this OnClick R id fab R id add channel iv public void onClick View view switch view getId case R id fab RxBus getInstance post new ScrollToTopEvent break case R id add channel iv Intent intent new Intent this NewsChannelActivity class startActivity intent break Override public void initViewPager List NewsChannelTable newsChannels final List String channelNames new ArrayList if newsChannels null setNewsList newsChannels channelNames setViewPager channelNames private void setNewsList List NewsChannelTable newsChannels List String channelNames mNewsFragmentList clear for NewsChannelTable newsChannel newsChannels NewsListFragment newsListFragment createListFragments newsChannel mNewsFragmentList add newsListFragment channelNames add newsChannel getNewsChannelName private NewsListFragment createListFragments NewsChannelTable newsChannel NewsListFragment fragment new NewsListFragment Bundle bundle new Bundle bundle putString Constants NEWS ID newsChannel getNewsChannelId bundle putString Constants NEWS TYPE newsChannel getNewsChannelType bundle putInt Constants CHANNEL POSITION newsChannel getNewsChannelIndex fragment setArguments bundle return fragment private void setViewPager List String channelNames NewsFragmentPagerAdapter adapter new NewsFragmentPagerAdapter getSupportFragmentManager channelNames mNewsFragmentList mViewPager setAdapter adapter mTabs setupWithViewPager mViewPager MyUtils dynamicSetTabLayoutMode mTabs mTabs setTabsFromPagerAdapter adapter setPageChangeListener mChannelNames channelNames int currentViewPagerPosition getCurrentViewPagerPosition mViewPager setCurrentItem currentViewPagerPosition false private int getCurrentViewPagerPosition int position 0 if mCurrentViewPagerName null for int i 0 i mChannelNames size i if mCurrentViewPagerName equals mChannelNames get i position i return position private void setPageChangeListener mViewPager addOnPageChangeListener new ViewPager OnPageChangeListener Override public void onPageScrolled int position float positionOffset int positionOffsetPixels Override public void onPageSelected int position mCurrentViewPagerName mChannelNames get position Override public void onPageScrollStateChanged int state Override public void showProgress Override public void hideProgress Override public void showMsg String message Snackbar make mFab message Snackbar LENGTH SHORT showpackage com kaku colorfulnews mvp ui activities import android support v7 widget Toolbar import android view View import android webkit WebChromeClient import android webkit WebSettings import android webkit WebView import android webkit WebViewClient import android widget ProgressBar import com kaku colorfulnews R import com kaku colorfulnews common Constants import com kaku colorfulnews mvp ui activities base BaseActivity import butterknife BindView public class NewsBrowserActivity extends BaseActivity BindView R id toolbar Toolbar mToolbar BindView R id web view WebView mWebView BindView R id progress bar ProgressBar mProgressBar Override public int getLayoutId return R layout activity news browser Override public void initInjector Override public void initViews mToolbar setTitle getIntent getStringExtra Constants NEWS TITLE initWebView private void initWebView setWebViewSettings setWebView private void setWebViewSettings WebSettings webSettings mWebView getSettings webSettings setUseWideViewPort true webview webSettings setLoadWithOverviewMode true webSettings setJavaScriptEnabled true js webSettings setSupportZoom true webSettings setBuiltInZoomControls true http blog csdn net dreamer0924 article details 34082687 webSettings setAppCacheEnabled true webSettings setCacheMode WebSettings LOAD CACHE ELSE NETWORK private void setWebView mWebView loadUrl getIntent getStringExtra Constants NEWS LINK mWebView setWebViewClient new WebViewClient Override public boolean shouldOverrideUrlLoading WebView view String url if url null view loadUrl url return true mWebView setWebChromeClient new WebChromeClient Override public void onProgressChanged WebView view int newProgress super onProgressChanged view newProgress if newProgress 100 mProgressBar setVisibility View GONE else mProgressBar setVisibility View VISIBLE mProgressBar setProgress newProgress Override protected void onDestroy super onDestroy mWebView removeAllViews mWebView destroypackage com kaku colorfulnews mvp ui activities import android os Bundle import android support design widget Snackbar import android support v7 widget DefaultItemAnimator import android support v7 widget GridLayoutManager import android support v7 widget LinearLayoutManager import android support v7 widget RecyclerView import android support v7 widget Toolbar import android support v7 widget helper ItemTouchHelper import android view View import com kaku colorfulnews R import com kaku colorfulnews event ChannelItemMoveEvent import com kaku colorfulnews greendao NewsChannelTable import com kaku colorfulnews listener OnItemClickListener import com kaku colorfulnews mvp presenter impl NewsChannelPresenterImpl import com kaku colorfulnews mvp ui activities base BaseActivity import com kaku colorfulnews mvp ui adapter NewsChannelAdapter import com kaku colorfulnews widget ItemDragHelperCallback import com kaku colorfulnews mvp view NewsChannelView import com kaku colorfulnews utils RxBus import java util List import javax inject Inject import butterknife BindView import rx functions Action1 public class NewsChannelActivity extends BaseActivity implements NewsChannelView BindView R id toolbar Toolbar mToolbar BindView R id news channel mine rv RecyclerView mNewsChannelMineRv BindView R id news channel more rv RecyclerView mNewsChannelMoreRv Inject NewsChannelPresenterImpl mNewsChannelPresenter private NewsChannelAdapter mNewsChannelAdapterMine private NewsChannelAdapter mNewsChannelAdapterMore Override protected void onCreate Bundle savedInstanceState super onCreate savedInstanceState mSubscription RxBus getInstance toObservable ChannelItemMoveEvent class subscribe new Action1 ChannelItemMoveEvent Override public void call ChannelItemMoveEvent channelItemMoveEvent int fromPosition channelItemMoveEvent getFromPosition int toPosition channelItemMoveEvent getToPosition mNewsChannelPresenter onItemSwap fromPosition toPosition Override public int getLayoutId return R layout activity news channel Override public void initInjector mActivityComponent inject this Override public void initViews mPresenter mNewsChannelPresenter mPresenter attachView this Override public void initRecyclerViews List NewsChannelTable newsChannelsMine List NewsChannelTable newsChannelsMore initRecyclerViewMineAndMore newsChannelsMine newsChannelsMore private void initRecyclerViewMineAndMore List NewsChannelTable newsChannelsMine List NewsChannelTable newsChannelsMore initRecyclerView mNewsChannelMineRv newsChannelsMine true initRecyclerView mNewsChannelMoreRv newsChannelsMore false private void initRecyclerView RecyclerView recyclerView List NewsChannelTable newsChannels final boolean isChannelMine recyclerView setHasFixedSize true recyclerView setLayoutManager new GridLayoutManager this 4 LinearLayoutManager VERTICAL false recyclerView setItemAnimator new DefaultItemAnimator if isChannelMine mNewsChannelAdapterMine new NewsChannelAdapter newsChannels recyclerView setAdapter mNewsChannelAdapterMine setChannelMineOnItemClick initItemDragHelper else mNewsChannelAdapterMore new NewsChannelAdapter newsChannels recyclerView setAdapter mNewsChannelAdapterMore setChannelMoreOnItemClick private void setChannelMineOnItemClick mNewsChannelAdapterMine setOnItemClickListener new OnItemClickListener Override public void onItemClick View view int position NewsChannelTable newsChannel mNewsChannelAdapterMine getData get position boolean isNewsChannelFixed newsChannel getNewsChannelFixed if isNewsChannelFixed mNewsChannelAdapterMore add mNewsChannelAdapterMore getItemCount newsChannel mNewsChannelAdapterMine delete position mNewsChannelPresenter onItemAddOrRemove newsChannel true private void setChannelMoreOnItemClick mNewsChannelAdapterMore setOnItemClickListener new OnItemClickListener Override public void onItemClick View view int position NewsChannelTable newsChannel mNewsChannelAdapterMore getData get position mNewsChannelAdapterMine add mNewsChannelAdapterMine getItemCount newsChannel mNewsChannelAdapterMore delete position mNewsChannelPresenter onItemAddOrRemove newsChannel false private void initItemDragHelper ItemDragHelperCallback itemDragHelperCallback new ItemDragHelperCallback mNewsChannelAdapterMine ItemTouchHelper itemTouchHelper new ItemTouchHelper itemDragHelperCallback itemTouchHelper attachToRecyclerView mNewsChannelMineRv mNewsChannelAdapterMine setItemDragHelperCallback itemDragHelperCallback Override public void showProgress Override public void hideProgress Override public void showMsg String message Snackbar make mNewsChannelMoreRv message Snackbar LENGTH SHORT showpackage com kaku colorfulnews mvp ui adapter import android support v4 content ContextCompat import android support v7 widget RecyclerView import android view LayoutInflater import android view MotionEvent import android view View import android view ViewGroup import android widget TextView import com kaku colorfulnews App import com kaku colorfulnews R import com kaku colorfulnews event ChannelItemMoveEvent import com kaku colorfulnews greendao NewsChannelTable import com kaku colorfulnews listener OnItemClickListener import com kaku colorfulnews mvp ui adapter base BaseRecyclerViewAdapter import com kaku colorfulnews widget ItemDragHelperCallback import com kaku colorfulnews utils ClickUtil import com kaku colorfulnews utils MyUtils import com kaku colorfulnews utils RxBus import java util Collections import java util List import butterknife BindView import butterknife ButterKnife public class NewsChannelAdapter extends BaseRecyclerViewAdapter NewsChannelTable implements ItemDragHelperCallback OnItemMoveListener private static final int TYPE CHANNEL FIXED 0 private static final int TYPE CHANNEL NO FIXED 1 private ItemDragHelperCallback mItemDragHelperCallback private OnItemClickListener mOnItemClickListener public void setOnItemClickListener OnItemClickListener onItemClickListener mOnItemClickListener onItemClickListener public void setItemDragHelperCallback ItemDragHelperCallback itemDragHelperCallback mItemDragHelperCallback itemDragHelperCallback public NewsChannelAdapter List NewsChannelTable newsChannelTableList super newsChannelTableList public List NewsChannelTable getData return mList Override public NewsChannelViewHolder onCreateViewHolder ViewGroup parent final int viewType View view LayoutInflater from parent getContext inflate R layout item news channel parent false final NewsChannelViewHolder newsChannelViewHolder new NewsChannelViewHolder view handleLongPress newsChannelViewHolder handleOnClick newsChannelViewHolder return newsChannelViewHolder private void handleLongPress final NewsChannelViewHolder newsChannelViewHolder if mItemDragHelperCallback null newsChannelViewHolder itemView setOnTouchListener new View OnTouchListener Override public boolean onTouch View v MotionEvent event NewsChannelTable newsChannel mList get newsChannelViewHolder getLayoutPosition boolean isChannelFixed newsChannel getNewsChannelFixed if isChannelFixed mItemDragHelperCallback setLongPressEnabled false else mItemDragHelperCallback setLongPressEnabled true return false private void handleOnClick final NewsChannelViewHolder newsChannelViewHolder if mOnItemClickListener null newsChannelViewHolder itemView setOnClickListener new View OnClickListener Override public void onClick View v if ClickUtil isFastDoubleClick mOnItemClickListener onItemClick v newsChannelViewHolder getLayoutPosition Override public void onBindViewHolder RecyclerView ViewHolder holder int position final NewsChannelTable newsChannel mList get position String newsChannelName newsChannel getNewsChannelName NewsChannelViewHolder viewHolder NewsChannelViewHolder holder viewHolder mNewsChannelTv setText newsChannelName if newsChannel getNewsChannelIndex 0 viewHolder mNewsChannelTv setTextColor ContextCompat getColor App getAppContext getColorId private int getColorId int colorId if MyUtils isNightMode colorId R color alpha 40 white else colorId R color alpha 40 black return colorId Override public int getItemViewType int position Boolean isFixed mList get position getNewsChannelFixed if isFixed return TYPE CHANNEL FIXED else return TYPE CHANNEL NO FIXED Override public boolean onItemMove int fromPosition int toPosition if isChannelFixed fromPosition toPosition return false Collections swap mList fromPosition toPosition notifyItemMoved fromPosition toPosition RxBus getInstance post new ChannelItemMoveEvent fromPosition toPosition return true private boolean isChannelFixed int fromPosition int toPosition return mList get fromPosition getNewsChannelFixed mList get toPosition getNewsChannelFixed class NewsChannelViewHolder extends RecyclerView ViewHolder BindView R id news channel tv TextView mNewsChannelTv public NewsChannelViewHolder View view super view ButterKnife bind this viewpackage com kaku colorfulnews mvp interactor import com kaku colorfulnews greendao NewsChannelTable import com kaku colorfulnews listener RequestCallBack import rx Subscription public interface NewsChannelInteractor T Subscription lodeNewsChannels RequestCallBack T callback void swapDb int fromPosition int toPosition void updateDb NewsChannelTable newsChannel boolean isChannelMinepackage com kaku colorfulnews mvp interactor impl import com kaku colorfulnews App import com kaku colorfulnews R import com kaku colorfulnews common Constants import com kaku colorfulnews greendao NewsChannelTable import com kaku colorfulnews listener RequestCallBack import com kaku colorfulnews mvp interactor NewsChannelInteractor import com kaku colorfulnews repository db NewsChannelTableManager import com kaku colorfulnews utils TransformUtils import com socks library KLog import java util HashMap import java util List import java util Map import java util concurrent ExecutorService import java util concurrent Executors import javax inject Inject import rx Subscriber import rx Subscription public class NewsChannelInteractorImpl implements NewsChannelInteractor Map Integer List NewsChannelTable private ExecutorService mSingleThreadPool Inject public NewsChannelInteractorImpl Override public Subscription lodeNewsChannels final RequestCallBack Map Integer List NewsChannelTable callback return rx Observable create new rx Observable OnSubscribe Map Integer List NewsChannelTable Override public void call Subscriber super Map Integer List NewsChannelTable subscriber Map Integer List NewsChannelTable newsChannelListMap getNewsChannelData subscriber onNext newsChannelListMap subscriber onCompleted compose TransformUtils Map Integer List NewsChannelTable defaultSchedulers subscribe new Subscriber Map Integer List NewsChannelTable Override public void onCompleted Override public void onError Throwable e callback onError App getAppContext getString R string db error Override public void onNext Map Integer List NewsChannelTable newsChannelListMap callback success newsChannelListMap private Map Integer List NewsChannelTable getNewsChannelData Map Integer List NewsChannelTable map new HashMap List NewsChannelTable channelListMine NewsChannelTableManager loadNewsChannelsMine List NewsChannelTable channelListMore NewsChannelTableManager loadNewsChannelsMore map put Constants NEWS CHANNEL MINE channelListMine map put Constants NEWS CHANNEL MORE channelListMore return map Override public void swapDb final int fromPosition final int toPosition createThreadPool mSingleThreadPool execute new Runnable Override public void run KLog d Thread currentThread getName KLog d fromPosition fromPosition toPosition toPosition NewsChannelTable fromNewsChannel NewsChannelTableManager loadNewsChannel fromPosition NewsChannelTable toNewsChannel NewsChannelTableManager loadNewsChannel toPosition if isAdjacent fromPosition toPosition swapAdjacentIndexAndUpdate fromNewsChannel toNewsChannel else if fromPosition toPosition 0 List NewsChannelTable newsChannels NewsChannelTableManager loadNewsChannelsWithin toPosition fromPosition 1 increaseOrReduceIndexAndUpdate newsChannels true changeFromChannelIndexAndUpdate fromNewsChannel toPosition else if fromPosition toPosition 0 List NewsChannelTable newsChannels NewsChannelTableManager loadNewsChannelsWithin fromPosition 1 toPosition increaseOrReduceIndexAndUpdate newsChannels false changeFromChannelIndexAndUpdate fromNewsChannel toPosition private boolean isAdjacent int fromChannelIndex int toChannelIndex return Math abs fromChannelIndex toChannelIndex 1 private void swapAdjacentIndexAndUpdate NewsChannelTable fromNewsChannel NewsChannelTable toNewsChannel fromNewsChannel setNewsChannelIndex toPosition toNewsChannel setNewsChannelIndex fromPosition NewsChannelTableManager update fromNewsChannel NewsChannelTableManager update toNewsChannel private void increaseOrReduceIndexAndUpdate List NewsChannelTable newsChannels boolean isIncrease for NewsChannelTable newsChannel newsChannels increaseOrReduceIndex isIncrease newsChannel NewsChannelTableManager update newsChannel private void increaseOrReduceIndex boolean isIncrease NewsChannelTable newsChannel int targetIndex if isIncrease targetIndex newsChannel getNewsChannelIndex 1 else targetIndex newsChannel getNewsChannelIndex 1 newsChannel setNewsChannelIndex targetIndex private void changeFromChannelIndexAndUpdate NewsChannelTable fromNewsChannel int toPosition fromNewsChannel setNewsChannelIndex toPosition NewsChannelTableManager update fromNewsChannel Override public void updateDb final NewsChannelTable newsChannel final boolean isChannelMine createThreadPool mSingleThreadPool execute new Runnable Override public void run KLog d Thread currentThread getName int channelIndex newsChannel getNewsChannelIndex if isChannelMine List NewsChannelTable newsChannels NewsChannelTableManager loadNewsChannelsIndexGt channelIndex increaseOrReduceIndexAndUpdate newsChannels false int targetIndex NewsChannelTableManager getAllSize ChangeIsSelectAndIndex targetIndex false else List NewsChannelTable newsChannels NewsChannelTableManager loadNewsChannelsIndexLtAndIsUnselect channelIndex increaseOrReduceIndexAndUpdate newsChannels true int targetIndex NewsChannelTableManager getNewsChannelSelectSize ChangeIsSelectAndIndex targetIndex true private void ChangeIsSelectAndIndex int targetIndex boolean isSelect newsChannel setNewsChannelSelect isSelect changeFromChannelIndexAndUpdate newsChannel targetIndex private void createThreadPool if mSingleThreadPool null mSingleThreadPool Executors newSingleThreadExecutorpackage com kaku colorfulnews mvp presenter import com kaku colorfulnews greendao NewsChannelTable import com kaku colorfulnews mvp presenter base BasePresenter public interface NewsChannelPresenter extends BasePresenter void onItemSwap int fromPosition int toPosition void onItemAddOrRemove NewsChannelTable newsChannel boolean isChannelMinepackage com kaku colorfulnews mvp presenter impl import com kaku colorfulnews common Constants import com kaku colorfulnews event ChannelChangeEvent import com kaku colorfulnews greendao NewsChannelTable import com kaku colorfulnews mvp interactor impl NewsChannelInteractorImpl import com kaku colorfulnews mvp presenter NewsChannelPresenter import com kaku colorfulnews mvp presenter base BasePresenterImpl import com kaku colorfulnews mvp view NewsChannelView import com kaku colorfulnews utils RxBus import java util List import java util Map import javax inject Inject public class NewsChannelPresenterImpl extends BasePresenterImpl NewsChannelView Map Integer List NewsChannelTable implements NewsChannelPresenter private NewsChannelInteractorImpl mNewsChannelInteractor private boolean mIsChannelChanged Inject public NewsChannelPresenterImpl NewsChannelInteractorImpl newsChannelInteractor mNewsChannelInteractor newsChannelInteractor Override public void onDestroy super onDestroy if mIsChannelChanged RxBus getInstance post new ChannelChangeEvent Override public void onCreate super onCreate mNewsChannelInteractor lodeNewsChannels this Override public void success Map Integer List NewsChannelTable data super success data mView initRecyclerViews data get Constants NEWS CHANNEL MINE data get Constants NEWS CHANNEL MORE Override public void onItemSwap int fromPosition int toPosition mNewsChannelInteractor swapDb fromPosition toPosition mIsChannelChanged true Override public void onItemAddOrRemove NewsChannelTable newsChannel boolean isChannelMine mNewsChannelInteractor updateDb newsChannel isChannelMine mIsChannelChanged truepackage com kaku colorfulnews greendao THIS CODE IS GENERATED BY greenDAO DO NOT EDIT Enable keep sections if you want to edit public class NewsChannelTable private String newsChannelName private String newsChannelId private String newsChannelType private boolean newsChannelSelect private int newsChannelIndex private Boolean newsChannelFixed public NewsChannelTable public NewsChannelTable String newsChannelName this newsChannelName newsChannelName public NewsChannelTable String newsChannelName String newsChannelId String newsChannelType boolean newsChannelSelect int newsChannelIndex Boolean newsChannelFixed this newsChannelName newsChannelName this newsChannelId newsChannelId this newsChannelType newsChannelType this newsChannelSelect newsChannelSelect this newsChannelIndex newsChannelIndex this newsChannelFixed newsChannelFixed public String getNewsChannelName return newsChannelName public void setNewsChannelName String newsChannelName this newsChannelName newsChannelName public String getNewsChannelId return newsChannelId public void setNewsChannelId String newsChannelId this newsChannelId newsChannelId public String getNewsChannelType return newsChannelType public void setNewsChannelType String newsChannelType this newsChannelType newsChannelType public boolean getNewsChannelSelect return newsChannelSelect public void setNewsChannelSelect boolean newsChannelSelect this newsChannelSelect newsChannelSelect public int getNewsChannelIndex return newsChannelIndex public void setNewsChannelIndex int newsChannelIndex this newsChannelIndex newsChannelIndex public Boolean getNewsChannelFixed return newsChannelFixed public void setNewsChannelFixed Boolean newsChannelFixed this newsChannelFixed newsChannelFixedpackage com kaku colorfulnews greendao import android database Cursor import android database sqlite SQLiteDatabase import android database sqlite SQLiteStatement import de greenrobot dao AbstractDao import de greenrobot dao Property import de greenrobot dao internal DaoConfig THIS CODE IS GENERATED BY greenDAO DO NOT EDIT public class NewsChannelTableDao extends AbstractDao NewsChannelTable String public static final String TABLENAME NEWS CHANNEL TABLE public static class Properties public final static Property NewsChannelName new Property 0 String class newsChannelName true NEWS CHANNEL NAME public final static Property NewsChannelId new Property 1 String class newsChannelId false NEWS CHANNEL ID public final static Property NewsChannelType new Property 2 String class newsChannelType false NEWS CHANNEL TYPE public final static Property NewsChannelSelect new Property 3 boolean class newsChannelSelect false NEWS CHANNEL SELECT public final static Property NewsChannelIndex new Property 4 int class newsChannelIndex false NEWS CHANNEL INDEX public final static Property NewsChannelFixed new Property 5 Boolean class newsChannelFixed false NEWS CHANNEL FIXED public NewsChannelTableDao DaoConfig config super config public NewsChannelTableDao DaoConfig config DaoSession daoSession super config daoSession public static void createTable SQLiteDatabase db boolean ifNotExists String constraint ifNotExists IF NOT EXISTS db execSQL CREATE TABLE constraint NEWS CHANNEL TABLE NEWS CHANNEL NAME TEXT PRIMARY KEY NOT NULL 0 newsChannelName NEWS CHANNEL ID TEXT NOT NULL 1 newsChannelId NEWS CHANNEL TYPE TEXT NOT NULL 2 newsChannelType NEWS CHANNEL SELECT INTEGER NOT NULL 3 newsChannelSelect NEWS CHANNEL INDEX INTEGER NOT NULL 4 newsChannelIndex NEWS CHANNEL FIXED INTEGER 5 newsChannelFixed Add Indexes db execSQL CREATE INDEX constraint IDX NEWS CHANNEL TABLE NEWS CHANNEL NAME ON NEWS CHANNEL TABLE NEWS CHANNEL NAME public static void dropTable SQLiteDatabase db boolean ifExists String sql DROP TABLE ifExists IF EXISTS NEWS CHANNEL TABLE db execSQL sql Override protected void bindValues SQLiteStatement stmt NewsChannelTable entity stmt clearBindings stmt bindString 1 entity getNewsChannelName stmt bindString 2 entity getNewsChannelId stmt bindString 3 entity getNewsChannelType stmt bindLong 4 entity getNewsChannelSelect 1l 0l stmt bindLong 5 entity getNewsChannelIndex Boolean newsChannelFixed entity getNewsChannelFixed if newsChannelFixed null stmt bindLong 6 newsChannelFixed 1l 0l Override public String readKey Cursor cursor int offset return cursor getString offset 0 Override public NewsChannelTable readEntity Cursor cursor int offset NewsChannelTable entity new NewsChannelTable cursor getString offset 0 newsChannelName cursor getString offset 1 newsChannelId cursor getString offset 2 newsChannelType cursor getShort offset 3 0 newsChannelSelect cursor getInt offset 4 newsChannelIndex cursor isNull offset 5 null cursor getShort offset 5 0 newsChannelFixed return entity Override public void readEntity Cursor cursor NewsChannelTable entity int offset entity setNewsChannelName cursor getString offset 0 entity setNewsChannelId cursor getString offset 1 entity setNewsChannelType cursor getString offset 2 entity setNewsChannelSelect cursor getShort offset 3 0 entity setNewsChannelIndex cursor getInt offset 4 entity setNewsChannelFixed cursor isNull offset 5 null cursor getShort offset 5 0 Override protected String updateKeyAfterInsert NewsChannelTable entity long rowId return entity getNewsChannelName Override public String getKey NewsChannelTable entity if entity null return entity getNewsChannelName else return null Override protected boolean isEntityUpdateable return truepackage com kaku colorfulnews repository db import com kaku colorfulnews App import com kaku colorfulnews R import com kaku colorfulnews common ApiConstants import com kaku colorfulnews common Constants import com kaku colorfulnews greendao NewsChannelTable import com kaku colorfulnews greendao NewsChannelTableDao import com kaku colorfulnews utils MyUtils import java util Arrays import java util List import de greenrobot dao query Query public class NewsChannelTableManager public static void initDB if MyUtils getSharedPreferences getBoolean Constants INIT DB false NewsChannelTableDao dao App getNewsChannelTableDao List String channelName Arrays asList App getAppContext getResources getStringArray R array news channel name List String channelId Arrays asList App getAppContext getResources getStringArray R array news channel id for int i 0 i channelName size i NewsChannelTable entity new NewsChannelTable channelName get i channelId get i ApiConstants getType channelId get i i 5 i i 0 dao insert entity MyUtils getSharedPreferences edit putBoolean Constants INIT DB true apply public static List NewsChannelTable loadNewsChannelsMine Query NewsChannelTable newsChannelTableQuery App getNewsChannelTableDao queryBuilder where NewsChannelTableDao Properties NewsChannelSelect eq true orderAsc NewsChannelTableDao Properties NewsChannelIndex build return newsChannelTableQuery list public static List NewsChannelTable loadNewsChannelsMore Query NewsChannelTable newsChannelTableQuery App getNewsChannelTableDao queryBuilder where NewsChannelTableDao Properties NewsChannelSelect eq false orderAsc NewsChannelTableDao Properties NewsChannelIndex build return newsChannelTableQuery list public static NewsChannelTable loadNewsChannel int position return App getNewsChannelTableDao queryBuilder where NewsChannelTableDao Properties NewsChannelIndex eq position build unique public static void update NewsChannelTable newsChannelTable App getNewsChannelTableDao update newsChannelTable public static List NewsChannelTable loadNewsChannelsWithin int from int to Query NewsChannelTable newsChannelTableQuery App getNewsChannelTableDao queryBuilder where NewsChannelTableDao Properties NewsChannelIndex between from to build return newsChannelTableQuery list public static List NewsChannelTable loadNewsChannelsIndexGt int channelIndex Query NewsChannelTable newsChannelTableQuery App getNewsChannelTableDao queryBuilder where NewsChannelTableDao Properties NewsChannelIndex gt channelIndex build return newsChannelTableQuery list public static List NewsChannelTable loadNewsChannelsIndexLtAndIsUnselect int channelIndex Query NewsChannelTable newsChannelTableQuery App getNewsChannelTableDao queryBuilder where NewsChannelTableDao Properties NewsChannelIndex lt channelIndex NewsChannelTableDao Properties NewsChannelSelect eq false build return newsChannelTableQuery list public static int getAllSize return App getNewsChannelTableDao loadAll size public static int getNewsChannelSelectSize return int App getNewsChannelTableDao queryBuilder where NewsChannelTableDao Properties NewsChannelSelect eq true buildCount countpackage com kaku colorfulnews mvp view import com kaku colorfulnews greendao NewsChannelTable import com kaku colorfulnews mvp view base BaseView import java util List public interface NewsChannelView extends BaseView void initRecyclerViews List NewsChannelTable newsChannelsMine List NewsChannelTable newsChannelsMorepackage com kaku colorfulnews mvp entity import java util List public class NewsDetail private String body private int replyCount private String shareLink private String digest private String dkeys private String ec private String docid private boolean picnews private String title private String tid private String template private int threadVote private int threadAgainst private String replyBoard private String source private boolean hasNext private String voicecomment private String ptime private List users private List ydbaike private List link private List votes private List ImgBean img private List TopiclistNewsBean topiclist news private List TopiclistBean topiclist private List boboList private List relative sys private List apps public String getBody return body public void setBody String body this body body public int getReplyCount return replyCount public void setReplyCount int replyCount this replyCount replyCount public String getShareLink return shareLink public void setShareLink String shareLink this shareLink shareLink public String getDigest return digest public void setDigest String digest this digest digest public String getDkeys return dkeys public void setDkeys String dkeys this dkeys dkeys public String getEc return ec public void setEc String ec this ec ec public String getDocid return docid public void setDocid String docid this docid docid public boolean isPicnews return picnews public void setPicnews boolean picnews this picnews picnews public String getTitle return title public void setTitle String title this title title public String getTid return tid public void setTid String tid this tid tid public String getTemplate return template public void setTemplate String template this template template public int getThreadVote return threadVote public void setThreadVote int threadVote this threadVote threadVote public int getThreadAgainst return threadAgainst public void setThreadAgainst int threadAgainst this threadAgainst threadAgainst public String getReplyBoard return replyBoard public void setReplyBoard String replyBoard this replyBoard replyBoard public String getSource return source public void setSource String source this source source public boolean isHasNext return hasNext public void setHasNext boolean hasNext this hasNext hasNext public String getVoicecomment return voicecomment public void setVoicecomment String voicecomment this voicecomment voicecomment public String getPtime return ptime public void setPtime String ptime this ptime ptime public List getUsers return users public void setUsers List users this users users public List getYdbaike return ydbaike public void setYdbaike List ydbaike this ydbaike ydbaike public List getLink return link public void setLink List link this link link public List getVotes return votes public void setVotes List votes this votes votes public List ImgBean getImg return img public void setImg List ImgBean img this img img public List TopiclistNewsBean getTopiclist news return topiclist news public void setTopiclist news List TopiclistNewsBean topiclist news this topiclist news topiclist news public List TopiclistBean getTopiclist return topiclist public void setTopiclist List TopiclistBean topiclist this topiclist topiclist public List getBoboList return boboList public void setBoboList List boboList this boboList boboList public List getRelative sys return relative sys public void setRelative sys List relative sys this relative sys relative sys public List getApps return apps public void setApps List apps this apps apps public static class ImgBean private String ref private String pixel private String alt private String src public String getRef return ref public void setRef String ref this ref ref public String getPixel return pixel public void setPixel String pixel this pixel pixel public String getAlt return alt public void setAlt String alt this alt alt public String getSrc return src public void setSrc String src this src src public static class TopiclistNewsBean private boolean hasCover private String subnum private String alias private String tname private String ename private String tid private String cid public boolean isHasCover return hasCover public void setHasCover boolean hasCover this hasCover hasCover public String getSubnum return subnum public void setSubnum String subnum this subnum subnum public String getAlias return alias public void setAlias String alias this alias alias public String getTname return tname public void setTname String tname this tname tname public String getEname return ename public void setEname String ename this ename ename public String getTid return tid public void setTid String tid this tid tid public String getCid return cid public void setCid String cid this cid cid public static class TopiclistBean private boolean hasCover private String subnum private String alias private String tname private String ename private String tid private String cid public boolean isHasCover return hasCover public void setHasCover boolean hasCover this hasCover hasCover public String getSubnum return subnum public void setSubnum String subnum this subnum subnum public String getAlias return alias public void setAlias String alias this alias alias public String getTname return tname public void setTname String tname this tname tname public String getEname return ename public void setEname String ename this ename ename public String getTid return tid public void setTid String tid this tid tid public String getCid return cid public void setCid String cid this cid cidpackage com kaku colorfulnews mvp ui activities import android content Intent import android net Uri import android os Bundle import android support annotation NonNull import android support design widget AppBarLayout import android support design widget CollapsingToolbarLayout import android support design widget FloatingActionButton import android support design widget Snackbar import android support v4 content ContextCompat import android support v7 widget Toolbar import android text Html import android view Menu import android view MenuItem import android view View import android widget ImageView import android widget ProgressBar import android widget TextView import com bumptech glide Glide import com bumptech glide load DecodeFormat import com bumptech glide load engine DiskCacheStrategy import com daimajia androidanimations library Techniques import com daimajia androidanimations library YoYo import com kaku colorfulnews App import com kaku colorfulnews R import com kaku colorfulnews common Constants import com kaku colorfulnews mvp entity NewsDetail import com kaku colorfulnews mvp presenter impl NewsDetailPresenterImpl import com kaku colorfulnews mvp ui activities base BaseActivity import com kaku colorfulnews mvp view NewsDetailView import com kaku colorfulnews utils MyUtils import com kaku colorfulnews utils NetUtil import com kaku colorfulnews utils TransformUtils import com kaku colorfulnews widget URLImageGetter import com socks library KLog import java util List import java util concurrent TimeUnit import javax inject Inject import butterknife BindView import butterknife OnClick import rx Observable import rx Subscriber public class NewsDetailActivity extends BaseActivity implements NewsDetailView BindView R id news detail photo iv ImageView mNewsDetailPhotoIv BindView R id toolbar Toolbar mToolbar BindView R id toolbar layout CollapsingToolbarLayout mToolbarLayout BindView R id app bar AppBarLayout mAppBar BindView R id news detail from tv TextView mNewsDetailFromTv BindView R id news detail body tv TextView mNewsDetailBodyTv BindView R id fab FloatingActionButton mFab BindView R id progress bar ProgressBar mProgressBar BindView R id mask view View mMaskView Inject NewsDetailPresenterImpl mNewsDetailPresenter private URLImageGetter mUrlImageGetter private String mNewsTitle private String mShareLink Override public int getLayoutId return R layout activity news detail Override public void initInjector mActivityComponent inject this Override public void initViews String postId getIntent getStringExtra Constants NEWS POST ID mNewsDetailPresenter setPosId postId mPresenter mNewsDetailPresenter mPresenter attachView this Override protected void onCreate Bundle savedInstanceState super onCreate savedInstanceState SuppressWarnings deprecation Override public void setNewsDetail NewsDetail newsDetail mShareLink newsDetail getShareLink mNewsTitle newsDetail getTitle String newsSource newsDetail getSource String newsTime MyUtils formatDate newsDetail getPtime String newsBody newsDetail getBody String NewsImgSrc getImgSrcs newsDetail setToolBarLayout mNewsTitle mNewsDetailTitleTv setText newsTitle mNewsDetailFromTv setText getString R string news from newsSource newsTime setNewsDetailPhotoIv NewsImgSrc setNewsDetailBodyTv newsDetail newsBody private void setToolBarLayout String newsTitle mToolbarLayout setTitle newsTitle mToolbarLayout setExpandedTitleColor ContextCompat getColor this R color white mToolbarLayout setCollapsedTitleTextColor ContextCompat getColor this R color primary text white private void setNewsDetailPhotoIv String imgSrc Glide with this load imgSrc asBitmap placeholder R drawable ic loading format DecodeFormat PREFER ARGB 8888 error R drawable ic load fail diskCacheStrategy DiskCacheStrategy ALL into mNewsDetailPhotoIv private void setNewsDetailBodyTv final NewsDetail newsDetail final String newsBody mSubscription Observable timer 500 TimeUnit MILLISECONDS compose TransformUtils Long defaultSchedulers subscribe new Subscriber Long Override public void onCompleted mProgressBar setVisibility View GONE mFab setVisibility View VISIBLE YoYo with Techniques RollIn playOn mFab Override public void onError Throwable e mProgressBar setVisibility View GONE Override public void onNext Long aLong setBody newsDetail newsBody private void setBody NewsDetail newsDetail String newsBody int imgTotal newsDetail getImg size if isShowBody newsBody imgTotal mNewsDetailBodyTv setMovementMethod LinkMovementMethod getInstance mUrlImageGetter new URLImageGetter mNewsDetailBodyTv newsBody imgTotal mNewsDetailBodyTv setText Html fromHtml newsBody mUrlImageGetter null else mNewsDetailBodyTv setText Html fromHtml newsBody private boolean isShowBody String newsBody int imgTotal return App isHavePhoto imgTotal 2 newsBody null private String getImgSrcs NewsDetail newsDetail List NewsDetail ImgBean imgSrcs newsDetail getImg String imgSrc if imgSrcs null imgSrcs size 0 imgSrc imgSrcs get 0 getSrc else imgSrc getIntent getStringExtra Constants NEWS IMG RES return imgSrc Override public void showProgress mProgressBar setVisibility View VISIBLE Override public void hideProgress mProgressBar setVisibility View GONE Override public void showMsg String message mProgressBar setVisibility View GONE if NetUtil isNetworkAvailable Snackbar make mAppBar message Snackbar LENGTH LONG show Override public boolean onCreateOptionsMenu Menu menu Inflate the menu this adds items to the action bar if it is present getMenuInflater inflate R menu news detail menu return true Override public boolean onOptionsItemSelected MenuItem item switch item getItemId case R id action web view openByWebView break case R id action browser openByBrowser break return super onOptionsItemSelected item private void openByWebView Intent intent new Intent this NewsBrowserActivity class intent putExtra Constants NEWS LINK mShareLink intent putExtra Constants NEWS TITLE mNewsTitle startActivity intent private void openByBrowser Intent intent new Intent intent setAction android intent action VIEW if canBrowse intent Uri uri Uri parse mShareLink intent setData uri startActivity intent private boolean canBrowse Intent intent return intent resolveActivity getPackageManager null mShareLink null Override protected void onDestroy cancelUrlImageGetterSubscription super onDestroy private void cancelUrlImageGetterSubscription try if mUrlImageGetter null mUrlImageGetter mSubscription null mUrlImageGetter mSubscription isUnsubscribed mUrlImageGetter mSubscription unsubscribe KLog d UrlImageGetter unsubscribe catch Exception e KLog e UrlImageGetter Subscription e toString OnClick R id fab public void onClick share private void share Intent intent new Intent Intent ACTION SEND intent setType text plain intent putExtra Intent EXTRA SUBJECT getString R string share intent putExtra Intent EXTRA TEXT getShareContents startActivity Intent createChooser intent getTitle NonNull private String getShareContents if mShareLink null mShareLink return getString R string share contents mNewsTitle mShareLinkpackage com kaku colorfulnews mvp interactor import com kaku colorfulnews listener RequestCallBack import rx Subscription public interface NewsDetailInteractor T Subscription loadNewsDetail RequestCallBack T callBack String postIdpackage com kaku colorfulnews mvp interactor impl import com kaku colorfulnews App import com kaku colorfulnews common HostType import com kaku colorfulnews listener RequestCallBack import com kaku colorfulnews mvp entity NewsDetail import com kaku colorfulnews mvp interactor NewsDetailInteractor import com kaku colorfulnews repository network RetrofitManager import com kaku colorfulnews utils MyUtils import com kaku colorfulnews utils TransformUtils import com socks library KLog import java util List import java util Map import javax inject Inject import rx Observer import rx Subscription import rx functions Func1 public class NewsDetailInteractorImpl implements NewsDetailInteractor NewsDetail Inject public NewsDetailInteractorImpl Override public Subscription loadNewsDetail final RequestCallBack NewsDetail callBack final String postId return RetrofitManager getInstance HostType NETEASE NEWS VIDEO getNewsDetailObservable postId map new Func1 Map String NewsDetail NewsDetail Override public NewsDetail call Map String NewsDetail map KLog d Thread currentThread getName NewsDetail newsDetail map get postId changeNewsDetail newsDetail return newsDetail compose TransformUtils NewsDetail defaultSchedulers subscribe new Observer NewsDetail Override public void onCompleted Override public void onError Throwable e KLog e e toString callBack onError MyUtils analyzeNetworkError e Override public void onNext NewsDetail newsDetail callBack success newsDetail private void changeNewsDetail NewsDetail newsDetail List NewsDetail ImgBean imgSrcs newsDetail getImg if isChange imgSrcs String newsBody newsDetail getBody newsBody changeNewsBody imgSrcs newsBody newsDetail setBody newsBody private boolean isChange List NewsDetail ImgBean imgSrcs return imgSrcs null imgSrcs size 2 App isHavePhoto private String changeNewsBody List NewsDetail ImgBean imgSrcs String newsBody for int i 0 i imgSrcs size i String oldChars IMG i String newChars if i 0 newChars else newChars img src imgSrcs get i getSrc newsBody newsBody replace oldChars newChars return newsBodypackage com kaku colorfulnews mvp presenter import com kaku colorfulnews mvp presenter base BasePresenter public interface NewsDetailPresenter extends BasePresenter void setPosId String postIdpackage com kaku colorfulnews mvp presenter impl import com kaku colorfulnews mvp entity NewsDetail import com kaku colorfulnews mvp interactor NewsDetailInteractor import com kaku colorfulnews mvp interactor impl NewsDetailInteractorImpl import com kaku colorfulnews mvp presenter NewsDetailPresenter import com kaku colorfulnews mvp presenter base BasePresenterImpl import com kaku colorfulnews mvp view NewsDetailView import javax inject Inject public class NewsDetailPresenterImpl extends BasePresenterImpl NewsDetailView NewsDetail implements NewsDetailPresenter private NewsDetailInteractor NewsDetail mNewsDetailInteractor private String mPostId Inject public NewsDetailPresenterImpl NewsDetailInteractorImpl newsDetailInteractor mNewsDetailInteractor newsDetailInteractor Override public void onCreate super onCreate mSubscription mNewsDetailInteractor loadNewsDetail this mPostId Override public void success NewsDetail data super success data mView setNewsDetail data Override public void setPosId String postId mPostId postIdpackage com kaku colorfulnews mvp view import com kaku colorfulnews mvp entity NewsDetail import com kaku colorfulnews mvp view base BaseView public interface NewsDetailView extends BaseView void setNewsDetail NewsDetail newsDetailpackage com kaku colorfulnews mvp ui adapter PagerAdapter import android support v4 app Fragment import android support v4 app FragmentManager import android support v4 app FragmentPagerAdapter import java util ArrayList import java util List public class NewsFragmentPagerAdapter extends FragmentPagerAdapter private final List String mTitles private List Fragment mNewsFragmentList new ArrayList public NewsFragmentPagerAdapter FragmentManager fm List String titles List Fragment newsFragmentList super fm mTitles titles mNewsFragmentList newsFragmentList Override public CharSequence getPageTitle int position return mTitles get position Override public Fragment getItem int position return mNewsFragmentList get position Override public int getCount return mNewsFragmentList sizepackage com kaku colorfulnews mvp interactor import com kaku colorfulnews listener RequestCallBack import rx Subscription public interface NewsInteractor T Subscription lodeNewsChannels RequestCallBack T callbackpackage com kaku colorfulnews mvp interactor impl import com kaku colorfulnews App import com kaku colorfulnews R import com kaku colorfulnews greendao NewsChannelTable import com kaku colorfulnews listener RequestCallBack import com kaku colorfulnews mvp interactor NewsInteractor import com kaku colorfulnews repository db NewsChannelTableManager import com kaku colorfulnews utils TransformUtils import java util List import javax inject Inject import rx Observable import rx Subscriber import rx Subscription public class NewsInteractorImpl implements NewsInteractor List NewsChannelTable Inject public NewsInteractorImpl Override public Subscription lodeNewsChannels final RequestCallBack List NewsChannelTable callback return Observable create new Observable OnSubscribe List NewsChannelTable Override public void call Subscriber super List NewsChannelTable subscriber NewsChannelTableManager initDB subscriber onNext NewsChannelTableManager loadNewsChannelsMine subscriber onCompleted compose TransformUtils List NewsChannelTable defaultSchedulers subscribe new Subscriber List NewsChannelTable Override public void onCompleted Override public void onError Throwable e callback onError App getAppContext getString R string db error Override public void onNext List NewsChannelTable newsChannelTables callback success newsChannelTablespackage com kaku colorfulnews mvp ui adapter import android support v7 widget RecyclerView import android text TextUtils import android view View import android view ViewGroup import android widget ImageView import android widget LinearLayout import android widget TextView import com bumptech glide Glide import com bumptech glide load DecodeFormat import com bumptech glide load engine DiskCacheStrategy import com kaku colorfulnews App import com kaku colorfulnews R import com kaku colorfulnews listener OnItemClickListener import com kaku colorfulnews mvp entity NewsSummary import com kaku colorfulnews mvp ui adapter base BaseRecyclerViewAdapter import com kaku colorfulnews utils DimenUtil import java util List import javax inject Inject import butterknife BindView import butterknife ButterKnife public class NewsListAdapter extends BaseRecyclerViewAdapter NewsSummary public static final int TYPE PHOTO ITEM 2 public interface OnNewsListItemClickListener extends OnItemClickListener void onItemClick View view int position boolean isPhoto Inject public NewsListAdapter super null Override public RecyclerView ViewHolder onCreateViewHolder ViewGroup parent final int viewType View view switch viewType case TYPE FOOTER view getView parent R layout item news footer return new FooterViewHolder view case TYPE ITEM view getView parent R layout item news final ItemViewHolder itemViewHolder new ItemViewHolder view setItemOnClickEvent itemViewHolder false return itemViewHolder case TYPE PHOTO ITEM view getView parent R layout item news photo final PhotoViewHolder photoItemViewHolder new PhotoViewHolder view setItemOnClickEvent photoItemViewHolder true return photoItemViewHolder default throw new RuntimeException there is no type that matches the type viewType make sure your using types correctly private void setItemOnClickEvent final RecyclerView ViewHolder holder final boolean isPhoto if mOnItemClickListener null holder itemView setOnClickListener new View OnClickListener Override public void onClick View v OnNewsListItemClickListener mOnItemClickListener onItemClick v holder getLayoutPosition isPhoto Override public int getItemViewType int position if mIsShowFooter isFooterPosition position return TYPE FOOTER else if TextUtils isEmpty mList get position getDigest return TYPE ITEM else return TYPE PHOTO ITEM Override public void onBindViewHolder final RecyclerView ViewHolder holder int position setValues holder position setItemAppearAnimation holder position R anim anim bottom in private void setValues RecyclerView ViewHolder holder int position if holder instanceof ItemViewHolder setItemValues ItemViewHolder holder position else if holder instanceof PhotoViewHolder setPhotoItemValues PhotoViewHolder holder position private void setItemValues ItemViewHolder holder int position NewsSummary newsSummary mList get position String title newsSummary getLtitle if title null title newsSummary getTitle String ptime newsSummary getPtime String digest newsSummary getDigest String imgSrc newsSummary getImgsrc holder mNewsSummaryTitleTv setText title holder mNewsSummaryPtimeTv setText ptime holder mNewsSummaryDigestTv setText digest Glide with App getAppContext load imgSrc asBitmap gif format DecodeFormat PREFER ARGB 8888 diskCacheStrategy DiskCacheStrategy ALL placeholder R color image place holder error R drawable ic load fail into holder mNewsSummaryPhotoIv private void setPhotoItemValues PhotoViewHolder holder int position NewsSummary newsSummary mList get position setTextView holder newsSummary setImageView holder newsSummary private void setTextView PhotoViewHolder holder NewsSummary newsSummary String title newsSummary getTitle String ptime newsSummary getPtime holder mNewsSummaryTitleTv setText title holder mNewsSummaryPtimeTv setText ptime private void setImageView PhotoViewHolder holder NewsSummary newsSummary int PhotoThreeHeight int DimenUtil dp2px 90 int PhotoTwoHeight int DimenUtil dp2px 120 int PhotoOneHeight int DimenUtil dp2px 150 String imgSrcLeft null String imgSrcMiddle null String imgSrcRight null ViewGroup LayoutParams layoutParams holder mNewsSummaryPhotoIvGroup getLayoutParams if newsSummary getAds null List NewsSummary AdsBean adsBeanList newsSummary getAds int size adsBeanList size if size 3 imgSrcLeft adsBeanList get 0 getImgsrc imgSrcMiddle adsBeanList get 1 getImgsrc imgSrcRight adsBeanList get 2 getImgsrc layoutParams height PhotoThreeHeight holder mNewsSummaryTitleTv setText App getAppContext getString R string photo collections adsBeanList get 0 getTitle else if size 2 imgSrcLeft adsBeanList get 0 getImgsrc imgSrcMiddle adsBeanList get 1 getImgsrc layoutParams height PhotoTwoHeight else if size 1 imgSrcLeft adsBeanList get 0 getImgsrc layoutParams height PhotoOneHeight else if newsSummary getImgextra null int size newsSummary getImgextra size if size 3 imgSrcLeft newsSummary getImgextra get 0 getImgsrc imgSrcMiddle newsSummary getImgextra get 1 getImgsrc imgSrcRight newsSummary getImgextra get 2 getImgsrc layoutParams height PhotoThreeHeight else if size 2 imgSrcLeft newsSummary getImgextra get 0 getImgsrc imgSrcMiddle newsSummary getImgextra get 1 getImgsrc layoutParams height PhotoTwoHeight else if size 1 imgSrcLeft newsSummary getImgextra get 0 getImgsrc layoutParams height PhotoOneHeight else imgSrcLeft newsSummary getImgsrc layoutParams height PhotoOneHeight setPhotoImageView holder imgSrcLeft imgSrcMiddle imgSrcRight holder mNewsSummaryPhotoIvGroup setLayoutParams layoutParams private void setPhotoImageView PhotoViewHolder holder String imgSrcLeft String imgSrcMiddle String imgSrcRight if imgSrcLeft null showAndSetPhoto holder mNewsSummaryPhotoIvLeft imgSrcLeft else hidePhoto holder mNewsSummaryPhotoIvLeft if imgSrcMiddle null showAndSetPhoto holder mNewsSummaryPhotoIvMiddle imgSrcMiddle else hidePhoto holder mNewsSummaryPhotoIvMiddle if imgSrcRight null showAndSetPhoto holder mNewsSummaryPhotoIvRight imgSrcRight else hidePhoto holder mNewsSummaryPhotoIvRight private void showAndSetPhoto ImageView imageView String imgSrc imageView setVisibility View VISIBLE Glide with App getAppContext load imgSrc asBitmap format DecodeFormat PREFER ARGB 8888 diskCacheStrategy DiskCacheStrategy ALL placeholder R color image place holder error R drawable ic load fail into imageView private void hidePhoto ImageView imageView imageView setVisibility View GONE Override public void onViewDetachedFromWindow RecyclerView ViewHolder holder super onViewDetachedFromWindow holder if isShowingAnimation holder holder itemView clearAnimation private boolean isShowingAnimation RecyclerView ViewHolder holder return holder itemView getAnimation null holder itemView getAnimation hasStarted class ItemViewHolder extends RecyclerView ViewHolder BindView R id news summary photo iv ImageView mNewsSummaryPhotoIv BindView R id news summary title tv TextView mNewsSummaryTitleTv BindView R id news summary digest tv TextView mNewsSummaryDigestTv BindView R id news summary ptime tv TextView mNewsSummaryPtimeTv public ItemViewHolder View view super view ButterKnife bind this view class PhotoViewHolder extends RecyclerView ViewHolder BindView R id news summary title tv TextView mNewsSummaryTitleTv BindView R id news summary photo iv group LinearLayout mNewsSummaryPhotoIvGroup BindView R id news summary photo iv left ImageView mNewsSummaryPhotoIvLeft BindView R id news summary photo iv middle ImageView mNewsSummaryPhotoIvMiddle BindView R id news summary photo iv right ImageView mNewsSummaryPhotoIvRight BindView R id news summary ptime tv TextView mNewsSummaryPtimeTv public PhotoViewHolder View view super view ButterKnife bind this viewpackage com kaku colorfulnews mvp ui fragment import android annotation TargetApi import android app Activity import android app ActivityOptions import android content Intent import android os Build import android os Bundle import android support annotation NonNull import android support annotation Nullable import android support design widget Snackbar import android support v4 app ActivityCompat import android support v4 app ActivityOptionsCompat import android support v4 widget SwipeRefreshLayout import android support v7 widget DefaultItemAnimator import android support v7 widget LinearLayoutManager import android support v7 widget RecyclerView import android view View import android widget ImageView import android widget ProgressBar import android widget TextView import com kaku colorfulnews R import com kaku colorfulnews common Constants import com kaku colorfulnews common LoadNewsType import com kaku colorfulnews event ScrollToTopEvent import com kaku colorfulnews mvp entity NewsSummary import com kaku colorfulnews mvp entity NewsPhotoDetail import com kaku colorfulnews mvp presenter impl NewsListPresenterImpl import com kaku colorfulnews mvp ui activities NewsDetailActivity import com kaku colorfulnews mvp ui activities NewsPhotoDetailActivity import com kaku colorfulnews mvp ui adapter NewsListAdapter import com kaku colorfulnews mvp ui fragment base BaseFragment import com kaku colorfulnews mvp view NewsListView import com kaku colorfulnews utils NetUtil import com kaku colorfulnews utils RxBus import java util ArrayList import java util List import javax inject Inject import butterknife BindView import butterknife OnClick import rx functions Action1 import static android support v7 widget RecyclerView LayoutManager import static android support v7 widget RecyclerView OnScrollListener public class NewsListFragment extends BaseFragment implements NewsListView NewsListAdapter OnNewsListItemClickListener SwipeRefreshLayout OnRefreshListener BindView R id news rv RecyclerView mNewsRV BindView R id progress bar ProgressBar mProgressBar BindView R id swipe refresh layout SwipeRefreshLayout mSwipeRefreshLayout BindView R id empty view TextView mEmptyView Inject NewsListAdapter mNewsListAdapter Inject NewsListPresenterImpl mNewsListPresenter Inject Activity mActivity private String mNewsId private String mNewsType private boolean mIsAllLoaded Override public void initInjector mFragmentComponent inject this Override public void initViews View view initSwipeRefreshLayout initRecyclerView initPresenter registerScrollToTopEvent private void initSwipeRefreshLayout mSwipeRefreshLayout setOnRefreshListener this mSwipeRefreshLayout setColorSchemeColors getActivity getResources getIntArray R array gplus colors private void initPresenter mNewsListPresenter setNewsTypeAndId mNewsType mNewsId mPresenter mNewsListPresenter mPresenter attachView this mPresenter onCreate private void registerScrollToTopEvent mSubscription RxBus getInstance toObservable ScrollToTopEvent class subscribe new Action1 ScrollToTopEvent Override public void call ScrollToTopEvent scrollToTopEvent mNewsRV getLayoutManager scrollToPosition 0 private void initRecyclerView mNewsRV setHasFixedSize true mNewsRV setLayoutManager new LinearLayoutManager mActivity LinearLayoutManager VERTICAL false mNewsRV setItemAnimator new DefaultItemAnimator mNewsRV addOnScrollListener new OnScrollListener Override public void onScrollStateChanged RecyclerView recyclerView int newState super onScrollStateChanged recyclerView newState LayoutManager layoutManager recyclerView getLayoutManager int lastVisibleItemPosition LinearLayoutManager layoutManager findLastVisibleItemPosition int visibleItemCount layoutManager getChildCount int totalItemCount layoutManager getItemCount if mIsAllLoaded visibleItemCount 0 newState RecyclerView SCROLL STATE IDLE lastVisibleItemPosition totalItemCount 1 mNewsListPresenter loadMore mNewsListAdapter showFooter mNewsRV scrollToPosition mNewsListAdapter getItemCount 1 mNewsListAdapter setOnItemClickListener this mNewsRV setAdapter mNewsListAdapter Override public int getLayoutId return R layout fragment news Override public void onCreate Nullable Bundle savedInstanceState super onCreate savedInstanceState initValues NetUtil isNetworkErrThenShowMsg private void initValues if getArguments null mNewsId getArguments getString Constants NEWS ID mNewsType getArguments getString Constants NEWS TYPE Override public void onResume super onResume Override public void showProgress mProgressBar setVisibility View VISIBLE Override public void hideProgress mProgressBar setVisibility View GONE Override public void setNewsList List NewsSummary newsSummary LoadNewsType checker int loadType switch loadType case LoadNewsType TYPE REFRESH SUCCESS mSwipeRefreshLayout setRefreshing false mNewsListAdapter setList newsSummary mNewsListAdapter notifyDataSetChanged checkIsEmpty newsSummary break case LoadNewsType TYPE REFRESH ERROR mSwipeRefreshLayout setRefreshing false checkIsEmpty newsSummary break case LoadNewsType TYPE LOAD MORE SUCCESS mNewsListAdapter hideFooter if newsSummary null newsSummary size 0 mIsAllLoaded true Snackbar make mNewsRV getString R string no more Snackbar LENGTH SHORT show else mNewsListAdapter addMore newsSummary break case LoadNewsType TYPE LOAD MORE ERROR mNewsListAdapter hideFooter break private void checkIsEmpty List NewsSummary newsSummary if newsSummary null mNewsListAdapter getList null mNewsRV setVisibility View GONE mEmptyView setVisibility View VISIBLE else mNewsRV setVisibility View VISIBLE mEmptyView setVisibility View GONE Override public void showMsg String message mProgressBar setVisibility View GONE if NetUtil isNetworkAvailable Snackbar make mNewsRV message Snackbar LENGTH LONG show Override public void onDestroyView super onDestroyView mNewsListPresenter onDestroy TargetApi Build VERSION CODES LOLLIPOP Override public void onItemClick View view int position boolean isPhoto if isPhoto NewsPhotoDetail newsPhotoDetail getPhotoDetail position goToPhotoDetailActivity newsPhotoDetail else goToNewsDetailActivity view position private NewsPhotoDetail getPhotoDetail int position NewsSummary newsSummary mNewsListAdapter getList get position NewsPhotoDetail newsPhotoDetail new NewsPhotoDetail newsPhotoDetail setTitle newsSummary getTitle setPictures newsSummary newsPhotoDetail return newsPhotoDetail private void setPictures NewsSummary newsSummary NewsPhotoDetail newsPhotoDetail List NewsPhotoDetail Picture pictureList new ArrayList if newsSummary getAds null for NewsSummary AdsBean entity newsSummary getAds setValuesAndAddToList pictureList entity getTitle entity getImgsrc else if newsSummary getImgextra null for NewsSummary ImgextraBean entity newsSummary getImgextra setValuesAndAddToList pictureList null entity getImgsrc else setValuesAndAddToList pictureList null newsSummary getImgsrc newsPhotoDetail setPictures pictureList private void setValuesAndAddToList List NewsPhotoDetail Picture pictureList String title String imgsrc NewsPhotoDetail Picture picture new NewsPhotoDetail Picture if title null picture setTitle title picture setImgSrc imgsrc pictureList add picture private void goToPhotoDetailActivity NewsPhotoDetail newsPhotoDetail Intent intent new Intent getActivity NewsPhotoDetailActivity class intent putExtra Constants PHOTO DETAIL newsPhotoDetail startActivity intent private void goToNewsDetailActivity View view int position Intent intent setIntent position startActivity view intent NonNull private Intent setIntent int position List NewsSummary newsSummaryList mNewsListAdapter getList Intent intent new Intent mActivity NewsDetailActivity class intent putExtra Constants NEWS POST ID newsSummaryList get position getPostid intent putExtra Constants NEWS IMG RES newsSummaryList get position getImgsrc return intent private void startActivity View view Intent intent ImageView newsSummaryPhotoIv ImageView view findViewById R id news summary photo iv if Build VERSION SDK INT Build VERSION CODES LOLLIPOP ActivityOptions options ActivityOptions makeSceneTransitionAnimation mActivity newsSummaryPhotoIv Constants TRANSITION ANIMATION NEWS PHOTOS startActivity intent options toBundle else Activity ActivityOptionsCompat options ActivityOptionsCompat makeScaleUpAnimation view view getWidth 2 view getHeight 2 0 0 ActivityCompat startActivity mActivity intent options toBundle Override public void onRefresh mNewsListPresenter refreshData OnClick R id empty view public void onClick mSwipeRefreshLayout setRefreshing true mNewsListPresenter refreshData Override public void onItemClick View view int positionpackage com kaku colorfulnews mvp interactor import com kaku colorfulnews listener RequestCallBack import rx Subscription public interface NewsListInteractor T Subscription loadNews RequestCallBack T listener String type String id int startPagepackage com kaku colorfulnews mvp interactor impl import com kaku colorfulnews common ApiConstants import com kaku colorfulnews common HostType import com kaku colorfulnews listener RequestCallBack import com kaku colorfulnews mvp entity NewsSummary import com kaku colorfulnews mvp interactor NewsListInteractor import com kaku colorfulnews repository network RetrofitManager import com kaku colorfulnews utils MyUtils import com kaku colorfulnews utils TransformUtils import com socks library KLog import java util List import java util Map import javax inject Inject import rx Observable import rx Subscriber import rx Subscription import rx functions Func1 import rx functions Func2 public class NewsListInteractorImpl implements NewsListInteractor List NewsSummary private boolean mIsNetError Inject public NewsListInteractorImpl Override public Subscription loadNews final RequestCallBack List NewsSummary listener String type final String id int startPage mIsNetError false API observeOn MainThread onComplete unsubscribe call cancel NetworkOnMainThreadException unsubscribeOn io return RetrofitManager getInstance HostType NETEASE NEWS VIDEO getNewsListObservable type id startPage flatMap new Func1 Map String List NewsSummary Observable NewsSummary Override public Observable NewsSummary call Map String List NewsSummary map if id endsWith ApiConstants HOUSE ID id key return Observable from map get return Observable from map get id map new Func1 NewsSummary NewsSummary Override public NewsSummary call NewsSummary newsSummary String ptime MyUtils formatDate newsSummary getPtime newsSummary setPtime ptime return newsSummary toList distinct toSortedList new Func2 NewsSummary NewsSummary Integer Override public Integer call NewsSummary newsSummary NewsSummary newsSummary2 return newsSummary2 getPtime compareTo newsSummary getPtime compose TransformUtils List NewsSummary defaultSchedulers subscribe new Subscriber List NewsSummary Override public void onCompleted KLog d checkNetState listener Override public void onError Throwable e KLog e e toString checkNetState listener if NetUtil isNetworkAvailable App getAppContext listener onError MyUtils analyzeNetworkError e Override public void onNext List NewsSummary newsSummaries KLog d listener success newsSummaries private void checkNetState RequestCallBack List NewsSummary listener if NetUtil isNetworkAvailable App getAppContext mIsNetError true listener onError App getAppContext getString R string internet error else mIsNetError falsepackage com kaku colorfulnews mvp interactor impl public class NewsListInteractorSamplepackage com kaku colorfulnews mvp presenter import com kaku colorfulnews mvp presenter base BasePresenter public interface NewsListPresenter extends BasePresenter void setNewsTypeAndId String newsType String newsId void refreshData void loadMorepackage com kaku colorfulnews mvp presenter impl import com kaku colorfulnews mvp entity NewsSummary import com kaku colorfulnews common LoadNewsType import com kaku colorfulnews mvp interactor NewsListInteractor import com kaku colorfulnews mvp interactor impl NewsListInteractorImpl import com kaku colorfulnews listener RequestCallBack import com kaku colorfulnews mvp presenter NewsListPresenter import com kaku colorfulnews mvp presenter base BasePresenterImpl import com kaku colorfulnews mvp view NewsListView import java util List import javax inject Inject public class NewsListPresenterImpl extends BasePresenterImpl NewsListView List NewsSummary implements NewsListPresenter RequestCallBack List NewsSummary private NewsListInteractor List NewsSummary mNewsListInteractor private String mNewsType private String mNewsId private int mStartPage private boolean misFirstLoad private boolean mIsRefresh true Inject public NewsListPresenterImpl NewsListInteractorImpl newsListInteractor mNewsListInteractor newsListInteractor Override public void onCreate if mView null loadNewsData Override public void beforeRequest if misFirstLoad mView showProgress Override public void onError String errorMsg super onError errorMsg if mView null int loadType mIsRefresh LoadNewsType TYPE REFRESH ERROR LoadNewsType TYPE LOAD MORE ERROR mView setNewsList null loadType Override public void success List NewsSummary items misFirstLoad true if items null mStartPage 20 int loadType mIsRefresh LoadNewsType TYPE REFRESH SUCCESS LoadNewsType TYPE LOAD MORE SUCCESS if mView null mView setNewsList items loadType mView hideProgress Override public void setNewsTypeAndId String newsType String newsId mNewsType newsType mNewsId newsId Override public void refreshData mStartPage 0 mIsRefresh true loadNewsData Override public void loadMore mIsRefresh false loadNewsData private void loadNewsData mSubscription mNewsListInteractor loadNews this mNewsType mNewsId mStartPagepackage com kaku colorfulnews mvp view import com kaku colorfulnews mvp entity NewsSummary import com kaku colorfulnews common LoadNewsType import com kaku colorfulnews mvp view base BaseView import java util List public interface NewsListView extends BaseView void setNewsList List NewsSummary newsSummary LoadNewsType checker int loadTypepackage com kaku colorfulnews mvp entity import android os Parcel import android os Parcelable import java util ArrayList import java util List public class NewsPhotoDetail implements Parcelable private String title private List Picture pictures public String getTitle return title public void setTitle String title this title title public List Picture getPictures return pictures public void setPictures List Picture pictures this pictures pictures public static class Picture implements Parcelable private String title public String getImgSrc return imgSrc public void setImgSrc String imgSrc this imgSrc imgSrc public String getTitle return title public void setTitle String title this title title private String imgSrc Override public int describeContents return 0 Override public void writeToParcel Parcel dest int flags dest writeString this title dest writeString this imgSrc public Picture protected Picture Parcel in this title in readString this imgSrc in readString public static final Creator Picture CREATOR new Creator Picture Override public Picture createFromParcel Parcel source return new Picture source Override public Picture newArray int size return new Picture size Override public int describeContents return 0 Override public void writeToParcel Parcel dest int flags dest writeString this title dest writeList this pictures public NewsPhotoDetail protected NewsPhotoDetail Parcel in this title in readString this pictures new ArrayList in readList this pictures Picture class getClassLoader public static final Parcelable Creator NewsPhotoDetail CREATOR new Parcelable Creator NewsPhotoDetail Override public NewsPhotoDetail createFromParcel Parcel source return new NewsPhotoDetail source Override public NewsPhotoDetail newArray int size return new NewsPhotoDetail sizepackage com kaku colorfulnews mvp ui activities import android animation Animator import android animation ObjectAnimator import android os Bundle import android support v4 view ViewPager import android support v7 widget Toolbar import android view View import android widget TextView import com kaku colorfulnews R import com kaku colorfulnews common Constants import com kaku colorfulnews event PhotoDetailOnClickEvent import com kaku colorfulnews mvp entity NewsPhotoDetail import com kaku colorfulnews mvp ui activities base BaseActivity import com kaku colorfulnews mvp ui adapter PagerAdapter PhotoPagerAdapter import com kaku colorfulnews mvp ui fragment PhotoDetailFragment import com kaku colorfulnews widget PhotoViewPager import com kaku colorfulnews utils RxBus import java util ArrayList import java util List import butterknife BindView import rx functions Action1 public class NewsPhotoDetailActivity extends BaseActivity BindView R id toolbar Toolbar mToolbar BindView R id viewpager PhotoViewPager mViewpager BindView R id photo detail title tv TextView mPhotoDetailTitleTv private List PhotoDetailFragment mPhotoDetailFragmentList new ArrayList private NewsPhotoDetail mNewsPhotoDetail Override protected void onCreate Bundle savedInstanceState super onCreate savedInstanceState mSubscription RxBus getInstance toObservable PhotoDetailOnClickEvent class subscribe new Action1 PhotoDetailOnClickEvent Override public void call PhotoDetailOnClickEvent photoDetailOnClickEvent if mPhotoDetailTitleTv getVisibility View VISIBLE startAnimation View GONE 0 9f 0 5f else mPhotoDetailTitleTv setVisibility View VISIBLE startAnimation View VISIBLE 0 5f 0 9f private void startAnimation final int endState float startValue float endValue ObjectAnimator animator ObjectAnimator ofFloat mPhotoDetailTitleTv alpha startValue endValue setDuration 200 animator addListener new Animator AnimatorListener Override public void onAnimationStart Animator animation Override public void onAnimationEnd Animator animation mPhotoDetailTitleTv setVisibility endState Override public void onAnimationCancel Animator animation Override public void onAnimationRepeat Animator animation animator start Override public int getLayoutId return R layout activity news photo detail Override public void initInjector mActivityComponent inject this Override public void initViews mNewsPhotoDetail getIntent getParcelableExtra Constants PHOTO DETAIL createFragment mNewsPhotoDetail initViewPager setPhotoDetailTitle 0 private void createFragment NewsPhotoDetail newsPhotoDetail mPhotoDetailFragmentList clear for NewsPhotoDetail Picture picture newsPhotoDetail getPictures PhotoDetailFragment fragment new PhotoDetailFragment Bundle bundle new Bundle bundle putString Constants PHOTO DETAIL IMGSRC picture getImgSrc fragment setArguments bundle mPhotoDetailFragmentList add fragment private void initViewPager PhotoPagerAdapter photoPagerAdapter new PhotoPagerAdapter getSupportFragmentManager mPhotoDetailFragmentList mViewpager setAdapter photoPagerAdapter mViewpager addOnPageChangeListener new ViewPager OnPageChangeListener Override public void onPageScrolled int position float positionOffset int positionOffsetPixels Override public void onPageSelected int position setPhotoDetailTitle position Override public void onPageScrollStateChanged int state public void setPhotoDetailTitle int position String title getTitle position mPhotoDetailTitleTv setText getString R string photo detail title position 1 mPhotoDetailFragmentList size title private String getTitle int position String title mNewsPhotoDetail getPictures get position getTitle if title null title mNewsPhotoDetail getTitle return titlepackage com kaku colorfulnews mvp presenter import com kaku colorfulnews mvp presenter base BasePresenter public interface NewsPresenter extends BasePresenter void onChannelDbChangedpackage com kaku colorfulnews repository network import com kaku colorfulnews mvp entity GirlData import com kaku colorfulnews mvp entity NewsDetail import com kaku colorfulnews mvp entity NewsSummary import java util List import java util Map import okhttp3 ResponseBody import retrofit2 http GET import retrofit2 http Header import retrofit2 http Path import retrofit2 http Url import rx Observable public interface NewsService GET nc article type id startPage 20 html Observable Map String List NewsSummary getNewsList Header Cache Control String cacheControl Path type String type Path id String id Path startPage int startPage GET nc article postId full html Observable Map String NewsDetail getNewDetail Header Cache Control String cacheControl Path postId String postId GET Observable ResponseBody getNewsBodyHtmlPhoto Url String photoPath Url URL url baseUrl baseUrl GET data size page Observable GirlData getPhotoList Path size int size Path page int pagepackage com kaku colorfulnews mvp entity import java util List public class NewsSummary private String postid private boolean hasCover private int hasHead private int replyCount private int hasImg private String digest private boolean hasIcon private String docid private String title private String ltitle private int order private int priority private String lmodify private String boardid private String photosetID private String template private int votecount private String skipID private String alias private String skipType private String cid private int hasAD private String source private String ename private String imgsrc private String tname private String ptime private List AdsBean ads private List ImgextraBean imgextra public String getPostid return postid public void setPostid String postid this postid postid public boolean isHasCover return hasCover public void setHasCover boolean hasCover this hasCover hasCover public int getHasHead return hasHead public void setHasHead int hasHead this hasHead hasHead public int getReplyCount return replyCount public void setReplyCount int replyCount this replyCount replyCount public int getHasImg return hasImg public void setHasImg int hasImg this hasImg hasImg public String getDigest return digest public void setDigest String digest this digest digest public boolean isHasIcon return hasIcon public void setHasIcon boolean hasIcon this hasIcon hasIcon public String getDocid return docid public void setDocid String docid this docid docid public String getTitle return title public void setTitle String title this title title public String getLtitle return ltitle public void setLtitle String ltitle this ltitle ltitle public int getOrder return order public void setOrder int order this order order public int getPriority return priority public void setPriority int priority this priority priority public String getLmodify return lmodify public void setLmodify String lmodify this lmodify lmodify public String getBoardid return boardid public void setBoardid String boardid this boardid boardid public String getPhotosetID return photosetID public void setPhotosetID String photosetID this photosetID photosetID public String getTemplate return template public void setTemplate String template this template template public int getVotecount return votecount public void setVotecount int votecount this votecount votecount public String getSkipID return skipID public void setSkipID String skipID this skipID skipID public String getAlias return alias public void setAlias String alias this alias alias public String getSkipType return skipType public void setSkipType String skipType this skipType skipType public String getCid return cid public void setCid String cid this cid cid public int getHasAD return hasAD public void setHasAD int hasAD this hasAD hasAD public String getSource return source public void setSource String source this source source public String getEname return ename public void setEname String ename this ename ename public String getImgsrc return imgsrc public void setImgsrc String imgsrc this imgsrc imgsrc public String getTname return tname public void setTname String tname this tname tname public String getPtime return ptime public void setPtime String ptime this ptime ptime public List AdsBean getAds return ads public void setAds List AdsBean ads this ads ads public List ImgextraBean getImgextra return imgextra public void setImgextra List ImgextraBean imgextra this imgextra imgextra public static class AdsBean private String title private String tag private String imgsrc private String subtitle private String url public String getTitle return title public void setTitle String title this title title public String getTag return tag public void setTag String tag this tag tag public String getImgsrc return imgsrc public void setImgsrc String imgsrc this imgsrc imgsrc public String getSubtitle return subtitle public void setSubtitle String subtitle this subtitle subtitle public String getUrl return url public void setUrl String url this url url public static class ImgextraBean private String imgsrc public String getImgsrc return imgsrc public void setImgsrc String imgsrc this imgsrc imgsrcpackage com kaku colorfulnews mvp view import com kaku colorfulnews greendao NewsChannelTable import com kaku colorfulnews mvp view base BaseView import java util List public interface NewsView extends BaseView void initViewPager List NewsChannelTable newsChannelspackage jenkins slaves import hudson Extension import jenkins util SystemProperties import hudson init Terminator import hudson model Computer import org jenkinsci remoting nio NioChannelHub import java io IOException import java util logging Level import java util logging Logger Extension public class NioChannelSelector private NioChannelHub hub public NioChannelSelector try if DISABLED this hub new NioChannelHub Computer threadPoolForRemoting Computer threadPoolForRemoting submit hub catch IOException e LOGGER log Level SEVERE Failed to launch NIO hub e this hub null DISABLED true public NioChannelHub getHub return hub Terminator public void cleanUp throws IOException if hub null hub close hub null public static boolean DISABLED SystemProperties getBoolean NioChannelSelector class getName disabled private static final Logger LOGGER Logger getLogger NioChannelSelector class getNamepackage hudson cli import javax net ssl X509TrustManager import java security cert CertificateException import java security cert X509Certificate public class NoCheckTrustManager implements X509TrustManager public void checkClientTrusted X509Certificate x509Certificates String s throws CertificateException public void checkServerTrusted X509Certificate x509Certificates String s throws CertificateException public X509Certificate getAcceptedIssuers return new X509Certificate 0package hudson util import java io IOException import java net InetAddress import java net InetSocketAddress import java net Socket import java net UnknownHostException import org apache commons httpclient ConnectTimeoutException import org apache commons httpclient params HttpConnectionParams import org apache commons httpclient protocol ProtocolSocketFactory public class NoClientBindProtocolSocketFactory implements ProtocolSocketFactory public NoClientBindProtocolSocketFactory public Socket createSocket String host int port InetAddress localAddress int localPort throws IOException UnknownHostException ignore the local address port for binding return createSocket host port public Socket createSocket String host int port InetAddress localAddress int localPort HttpConnectionParams params throws IOException UnknownHostException ConnectTimeoutException if params null throw new IllegalArgumentException Parameters may not be null int timeout params getConnectionTimeout if timeout 0 ignore the local address port for binding return createSocket host port else Socket s new Socket s connect new InetSocketAddress host port timeout return s public Socket createSocket String host int port throws IOException UnknownHostException IOException Socket socket null try socket new Socket host port catch IOException e throw e return socket public boolean equals Object obj return obj null obj getClass equals NoClientBindProtocolSocketFactory class public int hashCode return NoClientBindProtocolSocketFactory class hashCodepackage hudson util import java io IOException import java net InetAddress import java net Socket import java net UnknownHostException import javax net ssl SSLSocketFactory import org apache commons httpclient ConnectTimeoutException import org apache commons httpclient params HttpConnectionParams import org apache commons httpclient protocol ControllerThreadSocketFactory import org apache commons httpclient protocol ReflectionSocketFactory import org apache commons httpclient protocol SecureProtocolSocketFactory import org apache commons httpclient protocol SSLProtocolSocketFactory public class NoClientBindSSLProtocolSocketFactory implements SecureProtocolSocketFactory private static final NoClientBindSSLProtocolSocketFactory factory new NoClientBindSSLProtocolSocketFactory static NoClientBindSSLProtocolSocketFactory getSocketFactory return factory public NoClientBindSSLProtocolSocketFactory super public Socket createSocket String host int port InetAddress clientHost int clientPort throws IOException UnknownHostException return createSocket host port public Socket createSocket final String host final int port final InetAddress localAddress final int localPort final HttpConnectionParams params throws IOException UnknownHostException ConnectTimeoutException if params null throw new IllegalArgumentException Parameters may not be null int timeout params getConnectionTimeout if timeout 0 return createSocket host port else To be eventually deprecated when migrated to Java 1 4 or above Socket socket ReflectionSocketFactory createSocket javax net ssl SSLSocketFactory host port null 0 timeout if socket null socket ControllerThreadSocketFactory createSocket this host port null 0 timeout return socket public Socket createSocket String host int port throws IOException UnknownHostException return SSLSocketFactory getDefault createSocket host port public Socket createSocket Socket socket String host int port boolean autoClose throws IOException UnknownHostException return SSLSocketFactory SSLSocketFactory getDefault createSocket socket host port autoClose public boolean equals Object obj return obj null obj getClass equals SSLProtocolSocketFactory class public int hashCode return SSLProtocolSocketFactory class hashCodepackage hudson model import com infradna tool bridge method injector WithBridgeMethods import hudson Extension import hudson ExtensionPoint import hudson FilePath import hudson FileSystemProvisioner import hudson Launcher import hudson Util import hudson model Descriptor FormException import hudson model Queue Task import hudson model labels LabelAtom import hudson model queue CauseOfBlockage import hudson remoting Callable import hudson remoting VirtualChannel import hudson security ACL import hudson security AccessControlled import hudson security Permission import hudson slaves ComputerListener import hudson slaves NodeDescriptor import hudson slaves NodeProperty import hudson slaves NodePropertyDescriptor import hudson slaves OfflineCause import hudson util ClockDifference import hudson util DescribableList import hudson util EnumConverter import hudson util TagCloud import hudson util TagCloud WeightFunction import java io IOException import java lang reflect Type import java util Collections import java util HashSet import java util List import java util Set import java util concurrent atomic AtomicReference import java util logging Logger import javax annotation CheckForNull import javax annotation Nonnull import jenkins model Jenkins import jenkins util io OnMaster import net sf json JSONObject import org acegisecurity Authentication import org jvnet localizer Localizable import org kohsuke stapler BindInterceptor import org kohsuke stapler Stapler import org kohsuke stapler StaplerRequest import org kohsuke stapler export Exported import org kohsuke stapler export ExportedBean ExportedBean public abstract class Node extends AbstractModelObject implements ReconfigurableDescribable Node ExtensionPoint AccessControlled OnMaster Saveable private static final Logger LOGGER Logger getLogger Node class getName protected volatile transient boolean holdOffLaunchUntilSave public String getDisplayName return getNodeName default implementation public String getSearchUrl Computer c toComputer if c null return c getUrl return computer Util rawEncode getNodeName public boolean isHoldOffLaunchUntilSave return holdOffLaunchUntilSave Override public void save throws IOException this should be a no op unless this node instance is the node instance in Jenkins list of nodes thus where Jenkins getInstance null there is no list of nodes so we do a no op Nodes updateNode n will only persist the node record if the node instance is in the list of nodes so either path results in the same behaviour the node instance is only saved if it is in the list of nodes for all other cases we do not know where to persist the node record and hence we follow the default no op of a Saveable NOOP final Jenkins jenkins Jenkins getInstanceOrNull if jenkins null jenkins updateNode this Exported visibility 999 Nonnull public abstract String getNodeName Deprecated public abstract void setNodeName String name Exported public abstract String getNodeDescription public abstract Launcher createLauncher TaskListener listener Exported public abstract int getNumExecutors Exported public abstract Mode getMode CheckForNull public final Computer toComputer AbstractCIBase ciBase Jenkins getInstance return ciBase getComputer this CheckForNull public final VirtualChannel getChannel Computer c toComputer return c null null c getChannel protected abstract Computer createComputer public boolean isAcceptingTasks return true Extension public static class InternalComputerListener extends ComputerListener Override public void onOnline Computer c TaskListener listener Node node c getNode At startup we need to restore any previously in effect temp offline cause We wait until the computer is started rather than getting the data to it sooner so that the normal computer start up processing works as expected if node null node temporaryOfflineCause null node temporaryOfflineCause c getOfflineCause c setTemporarilyOffline true node temporaryOfflineCause private OfflineCause temporaryOfflineCause void setTemporaryOfflineCause OfflineCause cause try if temporaryOfflineCause cause temporaryOfflineCause cause save catch java io IOException e LOGGER warning Unable to complete save temporary offline status will not be persisted e getMessage public TagCloud LabelAtom getLabelCloud return new TagCloud LabelAtom getAssignedLabels new WeightFunction LabelAtom public float weight LabelAtom item return item getTiedJobCount Exported public Set LabelAtom getAssignedLabels Set LabelAtom r Label parse getLabelString r add getSelfLabel r addAll getDynamicLabels return Collections unmodifiableSet r private HashSet LabelAtom getDynamicLabels HashSet LabelAtom result new HashSet LabelAtom for LabelFinder labeler LabelFinder all Filter out any bad null results from plugins for compatibility reasons findLabels may return LabelExpression and not atom for Label label labeler findLabels this if label instanceof LabelAtom result add LabelAtom label return result public abstract String getLabelString public void setLabelString String labelString throws IOException throw new UnsupportedOperationException WithBridgeMethods Label class public LabelAtom getSelfLabel return LabelAtom get getNodeName Deprecated public CauseOfBlockage canTake Task task return null public CauseOfBlockage canTake Queue BuildableItem item Label l item getAssignedLabel if l null l contains this return CauseOfBlockage fromMessage Messages Node LabelMissing getNodeName l the task needs to be executed on label that this node doesn t have if l null getMode Mode EXCLUSIVE flyweight tasks need to get executed somewhere if every node if item task instanceof Queue FlyweightTask this instanceof Jenkins Jenkins getInstance getNumExecutors 1 Jenkins getInstance getMode Mode EXCLUSIVE return CauseOfBlockage fromMessage Messages Node BecauseNodeIsReserved getNodeName this node is reserved for tasks that are tied to it Authentication identity item authenticate if getACL hasPermission identity Computer BUILD doesn t have a permission return CauseOfBlockage fromMessage Messages Node LackingBuildPermission identity getName getNodeName Check each NodeProperty to see whether they object to this node taking the task for NodeProperty prop getNodeProperties CauseOfBlockage c prop canTake item if c null return c if isAcceptingTasks return CauseOfBlockage fromMessage Messages Node BecauseNodeIsNotAcceptingTasks getNodeName Looks like we can take the task return null TODO should this be modified now that getWorkspace is moved from AbstractProject to AbstractBuild public abstract CheckForNull FilePath getWorkspaceFor TopLevelItem item public abstract CheckForNull FilePath getRootPath public CheckForNull FilePath createPath String absolutePath VirtualChannel ch getChannel if ch null return null offline return new FilePath ch absolutePath public FileSystemProvisioner getFileSystemProvisioner TODO make this configurable or auto detectable or something else return FileSystemProvisioner DEFAULT public abstract Nonnull DescribableList NodeProperty NodePropertyDescriptor getNodeProperties used in the Jelly script to expose descriptors public List NodePropertyDescriptor getNodePropertyDescriptors return NodeProperty for this public ACL getACL return Jenkins getInstance getAuthorizationStrategy getACL this public final void checkPermission Permission permission getACL checkPermission permission public final boolean hasPermission Permission permission return getACL hasPermission permission public Node reconfigure final StaplerRequest req JSONObject form throws FormException if form null return null final JSONObject jsonForProperties form optJSONObject nodeProperties final AtomicReference BindInterceptor old new AtomicReference old set req setBindListener new BindInterceptor Override public Object onConvert Type targetType Class targetTypeErasure Object jsonSource if jsonForProperties jsonSource return old get onConvert targetType targetTypeErasure jsonSource try DescribableList NodeProperty NodePropertyDescriptor tmp new DescribableList NodeProperty NodePropertyDescriptor Saveable NOOP getNodeProperties toList tmp rebuild req jsonForProperties NodeProperty all return tmp toList catch FormException e throw new IllegalArgumentException e catch IOException e throw new IllegalArgumentException e try return getDescriptor newInstance req form finally req setBindListener old get public abstract NodeDescriptor getDescriptor public ClockDifference getClockDifference throws IOException InterruptedException VirtualChannel channel getChannel if channel null throw new IOException getNodeName is offline return channel call getClockDifferenceCallable public abstract Callable ClockDifference IOException getClockDifferenceCallable public enum Mode NORMAL Messages Node Mode NORMAL EXCLUSIVE Messages Node Mode EXCLUSIVE private final Localizable description public String getDescription return description toString public String getName return name Mode Localizable description this description description static Stapler CONVERT UTILS register new EnumConverter Mode classpackage hudson slaves import hudson Extension import hudson model ComputerSet import hudson model Descriptor import hudson model Slave import hudson model Node import jenkins model Jenkins import hudson util DescriptorList import hudson util FormValidation import hudson DescriptorExtensionList import hudson Util import hudson model Failure import java io IOException import java util List import java util ArrayList import org kohsuke stapler QueryParameter import org kohsuke stapler StaplerRequest import org kohsuke stapler StaplerResponse import javax servlet ServletException public abstract class NodeDescriptor extends Descriptor Node protected NodeDescriptor Class extends Node clazz super clazz protected NodeDescriptor public boolean isInstantiable return true public final String newInstanceDetailPage return clazz getName replace replace newInstanceDetail jelly public void handleNewNodePage ComputerSet computerSet String name StaplerRequest req StaplerResponse rsp throws IOException ServletException computerSet checkName name req setAttribute descriptor this req getView computerSet new jelly forward req rsp Override public String getConfigPage return getViewPage clazz configure entries jelly public FormValidation doCheckName QueryParameter String value String name Util fixEmptyAndTrim value if name null return FormValidation error Messages NodeDescripter CheckName Mandatory try Jenkins checkGoodName name catch Failure f return FormValidation error f getMessage return FormValidation ok public static DescriptorExtensionList Node NodeDescriptor all return Jenkins getInstance Node NodeDescriptor getDescriptorList Node class Deprecated public static final DescriptorList Node ALL new DescriptorList Node Node class public static List NodeDescriptor allInstantiable List NodeDescriptor r new ArrayList NodeDescriptor for NodeDescriptor d all if d isInstantiable r add d return rpackage hudson slaves import com thoughtworks xstream XStream import com thoughtworks xstream converters Converter import com thoughtworks xstream converters MarshallingContext import com thoughtworks xstream converters UnmarshallingContext import com thoughtworks xstream io HierarchicalStreamReader import com thoughtworks xstream io HierarchicalStreamWriter import hudson model Node import hudson util RobustCollectionConverter import java util ArrayList import java util Arrays import java util Collection import java util HashMap import java util List import java util Map import java util concurrent CopyOnWriteArrayList import javax annotation CheckForNull public final class NodeList extends ArrayList Node private Map String Node map new HashMap String Node public NodeList public NodeList Collection extends Node c super c for Node node c if map put node getNodeName node null make sure that all names are unique throw new IllegalArgumentException node getNodeName is defined more than once public NodeList Node toCopyIn this Arrays asList toCopyIn public CheckForNull Node getNode String nodeName return map get nodeName Override public void add int index Node element throw new UnsupportedOperationException unmodifiable list Override public Node remove int index throw new UnsupportedOperationException unmodifiable list Override public boolean remove Object o throw new UnsupportedOperationException unmodifiable list Override public void clear throw new UnsupportedOperationException unmodifiable list Override public boolean addAll Collection extends Node c throw new UnsupportedOperationException unmodifiable list Override public boolean addAll int index Collection extends Node c throw new UnsupportedOperationException unmodifiable list Override protected void removeRange int fromIndex int toIndex throw new UnsupportedOperationException unmodifiable list Override public boolean removeAll Collection c throw new UnsupportedOperationException unmodifiable list Override public boolean retainAll Collection c throw new UnsupportedOperationException unmodifiable list Override public boolean add Node node throw new UnsupportedOperationException unmodifiable list Override public Node set int index Node element throw new UnsupportedOperationException unmodifiable list public static final class ConverterImpl extends RobustCollectionConverter public ConverterImpl XStream xstream super xstream Override public boolean canConvert Class type return type NodeList class Override public void marshal Object source HierarchicalStreamWriter writer MarshallingContext context for Node o NodeList source if o instanceof EphemeralNode continue skip writeItem o context writer Override protected Object createCollection Class type return new ArrayList Override public Object unmarshal HierarchicalStreamReader reader UnmarshallingContext context return new NodeList List Node super unmarshal reader contextpackage jenkins model import hudson ExtensionList import hudson ExtensionPoint import hudson model Node import javax annotation Nonnull import java util List import java util logging Level import java util logging Logger public abstract class NodeListener implements ExtensionPoint private static final Logger LOGGER Logger getLogger NodeListener class getName protected void onCreated Nonnull Node node protected void onUpdated Nonnull Node oldOne Nonnull Node newOne protected void onDeleted Nonnull Node node public static void fireOnCreated Nonnull Node node for NodeListener nl all try nl onCreated node catch Throwable ex LOGGER log Level WARNING Listener invocation failed ex public static void fireOnUpdated Nonnull Node oldOne Nonnull Node newOne for NodeListener nl all try nl onUpdated oldOne newOne catch Throwable ex LOGGER log Level WARNING Listener invocation failed ex public static void fireOnDeleted Nonnull Node node for NodeListener nl all try nl onDeleted node catch Throwable ex LOGGER log Level WARNING Listener invocation failed ex public static Nonnull List NodeListener all return ExtensionList lookup NodeListener classpackage hudson node monitors import hudson ExtensionPoint import hudson DescriptorExtensionList import hudson Extension import hudson tasks Publisher import hudson model Computer import hudson model ComputerSet import hudson model Describable import hudson model Node import jenkins model Jenkins import hudson model Descriptor import hudson util DescriptorList import java util List import javax annotation CheckForNull import org kohsuke stapler export Exported import org kohsuke stapler export ExportedBean ExportedBean public abstract class NodeMonitor implements ExtensionPoint Describable NodeMonitor private volatile boolean ignored Exported public CheckForNull String getColumnCaption return getDescriptor getDisplayName public AbstractNodeMonitorDescriptor getDescriptor return AbstractNodeMonitorDescriptor Jenkins getInstance getDescriptorOrDie getClass public Object data Computer c return getDescriptor get c public Thread triggerUpdate return getDescriptor triggerUpdate public static List NodeMonitor getAll return ComputerSet getMonitors toList public boolean isIgnored return ignored public void setIgnored boolean ignored this ignored ignored Deprecated public static final DescriptorList NodeMonitor LIST new DescriptorList NodeMonitor NodeMonitor class public static DescriptorExtensionList NodeMonitor Descriptor NodeMonitor all return Jenkins getInstance NodeMonitor Descriptor NodeMonitor getDescriptorList NodeMonitor classpackage hudson node monitors import hudson Extension import hudson model Computer import hudson model TaskListener import hudson slaves ComputerListener import hudson util Futures import jenkins model Jenkins import java io IOException import java util concurrent Future import java util concurrent TimeUnit import jenkins util Timer Extension public class NodeMonitorUpdater extends ComputerListener private static final Runnable MONITOR UPDATER new Runnable Override public void run for NodeMonitor nm Jenkins getInstance getComputer getMonitors nm triggerUpdate private Future future Futures precomputed null Override public void onOnline Computer c TaskListener listener throws IOException InterruptedException synchronized this future cancel false future Timer get schedule MONITOR UPDATER 5 TimeUnit SECONDSpackage hudson cli handlers import hudson model Node import jenkins model Jenkins import org kohsuke MetaInfServices import org kohsuke args4j CmdLineException import org kohsuke args4j CmdLineParser import org kohsuke args4j OptionDef import org kohsuke args4j spi OptionHandler import org kohsuke args4j spi Parameters import org kohsuke args4j spi Setter MetaInfServices public class NodeOptionHandler extends OptionHandler Node public NodeOptionHandler CmdLineParser parser OptionDef option Setter Node setter super parser option setter Override public int parseArguments Parameters params throws CmdLineException String nodeName params getParameter 0 final Node node Jenkins getInstance getNode nodeName if node null throw new IllegalArgumentException No such node nodeName setter addValue node return 1 Override public String getDefaultMetaVariable return NODEpackage hudson slaves import hudson EnvVars import hudson ExtensionPoint import hudson FilePath import hudson Launcher import hudson DescriptorExtensionList import hudson model Descriptor FormException import hudson model Queue BuildableItem import hudson model ReconfigurableDescribable import hudson model TaskListener import hudson model queue CauseOfBlockage import hudson scm SCM import hudson model AbstractBuild import hudson model BuildListener import hudson model Environment import jenkins model Jenkins import hudson model Node import hudson model Queue Task import net sf json JSONObject import org kohsuke stapler StaplerRequest import java io File import java io IOException import java util List import java util Map import javax annotation Nonnull public abstract class NodeProperty N extends Node implements ReconfigurableDescribable NodeProperty ExtensionPoint protected transient N node protected void setNode N node this node node public NodePropertyDescriptor getDescriptor return NodePropertyDescriptor Jenkins getInstance getDescriptorOrDie getClass Deprecated public CauseOfBlockage canTake Task task return null public CauseOfBlockage canTake BuildableItem item return canTake item task backward compatible behaviour public Environment setUp AbstractBuild build Launcher launcher BuildListener listener throws IOException InterruptedException return new Environment public void buildEnvVars Nonnull EnvVars env Nonnull TaskListener listener throws IOException InterruptedException default is no op public NodeProperty reconfigure StaplerRequest req JSONObject form throws FormException return form null null getDescriptor newInstance req form public static DescriptorExtensionList NodeProperty NodePropertyDescriptor all return DescriptorExtensionList Jenkins getInstance getDescriptorList NodeProperty class public static List NodePropertyDescriptor for Node node return NodePropertyDescriptor for all nodepackage hudson slaves import hudson Extension import hudson model Node import hudson tools PropertyDescriptor import jenkins model Jenkins public abstract class NodePropertyDescriptor extends PropertyDescriptor NodeProperty Node protected NodePropertyDescriptor Class extends NodeProperty clazz super clazz protected NodePropertyDescriptor public boolean isApplicableAsGlobal preserve legacy behaviour even if brain dead stupid where applying to Jenkins was the discriminator note that it would be a mistake to assume Jenkins getInstance getClass Jenkins class the groovy code tested against app class so we replicate that exact logic return isApplicable Jenkins getInstance getClasspackage hudson slaves import hudson ExtensionPoint import hudson model import jenkins model Jenkins import static hudson model LoadStatistics DECAY import hudson model MultiStageTimeSeries TimeScale import hudson Extension import jenkins util SystemProperties import org jenkinsci Symbol import javax annotation Nonnull import javax annotation concurrent GuardedBy import java awt Color import java util Arrays import java util concurrent Future import java util concurrent ExecutionException import java util List import java util Collection import java util ArrayList import java util Iterator import java util concurrent TimeUnit import java util concurrent atomic AtomicReference import java util concurrent locks Lock import java util concurrent locks ReentrantLock import java util logging Logger import java util logging Level import java io IOException public class NodeProvisioner public static class PlannedNode public final String displayName public final Future Node future public final int numExecutors public PlannedNode String displayName Future Node future int numExecutors if displayName null future null numExecutors 1 throw new IllegalArgumentException this displayName displayName this future future this numExecutors numExecutors public void spent private final LoadStatistics stat private final Label label private final AtomicReference List PlannedNode pendingLaunches new AtomicReference List PlannedNode new ArrayList PlannedNode private final Lock provisioningLock new ReentrantLock GuardedBy provisioningLock private StrategyState provisioningState null private transient volatile long lastSuggestedReview private final MultiStageTimeSeries plannedCapacitiesEMA new MultiStageTimeSeries Messages NodeProvisioner EmptyString Color WHITE 0 DECAY public NodeProvisioner Label label LoadStatistics loadStatistics this label label this stat loadStatistics public List PlannedNode getPendingLaunches return new ArrayList PlannedNode pendingLaunches get public void suggestReviewNow if System currentTimeMillis lastSuggestedReview TimeUnit SECONDS toMillis 1 lastSuggestedReview System currentTimeMillis Computer threadPoolForRemoting submit new Runnable public void run update private void update provisioningLock lock try lastSuggestedReview System currentTimeMillis We need to get the lock on Queue for two reasons 1 We will potentially adding a lot of nodes and we don t want to fight with Queue maintain to acquire the Queue lock in order to add each node Much better is to hold the Queue lock until all nodes that were provisioned since last we checked have been added 2 We want to know the idle executors count which can only be measured if you hold the Queue lock Strictly speaking we don t need an accurate measure for this but as we had to get the Queue lock anyway we might as well get an accurate measure We do not need the Queue lock to get the count of items in the queue as that is a lock free call Since adding a node should not in principle confuse Queue maintain it is only removal of nodes that causes issues in Queue maintain we should be able to remove the need for Queue lock TODO once Nodes addNode is made lock free we should be able to remove the requirement for Queue lock Queue withLock new Runnable Override public void run Jenkins jenkins Jenkins getInstance clean up the cancelled launch activity then count the of executors that we are about to bring up int plannedCapacitySnapshot 0 List PlannedNode snapPendingLaunches new ArrayList PlannedNode pendingLaunches get for Iterator PlannedNode itr snapPendingLaunches iterator itr hasNext PlannedNode f itr next if f future isDone try Node node f future get for CloudProvisioningListener cl CloudProvisioningListener all cl onComplete f node jenkins addNode node LOGGER log Level INFO 0 provisioning successfully completed We have now 1 number integer computer s new Object f displayName jenkins getComputers length catch InterruptedException e throw new AssertionError e since we confirmed that the future is already done catch ExecutionException e LOGGER log Level WARNING Provisioned agent f displayName failed to launch e getCause for CloudProvisioningListener cl CloudProvisioningListener all cl onFailure f e getCause catch IOException e LOGGER log Level WARNING Provisioned agent f displayName failed to launch e for CloudProvisioningListener cl CloudProvisioningListener all cl onFailure f e catch Error e we are not supposed to try and recover from Errors throw e catch Throwable e LOGGER log Level SEVERE Unexpected uncaught exception encountered while processing provisioned agent f displayName e finally while true List PlannedNode orig pendingLaunches get List PlannedNode repl new ArrayList PlannedNode orig the contract for List remove o is that the first element i where o null get i null o equals get i is true will be removed from the list since PlannedNode equals o is not final and we cannot assume that subclasses do not override with an equals which does not assure object identity comparison we need to manually do the removal based on instance identity not equality boolean changed false for Iterator PlannedNode iterator repl iterator iterator hasNext PlannedNode p iterator next if p f iterator remove changed true break if changed pendingLaunches compareAndSet orig repl break f spent else plannedCapacitySnapshot f numExecutors float plannedCapacity plannedCapacitySnapshot plannedCapacitiesEMA update plannedCapacity final LoadStatistics LoadStatisticsSnapshot snapshot stat computeSnapshot int availableSnapshot snapshot getAvailableExecutors int queueLengthSnapshot snapshot getQueueLength if queueLengthSnapshot availableSnapshot LOGGER log Level FINER Queue length 0 is less than the available capacity 1 No provisioning strategy required new Object queueLengthSnapshot availableSnapshot provisioningState null else provisioningState new StrategyState snapshot label plannedCapacitySnapshot if provisioningState null List Strategy strategies Jenkins getInstance getExtensionList Strategy class for Strategy strategy strategies isEmpty Arrays Strategy asList new StandardStrategyImpl strategies LOGGER log Level FINER Consulting 0 provisioning strategy with state 1 new Object strategy provisioningState if StrategyDecision PROVISIONING COMPLETED strategy apply provisioningState LOGGER log Level FINER Provisioning strategy 0 declared provisioning complete strategy break finally provisioningLock unlock public static enum StrategyDecision CONSULT REMAINING STRATEGIES PROVISIONING COMPLETED public static abstract class Strategy implements ExtensionPoint Nonnull GuardedBy NodeProvisioner this public abstract StrategyDecision apply Nonnull StrategyState state public final class StrategyState private final Label label private final int plannedCapacitySnapshot private final LoadStatistics LoadStatisticsSnapshot snapshot GuardedBy this private int additionalPlannedCapacity private StrategyState LoadStatistics LoadStatisticsSnapshot snapshot Label label int plannedCapacitySnapshot this snapshot snapshot this label label this plannedCapacitySnapshot plannedCapacitySnapshot public Label getLabel return label public LoadStatistics LoadStatisticsSnapshot getSnapshot return snapshot Deprecated public int getQueueLengthSnapshot return snapshot getQueueLength public int getPlannedCapacitySnapshot return plannedCapacitySnapshot Deprecated public int getIdleSnapshot return snapshot getAvailableExecutors Deprecated public int getTotalSnapshot return snapshot getOnlineExecutors public synchronized int getAdditionalPlannedCapacity return additionalPlannedCapacity public float getQueueLengthLatest return stat queueLength getLatest TIME SCALE public float getPlannedCapacityLatest return plannedCapacitiesEMA getLatest TIME SCALE Deprecated public float getIdleLatest return getAvailableExecutorsLatest Deprecated public float getTotalLatest return getOnlineExecutorsLatest public float getDefinedExecutorsLatest return stat definedExecutors getLatest TIME SCALE public float getOnlineExecutorsLatest return stat onlineExecutors getLatest TIME SCALE public float getConnectingExecutorsLatest return stat connectingExecutors getLatest TIME SCALE public float getBusyExecutorsLatest return stat busyExecutors getLatest TIME SCALE public float getIdleExecutorsLatest return stat idleExecutors getLatest TIME SCALE public float getAvailableExecutorsLatest return stat availableExecutors getLatest TIME SCALE public void recordPendingLaunches PlannedNode plannedNodes recordPendingLaunches Arrays asList plannedNodes public void recordPendingLaunches Collection PlannedNode plannedNodes int additionalPlannedCapacity 0 for PlannedNode f plannedNodes if f future isDone if done we should use the actual delivered capacity try Node node f future get if node null additionalPlannedCapacity node getNumExecutors catch InterruptedException ExecutionException e InterruptedException should never happen as we were told the future was done ExecutionException ignore this will be caught by others later else additionalPlannedCapacity f numExecutors while plannedNodes isEmpty List PlannedNode orig pendingLaunches get List PlannedNode repl new ArrayList PlannedNode orig repl addAll plannedNodes if pendingLaunches compareAndSet orig repl if additionalPlannedCapacity 0 synchronized this this additionalPlannedCapacity additionalPlannedCapacity break Override public String toString final StringBuilder sb new StringBuilder StrategyState sb append label append label sb append snapshot append snapshot sb append plannedCapacitySnapshot append plannedCapacitySnapshot sb append additionalPlannedCapacity append additionalPlannedCapacity sb append return sb toString Extension Symbol standard public static class StandardStrategyImpl extends Strategy Nonnull Override public StrategyDecision apply Nonnull StrategyState state final LoadStatistics LoadStatisticsSnapshot snapshot state getSnapshot boolean needSomeWhenNoneAtAll snapshot getAvailableExecutors snapshot getConnectingExecutors 0 snapshot getOnlineExecutors state getPlannedCapacitySnapshot state getAdditionalPlannedCapacity 0 snapshot getQueueLength 0 float available Math max snapshot getAvailableExecutors state getAvailableExecutorsLatest if available MARGIN needSomeWhenNoneAtAll make sure the system is fully utilized before attempting any new launch this is the amount of work left to be done float qlen Math min state getQueueLengthLatest snapshot getQueueLength float connectingCapacity Math min state getConnectingExecutorsLatest snapshot getConnectingExecutors and this is the additional executors we ve already provisioned float plannedCapacity Math max state getPlannedCapacityLatest state getPlannedCapacitySnapshot state getAdditionalPlannedCapacity float excessWorkload qlen plannedCapacity connectingCapacity if needSomeWhenNoneAtAll excessWorkload 1 in this specific exceptional case we should just provision right now the exponential smoothing will delay the build unnecessarily excessWorkload 1 float m calcThresholdMargin state getTotalSnapshot if excessWorkload 1 m and there s more work to do LOGGER log Level FINE Excess workload 0 number detected planned capacity 1 number connecting capacity 7 number Qlen 2 number available 3 number 4 number integer online 5 number integer m 6 number new Object excessWorkload plannedCapacity qlen available snapshot getAvailableExecutors snapshot getOnlineExecutors m snapshot getConnectingExecutors CLOUD for Cloud c Jenkins getInstance clouds if excessWorkload 0 break enough agents allocated Make sure this cloud actually can provision for this label if c canProvision state getLabel provisioning a new node should be conservative for example if excessWorkload is 1 4 we don t want to allocate two nodes but just one OTOH because of the exponential decay even when we need one agent excess workload is always something like 0 95 in which case we want to allocate one node so the threshold here is 1 MARGIN and hence floor excessWorkload MARGIN is needed to handle this int workloadToProvision int Math round Math floor excessWorkload m for CloudProvisioningListener cl CloudProvisioningListener all if cl canProvision c state getLabel workloadToProvision null consider displaying reasons in a future cloud ux continue CLOUD Collection PlannedNode additionalCapacities c provision state getLabel workloadToProvision for CloudProvisioningListener cl CloudProvisioningListener all cl onStarted c state getLabel additionalCapacities for PlannedNode ac additionalCapacities excessWorkload ac numExecutors LOGGER log Level INFO Started provisioning 0 from 1 with 2 number integer executors Remaining excess workload 3 number new Object ac displayName c name ac numExecutors excessWorkload state recordPendingLaunches additionalCapacities we took action only pass on to other strategies if our action was insufficient return excessWorkload 1 m StrategyDecision CONSULT REMAINING STRATEGIES StrategyDecision PROVISIONING COMPLETED if we reach here then the standard strategy obviously decided to do nothing so let any other strategies take their considerations return StrategyDecision CONSULT REMAINING STRATEGIES private float calcThresholdMargin int totalSnapshot float f float MARGIN MARGIN0 MARGIN Math pow MARGIN DECAY totalSnapshot defensively ensure that the threshold margin is in 0 1 f Math max f 0 f Math min f 1 return f Extension public static class NodeProvisionerInvoker extends PeriodicWork public static int INITIALDELAY SystemProperties getInteger NodeProvisioner class getName initialDelay LoadStatistics CLOCK 10 public static int RECURRENCEPERIOD SystemProperties getInteger NodeProvisioner class getName recurrencePeriod LoadStatistics CLOCK Override public long getInitialDelay return INITIALDELAY public long getRecurrencePeriod return RECURRENCEPERIOD Override protected void doRun Jenkins h Jenkins getInstance h unlabeledNodeProvisioner update for Label l h getLabels l nodeProvisioner update private static final Logger LOGGER Logger getLogger NodeProvisioner class getName private static final float MARGIN SystemProperties getInteger NodeProvisioner class getName MARGIN 10 100f private static final float MARGIN0 Math max MARGIN getFloatSystemProperty NodeProvisioner class getName MARGIN0 0 5f private static final float MARGIN DECAY getFloatSystemProperty NodeProvisioner class getName MARGIN DECAY 0 5f TODO picker should be selectable private static final TimeScale TIME SCALE TimeScale SEC10 private static float getFloatSystemProperty String propName float defaultValue String v SystemProperties getString propName if v null try return Float parseFloat v catch NumberFormatException e LOGGER warning Failed to parse a float value from system property propName value was v return defaultValuepackage jenkins model import hudson BulkChange import hudson Util import hudson XmlFile import hudson model Computer import hudson model Node import hudson model Queue import hudson model Saveable import hudson model listeners SaveableListener import hudson slaves EphemeralNode import hudson slaves OfflineCause import java util concurrent Callable import org kohsuke accmod Restricted import org kohsuke accmod restrictions NoExternalUse import javax annotation CheckForNull import javax annotation Nonnull import java io File import java io FileFilter import java io IOException import java util ArrayList import java util Collection import java util HashSet import java util Iterator import java util List import java util Map import java util Set import java util TreeMap import java util concurrent ConcurrentMap import java util concurrent ConcurrentSkipListMap import java util logging Level import java util logging Logger Restricted NoExternalUse class for now we may make it public later public class Nodes implements Saveable Nonnull private final Jenkins jenkins private final ConcurrentMap String Node nodes new ConcurrentSkipListMap String Node Nodes Nonnull Jenkins jenkins this jenkins jenkins Nonnull public List Node getNodes return new ArrayList Node nodes values public void setNodes final Nonnull Collection extends Node nodes throws IOException Queue withLock new Runnable Override public void run Set String toRemove new HashSet String Nodes this nodes keySet for Node n nodes final String name n getNodeName toRemove remove name Nodes this nodes put name n Nodes this nodes keySet removeAll toRemove directory clean up will be handled by save jenkins updateComputerList jenkins trimLabels save public void addNode final Nonnull Node node throws IOException if node nodes get node getNodeName TODO we should not need to lock the queue for adding nodes but until we have a way to update the computer list for just the new node Queue withLock new Runnable Override public void run nodes put node getNodeName node jenkins updateComputerList jenkins trimLabels TODO there is a theoretical race whereby the node instance is updated removed after lock release persistNode node NodeListener fireOnCreated node private void persistNode final Nonnull Node node throws IOException no need for a full save so we just do the minimum if node instanceof EphemeralNode Util deleteRecursive new File getNodesDir node getNodeName else XmlFile xmlFile new XmlFile Jenkins XSTREAM new File new File getNodesDir node getNodeName config xml xmlFile write node SaveableListener fireOnChange this xmlFile jenkins getQueue scheduleMaintenance public boolean updateNode final Nonnull Node node throws IOException boolean exists try exists Queue withLock new Callable Boolean Override public Boolean call throws Exception if node nodes get node getNodeName jenkins trimLabels return true return false catch RuntimeException e should never happen but if it does let s do the right thing throw e catch Exception e can never happen exists false if exists TODO there is a theoretical race whereby the node instance is updated removed after lock release persistNode node return true return false public boolean replaceNode final Node oldOne final Nonnull Node newOne throws IOException if oldOne nodes get oldOne getNodeName use the queue lock until Nodes has a way of directly modifying a single node Queue withLock new Runnable public void run Nodes this nodes remove oldOne getNodeName Nodes this nodes put newOne getNodeName newOne jenkins updateComputerList jenkins trimLabels updateNode newOne NodeListener fireOnUpdated oldOne newOne return true else return false public void removeNode final Nonnull Node node throws IOException if node nodes get node getNodeName Queue withLock new Runnable Override public void run Computer c node toComputer if c null c recordTermination c disconnect OfflineCause create hudson model Messages Hudson NodeBeingRemoved if node nodes remove node getNodeName jenkins updateComputerList jenkins trimLabels no need for a full save so we just do the minimum Util deleteRecursive new File getNodesDir node getNodeName NodeListener fireOnDeleted node Override public void save throws IOException if BulkChange contains this return final File nodesDir getNodesDir final Set String existing new HashSet String for Node n nodes values if n instanceof EphemeralNode continue existing add n getNodeName XmlFile xmlFile new XmlFile Jenkins XSTREAM new File new File nodesDir n getNodeName config xml xmlFile write n SaveableListener fireOnChange this xmlFile for File forDeletion nodesDir listFiles new FileFilter Override public boolean accept File pathname return pathname isDirectory existing contains pathname getName Util deleteRecursive forDeletion CheckForNull public Node getNode String name return name null null nodes get name public void load throws IOException final File nodesDir getNodesDir final File subdirs nodesDir listFiles new FileFilter public boolean accept File child return child isDirectory final Map String Node newNodes new TreeMap String Node if subdirs null for File subdir subdirs try XmlFile xmlFile new XmlFile Jenkins XSTREAM new File subdir config xml if xmlFile exists Node node Node xmlFile read newNodes put node getNodeName node catch IOException e Logger getLogger Nodes class getName log Level WARNING could not load subdir e Queue withLock new Runnable Override public void run for Iterator Map Entry String Node i nodes entrySet iterator i hasNext if i next getValue instanceof EphemeralNode i remove nodes putAll newNodes jenkins updateComputerList jenkins trimLabels private File getNodesDir throws IOException final File nodesDir new File jenkins getRootDir nodes if nodesDir isDirectory nodesDir mkdirs throw new IOException String format Could not mkdirs s nodesDir return nodesDir public boolean isLegacy return new File jenkins getRootDir nodes isDirectorypackage jenkins management import hudson Extension import hudson model ManagementLink import jenkins management Messages import org jenkinsci Symbol Extension ordinal Integer MAX VALUE 1000 Symbol nodes public class NodesLink extends ManagementLink Override public String getIconFileName return network png public String getDisplayName return Messages NodesLink DisplayName Override public String getDescription return Messages NodesLink Description Override public String getUrlName return computerpackage hudson slaves import hudson model Node import hudson model EnvironmentSpecific import hudson model TaskListener import javax annotation Nonnull import java io IOException public interface NodeSpecific T extends NodeSpecific T T forNode Nonnull Node node TaskListener log throws IOException InterruptedExceptionpackage hudson model public class NoFingerprintMatch implements ModelObject private final String md5sum public NoFingerprintMatch String md5sum this md5sum md5sum public String getDisplayName return md5sumpackage hudson util import java io File public class NoHomeDir extends BootFailure public final File home public NoHomeDir File home this home homepackage jenkins util import org jvnet localizer Localizable import java util Locale public class NonLocalizable extends Localizable private final String nonLocalizable public NonLocalizable String nonLocalizable super null null this nonLocalizable nonLocalizable Override public String toString Locale locale return nonLocalizable Override public String toString return nonLocalizablepackage jenkins security import org acegisecurity context SecurityContext import org acegisecurity context SecurityContextImpl import org acegisecurity Authentication import org acegisecurity userdetails UserDetails import javax servlet http HttpSession public class NonSerializableSecurityContext implements SecurityContext private transient Authentication authentication public NonSerializableSecurityContext public NonSerializableSecurityContext Authentication authentication this authentication authentication Override public boolean equals Object obj if obj instanceof SecurityContext SecurityContext test SecurityContext obj if this getAuthentication null test getAuthentication null return true if this getAuthentication null test getAuthentication null this getAuthentication equals test getAuthentication return true return false public Authentication getAuthentication return authentication Override public int hashCode if this authentication null return 1 else return this authentication hashCode public void setAuthentication Authentication authentication this authentication authentication Override public String toString StringBuilder sb new StringBuilder sb append super toString if this authentication null sb append Null authentication else sb append Authentication append this authentication return sb toStringpackage hudson security import javax servlet Filter import javax servlet FilterChain import javax servlet FilterConfig import javax servlet ServletException import javax servlet ServletRequest import javax servlet ServletResponse import java io IOException public class NoopFilter implements Filter public void init FilterConfig filterConfig throws ServletException public void doFilter ServletRequest request ServletResponse response FilterChain chain throws IOException ServletException chain doFilter request response public void destroypackage hudson util import org jfree chart axis CategoryAxis import org jfree chart axis AxisState import org jfree chart axis CategoryTick import org jfree chart axis CategoryLabelPosition import org jfree chart plot PlotRenderingInfo import org jfree chart entity EntityCollection import org jfree chart entity CategoryLabelEntity import org jfree ui RectangleEdge import org jfree ui RectangleAnchor import org jfree text TextBlock import java awt import java awt geom Rectangle2D import java awt geom Point2D import java util public class NoOverlapCategoryAxis extends CategoryAxis public NoOverlapCategoryAxis String label super label Override protected AxisState drawCategoryLabels Graphics2D g2 Rectangle2D plotArea Rectangle2D dataArea RectangleEdge edge AxisState state PlotRenderingInfo plotState if state null throw new IllegalArgumentException Null state argument if isTickLabelsVisible java util List ticks refreshTicks g2 state plotArea edge state setTicks ticks remember the last drawn label so that we can avoid drawing overlapping labels Rectangle2D r null int categoryIndex 0 Iterator iterator ticks iterator while iterator hasNext CategoryTick tick CategoryTick iterator next g2 setFont getTickLabelFont tick getCategory g2 setPaint getTickLabelPaint tick getCategory CategoryLabelPosition position this getCategoryLabelPositions getLabelPosition edge double x0 0 0 double x1 0 0 double y0 0 0 double y1 0 0 if edge RectangleEdge TOP x0 getCategoryStart categoryIndex ticks size dataArea edge x1 getCategoryEnd categoryIndex ticks size dataArea edge y1 state getCursor this getCategoryLabelPositionOffset y0 y1 state getMax else if edge RectangleEdge BOTTOM x0 getCategoryStart categoryIndex ticks size dataArea edge x1 getCategoryEnd categoryIndex ticks size dataArea edge y0 state getCursor this getCategoryLabelPositionOffset y1 y0 state getMax else if edge RectangleEdge LEFT y0 getCategoryStart categoryIndex ticks size dataArea edge y1 getCategoryEnd categoryIndex ticks size dataArea edge x1 state getCursor this getCategoryLabelPositionOffset x0 x1 state getMax else if edge RectangleEdge RIGHT y0 getCategoryStart categoryIndex ticks size dataArea edge y1 getCategoryEnd categoryIndex ticks size dataArea edge x0 state getCursor this getCategoryLabelPositionOffset x1 x0 state getMax Rectangle2D area new Rectangle2D Double x0 y0 x1 x0 y1 y0 if r null r intersects area Point2D anchorPoint RectangleAnchor coordinates area position getCategoryAnchor TextBlock block tick getLabel block draw g2 float anchorPoint getX float anchorPoint getY position getLabelAnchor float anchorPoint getX float anchorPoint getY position getAngle Shape bounds block calculateBounds g2 float anchorPoint getX float anchorPoint getY position getLabelAnchor float anchorPoint getX float anchorPoint getY position getAngle if plotState null plotState getOwner null EntityCollection entities plotState getOwner getEntityCollection if entities null String tooltip getCategoryLabelToolTip tick getCategory entities add new CategoryLabelEntity tick getCategory bounds tooltip null r bounds getBounds2D add margins in all directions r add r getMaxX r getWidth 2 r getCenterY r add r getMinX r getWidth 2 r getCenterY r add r getCenterX r getMinY r getHeight 2 r add r getCenterX r getMaxX r getHeight 2 categoryIndex if edge equals RectangleEdge TOP double h state getMax state cursorUp h else if edge equals RectangleEdge BOTTOM double h state getMax state cursorDown h else if edge RectangleEdge LEFT double w state getMax state cursorLeft w else if edge RectangleEdge RIGHT double w state getMax state cursorRight w return statepackage hudson util import org kohsuke accmod Restricted import org kohsuke accmod restrictions NoExternalUse import java io IOException public class NoTempDir extends BootFailure Restricted NoExternalUse class Deprecated public final IOException exception public NoTempDir IOException exception super exception this exception exception public String getTempDir return System getProperty java io tmpdirpackage hudson tasks import hudson Extension import hudson ExtensionPoint public abstract class Notifier extends Publisher implements ExtensionPoint SuppressWarnings deprecation super only Deprecated to discourage other subclasses protected Notifier public BuildStepDescriptor getDescriptor return BuildStepDescriptor super getDescriptorpackage jenkins security import hudson remoting Callable import org jenkinsci remoting RoleChecker public abstract class NotReallyRoleSensitiveCallable V T extends Throwable implements Callable V T Override public void checkRoles RoleChecker checker throws SecurityException not meant to be used where this matters throw new UnsupportedOperationExceptionpackage hudson security import jenkins security NonSerializableSecurityContext import org acegisecurity Authentication Deprecated public class NotSerilizableSecurityContext extends NonSerializableSecurityContext public NotSerilizableSecurityContext public NotSerilizableSecurityContext Authentication authentication super authenticationpackage hudson scm import hudson model Run import org xml sax SAXException import java io File import java io IOException public class NullChangeLogParser extends ChangeLogParser public static final NullChangeLogParser INSTANCE new NullChangeLogParser Override public ChangeLogSet extends ChangeLogSet Entry parse Run build RepositoryBrowser browser File changelogFile throws IOException SAXException return ChangeLogSet createEmpty build public Object readResolve return INSTANCEpackage hudson diagnosis import hudson Extension import hudson PluginWrapper import hudson init Initializer import hudson model AdministrativeMonitor import hudson model Descriptor import jenkins model Jenkins import org jenkinsci Symbol import java text MessageFormat import java util ArrayList import java util Collections import java util List import java util logging Level import java util logging Logger import static hudson init InitMilestone EXTENSIONS AUGMENTED Extension Symbol nullId public class NullIdDescriptorMonitor extends AdministrativeMonitor Override public String getDisplayName return Messages NullIdDescriptorMonitor DisplayName private final List Descriptor problems new ArrayList Descriptor Override public boolean isActivated return problems isEmpty public List Descriptor getProblems return Collections unmodifiableList problems Initializer after EXTENSIONS AUGMENTED public void verify Jenkins h Jenkins getInstance for Descriptor d h getExtensionList Descriptor class PluginWrapper p h getPluginManager whichPlugin d getClass String id try id d getId catch Throwable t LOGGER log Level SEVERE MessageFormat format Descriptor 0 from plugin 1 with display name 2 reported an exception for ID d p null p getLongName d getDisplayName t problems add d continue if id null LOGGER severe MessageFormat format Descriptor 0 from plugin 1 with display name 2 has null ID d p null p getLongName d getDisplayName problems add d private static final Logger LOGGER Logger getLogger NullIdDescriptorMonitor class getNamepackage hudson scm import hudson Extension import hudson FilePath import hudson Launcher import hudson model Job import hudson model Run import hudson model TaskListener import java io File import java io IOException import org jenkinsci Symbol import org kohsuke stapler DataBoundConstructor public class NullSCM extends SCM DataBoundConstructor public NullSCM Override public SCMRevisionState calcRevisionsFromBuild Run build FilePath workspace Launcher launcher TaskListener listener throws IOException InterruptedException return null Override public PollingResult compareRemoteRevisionWith Job project Launcher launcher FilePath workspace TaskListener listener SCMRevisionState baseline throws IOException InterruptedException return PollingResult NO CHANGES Override public void checkout Run build Launcher launcher FilePath workspace TaskListener listener File changelogFile SCMRevisionState baseline throws IOException InterruptedException if changelogFile null createEmptyChangeLog changelogFile listener log Override public ChangeLogParser createChangeLogParser return NullChangeLogParser INSTANCE Extension ordinal Integer MAX VALUE Symbol none public static class DescriptorImpl extends SCMDescriptor NullSCM public DescriptorImpl super null Override public String getDisplayName return Messages NullSCM DisplayNamepackage hudson util import java io OutputStream public final class NullStream extends OutputStream public NullStream Override public void write byte b Override public void write byte b int off int len public void write int bpackage com twitter sdk android core internal oauth import com twitter sdk android core TwitterAuthConfig import com twitter sdk android core TwitterAuthToken import java util HashMap import java util Map public class OAuth1aHeaders public static final String HEADER AUTH SERVICE PROVIDER X Auth Service Provider public static final String HEADER AUTH CREDENTIALS X Verify Credentials Authorization public String getAuthorizationHeader TwitterAuthConfig authConfig TwitterAuthToken authToken String callback String method String url Map String String postParams final OAuth1aParameters oAuth1aParameters getOAuth1aParameters authConfig authToken callback method url postParams return oAuth1aParameters getAuthorizationHeader public Map String String getOAuthEchoHeaders TwitterAuthConfig authConfig TwitterAuthToken authToken String callback String method String url Map String String postParams final Map String String headers new HashMap 2 final String authorizationHeader getAuthorizationHeader authConfig authToken callback method url postParams headers put HEADER AUTH CREDENTIALS authorizationHeader headers put HEADER AUTH SERVICE PROVIDER url return headers OAuth1aParameters getOAuth1aParameters TwitterAuthConfig authConfig TwitterAuthToken authToken String callback String method String url Map String String postParams return new OAuth1aParameters authConfig authToken callback method url postParamspackage com twitter sdk android core internal network import com twitter sdk android core Session import com twitter sdk android core TwitterAuthConfig import com twitter sdk android core TwitterAuthToken import com twitter sdk android core internal oauth OAuth1aHeaders import com twitter sdk android core internal oauth OAuthConstants import java io IOException import java util HashMap import java util Locale import java util Map import io fabric sdk android services network UrlUtils import okhttp3 FormBody import okhttp3 HttpUrl import okhttp3 Interceptor import okhttp3 Request import okhttp3 RequestBody import okhttp3 Response public class OAuth1aInterceptor implements Interceptor final Session extends TwitterAuthToken session final TwitterAuthConfig authConfig public OAuth1aInterceptor Session extends TwitterAuthToken session TwitterAuthConfig authConfig this session session this authConfig authConfig Override public Response intercept Chain chain throws IOException final Request request chain request final Request hackRequest request newBuilder url urlWorkaround request url build final Request newRequest hackRequest newBuilder header OAuthConstants HEADER AUTHORIZATION getAuthorizationHeader hackRequest build return chain proceed newRequest HttpUrl urlWorkaround HttpUrl url final HttpUrl Builder builder url newBuilder query null final int size url querySize for int i 0 i size i builder addEncodedQueryParameter UrlUtils percentEncode url queryParameterName i UrlUtils percentEncode url queryParameterValue i return builder build String getAuthorizationHeader Request request throws IOException return new OAuth1aHeaders getAuthorizationHeader authConfig session getAuthToken null request method request url toString getPostParams request Map String String getPostParams Request request throws IOException final Map String String params new HashMap if POST equals request method toUpperCase Locale US final RequestBody output request body if output instanceof FormBody final FormBody body FormBody output for int i 0 i body size i params put body encodedName i body value i return paramspackage com twitter sdk android core internal oauth import io fabric sdk android Fabric import io fabric sdk android services network HttpRequest import io fabric sdk android services network UrlUtils import com twitter sdk android core TwitterAuthConfig import com twitter sdk android core TwitterAuthToken import com twitter sdk android core TwitterCore import java io UnsupportedEncodingException import java net URI import java security InvalidKeyException import java security NoSuchAlgorithmException import java security SecureRandom import java util Locale import java util Map import java util TreeMap import javax crypto Mac import javax crypto SecretKey import javax crypto spec SecretKeySpec class OAuth1aParameters private static final String VERSION 1 0 private static final String SIGNATURE METHOD HMAC SHA1 private static final SecureRandom RAND new SecureRandom private final TwitterAuthConfig authConfig private final TwitterAuthToken authToken private final String callback private final String method private final String url private final Map String String postParams public OAuth1aParameters TwitterAuthConfig authConfig TwitterAuthToken authToken String callback String method String url Map String String postParams this authConfig authConfig this authToken authToken this callback callback this method method this url url this postParams postParams public String getAuthorizationHeader final String nonce getNonce final String timestamp getTimestamp final String signatureBase constructSignatureBase nonce timestamp final String signature calculateSignature signatureBase return constructAuthorizationHeader nonce timestamp signature private String getNonce return String valueOf System nanoTime String valueOf Math abs RAND nextLong private String getTimestamp final long secondsFromEpoch System currentTimeMillis 1000 return Long toString secondsFromEpoch String constructSignatureBase String nonce String timestamp Get query parameters from request final URI uri URI create url final TreeMap String String params UrlUtils getQueryParams uri true if postParams null params putAll postParams Add OAuth parameters if callback null params put OAuthConstants PARAM CALLBACK callback params put OAuthConstants PARAM CONSUMER KEY authConfig getConsumerKey params put OAuthConstants PARAM NONCE nonce params put OAuthConstants PARAM SIGNATURE METHOD SIGNATURE METHOD params put OAuthConstants PARAM TIMESTAMP timestamp if authToken null authToken token null params put OAuthConstants PARAM TOKEN authToken token params put OAuthConstants PARAM VERSION VERSION Construct the signature base final String baseUrl uri getScheme uri getHost uri getPath final StringBuilder sb new StringBuilder append method toUpperCase Locale ENGLISH append append UrlUtils percentEncode baseUrl append append getEncodedQueryParams params return sb toString private String getEncodedQueryParams TreeMap String String params final StringBuilder paramsBuf new StringBuilder final int numParams params size int current 0 for Map Entry String String entry params entrySet paramsBuf append UrlUtils percentEncode UrlUtils percentEncode entry getKey append 3D append UrlUtils percentEncode UrlUtils percentEncode entry getValue current 1 if current numParams paramsBuf append 26 return paramsBuf toString String calculateSignature String signatureBase try final String key getSigningKey Calculate the signature by passing both the signature base and signing key to the HMAC SHA1 hashing algorithm final byte signatureBaseBytes signatureBase getBytes UrlUtils UTF8 final byte keyBytes key getBytes UrlUtils UTF8 final SecretKey secretKey new SecretKeySpec keyBytes HmacSHA1 final Mac mac Mac getInstance HmacSHA1 mac init secretKey final byte signatureBytes mac doFinal signatureBaseBytes return new String HttpRequest Base64 encodeBytesToBytes signatureBytes 0 signatureBytes length UrlUtils UTF8 catch InvalidKeyException e Fabric getLogger e TwitterCore TAG Failed to calculate signature e return catch NoSuchAlgorithmException e Fabric getLogger e TwitterCore TAG Failed to calculate signature e return catch UnsupportedEncodingException e Fabric getLogger e TwitterCore TAG Failed to calculate signature e return private String getSigningKey final String tokenSecret authToken null authToken secret null return new StringBuilder append UrlUtils urlEncode authConfig getConsumerSecret append append UrlUtils urlEncode tokenSecret toString String constructAuthorizationHeader String nonce String timestamp String signature final StringBuilder sb new StringBuilder OAuth appendParameter sb OAuthConstants PARAM CALLBACK callback appendParameter sb OAuthConstants PARAM CONSUMER KEY authConfig getConsumerKey appendParameter sb OAuthConstants PARAM NONCE nonce appendParameter sb OAuthConstants PARAM SIGNATURE signature appendParameter sb OAuthConstants PARAM SIGNATURE METHOD SIGNATURE METHOD appendParameter sb OAuthConstants PARAM TIMESTAMP timestamp final String token authToken null authToken token null appendParameter sb OAuthConstants PARAM TOKEN token appendParameter sb OAuthConstants PARAM VERSION VERSION Remove the extra at the end return sb substring 0 sb length 1 private void appendParameter StringBuilder sb String name String value if value null sb append append UrlUtils percentEncode name append append UrlUtils percentEncode value appendpackage com twitter sdk android core internal oauth import android net Uri import io fabric sdk android services network UrlUtils import com twitter sdk android core Callback import com twitter sdk android core Result import com twitter sdk android core TwitterCore import com twitter sdk android core TwitterAuthConfig import com twitter sdk android core TwitterAuthException import com twitter sdk android core TwitterAuthToken import com twitter sdk android core TwitterException import com twitter sdk android core internal TwitterApi import java io BufferedReader import java io IOException import java io InputStreamReader import java util TreeMap import javax net ssl SSLSocketFactory import okhttp3 ResponseBody import retrofit2 Call import retrofit2 http Header import retrofit2 http POST import retrofit2 http Query public class OAuth1aService extends OAuthService interface OAuthApi POST oauth request token Call ResponseBody getTempToken Header OAuthConstants HEADER AUTHORIZATION String auth POST oauth access token Call ResponseBody getAccessToken Header OAuthConstants HEADER AUTHORIZATION String auth Query OAuthConstants PARAM VERIFIER String verifier private static final String RESOURCE OAUTH oauth private static final String CALLBACK URL twittersdk callback private static final String PARAM SCREEN NAME screen name private static final String PARAM USER ID user id OAuthApi api public OAuth1aService TwitterCore twitterCore SSLSocketFactory sslSocketFactory TwitterApi api super twitterCore sslSocketFactory api this api getRetrofit create OAuthApi class public void requestTempToken final Callback OAuthResponse callback final TwitterAuthConfig config getTwitterCore getAuthConfig final String url getTempTokenUrl api getTempToken new OAuth1aHeaders getAuthorizationHeader config null buildCallbackUrl config POST url null enqueue getCallbackWrapper callback String getTempTokenUrl return getApi getBaseHostUrl oauth request token public String buildCallbackUrl TwitterAuthConfig authConfig return Uri parse CALLBACK URL buildUpon appendQueryParameter version getTwitterCore getVersion appendQueryParameter app authConfig getConsumerKey build toString public void requestAccessToken final Callback OAuthResponse callback TwitterAuthToken requestToken String verifier final String url getAccessTokenUrl final String authHeader new OAuth1aHeaders getAuthorizationHeader getTwitterCore getAuthConfig requestToken null POST url null api getAccessToken authHeader verifier enqueue getCallbackWrapper callback String getAccessTokenUrl return getApi getBaseHostUrl oauth access token public String getAuthorizeUrl TwitterAuthToken requestToken https api twitter com oauth authorize oauth token s return getApi buildUponBaseHostUrl RESOURCE OAUTH authorize appendQueryParameter OAuthConstants PARAM TOKEN requestToken token build toString public static OAuthResponse parseAuthResponse String response final TreeMap String String params UrlUtils getQueryParams response false final String token params get OAuthConstants PARAM TOKEN final String secret params get OAuthConstants PARAM TOKEN SECRET final String userName params get PARAM SCREEN NAME final long userId if params containsKey PARAM USER ID userId Long parseLong params get PARAM USER ID else userId 0L if token null secret null return null else return new OAuthResponse new TwitterAuthToken token secret userName userId Callback ResponseBody getCallbackWrapper final Callback OAuthResponse callback return new Callback ResponseBody Override public void success Result ResponseBody result Try to get response body BufferedReader reader null final StringBuilder sb new StringBuilder try try reader new BufferedReader new InputStreamReader result data byteStream String line while line reader readLine null sb append line finally if reader null reader close final String responseAsStr sb toString final OAuthResponse authResponse parseAuthResponse responseAsStr if authResponse null callback failure new TwitterAuthException Failed to parse auth response responseAsStr else callback success new Result authResponse null catch IOException e callback failure new TwitterAuthException e getMessage e Override public void failure TwitterException exception callback failure exceptionpackage com twitter sdk android core internal oauth import io fabric sdk android Fabric import io fabric sdk android services network HttpRequest import io fabric sdk android services network UrlUtils import com twitter sdk android core Callback import com twitter sdk android core Result import com twitter sdk android core TwitterCore import com twitter sdk android core TwitterAuthConfig import com twitter sdk android core TwitterException import com twitter sdk android core internal TwitterApi import javax net ssl SSLSocketFactory import retrofit2 Call import retrofit2 http Field import retrofit2 http FormUrlEncoded import retrofit2 http Header import retrofit2 http Headers import retrofit2 http POST public class OAuth2Service extends OAuthService OAuth2Api api interface OAuth2Api POST 1 1 guest activate json Call GuestTokenResponse getGuestToken Header OAuthConstants HEADER AUTHORIZATION String auth Headers Content Type application x www form urlencoded charset UTF 8 FormUrlEncoded POST oauth2 token Call OAuth2Token getAppAuthToken Header OAuthConstants HEADER AUTHORIZATION String auth Field OAuthConstants PARAM GRANT TYPE String grantType public OAuth2Service TwitterCore twitterCore SSLSocketFactory sslSocketFactory TwitterApi api super twitterCore sslSocketFactory api this api getRetrofit create OAuth2Api class public void requestGuestAuthToken final Callback GuestAuthToken callback final Callback OAuth2Token appAuthCallback new Callback OAuth2Token Override public void success Result OAuth2Token result final OAuth2Token appAuthToken result data Got back an app auth token now request a guest auth token final Callback GuestTokenResponse guestTokenCallback new Callback GuestTokenResponse Override public void success Result GuestTokenResponse result Return a GuestAuthToken that includes the guestToken final GuestAuthToken guestAuthToken new GuestAuthToken appAuthToken getTokenType appAuthToken getAccessToken result data guestToken callback success new Result guestAuthToken null Override public void failure TwitterException error Fabric getLogger e TwitterCore TAG Your app may not allow guest auth Please talk to us regarding upgrading your consumer key error callback failure error requestGuestToken guestTokenCallback appAuthToken Override public void failure TwitterException error Fabric getLogger e TwitterCore TAG Failed to get app auth token error if callback null callback failure error requestAppAuthToken appAuthCallback void requestAppAuthToken final Callback OAuth2Token callback api getAppAuthToken getAuthHeader OAuthConstants GRANT TYPE CLIENT CREDENTIALS enqueue callback void requestGuestToken final Callback GuestTokenResponse callback OAuth2Token appAuthToken api getGuestToken getAuthorizationHeader appAuthToken enqueue callback private String getAuthorizationHeader OAuth2Token token return OAuthConstants AUTHORIZATION BEARER token getAccessToken private String getAuthHeader final TwitterAuthConfig authConfig getTwitterCore getAuthConfig return OAuthConstants AUTHORIZATION BASIC HttpRequest Base64 encode UrlUtils percentEncode authConfig getConsumerKey UrlUtils percentEncode authConfig getConsumerSecretpackage com twitter sdk android core internal oauth import android os Parcel import android os Parcelable import com google gson annotations SerializedName import com twitter sdk android core AuthToken public class OAuth2Token extends AuthToken implements Parcelable public static final String TOKEN TYPE BEARER bearer public static final Parcelable Creator OAuth2Token CREATOR new Parcelable Creator OAuth2Token public OAuth2Token createFromParcel Parcel in return new OAuth2Token in public OAuth2Token newArray int size return new OAuth2Token size SerializedName token type private final String tokenType SerializedName access token private final String accessToken public OAuth2Token String tokenType String accessToken super this tokenType tokenType this accessToken accessToken public OAuth2Token String tokenType String accessToken long createdAt super createdAt this tokenType tokenType this accessToken accessToken private OAuth2Token Parcel in super tokenType in readString accessToken in readString public String getTokenType return tokenType public String getAccessToken return accessToken Override public boolean isExpired Oauth 2 0 tokens do not have a common expiration policy Returning false indicates the token is not known to have expired App auth tokens only expire when manually invalidated while guest auth tokens are known to have expired after 3 hours return false Override public int describeContents return 0 Override public void writeToParcel Parcel out int flags out writeString tokenType out writeString accessToken Override public boolean equals Object o if this o return true if o null getClass o getClass return false final OAuth2Token that OAuth2Token o if accessToken null accessToken equals that accessToken that accessToken null return false if tokenType null tokenType equals that tokenType that tokenType null return false return true Override public int hashCode int result tokenType null tokenType hashCode 0 result 31 result accessToken null accessToken hashCode 0 return resultpackage com twitter sdk android core identity import android app Activity import android content Intent import android os Bundle import android view View import android webkit WebView import android widget ProgressBar import com twitter sdk android core R import com twitter sdk android core TwitterAuthConfig import com twitter sdk android core TwitterAuthException import com twitter sdk android core TwitterCore import com twitter sdk android core internal TwitterApi import com twitter sdk android core internal oauth OAuth1aService This activity assumes it will handle configuration changes itself and MUST have the following attribute defined in the AndroidManifest xml file android configChanges orientation screenSize public class OAuthActivity extends Activity implements OAuthController Listener static final String EXTRA AUTH CONFIG auth config private static final String STATE PROGRESS progress OAuthController oAuthController private ProgressBar spinner private WebView webView Override protected void onCreate Bundle savedInstanceState super onCreate savedInstanceState setContentView R layout tw activity oauth spinner ProgressBar findViewById R id tw spinner webView WebView findViewById R id tw web view final boolean showProgress if savedInstanceState null showProgress savedInstanceState getBoolean STATE PROGRESS false else showProgress true spinner setVisibility showProgress View VISIBLE View GONE final TwitterCore kit TwitterCore getInstance oAuthController new OAuthController spinner webView TwitterAuthConfig getIntent getParcelableExtra EXTRA AUTH CONFIG new OAuth1aService kit kit getSSLSocketFactory new TwitterApi this oAuthController startAuth Override protected void onSaveInstanceState Bundle outState if spinner getVisibility View VISIBLE outState putBoolean STATE PROGRESS true super onSaveInstanceState outState Override public void onBackPressed oAuthController handleAuthError RESULT CANCELED new TwitterAuthException Authorization failed request was canceled Override public void onComplete int resultCode Intent data setResult resultCode data finishpackage com twitter sdk android core identity import android app Activity import android content Context import android content Intent import io fabric sdk android FabricActivityTestCase import io fabric sdk android FabricTestUtils import com twitter sdk android core TwitterAuthConfig import com twitter sdk android core TwitterAuthException import com twitter sdk android core TwitterCore import org mockito ArgumentCaptor import static org mockito Mockito public class OAuthActivityTest extends FabricActivityTestCase OAuthActivity private Context context private TwitterCore twitterCore private OAuthController mockController public OAuthActivityTest super OAuthActivity class Override protected void setUp throws Exception super setUp context getInstrumentation getTargetContext twitterCore new TwitterCore new TwitterAuthConfig mockController mock TestOAuthController class FabricTestUtils resetFabric FabricTestUtils with context twitterCore Override protected void tearDown throws Exception FabricTestUtils resetFabric super tearDown private void init final Intent intent new Intent context OAuthActivity class putExtra OAuthActivity EXTRA AUTH CONFIG twitterCore getAuthConfig final OAuthActivity activity startActivity intent null null activity oAuthController mockController public void testOnBackPressed init getActivity onBackPressed final ArgumentCaptor TwitterAuthException exceptionArgCaptor ArgumentCaptor forClass TwitterAuthException class verify mockController handleAuthError eq Activity RESULT CANCELED exceptionArgCaptor capture assertEquals Authorization failed request was canceled exceptionArgCaptor getValue getMessage public void testOnComplete init getActivity onComplete Activity RESULT OK new Intent assertTrue isFinishCalledpackage com twitter sdk android core internal oauth public class OAuthConstants public static final String HEADER AUTHORIZATION Authorization public static final String HEADER GUEST TOKEN x guest token OAuth1 0a parameter constants public static final String PARAM CALLBACK oauth callback public static final String PARAM CONSUMER KEY oauth consumer key public static final String PARAM NONCE oauth nonce public static final String PARAM SIGNATURE METHOD oauth signature method public static final String PARAM TIMESTAMP oauth timestamp public static final String PARAM TOKEN oauth token public static final String PARAM TOKEN SECRET oauth token secret public static final String PARAM VERSION oauth version public static final String PARAM SIGNATURE oauth signature public static final String PARAM VERIFIER oauth verifier OAuth2 public static final String AUTHORIZATION BASIC Basic public static final String AUTHORIZATION BEARER Bearer public static final String PARAM GRANT TYPE grant type public static final String GRANT TYPE CLIENT CREDENTIALS client credentialspackage com twitter sdk android core identity import android app Activity import android content Intent import android os Bundle import android view View import android webkit WebChromeClient import android webkit WebSettings import android webkit WebView import android webkit WebViewClient import android widget ProgressBar import io fabric sdk android Fabric import com twitter sdk android core Callback import com twitter sdk android core Result import com twitter sdk android core TwitterAuthConfig import com twitter sdk android core TwitterAuthException import com twitter sdk android core TwitterAuthToken import com twitter sdk android core TwitterCore import com twitter sdk android core TwitterException import com twitter sdk android core internal oauth OAuth1aService import com twitter sdk android core internal oauth OAuthConstants import com twitter sdk android core internal oauth OAuthResponse class OAuthController implements OAuthWebViewClient Listener interface Listener void onComplete int resultCode Intent data final Listener listener TwitterAuthToken requestToken private final ProgressBar spinner private final WebView webView private final TwitterAuthConfig authConfig private final OAuth1aService oAuth1aService OAuthController ProgressBar spinner WebView webView TwitterAuthConfig authConfig OAuth1aService oAuth1aService Listener listener this spinner spinner this webView webView this authConfig authConfig this oAuth1aService oAuth1aService this listener listener void startAuth Step 1 Obtain a request token to start the sign in flow Fabric getLogger d TwitterCore TAG Obtaining request token to start the sign in flow oAuth1aService requestTempToken newRequestTempTokenCallback Callback OAuthResponse newRequestTempTokenCallback return new Callback OAuthResponse Override public void success Result OAuthResponse result requestToken result data authToken final String authorizeUrl oAuth1aService getAuthorizeUrl requestToken Step 2 Redirect user to web view to complete authorization flow Fabric getLogger d TwitterCore TAG Redirecting user to web view to complete authorization flow setUpWebView webView new OAuthWebViewClient oAuth1aService buildCallbackUrl authConfig OAuthController this authorizeUrl new OAuthWebChromeClient Override public void failure TwitterException error Fabric getLogger e TwitterCore TAG Failed to get request token error Create new exception that can be safely serialized since Retrofit errors may throw a NotSerializableException handleAuthError AuthHandler RESULT CODE ERROR new TwitterAuthException Failed to get request token protected void handleAuthError int resultCode TwitterAuthException error final Intent data new Intent data putExtra AuthHandler EXTRA AUTH ERROR error listener onComplete resultCode data void setUpWebView WebView webView WebViewClient webViewClient String url WebChromeClient webChromeClient final WebSettings webSettings webView getSettings webSettings setAllowFileAccess false webSettings setJavaScriptEnabled false webSettings setSaveFormData false webView setVerticalScrollBarEnabled false webView setHorizontalScrollBarEnabled false webView setWebViewClient webViewClient webView loadUrl url webView setVisibility View INVISIBLE webView setWebChromeClient webChromeClient private void handleWebViewSuccess Bundle bundle Fabric getLogger d TwitterCore TAG OAuth web view completed successfully if bundle null final String verifier bundle getString OAuthConstants PARAM VERIFIER if verifier null Step 3 Convert the request token to an access token Fabric getLogger d TwitterCore TAG Converting the request token to an access token oAuth1aService requestAccessToken newRequestAccessTokenCallback requestToken verifier return If we get here we failed to complete authorization Fabric getLogger e TwitterCore TAG Failed to get authorization bundle incomplete bundle null handleAuthError AuthHandler RESULT CODE ERROR new TwitterAuthException Failed to get authorization bundle incomplete Callback OAuthResponse newRequestAccessTokenCallback return new Callback OAuthResponse Override public void success Result OAuthResponse result final Intent data new Intent final OAuthResponse response result data data putExtra AuthHandler EXTRA SCREEN NAME response userName data putExtra AuthHandler EXTRA USER ID response userId data putExtra AuthHandler EXTRA TOKEN response authToken token data putExtra AuthHandler EXTRA TOKEN SECRET response authToken secret listener onComplete Activity RESULT OK data Override public void failure TwitterException error Fabric getLogger e TwitterCore TAG Failed to get access token error Create new exception that can be safely serialized since Retrofit errors may throw a NotSerializableException handleAuthError AuthHandler RESULT CODE ERROR new TwitterAuthException Failed to get access token private void handleWebViewError WebViewException error Fabric getLogger e TwitterCore TAG OAuth web view completed with an error error handleAuthError AuthHandler RESULT CODE ERROR new TwitterAuthException OAuth web view completed with an error private void dismissWebView webView stopLoading dismissSpinner private void dismissSpinner spinner setVisibility View GONE Override public void onPageFinished WebView webView String url dismissSpinner webView setVisibility View VISIBLE Override public void onSuccess Bundle bundle handleWebViewSuccess bundle dismissWebView Override public void onError WebViewException exception handleWebViewError exception dismissWebViewpackage com twitter sdk android core identity import android app Activity import android content Intent import com twitter sdk android core Callback import com twitter sdk android core TwitterAuthConfig import com twitter sdk android core TwitterSession class OAuthHandler extends AuthHandler public OAuthHandler TwitterAuthConfig authConfig Callback TwitterSession callback int requestCode super authConfig callback requestCode Override public boolean authorize Activity activity activity startActivityForResult newIntent activity requestCode return true Intent newIntent Activity activity final Intent intent new Intent activity OAuthActivity class intent putExtra OAuthActivity EXTRA AUTH CONFIG getAuthConfig return intentpackage com twitter sdk android core internal oauth import android os Parcel import android os Parcelable import com twitter sdk android core TwitterAuthToken public class OAuthResponse implements Parcelable public static final Parcelable Creator OAuthResponse CREATOR new Parcelable Creator OAuthResponse public OAuthResponse createFromParcel Parcel in return new OAuthResponse in public OAuthResponse newArray int size return new OAuthResponse size public final TwitterAuthToken authToken public final String userName public final long userId public OAuthResponse TwitterAuthToken authToken String userName long userId this authToken authToken this userName userName this userId userId private OAuthResponse Parcel in this authToken in readParcelable TwitterAuthToken class getClassLoader this userName in readString this userId in readLong Override public String toString return new StringBuilder append authToken append authToken append userName append userName append userId append userId toString Override public int describeContents return 0 Override public void writeToParcel Parcel out int flags out writeParcelable this authToken flags out writeString this userName out writeLong this userIdpackage com twitter sdk android core internal oauth import com twitter sdk android core TwitterCore import com twitter sdk android core internal TwitterApi import java io IOException import javax net ssl SSLSocketFactory import okhttp3 Interceptor import okhttp3 OkHttpClient import okhttp3 Request import okhttp3 Response import retrofit2 Retrofit import retrofit2 converter gson GsonConverterFactory abstract class OAuthService private static final String CLIENT NAME TwitterAndroidSDK private final TwitterCore twitterCore private final TwitterApi api private final String userAgent private final Retrofit retrofit OAuthService TwitterCore twitterCore SSLSocketFactory sslSocketFactory TwitterApi api this twitterCore twitterCore this api api userAgent TwitterApi buildUserAgent CLIENT NAME twitterCore getVersion if sslSocketFactory null throw new IllegalArgumentException sslSocketFactory must not be null final OkHttpClient client new OkHttpClient Builder sslSocketFactory sslSocketFactory addInterceptor new Interceptor Override public Response intercept Chain chain throws IOException final Request request chain request newBuilder header User Agent getUserAgent build return chain proceed request build retrofit new Retrofit Builder baseUrl getApi getBaseHostUrl client client addConverterFactory GsonConverterFactory create build protected TwitterCore getTwitterCore return twitterCore protected TwitterApi getApi return api protected String getUserAgent return userAgent protected Retrofit getRetrofit return retrofitpackage com twitter sdk android core import io fabric sdk android services network HttpMethod import com twitter sdk android core internal TwitterApi import com twitter sdk android core internal oauth OAuth1aHeaders import java util Map public class OAuthSigning static final String VERIFY CREDENTIALS URL TwitterApi BASE HOST URL 1 1 account verify credentials json final TwitterAuthConfig authConfig final TwitterAuthToken authToken final OAuth1aHeaders oAuth1aHeaders public OAuthSigning TwitterAuthConfig authConfig TwitterAuthToken authToken this authConfig authToken new OAuth1aHeaders OAuthSigning TwitterAuthConfig authConfig TwitterAuthToken authToken OAuth1aHeaders oAuth1aHeaders if authConfig null throw new IllegalArgumentException authConfig must not be null if authToken null throw new IllegalArgumentException authToken must not be null this authConfig authConfig this authToken authToken this oAuth1aHeaders oAuth1aHeaders public String getAuthorizationHeader String method String url Map String String postParams return oAuth1aHeaders getAuthorizationHeader authConfig authToken null method url postParams public Map String String getOAuthEchoHeaders String method String url Map String String postParams return oAuth1aHeaders getOAuthEchoHeaders authConfig authToken null method url postParams public Map String String getOAuthEchoHeadersForVerifyCredentials return oAuth1aHeaders getOAuthEchoHeaders authConfig authToken null HttpMethod GET name VERIFY CREDENTIALS URL nullpackage com twitter sdk android core identity import android webkit ConsoleMessage import android webkit WebChromeClient class OAuthWebChromeClient extends WebChromeClient Override public boolean onConsoleMessage ConsoleMessage consoleMessage Do not log return truepackage com twitter sdk android core identity import android net http SslError import android os Bundle import android webkit SslErrorHandler import android webkit WebView import android webkit WebViewClient import java net URI import java util TreeMap import io fabric sdk android services network UrlUtils class OAuthWebViewClient extends WebViewClient interface Listener void onPageFinished WebView webView String url void onSuccess Bundle bundle void onError WebViewException exception private final String completeUrl private final Listener listener public OAuthWebViewClient String completeUrl Listener listener this completeUrl completeUrl this listener listener Override public void onPageFinished WebView view String url super onPageFinished view url listener onPageFinished view url Override public boolean shouldOverrideUrlLoading WebView view String url if url startsWith completeUrl final TreeMap String String params UrlUtils getQueryParams URI create url false final Bundle bundle new Bundle params size for TreeMap Entry String String entry params entrySet bundle putString entry getKey entry getValue listener onSuccess bundle return true return super shouldOverrideUrlLoading view url Override public void onReceivedError WebView view int errorCode String description String failingUrl super onReceivedError view errorCode description failingUrl listener onError new WebViewException errorCode description failingUrl Override public void onReceivedSslError WebView view SslErrorHandler handler SslError error super onReceivedSslError view handler error listener onError new WebViewException error getPrimaryError null nullpackage com twitter sdk android core internal util import android annotation TargetApi import android content Context import android os Build import android util AttributeSet import android widget ScrollView public class ObservableScrollView extends ScrollView ScrollViewListener scrollViewListener public ObservableScrollView Context context super context public ObservableScrollView Context context AttributeSet attrs super context attrs public ObservableScrollView Context context AttributeSet attrs int defStyleAttr super context attrs defStyleAttr TargetApi Build VERSION CODES LOLLIPOP public ObservableScrollView Context context AttributeSet attrs int defStyleAttr int defStyleRes super context attrs defStyleAttr defStyleRes Override protected void onScrollChanged int currentX int currentY int oldX int oldY super onScrollChanged currentX currentY oldX oldY if scrollViewListener null scrollViewListener onScrollChanged currentY public void setScrollViewListener ScrollViewListener scrollViewListener this scrollViewListener scrollViewListener public interface ScrollViewListener void onScrollChanged int scrollYpackage com twitter sdk android core internal util import android test AndroidTestCase import static org mockito Mockito mock import static org mockito Mockito verify public class ObservableScrollViewTest extends AndroidTestCase static final int TEST SCROLL X 10 public void testOnScrollChanged final ObservableScrollView scrollView new ObservableScrollView getContext final ObservableScrollView ScrollViewListener listener mock ObservableScrollView ScrollViewListener class scrollView setScrollViewListener listener scrollView onScrollChanged 0 TEST SCROLL X 0 0 verify listener onScrollChanged TEST SCROLL Xpackage hudson slaves import jenkins model Jenkins import hudson Functions import hudson model Computer import hudson model User import org jvnet localizer Localizable import org kohsuke stapler export ExportedBean import org kohsuke stapler export Exported import javax annotation Nonnull import java util Date ExportedBean public abstract class OfflineCause protected final long timestamp System currentTimeMillis Exported public long getTimestamp return timestamp public final Nonnull Date getTime return new Date timestamp public static class SimpleOfflineCause extends OfflineCause public final Localizable description protected SimpleOfflineCause Localizable description this description description Exported name description Override public String toString return description toString public static OfflineCause create Localizable d if d null return null return new SimpleOfflineCause d public static class ChannelTermination extends OfflineCause Exported public final Exception cause public ChannelTermination Exception cause this cause cause public String getShortDescription return cause toString Override public String toString return Messages OfflineCause connection was broken Functions printThrowable cause public static class LaunchFailed extends OfflineCause Override public String toString return Messages OfflineCause LaunchFailed public static class UserCause extends SimpleOfflineCause private final User user public UserCause User user String message super hudson slaves Messages SlaveComputer DisconnectedBy user null user getId Jenkins ANONYMOUS getName message null message this user user public User getUser return user public static class ByCLI extends UserCause Exported public final String message public ByCLI String message super User current message this message message public static class IdleOfflineCause extends SimpleOfflineCause public IdleOfflineCause super hudson slaves Messages RetentionStrategy Demand OfflineIdlepackage hudson cli import hudson AbortException import hudson Extension import hudson model Computer import hudson model ComputerSet import hudson util EditDistance import jenkins model Jenkins import org kohsuke args4j Argument import org kohsuke args4j Option import java util ArrayList import java util HashSet import java util List Extension public class OfflineNodeCommand extends CLICommand Argument metaVar NAME usage Agent name or empty string for master required true multiValued true private List String nodes Option name m usage Record the reason about why you are disconnecting this node public String cause Override public String getShortDescription return Messages OfflineNodeCommand ShortDescription Override protected int run throws Exception boolean errorOccurred false final Jenkins jenkins Jenkins getInstance final HashSet String hs new HashSet String nodes List String names null for String node s hs try Computer computer jenkins getComputer node s if computer null if names null names ComputerSet getComputerNames String adv EditDistance findNearest node s names throw new IllegalArgumentException adv null hudson model Messages Computer NoSuchSlaveExistsWithoutAdvice node s hudson model Messages Computer NoSuchSlaveExists node s adv computer cliOffline cause catch Exception e if hs size 1 throw e stderr println node s e getMessage errorOccurred true continue if errorOccurred throw new AbortException CLI LISTPARAM SUMMARY ERROR TEXT return 0package com twitter sdk android core internal network import com twitter sdk android core GuestSessionProvider import com twitter sdk android core Session import com twitter sdk android core TwitterAuthConfig import com twitter sdk android core TwitterAuthToken import javax net ssl SSLSocketFactory import okhttp3 OkHttpClient public class OkHttpClientHelper public static OkHttpClient getOkHttpClient GuestSessionProvider guestSessionProvider SSLSocketFactory sslSocketFactory return getOkHttpClientBuilder guestSessionProvider sslSocketFactory build public static OkHttpClient Builder getOkHttpClientBuilder GuestSessionProvider guestSessionProvider SSLSocketFactory sslSocketFactory return new OkHttpClient Builder sslSocketFactory sslSocketFactory authenticator new GuestAuthenticator guestSessionProvider addInterceptor new GuestAuthInterceptor guestSessionProvider addNetworkInterceptor new GuestAuthNetworkInterceptor public static OkHttpClient getOkHttpClient Session extends TwitterAuthToken session TwitterAuthConfig authConfig SSLSocketFactory sslSocketFactory return getOkHttpClientBuilder session authConfig sslSocketFactory build public static OkHttpClient Builder getOkHttpClientBuilder Session extends TwitterAuthToken session TwitterAuthConfig authConfig SSLSocketFactory sslSocketFactory if session null throw new IllegalArgumentException Session must not be null return new OkHttpClient Builder sslSocketFactory sslSocketFactory addInterceptor new OAuth1aInterceptor session authConfigpackage hudson diagnosis import com google common base Predicate import com thoughtworks xstream converters UnmarshallingContext import hudson Extension import hudson XmlFile import hudson model AdministrativeMonitor import hudson model Item import hudson model Job import hudson model ManagementLink import hudson model Run import hudson model Saveable import hudson model listeners ItemListener import hudson model listeners RunListener import hudson model listeners SaveableListener import hudson security ACL import hudson util RobustReflectionConverter import hudson util VersionNumber import java io IOException import java util ArrayList import java util Collection import java util HashMap import java util Iterator import java util List import java util Map import java util TreeSet import java util concurrent ConcurrentHashMap import java util concurrent ConcurrentMap import java util logging Level import java util logging Logger import javax annotation CheckForNull import jenkins model Jenkins import org acegisecurity context SecurityContext import org acegisecurity context SecurityContextHolder import org jenkinsci Symbol import org kohsuke accmod Restricted import org kohsuke accmod restrictions NoExternalUse import org kohsuke stapler HttpRedirect import org kohsuke stapler HttpResponse import org kohsuke stapler HttpResponses import org kohsuke stapler StaplerRequest import org kohsuke stapler StaplerResponse import org kohsuke stapler interceptor RequirePOST Extension Symbol oldData public class OldDataMonitor extends AdministrativeMonitor private static final Logger LOGGER Logger getLogger OldDataMonitor class getName private ConcurrentMap SaveableReference VersionRange data new ConcurrentHashMap SaveableReference VersionRange static OldDataMonitor get Jenkins j return OldDataMonitor j getAdministrativeMonitor OldData public OldDataMonitor super OldData Override public String getDisplayName return Messages OldDataMonitor DisplayName public boolean isActivated return data isEmpty public Map Saveable VersionRange getData Map Saveable VersionRange r new HashMap Saveable VersionRange for Map Entry SaveableReference VersionRange entry this data entrySet Saveable s entry getKey get if s null r put s entry getValue return r private static void remove Saveable obj boolean isDelete Jenkins j Jenkins getInstance OldDataMonitor odm get j SecurityContext oldContext ACL impersonate ACL SYSTEM try odm data remove referTo obj if isDelete obj instanceof Job for Run r Job obj getBuilds odm data remove referTo r finally SecurityContextHolder setContext oldContext Listeners to remove data here if resaved or deleted in regular Hudson usage Extension public static final SaveableListener changeListener new SaveableListener Override public void onChange Saveable obj XmlFile file remove obj false Extension public static final ItemListener itemDeleteListener new ItemListener Override public void onDeleted Item item remove item true Extension public static final RunListener Run runDeleteListener new RunListener Run Override public void onDeleted Run run remove run true public static void report Saveable obj String version OldDataMonitor odm get Jenkins getInstance try SaveableReference ref referTo obj while true VersionRange vr odm data get ref if vr null odm data replace ref vr new VersionRange vr version null break else if odm data putIfAbsent ref new VersionRange null version null null break catch IllegalArgumentException ex LOGGER log Level WARNING Bad parameter given to OldDataMonitor ex public static void report UnmarshallingContext context String version RobustReflectionConverter addErrorInContext context new ReportException version private static class ReportException extends Exception private String version private ReportException String version this version version public static void report Saveable obj Collection Throwable errors StringBuilder buf new StringBuilder int i 0 for Throwable e errors if e instanceof ReportException report obj ReportException e version else if i 1 buf append buf append e getClass getSimpleName append append e getMessage if buf length 0 return Jenkins j Jenkins getInstanceOrNull if j null Need this path at least for unit tests but also in case of very broken startup Startup failed something is very broken so report what we can for Throwable t errors LOGGER log Level WARNING could not read obj and Jenkins did not start up t return OldDataMonitor odm get j SaveableReference ref referTo obj while true VersionRange vr odm data get ref if vr null odm data replace ref vr new VersionRange vr null buf toString break else if odm data putIfAbsent ref new VersionRange null null buf toString null break public static class VersionRange private static VersionNumber currentVersion Jenkins getVersion final VersionNumber min final VersionNumber max final boolean single final public String extra public VersionRange VersionRange previous String version String extra if previous null min max version null new VersionNumber version null this single true this extra extra else if version null min previous min max previous max single previous single this extra extra else VersionNumber ver new VersionNumber version if previous min null ver isOlderThan previous min this min ver else this min previous min if previous max null ver isNewerThan previous max this max ver else this max previous max this single this max isNewerThan this min this extra extra Override public String toString return min null min toString single max toString public boolean isOld int threshold return currentVersion null min null currentVersion digit 0 min digit 0 currentVersion digit 0 min digit 0 currentVersion digit 1 min digit 1 threshold Restricted NoExternalUse class public Iterator VersionNumber getVersionList TreeSet VersionNumber set new TreeSet VersionNumber for VersionRange vr data values if vr max null set add vr max return set iterator RequirePOST public HttpResponse doAct StaplerRequest req StaplerResponse rsp throws IOException if req hasParameter no disable true return HttpResponses redirectViaContextPath manage else return new HttpRedirect manage RequirePOST public HttpResponse doUpgrade StaplerRequest req StaplerResponse rsp final String thruVerParam req getParameter thruVer final VersionNumber thruVer thruVerParam equals all null new VersionNumber thruVerParam saveAndRemoveEntries new Predicate Map Entry SaveableReference VersionRange Override public boolean apply Map Entry SaveableReference VersionRange entry VersionNumber version entry getValue max return version null thruVer null version isNewerThan thruVer return HttpResponses forwardToPreviousPage RequirePOST public HttpResponse doDiscard StaplerRequest req StaplerResponse rsp saveAndRemoveEntries new Predicate Map Entry SaveableReference VersionRange Override public boolean apply Map Entry SaveableReference VersionRange entry return entry getValue max null return HttpResponses forwardToPreviousPage private void saveAndRemoveEntries Predicate Map Entry SaveableReference VersionRange matchingPredicate List SaveableReference removed new ArrayList SaveableReference for Map Entry SaveableReference VersionRange entry data entrySet if matchingPredicate apply entry Saveable s entry getKey get if s null try s save catch Exception x LOGGER log Level WARNING failed to save s x removed add entry getKey data keySet removeAll removed public HttpResponse doIndex StaplerResponse rsp throws IOException return new HttpRedirect manage private interface SaveableReference CheckForNull Saveable get must also define equals hashCode private static SaveableReference referTo Saveable s if s instanceof Run Job parent Run s getParent if Jenkins getInstance getItemByFullName parent getFullName parent return new RunSaveableReference Run s return new SimpleSaveableReference s private static final class SimpleSaveableReference implements SaveableReference private final Saveable instance SimpleSaveableReference Saveable instance this instance instance Override public Saveable get return instance Override public int hashCode return instance hashCode Override public boolean equals Object obj return obj instanceof SimpleSaveableReference instance equals SimpleSaveableReference obj instance could easily make an ItemSaveableReference but Jenkins holds all these strongly so why bother private static final class RunSaveableReference implements SaveableReference private final String id RunSaveableReference Run r id r getExternalizableId Override public Saveable get try return Run fromExternalizableId id catch IllegalArgumentException x Typically meaning the job or build was since deleted LOGGER log Level FINE null x return null Override public int hashCode return id hashCode Override public boolean equals Object obj return obj instanceof RunSaveableReference id equals RunSaveableReference obj id Extension Symbol oldData public static class ManagementLinkImpl extends ManagementLink Override public String getIconFileName return document png Override public String getUrlName return administrativeMonitor OldData Override public String getDescription return Messages OldDataMonitor Description public String getDisplayName return Messages OldDataMonitor DisplayNamepackage hudson model import hudson model Queue FlyweightTask public class OneOffExecutor extends Executor public OneOffExecutor Computer owner super owner 1package hudson util public final class OneShotEvent private boolean signaled private final Object lock public OneShotEvent this lock this public OneShotEvent Object lock this lock lock public void signal synchronized lock if signaled return this signaled true lock notifyAll public void block throws InterruptedException synchronized lock while signaled lock wait public void block long timeout throws InterruptedException synchronized lock if signaled lock wait timeout public boolean isSignaled synchronized lock return signaledpackage com kaku colorfulnews listener import android view View public interface OnItemClickListener void onItemClick View view int positionpackage hudson cli import hudson AbortException import hudson Extension import hudson model Computer import hudson model ComputerSet import hudson util EditDistance import jenkins model Jenkins import org kohsuke args4j Argument import java util HashSet import java util List Extension public class OnlineNodeCommand extends CLICommand Argument metaVar NAME usage Agent name or empty string for master required true multiValued true private List String nodes Override public String getShortDescription return Messages OnlineNodeCommand ShortDescription Override protected int run throws Exception boolean errorOccurred false final Jenkins jenkins Jenkins getActiveInstance final HashSet String hs new HashSet String nodes List String names null for String node s hs Computer computer null try computer jenkins getComputer node s if computer null if names null names ComputerSet getComputerNames String adv EditDistance findNearest node s names throw new IllegalArgumentException adv null hudson model Messages Computer NoSuchSlaveExistsWithoutAdvice node s hudson model Messages Computer NoSuchSlaveExists node s adv computer cliOnline catch Exception e if hs size 1 throw e final String errorMsg node s e getMessage stderr println errorMsg errorOccurred true continue if errorOccurred throw new AbortException CLI LISTPARAM SUMMARY ERROR TEXT return 0package jenkins util io public interface OnMaster TODO uncomment once we can have a delegating ClassFilter also add SystemProperty to toggle feature Extension Restricted NoExternalUse class class ChannelConfiguratorImpl extends ChannelConfigurator Override public void onChannelBuilding ChannelBuilder builder Nullable Object context if context instanceof SlaveComputer builder withClassFilter new ClassFilterImpl builder getClassFilter OnMaster class getName Restricted NoExternalUse class class ClassFilterImpl extends ClassFilter private final ClassFilter delegate private final Set String blacklist public ClassFilterImpl ClassFilter delegate String blacklist this blacklist new HashSet blacklist this delegate delegate Override protected boolean isBlacklisted String name return blacklist contains name delegate isBlacklisted name Override protected boolean isBlacklisted Class c return c getAnnotation MasterJVMOnly class null delegate isBlacklisted cpackage jenkins security s2m import jenkins ReflectiveFilePathFilter import java io File interface OpMatcher boolean matches String op OpMatcher ALL new OpMatcher Override public boolean matches String op return truepackage jenkins model import hudson model Job import hudson model JobProperty import hudson model JobPropertyDescriptor import net sf json JSONObject import org kohsuke stapler StaplerRequest public abstract class OptionalJobProperty J extends Job extends JobProperty J Override public OptionalJobPropertyDescriptor getDescriptor return OptionalJobPropertyDescriptor super getDescriptor public static abstract class OptionalJobPropertyDescriptor extends JobPropertyDescriptor protected OptionalJobPropertyDescriptor Class extends JobProperty clazz super clazz protected OptionalJobPropertyDescriptor Override public JobProperty newInstance StaplerRequest req JSONObject formData throws FormException return formData optBoolean specified super newInstance req formData nullpackage hudson cli declarative import org jvnet hudson annotation indexer Indexed import org kohsuke args4j spi OptionHandler import java lang annotation Documented import java lang annotation Retention import java lang annotation Target import static java lang annotation ElementType TYPE import static java lang annotation RetentionPolicy RUNTIME Indexed Retention RUNTIME Target TYPE Documented public interface OptionHandlerExtensionpackage hudson util jna import static com sun jna Library import com sun jna win32 W32APITypeMapper import com sun jna win32 W32APIFunctionMapper import java util Map import java util HashMap public interface Options Map String Object UNICODE OPTIONS new HashMap String Object put OPTION TYPE MAPPER W32APITypeMapper UNICODE put OPTION FUNCTION MAPPER W32APIFunctionMapper UNICODEpackage hudson model import hudson model MultiStageTimeSeries TimeScale import hudson model MultiStageTimeSeries TrendChart import hudson model queue SubTask import jenkins model Jenkins import org kohsuke accmod Restricted import org kohsuke accmod restrictions NoExternalUse import org kohsuke stapler export Exported public class OverallLoadStatistics extends LoadStatistics Exported Restricted NoExternalUse class Deprecated public final MultiStageTimeSeries totalQueueLength queueLength public OverallLoadStatistics super 0 0 Override public int computeIdleExecutors return new ComputerSet getIdleExecutors Override public int computeTotalExecutors return new ComputerSet getTotalExecutors Override public int computeQueueLength return Jenkins getInstance getQueue countBuildableItems Override protected Iterable Node getNodes return Jenkins getActiveInstance getNodes Override protected boolean matches Queue Item item SubTask subTask return true protected TrendChart createOverallTrendChart TimeScale timeScale return MultiStageTimeSeries createTrendChart timeScale busyExecutors onlineExecutors queueLength availableExecutorspackage hudson init import org jvnet hudson reactor Taskpackage hudson util import com thoughtworks xstream converters UnmarshallingContext import com thoughtworks xstream converters collections MapConverter import com thoughtworks xstream io HierarchicalStreamReader import com thoughtworks xstream mapper Mapper import java util AbstractList import java util AbstractMap import java util AbstractSet import java util Collection import java util HashMap import java util Iterator import java util LinkedHashMap import java util Map import java util Set import java util TreeMap SuppressWarnings unchecked public final class PackedMap K V extends AbstractMap K V private Object kvpairs public static K V PackedMap K V of Map extends K extends V src return new PackedMap K V src private PackedMap Map extends K extends V src kvpairs new Object src size 2 int i 0 for Entry extends K extends V e src entrySet kvpairs i e getKey kvpairs i e getValue private final Set Entry K V entrySet new AbstractSet Entry K V Override public Iterator Entry K V iterator return new Iterator Entry K V int index 0 public boolean hasNext return index kvpairs length SuppressWarnings unchecked public Entry K V next final K k K kvpairs index final V v V kvpairs index return new Entry K V public K getKey return k public V getValue return v public V setValue V value throw new UnsupportedOperationException public void remove throw new UnsupportedOperationException Override public int size return kvpairs length 2 Override public Set Entry K V entrySet return entrySet Override public boolean containsKey Object key for int i 0 i kvpairs length i 2 if key equals kvpairs i return true return false Override public V get Object key for int i 0 i kvpairs length i 2 if key equals kvpairs i return V kvpairs i 1 return null Override public Collection V values return new AbstractList V Override public V get int index return V kvpairs index 2 Override public int size return PackedMap this size public static class ConverterImpl extends MapConverter public ConverterImpl Mapper mapper super mapper Override public boolean canConvert Class type return type PackedMap class Override protected Object createCollection Class type return new LinkedHashMap String String Override public Object unmarshal HierarchicalStreamReader reader UnmarshallingContext context return PackedMap of Map super unmarshal reader contextpackage hudson model import hudson ExtensionPoint import hudson Extension import hudson ExtensionList import hudson util DescriptorList import jenkins model Jenkins import java util List public abstract class PageDecorator extends Descriptor PageDecorator implements ExtensionPoint Describable PageDecorator Deprecated protected PageDecorator Class extends PageDecorator yourClass super yourClass protected PageDecorator super self this will never work because Descriptor and Describable are the same thing protected PageDecorator public final Descriptor PageDecorator getDescriptor return this public final String getUrl return descriptor clazz getName Deprecated public static final List PageDecorator ALL List new DescriptorList PageDecorator PageDecorator class public static ExtensionList PageDecorator all return Jenkins getInstance PageDecorator PageDecorator getDescriptorList PageDecorator classpackage hudson model import static java lang String format import hudson Extension import hudson util PersistedList import java io IOException import javax servlet http HttpSession import org jenkinsci Symbol import org kohsuke stapler Stapler public class PaneStatusProperties extends UserProperty implements Saveable private final PersistedList String collapsed new PersistedList String this private static final PaneStatusProperties FALLBACK new PaneStatusPropertiesSessionFallback public boolean isCollapsed String paneId return collapsed contains paneId public boolean toggleCollapsed String paneId throws IOException if collapsed contains paneId collapsed remove paneId return false else collapsed add paneId return true public void save throws IOException user save private Object readResolve collapsed setOwner this return this Extension Symbol paneStatus public static class DescriptorImpl extends UserPropertyDescriptor Override public UserProperty newInstance User user return new PaneStatusProperties Override public boolean isEnabled return false private static class PaneStatusPropertiesSessionFallback extends PaneStatusProperties private final String attribute jenkins pane s collapsed Override public boolean isCollapsed String paneId final HttpSession session Stapler getCurrentRequest getSession return session getAttribute format attribute paneId null Override public boolean toggleCollapsed String paneId final HttpSession session Stapler getCurrentRequest getSession final String property format attribute paneId final Object collapsed session getAttribute property if collapsed null session setAttribute property true return true session removeAttribute property return false public static PaneStatusProperties forCurrentUser final User current User current if current null return FALLBACK return current getProperty PaneStatusProperties classpackage hudson model import hudson DescriptorExtensionList import hudson Extension import hudson ExtensionPoint import hudson AbortException import hudson cli CLICommand import hudson util DescriptorList import java io Serializable import java io IOException import java util logging Logger import javax annotation CheckForNull import jenkins model Jenkins import net sf json JSONObject import org kohsuke stapler StaplerRequest import org kohsuke stapler export Exported import org kohsuke stapler export ExportedBean ExportedBean defaultVisibility 3 public abstract class ParameterDefinition implements Describable ParameterDefinition ExtensionPoint Serializable private final String name private final String description public ParameterDefinition String name this name null public ParameterDefinition String name String description this name name this description description public ParameterDefinition copyWithDefaultValue ParameterValue defaultValue By default just return this again return this Exported public String getType return this getClass getSimpleName Exported public String getName return name Exported public String getDescription return description public String getFormattedDescription try return Jenkins getInstance getMarkupFormatter translate description catch IOException e LOGGER warning failed to translate description using configured markup formatter return Override public ParameterDescriptor getDescriptor return ParameterDescriptor Jenkins getInstance getDescriptorOrDie getClass CheckForNull public abstract ParameterValue createValue StaplerRequest req JSONObject jo CheckForNull public abstract ParameterValue createValue StaplerRequest req CheckForNull public ParameterValue createValue CLICommand command String value throws IOException InterruptedException throw new AbortException CLI parameter submission is not supported for the getClass type Please file a bug report for this CheckForNull Exported public ParameterValue getDefaultParameterValue return null public static DescriptorExtensionList ParameterDefinition ParameterDescriptor all return Jenkins getInstance ParameterDefinition ParameterDescriptor getDescriptorList ParameterDefinition class Deprecated public static final DescriptorList ParameterDefinition LIST new DescriptorList ParameterDefinition ParameterDefinition class public abstract static class ParameterDescriptor extends Descriptor ParameterDefinition protected ParameterDescriptor Class extends ParameterDefinition klazz super klazz protected ParameterDescriptor public String getValuePage return getViewPage clazz index jelly Override public String getDisplayName return Parameter private static final Logger LOGGER Logger getLogger ParameterDefinition class getNamepackage jenkins model import hudson Util import hudson model Action import hudson model BuildableItem import hudson model Cause import hudson model CauseAction import hudson model Item import hudson model Job import hudson model ParameterDefinition import hudson model ParameterValue import hudson model ParametersAction import hudson model ParametersDefinitionProperty import hudson model Queue import hudson model Run import hudson model queue QueueTaskFuture import hudson search SearchIndexBuilder import hudson triggers Trigger import hudson triggers TriggerDescriptor import hudson util AlternativeUiTextProvider import hudson views BuildButtonColumn import java io IOException import java util ArrayList import java util Arrays import java util Collections import java util List import java util Map import javax annotation CheckForNull import javax servlet ServletException import static javax servlet http HttpServletResponse SC CREATED import static javax servlet http HttpServletResponse SC CONFLICT import jenkins util TimeDuration import org kohsuke accmod Restricted import org kohsuke accmod restrictions NoExternalUse import org kohsuke stapler HttpResponses import org kohsuke stapler QueryParameter import org kohsuke stapler StaplerRequest import org kohsuke stapler StaplerResponse import org kohsuke stapler interceptor RequirePOST SuppressWarnings unchecked AbstractItem getParent does not correctly override scheduleBuild2 inherently untypable public abstract class ParameterizedJobMixIn JobT extends Job JobT RunT ParameterizedJobMixIn ParameterizedJob Queue Task RunT extends Run JobT RunT Queue Executable protected abstract JobT asJob SuppressWarnings deprecation public final boolean scheduleBuild return scheduleBuild asJob getQuietPeriod new Cause LegacyCodeCause public final boolean scheduleBuild Cause c return scheduleBuild asJob getQuietPeriod c SuppressWarnings deprecation public final boolean scheduleBuild int quietPeriod return scheduleBuild quietPeriod new Cause LegacyCodeCause public final boolean scheduleBuild int quietPeriod Cause c return scheduleBuild2 quietPeriod c null Collections Action singletonList new CauseAction c Collections Action emptyList null public final CheckForNull QueueTaskFuture RunT scheduleBuild2 int quietPeriod Action actions Queue Item i scheduleBuild2 quietPeriod Arrays asList actions return i null QueueTaskFuture i getFuture null public static CheckForNull Queue Item scheduleBuild2 final Job job int quietPeriod Action actions if job instanceof ParameterizedJob return null return new ParameterizedJobMixIn Override protected Job asJob return job scheduleBuild2 quietPeriod 1 ParameterizedJob job getQuietPeriod quietPeriod Arrays asList actions CheckForNull Queue Item scheduleBuild2 int quietPeriod List Action actions if asJob isBuildable return null List Action queueActions new ArrayList Action actions if isParameterized Util filter queueActions ParametersAction class isEmpty queueActions add new ParametersAction getDefaultParametersValues return Jenkins getInstance getQueue schedule2 asJob quietPeriod queueActions getItem private List ParameterValue getDefaultParametersValues ParametersDefinitionProperty paramDefProp asJob getProperty ParametersDefinitionProperty class ArrayList ParameterValue defValues new ArrayList ParameterValue if paramDefProp null return defValues for ParameterDefinition paramDefinition paramDefProp getParameterDefinitions ParameterValue defaultValue paramDefinition getDefaultParameterValue if defaultValue null defValues add defaultValue return defValues public final boolean isParameterized return asJob getProperty ParametersDefinitionProperty class null SuppressWarnings deprecation public final void doBuild StaplerRequest req StaplerResponse rsp QueryParameter TimeDuration delay throws IOException ServletException if delay null delay new TimeDuration asJob getQuietPeriod if asJob isBuildable throw HttpResponses error SC CONFLICT new IOException asJob getFullName is not buildable if a build is parameterized let that take over ParametersDefinitionProperty pp asJob getProperty ParametersDefinitionProperty class if pp null req getMethod equals POST show the parameter entry form req getView pp index jelly forward req rsp return hudson model BuildAuthorizationToken checkPermission asJob asJob getAuthToken req rsp if pp null pp doBuild req rsp delay return Queue Item item Jenkins getInstance getQueue schedule2 asJob delay getTime getBuildCause asJob req getItem if item null rsp sendRedirect SC CREATED req getContextPath item getUrl else rsp sendRedirect SuppressWarnings deprecation public final void doBuildWithParameters StaplerRequest req StaplerResponse rsp QueryParameter TimeDuration delay throws IOException ServletException hudson model BuildAuthorizationToken checkPermission asJob asJob getAuthToken req rsp ParametersDefinitionProperty pp asJob getProperty ParametersDefinitionProperty class if asJob isBuildable throw HttpResponses error SC CONFLICT new IOException asJob getFullName is not buildable if pp null pp buildWithParameters req rsp delay else throw new IllegalStateException This build is not parameterized RequirePOST public final void doCancelQueue StaplerRequest req StaplerResponse rsp throws IOException ServletException asJob checkPermission Item CANCEL Jenkins getInstance getQueue cancel asJob rsp forwardToPreviousPage req public final SearchIndexBuilder extendSearchIndex SearchIndexBuilder sib if asJob isBuildable asJob hasPermission Item BUILD sib add build build return sib Restricted NoExternalUse class public static final CauseAction getBuildCause ParameterizedJob job StaplerRequest req Cause cause SuppressWarnings deprecation hudson model BuildAuthorizationToken authToken job getAuthToken if authToken null authToken getToken null req getParameter token null Optional additional cause text when starting via token String causeText req getParameter cause cause new Cause RemoteCause req getRemoteAddr causeText else cause new Cause UserIdCause return new CauseAction cause public static final AlternativeUiTextProvider Message ParameterizedJob BUILD NOW TEXT new AlternativeUiTextProvider Message ParameterizedJob public final String getBuildNowText return isParameterized Messages ParameterizedJobMixIn build with parameters AlternativeUiTextProvider get BUILD NOW TEXT asJob Messages ParameterizedJobMixIn build now public static CheckForNull T extends Trigger T getTrigger Job job Class T clazz if job instanceof ParameterizedJob return null for Trigger t ParameterizedJob job getTriggers values if clazz isInstance t return clazz cast t return null public interface ParameterizedJob extends hudson model Queue Task hudson model Item SuppressWarnings deprecation CheckForNull hudson model BuildAuthorizationToken getAuthToken int getQuietPeriod String getBuildNowText Map TriggerDescriptor Trigger getTriggerspackage hudson model import hudson Util import hudson EnvVars import hudson diagnosis OldDataMonitor import hudson model Queue QueueAction import hudson model labels LabelAssignmentAction import hudson model queue SubTask import hudson tasks BuildStep import hudson tasks BuildWrapper import hudson util VariableResolver import jenkins model RunAction2 import org kohsuke accmod Restricted import org kohsuke accmod restrictions NoExternalUse import org kohsuke stapler export Exported import org kohsuke stapler export ExportedBean import java util ArrayList import java util Arrays import java util Collection import java util Collections import java util HashSet import java util Iterator import java util List import java util Set import java util TreeSet import java util logging Level import java util logging Logger import com google common collect Lists import static com google common collect Sets newHashSet import javax annotation CheckForNull import javax annotation Nonnull import jenkins util SystemProperties ExportedBean public class ParametersAction implements RunAction2 Iterable ParameterValue QueueAction EnvironmentContributingAction LabelAssignmentAction Restricted NoExternalUse class public static final String KEEP UNDEFINED PARAMETERS SYSTEM PROPERTY NAME ParametersAction class getName keepUndefinedParameters Restricted NoExternalUse class public static final String SAFE PARAMETERS SYSTEM PROPERTY NAME ParametersAction class getName safeParameters private Set String safeParameters private final List ParameterValue parameters private List String parameterDefinitionNames Deprecated private transient AbstractBuild build private transient Run run public ParametersAction List ParameterValue parameters this parameters parameters String paramNames SystemProperties getString SAFE PARAMETERS SYSTEM PROPERTY NAME safeParameters new TreeSet if paramNames null safeParameters addAll Arrays asList paramNames split public ParametersAction List ParameterValue parameters Collection String additionalSafeParameters this parameters if additionalSafeParameters null safeParameters addAll additionalSafeParameters public ParametersAction ParameterValue parameters this Arrays asList parameters public void createBuildWrappers AbstractBuild build Collection super BuildWrapper result for ParameterValue p getParameters if p null continue BuildWrapper w p createBuildWrapper build if w null result add w public void buildEnvVars AbstractBuild build EnvVars env for ParameterValue p getParameters if p null continue p buildEnvironment build env TODO do we need an EnvironmentContributingAction variant that takes Run so this can implement it public String substitute AbstractBuild build String text return Util replaceMacro text createVariableResolver build public VariableResolver String createVariableResolver AbstractBuild build VariableResolver resolvers new VariableResolver getParameters size 1 int i 0 for ParameterValue p getParameters if p null continue resolvers i p createVariableResolver build resolvers i build getBuildVariableResolver return new VariableResolver Union String resolvers public Iterator ParameterValue iterator return getParameters iterator Exported visibility 2 public List ParameterValue getParameters return Collections ParameterValue unmodifiableList filter parameters public ParameterValue getParameter String name for ParameterValue p parameters if p null continue if p getName equals name return p return null public Label getAssignedLabel SubTask task for ParameterValue p getParameters if p null continue Label l p getAssignedLabel task if l null return l return null public String getDisplayName return Messages ParameterAction DisplayName public String getIconFileName return document properties png public String getUrlName return parameters public boolean shouldSchedule List Action actions List ParametersAction others Util filter actions ParametersAction class if others isEmpty return parameters isEmpty else I don t think we need multiple ParametersActions but let s be defensive Set ParameterValue params new HashSet ParameterValue for ParametersAction other others params addAll other parameters return params equals new HashSet ParameterValue this parameters Nonnull public ParametersAction createUpdated Collection extends ParameterValue overrides if overrides null ParametersAction parametersAction new ParametersAction parameters parametersAction safeParameters this safeParameters return parametersAction List ParameterValue combinedParameters Lists ParameterValue newArrayList overrides Set String names newHashSet for ParameterValue v overrides if v null continue names add v getName for ParameterValue v parameters if v null continue if names contains v getName combinedParameters add v return new ParametersAction combinedParameters this safeParameters Nonnull public ParametersAction merge CheckForNull ParametersAction overrides if overrides null ParametersAction parametersAction new ParametersAction parameters this safeParameters return parametersAction ParametersAction parametersAction createUpdated overrides parameters Set String safe new TreeSet if parametersAction safeParameters null this safeParameters null safe addAll this safeParameters if overrides safeParameters null safe addAll overrides safeParameters parametersAction safeParameters safe return parametersAction private Object readResolve if build null OldDataMonitor report build 1 283 if safeParameters null safeParameters Collections emptySet return this Override public void onAttached Run r ParametersDefinitionProperty p r getParent getProperty ParametersDefinitionProperty class if p null this parameterDefinitionNames p getParameterDefinitionNames else this parameterDefinitionNames Collections emptyList this run r Override public void onLoad Run r this run r private List extends ParameterValue filter List ParameterValue parameters if this run null return parameters if this parameterDefinitionNames null return parameters if SystemProperties getBoolean KEEP UNDEFINED PARAMETERS SYSTEM PROPERTY NAME return parameters List ParameterValue filteredParameters new ArrayList ParameterValue for ParameterValue v this parameters if this parameterDefinitionNames contains v getName isSafeParameter v getName filteredParameters add v else LOGGER log Level WARNING Skipped parameter 0 as it is undefined on 1 Set D 2 true to allow undefined parameters to be injected as environment variables or D 3 comma separated list to whitelist specific parameter names even though it represents a security breach new Object v getName run getParent getFullName KEEP UNDEFINED PARAMETERS SYSTEM PROPERTY NAME SAFE PARAMETERS SYSTEM PROPERTY NAME return filteredParameters public List ParameterValue getAllParameters return Collections unmodifiableList parameters private boolean isSafeParameter String name return safeParameters contains name private static final Logger LOGGER Logger getLogger ParametersAction class getNamepackage hudson model import hudson Extension import hudson Util import hudson model Queue WaitingItem import java io IOException import java util AbstractList import java util ArrayList import java util Arrays import java util Collection import java util Collections import java util List import javax annotation CheckForNull import javax annotation Nonnull import javax servlet ServletException import static javax servlet http HttpServletResponse SC CREATED import jenkins model Jenkins import jenkins model OptionalJobProperty import jenkins model ParameterizedJobMixIn import jenkins util TimeDuration import net sf json JSONArray import net sf json JSONObject import org jenkinsci Symbol import org kohsuke accmod Restricted import org kohsuke accmod restrictions NoExternalUse import org kohsuke stapler DataBoundConstructor import org kohsuke stapler QueryParameter import org kohsuke stapler StaplerRequest import org kohsuke stapler StaplerResponse import org kohsuke stapler export Exported import org kohsuke stapler export ExportedBean ExportedBean defaultVisibility 2 public class ParametersDefinitionProperty extends OptionalJobProperty Job implements Action private final List ParameterDefinition parameterDefinitions DataBoundConstructor public ParametersDefinitionProperty Nonnull List ParameterDefinition parameterDefinitions if parameterDefinitions null throw new NullPointerException ParameterDefinitions is null when this is a not valid value this parameterDefinitions parameterDefinitions public ParametersDefinitionProperty Nonnull ParameterDefinition parameterDefinitions if parameterDefinitions null throw new NullPointerException ParameterDefinitions is null when this is a not valid value this parameterDefinitions Arrays asList parameterDefinitions private Object readResolve return parameterDefinitions null new ParametersDefinitionProperty this Deprecated public AbstractProject getOwner return AbstractProject owner Restricted NoExternalUse class Jelly public ParameterizedJobMixIn ParameterizedJob getJob return ParameterizedJobMixIn ParameterizedJob owner Exported public List ParameterDefinition getParameterDefinitions return parameterDefinitions public List String getParameterDefinitionNames return new AbstractList String public String get int index return parameterDefinitions get index getName public int size return parameterDefinitions size Nonnull Override public Collection Action getJobActions Job job return Collections Action singleton this Deprecated public Collection Action getJobActions AbstractProject job return getJobActions Job job Deprecated public AbstractProject getProject return AbstractProject owner Deprecated public void doBuild StaplerRequest req StaplerResponse rsp throws IOException ServletException doBuild req rsp TimeDuration fromString req getParameter delay public void doBuild StaplerRequest req StaplerResponse rsp QueryParameter TimeDuration delay throws IOException ServletException if delay null delay new TimeDuration getJob getQuietPeriod List ParameterValue values new ArrayList ParameterValue JSONObject formData req getSubmittedForm JSONArray a JSONArray fromObject formData get parameter for Object o a JSONObject jo JSONObject o String name jo getString name ParameterDefinition d getParameterDefinition name if d null throw new IllegalArgumentException No such parameter definition name ParameterValue parameterValue d createValue req jo if parameterValue null values add parameterValue else throw new IllegalArgumentException Cannot retrieve the parameter value name WaitingItem item Jenkins getInstance getQueue schedule getJob delay getTime new ParametersAction values new CauseAction new Cause UserIdCause if item null String url formData optString redirectTo if url null Util isSafeToRedirectTo url avoid open redirect url req getContextPath item getUrl rsp sendRedirect formData optInt statusCode SC CREATED url else send the user back to the job top page rsp sendRedirect Deprecated public void buildWithParameters StaplerRequest req StaplerResponse rsp throws IOException ServletException buildWithParameters req rsp TimeDuration fromString req getParameter delay public void buildWithParameters StaplerRequest req StaplerResponse rsp CheckForNull TimeDuration delay throws IOException ServletException List ParameterValue values new ArrayList ParameterValue for ParameterDefinition d parameterDefinitions ParameterValue value d createValue req if value null values add value if delay null delay new TimeDuration getJob getQuietPeriod Queue Item item Jenkins getInstance getQueue schedule2 getJob delay getTime new ParametersAction values ParameterizedJobMixIn getBuildCause getJob req getItem if item null rsp sendRedirect SC CREATED req getContextPath item getUrl else rsp sendRedirect public ParameterDefinition getParameterDefinition String name for ParameterDefinition pd parameterDefinitions if pd getName equals name return pd return null Extension Symbol parameters public static class DescriptorImpl extends OptionalJobPropertyDescriptor Override public boolean isApplicable Class extends Job jobType return ParameterizedJobMixIn ParameterizedJob class isAssignableFrom jobType Override public String getDisplayName return Messages ParametersDefinitionProperty DisplayName public String getDisplayName return null public String getIconFileName return null public String getUrlName return nullpackage hudson model import hudson EnvVars import hudson Util import hudson model queue SubTask import hudson scm SCM import hudson tasks BuildWrapper import hudson tasks Builder import hudson util VariableResolver import java io Serializable import java util Map import net sf json JSONObject import org kohsuke stapler StaplerRequest import org kohsuke stapler export Exported import org kohsuke stapler export ExportedBean ExportedBean defaultVisibility 3 public abstract class ParameterValue implements Serializable protected final String name private String description protected ParameterValue String name String description this name name this description description protected ParameterValue String name this name null public String getDescription return description public void setDescription String description this description description Exported public final String getName return name Deprecated public void buildEnvVars AbstractBuild build Map String String env if env instanceof EnvVars if Util isOverridden ParameterValue class getClass buildEnvironment Run class EnvVars class if the subtype already derives buildEnvironment then delegate to it buildEnvironment build EnvVars env else if Util isOverridden ParameterValue class getClass buildEnvVars AbstractBuild class EnvVars class buildEnvVars build EnvVars env otherwise no op by default Deprecated public void buildEnvVars AbstractBuild build EnvVars env if Util isOverridden ParameterValue class getClass buildEnvironment Run class EnvVars class buildEnvironment build env else for backward compatibility buildEnvVars build Map String String env public void buildEnvironment Run build EnvVars env if build instanceof AbstractBuild buildEnvVars AbstractBuild build env else do not know how to do it public BuildWrapper createBuildWrapper AbstractBuild build return null public VariableResolver String createVariableResolver AbstractBuild build return VariableResolver NONE TODO should there be a Run overload of this Deprecated public ParameterDefinition getDefinition throw new UnsupportedOperationException Override public int hashCode final int prime 31 int result 1 result prime result name null 0 name hashCode return result Override public boolean equals Object obj if this obj return true if obj null return false if getClass obj getClass return false ParameterValue other ParameterValue obj if name null if other name null return false else if name equals other name return false return true public String getShortDescription return toString public boolean isSensitive return false public Object getValue return null public Label getAssignedLabel SubTask task return nullpackage hudson search import java lang reflect Field import java lang reflect Method import java lang reflect InvocationTargetException import java util ArrayList import java util List import java util Map import java util HashMap import java beans Introspector final class ParsedQuickSilver private static final Map Class ParsedQuickSilver TABLE new HashMap Class ParsedQuickSilver synchronized static ParsedQuickSilver get Class extends SearchableModelObject clazz ParsedQuickSilver pqs TABLE get clazz if pqs null TABLE put clazz pqs new ParsedQuickSilver clazz return pqs private final List Getter getters new ArrayList Getter private ParsedQuickSilver Class extends SearchableModelObject clazz QuickSilver qs for Method m clazz getMethods qs m getAnnotation QuickSilver class if qs null String url stripGetPrefix m if qs value length 0 getters add new MethodGetter url splitName url m else for String name qs value getters add new MethodGetter url name m for Field f clazz getFields qs f getAnnotation QuickSilver class if qs null if qs value length 0 getters add new FieldGetter f getName splitName f getName f else for String name qs value getters add new FieldGetter f getName name f private String splitName String url StringBuilder buf new StringBuilder url length 5 for String token url split a z A Z if buf length 0 buf append buf append Introspector decapitalize token return buf toString private String stripGetPrefix Method m String n m getName if n startsWith get n Introspector decapitalize n substring 3 return n static abstract class Getter final String url final String searchName protected Getter String url String searchName this url url this searchName searchName abstract Object get Object obj static final class MethodGetter extends Getter private final Method method public MethodGetter String url String searchName Method method super url searchName this method method Object get Object obj try return method invoke obj catch IllegalAccessException e throw toError e catch InvocationTargetException e Throwable x e getTargetException if x instanceof Error throw Error x if x instanceof RuntimeException throw RuntimeException x throw new Error e static final class FieldGetter extends Getter private final Field field public FieldGetter String url String searchName Field field super url searchName this field field Object get Object obj try return field get obj catch IllegalAccessException e throw toError e private static IllegalAccessError toError IllegalAccessException e IllegalAccessError iae new IllegalAccessError iae initCause e return iae public void addTo SearchIndexBuilder builder final Object instance for final Getter getter getters builder add new SearchItem public String getSearchName return getter searchName public String getSearchUrl return getter url public SearchIndex getSearchIndex Object child getter get instance if child null return SearchIndex EMPTY return SearchableModelObject child getSearchIndexpackage hudson util io import hudson ExtensionList import hudson ExtensionPoint import hudson remoting Channel import jenkins model Jenkins import jenkins security SlaveToMasterCallable import org dom4j io SAXReader import java io IOException import java io Serializable import java util ArrayList import java util Collection import java util Collections public abstract class ParserConfigurator implements ExtensionPoint Serializable private static final long serialVersionUID 2523542286453177108L public void configure SAXReader reader Object context public static ExtensionList ParserConfigurator all return ExtensionList lookup ParserConfigurator class public static void applyConfiguration SAXReader reader Object context throws IOException InterruptedException Collection ParserConfigurator all Collections emptyList if Jenkins getInstanceOrNull null Channel ch Channel current if ch null all ch call new SlaveToMasterCallable Collection ParserConfigurator IOException private static final long serialVersionUID 2178106894481500733L public Collection ParserConfigurator call throws IOException return new ArrayList ParserConfigurator all else all all for ParserConfigurator pc all pc configure reader contextpackage hudson model import net sf json JSONObject import org jenkinsci Symbol import org kohsuke stapler StaplerRequest import org kohsuke stapler DataBoundConstructor import hudson Extension import hudson util Secret import org kohsuke accmod Restricted import org kohsuke accmod restrictions DoNotUse import org kohsuke accmod restrictions NoExternalUse public class PasswordParameterDefinition extends SimpleParameterDefinition Restricted NoExternalUse class public static final String DEFAULT VALUE DEFAULT private Secret defaultValue DataBoundConstructor public PasswordParameterDefinition String name String defaultValue String description super name description this defaultValue Secret fromString defaultValue Override public ParameterDefinition copyWithDefaultValue ParameterValue defaultValue if defaultValue instanceof PasswordParameterValue PasswordParameterValue value PasswordParameterValue defaultValue return new PasswordParameterDefinition getName Secret toString value getValue getDescription else return this Override public ParameterValue createValue String value return new PasswordParameterValue getName value getDescription Override public PasswordParameterValue createValue StaplerRequest req JSONObject jo PasswordParameterValue value req bindJSON PasswordParameterValue class jo if value getValue getPlainText equals DEFAULT VALUE value new PasswordParameterValue getName getDefaultValue value setDescription getDescription return value Override public ParameterValue getDefaultParameterValue return new PasswordParameterValue getName getDefaultValue getDescription public String getDefaultValue return Secret toString defaultValue Restricted DoNotUse class used from Jelly public Secret getDefaultValueAsSecret return defaultValue kept for backward compatibility public void setDefaultValue String defaultValue this defaultValue Secret fromString defaultValue Extension Symbol password nonStoredPasswordParam public final static class ParameterDescriptorImpl extends ParameterDescriptor Override public String getDisplayName return Messages PasswordParameterDefinition DisplayName Override public String getHelpFile return help parameter string htmlpackage hudson model import hudson EnvVars import hudson util Secret import hudson util VariableResolver import org kohsuke stapler DataBoundConstructor import java util Locale import javax annotation Nonnull public class PasswordParameterValue extends ParameterValue Nonnull private final Secret value kept for backward compatibility public PasswordParameterValue String name String value this name value null DataBoundConstructor public PasswordParameterValue String name String value String description super name description this value Secret fromString value Override public void buildEnvironment Run build EnvVars env String v Secret toString value env put name v env put name toUpperCase Locale ENGLISH v backward compatibility pre 1 345 Override public VariableResolver String createVariableResolver AbstractBuild build return new VariableResolver String public String resolve String name return PasswordParameterValue this name equals name Secret toString value null Override public boolean isSensitive return true Nonnull public Secret getValue return value Override public String getShortDescription return nameimport java util Date import org apache axis client Call import org apache axis client Stub import com adyen services common Amount import com adyen services common Installments import com adyen services payment AnyType2AnyTypeMapEntry import com adyen services payment Card import com adyen services payment PaymentLocator import com adyen services payment PaymentPortType import com adyen services payment PaymentRequest import com adyen services payment PaymentResult import com adyen services payment Recurring public class Payment public static void main String args try PaymentPortType ws new PaymentLocator getPaymentHttpPort new java net URL Credentials test address Basic HTTP Authentication Stub ws setProperty Call USERNAME PROPERTY Credentials ws user Stub ws setProperty Call PASSWORD PROPERTY Credentials pwd user Payment data PaymentRequest request new PaymentRequest request setMerchantAccount Credentials merchant account request setAmount new Amount GBP 199 request setReference Payment Test 1 request setInstallments new Installments short 2 request setShopperEmail shopperemail server com request setShopperReference shopperreference request setFraudOffset 100 Card card new Card card setHolderName John Smith card setCvc 737 card setExpiryMonth 06 card setExpiryYear 2016 card setNumber 4111111111111111 request setCard card PaymentResult result ws authorise request System out println new Date System out println result getPspReference System out println result getResultCode System out println result getAuthCode System out println result getRefusalReason catch Exception ex ex printStackTracepackage jenkins model import com google common base Predicate import hudson Extension import hudson Util import hudson model Job import hudson model PermalinkProjectAction Permalink import hudson model Run import hudson model TaskListener import hudson model listeners RunListener import hudson util AtomicFileWriter import hudson util StreamTaskListener import java io File import java io IOException import java io StringWriter import java util Arrays import java util HashMap import java util Map import java util logging Level import java util logging Logger import javax annotation Nonnull import javax annotation Nullable import org apache commons io FileUtils public abstract class PeepholePermalink extends Permalink implements Predicate Run static final Map File String symlinks new HashMap File String public abstract boolean apply Run run protected File getPermalinkFile Job job return new File job getBuildDir getId Override public Run resolve Job job File f getPermalinkFile job Run b null try String target readSymlink f if target null int n Integer parseInt Util getFileName target if n RESOLVES TO NONE return null b job getBuildByNumber n if b null apply b return b found it in the most efficient way possible the cache is stale start the search if b null b job getNearestOldBuild n catch InterruptedException e LOGGER log Level WARNING Failed to read permalink cache f e if we fail to read the cache fall back to the re computation catch NumberFormatException e LOGGER log Level WARNING Failed to parse the build number in the permalink cache f e if we fail to read the cache fall back to the re computation catch IOException e this happens when the symlink doesn t exist and it cannot be distinguished from the case when the actual I O error happened if b null no cache b job getLastBuild start from the build b and locate the build that matches the criteria going back in time b find b updateCache job b return b private Run find Run b for b null apply b b b getPreviousBuild return b protected void updateCache Nonnull Job job Nullable Run b final int n b null RESOLVES TO NONE b getNumber File cache getPermalinkFile job cache getParentFile mkdirs try String target String valueOf n if b null new File job getBuildDir target exists re create the build Number Id symlink Util createSymlink job getBuildDir b getId target TaskListener NULL writeSymlink cache target catch IOException e LOGGER log Level WARNING Failed to update job getId permalink for b e cache delete catch InterruptedException e LOGGER log Level WARNING Failed to update job getId permalink for b e cache delete File exists returns false for a link with a missing target so for Java 6 compatibility we have to use this circuitous method to see if it was created private static boolean exists File link File kids link getParentFile listFiles return kids null Arrays asList kids contains link static String readSymlink File cache throws IOException InterruptedException synchronized symlinks String target symlinks get cache if target null LOGGER log Level FINE readSymlink cached 0 1 new Object cache target return target String target Util resolveSymlink cache if target null cache exists if this file isn t a symlink it must be a regular file target FileUtils readFileToString cache UTF 8 trim LOGGER log Level FINE readSymlink 0 1 new Object cache target synchronized symlinks symlinks put cache target return target static void writeSymlink File cache String target throws IOException InterruptedException LOGGER log Level FINE writeSymlink 0 1 new Object cache target synchronized symlinks symlinks put cache target StringWriter w new StringWriter StreamTaskListener listener new StreamTaskListener w Util createSymlink cache getParentFile target cache getName listener Avoid calling resolveSymlink on a nonexistent file as it will probably throw an IOException if exists cache Util resolveSymlink cache null symlink not supported use a regular file AtomicFileWriter cw new AtomicFileWriter cache try cw write target cw commit finally cw abort Extension public static class RunListenerImpl extends RunListener Run Override public void onDeleted Run run Job j run getParent for PeepholePermalink pp Util filter j getPermalinks PeepholePermalink class if pp resolve j run Run r pp find run getPreviousBuild if LOGGER isLoggable Level FINE LOGGER fine Updating pp getPermalinkFile j getName permalink from deleted run getNumber to r null 1 r getNumber pp updateCache j r Override public void onCompleted Run run Nonnull TaskListener listener Job j run getParent for PeepholePermalink pp Util filter j getPermalinks PeepholePermalink class if pp apply run Run cur pp resolve j if cur null cur getNumber run getNumber if LOGGER isLoggable Level FINE LOGGER fine Updating pp getPermalinkFile j getName permalink to completed run getNumber pp updateCache j run private static final int RESOLVES TO NONE 1 private static final Logger LOGGER Logger getLogger PeepholePermalink class getNamepackage com kaku colorfulnews di scope import java lang annotation Documented import java lang annotation Retention import java lang annotation RetentionPolicy import javax inject Scope Scope Documented Retention RetentionPolicy RUNTIME public interface PerActivitypackage com kaku colorfulnews di scope import java lang annotation Documented import java lang annotation Retention import java lang annotation RetentionPolicy import javax inject Scope Scope Documented Retention RetentionPolicy RUNTIME public interface PerApppackage com kaku colorfulnews di scope import java lang annotation Documented import java lang annotation Retention import java lang annotation RetentionPolicy import javax inject Scope Scope Documented Retention RetentionPolicy RUNTIME public interface PerFragmentpackage hudson model import hudson init Initializer import hudson triggers SafeTimerTask import hudson ExtensionPoint import hudson Extension import hudson ExtensionList import jenkins util Timer import java util concurrent TimeUnit import java util logging Logger import java util Random import static hudson init InitMilestone JOB LOADED public abstract class PeriodicWork extends SafeTimerTask implements ExtensionPoint SuppressWarnings NonConstantLogger Deprecated protected final Logger logger Logger getLogger getClass getName public abstract long getRecurrencePeriod public long getInitialDelay long l RANDOM nextLong Math abs Long MIN VALUE Long MIN VALUE if l Long MIN VALUE l return Math abs l getRecurrencePeriod public static ExtensionList PeriodicWork all return ExtensionList lookup PeriodicWork class Initializer after JOB LOADED public static void init start all PeriodicWorks for PeriodicWork p PeriodicWork all Timer get scheduleAtFixedRate p p getInitialDelay p getRecurrencePeriod TimeUnit MILLISECONDS time constants protected static final long MIN 1000 60 protected static final long HOUR 60 MIN protected static final long DAY 24 HOUR private static final Random RANDOM new Randompackage hudson import hudson model PermalinkProjectAction Permalink import hudson util EditDistance import java util ArrayList import java util Collection import java util List public final class PermalinkList extends ArrayList Permalink public PermalinkList Collection extends Permalink c super c public PermalinkList public Permalink get String id for Permalink p this if p getId equals id return p return null public Permalink findNearest String id List String ids new ArrayList String for Permalink p this ids add p getId String nearest EditDistance findNearest id ids if nearest null return null return get nearestpackage hudson model import jenkins model PeepholePermalink import java util List import java util concurrent CopyOnWriteArrayList public interface PermalinkProjectAction extends Action List Permalink getPermalinks abstract class Permalink public abstract String getDisplayName public abstract String getId public abstract Run resolve Job job public static final List Permalink BUILTIN new CopyOnWriteArrayList Permalink public static final Permalink LAST BUILD new Permalink public String getDisplayName return Messages Permalink LastBuild public String getId return lastBuild public Run resolve Job job return job getLastBuild public static final Permalink LAST STABLE BUILD new PeepholePermalink public String getDisplayName return Messages Permalink LastStableBuild public String getId return lastStableBuild Override public boolean apply Run run return run isBuilding run getResult Result SUCCESS public static final Permalink LAST SUCCESSFUL BUILD new PeepholePermalink public String getDisplayName return Messages Permalink LastSuccessfulBuild public String getId return lastSuccessfulBuild Override public boolean apply Run run return run isBuilding run getResult isBetterOrEqualTo Result UNSTABLE public static final Permalink LAST FAILED BUILD new PeepholePermalink public String getDisplayName return Messages Permalink LastFailedBuild public String getId return lastFailedBuild Override public boolean apply Run run return run isBuilding run getResult Result FAILURE public static final Permalink LAST UNSTABLE BUILD new PeepholePermalink public String getDisplayName return Messages Permalink LastUnstableBuild public String getId return lastUnstableBuild Override public boolean apply Run run return run isBuilding run getResult Result UNSTABLE public static final Permalink LAST UNSUCCESSFUL BUILD new PeepholePermalink public String getDisplayName return Messages Permalink LastUnsuccessfulBuild public String getId return lastUnsuccessfulBuild Override public boolean apply Run run return run isBuilding run getResult Result SUCCESS public static final Permalink LAST COMPLETED BUILD new Permalink public String getDisplayName return Messages Permalink LastCompletedBuild public String getId return lastCompletedBuild public Run resolve Job job return job getLastCompletedBuild static BUILTIN add LAST BUILD BUILTIN add LAST STABLE BUILD BUILTIN add LAST SUCCESSFUL BUILD BUILTIN add LAST FAILED BUILD BUILTIN add LAST UNSTABLE BUILD BUILTIN add LAST UNSUCCESSFUL BUILD BUILTIN add LAST COMPLETED BUILDpackage hudson security import com google common collect ImmutableSet import hudson model Hudson import jenkins model Jenkins import net sf json util JSONUtils import java util Collections import java util Comparator import java util List import java util Set import java util concurrent CopyOnWriteArrayList import javax annotation CheckForNull import javax annotation Nonnull import org jvnet localizer Localizable public final class Permission public static final Comparator Permission ID COMPARATOR new Comparator Permission break eclipse compilation Override public int compare Nonnull Permission one Nonnull Permission two return one getId compareTo two getId public final Nonnull Class owner public final Nonnull PermissionGroup group public final Nonnull String name public final CheckForNull Localizable description public final CheckForNull Permission impliedBy public boolean enabled private final Nonnull Set PermissionScope scopes public Permission Nonnull PermissionGroup group Nonnull String name CheckForNull Localizable description CheckForNull Permission impliedBy boolean enable Nonnull PermissionScope scopes throws IllegalStateException if JSONUtils isJavaIdentifier name throw new IllegalArgumentException name is not a Java identifier this owner group owner this group group this name name this description description this impliedBy impliedBy this enabled enable this scopes ImmutableSet copyOf scopes group add this ALL add this public Permission Nonnull PermissionGroup group Nonnull String name CheckForNull Localizable description CheckForNull Permission impliedBy Nonnull PermissionScope scope this group name description impliedBy true new PermissionScope scope assert scope null Deprecated public Permission Nonnull PermissionGroup group Nonnull String name CheckForNull Localizable description CheckForNull Permission impliedBy boolean enable this group name description impliedBy enable new PermissionScope PermissionScope JENKINS Deprecated public Permission Nonnull PermissionGroup group Nonnull String name CheckForNull Localizable description CheckForNull Permission impliedBy this group name description impliedBy PermissionScope JENKINS Deprecated public Permission Nonnull PermissionGroup group Nonnull String name CheckForNull Permission impliedBy this group name null impliedBy private Permission Nonnull PermissionGroup group Nonnull String name this group name null null public boolean isContainedBy Nonnull PermissionScope s for PermissionScope c scopes if c isContainedBy s return true return false public Nonnull String getId return owner getName name Override public boolean equals Object o return o instanceof Permission getId equals Permission o getId Override public int hashCode return getId hashCode public static CheckForNull Permission fromId Nonnull String id int idx id lastIndexOf if idx 0 return null try force the initialization so that it will put all its permissions into the list Class cl Class forName id substring 0 idx true Jenkins getInstance getPluginManager uberClassLoader PermissionGroup g PermissionGroup get cl if g null return null return g find id substring idx 1 catch ClassNotFoundException e return null Override public String toString return Permission owner name public void setEnabled boolean enable enabled enable public boolean getEnabled return enabled public static Nonnull List Permission getAll return ALL VIEW private static final List Permission ALL new CopyOnWriteArrayList Permission private static final List Permission ALL VIEW Collections unmodifiableList ALL Because of the initialization order issue these two fields need to be defined here even though they logically belong to Jenkins Deprecated public static final PermissionGroup HUDSON PERMISSIONS new PermissionGroup Hudson class hudson model Messages Hudson Permissions Title Deprecated public static final Permission HUDSON ADMINISTER new Permission HUDSON PERMISSIONS Administer hudson model Messages Hudson AdministerPermission Description null Root Permissions These permisisons are meant to be used as the impliedBy permission for other more specific permissions The intention is to allow a simplified AuthorizationStrategy implementation agnostic to specific permissions public static final PermissionGroup GROUP new PermissionGroup Permission class Messages Permission Permissions Title Deprecated public static final Permission FULL CONTROL new Permission GROUP FullControl null HUDSON ADMINISTER public static final Permission READ new Permission GROUP GenericRead null HUDSON ADMINISTER public static final Permission WRITE new Permission GROUP GenericWrite null HUDSON ADMINISTER public static final Permission CREATE new Permission GROUP GenericCreate null WRITE public static final Permission UPDATE new Permission GROUP GenericUpdate null WRITE public static final Permission DELETE new Permission GROUP GenericDelete null WRITE public static final Permission CONFIGURE new Permission GROUP GenericConfigure null UPDATEpackage hudson security import hudson ExtensionPoint import hudson model User public abstract class PermissionAdder implements ExtensionPoint public abstract boolean add AuthorizationStrategy strategy User user Permission permpackage hudson security import hudson model Hudson import java util ArrayList import java util Iterator import java util List import java util SortedSet import java util TreeSet import javax annotation CheckForNull import org jvnet localizer Localizable public final class PermissionGroup implements Iterable Permission Comparable PermissionGroup private final SortedSet Permission permissions new TreeSet Permission Permission ID COMPARATOR public final Class owner public final Localizable title public PermissionGroup Class owner Localizable title throws IllegalStateException this owner owner this title title register this private String id return owner getName public Iterator Permission iterator return getPermissions iterator synchronized void add Permission p if permissions add p throw new IllegalStateException attempt to register a second Permission for p getId public synchronized List Permission getPermissions return new ArrayList Permission permissions public synchronized boolean hasPermissionContainedBy PermissionScope scope for Permission p permissions if p isContainedBy scope return true return false public synchronized Permission find String name for Permission p permissions if p name equals name return p return null public int compareTo PermissionGroup that first sort by the compare order number This is so that we can put Hudson PERMISSIONS first int r this compareOrder that compareOrder if r 0 return r among the permissions of the same group just sort by their names so that the sort order is consistent regardless of classloading order return id compareTo that id private int compareOrder if owner Hudson class return 0 return 1 Override public boolean equals Object o return o instanceof PermissionGroup id equals PermissionGroup o id Override public int hashCode return id hashCode public synchronized int size return permissions size Override public String toString return PermissionGroup id private static synchronized void register PermissionGroup g if PERMISSIONS add g throw new IllegalStateException attempt to register a second PermissionGroup for g id public static synchronized List PermissionGroup getAll return new ArrayList PermissionGroup PERMISSIONS public static synchronized CheckForNull PermissionGroup get Class owner for PermissionGroup g PERMISSIONS if g owner owner return g return null private static final SortedSet PermissionGroup PERMISSIONS new TreeSet PermissionGrouppackage hudson security import com google common collect ImmutableSet import hudson model Build import hudson model Computer import hudson model Item import hudson model ItemGroup import hudson model Job import hudson model ModelObject import hudson model Node import hudson model Run import jenkins model Jenkins import java util Set public final class PermissionScope public final Class extends ModelObject modelClass private final Set PermissionScope containers public PermissionScope Class extends ModelObject modelClass PermissionScope containers this modelClass modelClass this containers ImmutableSet copyOf containers public boolean isContainedBy PermissionScope s if this s return true for PermissionScope c containers if c isContainedBy s return true return false A few built in permission scopes public static final PermissionScope JENKINS new PermissionScope Jenkins class public static final PermissionScope ITEM GROUP new PermissionScope ItemGroup class JENKINS public static final PermissionScope ITEM new PermissionScope Item class ITEM GROUP public static final PermissionScope RUN new PermissionScope Run class ITEM public static final PermissionScope COMPUTER new PermissionScope Computer class JENKINSpackage com kaku colorfulnews di scope import java lang annotation Documented import java lang annotation Retention import java lang annotation RetentionPolicy import javax inject Scope Scope Documented Retention RetentionPolicy RUNTIME public interface PerServicepackage hudson util import com infradna tool bridge method injector WithBridgeMethods import com thoughtworks xstream converters Converter import com thoughtworks xstream converters MarshallingContext import com thoughtworks xstream converters UnmarshallingContext import com thoughtworks xstream converters collections AbstractCollectionConverter import com thoughtworks xstream io HierarchicalStreamReader import com thoughtworks xstream io HierarchicalStreamWriter import com thoughtworks xstream mapper Mapper import hudson model Describable import hudson model Saveable import java io IOException import java util AbstractList import java util ArrayList import java util Collection import java util Iterator import java util List public class PersistedList T extends AbstractList T protected final CopyOnWriteList T data new CopyOnWriteList T protected Saveable owner Saveable NOOP protected PersistedList protected PersistedList Collection extends T initialList data replaceBy initialList public PersistedList Saveable owner setOwner owner public void setOwner Saveable owner this owner owner WithBridgeMethods void class public boolean add T item data add item onModified return true WithBridgeMethods void class public boolean addAll Collection extends T items data addAll items onModified return true public void replaceBy Collection extends T col throws IOException data replaceBy col onModified public T get int index return data get index public U extends T U get Class U type for T t data if type isInstance t return type cast t return null public U extends T List U getAll Class U type List U r new ArrayList U for T t data if type isInstance t r add type cast t return r public int size return data size public void remove Class extends T type throws IOException for T t data if t getClass type data remove t onModified return public void replace T from T to throws IOException List T copy new ArrayList T data getView for int i 0 i copy size i if copy get i equals from copy set i to data replaceBy copy public boolean remove Object o boolean b data remove T o if b onModified return b public void removeAll Class extends T type throws IOException boolean modified false for T t data if t getClass type data remove t modified true if modified onModified public void clear data clear public Iterator T iterator return data iterator protected void onModified throws IOException owner save private void onModified try onModified catch IOException e throw new RuntimeException e public List T toList return data getView public T T toArray T array return data toArray array public void addAllTo Collection super T dst data addAllTo dst public boolean isEmpty return data isEmpty public boolean contains Object item return data contains item Override public String toString return toList toString public static class ConverterImpl extends AbstractCollectionConverter CopyOnWriteList ConverterImpl copyOnWriteListConverter public ConverterImpl Mapper mapper super mapper copyOnWriteListConverter new CopyOnWriteList ConverterImpl mapper public boolean canConvert Class type handle subtypes in case the onModified method is overridden return PersistedList class isAssignableFrom type public void marshal Object source HierarchicalStreamWriter writer MarshallingContext context for Object o PersistedList source writeItem o context writer public Object unmarshal HierarchicalStreamReader reader UnmarshallingContext context CopyOnWriteList core copyOnWriteListConverter unmarshal reader context try PersistedList r PersistedList context getRequiredType newInstance r data replaceBy core return r catch InstantiationException e InstantiationError x new InstantiationError x initCause e throw x catch IllegalAccessException e IllegalAccessError x new IllegalAccessError x initCause e throw xpackage com twitter sdk android core import io fabric sdk android services persistence PreferenceStore import io fabric sdk android services persistence PreferenceStoreStrategy import io fabric sdk android services persistence SerializationStrategy import java util Collections import java util Map import java util concurrent ConcurrentHashMap import java util concurrent atomic AtomicReference public class PersistedSessionManager T extends Session implements SessionManager T private static final int NUM SESSIONS 1 private final PreferenceStore preferenceStore private final SerializationStrategy T serializer private final ConcurrentHashMap Long T sessionMap private final ConcurrentHashMap Long PreferenceStoreStrategy T storageMap private final PreferenceStoreStrategy T activeSessionStorage private final AtomicReference T activeSessionRef private final String prefKeySession private volatile boolean restorePending true public PersistedSessionManager PreferenceStore preferenceStore SerializationStrategy T serializer String prefKeyActiveSession String prefKeySession this preferenceStore serializer new ConcurrentHashMap Long T NUM SESSIONS new ConcurrentHashMap Long PreferenceStoreStrategy T NUM SESSIONS new PreferenceStoreStrategy preferenceStore serializer prefKeyActiveSession prefKeySession PersistedSessionManager PreferenceStore preferenceStore SerializationStrategy T serializer ConcurrentHashMap Long T sessionMap ConcurrentHashMap Long PreferenceStoreStrategy T storageMap PreferenceStoreStrategy T activesSessionStorage String prefKeySession this preferenceStore preferenceStore this serializer serializer this sessionMap sessionMap this storageMap storageMap this activeSessionStorage activesSessionStorage this activeSessionRef new AtomicReference this prefKeySession prefKeySession void restoreAllSessionsIfNecessary Only restore once if restorePending restoreAllSessions private synchronized void restoreAllSessions if restorePending restoreActiveSession restoreSessions restorePending false private void restoreSessions T session final Map String preferences preferenceStore get getAll for Map Entry String entry preferences entrySet if isSessionPreferenceKey entry getKey session serializer deserialize String entry getValue if session null internalSetSession session getId session false private void restoreActiveSession final T session activeSessionStorage restore if session null internalSetSession session getId session false boolean isSessionPreferenceKey String preferenceKey return preferenceKey startsWith prefKeySession Override public T getActiveSession restoreAllSessionsIfNecessary return activeSessionRef get Override public void setActiveSession T session if session null throw new IllegalArgumentException Session must not be null restoreAllSessionsIfNecessary internalSetSession session getId session true Override public void clearActiveSession restoreAllSessionsIfNecessary if activeSessionRef get null clearSession activeSessionRef get getId Override public T getSession long id restoreAllSessionsIfNecessary return sessionMap get id Override public void setSession long id T session if session null throw new IllegalArgumentException Session must not be null restoreAllSessionsIfNecessary internalSetSession id session false Override public Map Long T getSessionMap restoreAllSessionsIfNecessary return Collections unmodifiableMap sessionMap private void internalSetSession long id T session boolean forceUpdate sessionMap put id session PreferenceStoreStrategy T storage storageMap get id if storage null storage new PreferenceStoreStrategy preferenceStore serializer getPrefKey id storageMap putIfAbsent id storage storage save session final T activeSession activeSessionRef get if activeSession null activeSession getId id forceUpdate synchronized this activeSessionRef compareAndSet activeSession session activeSessionStorage save session String getPrefKey long id return prefKeySession id Override public void clearSession long id restoreAllSessionsIfNecessary if activeSessionRef get null activeSessionRef get getId id synchronized this activeSessionRef set null activeSessionStorage clear sessionMap remove id final PreferenceStoreStrategy T storage storageMap remove id if storage null storage clearpackage hudson model import java io File public interface PersistenceRoot extends Saveable File getRootDirpackage com kaku colorfulnews mvp ui activities import android app Activity import android app ActivityOptions import android content Intent import android os Build import android os Bundle import android support design widget FloatingActionButton import android support design widget NavigationView import android support design widget Snackbar import android support v4 app ActivityCompat import android support v4 app ActivityOptionsCompat import android support v4 widget DrawerLayout import android support v4 widget SwipeRefreshLayout import android support v7 widget DefaultItemAnimator import android support v7 widget RecyclerView import android support v7 widget StaggeredGridLayoutManager import android support v7 widget Toolbar import android view View import android widget ProgressBar import android widget TextView import com kaku colorfulnews R import com kaku colorfulnews common Constants import com kaku colorfulnews common LoadNewsType import com kaku colorfulnews listener OnItemClickListener import com kaku colorfulnews mvp entity PhotoGirl import com kaku colorfulnews mvp presenter impl PhotoPresenterImpl import com kaku colorfulnews mvp ui activities base BaseActivity import com kaku colorfulnews mvp ui adapter PhotoListAdapter import com kaku colorfulnews mvp view PhotoView import com kaku colorfulnews utils NetUtil import java util List import javax inject Inject import butterknife BindView import butterknife OnClick public class PhotoActivity extends BaseActivity implements PhotoView SwipeRefreshLayout OnRefreshListener BindView R id toolbar Toolbar mToolbar BindView R id photo rv RecyclerView mPhotoRv BindView R id nav view NavigationView mNavView BindView R id drawer layout DrawerLayout mDrawerLayout BindView R id progress bar ProgressBar mProgressBar BindView R id swipe refresh layout SwipeRefreshLayout mSwipeRefreshLayout BindView R id empty view TextView mEmptyView BindView R id fab FloatingActionButton mFab Inject PhotoPresenterImpl mPhotoPresenter Inject PhotoListAdapter mPhotoListAdapter Inject Activity mActivity private boolean mIsAllLoaded Override public int getLayoutId return R layout activity photo Override public void initInjector mActivityComponent inject this Override protected void onCreate Bundle savedInstanceState super onCreate savedInstanceState Override public void initViews mIsHasNavigationView true mBaseNavView mNavView initSwipeRefreshLayout initRecyclerView setAdapterItemClickEvent initPresenter private void initSwipeRefreshLayout mSwipeRefreshLayout setOnRefreshListener this mSwipeRefreshLayout setColorSchemeColors getResources getIntArray R array gplus colors private void initRecyclerView mPhotoRv setHasFixedSize true mPhotoRv setLayoutManager new StaggeredGridLayoutManager 2 StaggeredGridLayoutManager VERTICAL mPhotoRv setItemAnimator new DefaultItemAnimator mPhotoRv setAdapter mPhotoListAdapter setRvScrollEvent private void setRvScrollEvent mPhotoRv addOnScrollListener new RecyclerView OnScrollListener Override public void onScrollStateChanged RecyclerView recyclerView int newState super onScrollStateChanged recyclerView newState RecyclerView LayoutManager layoutManager recyclerView getLayoutManager int lastVisibleItemPosition StaggeredGridLayoutManager layoutManager findLastVisibleItemPositions null int visibleItemCount layoutManager getChildCount int totalItemCount layoutManager getItemCount if mIsAllLoaded visibleItemCount 0 newState RecyclerView SCROLL STATE IDLE lastVisibleItemPosition 0 totalItemCount 1 lastVisibleItemPosition 1 totalItemCount 1 mPhotoPresenter loadMore mPhotoListAdapter showFooter mPhotoRv scrollToPosition mPhotoListAdapter getItemCount 1 private void setAdapterItemClickEvent mPhotoListAdapter setOnItemClickListener new OnItemClickListener Override public void onItemClick View view int position Intent intent new Intent PhotoActivity this PhotoDetailActivity class intent putExtra Constants PHOTO DETAIL mPhotoListAdapter getList get position getUrl startActivity view intent private void startActivity View view Intent intent if Build VERSION SDK INT Build VERSION CODES LOLLIPOP ActivityOptions options ActivityOptions makeSceneTransitionAnimation mActivity view Constants TRANSITION ANIMATION NEWS PHOTOS startActivity intent options toBundle else ActivityOptionsCompat options ActivityOptionsCompat makeScaleUpAnimation view view getWidth 2 view getHeight 2 0 0 ActivityCompat startActivity mActivity intent options toBundle private void initPresenter mPresenter mPhotoPresenter mPresenter attachView this mPresenter onCreate Override public void setPhotoList List PhotoGirl photoGirls LoadNewsType checker int loadType switch loadType case LoadNewsType TYPE REFRESH SUCCESS mSwipeRefreshLayout setRefreshing false mPhotoListAdapter setList photoGirls mPhotoListAdapter notifyDataSetChanged checkIsEmpty photoGirls mIsAllLoaded false break case LoadNewsType TYPE REFRESH ERROR mSwipeRefreshLayout setRefreshing false checkIsEmpty photoGirls break case LoadNewsType TYPE LOAD MORE SUCCESS mPhotoListAdapter hideFooter if photoGirls null photoGirls size 0 mIsAllLoaded true Snackbar make mPhotoRv getString R string no more Snackbar LENGTH SHORT show else mPhotoListAdapter addMore photoGirls break case LoadNewsType TYPE LOAD MORE ERROR mPhotoListAdapter hideFooter break private void checkIsEmpty List PhotoGirl photoGirls if photoGirls null mPhotoListAdapter getList null mPhotoRv setVisibility View GONE mEmptyView setVisibility View VISIBLE else mPhotoRv setVisibility View VISIBLE mEmptyView setVisibility View GONE Override public void showProgress mProgressBar setVisibility View VISIBLE Override public void hideProgress mProgressBar setVisibility View GONE Override public void showMsg String message mProgressBar setVisibility View GONE if NetUtil isNetworkAvailable Snackbar make mPhotoRv message Snackbar LENGTH LONG show Override public void onRefresh mPhotoPresenter refreshData OnClick R id empty view R id fab public void onClick View view switch view getId case R id empty view mSwipeRefreshLayout setRefreshing true mPhotoPresenter refreshData break case R id fab mPhotoRv getLayoutManager scrollToPosition 0 breakpackage com kaku colorfulnews mvp ui activities import android content Context import android graphics Color import android graphics drawable ColorDrawable import android os Build import android os Bundle import android support v7 widget Toolbar import android transition Transition import android view Menu import android view MenuItem import android view View import android view animation DecelerateInterpolator import android widget ImageView import android widget Toast import com kaku colorfulnews R import com kaku colorfulnews common Constants import com kaku colorfulnews common PhotoRequestType import com kaku colorfulnews di scope ContextLife import com kaku colorfulnews mvp presenter impl PhotoDetailPresenterImpl import com kaku colorfulnews mvp ui activities base BaseActivity import com kaku colorfulnews mvp view PhotoDetailView import com kaku colorfulnews utils MyUtils import com kaku colorfulnews utils SystemUiVisibilityUtil import com kaku colorfulnews widget PullBackLayout import com socks library KLog import com squareup picasso Picasso import javax inject Inject import butterknife BindView import dagger Lazy import uk co senab photoview PhotoView import uk co senab photoview PhotoViewAttacher public class PhotoDetailActivity extends BaseActivity implements PullBackLayout Callback PhotoDetailView BindView R id toolbar Toolbar mToolbar BindView R id photo iv ImageView mPhotoIv BindView R id pull back layout PullBackLayout mPullBackLayout BindView R id photo touch iv PhotoView mPhotoTouchIv Inject Lazy PhotoDetailPresenterImpl mPhotoDetailPresenter Inject ContextLife Activity Context mContext private ColorDrawable mBackground private boolean mIsToolBarHidden private boolean mIsStatusBarHidden Override protected void onCreate Bundle savedInstanceState super onCreate savedInstanceState mPullBackLayout setCallback this initLazyLoadView Override public void supportFinishAfterTransition super supportFinishAfterTransition private void initLazyLoadView if Build VERSION SDK INT Build VERSION CODES LOLLIPOP getWindow getEnterTransition addListener new Transition TransitionListener Override public void onTransitionStart Transition transition Override public void onTransitionEnd Transition transition showToolBarAndPhotoTouchView Override public void onTransitionCancel Transition transition Override public void onTransitionPause Transition transition Override public void onTransitionResume Transition transition else showToolBarAndPhotoTouchView private void showToolBarAndPhotoTouchView toolBarFadeIn loadPhotoTouchIv private void toolBarFadeIn mIsToolBarHidden true hideOrShowToolbar private void loadPhotoTouchIv Picasso with this load getIntent getStringExtra Constants PHOTO DETAIL error R drawable ic load fail into mPhotoTouchIv Override public int getLayoutId return R layout activity photo detail Override public void initInjector mActivityComponent inject this Override public void initViews initToolbar initImageView initBackground setPhotoViewClickEvent private void initToolbar mToolbar setTitle getString R string girl private void initImageView loadPhotoIv private void loadPhotoIv Picasso with this load getIntent getStringExtra Constants PHOTO DETAIL into mPhotoIv private void setPhotoViewClickEvent mPhotoTouchIv setOnPhotoTapListener new PhotoViewAttacher OnPhotoTapListener Override public void onPhotoTap View view float v float v1 KLog d hideOrShowToolbar hideOrShowStatusBar Override public void onOutsidePhotoTap KLog d hideOrShowToolbar hideOrShowStatusBar protected void hideOrShowToolbar mToolbar animate alpha mIsToolBarHidden 1 0f 0 0f setInterpolator new DecelerateInterpolator 2 start mIsToolBarHidden mIsToolBarHidden private void hideOrShowStatusBar if mIsStatusBarHidden SystemUiVisibilityUtil enter PhotoDetailActivity this else SystemUiVisibilityUtil exit PhotoDetailActivity this mIsStatusBarHidden mIsStatusBarHidden SuppressWarnings deprecation private void initBackground mBackground new ColorDrawable Color BLACK MyUtils getRootView this setBackgroundDrawable mBackground private void initPresenter mPresenter mPhotoDetailPresenter get mPhotoDetailPresenter get mPhotoDetailPresenter mPresenter attachView this Override public boolean onCreateOptionsMenu Menu menu getMenuInflater inflate R menu menu photo menu return true Override public boolean onOptionsItemSelected MenuItem item switch item getItemId case R id action share handlePicture PhotoRequestType TYPE SHARE return true case R id action save handlePicture PhotoRequestType TYPE SAVE return true case R id action set wallpaper handlePicture PhotoRequestType TYPE SET WALLPAPER return true return super onOptionsItemSelected item private void handlePicture int type initPresenter mPhotoDetailPresenter get handlePicture getIntent getStringExtra Constants PHOTO DETAIL type Override public void onPullStart toolBarFadeOut mIsStatusBarHidden true hideOrShowStatusBar private void toolBarFadeOut mIsToolBarHidden false hideOrShowToolbar Override public void onPull float progress KLog d progress progress progress Math min 1f progress 3f KLog d alpha int 0xff 1f progress mBackground setAlpha int 0xff 1f progress Override public void onPullCancel toolBarFadeIn Override public void onPullComplete supportFinishAfterTransition Override public void showProgress Override public void hideProgress Override public void showMsg String message Toast makeText mContext message Toast LENGTH LONG showpackage com kaku colorfulnews mvp ui fragment import android os Bundle import android support annotation Nullable import android view LayoutInflater import android view View import android view ViewGroup import android widget ProgressBar import com bumptech glide Glide import com bumptech glide load DecodeFormat import com bumptech glide load engine DiskCacheStrategy import com kaku colorfulnews App import com kaku colorfulnews R import com kaku colorfulnews common Constants import com kaku colorfulnews event PhotoDetailOnClickEvent import com kaku colorfulnews mvp ui fragment base BaseFragment import com kaku colorfulnews utils RxBus import com kaku colorfulnews utils TransformUtils import com socks library KLog import java util concurrent TimeUnit import butterknife BindView import butterknife ButterKnife import rx Observable import rx Subscriber import uk co senab photoview PhotoView import uk co senab photoview PhotoViewAttacher public class PhotoDetailFragment extends BaseFragment BindView R id photo view PhotoView mPhotoView BindView R id progress bar ProgressBar mProgressBar private String mImgSrc Override public void onCreate Nullable Bundle savedInstanceState super onCreate savedInstanceState if getArguments null mImgSrc getArguments getString Constants PHOTO DETAIL IMGSRC Nullable Override public View onCreateView LayoutInflater inflater Nullable ViewGroup container Nullable Bundle savedInstanceState View view inflater inflate getLayoutId container false ButterKnife bind this view initViews view return view Override public void initInjector Override public void initViews View view mProgressBar setVisibility View VISIBLE initPhotoView setPhotoViewClickEvent private void initPhotoView mSubscription Observable timer 100 TimeUnit MILLISECONDS glide activity compose TransformUtils Long defaultSchedulers subscribe new Subscriber Long Override public void onCompleted mProgressBar setVisibility View GONE Override public void onError Throwable e mProgressBar setVisibility View GONE Override public void onNext Long aLong Glide with App getAppContext load mImgSrc asBitmap format DecodeFormat PREFER ARGB 8888 diskCacheStrategy DiskCacheStrategy ALL error R drawable ic load fail into mPhotoView private void setPhotoViewClickEvent mPhotoView setOnPhotoTapListener new PhotoViewAttacher OnPhotoTapListener Override public void onPhotoTap View view float v float v1 KLog d handleOnTabEvent Override public void onOutsidePhotoTap KLog d handleOnTabEvent private void handleOnTabEvent RxBus getInstance post new PhotoDetailOnClickEvent Override public int getLayoutId return R layout fragment news photo detailpackage com kaku colorfulnews mvp interactor import com kaku colorfulnews listener RequestCallBack import rx Subscription public interface PhotoDetailInteractor T Subscription saveImageAndGetImageUri RequestCallBack T listener String urlpackage com kaku colorfulnews mvp interactor impl import android content Intent import android graphics Bitmap import android net Uri import android os Environment import android support annotation NonNull import com kaku colorfulnews App import com kaku colorfulnews R import com kaku colorfulnews listener RequestCallBack import com kaku colorfulnews mvp interactor PhotoDetailInteractor import com kaku colorfulnews utils TransformUtils import com socks library KLog import com squareup picasso Picasso import java io File import java io FileOutputStream import java io IOException import javax inject Inject import rx Observable import rx Subscriber import rx Subscription import rx functions Func1 public class PhotoDetailInteractorImpl implements PhotoDetailInteractor Uri Inject public PhotoDetailInteractorImpl Override public Subscription saveImageAndGetImageUri final RequestCallBack Uri listener final String url return Observable create new Observable OnSubscribe Bitmap Override public void call final Subscriber super Bitmap subscriber KLog d Thread currentThread getName Bitmap bitmap null try bitmap Picasso with App getAppContext load url get catch IOException e subscriber onError e if bitmap null subscriber onError new Exception subscriber onNext bitmap subscriber onCompleted observeOn Schedulers io flatMap new Func1 Bitmap Observable Uri Override public Observable Uri call Bitmap bitmap KLog d Thread currentThread getName return getUriObservable bitmap url compose TransformUtils Uri defaultSchedulers subscribe new Subscriber Uri Override public void onCompleted Override public void onError Throwable e KLog e e toString listener onError App getAppContext getString R string error try again Override public void onNext Uri uri listener success uri NonNull private Observable Uri getUriObservable Bitmap bitmap String url File file getImageFile bitmap url if file null return Observable error new NullPointerException Save image file failed Uri uri Uri fromFile file Update the System MediaStore Images Media ContentUri Intent scannerIntent new Intent Intent ACTION MEDIA SCANNER SCAN FILE uri App getAppContext sendBroadcast scannerIntent return Observable just uri private File getImageFile Bitmap bitmap String url String fileName colorful news photo url hashCode jpg File file new File Environment getExternalStorageDirectory fileName getFilesDir if file getParentFile exists noinspection ResultOfMethodCallIgnored file getParentFile mkdirs FileOutputStream outputStream null try outputStream new FileOutputStream file bitmap compress Bitmap CompressFormat JPEG 100 outputStream catch Exception e e printStackTrace return null finally try if outputStream null outputStream close catch IOException e e printStackTrace return filepackage com kaku colorfulnews event public class PhotoDetailOnClickEventpackage com kaku colorfulnews mvp presenter import com kaku colorfulnews common PhotoRequestType import com kaku colorfulnews mvp presenter base BasePresenter public interface PhotoDetailPresenter extends BasePresenter void handlePicture String imageUrl PhotoRequestType PhotoRequestTypeChecker int typepackage com kaku colorfulnews mvp presenter impl import android app Activity import android app WallpaperManager import android content ContentValues import android content Context import android content Intent import android database Cursor import android net Uri import android os Build import android provider MediaStore import com kaku colorfulnews App import com kaku colorfulnews R import com kaku colorfulnews common PhotoRequestType import com kaku colorfulnews listener RequestCallBack import com kaku colorfulnews mvp interactor impl PhotoDetailInteractorImpl import com kaku colorfulnews mvp presenter PhotoDetailPresenter import com kaku colorfulnews mvp presenter base BasePresenterImpl import com kaku colorfulnews mvp view PhotoDetailView import com socks library KLog import java io File import java io IOException import javax inject Inject public class PhotoDetailPresenterImpl extends BasePresenterImpl PhotoDetailView Uri implements PhotoDetailPresenter RequestCallBack Uri private PhotoDetailInteractorImpl mPhotoDetailInteractor private Activity mActivity private int mRequestType 1 Inject public PhotoDetailPresenterImpl PhotoDetailInteractorImpl photoDetailInteractor Activity activity mPhotoDetailInteractor photoDetailInteractor mActivity activity Override public void success Uri imageUri super success imageUri switch mRequestType case PhotoRequestType TYPE SHARE share imageUri break case PhotoRequestType TYPE SAVE showSavePathMsg imageUri break case PhotoRequestType TYPE SET WALLPAPER setWallpaper imageUri break private void share Uri uri Intent intent new Intent intent setAction Intent ACTION SEND intent putExtra Intent EXTRA STREAM uri intent setType image jpeg mActivity startActivity Intent createChooser intent App getAppContext getString R string share private void showSavePathMsg Uri imageUri mView showMsg mActivity getString R string picture already save to imageUri getPath private void setWallpaper Uri imageUri WallpaperManager wallpaperManager WallpaperManager getInstance mActivity if Build VERSION SDK INT Build VERSION CODES KITKAT File wallpaperFile new File imageUri getPath Uri contentURI getImageContentUri mActivity wallpaperFile getAbsolutePath Uri uri1 getImageContentUri mActivity imageUri getPath mActivity startActivity wallpaperManager getCropAndSetWallpaperIntent contentURI else try wallpaperManager setStream mActivity getContentResolver openInputStream imageUri mView showMsg App getAppContext getString R string set wallpaper success catch IOException e KLog e e toString mView showMsg e getMessage http stackoverflow com questions 23207604 get a content uri from a file uri public Uri getImageContentUri Context context String absPath KLog d getImageContentUri absPath Cursor cursor context getContentResolver query MediaStore Images Media EXTERNAL CONTENT URI new String MediaStore Images Media ID MediaStore Images Media DATA new String absPath null if cursor null cursor moveToFirst int id cursor getInt cursor getColumnIndex MediaStore MediaColumns ID cursor close return Uri withAppendedPath MediaStore Images Media EXTERNAL CONTENT URI Integer toString id else if absPath isEmpty ContentValues values new ContentValues values put MediaStore Images Media DATA absPath return context getContentResolver insert MediaStore Images Media EXTERNAL CONTENT URI values else return null Override public void handlePicture String imageUrl PhotoRequestType PhotoRequestTypeChecker int type mRequestType type mPhotoDetailInteractor saveImageAndGetImageUri this imageUrlpackage com kaku colorfulnews mvp view import com kaku colorfulnews mvp view base BaseView public interface PhotoDetailView extends BaseViewpackage com kaku colorfulnews mvp entity public class PhotoGirl private String id private String createdAt private String desc private String publishedAt private String source private String type private String url private boolean used private String who public String get id return id public void set id String id this id id public String getCreatedAt return createdAt public void setCreatedAt String createdAt this createdAt createdAt public String getDesc return desc public void setDesc String desc this desc desc public String getPublishedAt return publishedAt public void setPublishedAt String publishedAt this publishedAt publishedAt public String getSource return source public void setSource String source this source source public String getType return type public void setType String type this type type public String getUrl return url public void setUrl String url this url url public boolean isUsed return used public void setUsed boolean used this used used public String getWho return who public void setWho String who this who whopackage com kaku colorfulnews mvp interactor import com kaku colorfulnews listener RequestCallBack import rx Subscription public interface PhotoInteractor T Subscription loadPhotos RequestCallBack T listener int size int pagepackage com kaku colorfulnews mvp interactor impl import com kaku colorfulnews App import com kaku colorfulnews R import com kaku colorfulnews common HostType import com kaku colorfulnews listener RequestCallBack import com kaku colorfulnews mvp entity GirlData import com kaku colorfulnews mvp entity PhotoGirl import com kaku colorfulnews mvp interactor PhotoInteractor import com kaku colorfulnews repository network RetrofitManager import com kaku colorfulnews utils TransformUtils import java util List import javax inject Inject import rx Subscriber import rx Subscription import rx functions Func1 public class PhotoInteractorImpl implements PhotoInteractor List PhotoGirl Inject public PhotoInteractorImpl Override public Subscription loadPhotos final RequestCallBack List PhotoGirl listener int size int page return RetrofitManager getInstance HostType GANK GIRL PHOTO getPhotoListObservable size page map new Func1 GirlData List PhotoGirl Override public List PhotoGirl call GirlData girlData return girlData getResults compose TransformUtils List PhotoGirl defaultSchedulers subscribe new Subscriber List PhotoGirl Override public void onCompleted Override public void onError Throwable e listener onError App getAppContext getString R string load error Override public void onNext List PhotoGirl photoGirls listener success photoGirlspackage com kaku colorfulnews mvp ui adapter import android support v7 widget RecyclerView import android view View import android view ViewGroup import com kaku colorfulnews App import com kaku colorfulnews R import com kaku colorfulnews mvp entity PhotoGirl import com kaku colorfulnews mvp ui adapter base BaseRecyclerViewAdapter import com kaku colorfulnews utils DimenUtil import com kaku colorfulnews widget RatioImageView import com socks library KLog import com squareup picasso Picasso import java util HashMap import java util Map import java util Random import javax inject Inject import butterknife BindView import butterknife ButterKnife public class PhotoListAdapter extends BaseRecyclerViewAdapter PhotoGirl private int width int DimenUtil getScreenSize 2 private Map Integer Integer mHeights new HashMap Inject public PhotoListAdapter super null Override public RecyclerView ViewHolder onCreateViewHolder ViewGroup parent int viewType View view switch viewType case TYPE FOOTER view getView parent R layout item news footer return new FooterViewHolder view case TYPE ITEM view getView parent R layout item photo final ItemViewHolder itemViewHolder new ItemViewHolder view itemViewHolder setIsRecyclable false setItemOnClickEvent itemViewHolder return itemViewHolder default throw new RuntimeException there is no type that matches the type viewType make sure your using types correctly private void setItemOnClickEvent final RecyclerView ViewHolder holder if mOnItemClickListener null holder itemView setOnClickListener new View OnClickListener Override public void onClick View v mOnItemClickListener onItemClick v holder getLayoutPosition Override public void onBindViewHolder final RecyclerView ViewHolder holder final int position super onBindViewHolder holder position if holder instanceof ItemViewHolder ItemViewHolder holder mPhotoIv setOriginalSize width getHeight position Picasso with App getAppContext load mList get position getUrl placeholder R color image place holder error R drawable ic load fail into ItemViewHolder holder mPhotoIv picasso item setItemAppearAnimation holder position R anim anim rotate scale in private int getHeight int position int height try if position mHeights size height getRandomHeight mHeights put position height else height mHeights get position catch Exception e KLog e height width 2 return height private int getRandomHeight int height height int width new Random nextFloat 2 1 return height Override public int getItemViewType int position if mIsShowFooter isFooterPosition position return TYPE FOOTER else return TYPE ITEM class ItemViewHolder extends RecyclerView ViewHolder BindView R id photo iv RatioImageView mPhotoIv ItemViewHolder View view super view ButterKnife bind this viewpackage com kaku colorfulnews mvp ui adapter PagerAdapter import android support v4 app Fragment import android support v4 app FragmentManager import android support v4 app FragmentStatePagerAdapter import com kaku colorfulnews mvp ui fragment PhotoDetailFragment import java util List public class PhotoPagerAdapter extends FragmentStatePagerAdapter private List PhotoDetailFragment mFragmentList public PhotoPagerAdapter FragmentManager fm List PhotoDetailFragment fragmentList super fm mFragmentList fragmentList Override public Fragment getItem int position return mFragmentList get position Override public int getCount return mFragmentList sizepackage com kaku colorfulnews mvp presenter import com kaku colorfulnews mvp presenter base BasePresenter public interface PhotoPresenter extends BasePresenter void refreshData void loadMorepackage com kaku colorfulnews mvp presenter impl import com kaku colorfulnews common LoadNewsType import com kaku colorfulnews listener RequestCallBack import com kaku colorfulnews mvp entity PhotoGirl import com kaku colorfulnews mvp interactor impl PhotoInteractorImpl import com kaku colorfulnews mvp presenter PhotoPresenter import com kaku colorfulnews mvp presenter base BasePresenterImpl import java util List import javax inject Inject public class PhotoPresenterImpl extends BasePresenterImpl com kaku colorfulnews mvp view PhotoView List PhotoGirl implements PhotoPresenter RequestCallBack List PhotoGirl private PhotoInteractorImpl mPhotoInteractor private static int SIZE 20 private int mStartPage 1 private boolean misFirstLoad private boolean mIsRefresh true Inject public PhotoPresenterImpl PhotoInteractorImpl photoInteractor mPhotoInteractor photoInteractor Override public void onCreate super onCreate loadPhotoData Override public void beforeRequest if misFirstLoad mView showProgress Override public void onError String errorMsg super onError errorMsg if mView null int loadType mIsRefresh LoadNewsType TYPE REFRESH ERROR LoadNewsType TYPE LOAD MORE ERROR mView setPhotoList null loadType Override public void success List PhotoGirl items super success items misFirstLoad true if items null mStartPage 1 int loadType mIsRefresh LoadNewsType TYPE REFRESH SUCCESS LoadNewsType TYPE LOAD MORE SUCCESS if mView null mView setPhotoList items loadType mView hideProgress Override public void refreshData mStartPage 1 mIsRefresh true loadPhotoData Override public void loadMore mIsRefresh false loadPhotoData private void loadPhotoData mPhotoInteractor loadPhotos this SIZE mStartPagepackage com kaku colorfulnews common import android support annotation IntDef import java lang annotation Retention import java lang annotation RetentionPolicy public class PhotoRequestType public static final int TYPE SHARE 1 public static final int TYPE SAVE 2 public static final int TYPE SET WALLPAPER 3 IntDef TYPE SHARE TYPE SAVE TYPE SET WALLPAPER Retention RetentionPolicy SOURCE public interface PhotoRequestTypeCheckerpackage com kaku colorfulnews mvp view import com kaku colorfulnews common LoadNewsType import com kaku colorfulnews mvp entity PhotoGirl import com kaku colorfulnews mvp view base BaseView import java util List public interface PhotoView extends BaseView void setPhotoList List PhotoGirl photoGirls LoadNewsType checker int loadTypepackage com kaku colorfulnews widget import android content Context import android support v4 view ViewPager import android util AttributeSet import android view MotionEvent import com socks library KLog public class PhotoViewPager extends ViewPager public PhotoViewPager Context context super context public PhotoViewPager Context context AttributeSet attrs super context attrs Override public boolean onInterceptTouchEvent MotionEvent ev try return super onInterceptTouchEvent ev catch Exception e KLog e e toString return false Override public boolean onTouchEvent MotionEvent ev try return super onTouchEvent ev catch IllegalArgumentException ex KLog e ex toString return falsepackage jenkins slaves import hudson ExtensionList import hudson ExtensionPoint import hudson remoting Channel import jenkins model Jenkins import java io IOException public abstract class PingFailureAnalyzer implements ExtensionPoint public abstract void onPingFailure Channel c Throwable cause throws IOException public static ExtensionList PingFailureAnalyzer all return Jenkins getInstance getExtensionList PingFailureAnalyzer classpackage com twitter sdk android core models import com google gson annotations SerializedName import java util List import java util Map public class Place SerializedName attributes public final Map String String attributes SerializedName bounding box public final BoundingBox boundingBox SerializedName country public final String country SerializedName country code public final String countryCode SerializedName full name public final String fullName SerializedName id public final String id SerializedName name public final String name SerializedName place type public final String placeType SerializedName url public final String url public Place Map String String attributes BoundingBox boundingBox String country String countryCode String fullName String id String name String placeType String url this attributes attributes this boundingBox boundingBox this country country this countryCode countryCode this fullName fullName this id id this name name this placeType placeType this url url public static class BoundingBox SerializedName coordinates public final List List List Double coordinates SerializedName type public final String type public BoundingBox List List List Double coordinates String type this coordinates coordinates this type typepackage hudson console import java io ByteArrayInputStream import java io DataInputStream import java io IOException import java io OutputStream import java util logging Logger public class PlainTextConsoleOutputStream extends LineTransformationOutputStream private final OutputStream out public PlainTextConsoleOutputStream OutputStream out this out out protected void eol byte in int sz throws IOException int next ConsoleNote findPreamble in 0 sz perform byte char while figuring out the char positions of the BLOBs int written 0 while next 0 if next written out write in written next written written next else assert next written int rest sz next ByteArrayInputStream b new ByteArrayInputStream in next rest ConsoleNote skip new DataInputStream b int bytesUsed rest b available bytes consumed by annotations written bytesUsed next ConsoleNote findPreamble in written sz written finish the remaining bytes chars conversion out write in written sz written Override public void flush throws IOException out flush Override public void close throws IOException super close out close private static final Logger LOGGER Logger getLogger PlainTextConsoleOutputStream class getNamepackage hudson import hudson util VersionNumber import java io File import java util Locale public enum Platform WINDOWS UNIX public final char pathSeparator private Platform char pathSeparator this pathSeparator pathSeparator public static Platform current if File pathSeparatorChar return UNIX return WINDOWS public static boolean isDarwin according to http developer apple com technotes tn2002 tn2110 html return System getProperty os name toLowerCase Locale ENGLISH startsWith mac public static boolean isSnowLeopardOrLater try return isDarwin new VersionNumber System getProperty os version compareTo new VersionNumber 10 6 0 catch IllegalArgumentException e failed to parse the version return falsepackage com twitter sdk android tweetui import android app Activity import android os Bundle import android view View import com twitter sdk android core internal scribe ScribeItem import java io Serializable public class PlayerActivity extends Activity static final String PLAYER ITEM PLAYER ITEM static final String SCRIBE ITEM SCRIBE ITEM static final VideoScribeClient videoScribeClient new VideoScribeClientImpl TweetUi getInstance PlayerController playerController Override public void onCreate Bundle savedInstanceState super onCreate savedInstanceState setContentView R layout tw player activity final PlayerItem item PlayerItem getIntent getSerializableExtra PLAYER ITEM final View rootView findViewById android R id content playerController new PlayerController rootView playerController prepare item final ScribeItem scribeItem ScribeItem getIntent getSerializableExtra SCRIBE ITEM scribeCardPlayImpression scribeItem Override protected void onResume super onResume playerController onResume Override protected void onPause playerController onPause super onPause Override public void onDestroy playerController onDestroy super onDestroy private void scribeCardPlayImpression ScribeItem scribeItem videoScribeClient play scribeItem public static class PlayerItem implements Serializable public String url public boolean looping public String callToActionUrl public String callToActionText public PlayerItem String url boolean looping this url url this looping looping public PlayerItem String url boolean looping String callToActionText String callToActionUrl this url url this looping looping this callToActionText callToActionText this callToActionUrl callToActionUrlpackage com twitter sdk android tweetui import android content Intent import android media MediaPlayer import android net Uri import android view View import android widget ProgressBar import android widget TextView import com twitter sdk android core IntentUtils import com twitter sdk android tweetui internal VideoControlView import com twitter sdk android tweetui internal VideoView import io fabric sdk android Fabric class PlayerController private static final String TAG PlayerController final VideoView videoView final VideoControlView videoControlView final ProgressBar videoProgressView final TextView callToActionView View rootView int seekPosition 0 boolean isPlaying true PlayerController View rootView this rootView rootView this videoView VideoView rootView findViewById R id video view this videoControlView VideoControlView rootView findViewById R id video control view this videoProgressView ProgressBar rootView findViewById R id video progress view this callToActionView TextView rootView findViewById R id call to action view Unit testing purposes PlayerController View rootView VideoView videoView VideoControlView videoControlView ProgressBar videoProgressView TextView callToActionView this rootView rootView this videoView videoView this videoControlView videoControlView this videoProgressView videoProgressView this callToActionView callToActionView void prepare PlayerActivity PlayerItem item try setUpCallToAction item setUpMediaControl item looping videoView setOnPreparedListener new MediaPlayer OnPreparedListener Override public void onPrepared MediaPlayer mediaPlayer videoProgressView setVisibility View GONE videoView setOnInfoListener new MediaPlayer OnInfoListener Override public boolean onInfo MediaPlayer mediaPlayer int what int extra if what MediaPlayer MEDIA INFO BUFFERING END videoProgressView setVisibility View GONE return true else if what MediaPlayer MEDIA INFO BUFFERING START videoProgressView setVisibility View VISIBLE return true return false final Uri uri Uri parse item url videoView setVideoURI uri item looping videoView requestFocus catch Exception e Fabric getLogger e TAG Error occurred during video playback e void onResume if seekPosition 0 videoView seekTo seekPosition if isPlaying videoView start videoControlView update void onPause isPlaying videoView isPlaying seekPosition videoView getCurrentPosition videoView pause void onDestroy videoView stopPlayback void setUpMediaControl boolean looping if looping setUpLoopControl else setUpMediaControl void setUpLoopControl videoControlView setVisibility View INVISIBLE videoView setOnClickListener new View OnClickListener Override public void onClick View view if videoView isPlaying videoView pause else videoView start void setUpMediaControl videoView setMediaController videoControlView void setUpCallToAction PlayerActivity PlayerItem item if item callToActionText null item callToActionUrl null callToActionView setVisibility View VISIBLE callToActionView setText item callToActionText setUpCallToActionListener item callToActionUrl setUpRootViewOnClickListener void setUpCallToActionListener final String callToActionUrl callToActionView setOnClickListener new View OnClickListener Override public void onClick View v final Uri uri Uri parse callToActionUrl final Intent intent new Intent Intent ACTION VIEW uri IntentUtils safeStartActivity callToActionView getContext intent void setUpRootViewOnClickListener rootView setOnClickListener new View OnClickListener Override public void onClick View v if callToActionView getVisibility View VISIBLE callToActionView setVisibility View GONE else callToActionView setVisibility View VISIBLEpackage hudson import hudson util TimeUnit2 import jenkins model Jenkins import hudson model Descriptor import hudson model Saveable import hudson model listeners ItemListener import hudson model listeners SaveableListener import hudson model Descriptor FormException import org kohsuke stapler StaplerRequest import org kohsuke stapler StaplerResponse import javax servlet ServletContext import javax servlet ServletException import java io IOException import java io File import net sf json JSONObject import com thoughtworks xstream XStream import hudson init Initializer import hudson init Terminator import java net URI import java net URISyntaxException import jenkins model GlobalConfiguration import org kohsuke stapler HttpResponses public abstract class Plugin implements Saveable Deprecated protected Plugin transient PluginWrapper wrapper public void setServletContext ServletContext context public PluginWrapper getWrapper return wrapper public void start throws Exception public void postInitialize throws Exception public void stop throws Exception Deprecated public void configure JSONObject formData throws IOException ServletException FormException public void configure StaplerRequest req JSONObject formData throws IOException ServletException FormException configure formData public void doDynamic StaplerRequest req StaplerResponse rsp throws IOException ServletException String path req getRestOfPath if path startsWith META INF path startsWith WEB INF throw HttpResponses notFound if path length 0 path Stapler routes requests like the static foo bar zot to be treated like foo bar zot and this is used to serve long expiration header by using Jenkins VERSION HASH as to create unique URLs Recognize that and set a long expiration header String requestPath req getRequestURI substring req getContextPath length boolean staticLink requestPath startsWith static long expires staticLink TimeUnit2 DAYS toMillis 365 1 use serveLocalizedFile to support automatic locale selection try rsp serveLocalizedFile req wrapper baseResourceURL toURI resolve new URI null path null toURL expires catch URISyntaxException x throw new IOException x Convenience methods for those plugins that persist configuration protected void load throws IOException XmlFile xml getConfigXml if xml exists xml unmarshal this public void save throws IOException if BulkChange contains this return XmlFile config getConfigXml config write this SaveableListener fireOnChange this config protected XmlFile getConfigXml return new XmlFile Jenkins XSTREAM new File Jenkins getInstance getRootDir wrapper getShortName xml public static final class DummyImpl extends Pluginpackage hudson import java io Closeable import java io File import java io IOException import java io InputStream import java net URL import java util ArrayList import java util Collection import java util Enumeration import java util List import org apache tools ant AntClassLoader public class PluginFirstClassLoader extends AntClassLoader implements Closeable private List URL urls new ArrayList URL public void addPathFiles Collection File paths throws IOException for File f paths urls add f toURI toURL addPathFile f public List URL getURLs return urls public void close throws IOException cleanup Override protected Enumeration findResources String arg0 boolean arg1 throws IOException Enumeration enu super findResources arg0 arg1 return enu Override protected Enumeration findResources String name throws IOException Enumeration enu super findResources name return enu Override public URL getResource String arg0 URL url super getResource arg0 return url Override public InputStream getResourceAsStream String name InputStream is super getResourceAsStream name return ispackage hudson import edu umd cs findbugs annotations NonNull import edu umd cs findbugs annotations SuppressFBWarnings import hudson security ACLContext import jenkins util SystemProperties import hudson PluginWrapper Dependency import hudson init InitMilestone import hudson init InitStrategy import hudson init InitializerFinder import hudson model AbstractItem import hudson model AbstractModelObject import hudson model AdministrativeMonitor import hudson model Api import hudson model Descriptor import hudson model Failure import hudson model ItemGroupMixIn import hudson model UpdateCenter import hudson model UpdateSite import hudson model UpdateCenter DownloadJob import hudson model UpdateCenter InstallationJob import hudson security ACL import hudson security Permission import hudson security PermissionScope import hudson util CyclicGraphDetector import hudson util CyclicGraphDetector CycleDetectedException import hudson util PersistedList import hudson util Service import hudson util VersionNumber import hudson util XStream2 import jenkins ClassLoaderReflectionToolkit import jenkins InitReactorRunner import jenkins MissingDependencyException import jenkins RestartRequiredException import jenkins YesNoMaybe import jenkins install InstallState import jenkins install InstallUtil import jenkins model Jenkins import jenkins util io OnMaster import jenkins util xml RestrictiveEntityResolver import net sf json JSONArray import net sf json JSONObject import org acegisecurity Authentication import org apache commons fileupload FileItem import org apache commons fileupload disk DiskFileItemFactory import org apache commons fileupload servlet ServletFileUpload import org apache commons io FileUtils import org apache commons io FilenameUtils import org apache commons io IOUtils import org apache commons lang StringUtils import org apache commons logging LogFactory import org jenkinsci Symbol import org jenkinsci bytecode Transformer import org jvnet hudson reactor Executable import org jvnet hudson reactor Reactor import org jvnet hudson reactor ReactorException import org jvnet hudson reactor TaskBuilder import org jvnet hudson reactor TaskGraphBuilder import org kohsuke accmod restrictions DoNotUse import org kohsuke stapler HttpRedirect import org kohsuke stapler HttpResponse import org kohsuke stapler HttpResponses import org kohsuke stapler QueryParameter import org kohsuke stapler StaplerOverridable import org kohsuke stapler StaplerRequest import org kohsuke stapler StaplerResponse import org kohsuke stapler export Exported import org kohsuke stapler export ExportedBean import org kohsuke stapler interceptor RequirePOST import javax annotation CheckForNull import javax annotation Nonnull import javax servlet ServletContext import javax servlet ServletException import javax xml parsers ParserConfigurationException import javax xml parsers SAXParserFactory import java io Closeable import java io File import java io FilenameFilter import java io IOException import java io InputStream import java lang ref WeakReference import java lang reflect Method import java net MalformedURLException import java net URISyntaxException import java net URL import java net URLClassLoader import java util ArrayList import java util Collection import java util Collections import java util Enumeration import java util HashMap import java util HashSet import java util Hashtable import java util Iterator import java util LinkedHashSet import java util List import java util ListIterator import java util Map import java util Set import java util TreeMap import java util UUID import java util concurrent ConcurrentHashMap import java util concurrent ConcurrentMap import java util concurrent CopyOnWriteArrayList import java util concurrent Future import java util jar JarFile import java util jar Manifest import java util logging Level import java util logging Logger import org xml sax Attributes import org xml sax InputSource import org xml sax SAXException import org xml sax helpers DefaultHandler import static hudson init InitMilestone import hudson model DownloadService import hudson util FormValidation import java io ByteArrayInputStream import java net JarURLConnection import java net URLConnection import java util jar JarEntry import static java util logging Level FINE import static java util logging Level INFO import static java util logging Level SEVERE import static java util logging Level WARNING import org kohsuke accmod Restricted import org kohsuke accmod restrictions NoExternalUse ExportedBean public abstract class PluginManager extends AbstractModelObject implements OnMaster StaplerOverridable public static final String CUSTOM PLUGIN MANAGER PluginManager class getName className private enum PMConstructor JENKINS Override NonNull PluginManager doCreate NonNull Class extends PluginManager klass NonNull Jenkins jenkins throws ReflectiveOperationException return klass getConstructor Jenkins class newInstance jenkins SC FILE Override NonNull PluginManager doCreate NonNull Class extends PluginManager klass NonNull Jenkins jenkins throws ReflectiveOperationException return klass getConstructor ServletContext class File class newInstance jenkins servletContext jenkins getRootDir FILE Override NonNull PluginManager doCreate NonNull Class extends PluginManager klass NonNull Jenkins jenkins throws ReflectiveOperationException return klass getConstructor File class newInstance jenkins getRootDir final CheckForNull PluginManager create NonNull Class extends PluginManager klass NonNull Jenkins jenkins throws ReflectiveOperationException try return doCreate klass jenkins catch NoSuchMethodException e Constructor not found Will try the remaining ones return null abstract NonNull PluginManager doCreate NonNull Class extends PluginManager klass NonNull Jenkins jenkins throws ReflectiveOperationException public static NonNull PluginManager createDefault NonNull Jenkins jenkins String pmClassName SystemProperties getString CUSTOM PLUGIN MANAGER if StringUtils isBlank pmClassName LOGGER log FINE String format Use of custom plugin manager s requested pmClassName try final Class extends PluginManager klass Class forName pmClassName asSubclass PluginManager class Iteration is in declaration order for PMConstructor c PMConstructor values PluginManager pm c create klass jenkins if pm null return pm LOGGER log WARNING String format Provided custom plugin manager s does not provide any of the suitable constructors Using default pmClassName catch NullPointerException e Class forName and Class getConstructor are supposed to never return null though a broken ClassLoader could break the contract Just in case we introduce this specific catch to avoid polluting the logs with NPEs LOGGER log WARNING String format Unable to instantiate custom plugin manager s Using default pmClassName catch ClassCastException e LOGGER log WARNING String format Provided class s does not extend PluginManager Using default pmClassName catch Exception e LOGGER log WARNING String format Unable to instantiate custom plugin manager s Using default pmClassName e return new LocalPluginManager jenkins protected final List PluginWrapper plugins new ArrayList PluginWrapper protected final List PluginWrapper activePlugins new CopyOnWriteArrayList PluginWrapper protected final List FailedPlugin failedPlugins new ArrayList FailedPlugin public final File rootDir CheckForNull private final File workDir Deprecated public final ServletContext context implementation is minimal just enough to run XStream and load plugin contributed classes public final ClassLoader uberClassLoader new UberClassLoader private final Transformer compatibilityTransformer new Transformer public volatile boolean pluginUploaded false private boolean pluginListed false private final PluginStrategy strategy public PluginManager ServletContext context File rootDir this context context this rootDir rootDir if rootDir exists rootDir mkdirs String workDir SystemProperties getString PluginManager class getName workDir this workDir StringUtils isBlank workDir null new File workDir strategy createPluginStrategy load up rules for the core first try compatibilityTransformer loadRules getClass getClassLoader catch IOException e LOGGER log Level WARNING Failed to load compatibility rewrite rules e public Transformer getCompatibilityTransformer return compatibilityTransformer public Api getApi Jenkins getInstance checkPermission Jenkins ADMINISTER return new Api this CheckForNull public File getWorkDir return workDir Override public Collection PluginManagerStaplerOverride getOverrides return PluginManagerStaplerOverride all public TaskBuilder initTasks final InitStrategy initStrategy TaskBuilder builder if pluginListed builder new TaskGraphBuilder List File archives Collection String bundledPlugins Handle loadBundledPlugins add Loading bundled plugins new Executable public void run Reactor session throws Exception bundledPlugins loadBundledPlugins Handle listUpPlugins requires loadBundledPlugins add Listing up plugins new Executable public void run Reactor session throws Exception archives initStrategy listPluginArchives PluginManager this requires listUpPlugins attains PLUGINS LISTED add Preparing plugins new Executable public void run Reactor session throws Exception once we ve listed plugins we can fill in the reactor with plugin specific initialization tasks TaskGraphBuilder g new TaskGraphBuilder final Map String File inspectedShortNames new HashMap String File for final File arc archives g followedBy notFatal attains PLUGINS LISTED add Inspecting plugin arc new Executable public void run Reactor session1 throws Exception try PluginWrapper p strategy createPluginWrapper arc if isDuplicate p return p isBundled containsHpiJpi bundledPlugins arc getName plugins add p catch IOException e failedPlugins add new FailedPlugin arc getName e throw e private boolean isDuplicate PluginWrapper p String shortName p getShortName if inspectedShortNames containsKey shortName LOGGER info Ignoring arc because inspectedShortNames get shortName is already loaded return true inspectedShortNames put shortName arc return false g followedBy attains PLUGINS LISTED add Checking cyclic dependencies new Executable public void run Reactor reactor throws Exception try CyclicGraphDetector PluginWrapper cgd new CyclicGraphDetector PluginWrapper Override protected List PluginWrapper getEdges PluginWrapper p List PluginWrapper next new ArrayList PluginWrapper addTo p getDependencies next addTo p getOptionalDependencies next return next private void addTo List Dependency dependencies List PluginWrapper r for Dependency d dependencies PluginWrapper p getPlugin d shortName if p null r add p Override protected void reactOnCycle PluginWrapper q List PluginWrapper cycle throws hudson util CyclicGraphDetector CycleDetectedException LOGGER log Level SEVERE found cycle in plugin dependencies root q deactivating all involved Util join cycle for PluginWrapper pluginWrapper cycle pluginWrapper setHasCycleDependency true failedPlugins add new FailedPlugin pluginWrapper getShortName new CycleDetectedException cycle cgd run getPlugins obtain topologically sorted list and overwrite the list ListIterator PluginWrapper litr getPlugins listIterator for PluginWrapper p cgd getSorted litr next litr set p if p isActive activePlugins add p catch CycleDetectedException e TODO this should be impossible since we override reactOnCycle to not throw the exception stop disable all plugins since classloading from them can lead to StackOverflow throw e let Hudson fail Let s see for a while until we open this functionality up to plugins g followedBy attains PLUGINS LISTED add Load compatibility rules new Executable public void run Reactor reactor throws Exception compatibilityTransformer loadRules uberClassLoader session addAll g discoverTasks session pluginListed true technically speaking this is still too early as at this point tasks are merely scheduled not necessarily executed else builder TaskBuilder EMPTY BUILDER final InitializerFinder initializerFinder new InitializerFinder uberClassLoader misc stuff lists up initialization tasks about loading plugins return TaskBuilder union initializerFinder this scans Initializer in the core once builder new TaskGraphBuilder requires PLUGINS LISTED attains PLUGINS PREPARED add Loading plugins new Executable public void run Reactor session throws Exception Jenkins getInstance lookup set PluginInstanceStore class new PluginInstanceStore TaskGraphBuilder g new TaskGraphBuilder schedule execution of loading plugins for final PluginWrapper p activePlugins toArray new PluginWrapper activePlugins size g followedBy notFatal attains PLUGINS PREPARED add String format Loading plugin s v s s p getLongName p getVersion p getShortName new Executable public void run Reactor session throws Exception try p resolvePluginDependencies strategy load p catch MissingDependencyException e failedPlugins add new FailedPlugin p getShortName e activePlugins remove p plugins remove p LOGGER log Level SEVERE Failed to install 0 1 new Object p getShortName e getMessage return catch IOException e failedPlugins add new FailedPlugin p getShortName e activePlugins remove p plugins remove p throw e schedule execution of initializing plugins for final PluginWrapper p activePlugins toArray new PluginWrapper activePlugins size g followedBy notFatal attains PLUGINS STARTED add Initializing plugin p getShortName new Executable public void run Reactor session throws Exception if activePlugins contains p return try p getPlugin postInitialize catch Exception e failedPlugins add new FailedPlugin p getShortName e activePlugins remove p plugins remove p throw e g followedBy attains PLUGINS STARTED add Discovering plugin initialization tasks new Executable public void run Reactor reactor throws Exception rescan to find plugin contributed Initializer reactor addAll initializerFinder discoverTasks reactor register them all session addAll g discoverTasks session All plugins are loaded Now we can figure out who depends on who requires PLUGINS PREPARED attains COMPLETED add Resolving Dependant Plugins Graph new Executable Override public void run Reactor reactor throws Exception resolveDependantPlugins protected Nonnull Set String loadPluginsFromWar Nonnull String fromPath return loadPluginsFromWar fromPath null TODO Consider refactoring in order to avoid DMI COLLECTION OF URLS SuppressFBWarnings value DMI COLLECTION OF URLS justification Plugin loading happens only once on Jenkins startup protected Nonnull Set String loadPluginsFromWar Nonnull String fromPath CheckForNull FilenameFilter filter Set String names new HashSet ServletContext context Jenkins getActiveInstance servletContext Set String plugins Util fixNull Set String context getResourcePaths fromPath Set URL copiedPlugins new HashSet Set URL dependencies new HashSet for String pluginPath plugins String fileName pluginPath substring pluginPath lastIndexOf 1 if fileName length 0 see http www nabble com 404 Not Found error when clicking on help td24508544 html I suspect some containers are returning directory names continue try URL url context getResource pluginPath if filter null url null if filter accept new File url getFile getParentFile fileName continue names add fileName copyBundledPlugin url fileName copiedPlugins add url try addDependencies url fromPath dependencies catch Exception e LOGGER log Level SEVERE Failed to resolve dependencies for the bundled plugin fileName e catch IOException e LOGGER log Level SEVERE Failed to extract the bundled plugin fileName e Copy dependencies These are not detached plugins but are required by them for URL dependency dependencies if copiedPlugins contains dependency Ignore Already copied continue String fileName new File dependency getFile getName try names add fileName copyBundledPlugin dependency fileName copiedPlugins add dependency catch IOException e LOGGER log Level SEVERE Failed to extract the bundled dependency plugin fileName e return names TODO Consider refactoring in order to avoid DMI COLLECTION OF URLS SuppressFBWarnings value DMI COLLECTION OF URLS justification Plugin loading happens only once on Jenkins startup protected static void addDependencies URL hpiResUrl String fromPath Set URL dependencySet throws URISyntaxException MalformedURLException if dependencySet contains hpiResUrl return Manifest manifest parsePluginManifest hpiResUrl String dependencySpec manifest getMainAttributes getValue Plugin Dependencies if dependencySpec null String dependencyTokens dependencySpec split ServletContext context Jenkins getActiveInstance servletContext for String dependencyToken dependencyTokens if dependencyToken endsWith resolution optional ignore optional dependencies continue String artifactId dependencyToken split 0 URL dependencyURL context getResource fromPath artifactId hpi if dependencyURL null Maybe bundling has changed jpi files dependencyURL context getResource fromPath artifactId jpi if dependencyURL null And transitive deps addDependencies dependencyURL fromPath dependencySet And then add the current plugin dependencySet add dependencyURL protected void loadDetachedPlugins InstallState installState Jenkins getActiveInstance getInstallState if InstallState UPGRADE equals installState VersionNumber lastExecVersion new VersionNumber InstallUtil getLastExecVersion LOGGER log INFO Upgrading Jenkins The last running version was 0 This Jenkins is version 1 new Object lastExecVersion Jenkins VERSION final List ClassicPluginStrategy DetachedPlugin detachedPlugins ClassicPluginStrategy getDetachedPlugins lastExecVersion Set String loadedDetached loadPluginsFromWar WEB INF detached plugins new FilenameFilter Override public boolean accept File dir String name name normalisePluginName name If this was a plugin that was detached some time in the past i e not just one of the plugins that was bundled for fun if ClassicPluginStrategy isDetachedPlugin name If it s already installed and the installed version is older than the bundled version then we upgrade The bundled version is the min required version for this version of Jenkins so we must upgrade VersionNumber installedVersion getPluginVersion rootDir name VersionNumber bundledVersion getPluginVersion dir name if installedVersion null bundledVersion null installedVersion isOlderThan bundledVersion return true If it s a plugin that was detached since the last running version for ClassicPluginStrategy DetachedPlugin detachedPlugin detachedPlugins if detachedPlugin getShortName equals name return true Otherwise skip this and do not install return false LOGGER log INFO Upgraded Jenkins from version 0 to version 1 Loaded detached plugins and dependencies 2 new Object lastExecVersion Jenkins VERSION loadedDetached InstallUtil saveLastExecVersion else final Set ClassicPluginStrategy DetachedPlugin forceUpgrade new HashSet for ClassicPluginStrategy DetachedPlugin p ClassicPluginStrategy getDetachedPlugins VersionNumber installedVersion getPluginVersion rootDir p getShortName VersionNumber requiredVersion p getRequiredVersion if installedVersion null installedVersion isOlderThan requiredVersion LOGGER log Level WARNING Detached plugin 0 found at version 1 required minimum version is 2 new Object p getShortName installedVersion requiredVersion forceUpgrade add p if forceUpgrade isEmpty Set String loadedDetached loadPluginsFromWar WEB INF detached plugins new FilenameFilter Override public boolean accept File dir String name name normalisePluginName name for ClassicPluginStrategy DetachedPlugin detachedPlugin forceUpgrade if detachedPlugin getShortName equals name return true return false LOGGER log INFO Upgraded detached plugins and dependencies 0 new Object loadedDetached private String normalisePluginName Nonnull String name Normalise the name by stripping off the file extension if present return name replace jpi replace hpi private CheckForNull VersionNumber getPluginVersion Nonnull File dir Nonnull String pluginId VersionNumber version getPluginVersion new File dir pluginId jpi if version null version getPluginVersion new File dir pluginId hpi return version private CheckForNull VersionNumber getPluginVersion Nonnull File pluginFile if pluginFile exists return null try return getPluginVersion pluginFile toURI toURL catch MalformedURLException e return null private CheckForNull VersionNumber getPluginVersion Nonnull URL pluginURL Manifest manifest parsePluginManifest pluginURL if manifest null return null String versionSpec manifest getMainAttributes getValue Plugin Version return new VersionNumber versionSpec private boolean containsHpiJpi Collection String bundledPlugins String name return bundledPlugins contains name replaceAll hpi jpi bundledPlugins contains name replaceAll jpi hpi Deprecated See https groups google com d msg jenkinsci dev kRobm cxFw8 6V66uhibAwAJ public CheckForNull Manifest getBundledPluginManifest String shortName return null public void dynamicLoad File arc throws IOException InterruptedException RestartRequiredException dynamicLoad arc false Restricted NoExternalUse class public void dynamicLoad File arc boolean removeExisting throws IOException InterruptedException RestartRequiredException LOGGER info Attempting to dynamic load arc PluginWrapper p null String sn try sn strategy getShortName arc catch AbstractMethodError x LOGGER log WARNING JENKINS 12753 fix not active 0 x getMessage p strategy createPluginWrapper arc sn p getShortName PluginWrapper pw getPlugin sn if pw null if removeExisting try to load disabled plugins for Iterator PluginWrapper i plugins iterator i hasNext pw i next if sn equals pw getShortName i remove pw null break else throw new RestartRequiredException Messages PluginManager PluginIsAlreadyInstalled RestartRequired sn if p null p strategy createPluginWrapper arc if p supportsDynamicLoad YesNoMaybe NO throw new RestartRequiredException Messages PluginManager PluginDoesntSupportDynamicLoad RestartRequired sn there s no need to do cyclic dependency check because we are deploying one at a time so existing plugins can t be depending on this newly deployed one plugins add p if p isActive activePlugins add p synchronized UberClassLoader uberClassLoader loaded UberClassLoader uberClassLoader loaded clear try p resolvePluginDependencies strategy load p Jenkins getInstance refreshExtensions p getPlugin postInitialize catch Exception e failedPlugins add new FailedPlugin sn e activePlugins remove p plugins remove p throw new IOException Failed to install sn plugin e run initializers in the added plugin Reactor r new Reactor InitMilestone ordering final ClassLoader loader p classLoader r addAll new InitializerFinder loader Override protected boolean filter Method e return e getDeclaringClass getClassLoader loader super filter e discoverTasks r try new InitReactorRunner run r catch ReactorException e throw new IOException Failed to initialize sn plugin e recalculate dependencies of plugins optionally depending the newly deployed one for PluginWrapper depender plugins if depender equals p skip itself continue for Dependency d depender getOptionalDependencies if d shortName equals p getShortName this plugin depends on the newly loaded one recalculate dependencies try getPluginStrategy updateDependency depender p catch AbstractMethodError x LOGGER log WARNING 0 does not yet implement updateDependency getPluginStrategy getClass break Redo who depends on who resolveDependantPlugins LOGGER info Plugin p getShortName p getVersion dynamically installed Restricted NoExternalUse class public synchronized void resolveDependantPlugins for PluginWrapper plugin plugins Set String dependants new HashSet for PluginWrapper possibleDependant plugins The plugin could have just been deleted If so it doesn t count as a dependant if possibleDependant isDeleted continue List Dependency dependencies possibleDependant getDependencies for Dependency dependency dependencies if dependency shortName equals plugin getShortName dependants add possibleDependant getShortName plugin setDependants dependants protected abstract Collection String loadBundledPlugins throws Exception protected void copyBundledPlugin URL src String fileName throws IOException fileName fileName replace hpi jpi normalize fileNames to have the correct suffix String legacyName fileName replace jpi hpi long lastModified getModificationDate src File file new File rootDir fileName normalization first if the old file exists rename new File rootDir legacyName file update file if no file exists today bundled version and current version differs by timestamp if file exists file lastModified lastModified FileUtils copyURLToFile src file file setLastModified getModificationDate src lastModified is set for two reasons to avoid unpacking as much as possible but still do it on both upgrade and downgrade to make sure the value is not changed after each restart so we can avoid unpacking the plugin itself in ClassicPluginStrategy explode Plugin pinning has been deprecated See https groups google com d msg jenkinsci dev kRobm cxFw8 6V66uhibAwAJ static CheckForNull Manifest parsePluginManifest URL bundledJpi try URLClassLoader cl new URLClassLoader new URL bundledJpi InputStream in null try URL res cl findResource PluginWrapper MANIFEST FILENAME if res null in getBundledJpiManifestStream res Manifest manifest new Manifest in return manifest finally Util closeAndLogFailures in LOGGER PluginWrapper MANIFEST FILENAME bundledJpi toString if cl instanceof Closeable Closeable cl close catch IOException e LOGGER log WARNING Failed to parse manifest of bundledJpi e return null Nonnull static InputStream getBundledJpiManifestStream Nonnull URL url throws IOException URLConnection uc url openConnection InputStream in null Magic which allows to avoid using stream generated for JarURLConnection It prevents getting into JENKINS 37332 due to the file desciptor leak if uc instanceof JarURLConnection final JarURLConnection jarURLConnection JarURLConnection uc final String entryName jarURLConnection getEntryName try final JarFile jarFile jarURLConnection getJarFile final JarEntry entry entryName null jarFile null jarFile getJarEntry entryName null if entry null jarFile null try InputStream i jarFile getInputStream entry byte manifestBytes IOUtils toByteArray i in new ByteArrayInputStream manifestBytes else LOGGER log Level WARNING Failed to locate the JAR file for 0 The default URLConnection stream access will be used file descriptor may be leaked url If input stream is undefined use the default implementation if in null in url openStream return in Nonnull static long getModificationDate Nonnull URL url throws IOException URLConnection uc url openConnection It prevents file desciptor leak if the URL references a file within JAR See JENKINS 37332 for more info The code idea is taken from https github com jknack handlebars java pull 394 if uc instanceof JarURLConnection final JarURLConnection connection JarURLConnection uc final URL jarURL connection getJarFileURL if jarURL getProtocol equals file uc null String file jarURL getFile return new File file lastModified else We access the data without file protocol if connection getEntryName null LOGGER log WARNING Accessing modification date of 0 file which is an entry in JAR file The access protocol is not file falling back to the default logic risk of file descriptor leak url Fallbak to the default implementation return uc getLastModified private void rename File legacyFile File newFile throws IOException if legacyFile exists return if newFile exists Util deleteFile newFile if legacyFile renameTo newFile LOGGER warning Failed to rename legacyFile to newFile protected PluginStrategy createPluginStrategy String strategyName SystemProperties getString PluginStrategy class getName if strategyName null try Class klazz getClass getClassLoader loadClass strategyName Object strategy klazz getConstructor PluginManager class newInstance this if strategy instanceof PluginStrategy LOGGER info Plugin strategy strategyName return PluginStrategy strategy else LOGGER warning Plugin strategy strategyName is not an instance of hudson PluginStrategy catch ClassNotFoundException e LOGGER warning Plugin strategy class not found strategyName catch Exception e LOGGER log WARNING Could not instantiate plugin strategy strategyName Falling back to ClassicPluginStrategy e LOGGER info Falling back to ClassicPluginStrategy default and fallback return new ClassicPluginStrategy this public PluginStrategy getPluginStrategy return strategy public boolean isPluginUploaded return pluginUploaded Exported public List PluginWrapper getPlugins List PluginWrapper out new ArrayList PluginWrapper plugins size out addAll plugins return out public List FailedPlugin getFailedPlugins return failedPlugins public PluginWrapper getPlugin String shortName for PluginWrapper p getPlugins if p getShortName equals shortName return p return null public PluginWrapper getPlugin Class extends Plugin pluginClazz for PluginWrapper p getPlugins if pluginClazz isInstance p getPlugin return p return null public List PluginWrapper getPlugins Class extends Plugin pluginSuperclass List PluginWrapper result new ArrayList PluginWrapper for PluginWrapper p getPlugins if pluginSuperclass isInstance p getPlugin result add p return Collections unmodifiableList result public String getDisplayName return Messages PluginManager DisplayName public String getSearchUrl return pluginManager public T Collection Class extends T discover Class T spi Set Class extends T result new HashSet Class extends T for PluginWrapper p activePlugins Service load spi p classLoader result return result public PluginWrapper whichPlugin Class c PluginWrapper oneAndOnly null ClassLoader cl c getClassLoader for PluginWrapper p activePlugins if p classLoader cl if oneAndOnly null return null ambigious oneAndOnly p return oneAndOnly public void stop for PluginWrapper p activePlugins p stop p releaseClassLoader activePlugins clear Work around a bug in commons logging See http www szegedi org articles memleak html LogFactory release uberClassLoader Restricted DoNotUse class WebOnly public HttpResponse doPlugins Jenkins getInstance checkPermission Jenkins ADMINISTER JSONArray response new JSONArray Map String JSONObject allPlugins new HashMap for PluginWrapper plugin plugins JSONObject pluginInfo new JSONObject pluginInfo put installed true pluginInfo put name plugin getShortName pluginInfo put title plugin getDisplayName pluginInfo put active plugin isActive pluginInfo put enabled plugin isEnabled pluginInfo put bundled plugin isBundled pluginInfo put deleted plugin isDeleted pluginInfo put downgradable plugin isDowngradable pluginInfo put website plugin getUrl List Dependency dependencies plugin getDependencies if dependencies null dependencies isEmpty Map String String dependencyMap new HashMap for Dependency dependency dependencies dependencyMap put dependency shortName dependency version pluginInfo put dependencies dependencyMap else pluginInfo put dependencies Collections emptyMap response add pluginInfo for UpdateSite site Jenkins getActiveInstance getUpdateCenter getSiteList for UpdateSite Plugin plugin site getAvailables JSONObject pluginInfo allPlugins get plugin name if pluginInfo null pluginInfo new JSONObject pluginInfo put installed false pluginInfo put name plugin name pluginInfo put title plugin getDisplayName pluginInfo put excerpt plugin excerpt pluginInfo put site site getId pluginInfo put dependencies plugin dependencies pluginInfo put website plugin wiki response add pluginInfo return hudson util HttpResponses okJSON response public HttpResponse doUpdateSources StaplerRequest req throws IOException Jenkins getInstance checkPermission CONFIGURE UPDATECENTER if req hasParameter remove UpdateCenter uc Jenkins getInstance getUpdateCenter BulkChange bc new BulkChange uc try for String id req getParameterValues sources uc getSites remove uc getById id finally bc commit else if req hasParameter add return new HttpRedirect addSite return new HttpRedirect sites RequirePOST Restricted DoNotUse class WebOnly public void doInstallPluginsDone Jenkins j Jenkins getInstance j checkPermission Jenkins ADMINISTER InstallUtil proceedToNextStateFrom InstallState INITIAL PLUGINS INSTALLING public void doInstall StaplerRequest req StaplerResponse rsp throws IOException ServletException Jenkins getInstance checkPermission Jenkins ADMINISTER Set String plugins new LinkedHashSet Enumeration String en req getParameterNames while en hasMoreElements String n en nextElement if n startsWith plugin n n substring 7 plugins add n boolean dynamicLoad req getParameter dynamicLoad null install plugins dynamicLoad rsp sendRedirect updateCenter RequirePOST Restricted DoNotUse class WebOnly public HttpResponse doInstallPlugins StaplerRequest req throws IOException Jenkins getInstance checkPermission Jenkins ADMINISTER String payload IOUtils toString req getInputStream req getCharacterEncoding JSONObject request JSONObject fromObject payload JSONArray pluginListJSON request getJSONArray plugins List String plugins new ArrayList for int i 0 i pluginListJSON size i plugins add pluginListJSON getString i UUID correlationId UUID randomUUID try boolean dynamicLoad request getBoolean dynamicLoad install plugins dynamicLoad correlationId JSONObject responseData new JSONObject responseData put correlationId correlationId toString return hudson util HttpResponses okJSON responseData catch Exception e return hudson util HttpResponses errorJSON e getMessage Restricted NoExternalUse class public List Future UpdateCenter UpdateCenterJob install Nonnull Collection String plugins boolean dynamicLoad return install plugins dynamicLoad null private List Future UpdateCenter UpdateCenterJob install Nonnull Collection String plugins boolean dynamicLoad CheckForNull UUID correlationId List Future UpdateCenter UpdateCenterJob installJobs new ArrayList for String n plugins JENKINS 22080 plugin names can contain as could according to rumour update sites int index n indexOf UpdateSite Plugin p null if index 1 p getPlugin n UpdateCenter ID DEFAULT else while index 1 if index 1 n length break String pluginName n substring 0 index String siteName n substring index 1 UpdateSite Plugin plugin getPlugin pluginName siteName There could be cases like plugin ambiguous updatesite where both plugin ambigiuous updatesite and plugin ambiguous updatesite resolve to valid plugins if plugin null if p null throw new Failure Ambiguous plugin n p plugin index n indexOf index 1 if p null throw new Failure No such plugin n Future UpdateCenter UpdateCenterJob jobFuture p deploy dynamicLoad correlationId installJobs add jobFuture trackInitialPluginInstall installJobs return installJobs private void trackInitialPluginInstall Nonnull final List Future UpdateCenter UpdateCenterJob installJobs final Jenkins jenkins Jenkins getInstance final UpdateCenter updateCenter jenkins getUpdateCenter final Authentication currentAuth Jenkins getAuthentication if Jenkins getInstance getInstallState isSetupComplete jenkins setInstallState InstallState INITIAL PLUGINS INSTALLING updateCenter persistInstallStatus new Thread Override public void run boolean failures false INSTALLING while true try updateCenter persistInstallStatus Thread sleep 500 failures false for Future UpdateCenter UpdateCenterJob jobFuture installJobs if jobFuture isDone jobFuture isCancelled continue INSTALLING UpdateCenter UpdateCenterJob job jobFuture get if job instanceof InstallationJob InstallationJob job status instanceof DownloadJob Failure failures true catch Exception e LOGGER log WARNING Unexpected error while waiting for initial plugin set to install e break updateCenter persistInstallStatus if failures try ACLContext ACL as currentAuth InstallUtil proceedToNextStateFrom InstallState INITIAL PLUGINS INSTALLING start Fire a one off thread to wait for the plugins to be deployed and then refresh the dependant plugins list new Thread Override public void run INSTALLING while true for Future UpdateCenter UpdateCenterJob deployJob installJobs try Thread sleep 500 catch InterruptedException e LOGGER log SEVERE Unexpected error while waiting for some plugins to install Plugin Manager state may be invalid Please restart Jenkins ASAP e if deployJob isCancelled deployJob isDone One of the plugins is not installing canceled so go back to sleep and try again in a while continue INSTALLING All the plugins are installed It s now safe to refresh resolveDependantPlugins break start private UpdateSite Plugin getPlugin String pluginName String siteName UpdateSite updateSite Jenkins getInstance getUpdateCenter getById siteName if updateSite null throw new Failure No such update center siteName return updateSite getPlugin pluginName RequirePOST public HttpResponse doSiteConfigure QueryParameter String site throws IOException Jenkins hudson Jenkins getInstance hudson checkPermission CONFIGURE UPDATECENTER UpdateCenter uc hudson getUpdateCenter PersistedList UpdateSite sites uc getSites for UpdateSite s sites if s getId equals UpdateCenter ID DEFAULT sites remove s sites add new UpdateSite UpdateCenter ID DEFAULT site return HttpResponses redirectToContextRoot RequirePOST public HttpResponse doProxyConfigure StaplerRequest req throws IOException ServletException Jenkins jenkins Jenkins getInstance jenkins checkPermission CONFIGURE UPDATECENTER ProxyConfiguration pc req bindJSON ProxyConfiguration class req getSubmittedForm if pc name null jenkins proxy null ProxyConfiguration getXmlFile delete else jenkins proxy pc jenkins proxy save return new HttpRedirect advanced RequirePOST public HttpResponse doUploadPlugin StaplerRequest req throws IOException ServletException try Jenkins getInstance checkPermission UPLOAD PLUGINS ServletFileUpload upload new ServletFileUpload new DiskFileItemFactory Parse the request FileItem fileItem FileItem upload parseRequest req get 0 String fileName Util getFileName fileItem getName if equals fileName return new HttpRedirect advanced we allow the upload of the new jpi s and the legacy hpi s if fileName endsWith jpi fileName endsWith hpi throw new Failure hudson model Messages Hudson NotAPlugin fileName first copy into a temporary file name File t File createTempFile uploaded jpi t deleteOnExit fileItem write t fileItem delete final String baseName identifyPluginShortName t pluginUploaded true JSONArray dependencies new JSONArray try Manifest m new JarFile t getManifest String deps m getMainAttributes getValue Plugin Dependencies if StringUtils isNotBlank deps now we get to parse it String plugins deps split for String p plugins should have name version resolution optional String attrs p split dependencies add new JSONObject element name attrs 0 element version attrs 1 element optional p contains resolution optional catch IOException e LOGGER log WARNING Unable to setup dependency list for plugin upload e Now create a dummy plugin that we can dynamically load the InstallationJob will force a restart if one is needed JSONObject cfg new JSONObject element name baseName element version 0 unused but mandatory element url t toURI toString element dependencies dependencies new UpdateSite UpdateCenter ID UPLOAD null new Plugin UpdateCenter ID UPLOAD cfg deploy true return new HttpRedirect updateCenter catch IOException e throw e catch Exception e grrr fileItem write throws this throw new ServletException e Restricted NoExternalUse class RequirePOST public HttpResponse doCheckUpdatesServer throws IOException Jenkins getInstance checkPermission Jenkins ADMINISTER try for UpdateSite site Jenkins getInstance getUpdateCenter getSites FormValidation v site updateDirectlyNow DownloadService signatureCheck if v kind FormValidation Kind OK TODO crude but enough for now return v for DownloadService Downloadable d DownloadService Downloadable all FormValidation v d updateNow if v kind FormValidation Kind OK return v return HttpResponses forwardToPreviousPage catch RuntimeException ex throw new IOException Unhandled exception during updates server check ex protected String identifyPluginShortName File t try JarFile j new JarFile t try String name j getManifest getMainAttributes getValue Short Name if name null return name finally j close catch IOException e LOGGER log WARNING Failed to identify the short name from t e return FilenameUtils getBaseName t getName fall back to the base name of what s uploaded public Descriptor ProxyConfiguration getProxyDescriptor return Jenkins getInstance getDescriptor ProxyConfiguration class public List Future UpdateCenter UpdateCenterJob prevalidateConfig InputStream configXml throws IOException Jenkins getInstance checkPermission Jenkins ADMINISTER List Future UpdateCenter UpdateCenterJob jobs new ArrayList Future UpdateCenter UpdateCenterJob UpdateCenter uc Jenkins getInstance getUpdateCenter TODO call uc updateAllSites when available perhaps not since we should not block on network here for Map Entry String VersionNumber requestedPlugin parseRequestedPlugins configXml entrySet PluginWrapper pw getPlugin requestedPlugin getKey if pw null install new UpdateSite Plugin toInstall uc getPlugin requestedPlugin getKey if toInstall null LOGGER log WARNING No such plugin 0 to install requestedPlugin getKey continue if new VersionNumber toInstall version compareTo requestedPlugin getValue 0 LOGGER log WARNING 0 can only be satisfied in 1 new Object requestedPlugin toInstall version if toInstall isForNewerHudson LOGGER log WARNING 0 1 was built for a newer Jenkins new Object toInstall name toInstall version jobs add toInstall deploy true else if pw isOlderThan requestedPlugin getValue upgrade UpdateSite Plugin toInstall uc getPlugin requestedPlugin getKey if toInstall null LOGGER log WARNING No such plugin 0 to upgrade requestedPlugin getKey continue if pw isOlderThan new VersionNumber toInstall version LOGGER log WARNING 0 1 is no newer than what we already have new Object toInstall name toInstall version continue if new VersionNumber toInstall version compareTo requestedPlugin getValue 0 LOGGER log WARNING 0 can only be satisfied in 1 new Object requestedPlugin toInstall version if toInstall isForNewerHudson LOGGER log WARNING 0 1 was built for a newer Jenkins new Object toInstall name toInstall version if toInstall isCompatibleWithInstalledVersion LOGGER log WARNING 0 1 is incompatible with the installed 2 new Object toInstall name toInstall version pw getVersion jobs add toInstall deploy true dynamicLoad true sure to throw RestartRequiredException but at least message is nicer else already good return jobs RequirePOST public JSONArray doPrevalidateConfig StaplerRequest req throws IOException Jenkins getInstance checkPermission Jenkins ADMINISTER JSONArray response new JSONArray for Map Entry String VersionNumber p parseRequestedPlugins req getInputStream entrySet PluginWrapper pw getPlugin p getKey JSONObject j new JSONObject accumulate name p getKey accumulate version p getValue toString if pw null install new response add j accumulate mode missing else if pw isOlderThan p getValue upgrade response add j accumulate mode old else already good return response RequirePOST public HttpResponse doInstallNecessaryPlugins StaplerRequest req throws IOException prevalidateConfig req getInputStream return HttpResponses redirectViaContextPath updateCenter public Map String VersionNumber parseRequestedPlugins InputStream configXml throws IOException final Map String VersionNumber requestedPlugins new TreeMap String VersionNumber try SAXParserFactory newInstance newSAXParser parse configXml new DefaultHandler Override public void startElement String uri String localName String qName Attributes attributes throws SAXException String plugin attributes getValue plugin if plugin null return if plugin matches throw new SAXException Malformed plugin attribute plugin int at plugin indexOf String shortName plugin substring 0 at VersionNumber existing requestedPlugins get shortName VersionNumber requested new VersionNumber plugin substring at 1 if existing null existing compareTo requested 0 requestedPlugins put shortName requested Override public InputSource resolveEntity String publicId String systemId throws IOException SAXException return RestrictiveEntityResolver INSTANCE resolveEntity publicId systemId catch SAXException x throw new IOException Failed to parse XML x catch ParserConfigurationException e throw new AssertionError e impossible since we don t tweak XMLParser return requestedPlugins public final class UberClassLoader extends ClassLoader private ConcurrentMap String WeakReference Class generatedClasses new ConcurrentHashMap String WeakReference Class private final Map String Class loaded new HashMap String Class public UberClassLoader super PluginManager class getClassLoader public void addNamedClass String className Class c generatedClasses put className new WeakReference Class c Override protected Class findClass String name throws ClassNotFoundException WeakReference Class wc generatedClasses get name if wc null Class c wc get if c null return c else generatedClasses remove name wc if name startsWith SimpleTemplateScript cf groovy text SimpleTemplateEngine throw new ClassNotFoundException ignoring name synchronized loaded if loaded containsKey name Class c loaded get name if c null return c else throw new ClassNotFoundException cached miss for name if FAST LOOKUP for PluginWrapper p activePlugins try Class c ClassLoaderReflectionToolkit findLoadedClass p classLoader name if c null synchronized loaded loaded put name c return c calling findClass twice appears to cause LinkageError duplicate class def c ClassLoaderReflectionToolkit findClass p classLoader name synchronized loaded loaded put name c return c catch ClassNotFoundException e not found try next else for PluginWrapper p activePlugins try return p classLoader loadClass name catch ClassNotFoundException e not found try next synchronized loaded loaded put name null not found in any of the classloader delegate throw new ClassNotFoundException name Override protected URL findResource String name if FAST LOOKUP for PluginWrapper p activePlugins URL url ClassLoaderReflectionToolkit findResource p classLoader name if url null return url else for PluginWrapper p activePlugins URL url p classLoader getResource name if url null return url return null Override protected Enumeration URL findResources String name throws IOException List URL resources new ArrayList URL if FAST LOOKUP for PluginWrapper p activePlugins resources addAll Collections list ClassLoaderReflectionToolkit findResources p classLoader name else for PluginWrapper p activePlugins resources addAll Collections list p classLoader getResources name return Collections enumeration resources Override public String toString only for debugging purpose return classLoader getClass getName private static final Logger LOGGER Logger getLogger PluginManager class getName public static boolean FAST LOOKUP SystemProperties getBoolean PluginManager class getName noFastLookup public static final Permission UPLOAD PLUGINS new Permission Jenkins PERMISSIONS UploadPlugins Messages PluginManager UploadPluginsPermission Description Jenkins ADMINISTER PermissionScope JENKINS public static final Permission CONFIGURE UPDATECENTER new Permission Jenkins PERMISSIONS ConfigureUpdateCenter Messages PluginManager ConfigureUpdateCenterPermission Description Jenkins ADMINISTER PermissionScope JENKINS public static final class FailedPlugin public final String name public final Exception cause public FailedPlugin String name Exception cause this name name this cause cause public String getExceptionString return Functions printThrowable cause static final class PluginInstanceStore final Map PluginWrapper Plugin store new Hashtable PluginWrapper Plugin Extension Symbol pluginCycleDependencies public static final class PluginCycleDependenciesMonitor extends AdministrativeMonitor Override public String getDisplayName return Messages PluginManager PluginCycleDependenciesMonitor DisplayName private transient volatile boolean isActive false private transient volatile List PluginWrapper pluginsWithCycle public boolean isActivated if pluginsWithCycle null pluginsWithCycle new ArrayList for PluginWrapper p Jenkins getInstance getPluginManager getPlugins if p hasCycleDependency pluginsWithCycle add p isActive true return isActive public List PluginWrapper getPluginsWithCycle return pluginsWithCycle Extension Symbol pluginUpdate public static final class PluginUpdateMonitor extends AdministrativeMonitor private Map String PluginUpdateInfo pluginsToBeUpdated new HashMap String PluginManager PluginUpdateMonitor PluginUpdateInfo public static final PluginUpdateMonitor getInstance return ExtensionList lookup PluginUpdateMonitor class get 0 public void ifPluginOlderThenReport String pluginName String requiredVersion String message Plugin plugin Jenkins getInstance getPlugin pluginName if plugin null if plugin getWrapper getVersionNumber isOlderThan new VersionNumber requiredVersion pluginsToBeUpdated put pluginName new PluginUpdateInfo pluginName message public boolean isActivated return pluginsToBeUpdated isEmpty Override public String getDisplayName return Messages PluginManager PluginUpdateMonitor DisplayName public void addPluginToUpdate String pluginName String message this pluginsToBeUpdated put pluginName new PluginUpdateInfo pluginName message public Collection PluginUpdateInfo getPluginsToBeUpdated return pluginsToBeUpdated values public static class PluginUpdateInfo public final String pluginName public final String message private PluginUpdateInfo String pluginName String message this pluginName pluginName this message messagepackage hudson import javax annotation Nonnull public abstract class PluginManagerStaplerOverride implements ExtensionPoint public static Nonnull ExtensionList PluginManagerStaplerOverride all return ExtensionList lookup PluginManagerStaplerOverride classpackage hudson util import hudson ExtensionPoint import hudson security SecurityRealm import java util ArrayList import jenkins model Jenkins import javax annotation CheckForNull import javax servlet Filter import javax servlet FilterChain import javax servlet FilterConfig import javax servlet ServletContext import javax servlet ServletException import javax servlet ServletRequest import javax servlet ServletResponse import java io IOException import java util Iterator import java util List import java util Vector import java util concurrent CopyOnWriteArrayList import java util logging Level import java util logging Logger import org kohsuke accmod Restricted import org kohsuke accmod restrictions NoExternalUse public class PluginServletFilter implements Filter ExtensionPoint private final List Filter list new CopyOnWriteArrayList Filter private FilterConfig config private static final List Filter LEGACY new Vector Filter private static final String KEY PluginServletFilter class getName private static CheckForNull PluginServletFilter getInstance ServletContext c return PluginServletFilter c getAttribute KEY public void init FilterConfig config throws ServletException this config config synchronized LEGACY list addAll LEGACY LEGACY clear for Filter f list f init config config getServletContext setAttribute KEY this public static void addFilter Filter filter throws ServletException Jenkins j Jenkins getInstanceOrNull PluginServletFilter container null if j null container getInstance j servletContext https marvelution atlassian net browse JJI 188 if j null container null report who is doing legacy registration LOGGER log Level WARNING Filter instance is registered too early filter new Exception LEGACY add filter else filter init container config container list add filter public static void removeFilter Filter filter throws ServletException Jenkins j Jenkins getInstanceOrNull if j null getInstance j servletContext null LEGACY remove filter else getInstance j servletContext list remove filter public void doFilter ServletRequest request ServletResponse response final FilterChain chain throws IOException ServletException new FilterChain private final Iterator Filter itr list iterator public void doFilter ServletRequest request ServletResponse response throws IOException ServletException if itr hasNext call next itr next doFilter request response this else reached to the end chain doFilter request response doFilter request response public void destroy for Filter f list f destroy list clear Restricted NoExternalUse class public static void cleanUp PluginServletFilter instance getInstance Jenkins getInstance servletContext if instance null While we could rely on the current implementation of list being a CopyOnWriteArrayList safer to just take an explicit copy of the list and operate on the copy for Filter f new ArrayList instance list instance list remove f remove from the list even if destroy fails as a failed destroy is still a destroy try f destroy catch RuntimeException e LOGGER log Level WARNING Filter f propagated an exception from its destroy method e catch Error e throw e we are not supposed to catch errors don t log as could be an OOM catch Throwable e LOGGER log Level SEVERE Filter f propagated an exception from its destroy method e if some fool adds a filter while we are terminating we should just log the fact if instance list isEmpty LOGGER log Level SEVERE The following filters appear to have been added during clean up 0 instance list private static final Logger LOGGER Logger getLogger PluginServletFilter class getNamepackage jenkins management import hudson Extension import hudson model ManagementLink import org jenkinsci Symbol Extension ordinal Integer MAX VALUE 400 Symbol plugins public class PluginsLink extends ManagementLink Override public String getIconFileName return plugin png public String getDisplayName return Messages PluginsLink DisplayName Override public String getDescription return Messages PluginsLink Description Override public String getUrlName return pluginManagerpackage hudson import hudson model Hudson import java io File import java io IOException import java util List import javax annotation Nonnull public interface PluginStrategy extends ExtensionPoint PluginWrapper createPluginWrapper File archive throws IOException Nonnull String getShortName File archive throws IOException void load PluginWrapper wrapper throws IOException void initializeComponents PluginWrapper plugin T List ExtensionComponent T findComponents Class T type Hudson hudson void updateDependency PluginWrapper depender PluginWrapper dependeepackage jenkins import hudson Plugin import org kohsuke MetaInfServices import javax annotation processing AbstractProcessor import javax annotation processing Processor import javax annotation processing RoundEnvironment import javax annotation processing SupportedAnnotationTypes import javax lang model SourceVersion import javax lang model element Element import javax lang model element ElementKind import javax lang model element Modifier import javax lang model element TypeElement import javax lang model type TypeMirror import javax lang model util ElementScanner6 import javax tools Diagnostic Kind import javax tools FileObject import javax tools StandardLocation import java io IOException import java io OutputStreamWriter import java io PrintWriter import java io StringWriter import java io Writer import java util Set SupportedAnnotationTypes MetaInfServices Processor class SuppressWarnings Since15 public class PluginSubtypeMarker extends AbstractProcessor Override public boolean process Set extends TypeElement annotations RoundEnvironment roundEnv try ElementScanner6 Void Void scanner new ElementScanner6 Void Void Override public Void visitType TypeElement e Void aVoid if e getModifiers contains Modifier ABSTRACT Element sc asElement e getSuperclass if sc null TypeElement sc getQualifiedName contentEquals hudson Plugin try write e catch IOException x StringWriter sw new StringWriter x printStackTrace new PrintWriter sw processingEnv getMessager printMessage Kind ERROR sw toString e return super visitType e aVoid Override public Void visitUnknown Element e Void aVoid return DEFAULT VALUE for Element e roundEnv getRootElements if e getKind ElementKind PACKAGE JENKINS 11739 continue scanner scan e null return false catch RuntimeException e javac sucks at reporting errors in annotation processors e printStackTrace throw e catch Error e e printStackTrace throw e Override public SourceVersion getSupportedSourceVersion return SourceVersion latest private void write TypeElement c throws IOException FileObject f processingEnv getFiler createResource StandardLocation CLASS OUTPUT META INF services hudson Plugin try Writer w new OutputStreamWriter f openOutputStream UTF 8 w write c getQualifiedName toString private Element asElement TypeMirror m return processingEnv getTypeUtils asElement mpackage hudson import com google common collect ImmutableSet import hudson PluginManager PluginInstanceStore import hudson model AdministrativeMonitor import hudson model Api import hudson model ModelObject import jenkins YesNoMaybe import jenkins model Jenkins import hudson model UpdateCenter import hudson model UpdateSite import hudson util VersionNumber import org jvnet localizer ResourceBundleHolder import org kohsuke stapler HttpResponse import org kohsuke stapler HttpResponses import org kohsuke stapler StaplerRequest import org kohsuke stapler StaplerResponse import org kohsuke stapler export Exported import org kohsuke stapler export ExportedBean import org kohsuke stapler interceptor RequirePOST import org apache commons lang StringUtils import org apache commons logging LogFactory import javax annotation CheckForNull import javax annotation Nonnull import java io Closeable import java io File import java io FileOutputStream import java io IOException import java io OutputStream import java net URL import java util ArrayList import java util Arrays import java util Collection import java util Collections import java util Enumeration import java util HashMap import java util HashSet import java util Iterator import java util List import java util Map import java util Set import java util jar JarFile import java util jar Manifest import java util logging Level import java util logging Logger import static java util logging Level WARNING import static org apache commons io FilenameUtils getBaseName ExportedBean public class PluginWrapper implements Comparable PluginWrapper ModelObject private static final boolean ENABLE PLUGIN DEPENDENCIES VERSION CHECK Boolean parseBoolean System getProperty PluginWrapper class getName dependenciesVersionCheck enabled true public final PluginManager parent private final Manifest manifest public final ClassLoader classLoader public final URL baseResourceURL private final File disableFile private final File archive private final String shortName private final boolean active private boolean hasCycleDependency false private final List Dependency dependencies private final List Dependency optionalDependencies public List String getDependencyErrors return Collections unmodifiableList dependencyErrors private final transient List String dependencyErrors new ArrayList boolean isBundled private Set String dependants Collections emptySet private static Set String CORE ONLY DEPENDANT ImmutableSet copyOf Arrays asList jenkins core public void setDependants Nonnull Set String dependants this dependants dependants public Nonnull Set String getDependants if isBundled dependants isEmpty return CORE ONLY DEPENDANT else return dependants public boolean hasDependants return isBundled dependants isEmpty public boolean hasDependencies return dependencies null dependencies isEmpty ExportedBean public static final class Dependency Exported public final String shortName Exported public final String version Exported public final boolean optional public Dependency String s int idx s indexOf if idx 1 throw new IllegalArgumentException Illegal dependency specifier s this shortName s substring 0 idx String version s substring idx 1 boolean isOptional false String osgiProperties version split for int i 1 i osgiProperties length i String osgiProperty osgiProperties i trim if osgiProperty equalsIgnoreCase resolution optional isOptional true this optional isOptional if isOptional this version osgiProperties 0 else this version version Override public String toString return shortName version optional optional public PluginWrapper PluginManager parent File archive Manifest manifest URL baseResourceURL ClassLoader classLoader File disableFile List Dependency dependencies List Dependency optionalDependencies this parent parent this manifest manifest this shortName computeShortName manifest archive getName this baseResourceURL baseResourceURL this classLoader classLoader this disableFile disableFile this active disableFile exists this dependencies dependencies this optionalDependencies optionalDependencies this archive archive public String getDisplayName return StringUtils removeStart getLongName Jenkins public Api getApi Jenkins getInstance checkPermission Jenkins ADMINISTER return new Api this public URL getIndexPage In the current impl dependencies are checked first so the plugin itself will add the last entry in the getResources result URL idx null try Enumeration URL en classLoader getResources index jelly while en hasMoreElements idx en nextElement catch IOException ignore In case plugin has dependencies but is missing its own index jelly check that result has this plugin s artifactId in it return idx null idx toString contains shortName idx null static String computeShortName Manifest manifest String fileName use the name captured in the manifest as often plugins depend on the specific short name in its URLs String n manifest getMainAttributes getValue Short Name if n null return n maven seems to put this automatically so good fallback to check n manifest getMainAttributes getValue Extension Name if n null return n otherwise infer from the file name since older plugins don t have this entry return getBaseName fileName Exported public List Dependency getDependencies return dependencies public List Dependency getOptionalDependencies return optionalDependencies Exported public String getShortName return shortName public CheckForNull Plugin getPlugin PluginInstanceStore pis Jenkins lookup PluginInstanceStore class return pis null pis store get this null Exported public String getUrl first look for the manifest entry This is new in maven hpi plugin 1 30 String url manifest getMainAttributes getValue Url if url null return url fallback to update center metadata UpdateSite Plugin ui getInfo if ui null return ui wiki return null Override public String toString return Plugin getShortName Exported public String getLongName String name manifest getMainAttributes getValue Long Name if name null return name return shortName Exported public YesNoMaybe supportsDynamicLoad String v manifest getMainAttributes getValue Support Dynamic Loading if v null return YesNoMaybe MAYBE return Boolean parseBoolean v YesNoMaybe YES YesNoMaybe NO Exported public String getVersion return getVersionOf manifest private String getVersionOf Manifest manifest String v manifest getMainAttributes getValue Plugin Version if v null return v plugins generated before maven hpi plugin 1 3 should still have this attribute v manifest getMainAttributes getValue Implementation Version if v null return v return Exported public CheckForNull String getRequiredCoreVersion String v manifest getMainAttributes getValue Jenkins Version if v null return v v manifest getMainAttributes getValue Hudson Version if v null return v return null public VersionNumber getVersionNumber return new VersionNumber getVersion public boolean isOlderThan VersionNumber v try return getVersionNumber compareTo v 0 catch IllegalArgumentException e if we can t figure out our current version it probably means it s very old since the version information is missing only from the very old plugins return true public void stop Plugin plugin getPlugin if plugin null try LOGGER log Level FINE Stopping 0 shortName plugin stop catch Throwable t LOGGER log WARNING Failed to shut down shortName t else LOGGER log Level FINE Could not find Plugin instance to stop for 0 shortName Work around a bug in commons logging See http www szegedi org articles memleak html LogFactory release classLoader public void releaseClassLoader if classLoader instanceof Closeable try Closeable classLoader close catch IOException e LOGGER log WARNING Failed to shut down classloader e public void enable throws IOException if disableFile exists LOGGER log Level FINEST Plugin 0 has been already enabled Skipping the enable operation getShortName return if disableFile delete throw new IOException Failed to delete disableFile public void disable throws IOException creates an empty file OutputStream os new FileOutputStream disableFile os close Exported public boolean isActive return active hasCycleDependency public boolean hasCycleDependency return hasCycleDependency public void setHasCycleDependency boolean hasCycle hasCycleDependency hasCycle Exported public boolean isBundled return isBundled Exported public boolean isEnabled return disableFile exists public Manifest getManifest return manifest public void setPlugin Plugin plugin Jenkins lookup PluginInstanceStore class store put this plugin plugin wrapper this public String getPluginClass return manifest getMainAttributes getValue Plugin Class public boolean hasLicensesXml try new URL baseResourceURL WEB INF licenses xml openStream close return true catch IOException e return false void resolvePluginDependencies throws IOException if ENABLE PLUGIN DEPENDENCIES VERSION CHECK String requiredCoreVersion getRequiredCoreVersion if requiredCoreVersion null LOGGER warning shortName doesn t declare required core version else VersionNumber actualVersion Jenkins getVersion if actualVersion isOlderThan new VersionNumber requiredCoreVersion dependencyErrors add Messages PluginWrapper obsoleteCore Jenkins getVersion toString requiredCoreVersion make sure dependencies exist for Dependency d dependencies PluginWrapper dependency parent getPlugin d shortName if dependency null PluginWrapper failedDependency NOTICE getPlugin d shortName if failedDependency null dependencyErrors add Messages PluginWrapper failed to load dependency failedDependency getLongName d version break else dependencyErrors add Messages PluginWrapper missing d shortName d version else if dependency isActive if isDependencyObsolete d dependency dependencyErrors add Messages PluginWrapper obsolete dependency getLongName dependency getVersion d version else if isDependencyObsolete d dependency dependencyErrors add Messages PluginWrapper disabledAndObsolete dependency getLongName dependency getVersion d version else dependencyErrors add Messages PluginWrapper disabled dependency getLongName add the optional dependencies that exists for Dependency d optionalDependencies PluginWrapper dependency parent getPlugin d shortName if dependency null dependency isActive if isDependencyObsolete d dependency dependencyErrors add Messages PluginWrapper obsolete dependency getLongName dependency getVersion d version else dependencies add d if dependencyErrors isEmpty NOTICE addPlugin this StringBuilder messageBuilder new StringBuilder messageBuilder append Messages PluginWrapper failed to load plugin getLongName getVersion append System lineSeparator for Iterator String iterator dependencyErrors iterator iterator hasNext String dependencyError iterator next messageBuilder append append dependencyError if iterator hasNext messageBuilder append System lineSeparator throw new IOException messageBuilder toString private boolean isDependencyObsolete Dependency d PluginWrapper dependency return ENABLE PLUGIN DEPENDENCIES VERSION CHECK dependency getVersionNumber isOlderThan new VersionNumber d version public UpdateSite Plugin getUpdateInfo UpdateCenter uc Jenkins getInstance getUpdateCenter UpdateSite Plugin p uc getPlugin getShortName if p null p isNewerThan getVersion return p return null public UpdateSite Plugin getInfo UpdateCenter uc Jenkins getInstance getUpdateCenter return uc getPlugin getShortName Exported public boolean hasUpdate return getUpdateInfo null Exported Deprecated See https groups google com d msg jenkinsci dev kRobm cxFw8 6V66uhibAwAJ public boolean isPinned return false Exported public boolean isDeleted return archive exists public int compareTo PluginWrapper pw return shortName compareToIgnoreCase pw shortName Exported public boolean isDowngradable return getBackupFile exists public File getBackupFile return new File Jenkins getInstance getRootDir plugins getShortName bak Exported public String getBackupVersion File backup getBackupFile if backup exists try try JarFile backupPlugin new JarFile backup return backupPlugin getManifest getMainAttributes getValue Plugin Version catch IOException e LOGGER log WARNING Failed to get backup version from backup e return null else return null Deprecated See https groups google com d msg jenkinsci dev kRobm cxFw8 6V66uhibAwAJ public boolean isPinningForcingOldVersion return false Extension public final static PluginWrapperAdministrativeMonitor NOTICE new PluginWrapperAdministrativeMonitor public static final class PluginWrapperAdministrativeMonitor extends AdministrativeMonitor private final Map String PluginWrapper plugins new HashMap void addPlugin PluginWrapper plugin plugins put plugin shortName plugin public boolean isActivated return plugins isEmpty Override public String getDisplayName return Messages PluginWrapper PluginWrapperAdministrativeMonitor DisplayName public Collection PluginWrapper getPlugins return plugins values public PluginWrapper getPlugin String shortName return plugins get shortName public void doAct StaplerRequest req StaplerResponse rsp throws IOException if req hasParameter correct rsp sendRedirect req getContextPath pluginManager public static PluginWrapperAdministrativeMonitor get return AdministrativeMonitor all get PluginWrapperAdministrativeMonitor class Action methods RequirePOST public HttpResponse doMakeEnabled throws IOException Jenkins getInstance checkPermission Jenkins ADMINISTER enable return HttpResponses ok RequirePOST public HttpResponse doMakeDisabled throws IOException Jenkins getInstance checkPermission Jenkins ADMINISTER disable return HttpResponses ok RequirePOST Deprecated public HttpResponse doPin throws IOException Jenkins getInstance checkPermission Jenkins ADMINISTER See https groups google com d msg jenkinsci dev kRobm cxFw8 6V66uhibAwAJ LOGGER log WARNING Call to pin plugin has been ignored Plugin name shortName return HttpResponses ok RequirePOST Deprecated public HttpResponse doUnpin throws IOException Jenkins getInstance checkPermission Jenkins ADMINISTER See https groups google com d msg jenkinsci dev kRobm cxFw8 6V66uhibAwAJ LOGGER log WARNING Call to unpin plugin has been ignored Plugin name shortName return HttpResponses ok RequirePOST public HttpResponse doDoUninstall throws IOException Jenkins jenkins Jenkins getActiveInstance jenkins checkPermission Jenkins ADMINISTER archive delete Redo who depends on who jenkins getPluginManager resolveDependantPlugins return HttpResponses redirectViaContextPath pluginManager installed send back to plugin manager private static final Logger LOGGER Logger getLogger PluginWrapper class getName public static final String MANIFEST FILENAME META INF MANIFEST MFpackage hudson scm import hudson model AbstractProject import hudson model TaskListener import hudson Launcher import hudson FilePath import javax annotation CheckForNull import javax annotation Nonnull import java io Serializable public final class PollingResult implements Serializable public final CheckForNull SCMRevisionState baseline public final CheckForNull SCMRevisionState remote public final Nonnull Change change public enum Change NONE INSIGNIFICANT SIGNIFICANT INCOMPARABLE public PollingResult CheckForNull SCMRevisionState baseline CheckForNull SCMRevisionState remote Nonnull Change change if change null throw new IllegalArgumentException this baseline baseline this remote remote this change change public PollingResult Nonnull Change change this null null change public boolean hasChanges return change ordinal Change INSIGNIFICANT ordinal public static final PollingResult NO CHANGES new PollingResult Change NONE public static final PollingResult SIGNIFICANT new PollingResult Change SIGNIFICANT public static final PollingResult BUILD NOW new PollingResult Change INCOMPARABLE private static final long serialVersionUID 1Lpackage hudson os import java io File import java io InputStream import java io PrintStream import java util Map import java util logging Logger import jnr constants platform Errno import jnr posix POSIX import jnr posix POSIXFactory import jnr posix util DefaultPOSIXHandler public class PosixAPI private static POSIX posix public static synchronized POSIX jnr if posix null posix POSIXFactory getPOSIX new DefaultPOSIXHandler Override public void error Errno error String extraData throw new PosixException native error error description extraData convert error Override public void error Errno error String methodName String extraData throw new PosixException native error calling methodName error description extraData convert error private org jruby ext posix POSIX ERRORS convert Errno error try return org jruby ext posix POSIX ERRORS valueOf error name catch IllegalArgumentException x return org jruby ext posix POSIX ERRORS EIO PosixException message has real error anyway true return posix Deprecated public boolean isNative return supportsNative Deprecated public static boolean supportsNative return jnaPosix instanceof org jruby ext posix JavaPOSIX private static org jruby ext posix POSIX jnaPosix Deprecated public static synchronized org jruby ext posix POSIX get if jnaPosix null jnaPosix org jruby ext posix POSIXFactory getPOSIX new org jruby ext posix POSIXHandler public void error org jruby ext posix POSIX ERRORS errors String s throw new PosixException s errors public void unimplementedError String s throw new UnsupportedOperationException s public void warn WARNING ID warning id String s Object objects LOGGER fine s public boolean isVerbose return true public File getCurrentWorkingDirectory return new File getAbsoluteFile public String getEnv Map String String envs System getenv String envp new String envs size int i 0 for Map Entry String String e envs entrySet envp i e getKey e getValue return envp public InputStream getInputStream return System in public PrintStream getOutputStream return System out public int getPID TODO return 0 public PrintStream getErrorStream return System err true return jnaPosix private static final Logger LOGGER Logger getLogger PosixAPI class getNamepackage hudson os import org jruby ext posix POSIX ERRORS public class PosixException extends RuntimeException private final ERRORS errors public PosixException String message ERRORS errors super message this errors errors Deprecated public ERRORS getErrorCode return errors Override public String toString return super toString errorspackage hudson cli import static java util logging Level FINE import java io Console import java io DataInputStream import java io File import java io FileInputStream import java io IOException import java security GeneralSecurityException import java security KeyFactory import java security KeyPair import java security spec DSAPrivateKeySpec import java security spec DSAPublicKeySpec import java util ArrayList import java util Collections import java util List import java util logging Logger import com trilead ssh2 crypto PEMDecoder public class PrivateKeyProvider private List KeyPair privateKeys new ArrayList KeyPair public List KeyPair getKeys return Collections unmodifiableList privateKeys public boolean hasKeys return privateKeys isEmpty public boolean readFromDefaultLocations final File home new File System getProperty user home boolean read false for String path new String ssh id rsa ssh id dsa ssh identity final File key new File home path if key exists continue try readFrom key read true catch IOException e LOGGER log FINE Failed to load key e catch GeneralSecurityException e LOGGER log FINE Failed to load key e return read public void readFrom File keyFile throws IOException GeneralSecurityException final String password isPemEncrypted keyFile askForPasswd keyFile getCanonicalPath null privateKeys add loadKey keyFile password private static boolean isPemEncrypted File f throws IOException simple check if the file is encrypted return readPemFile f contains 4 ENCRYPTED private static String askForPasswd String filePath Console cons System console String passwd null if cons null char p cons readPassword s Enter passphrase for filePath passwd String valueOf p return passwd public static KeyPair loadKey File f String passwd throws IOException GeneralSecurityException return loadKey readPemFile f passwd private static String readPemFile File f throws IOException try FileInputStream is new FileInputStream f DataInputStream dis new DataInputStream is byte bytes new byte int f length dis readFully bytes return new String bytes public static KeyPair loadKey String pemString String passwd throws IOException GeneralSecurityException Object key PEMDecoder decode pemString toCharArray passwd if key instanceof com trilead ssh2 signature RSAPrivateKey com trilead ssh2 signature RSAPrivateKey x com trilead ssh2 signature RSAPrivateKey key return x toJCEKeyPair if key instanceof com trilead ssh2 signature DSAPrivateKey com trilead ssh2 signature DSAPrivateKey x com trilead ssh2 signature DSAPrivateKey key KeyFactory kf KeyFactory getInstance DSA return new KeyPair kf generatePublic new DSAPublicKeySpec x getY x getP x getQ x getG kf generatePrivate new DSAPrivateKeySpec x getX x getP x getQ x getG throw new UnsupportedOperationException Unrecognizable key format key private static final Logger LOGGER Logger getLogger PrivateKeyProvider class getNamepackage hudson cli import static org mockito Mockito verify import static org powermock api mockito PowerMockito doReturn import static org powermock api mockito PowerMockito mock import static org powermock api mockito PowerMockito mockStatic import static org powermock api mockito PowerMockito whenNew import java io File import java io IOException import java net URISyntaxException import java net URL import java security GeneralSecurityException import java security Key import java security KeyPair import java util Arrays import org hamcrest Description import org junit Test import org junit runner RunWith import org mockito ArgumentMatcher import org mockito Mockito import org powermock core classloader annotations PrepareForTest import org powermock modules junit4 PowerMockRunner RunWith PowerMockRunner class PrepareForTest CLI class When mocking new operator caller has to be PreparedForTest not class itself public class PrivateKeyProviderTest Test public void specifyKeysExplicitly throws Exception final CLI cli fakeCLI final File dsaKey keyFile ssh id dsa final File rsaKey keyFile ssh id rsa run i dsaKey getAbsolutePath i rsaKey getAbsolutePath s http example com verify cli authenticate withKeyPairs keyPair dsaKey keyPair rsaKey Test public void useDefaultKeyLocations throws Exception final CLI cli fakeCLI final File rsaKey keyFile ssh id rsa final File dsaKey keyFile ssh id dsa fakeHome run s http example com verify cli authenticate withKeyPairs keyPair rsaKey keyPair dsaKey private CLI fakeCLI throws Exception final CLI cli mock CLI class final CLIConnectionFactory factory mock CLIConnectionFactory class Mockito CALLS REAL METHODS factory jenkins new URL http example com doReturn cli when factory connect mockStatic CLIConnectionFactory class whenNew CLIConnectionFactory class withNoArguments thenReturn factory return cli private void fakeHome throws URISyntaxException final File home new File this getClass getResource ssh toURI getParentFile System setProperty user home home getAbsolutePath private int run String args throws Exception return CLI main args private File keyFile String name throws URISyntaxException return new File this getClass getResource name toURI private KeyPair keyPair File file throws IOException GeneralSecurityException return PrivateKeyProvider loadKey file null private Iterable KeyPair withKeyPairs final KeyPair expected return Mockito argThat new ArgumentMatcher Iterable KeyPair Override public void describeTo Description description description appendText Arrays asList expected toString Override public boolean matches Object argument if argument instanceof Iterable throw new IllegalArgumentException Not an instance of Iterrable SuppressWarnings unchecked final Iterable KeyPair actual Iterable KeyPair argument int i 0 for KeyPair akp actual if eq expected i getPublic akp getPublic return false if eq expected i getPrivate akp getPrivate return false i return i expected length private boolean eq final Key expected final Key actual return Arrays equals expected getEncoded actual getEncodedpackage hudson import hudson Launcher ProcStarter import hudson model TaskListener import hudson remoting Channel import hudson util DaemonThreadFactory import hudson util ExceptionCatchingThreadFactory import hudson util NamingThreadFactory import hudson util NullStream import hudson util StreamCopyThread import hudson util ProcessTree import org apache commons io input NullInputStream import java io File import java io IOException import java io InputStream import java io OutputStream import java util Locale import java util Map import java util concurrent CancellationException import java util concurrent CountDownLatch import java util concurrent ExecutionException import java util concurrent ExecutorService import java util concurrent Executors import java util concurrent Future import java util concurrent TimeUnit import java util logging Level import java util logging Logger public abstract class Proc protected Proc public abstract boolean isAlive throws IOException InterruptedException public abstract void kill throws IOException InterruptedException public abstract int join throws IOException InterruptedException public abstract InputStream getStdout public abstract InputStream getStderr public abstract OutputStream getStdin private static final ExecutorService executor Executors newCachedThreadPool new ExceptionCatchingThreadFactory new NamingThreadFactory new DaemonThreadFactory Proc executor public final int joinWithTimeout final long timeout final TimeUnit unit final TaskListener listener throws IOException InterruptedException final CountDownLatch latch new CountDownLatch 1 try executor submit new Runnable public void run try if latch await timeout unit listener error Timeout after timeout unit toString toLowerCase Locale ENGLISH kill catch InterruptedException IOException RuntimeException x x printStackTrace listener error Failed to join a process return join finally latch countDown public static final class LocalProc extends Proc private final Process proc private final Thread copier copier2 private final OutputStream out private final EnvVars cookie private final String name private final InputStream stdout stderr private final OutputStream stdin public LocalProc String cmd Map String String env OutputStream out File workDir throws IOException this cmd Util mapToEnv env out workDir public LocalProc String cmd Map String String env InputStream in OutputStream out throws IOException this cmd Util mapToEnv env in out public LocalProc String cmd String env OutputStream out File workDir throws IOException this Util tokenize cmd env out workDir public LocalProc String cmd String env OutputStream out File workDir throws IOException this cmd env null out workDir public LocalProc String cmd String env InputStream in OutputStream out throws IOException this cmd env in out null public LocalProc String cmd String env InputStream in OutputStream out File workDir throws IOException this cmd env in out null workDir public LocalProc String cmd String env InputStream in OutputStream out OutputStream err File workDir throws IOException this calcName cmd stderr environment new ProcessBuilder cmd env directory workDir err null err SELFPUMP OUTPUT in out err private static ProcessBuilder stderr ProcessBuilder pb boolean redirectError if redirectError pb redirectErrorStream true return pb private static ProcessBuilder environment ProcessBuilder pb String env if env null Map String String m pb environment m clear for String e env int idx e indexOf m put e substring 0 idx e substring idx 1 e length return pb private LocalProc String name ProcessBuilder procBuilder InputStream in OutputStream out OutputStream err throws IOException Logger getLogger Proc class getName log Level FINE Running 0 name this name name this out out this cookie EnvVars createCookie procBuilder environment putAll cookie if procBuilder directory null procBuilder directory exists throw new IOException String format Process working directory s doesn t exist procBuilder directory getAbsolutePath this proc procBuilder start InputStream procInputStream proc getInputStream if out SELFPUMP OUTPUT stdout procInputStream copier null else copier new StreamCopyThread name stdout copier procInputStream out copier start stdout null if in null nothing to feed to stdin stdin null proc getOutputStream close else if in SELFPUMP INPUT stdin proc getOutputStream else new StdinCopyThread name stdin copier in proc getOutputStream start stdin null InputStream procErrorStream proc getErrorStream if err null if err SELFPUMP OUTPUT stderr procErrorStream copier2 null else stderr null copier2 new StreamCopyThread name stderr copier procErrorStream err copier2 start else the javadoc is unclear about what getErrorStream returns when ProcessBuilder redirectErrorStream true according to the source code Sun JREs still still returns a distinct reader end of a pipe that needs to be closed but apparently at least on some IBM JDK5 returned input and error streams are the same so try to close them smartly if procErrorStream procInputStream procErrorStream close copier2 null stderr null public InputStream getStdout return stdout public InputStream getStderr return stderr public OutputStream getStdin return stdin Override public int join throws InterruptedException IOException show what we are waiting for in the thread title since this involves some native work let s have some soak period before enabling this by default Thread t Thread currentThread String oldName t getName if SHOW PID ProcessTree OSProcess p ProcessTree get get proc t setName oldName p null waiting for pid p getPid waiting for name try int r proc waitFor see http wiki jenkins ci org display JENKINS Spawning processes from build problems like that shows up as infinite wait in join which confuses great many users So let s do a timed wait here and try to diagnose the problem if copier null copier join 10 1000 if copier2 null copier2 join 10 1000 if copier null copier isAlive copier2 null copier2 isAlive looks like handles are leaking closing these handles should terminate the threads String msg Process leaked file descriptors See http wiki jenkins ci org display JENKINS Spawning processes from build for more information Throwable e new Exception fillInStackTrace LOGGER log Level WARNING msg e doing proc getInputStream close hangs in FileInputStream close0 it could be either because another thread is blocking on read or it could be a bug in Windows JVM Who knows so I m abandoning the idea of closing the stream try proc getInputStream close catch IOException x LOGGER log Level FINE stdin termination failed x try proc getErrorStream close catch IOException x LOGGER log Level FINE stderr termination failed x out write msg getBytes out write n return r catch InterruptedException e aborting kill the process destroy throw e finally t setName oldName Override public boolean isAlive throws IOException InterruptedException try proc exitValue return false catch IllegalThreadStateException e return true Override public void kill throws InterruptedException IOException destroy join private void destroy throws InterruptedException ProcessTree get killAll proc cookie private static class StdinCopyThread extends Thread private final InputStream in private final OutputStream out public StdinCopyThread String threadName InputStream in OutputStream out super threadName this in in this out out Override public void run try try byte buf new byte 8192 int len while len in read buf 0 out write buf 0 len out flush finally in close out close catch IOException e TODO what to do private static String calcName String cmd StringBuilder buf new StringBuilder for String token cmd if buf length 0 buf append buf append token return buf toString public static final InputStream SELFPUMP INPUT new NullInputStream 0 public static final OutputStream SELFPUMP OUTPUT new NullStream Deprecated public static final class RemoteProc extends Proc private final Future Integer process public RemoteProc Future Integer process this process process Override public void kill throws IOException InterruptedException process cancel true Override public int join throws IOException InterruptedException try return process get catch InterruptedException e aborting kill the process process cancel true throw e catch ExecutionException e if e getCause instanceof IOException throw IOException e getCause throw new IOException Failed to join the process e catch CancellationException x return 1 Override public boolean isAlive throws IOException InterruptedException return process isDone Override public InputStream getStdout return null Override public InputStream getStderr return null Override public OutputStream getStdin return null private static final Logger LOGGER Logger getLogger Proc class getName public static boolean SHOW PID falsepackage hudson util import hudson ExtensionList import hudson ExtensionPoint import java io IOException import java io Serializable public abstract class ProcessKiller implements ExtensionPoint Serializable public static ExtensionList ProcessKiller all return ExtensionList lookup ProcessKiller class public abstract boolean kill ProcessTree OSProcess process throws IOException InterruptedException private static final long serialVersionUID 1Lpackage hudson util import hudson ExtensionList import hudson ExtensionPoint import hudson util ProcessTreeRemoting IOSProcess import java util Collections import java util List import javax annotation CheckForNull import javax annotation Nonnull import jenkins util JenkinsJVM public abstract class ProcessKillingVeto implements ExtensionPoint public static class VetoCause private final String message public VetoCause Nonnull String message this message message public Nonnull String getMessage return message public static List ProcessKillingVeto all if JenkinsJVM isJenkinsJVM return all return Collections emptyList private static List ProcessKillingVeto all return ExtensionList lookup ProcessKillingVeto class CheckForNull public abstract VetoCause vetoProcessKilling Nonnull IOSProcess ppackage hudson util import com sun jna Memory import com sun jna Native import com sun jna NativeLong import com sun jna Pointer import com sun jna LastErrorException import com sun jna ptr IntByReference import hudson EnvVars import hudson FilePath import hudson Util import hudson remoting Channel import hudson remoting VirtualChannel import hudson slaves SlaveComputer import hudson util ProcessKillingVeto VetoCause import hudson util ProcessTree OSProcess import hudson util ProcessTreeRemoting IOSProcess import hudson util ProcessTreeRemoting IProcessTree import jenkins security SlaveToMasterCallable import org jvnet winp WinProcess import org jvnet winp WinpException import java io import java lang reflect Field import java lang reflect InvocationTargetException import java lang reflect Method import java util ArrayList import java util Arrays import java util Collections import java util HashMap import java util Iterator import java util List import java util Locale import java util Map import java util Map Entry import java util SortedMap import java util logging Level import java util logging Logger import javax annotation CheckForNull import static com sun jna Pointer NULL import jenkins util SystemProperties import static hudson util jna GNUCLibrary LIBC import static java util logging Level FINE import static java util logging Level FINER import static java util logging Level FINEST public abstract class ProcessTree implements Iterable OSProcess IProcessTree Serializable protected final Map Integer OSProcess processes new HashMap Integer OSProcess private transient volatile List ProcessKiller killers instantiation only allowed for subtypes in this class private ProcessTree public final OSProcess get int pid return processes get pid public final Iterator OSProcess iterator return processes values iterator public abstract OSProcess get Process proc public abstract void killAll Map String String modelEnvVars throws InterruptedException public void killAll Process proc Map String String modelEnvVars throws InterruptedException LOGGER fine killAll process proc and envs modelEnvVars OSProcess p get proc if p null p killRecursively if modelEnvVars null killAll modelEnvVars final List ProcessKiller getKillers throws InterruptedException if killers null try VirtualChannel channelToMaster SlaveComputer getChannelToMaster if channelToMaster null killers channelToMaster call new SlaveToMasterCallable List ProcessKiller IOException public List ProcessKiller call throws IOException return new ArrayList ProcessKiller ProcessKiller all else used in an environment that doesn t support talk back to the master let s do with what we have killers Collections emptyList catch IOException e LOGGER log Level WARNING Failed to obtain killers e killers Collections emptyList return killers public abstract class OSProcess implements IOSProcess Serializable final int pid instantiation only allowed for subtypes in this class private OSProcess int pid this pid pid public final int getPid return pid public abstract OSProcess getParent final ProcessTree getTree return ProcessTree this public final List OSProcess getChildren List OSProcess r new ArrayList OSProcess for OSProcess p ProcessTree this if p getParent this r add p return r public abstract void kill throws InterruptedException void killByKiller throws InterruptedException for ProcessKiller killer getKillers try if killer kill this break catch IOException e LOGGER log Level WARNING Failed to kill pid getPid e public abstract void killRecursively throws InterruptedException protected CheckForNull VetoCause getVeto for ProcessKillingVeto vetoExtension ProcessKillingVeto all VetoCause cause vetoExtension vetoProcessKilling this if cause null if LOGGER isLoggable FINEST LOGGER finest Killing of pid getPid vetoed by vetoExtension getClass getName cause getMessage return cause return null public abstract List String getArguments public abstract EnvVars getEnvironmentVariables public final boolean hasMatchingEnvVars Map String String modelEnvVar if modelEnvVar isEmpty sanity check so that we don t start rampage return false SortedMap String String envs getEnvironmentVariables for Entry String String e modelEnvVar entrySet String v envs get e getKey if v null v equals e getValue return false no match return true public T T act ProcessCallable T callable throws IOException InterruptedException return callable invoke this FilePath localChannel Object writeReplace return new SerializedProcess pid private final class SerializedProcess implements Serializable private final int pid private static final long serialVersionUID 1L private SerializedProcess int pid this pid pid Object readResolve return get pid public interface ProcessCallable T extends Serializable T invoke OSProcess process VirtualChannel channel throws IOException public static ProcessTree get if enabled return DEFAULT try if File pathSeparatorChar return new Windows String os Util fixNull System getProperty os name if os equals Linux return new Linux if os equals SunOS return new Solaris if os equals Mac OS X return new Darwin catch LinkageError e LOGGER log Level WARNING Failed to load winp Reverting to the default e enabled false return DEFAULT implementation follows static final ProcessTree DEFAULT new Local public OSProcess get final Process proc return new OSProcess 1 public OSProcess getParent return null public void killRecursively fall back to a single process killer proc destroy public void kill throws InterruptedException if getVeto null return proc destroy killByKiller public List String getArguments return Collections emptyList public EnvVars getEnvironmentVariables return new EnvVars public void killAll Map String String modelEnvVars no op private static final class Windows extends Local Windows for final WinProcess p WinProcess all int pid p getPid if pid 0 pid 4 continue skip the System Idle and System processes super processes put pid new OSProcess pid private EnvVars env private List String args public OSProcess getParent windows process doesn t have parent child relationship return null public void killRecursively throws InterruptedException if getVeto null return LOGGER finer Killing recursively getPid p killRecursively killByKiller public void kill throws InterruptedException if getVeto null return LOGGER finer Killing getPid p kill killByKiller Override public synchronized List String getArguments if args null args Arrays asList QuotedStringTokenizer tokenize p getCommandLine return args Override public synchronized EnvVars getEnvironmentVariables if env null return env env new EnvVars try env putAll p getEnvironmentVariables catch WinpException e LOGGER log FINE Failed to get environment variable e return env Override public OSProcess get Process proc return get new WinProcess proc getPid public void killAll Map String String modelEnvVars throws InterruptedException for OSProcess p this if p getPid 10 continue ignore system processes like idle process LOGGER finest Considering to kill p getPid boolean matched try matched p hasMatchingEnvVars modelEnvVars catch WinpException e likely a missing privilege LOGGER log FINEST Failed to check environment variable match e continue if matched p killRecursively else LOGGER finest Environment variable didn t match static WinProcess enableDebugPrivilege static abstract class Unix extends Local Override public OSProcess get Process proc try return get Integer UnixReflection PID FIELD get proc catch IllegalAccessException e impossible IllegalAccessError x new IllegalAccessError x initCause e throw x public void killAll Map String String modelEnvVars throws InterruptedException for OSProcess p this if p hasMatchingEnvVars modelEnvVars p killRecursively static abstract class ProcfsUnix extends Unix ProcfsUnix File processes new File proc listFiles new FileFilter public boolean accept File f return f isDirectory if processes null LOGGER info No proc return for File p processes int pid try pid Integer parseInt p getName catch NumberFormatException e other sub directories continue try this processes put pid createProcess pid catch IOException e perhaps the process status has changed since we obtained a directory listing protected abstract OSProcess createProcess int pid throws IOException public abstract class UnixProcess extends OSProcess protected UnixProcess int pid super pid protected final File getFile String relativePath return new File new File proc getPid relativePath public void kill throws InterruptedException if getVeto null return try int pid getPid LOGGER fine Killing pid pid UnixReflection destroy pid catch IllegalAccessException e this is impossible IllegalAccessError x new IllegalAccessError x initCause e throw x catch InvocationTargetException e tunnel serious errors if e getTargetException instanceof Error throw Error e getTargetException otherwise log and let go I need to see when this happens LOGGER log Level INFO Failed to terminate pid getPid e killByKiller public void killRecursively throws InterruptedException We kill individual processes of a tree so handling vetoes inside kill is enough for UnixProcess es LOGGER fine Recursively killing pid getPid for OSProcess p getChildren p killRecursively kill public abstract List String getArguments private static final class UnixReflection private static final Field PID FIELD private static final Method DESTROY PROCESS static try Class clazz Class forName java lang UNIXProcess PID FIELD clazz getDeclaredField pid PID FIELD setAccessible true if isPreJava8 DESTROY PROCESS clazz getDeclaredMethod destroyProcess int class else DESTROY PROCESS clazz getDeclaredMethod destroyProcess int class boolean class DESTROY PROCESS setAccessible true catch ClassNotFoundException e LinkageError x new LinkageError x initCause e throw x catch NoSuchFieldException e LinkageError x new LinkageError x initCause e throw x catch NoSuchMethodException e LinkageError x new LinkageError x initCause e throw x public static void destroy int pid throws IllegalAccessException InvocationTargetException if isPreJava8 DESTROY PROCESS invoke null pid else DESTROY PROCESS invoke null pid false private static boolean isPreJava8 int javaVersionAsAnInteger Integer parseInt System getProperty java version replaceAll replaceAll substring 0 2 return javaVersionAsAnInteger 18 static class Linux extends ProcfsUnix protected LinuxProcess createProcess int pid throws IOException return new LinuxProcess pid class LinuxProcess extends UnixProcess private int ppid 1 private EnvVars envVars private List String arguments LinuxProcess int pid throws IOException super pid BufferedReader r new BufferedReader new FileReader getFile status try String line while line r readLine null line line toLowerCase Locale ENGLISH if line startsWith ppid ppid Integer parseInt line substring 5 trim break finally r close if ppid 1 throw new IOException Failed to parse PPID from proc pid status public OSProcess getParent return get ppid public synchronized List String getArguments if arguments null return arguments arguments new ArrayList String try byte cmdline readFileToByteArray getFile cmdline int pos 0 for int i 0 i cmdline length i byte b cmdline i if b 0 arguments add new String cmdline pos i pos pos i 1 catch IOException e failed to read this can happen under normal circumstances most notably permission denied so don t report this as an error arguments Collections unmodifiableList arguments return arguments public synchronized EnvVars getEnvironmentVariables if envVars null return envVars envVars new EnvVars try byte environ readFileToByteArray getFile environ int pos 0 for int i 0 i environ length i byte b environ i if b 0 envVars addLine new String environ pos i pos pos i 1 catch IOException e failed to read this can happen under normal circumstances most notably permission denied so don t report this as an error return envVars public byte readFileToByteArray File file throws IOException InputStream in org apache commons io FileUtils openInputStream file try return org apache commons io IOUtils toByteArray in finally in close static class Solaris extends ProcfsUnix protected OSProcess createProcess final int pid throws IOException return new SolarisProcess pid private class SolarisProcess extends UnixProcess private static final byte PR MODEL ILP32 1 private static final byte PR MODEL LP64 2 private final boolean b64 private final int ppid private final long envp private final long argp private final int argc private EnvVars envVars private List String arguments private SolarisProcess int pid throws IOException super pid RandomAccessFile psinfo new RandomAccessFile getFile psinfo r try see http cvs opensolaris org source xref onnv onnv gate usr src uts common sys procfs h typedef struct psinfo intpr flag intpr nlwp pid tpr pid pid tpr ppid pid tpr pgid pid tpr sid uid tpr uid uid tpr euid gid tpr gid gid tpr egid uintptr tpr addr size tpr size size tpr rssize dev tpr ttydev ushort tpr pctcpu ushort tpr pctmem timestruc tpr start timestruc tpr time timestruc tpr ctime charpr fname PRFNSZ charpr psargs PRARGSZ intpr wstat intpr argc uintptr tpr argv uintptr tpr envp charpr dmodel lwpsinfo tpr lwp psinfo t see http cvs opensolaris org source xref onnv onnv gate usr src uts common sys types h for the size of the various datatype see http cvs opensolaris org source xref onnv onnv gate usr src cmd ptools pargs pargs c for how to read this information psinfo seek 8 if adjust psinfo readInt pid throw new IOException psinfo PID mismatch sanity check ppid adjust psinfo readInt if Pointer SIZE 8 psinfo seek 236 offset of pr argc argc adjust psinfo readInt argp adjustL psinfo readLong envp adjustL psinfo readLong b64 psinfo readByte PR MODEL LP64 else psinfo seek 188 offset of pr argc argc adjust psinfo readInt argp to64 adjust psinfo readInt envp to64 adjust psinfo readInt b64 psinfo readByte PR MODEL LP64 finally psinfo close if ppid 1 throw new IOException Failed to parse PPID from proc pid status public OSProcess getParent return get ppid public synchronized List String getArguments if arguments null return arguments arguments new ArrayList String argc if argc 0 return arguments int psize b64 8 4 Memory m new Memory psize try if LOGGER isLoggable FINER LOGGER finer Reading getFile as int fd LIBC open getFile as getAbsolutePath 0 try for int n 0 n argc n read a pointer to one entry LIBC pread fd m new NativeLong psize new NativeLong argp n psize long addr b64 m getLong 0 m getInt 0 arguments add readLine fd addr argv n finally LIBC close fd catch IOException LastErrorException e failed to read this can happen under normal circumstances most notably permission denied so don t report this as an error arguments Collections unmodifiableList arguments return arguments public synchronized EnvVars getEnvironmentVariables if envVars null return envVars envVars new EnvVars if envp 0 return envVars int psize b64 8 4 Memory m new Memory psize try if LOGGER isLoggable FINER LOGGER finer Reading getFile as int fd LIBC open getFile as getAbsolutePath 0 try for int n 0 n read a pointer to one entry LIBC pread fd m new NativeLong psize new NativeLong envp n psize long addr b64 m getLong 0 m getInt 0 if addr 0 completed the walk break now read the null terminated string envVars addLine readLine fd addr env n finally LIBC close fd catch IOException LastErrorException e failed to read this can happen under normal circumstances most notably permission denied so don t report this as an error return envVars private String readLine int fd long addr String prefix throws IOException if LOGGER isLoggable FINEST LOGGER finest Reading prefix at addr Memory m new Memory 1 byte ch 1 ByteArrayOutputStream buf new ByteArrayOutputStream while true LIBC pread fd m new NativeLong 1 new NativeLong addr ch m getByte 0 if ch 0 break buf write ch addr String line buf toString if LOGGER isLoggable FINEST LOGGER finest prefix was line return line private static long to64 int i return i 0xFFFFFFFFL private static int adjust int i if IS LITTLE ENDIAN return i 24 i 8 0x00FF0000 i 8 0x0000FF00 i 24 else return i public static long adjustL long i if IS LITTLE ENDIAN return Long reverseBytes i else return i private static class Darwin extends Unix Darwin String arch System getProperty sun arch data model if 64 equals arch sizeOf kinfo proc sizeOf kinfo proc 64 kinfo proc pid offset kinfo proc pid offset 64 kinfo proc ppid offset kinfo proc ppid offset 64 else sizeOf kinfo proc sizeOf kinfo proc 32 kinfo proc pid offset kinfo proc pid offset 32 kinfo proc ppid offset kinfo proc ppid offset 32 try IntByReference new IntByReference sizeOfInt IntByReference size new IntByReference sizeOfInt Memory m int nRetry 0 while true find out how much memory we need to do this if LIBC sysctl MIB PROC ALL 3 NULL size NULL 0 throw new IOException Failed to obtain memory requirement LIBC strerror Native getLastError now try the real call m new Memory size getValue if LIBC sysctl MIB PROC ALL 3 m size NULL 0 if Native getLastError ENOMEM nRetry 16 continue retry throw new IOException Failed to call kern proc all LIBC strerror Native getLastError break int count size getValue sizeOf kinfo proc LOGGER fine Found count processes for int base 0 base size getValue base sizeOf kinfo proc int pid m getInt base kinfo proc pid offset int ppid m getInt base kinfo proc ppid offset int effective uid m getInt base 304 byte comm new byte 16 m read base 163 comm 0 16 super processes put pid new DarwinProcess pid ppid catch IOException e LOGGER log Level WARNING Failed to obtain process list e private class DarwinProcess extends UnixProcess private final int ppid private EnvVars envVars private List String arguments DarwinProcess int pid int ppid super pid this ppid ppid public OSProcess getParent return get ppid public synchronized EnvVars getEnvironmentVariables if envVars null return envVars parse return envVars public List String getArguments if arguments null return arguments parse return arguments private void parse try allocate them first so that the parse error wil result in empty data and avoid retry arguments new ArrayList String envVars new EnvVars IntByReference new IntByReference IntByReference argmaxRef new IntByReference 0 IntByReference size new IntByReference sizeOfInt for some reason I was never able to get sysctlbyname work if LIBC sysctlbyname kern argmax argmaxRef getPointer size NULL 0 if LIBC sysctl new int CTL KERN KERN ARGMAX 2 argmaxRef getPointer size NULL 0 throw new IOException Failed to get kernl argmax LIBC strerror Native getLastError int argmax argmaxRef getValue class StringArrayMemory extends Memory private long offset 0 StringArrayMemory long l super l int readInt int r getInt offset offset sizeOfInt return r byte peek return getByte offset String readString ByteArrayOutputStream baos new ByteArrayOutputStream byte ch while ch getByte offset 0 baos write ch return baos toString void skip0 skip padding 0 s while getByte offset 0 offset StringArrayMemory m new StringArrayMemory argmax size setValue argmax if LIBC sysctl new int CTL KERN KERN PROCARGS2 pid 3 m size NULL 0 throw new IOException Failed to obtain ken procargs2 LIBC strerror Native getLastError I find the Darwin source code of the ps command helpful in understanding how it does this see http www opensource apple com source adv cmds adv cmds 147 ps print c int argc m readInt String args0 m readString exec path m skip0 try for int i 0 i argc i arguments add m readString catch IndexOutOfBoundsException e throw new IllegalStateException Failed to parse arguments pid pid arg0 args0 arguments arguments nargs argc Please run ps e pid and report this to https issues jenkins ci org browse JENKINS 9634 e read env vars that follow while m peek 0 envVars addLine m readString catch IOException e this happens with insufficient permissions so just ignore the problem local constants private final int sizeOf kinfo proc private static final int sizeOf kinfo proc 32 492 on 32bit Mac OS X private static final int sizeOf kinfo proc 64 648 on 64bit Mac OS X private final int kinfo proc pid offset private static final int kinfo proc pid offset 32 24 private static final int kinfo proc pid offset 64 40 private final int kinfo proc ppid offset private static final int kinfo proc ppid offset 32 416 private static final int kinfo proc ppid offset 64 560 private static final int sizeOfInt Native getNativeSize int class private static final int CTL KERN 1 private static final int KERN PROC 14 private static final int KERN PROC ALL 0 private static final int ENOMEM 12 private static int MIB PROC ALL CTL KERN KERN PROC KERN PROC ALL private static final int KERN ARGMAX 8 private static final int KERN PROCARGS2 49 public static abstract class Local extends ProcessTree Local public static class Remote extends ProcessTree implements Serializable private final IProcessTree proxy public Remote ProcessTree proxy Channel ch this proxy ch export IProcessTree class proxy for Entry Integer OSProcess e proxy processes entrySet processes put e getKey new RemoteProcess e getValue ch Override public OSProcess get Process proc return null Override public void killAll Map String String modelEnvVars throws InterruptedException proxy killAll modelEnvVars Object writeReplace return this cancel out super writeReplace private static final long serialVersionUID 1L private class RemoteProcess extends OSProcess implements Serializable private final IOSProcess proxy RemoteProcess OSProcess proxy Channel ch super proxy getPid this proxy ch export IOSProcess class proxy public OSProcess getParent IOSProcess p proxy getParent if p null return null return get p getPid public void kill throws InterruptedException proxy kill public void killRecursively throws InterruptedException proxy killRecursively public List String getArguments return proxy getArguments public EnvVars getEnvironmentVariables return proxy getEnvironmentVariables Object writeReplace return this cancel out super writeReplace public T T act ProcessCallable T callable throws IOException InterruptedException return proxy act callable private static final long serialVersionUID 1L Object writeReplace return new Remote this Channel current public static void main String args dump everything LOGGER setLevel Level ALL ConsoleHandler h new ConsoleHandler h setLevel Level ALL LOGGER addHandler h Solaris killer Solaris get Solaris SolarisSystem s killer createSystem Solaris SolarisProcess p s get Integer parseInt args 0 System out println p getEnvVars if args length 2 p kill private static final boolean IS LITTLE ENDIAN little equals System getProperty sun cpu endian private static final Logger LOGGER Logger getLogger ProcessTree class getName public static boolean enabled SystemProperties getBoolean ProcessTreeKiller class getName disable SystemProperties getBoolean ProcessTree class getName disablepackage hudson util import hudson EnvVars import hudson util ProcessTree OSProcess import java util Map Deprecated public final class ProcessTreeKiller Deprecated public void kill Process proc throws InterruptedException kill proc null Deprecated public void kill Process proc Map String String modelEnvVars throws InterruptedException ProcessTree pt ProcessTree get if proc null pt get proc killRecursively if modelEnvVars null pt killAll modelEnvVars Deprecated public void kill Map String String modelEnvVars throws InterruptedException kill null modelEnvVars Deprecated public static EnvVars createCookie return EnvVars createCookie public static ProcessTreeKiller get return new ProcessTreeKillerpackage hudson util import hudson EnvVars import hudson util ProcessTree ProcessCallable import java io IOException import java lang reflect Proxy import java util List import java util Map public class ProcessTreeRemoting public interface IProcessTree void killAll Map String String modelEnvVars throws InterruptedException public interface IOSProcess int getPid IOSProcess getParent void kill throws InterruptedException void killRecursively throws InterruptedException List String getArguments EnvVars getEnvironmentVariables T T act ProcessCallable T callable throws IOException InterruptedExceptionpackage jenkins util import edu umd cs findbugs annotations SuppressFBWarnings import java lang reflect Field import java lang reflect InvocationHandler import java lang reflect Method import java lang reflect Proxy import java util HashMap import java util List import java util Locale import java util Map import java util concurrent ExecutorService import java util concurrent ScheduledExecutorService import java util concurrent TimeUnit import java util logging Level import java util logging Logger import javax annotation Nonnull import javax servlet http HttpServletRequest import net sf json JSON import net sf json JSONObject import org acegisecurity context SecurityContext import org acegisecurity context SecurityContextHolder import org kohsuke stapler Ancestor import org kohsuke stapler RequestImpl import org kohsuke stapler Stapler import org kohsuke stapler TokenList import org kohsuke stapler bind Bound import org kohsuke stapler bind BoundObjectTable import org kohsuke stapler bind JavaScriptMethod import org kohsuke stapler jelly BindTag public abstract class ProgressiveRendering private static final Logger LOG Logger getLogger ProgressiveRendering class getName private static final Long DEBUG SLEEP SystemProperties getLong jenkins util ProgressiveRendering DEBUG SLEEP private static final int CANCELED 1 private static final int ERROR 2 private double status 0 private long lastNewsTime private final SecurityContext securityContext private final RequestImpl request private final String uri private long start private BoundObjectTable Table boundObjectTable private String boundId protected ProgressiveRendering securityContext SecurityContextHolder getContext request createMockRequest uri request getRequestURI SuppressWarnings RV RETURN VALUE IGNORED BAD PRACTICE JavaScriptMethod public final void start Ancestor ancestor Stapler getCurrentRequest findAncestor BoundObjectTable class if ancestor null throw new IllegalStateException no BoundObjectTable boundObjectTable BoundObjectTable ancestor getObject getTable boundId ancestor getNextToken 0 LOG log Level FINE starting rendering 0 at 1 new Object uri boundId final ExecutorService executorService executorService executorService submit new Runnable Override public void run lastNewsTime start System currentTimeMillis setCurrentRequest request SecurityContext orig SecurityContextHolder getContext try SecurityContextHolder setContext securityContext compute if status CANCELED status ERROR status 1 catch Exception x LOG log Level WARNING failed to compute uri x status ERROR finally SecurityContextHolder setContext orig setCurrentRequest null LOG log Level FINE 0 finished in 1 msec with status 2 new Object uri System currentTimeMillis start status if executorService instanceof ScheduledExecutorService ScheduledExecutorService executorService schedule new Runnable Override public void run LOG log Level FINE some time has elapsed since 0 finished so releasing boundId release timeout 2 TimeUnit MILLISECONDS private void release try Method release BoundObjectTable Table class getDeclaredMethod release String class release setAccessible true release invoke boundObjectTable boundId catch Exception x LOG log Level WARNING failed to unbind boundId x java lang SuppressWarnings rawtypes unchecked public RequestImpl ctor requires List AncestorImpl yet AncestorImpl is not public API design flaw private static RequestImpl createMockRequest RequestImpl currentRequest RequestImpl Stapler getCurrentRequest HttpServletRequest original HttpServletRequest currentRequest getRequest final Map String Object getters new HashMap String Object for Method method HttpServletRequest class getMethods String m method getName if m startsWith get m startsWith is method getParameterTypes length 0 Class type method getReturnType TODO could add other types which are known to be safe to copy Cookie Principal HttpSession etc if type isPrimitive type String class type Locale class try getters put m method invoke original catch Exception x LOG log Level WARNING cannot mock Stapler request method x List ancestors currentRequest ancestors LOG log Level FINER mocking ancestors 0 using 1 new Object ancestors getters TokenList tokens currentRequest tokens return new RequestImpl Stapler getCurrent HttpServletRequest Proxy newProxyInstance ProgressiveRendering class getClassLoader new Class HttpServletRequest class new InvocationHandler Override public Object invoke Object proxy Method method Object args throws Throwable String m method getName if getters containsKey m return getters get m else TODO implement other methods as needed throw new UnsupportedOperationException m ancestors tokens java lang SuppressWarnings unchecked private static void setCurrentRequest RequestImpl request try Field field Stapler class getDeclaredField CURRENT REQUEST field setAccessible true ThreadLocal RequestImpl field get null set request catch Exception x LOG log Level WARNING cannot mock Stapler request x protected abstract void compute throws Exception protected abstract Nonnull JSON data protected final void progress double completedFraction if completedFraction 0 completedFraction 1 throw new IllegalArgumentException completedFraction should be in 0 1 status completedFraction protected final boolean canceled if DEBUG SLEEP null try Thread sleep DEBUG SLEEP catch InterruptedException x if status ERROR return true recent call to data failed long now System currentTimeMillis long elapsed now lastNewsTime if elapsed timeout status CANCELED LOG log Level FINE 0 canceled due to 1 msec inactivity after 2 msec new Object uri elapsed now start return true else return false JavaScriptMethod public final JSONObject news lastNewsTime System currentTimeMillis JSONObject r new JSONObject try r put data data catch RuntimeException x LOG log Level WARNING failed to update uri x status ERROR Object statusJSON status 1 done status CANCELED canceled status ERROR error status r put status statusJSON if statusJSON instanceof String somehow completed LOG log Level FINE finished in news so releasing 0 boundId release lastNewsTime System currentTimeMillis LOG log Level FINER news from 0 uri return r protected ExecutorService executorService return Timer get protected long timeout return 15000package hudson model import hudson Util import hudson model Descriptor FormException import hudson model queue QueueTaskFuture import hudson scm SCM import hudson tasks BuildStep import hudson tasks BuildWrapper import hudson tasks BuildWrappers import hudson tasks Builder import hudson tasks Fingerprinter import hudson tasks Publisher import hudson tasks Maven import hudson tasks Maven ProjectWithMaven import hudson tasks Maven MavenInstallation import hudson triggers SCMTrigger import hudson triggers Trigger import hudson util DescribableList import net sf json JSONObject import org kohsuke stapler StaplerRequest import org kohsuke stapler StaplerResponse import javax servlet ServletException import java io IOException import java util Collection import java util HashSet import java util List import java util Map import java util Set import java util concurrent atomic AtomicReferenceFieldUpdater import java util logging Level import java util logging Logger import jenkins triggers SCMTriggerItem public abstract class Project P extends Project P B B extends Build P B extends AbstractProject P B implements SCMTriggerItem Saveable ProjectWithMaven BuildableItemWithBuildWrappers private volatile DescribableList Builder Descriptor Builder builders private static final AtomicReferenceFieldUpdater Project DescribableList buildersSetter AtomicReferenceFieldUpdater newUpdater Project class DescribableList class builders private volatile DescribableList Publisher Descriptor Publisher publishers private static final AtomicReferenceFieldUpdater Project DescribableList publishersSetter AtomicReferenceFieldUpdater newUpdater Project class DescribableList class publishers private volatile DescribableList BuildWrapper Descriptor BuildWrapper buildWrappers private static final AtomicReferenceFieldUpdater Project DescribableList buildWrappersSetter AtomicReferenceFieldUpdater newUpdater Project class DescribableList class buildWrappers public Project ItemGroup parent String name super parent name Override public void onLoad ItemGroup extends Item parent String name throws IOException super onLoad parent name getBuildersList setOwner this getPublishersList setOwner this getBuildWrappersList setOwner this public AbstractProject asProject return this Override public Item asItem return this Override public QueueTaskFuture scheduleBuild2 int quietPeriod Action actions return scheduleBuild2 quietPeriod null actions Override public SCMTrigger getSCMTrigger return getTrigger SCMTrigger class Override public Collection extends SCM getSCMs return SCMTriggerItem SCMTriggerItems resolveMultiScmIfConfigured getScm public List Builder getBuilders return getBuildersList toList Deprecated public Map Descriptor Publisher Publisher getPublishers return getPublishersList toMap public DescribableList Builder Descriptor Builder getBuildersList if builders null buildersSetter compareAndSet this null new DescribableList Builder Descriptor Builder this return builders public DescribableList Publisher Descriptor Publisher getPublishersList if publishers null publishersSetter compareAndSet this null new DescribableList Publisher Descriptor Publisher this return publishers public Map Descriptor BuildWrapper BuildWrapper getBuildWrappers return getBuildWrappersList toMap public DescribableList BuildWrapper Descriptor BuildWrapper getBuildWrappersList if buildWrappers null buildWrappersSetter compareAndSet this null new DescribableList BuildWrapper Descriptor BuildWrapper this return buildWrappers Override protected Set ResourceActivity getResourceActivities final Set ResourceActivity activities new HashSet ResourceActivity activities addAll super getResourceActivities activities addAll Util filter getBuildersList ResourceActivity class activities addAll Util filter getPublishersList ResourceActivity class activities addAll Util filter getBuildWrappersList ResourceActivity class return activities Deprecated public void addPublisher Publisher buildStep throws IOException getPublishersList add buildStep Deprecated public void removePublisher Descriptor Publisher descriptor throws IOException getPublishersList remove descriptor public Publisher getPublisher Descriptor Publisher descriptor for Publisher p getPublishersList if p getDescriptor descriptor return p return null Override protected void buildDependencyGraph DependencyGraph graph super buildDependencyGraph graph getPublishersList buildDependencyGraph this graph getBuildersList buildDependencyGraph this graph getBuildWrappersList buildDependencyGraph this graph Override public boolean isFingerprintConfigured return getPublishersList get Fingerprinter class null public MavenInstallation inferMavenInstallation Maven m getBuildersList get Maven class if m null return m getMaven return null actions Override protected void submit StaplerRequest req StaplerResponse rsp throws IOException ServletException FormException super submit req rsp JSONObject json req getSubmittedForm getBuildWrappersList rebuild req json BuildWrappers getFor this getBuildersList rebuildHetero req json Builder all builder getPublishersList rebuildHetero req json Publisher all publisher Override protected List Action createTransientActions List Action r super createTransientActions for BuildStep step getBuildersList try r addAll step getProjectActions this catch Exception e LOGGER log Level SEVERE Error loading build step e for BuildStep step getPublishersList try r addAll step getProjectActions this catch Exception e LOGGER log Level SEVERE Error loading publisher e for BuildWrapper step getBuildWrappers values try r addAll step getProjectActions this catch Exception e LOGGER log Level SEVERE Error loading build wrapper e for Trigger trigger triggers try r addAll trigger getProjectActions catch Exception e LOGGER log Level SEVERE Error loading trigger e return r private static final Logger LOGGER Logger getLogger Project class getNamepackage jenkins model import hudson DescriptorExtensionList import hudson Extension import hudson ExtensionPoint import hudson Util import hudson model Describable import hudson model Descriptor import hudson model Failure import jenkins model Messages import hudson util FormValidation import java io IOException import java io Serializable import java util regex Pattern import java util regex PatternSyntaxException import javax servlet ServletException import org apache commons lang StringUtils import org jenkinsci Symbol import org kohsuke stapler DataBoundConstructor import org kohsuke stapler QueryParameter public abstract class ProjectNamingStrategy implements Describable ProjectNamingStrategy ExtensionPoint public ProjectNamingStrategyDescriptor getDescriptor return ProjectNamingStrategyDescriptor Jenkins getInstance getDescriptor getClass public static DescriptorExtensionList ProjectNamingStrategy ProjectNamingStrategyDescriptor all return Jenkins getInstance ProjectNamingStrategy ProjectNamingStrategyDescriptor getDescriptorList ProjectNamingStrategy class public void checkName String name throws Failure no op public boolean isForceExistingJobs return false public static final ProjectNamingStrategy DEFAULT NAMING STRATEGY new DefaultProjectNamingStrategy public static final class DefaultProjectNamingStrategy extends ProjectNamingStrategy implements Serializable private static final long serialVersionUID 1L DataBoundConstructor public DefaultProjectNamingStrategy Override public void checkName String origName throws Failure default should just do nothing this is how Jenkins worked before introducing this ExtensionPoint private Object readResolve return DEFAULT NAMING STRATEGY Extension Symbol standard public static final class DescriptorImpl extends ProjectNamingStrategyDescriptor Override public String getDisplayName return Messages DefaultProjectNamingStrategy DisplayName Override public String getHelpFile return help system config defaultJobNamingStrategy html public static final class PatternProjectNamingStrategy extends ProjectNamingStrategy implements Serializable private static final long serialVersionUID 1L private final String namePattern private final String description private boolean forceExistingJobs Deprecated public PatternProjectNamingStrategy String namePattern boolean forceExistingJobs this namePattern null forceExistingJobs DataBoundConstructor public PatternProjectNamingStrategy String namePattern String description boolean forceExistingJobs this namePattern namePattern this description description this forceExistingJobs forceExistingJobs Override public void checkName String name if StringUtils isNotBlank namePattern StringUtils isNotBlank name if Pattern matches namePattern name throw new Failure StringUtils isEmpty description Messages Hudson JobNameConventionNotApplyed name namePattern description public String getNamePattern return namePattern public String getDescription return description public boolean isForceExistingJobs return forceExistingJobs Extension Symbol pattern public static final class DescriptorImpl extends ProjectNamingStrategyDescriptor public static final String DEFAULT PATTERN Override public String getDisplayName return Messages PatternProjectNamingStrategy DisplayName Override public String getHelpFile return help system config patternJobNamingStrategy html public FormValidation doCheckNamePattern QueryParameter String value throws IOException ServletException String pattern Util fixEmptyAndTrim value if pattern null return FormValidation error Messages PatternProjectNamingStrategy NamePatternRequired try Pattern compile pattern catch PatternSyntaxException e return FormValidation error Messages PatternProjectNamingStrategy NamePatternInvalidSyntax return FormValidation ok public static abstract class ProjectNamingStrategyDescriptor extends Descriptor ProjectNamingStrategypackage hudson model import hudson tasks BuildStep import hudson tasks BuildWrapper import hudson triggers Trigger public interface ProminentProjectAction extends Action TODO do the rendering of the part from the action pagepackage hudson tools import hudson Functions import hudson model Describable import hudson model Descriptor import java util ArrayList import java util List public abstract class PropertyDescriptor P extends Describable P T extends Descriptor P protected PropertyDescriptor Class extends P clazz super clazz protected PropertyDescriptor private Class P getP return Functions getTypeParameter getClass Descriptor class 0 public boolean isApplicable Class extends T targetType Class extends T applicable Functions getTypeParameter clazz getP 0 return applicable isAssignableFrom targetType public static D extends PropertyDescriptor T T List D for List D all Class extends T target List D result new ArrayList D for D d all if d isApplicable target result add d return result public static D extends PropertyDescriptor T T List D for List D all T target return for all Class target getClasspackage hudson util import javax crypto SecretKey import javax crypto Cipher import javax crypto KeyGenerator import java io IOException import java io UnsupportedEncodingException import java security GeneralSecurityException import java security NoSuchAlgorithmException import com trilead ssh2 crypto Base64 public class Protector private static final String ALGORITHM DES private static final String MAGIC public static String protect String secret try Cipher cipher Secret getCipher ALGORITHM cipher init Cipher ENCRYPT MODE DES KEY return new String Base64 encode cipher doFinal secret MAGIC getBytes UTF 8 catch GeneralSecurityException e throw new Error e impossible catch UnsupportedEncodingException e throw new Error e impossible public static String unprotect String data if data null return null try Cipher cipher Secret getCipher ALGORITHM cipher init Cipher DECRYPT MODE DES KEY String plainText new String cipher doFinal Base64 decode data toCharArray UTF 8 if plainText endsWith MAGIC return plainText substring 0 plainText length 3 return null catch GeneralSecurityException e return null catch UnsupportedEncodingException e throw new Error e impossible catch IOException e return null private static final SecretKey DES KEY static try DES KEY KeyGenerator getInstance ALGORITHM generateKey catch NoSuchAlgorithmException e throw new Error epackage hudson import com google common collect Lists import com thoughtworks xstream XStream import hudson model AbstractDescribableImpl import hudson model Descriptor import hudson model Saveable import hudson model listeners SaveableListener import hudson util FormValidation import hudson util Scrambler import hudson util Secret import hudson util XStream2 import java io File import java io IOException import java io InputStream import java io Serializable import java net Authenticator import java net HttpURLConnection import java net InetSocketAddress import java net MalformedURLException import java net PasswordAuthentication import java net Proxy import java net URL import java net URLConnection import java util Collections import java util List import java util regex Pattern import javax annotation CheckForNull import jenkins model Jenkins import jenkins util JenkinsJVM import jenkins util SystemProperties import org apache commons httpclient Credentials import org apache commons httpclient HttpClient import org apache commons httpclient NTCredentials import org apache commons httpclient UsernamePasswordCredentials import org apache commons httpclient auth AuthScope import org apache commons httpclient methods GetMethod import org jenkinsci Symbol import org jvnet robust http client RetryableHttpStream import org kohsuke stapler DataBoundConstructor import org kohsuke stapler QueryParameter public final class ProxyConfiguration extends AbstractDescribableImpl ProxyConfiguration implements Saveable Serializable private static final int DEFAULT CONNECT TIMEOUT MILLIS SystemProperties getInteger hudson ProxyConfiguration DEFAULT CONNECT TIMEOUT MILLIS 20 1000 public final String name public final int port private final String userName public final String noProxyHost Deprecated private String password private Secret secretPassword private String testUrl public ProxyConfiguration String name int port this name port null null public ProxyConfiguration String name int port String userName String password this name port userName password null public ProxyConfiguration String name int port String userName String password String noProxyHost this name port userName password noProxyHost null DataBoundConstructor public ProxyConfiguration String name int port String userName String password String noProxyHost String testUrl this name Util fixEmptyAndTrim name this port port this userName Util fixEmptyAndTrim userName this secretPassword Secret fromString password this noProxyHost Util fixEmptyAndTrim noProxyHost this testUrl Util fixEmptyAndTrim testUrl public String getUserName return userName This method is public if it was public only for jelly then should make it private or inline contents Have left public as can t tell if anyone else is using from plugins public String getPassword return Secret toString secretPassword public String getEncryptedPassword return secretPassword null null secretPassword getEncryptedValue public String getTestUrl return testUrl public List Pattern getNoProxyHostPatterns return getNoProxyHostPatterns noProxyHost public static List Pattern getNoProxyHostPatterns String noProxyHost if noProxyHost null return Collections emptyList List Pattern r Lists newArrayList for String s noProxyHost split t n if s length 0 continue r add Pattern compile s replace replace return r Deprecated public Proxy createProxy return createProxy null public Proxy createProxy String host return createProxy host name port noProxyHost public static Proxy createProxy String host String name int port String noProxyHost if host null noProxyHost null for Pattern p getNoProxyHostPatterns noProxyHost if p matcher host matches return Proxy NO PROXY return new Proxy Proxy Type HTTP new InetSocketAddress name port public void save throws IOException if BulkChange contains this return XmlFile config getXmlFile config write this SaveableListener fireOnChange this config public Object readResolve if secretPassword null backward compatibility get crambled password and store it encrypted secretPassword Secret fromString Scrambler descramble password password null return this public static XmlFile getXmlFile return new XmlFile XSTREAM new File Jenkins getInstance getRootDir proxy xml public static ProxyConfiguration load throws IOException XmlFile f getXmlFile if f exists return ProxyConfiguration f read else return null public static URLConnection open URL url throws IOException final ProxyConfiguration p get URLConnection con if p null con url openConnection else con url openConnection p createProxy url getHost if p getUserName null Add an authenticator which provides the credentials for proxy authentication Authenticator setDefault new Authenticator Override public PasswordAuthentication getPasswordAuthentication if getRequestorType RequestorType PROXY return null return new PasswordAuthentication p getUserName p getPassword toCharArray if DEFAULT CONNECT TIMEOUT MILLIS 0 con setConnectTimeout DEFAULT CONNECT TIMEOUT MILLIS if JenkinsJVM isJenkinsJVM this code may run on a slave decorate con return con public static InputStream getInputStream URL url throws IOException final ProxyConfiguration p get if p null return new RetryableHttpStream url InputStream is new RetryableHttpStream url p createProxy url getHost if p getUserName null Add an authenticator which provides the credentials for proxy authentication Authenticator setDefault new Authenticator Override public PasswordAuthentication getPasswordAuthentication if getRequestorType RequestorType PROXY return null return new PasswordAuthentication p getUserName p getPassword toCharArray return is CheckForNull private static ProxyConfiguration get if JenkinsJVM isJenkinsJVM return get return null CheckForNull private static ProxyConfiguration get JenkinsJVM checkJenkinsJVM this code could be called between the JVM flag being set and theInstance initialized Jenkins jenkins Jenkins getInstance return jenkins null null jenkins proxy private static void decorate URLConnection con throws IOException for URLConnectionDecorator d URLConnectionDecorator all d decorate con private static final XStream XSTREAM new XStream2 private static final long serialVersionUID 1L static XSTREAM alias proxy ProxyConfiguration class Extension Symbol proxy public static class DescriptorImpl extends Descriptor ProxyConfiguration Override public String getDisplayName return Proxy Configuration public FormValidation doCheckPort QueryParameter String value value Util fixEmptyAndTrim value if value null return FormValidation ok int port try port Integer parseInt value catch NumberFormatException e return FormValidation error Messages PluginManager PortNotANumber if port 0 port 65535 return FormValidation error Messages PluginManager PortNotInRange 0 65535 return FormValidation ok public FormValidation doValidateProxy QueryParameter testUrl String testUrl QueryParameter name String name QueryParameter port int port QueryParameter userName String userName QueryParameter password String password QueryParameter noProxyHost String noProxyHost if Util fixEmptyAndTrim testUrl null return FormValidation error Messages ProxyConfiguration TestUrlRequired String host testUrl try URL url new URL testUrl host url getHost catch MalformedURLException e return FormValidation error Messages ProxyConfiguration MalformedTestUrl testUrl GetMethod method null try method new GetMethod testUrl method getParams setParameter http socket timeout DEFAULT CONNECT TIMEOUT MILLIS 0 DEFAULT CONNECT TIMEOUT MILLIS new Integer 30 1000 HttpClient client new HttpClient if Util fixEmptyAndTrim name null isNoProxyHost host noProxyHost client getHostConfiguration setProxy name port Credentials credentials createCredentials userName password AuthScope scope new AuthScope AuthScope ANY HOST AuthScope ANY PORT client getState setProxyCredentials scope credentials int code client executeMethod method if code HttpURLConnection HTTP OK return FormValidation error Messages ProxyConfiguration FailedToConnect testUrl code catch IOException e return FormValidation error e Messages ProxyConfiguration FailedToConnectViaProxy testUrl finally if method null method releaseConnection return FormValidation ok Messages ProxyConfiguration Success private boolean isNoProxyHost String host String noProxyHost if host null noProxyHost null for Pattern p getNoProxyHostPatterns noProxyHost if p matcher host matches return true return false private Credentials createCredentials String userName String password if userName indexOf 0 final String domain userName substring 0 userName indexOf final String user userName substring userName indexOf 1 return new NTCredentials user Secret fromString password getPlainText domain else return new UsernamePasswordCredentials userName Secret fromString password getPlainTextpackage jenkins import com google inject Binding import com google inject Injector import com google inject Key import com google inject MembersInjector import com google inject Module import com google inject Provider import com google inject Scope import com google inject TypeLiteral import com google inject spi TypeConverterBinding import java lang annotation Annotation import java util List import java util Map import java util Set public abstract class ProxyInjector implements Injector protected abstract Injector resolve public void injectMembers Object instance resolve injectMembers instance public T MembersInjector T getMembersInjector TypeLiteral T typeLiteral return resolve getMembersInjector typeLiteral public T MembersInjector T getMembersInjector Class T type return resolve getMembersInjector type public Map Key Binding getBindings return resolve getBindings public Map Key Binding getAllBindings return resolve getAllBindings public T Binding T getBinding Key T key return resolve getBinding key public T Binding T getBinding Class T type return resolve getBinding type public T Binding T getExistingBinding Key T key return resolve getExistingBinding key public T List Binding T findBindingsByType TypeLiteral T type return resolve findBindingsByType type public T Provider T getProvider Key T key return resolve getProvider key public T Provider T getProvider Class T type return resolve getProvider type public T T getInstance Key T key return resolve getInstance key public T T getInstance Class T type return resolve getInstance type public Injector getParent return resolve getParent public Injector createChildInjector Iterable extends Module modules return resolve createChildInjector modules public Injector createChildInjector Module modules return resolve createChildInjector modules public Map Class extends Annotation Scope getScopeBindings return resolve getScopeBindings public Set TypeConverterBinding getTypeConverterBindings return resolve getTypeConverterBindingspackage hudson model import hudson Extension import hudson Util import hudson model Descriptor FormException import hudson util FormValidation import java io IOException import java util Collection import javax servlet ServletException import jenkins model Jenkins import org jenkinsci Symbol import org kohsuke stapler DataBoundConstructor import org kohsuke stapler QueryParameter import org kohsuke stapler Stapler import org kohsuke stapler StaplerFallback import org kohsuke stapler StaplerRequest import org kohsuke stapler StaplerResponse import org kohsuke stapler interceptor RequirePOST public class ProxyView extends View implements StaplerFallback private String proxiedViewName DataBoundConstructor public ProxyView String name super name if Jenkins getInstance getView name null if this is a valid global view name let s assume the user wants to show it proxiedViewName name public View getProxiedView if proxiedViewName null just so we avoid errors just after creation return Jenkins getInstance getPrimaryView else return Jenkins getInstance getView proxiedViewName public String getProxiedViewName return proxiedViewName public void setProxiedViewName String proxiedViewName this proxiedViewName proxiedViewName Override public Collection TopLevelItem getItems return getProxiedView getItems Override public boolean contains TopLevelItem item return getProxiedView contains item Override protected void submit StaplerRequest req throws IOException ServletException FormException String proxiedViewName req getSubmittedForm getString proxiedViewName if Jenkins getInstance getView proxiedViewName null throw new FormException Not an existing global view proxiedViewName this proxiedViewName proxiedViewName RequirePOST Override public Item doCreateItem StaplerRequest req StaplerResponse rsp throws IOException ServletException return getProxiedView doCreateItem req rsp public FormValidation doViewExistsCheck QueryParameter String value checkPermission View CREATE String view Util fixEmpty value if view null return FormValidation ok if Jenkins getInstance getView view null return FormValidation ok else return FormValidation error Messages ProxyView NoSuchViewExists value Extension Symbol proxy public static class DescriptorImpl extends ViewDescriptor Override public String getDisplayName return Messages ProxyView DisplayName Override public boolean isInstantiable doesn t make sense to add a ProxyView to the global views return Stapler getCurrentRequest findAncestorObject ViewGroup class instanceof Jenkins public Object getStaplerFallback return getProxiedViewpackage hudson tasks import hudson DescriptorExtensionList import hudson Extension import hudson ExtensionComponent import hudson model Action import hudson model Build import hudson model BuildListener import hudson model Describable import hudson model Project import hudson model Descriptor import jenkins model Jenkins import java util List import java util ArrayList import java util Collections import java util Comparator public abstract class Publisher extends BuildStepCompatibilityLayer implements Describable Publisher Deprecated protected Publisher these two methods need to remain to keep binary compatibility with plugins built with Hudson 1 150 Deprecated Override public boolean prebuild Build build BuildListener listener return true Deprecated Override public Action getProjectAction Project project return null public boolean needsToRunAfterFinalized return false public Descriptor Publisher getDescriptor return Jenkins getInstance getDescriptorOrDie getClass public static final class DescriptorExtensionListImpl extends DescriptorExtensionList Publisher Descriptor Publisher implements Comparator ExtensionComponent Descriptor Publisher public DescriptorExtensionListImpl Jenkins hudson super hudson Publisher class Override protected List ExtensionComponent Descriptor Publisher sort List ExtensionComponent Descriptor Publisher r List ExtensionComponent Descriptor Publisher copy new ArrayList ExtensionComponent Descriptor Publisher r Collections sort copy this return copy public int compare ExtensionComponent Descriptor Publisher lhs ExtensionComponent Descriptor Publisher rhs int r classify lhs getInstance classify rhs getInstance if r 0 return r return lhs compareTo rhs private int classify Descriptor Publisher d if d isSubTypeOf Recorder class return 0 if d isSubTypeOf Notifier class return 2 for compatibility if the descriptor is manually registered in a specific way detect that Class extends Publisher kind PublisherList KIND get d if kind Recorder class return 0 if kind Notifier class return 2 return 1 for backward compatibility the signature is not BuildStepDescriptor public static DescriptorExtensionList Publisher Descriptor Publisher all return Jenkins getInstance Publisher Descriptor Publisher getDescriptorList Publisher classpackage com kaku colorfulnews widget import android content Context import android support annotation NonNull import android support annotation Nullable import android support v4 view ViewCompat import android support v4 widget ViewDragHelper import android util AttributeSet import android view MotionEvent import android view View import android view ViewConfiguration import android widget FrameLayout public class PullBackLayout extends FrameLayout private final ViewDragHelper dragger http blog csdn net lmj623565791 article details 46858663 private final int minimumFlingVelocity Nullable private Callback callback public PullBackLayout Context context this context null public PullBackLayout Context context AttributeSet attrs this context attrs 0 public PullBackLayout Context context AttributeSet attrs int defStyleAttr super context attrs defStyleAttr dragger ViewDragHelper create this 1f 8f new ViewDragCallback 1f 8f minimumFlingVelocity ViewConfiguration get context getScaledMinimumFlingVelocity public void setCallback Nullable Callback callback this callback callback Override public boolean onInterceptTouchEvent MotionEvent ev try return dragger shouldInterceptTouchEvent ev catch Exception e e printStackTrace return false Override public boolean onTouchEvent NonNull MotionEvent event try dragger processTouchEvent event return true catch Exception e e printStackTrace return false Override public void computeScroll if dragger continueSettling true ViewCompat postInvalidateOnAnimation this public interface Callback void onPullStart void onPull float progress void onPullCancel void onPullComplete private class ViewDragCallback extends ViewDragHelper Callback Override public boolean tryCaptureView View child int pointerId return true Override public int clampViewPositionHorizontal View child int left int dx return 0 Override public int clampViewPositionVertical View child int top int dy return Math max 0 top Override public int getViewHorizontalDragRange View child return 0 Override public int getViewVerticalDragRange View child return getHeight Override public void onViewCaptured View capturedChild int activePointerId if callback null callback onPullStart Override public void onViewPositionChanged View changedView int left int top int dx int dy if callback null callback onPull float top float getHeight Override public void onViewReleased View releasedChild float xvel float yvel int slop yvel minimumFlingVelocity getHeight 6 getHeight 3 if releasedChild getTop slop if callback null callback onPullComplete else if callback null callback onPullCancel dragger settleCapturedViewAt 0 0 invalidatepackage hudson scm browsers public final class QueryBuilder private final StringBuilder buf new StringBuilder public QueryBuilder String s add s public QueryBuilder add String s if s null return this nothing to add if buf length 0 buf append else buf append buf append s return this Override public String toString return buf toStringpackage hudson util import javax servlet http HttpServletRequest import java io UnsupportedEncodingException import java net URLDecoder import java util ArrayList import java util Collections import java util HashMap import java util List import java util Map public class QueryParameterMap private final Map String List String store new HashMap String List String public QueryParameterMap String queryString if queryString null queryString length 0 return try for String param queryString split String kv param split String key URLDecoder decode kv 0 UTF 8 String value URLDecoder decode kv 1 UTF 8 List String values store get key if values null store put key values new ArrayList String values add value catch UnsupportedEncodingException e throw new AssertionError e public QueryParameterMap HttpServletRequest req this req getQueryString public String get String name List String v store get name return v null v get 0 null public List String getAll String name List String v store get name return v null Collections unmodifiableList v Collections String emptyListpackage hudson model import com google common cache Cache import com google common cache CacheBuilder import com infradna tool bridge method injector WithBridgeMethods import hudson BulkChange import hudson ExtensionList import hudson ExtensionPoint import hudson Util import hudson XmlFile import hudson init Initializer import static hudson init InitMilestone JOB LOADED import static hudson util Iterators reverse import hudson cli declarative CLIResolver import hudson model labels LabelAssignmentAction import hudson model queue AbstractQueueTask import hudson model queue Executables import hudson model queue QueueListener import hudson model queue QueueTaskFuture import hudson model queue ScheduleResult import hudson model queue ScheduleResult Created import hudson model queue SubTask import hudson model queue FutureImpl import hudson model queue MappingWorksheet import hudson model queue MappingWorksheet Mapping import hudson model queue QueueSorter import hudson model queue QueueTaskDispatcher import hudson model queue Tasks import hudson model queue WorkUnit import hudson model Node Mode import hudson model listeners SaveableListener import hudson model queue CauseOfBlockage import hudson model queue FoldableAction import hudson model queue CauseOfBlockage BecauseLabelIsBusy import hudson model queue CauseOfBlockage BecauseNodeIsOffline import hudson model queue CauseOfBlockage BecauseLabelIsOffline import hudson model queue CauseOfBlockage BecauseNodeIsBusy import hudson model queue WorkUnitContext import hudson security AccessControlled import jenkins security QueueItemAuthenticatorProvider import jenkins util Timer import hudson triggers SafeTimerTask import hudson util TimeUnit2 import hudson util XStream2 import hudson util ConsistentHash import hudson util ConsistentHash Hash import java io BufferedReader import java io File import java io FileInputStream import java io IOException import java io InputStreamReader import java lang ref WeakReference import java util ArrayList import java util Arrays import java util Calendar import java util Collection import java util Collections import java util GregorianCalendar import java util HashMap import java util HashSet import java util Iterator import java util LinkedHashSet import java util List import java util Map import java util NoSuchElementException import java util Set import java util TreeSet import java util concurrent Callable import java util concurrent TimeUnit import java util concurrent Future import java util concurrent atomic AtomicLong import java util concurrent locks Condition import java util concurrent locks ReentrantLock import java util logging Level import java util logging Logger import javax annotation Nonnull import javax servlet ServletException import jenkins model Jenkins import jenkins security QueueItemAuthenticator import jenkins util AtmostOneTaskExecutor import org acegisecurity AccessDeniedException import org acegisecurity Authentication import org jenkinsci bytecode AdaptField import org jenkinsci remoting RoleChecker import org kohsuke accmod restrictions NoExternalUse import org kohsuke stapler HttpResponse import org kohsuke stapler HttpResponses import org kohsuke stapler export Exported import org kohsuke stapler export ExportedBean import org kohsuke accmod Restricted import org kohsuke accmod restrictions DoNotUse import com thoughtworks xstream XStream import com thoughtworks xstream converters basic AbstractSingleValueConverter import edu umd cs findbugs annotations SuppressFBWarnings import jenkins util SystemProperties import javax annotation CheckForNull import javax annotation Nonnegative import jenkins model queue AsynchronousExecution import org kohsuke stapler QueryParameter import org kohsuke stapler interceptor RequirePOST ExportedBean public class Queue extends ResourceController implements Saveable private final Set WaitingItem waitingList new TreeSet WaitingItem private final ItemList BlockedItem blockedProjects new ItemList BlockedItem private final ItemList BuildableItem buildables new ItemList BuildableItem private final ItemList BuildableItem pendings new ItemList BuildableItem private transient volatile Snapshot snapshot new Snapshot waitingList blockedProjects buildables pendings private final Cache Long LeftItem leftItems CacheBuilder newBuilder expireAfterWrite 5 60 TimeUnit SECONDS build public class JobOffer extends MappingWorksheet ExecutorSlot public final Executor executor private WorkUnit workUnit private JobOffer Executor executor this executor executor Override protected void set WorkUnit p assert this workUnit null this workUnit p assert executor isParking executor start workUnit LOGGER info Starting executor getName Override public Executor getExecutor return executor public boolean canTake BuildableItem item Node node getNode if node null return false this executor is about to die if node canTake item null return false this node is not able to take the task for QueueTaskDispatcher d QueueTaskDispatcher all if d canTake node item null return false return isAvailable public boolean isAvailable return workUnit null executor getOwner isOffline executor getOwner isAcceptingTasks CheckForNull public Node getNode return executor getOwner getNode public boolean isNotExclusive return getNode getMode Mode NORMAL Override public String toString return String format JobOffer s d executor getOwner getName executor getNumber private volatile transient LoadBalancer loadBalancer private volatile transient QueueSorter sorter private transient final AtmostOneTaskExecutor Void maintainerThread new AtmostOneTaskExecutor Void new Callable Void Override public Void call throws Exception maintain return null Override public String toString return Periodic Jenkins queue maintenance private transient final ReentrantLock lock new ReentrantLock private transient final Condition condition lock newCondition public Queue Nonnull LoadBalancer loadBalancer this loadBalancer loadBalancer sanitize if all the executors are busy doing something then the queue won t be maintained in timely fashion so use another thread to make sure it happens new MaintainTask this periodic public LoadBalancer getLoadBalancer return loadBalancer public void setLoadBalancer Nonnull LoadBalancer loadBalancer if loadBalancer null throw new IllegalArgumentException this loadBalancer loadBalancer sanitize public QueueSorter getSorter return sorter public void setSorter QueueSorter sorter this sorter sorter static class State public long counter public List Item items new ArrayList Item public void load lock lock try try Clear items for the benefit of reloading waitingList clear blockedProjects clear buildables clear pendings clear first try the old format File queueFile getQueueFile if queueFile exists try BufferedReader in new BufferedReader new InputStreamReader new FileInputStream queueFile String line while line in readLine null AbstractProject j Jenkins getInstance getItemByFullName line AbstractProject class if j null j scheduleBuild discard the queue file now that we are done queueFile delete else queueFile getXMLQueueFile if queueFile exists Object unmarshaledObj new XmlFile XSTREAM queueFile read List items if unmarshaledObj instanceof State State state State unmarshaledObj items state items WaitingItem COUNTER set state counter else backward compatibility it s an old List queue xml items List unmarshaledObj long maxId 0 for Object o items if o instanceof Item maxId Math max maxId Item o id WaitingItem COUNTER set maxId for Object o items if o instanceof Task backward compatibility schedule Task o 0 else if o instanceof Item Item item Item o if item task null continue botched persistence throw this one away if item instanceof WaitingItem item enter this else if item instanceof BlockedItem item enter this else if item instanceof BuildableItem item enter this else throw new IllegalStateException Unknown item type item I just had an incident where all the executors are dead at AbstractProject getRuns because runs is null Debugger revealed that this is caused by a MatrixConfiguration object that doesn t appear to be de serialized properly I don t know how this problem happened but to diagnose this problem better when it happens again save the old queue file for introspection File bk new File queueFile getPath bak bk delete queueFile renameTo bk queueFile delete catch IOException e LOGGER log Level WARNING Failed to load the queue file getXMLQueueFile e finally updateSnapshot finally lock unlock public void save if BulkChange contains this return XmlFile queueFile new XmlFile XSTREAM getXMLQueueFile lock lock try write out the queue state we want to save State state new State state counter WaitingItem COUNTER longValue write out the tasks on the queue for Item item getItems if item task instanceof TransientTask continue state items add item try queueFile write state catch IOException e LOGGER log Level WARNING Failed to write out the queue file getXMLQueueFile e finally lock unlock SaveableListener fireOnChange this queueFile public void clear Jenkins getInstance checkPermission Jenkins ADMINISTER lock lock try try for WaitingItem i new ArrayList WaitingItem waitingList copy the list as we ll modify it in the loop i cancel this blockedProjects cancelAll pendings cancelAll buildables cancelAll finally updateSnapshot finally lock unlock scheduleMaintenance private File getQueueFile return new File Jenkins getInstance getRootDir queue txt File getXMLQueueFile return new File Jenkins getInstance getRootDir queue xml Deprecated public boolean add AbstractProject p return schedule p null public CheckForNull WaitingItem schedule AbstractProject p return schedule p p getQuietPeriod Deprecated public boolean add AbstractProject p int quietPeriod return schedule p quietPeriod null Deprecated public WaitingItem schedule Task p int quietPeriod List Action actions return schedule2 p quietPeriod actions getCreateItem public Nonnull ScheduleResult schedule2 Task p int quietPeriod List Action actions remove nulls actions new ArrayList Action actions for Iterator Action itr actions iterator itr hasNext Action a itr next if a null itr remove lock lock try try for QueueDecisionHandler h QueueDecisionHandler all if h shouldSchedule p actions return ScheduleResult refused veto return scheduleInternal p quietPeriod actions finally updateSnapshot finally lock unlock private Nonnull ScheduleResult scheduleInternal Task p int quietPeriod List Action actions lock lock try try Calendar due new GregorianCalendar due add Calendar SECOND quietPeriod Do we already have this task in the queue Because if so we won t schedule a new one List Item duplicatesInQueue new ArrayList Item for Item item liveGetItems p boolean shouldScheduleItem false for QueueAction action item getActions QueueAction class shouldScheduleItem action shouldSchedule actions for QueueAction action Util filter actions QueueAction class shouldScheduleItem action shouldSchedule new ArrayList Action item getAllActions if shouldScheduleItem duplicatesInQueue add item if duplicatesInQueue isEmpty LOGGER log Level FINE 0 added to queue p put the item in the queue WaitingItem added new WaitingItem due p actions added enter this scheduleMaintenance let an executor know that a new item is in the queue return ScheduleResult created added LOGGER log Level FINE 0 is already in the queue p but let the actions affect the existing stuff for Item item duplicatesInQueue for FoldableAction a Util filter actions FoldableAction class a foldIntoExisting item p actions boolean queueUpdated false for WaitingItem wi Util filter duplicatesInQueue WaitingItem class make sure to always use the shorter of the available due times if wi timestamp before due continue waitingList is sorted so when we change a timestamp we need to maintain order wi leave this wi timestamp due wi enter this queueUpdated true if queueUpdated scheduleMaintenance REVISIT when there are multiple existing items in the queue that matches the incoming one whether the new one should affect all existing ones or not is debatable I for myself thought this would only affect one so the code was bit of surprise but I m keeping the current behaviour return ScheduleResult existing duplicatesInQueue get 0 finally updateSnapshot finally lock unlock Deprecated public boolean add Task p int quietPeriod return schedule p quietPeriod null public CheckForNull WaitingItem schedule Task p int quietPeriod return schedule p quietPeriod new Action 0 Deprecated public boolean add Task p int quietPeriod Action actions return schedule p quietPeriod actions null public CheckForNull WaitingItem schedule Task p int quietPeriod Action actions return schedule2 p quietPeriod actions getCreateItem public Nonnull ScheduleResult schedule2 Task p int quietPeriod Action actions return schedule2 p quietPeriod Arrays asList actions public boolean cancel Task p lock lock try try LOGGER log Level FINE Cancelling 0 p for WaitingItem item waitingList if item task equals p return item cancel this use bitwise OR to make sure that both branches get evaluated all the time return blockedProjects cancel p null buildables cancel p null finally updateSnapshot finally lock unlock private void updateSnapshot snapshot new Snapshot waitingList blockedProjects buildables pendings public boolean cancel Item item LOGGER log Level FINE Cancelling 0 item 1 new Object item task item id lock lock try try return item cancel this finally updateSnapshot finally lock unlock RequirePOST public HttpResponse doCancelItem QueryParameter long id throws IOException ServletException Item item getItem id if item null cancel item else too late ignore JENKINS 14813 return HttpResponses forwardToPreviousPage public boolean isEmpty Snapshot snapshot this snapshot return snapshot waitingList isEmpty snapshot blockedProjects isEmpty snapshot buildables isEmpty snapshot pendings isEmpty private WaitingItem peek return waitingList iterator next Exported inline true public Item getItems Snapshot s this snapshot List Item r new ArrayList Item for WaitingItem p s waitingList r checkPermissionsAndAddToList r p for BlockedItem p s blockedProjects r checkPermissionsAndAddToList r p for BuildableItem p reverse s buildables r checkPermissionsAndAddToList r p for BuildableItem p reverse s pendings r checkPermissionsAndAddToList r p Item items new Item r size r toArray items return items private List Item checkPermissionsAndAddToList List Item r Item t if t task instanceof hudson security AccessControlled if hudson security AccessControlled t task hasPermission hudson model Item READ hudson security AccessControlled t task hasPermission hudson security Permission READ r add t return r Restricted NoExternalUse class Exported inline true public StubItem getDiscoverableItems Snapshot s this snapshot List StubItem r new ArrayList StubItem for WaitingItem p s waitingList r filterDiscoverableItemListBasedOnPermissions r p for BlockedItem p s blockedProjects r filterDiscoverableItemListBasedOnPermissions r p for BuildableItem p reverse s buildables r filterDiscoverableItemListBasedOnPermissions r p for BuildableItem p reverse s pendings r filterDiscoverableItemListBasedOnPermissions r p StubItem items new StubItem r size r toArray items return items private List StubItem filterDiscoverableItemListBasedOnPermissions List StubItem r Item t if t task instanceof hudson model Item if hudson model Item t task hasPermission hudson model Item READ hudson model Item t task hasPermission hudson model Item DISCOVER r add new StubItem new StubTask t task return r Deprecated public List Item getApproximateItemsQuickly return Arrays asList getItems public Item getItem long id Snapshot snapshot this snapshot for Item item snapshot blockedProjects if item id id return item for Item item snapshot buildables if item id id return item for Item item snapshot pendings if item id id return item for Item item snapshot waitingList if item id id return item return leftItems getIfPresent id public List BuildableItem getBuildableItems Computer c Snapshot snapshot this snapshot List BuildableItem result new ArrayList BuildableItem getBuildableItems c snapshot buildables result getBuildableItems c snapshot pendings result return result private void getBuildableItems Computer c List BuildableItem col List BuildableItem result Node node c getNode if node null Deleted computers cannot take build items return for BuildableItem p col if node canTake p null result add p public List BuildableItem getBuildableItems Snapshot snapshot this snapshot ArrayList BuildableItem r new ArrayList BuildableItem snapshot buildables r addAll snapshot pendings return r public List BuildableItem getPendingItems return new ArrayList BuildableItem snapshot pendings protected List BlockedItem getBlockedItems return new ArrayList BlockedItem snapshot blockedProjects public Collection LeftItem getLeftItems return Collections unmodifiableCollection leftItems asMap values public void clearLeftItems leftItems invalidateAll public List Item getUnblockedItems Snapshot snapshot this snapshot List Item queuedNotBlocked new ArrayList Item queuedNotBlocked addAll snapshot waitingList queuedNotBlocked addAll snapshot buildables queuedNotBlocked addAll snapshot pendings but not blockedProjects return queuedNotBlocked public Set Task getUnblockedTasks List Item items getUnblockedItems Set Task unblockedTasks new HashSet Task items size for Queue Item t items unblockedTasks add t task return unblockedTasks public boolean isPending Task t Snapshot snapshot this snapshot for BuildableItem i snapshot pendings if i task equals t return true return false public Nonnegative int countBuildableItemsFor CheckForNull Label l Snapshot snapshot this snapshot int r 0 for BuildableItem bi snapshot buildables for SubTask st bi task getSubTasks if null l bi getAssignedLabelFor st l r for BuildableItem bi snapshot pendings for SubTask st bi task getSubTasks if null l bi getAssignedLabelFor st l r return r public Nonnegative int strictCountBuildableItemsFor CheckForNull Label l Snapshot snapshot this snapshot int r 0 for BuildableItem bi snapshot buildables for SubTask st bi task getSubTasks if bi getAssignedLabelFor st l r for BuildableItem bi snapshot pendings for SubTask st bi task getSubTasks if bi getAssignedLabelFor st l r return r public int countBuildableItems return countBuildableItemsFor null public Item getItem Task t Snapshot snapshot this snapshot for Item item snapshot blockedProjects if item task equals t return item for Item item snapshot buildables if item task equals t return item for Item item snapshot pendings if item task equals t return item for Item item snapshot waitingList if item task equals t return item return null private List Item liveGetItems Task t lock lock try List Item result new ArrayList Item result addAll blockedProjects getAll t result addAll buildables getAll t result addAll pendings getAll t for Item item waitingList if item task equals t result add item return result finally lock unlock public List Item getItems Task t Snapshot snapshot this snapshot List Item result new ArrayList Item for Item item snapshot blockedProjects if item task equals t result add item for Item item snapshot buildables if item task equals t result add item for Item item snapshot pendings if item task equals t result add item for Item item snapshot waitingList if item task equals t result add item return result public boolean contains Task t return getItem t null void onStartExecuting Executor exec throws InterruptedException lock lock try try final WorkUnit wu exec getCurrentWorkUnit pendings remove wu context item LeftItem li new LeftItem wu context li enter this finally updateSnapshot finally lock unlock WithBridgeMethods void class public Future scheduleMaintenance LOGGER info Scheduling maintenance return maintainerThread submit private boolean isBuildBlocked Item i if i task isBuildBlocked canRun i task getResourceList return true for QueueTaskDispatcher d QueueTaskDispatcher all if d canRun i null return true return false private boolean allowNewBuildableTask Task t try if t isConcurrentBuild return true catch AbstractMethodError e earlier versions don t have the isConcurrentBuild method so fall back gracefully return buildables containsKey t pendings containsKey t public static void withLock Runnable runnable final Jenkins jenkins Jenkins getInstanceOrNull TODO confirm safe to assume non null and use getInstance final Queue queue jenkins null null jenkins getQueue if queue null runnable run else queue withLock runnable public static V T extends Throwable V withLock hudson remoting Callable V T callable throws T final Jenkins jenkins Jenkins getInstanceOrNull TODO confirm safe to assume non null and use getInstance final Queue queue jenkins null null jenkins getQueue if queue null return callable call else return queue withLock callable public static V V withLock java util concurrent Callable V callable throws Exception final Jenkins jenkins Jenkins getInstanceOrNull TODO confirm safe to assume non null and use getInstance final Queue queue jenkins null null jenkins getQueue if queue null return callable call else return queue withLock callable public static boolean tryWithLock Runnable runnable final Jenkins jenkins Jenkins getInstanceOrNull TODO confirm safe to assume non null and use getInstance final Queue queue jenkins null null jenkins getQueue if queue null runnable run return true else return queue tryWithLock runnable public static Runnable wrapWithLock Runnable runnable final Jenkins jenkins Jenkins getInstanceOrNull TODO confirm safe to assume non null and use getInstance final Queue queue jenkins null null jenkins getQueue return queue null runnable new LockedRunnable runnable public static V T extends Throwable hudson remoting Callable V T wrapWithLock hudson remoting Callable V T callable final Jenkins jenkins Jenkins getInstanceOrNull TODO confirm safe to assume non null and use getInstance final Queue queue jenkins null null jenkins getQueue return queue null callable new LockedHRCallable callable public static V java util concurrent Callable V wrapWithLock java util concurrent Callable V callable final Jenkins jenkins Jenkins getInstanceOrNull TODO confirm safe to assume non null and use getInstance final Queue queue jenkins null null jenkins getQueue return queue null callable new LockedJUCCallable V callable Override protected void await throws InterruptedException condition await Override protected void signalAll condition signalAll protected void withLock Runnable runnable lock lock try runnable run finally lock unlock protected boolean tryWithLock Runnable runnable if lock tryLock try runnable run finally lock unlock return true else return false protected V T extends Throwable V withLock hudson remoting Callable V T callable throws T lock lock try return callable call finally lock unlock protected V V withLock java util concurrent Callable V callable throws Exception lock lock try return callable call finally lock unlock public void maintain lock lock try try LOGGER log Level FINE Queue maintenance started on 0 with 1 new Object this snapshot The executors that are currently waiting for a job to run Map Executor JobOffer parked new HashMap Executor JobOffer update parked and identify any pending items whose executor has disappeared List BuildableItem lostPendings new ArrayList BuildableItem pendings for Computer c Jenkins getInstance getComputers for Executor e c getExecutors if e isInterrupted JENKINS 28840 we will deadlock if we try to touch this executor while interrupt flag set we need to clear lost pendings as we cannot know what work unit was on this executor while it is interrupted All this dancing is a result of Executor extending Thread lostPendings clear we ll get them next time around when the flag is cleared LOGGER log Level FINEST Interrupt thread for executor 0 is set and we do not know what work unit was on the executor e getDisplayName continue if e isParking LOGGER log Level FINEST 0 is parking and is waiting for a job to execute e getDisplayName parked put e new JobOffer e final WorkUnit workUnit e getCurrentWorkUnit if workUnit null lostPendings remove workUnit context item pending buildable for BuildableItem p lostPendings LOGGER log Level FINE BuildableItem 0 pending buildable as the assigned executor disappeared p task getFullDisplayName p isPending false pendings remove p makeBuildable p final QueueSorter s sorter blocked buildable copy as we ll mutate the list and we want to process in a potentially different order List BlockedItem blockedItems new ArrayList blockedProjects values if facing a cycle of blocked tasks ensure we process in the desired sort order if s null s sortBlockedItems blockedItems else Collections sort blockedItems QueueSorter DEFAULT BLOCKED ITEM COMPARATOR for BlockedItem p blockedItems String taskDisplayName p task getFullDisplayName LOGGER log Level FINEST Current blocked item 0 taskDisplayName if isBuildBlocked p allowNewBuildableTask p task LOGGER log Level FINEST BlockedItem 0 blocked buildable as the build is not blocked and new tasks are allowed taskDisplayName ready to be executed Runnable r makeBuildable new BuildableItem p if r null p leave this r run JENKINS 28926 we have removed a task from the blocked projects and added to building thus we should update the snapshot so that subsequent blocked projects can correctly determine if they are blocked by the lucky winner updateSnapshot waitingList buildable blocked while waitingList isEmpty WaitingItem top peek if top timestamp compareTo new GregorianCalendar 0 LOGGER log Level FINEST Finished moving all ready items from queue break finished moving all ready items from queue top leave this Task p top task if isBuildBlocked top allowNewBuildableTask p ready to be executed immediately Runnable r makeBuildable new BuildableItem top String topTaskDisplayName top task getFullDisplayName if r null LOGGER log Level FINEST Executing runnable 0 topTaskDisplayName r run else LOGGER log Level FINEST Item 0 was unable to be made a buildable and is now a blocked item topTaskDisplayName new BlockedItem top enter this else this can t be built now because another build is in progress set this project aside new BlockedItem top enter this if s null s sortBuildableItems buildables Ensure that identification of blocked tasks is using the live state JENKINS 27708 JENKINS 27871 updateSnapshot allocate buildable jobs to executors for BuildableItem p new ArrayList BuildableItem buildables copy as we ll mutate the list in the loop one last check to make sure this build is not blocked if isBuildBlocked p p leave this new BlockedItem p enter this LOGGER log Level FINE Catching that 0 is blocked in the last minute p JENKINS 28926 we have moved an unblocked task into the blocked state update snapshot so that other buildables which might have been blocked by this can see the state change updateSnapshot continue String taskDisplayName p task getFullDisplayName if p task instanceof FlyweightTask Runnable r makeFlyWeightTaskBuildable new BuildableItem p if r null p leave this LOGGER log Level FINEST Executing flyweight task 0 taskDisplayName r run updateSnapshot else List JobOffer candidates new ArrayList JobOffer parked size for JobOffer j parked values if j canTake p LOGGER log Level FINEST 0 is a potential candidate for task 1 new Object j executor getDisplayName taskDisplayName candidates add j MappingWorksheet ws new MappingWorksheet p candidates Mapping m loadBalancer map p task ws if m null if we couldn t find the executor that fits just leave it in the buildables list and check if we can execute other projects LOGGER log Level FINER Failed to map 0 to executors candidates 1 parked 2 new Object p candidates parked values continue found a matching executor use it WorkUnitContext wuc new WorkUnitContext p LOGGER log Level FINEST Found a matching executor for 0 Using it taskDisplayName m execute wuc p leave this if wuc getWorkUnits isEmpty LOGGER log Level FINEST BuildableItem 0 marked as pending taskDisplayName makePending p else LOGGER log Level FINEST BuildableItem 0 with empty work units p Ensure that identification of blocked tasks is using the live state JENKINS 27708 JENKINS 27871 The creation of a snapshot itself should be relatively cheap given the expected rate of job execution You probably would need 100 s of jobs starting execution every iteration of maintain before this could even start to become an issue and likely the calculation of isBuildBlocked p will become a bottleneck before updateSnapshot will Additionally since the snapshot itself only ever has at most one reference originating outside of the stack it should remain in the eden space and thus be cheap to GC See https issues jenkins ci org browse JENKINS 27708 focusedCommentId 225819 page com atlassian jira plugin system issuetabpanels comment tabpanel comment 225819 or https issues jenkins ci org browse JENKINS 27708 focusedCommentId 225906 page com atlassian jira plugin system issuetabpanels comment tabpanel comment 225906 for alternative fixes of this issue updateSnapshot finally updateSnapshot finally lock unlock private CheckForNull Runnable makeBuildable final BuildableItem p if p task instanceof FlyweightTask String taskDisplayName p task getFullDisplayName if isBlockedByShutdown p task Runnable runnable makeFlyWeightTaskBuildable p LOGGER log Level FINEST Converting flyweight task 0 into a BuildableRunnable taskDisplayName if runnable null return runnable this is to solve JENKINS 30084 the task has to be buildable to force the provisioning of nodes if the execution gets here it means the task could not be scheduled since the node the task is supposed to run on is offline or not available Thus the flyweighttask enters the buildables queue and will ask Jenkins to provision a node LOGGER log Level FINEST Flyweight task 0 is entering as buildable to provision a node taskDisplayName return new BuildableRunnable p if the execution gets here it means the task is blocked by shutdown and null is returned LOGGER log Level FINEST Task 0 is blocked by shutdown taskDisplayName return null else regular heavyweight task return new BuildableRunnable p CheckForNull private Runnable makeFlyWeightTaskBuildable final BuildableItem p we double check if this is a flyweight task if p task instanceof FlyweightTask Jenkins h Jenkins getInstance Map Node Integer hashSource new HashMap Node Integer h getNodes size Even if master is configured with zero executors we may need to run a flyweight task like MatrixProject on it hashSource put h Math max h getNumExecutors 100 1 for Node n h getNodes hashSource put n n getNumExecutors 100 ConsistentHash Node hash new ConsistentHash Node NODE HASH hash addAll hashSource Label lbl p getAssignedLabel for Node n hash list p task getFullDisplayName final Computer c n toComputer if c null c isOffline continue if lbl null lbl contains n continue if n canTake p null continue LOGGER log Level FINEST Creating flyweight task 0 for computer 1 new Object p task getFullDisplayName c getName return new Runnable Override public void run c startFlyWeightTask new WorkUnitContext p createWorkUnit p task makePending p return null private static Hash Node NODE HASH new Hash Node public String hash Node node return node getNodeName private boolean makePending BuildableItem p LOGGER info Making p task pending REMOVE p isPending true return pendings add p Deprecated public static boolean ifBlockedByHudsonShutdown Task task return isBlockedByShutdown task public static boolean isBlockedByShutdown Task task return Jenkins getInstance isQuietingDown task instanceof NonBlockingTask public Api getApi return new Api this public interface TransientTask extends Task public interface FlyweightTask extends Task public interface NonBlockingTask extends Task public interface Task extends ModelObject SubTask boolean isBuildBlocked Deprecated String getWhyBlocked CauseOfBlockage getCauseOfBlockage String getName String getFullDisplayName void checkAbortPermission boolean hasAbortPermission String getUrl boolean isConcurrentBuild Collection extends SubTask getSubTasks Nonnull Authentication getDefaultAuthentication Nonnull Authentication getDefaultAuthentication Queue Item item public interface Executable extends Runnable Nonnull SubTask getParent Override void run throws AsynchronousExecution long getEstimatedDuration Override String toString ExportedBean defaultVisibility 999 public static abstract class Item extends Actionable private final long id Exported public long getId return id AdaptField was int class name id Deprecated public int getIdLegacy if id Integer MAX VALUE throw new IllegalStateException Sorry you need to update any Plugins attempting to assign Queue Item id to an int value Queue Item id is now a long value and has incremented to a value greater than Integer MAX VALUE 2 31 1 return int id Exported public final Task task private transient FutureImpl future private final long inQueueSince Exported public boolean isBlocked return this instanceof BlockedItem Exported public boolean isBuildable return this instanceof BuildableItem Exported public boolean isStuck return false Exported public long getInQueueSince return this inQueueSince public String getInQueueForString long duration System currentTimeMillis this inQueueSince return Util getTimeSpanString duration WithBridgeMethods Future class public QueueTaskFuture Executable getFuture return future public Label getAssignedLabel for LabelAssignmentAction laa getActions LabelAssignmentAction class Label l laa getAssignedLabel task if l null return l return task getAssignedLabel public CheckForNull Label getAssignedLabelFor Nonnull SubTask st for LabelAssignmentAction laa getActions LabelAssignmentAction class Label l laa getAssignedLabel st if l null return l return st getAssignedLabel public final List Cause getCauses CauseAction ca getAction CauseAction class if ca null return Collections unmodifiableList ca getCauses return Collections emptyList Restricted DoNotUse class used from Jelly public String getCausesDescription List Cause causes getCauses StringBuilder s new StringBuilder for Cause c causes s append c getShortDescription append n return s toString protected Item Task task List Action actions long id FutureImpl future this task task this id id this future future this inQueueSince System currentTimeMillis for Action action actions addAction action protected Item Task task List Action actions long id FutureImpl future long inQueueSince this task task this id id this future future this inQueueSince inQueueSince for Action action actions addAction action protected Item Item item this item task new ArrayList Action item getAllActions item id item future item inQueueSince Exported public String getUrl return queue item id Exported public final String getWhy CauseOfBlockage cob getCauseOfBlockage return cob null cob getShortDescription null public abstract CauseOfBlockage getCauseOfBlockage Exported public String getParams StringBuilder s new StringBuilder for ParametersAction pa getActions ParametersAction class for ParameterValue p pa getParameters s append n append p getShortDescription return s toString public boolean hasCancelPermission return task hasAbortPermission public String getDisplayName TODO Auto generated method stub return null public String getSearchUrl TODO Auto generated method stub return null Deprecated RequirePOST public HttpResponse doCancelQueue throws IOException ServletException Jenkins getInstance getQueue cancel this return HttpResponses forwardToPreviousPage Nonnull public Authentication authenticate for QueueItemAuthenticator auth QueueItemAuthenticatorProvider authenticators Authentication a auth authenticate this if a null return a return Tasks getDefaultAuthenticationOf task this public Api getApi return new Api this private Object readResolve this future new FutureImpl task return this Override public String toString return getClass getName task id abstract void enter Queue q abstract boolean leave Queue q boolean cancel Queue q boolean r leave q if r future setAsCancelled LeftItem li new LeftItem this li enter q return r Restricted NoExternalUse class ExportedBean defaultVisibility 999 public static class StubTask private String name public StubTask Nonnull Queue Task base this name base getName Exported public String getName return name Restricted NoExternalUse class ExportedBean defaultVisibility 999 public class StubItem Exported public StubTask task public StubItem StubTask task this task task public interface QueueAction extends Action boolean shouldSchedule List Action actions public static abstract class QueueDecisionHandler implements ExtensionPoint public abstract boolean shouldSchedule Task p List Action actions public static ExtensionList QueueDecisionHandler all return ExtensionList lookup QueueDecisionHandler class public static final class WaitingItem extends Item implements Comparable WaitingItem private static final AtomicLong COUNTER new AtomicLong 0 Exported public Calendar timestamp public WaitingItem Calendar timestamp Task project List Action actions super project actions COUNTER incrementAndGet new FutureImpl project this timestamp timestamp static int getCurrentCounterValue return COUNTER intValue public int compareTo WaitingItem that int r this timestamp getTime compareTo that timestamp getTime if r 0 return r if this getId that getId return 1 else if this getId that getId return 0 else return 1 public CauseOfBlockage getCauseOfBlockage long diff timestamp getTimeInMillis System currentTimeMillis if diff 0 return CauseOfBlockage fromMessage Messages Queue InQuietPeriod Util getTimeSpanString diff else return CauseOfBlockage fromMessage Messages Queue Unknown Override void enter Queue q if q waitingList add this for QueueListener ql QueueListener all try ql onEnterWaiting this catch Throwable e don t let this kill the queue LOGGER log Level WARNING QueueListener failed while processing this e Override boolean leave Queue q boolean r q waitingList remove this if r for QueueListener ql QueueListener all try ql onLeaveWaiting this catch Throwable e don t let this kill the queue LOGGER log Level WARNING QueueListener failed while processing this e return r public static abstract class NotWaitingItem extends Item Exported public final long buildableStartMilliseconds protected NotWaitingItem WaitingItem wi super wi buildableStartMilliseconds System currentTimeMillis protected NotWaitingItem NotWaitingItem ni super ni buildableStartMilliseconds ni buildableStartMilliseconds public final class BlockedItem extends NotWaitingItem public BlockedItem WaitingItem wi super wi public BlockedItem NotWaitingItem ni super ni public CauseOfBlockage getCauseOfBlockage ResourceActivity r getBlockingActivity task if r null if r task blocked by itself meaning another build is in progress return CauseOfBlockage fromMessage Messages Queue InProgress return CauseOfBlockage fromMessage Messages Queue BlockedBy r getDisplayName for QueueTaskDispatcher d QueueTaskDispatcher all CauseOfBlockage cause d canRun this if cause null return cause return task getCauseOfBlockage void enter Queue q LOGGER log Level FINE 0 is blocked this blockedProjects add this for QueueListener ql QueueListener all try ql onEnterBlocked this catch Throwable e don t let this kill the queue LOGGER log Level WARNING QueueListener failed while processing this e boolean leave Queue q boolean r blockedProjects remove this if r LOGGER log Level FINE 0 no longer blocked this for QueueListener ql QueueListener all try ql onLeaveBlocked this catch Throwable e don t let this kill the queue LOGGER log Level WARNING QueueListener failed while processing this e return r public final static class BuildableItem extends NotWaitingItem private boolean isPending public BuildableItem WaitingItem wi super wi public BuildableItem NotWaitingItem ni super ni public CauseOfBlockage getCauseOfBlockage Jenkins jenkins Jenkins getInstance if isBlockedByShutdown task return CauseOfBlockage fromMessage Messages Queue HudsonIsAboutToShutDown Label label getAssignedLabel List Node allNodes jenkins getNodes if allNodes isEmpty label null no master agent pointless to talk about nodes if label null Set Node nodes label getNodes if label isOffline if nodes size 1 return new BecauseLabelIsOffline label else return new BecauseNodeIsOffline nodes iterator next else if nodes size 1 return new BecauseLabelIsBusy label else return new BecauseNodeIsBusy nodes iterator next else return CauseOfBlockage createNeedsMoreExecutor Messages Queue WaitingForNextAvailableExecutor Override public boolean isStuck Label label getAssignedLabel if label null label isOffline no executor online to process this job definitely stuck return true long d task getEstimatedDuration long elapsed System currentTimeMillis buildableStartMilliseconds if d 0 if we were running elsewhere we would have done this build ten times return elapsed Math max d 60000L 10 else more than a day in the queue return TimeUnit2 MILLISECONDS toHours elapsed 24 Exported public boolean isPending return isPending Override void enter Queue q q buildables add this for QueueListener ql QueueListener all try ql onEnterBuildable this catch Throwable e don t let this kill the queue LOGGER log Level WARNING QueueListener failed while processing this e Override boolean leave Queue q boolean r q buildables remove this if r LOGGER log Level FINE 0 no longer blocked this for QueueListener ql QueueListener all try ql onLeaveBuildable this catch Throwable e don t let this kill the queue LOGGER log Level WARNING QueueListener failed while processing this e return r public final static class LeftItem extends Item public final WorkUnitContext outcome public LeftItem WorkUnitContext wuc super wuc item this outcome wuc public LeftItem Item cancelled super cancelled this outcome null Override public CauseOfBlockage getCauseOfBlockage return null Exported public CheckForNull Executable getExecutable return outcome null outcome getPrimaryWorkUnit getExecutable null Exported public boolean isCancelled return outcome null Override void enter Queue q q leftItems put getId this for QueueListener ql QueueListener all try ql onLeft this catch Throwable e don t let this kill the queue LOGGER log Level WARNING QueueListener failed while processing this e Override boolean leave Queue q there s no leave operation return false private static final Logger LOGGER Logger getLogger Queue class getName public static final XStream XSTREAM new XStream2 static XSTREAM registerConverter new AbstractSingleValueConverter Override SuppressWarnings unchecked public boolean canConvert Class klazz return hudson model Item class isAssignableFrom klazz Override public Object fromString String string Object item Jenkins getInstance getItemByFullName string if item null throw new NoSuchElementException No such job exists string return item Override public String toString Object item return hudson model Item item getFullName XSTREAM registerConverter new AbstractSingleValueConverter SuppressWarnings unchecked Override public boolean canConvert Class klazz return Run class isAssignableFrom klazz Override public Object fromString String string String split string split String projectName split 0 int buildNumber Integer parseInt split 1 Job job Job Jenkins getInstance getItemByFullName projectName if job null throw new NoSuchElementException No such job exists projectName Run run job getBuildByNumber buildNumber if run null throw new NoSuchElementException No such build string return run Override public String toString Object object Run run Run object return run getParent getFullName run getNumber XSTREAM registerConverter new AbstractSingleValueConverter Override public boolean canConvert Class klazz return Queue class isAssignableFrom klazz Override public Object fromString String string return Jenkins getInstance getQueue Override public String toString Object item return queue private static class MaintainTask extends SafeTimerTask private final WeakReference Queue queue MaintainTask Queue queue this queue new WeakReference Queue queue private void periodic long interval 5000 Timer get scheduleWithFixedDelay this interval interval TimeUnit MILLISECONDS protected void doRun Queue q queue get if q null q maintain else cancel private class ItemList T extends Item extends ArrayList T public T get Task task for T item this if item task equals task return item return null public List T getAll Task task List T result new ArrayList T for T item this if item task equals task result add item return result public boolean containsKey Task task return get task null public T remove Task task Iterator T it iterator while it hasNext T t it next if t task equals task it remove return t return null public void put Task task T item assert item task equals task add item public ItemList T values return this public T cancel Task p T x get p if x null x cancel Queue this return x SuppressFBWarnings value IA AMBIGUOUS INVOCATION OF INHERITED OR OUTER METHOD justification It will invoke the inherited clear method according to Java semantics FindBugs recommends suppresing warnings in such case public void cancelAll for T t new ArrayList T this t cancel Queue this clear private static class Snapshot private final Set WaitingItem waitingList private final List BlockedItem blockedProjects private final List BuildableItem buildables private final List BuildableItem pendings public Snapshot Set WaitingItem waitingList List BlockedItem blockedProjects List BuildableItem buildables List BuildableItem pendings this waitingList new LinkedHashSet WaitingItem waitingList this blockedProjects new ArrayList BlockedItem blockedProjects this buildables new ArrayList BuildableItem buildables this pendings new ArrayList BuildableItem pendings Override public String toString return Queue Snapshot waitingList waitingList blockedProjects blockedProjects buildables buildables pendings pendings private static class LockedRunnable implements Runnable private final Runnable delegate private LockedRunnable Runnable delegate this delegate delegate Override public void run withLock delegate private class BuildableRunnable implements Runnable private final BuildableItem buildableItem private BuildableRunnable BuildableItem p this buildableItem p Override public void run the flyweighttask enters the buildables queue and will ask Jenkins to provision a node buildableItem enter Queue this private static class LockedJUCCallable V implements java util concurrent Callable V private final java util concurrent Callable V delegate private LockedJUCCallable java util concurrent Callable V delegate this delegate delegate Override public V call throws Exception return withLock delegate private static class LockedHRCallable V T extends Throwable implements hudson remoting Callable V T private static final long serialVersionUID 1L private final hudson remoting Callable V T delegate private LockedHRCallable hudson remoting Callable V T delegate this delegate delegate Override public V call throws T return withLock delegate Override public void checkRoles RoleChecker checker throws SecurityException delegate checkRoles checker CLIResolver public static Queue getInstance return Jenkins getInstance getQueue Initializer after JOB LOADED public static void init Jenkins h h getQueue loadpackage jenkins security import hudson ExtensionPoint import hudson Util import hudson model AbstractDescribableImpl import hudson model AbstractProject import hudson model Action import hudson model CauseAction import hudson model Queue import hudson model Queue Item import hudson model Queue Task import java util Calendar import java util Collections import javax annotation CheckForNull import org acegisecurity Authentication public abstract class QueueItemAuthenticator extends AbstractDescribableImpl QueueItemAuthenticator implements ExtensionPoint public CheckForNull Authentication authenticate Queue Item item if Util isOverridden QueueItemAuthenticator class getClass authenticate Queue Task class return authenticate item task else throw new AbstractMethodError you must override at least one of the QueueItemAuthenticator authenticate methods public CheckForNull Authentication authenticate Queue Task task if Util isOverridden QueueItemAuthenticator class getClass authenticate Queue Item class Need a fake unscheduled item All the other calls assume a BuildableItem but probably it does not matter return authenticate new Queue WaitingItem Calendar getInstance task Collections Action emptyList else throw new AbstractMethodError you must override at least one of the QueueItemAuthenticator authenticate methods Override public QueueItemAuthenticatorDescriptor getDescriptor return QueueItemAuthenticatorDescriptor super getDescriptorpackage jenkins security import hudson Extension import hudson util DescribableList import jenkins model GlobalConfiguration import jenkins model GlobalConfigurationCategory import jenkins model Jenkins import net sf json JSONObject import org jenkinsci Symbol import org kohsuke stapler StaplerRequest import javax annotation Nonnull import java io IOException import java util List Extension Symbol queueItemAuthenticator public class QueueItemAuthenticatorConfiguration extends GlobalConfiguration private final DescribableList QueueItemAuthenticator QueueItemAuthenticatorDescriptor authenticators new DescribableList QueueItemAuthenticator QueueItemAuthenticatorDescriptor this public QueueItemAuthenticatorConfiguration load private Object readResolve authenticators setOwner this return this Override public GlobalConfigurationCategory getCategory return GlobalConfigurationCategory get GlobalConfigurationCategory Security class public DescribableList QueueItemAuthenticator QueueItemAuthenticatorDescriptor getAuthenticators return authenticators Override public boolean configure StaplerRequest req JSONObject json throws FormException try authenticators rebuildHetero req json QueueItemAuthenticatorDescriptor all authenticators return true catch IOException e throw new FormException e authenticators public static QueueItemAuthenticatorConfiguration get return Jenkins getInstance getInjector getInstance QueueItemAuthenticatorConfiguration class Extension ordinal 100 public static class ProviderImpl extends QueueItemAuthenticatorProvider Nonnull Override public List QueueItemAuthenticator getAuthenticators return get getAuthenticatorspackage jenkins security import hudson DescriptorExtensionList import hudson model Descriptor import jenkins model Jenkins public abstract class QueueItemAuthenticatorDescriptor extends Descriptor QueueItemAuthenticator nothing defined here yet public static DescriptorExtensionList QueueItemAuthenticator QueueItemAuthenticatorDescriptor all return Jenkins getInstance getDescriptorList QueueItemAuthenticator classpackage jenkins security import hudson Extension import hudson ExtensionList import hudson ExtensionPoint import javax annotation Nonnull import java util ArrayList import java util Iterator import java util List import java util NoSuchElementException public abstract class QueueItemAuthenticatorProvider implements ExtensionPoint Nonnull public abstract List QueueItemAuthenticator getAuthenticators public static Iterable QueueItemAuthenticator authenticators return new IterableImpl private static class IteratorImpl implements Iterator QueueItemAuthenticator private final Iterator QueueItemAuthenticatorProvider providers private Iterator QueueItemAuthenticator delegate null private IteratorImpl providers ExtensionList lookup QueueItemAuthenticatorProvider class iterator Override public boolean hasNext while delegate null delegate hasNext providers hasNext final QueueItemAuthenticatorProvider provider providers next if provider null continue delegate new ArrayList QueueItemAuthenticator provider getAuthenticators iterator return delegate null delegate hasNext Override public QueueItemAuthenticator next if hasNext throw new NoSuchElementException return delegate next Override public void remove throw new UnsupportedOperationException remove private static class IterableImpl implements Iterable QueueItemAuthenticator Override public Iterator QueueItemAuthenticator iterator return new IteratorImplpackage hudson model queue import hudson ExtensionList import hudson ExtensionPoint import hudson model Queue import hudson model Queue BlockedItem import hudson model Queue BuildableItem import hudson model Queue Item import hudson model Queue LeftItem import hudson model Queue WaitingItem import java util concurrent Executor public abstract class QueueListener implements ExtensionPoint public void onEnterWaiting WaitingItem wi public void onLeaveWaiting WaitingItem wi public void onEnterBlocked BlockedItem bi public void onLeaveBlocked BlockedItem bi public void onEnterBuildable BuildableItem bi public void onLeaveBuildable BuildableItem bi public void onLeft LeftItem li public static ExtensionList QueueListener all return ExtensionList lookup QueueListener classpackage hudson model queue import hudson ExtensionList import hudson ExtensionPoint import hudson init Initializer import jenkins model Jenkins import hudson model LoadBalancer import hudson model Queue import hudson model Queue BuildableItem import java util Collections import java util Comparator import java util List import java util logging Logger import static hudson init InitMilestone JOB LOADED public abstract class QueueSorter implements ExtensionPoint public static final Comparator Queue BlockedItem DEFAULT BLOCKED ITEM COMPARATOR new Comparator Queue BlockedItem Override public int compare Queue BlockedItem o1 Queue BlockedItem o2 return Long compare o1 getInQueueSince o2 getInQueueSince public abstract void sortBuildableItems List BuildableItem buildables public void sortBlockedItems List Queue BlockedItem blockedItems Collections sort blockedItems DEFAULT BLOCKED ITEM COMPARATOR public static ExtensionList QueueSorter all return ExtensionList lookup QueueSorter class Initializer after JOB LOADED public static void installDefaultQueueSorter ExtensionList QueueSorter all all if all isEmpty return Queue q Jenkins getInstance getQueue if q getSorter null return someone has already installed something leave that alone q setSorter all get 0 if all size 1 LOGGER warning Multiple QueueSorters are registered Only the first one is used and the rest are ignored all private static final Logger LOGGER Logger getLogger QueueSorter class getNamepackage hudson model queue import hudson Extension import hudson ExtensionList import hudson ExtensionPoint import hudson slaves Cloud import hudson model Node import hudson model Queue import hudson model Queue BuildableItem import hudson model Queue Task import javax annotation CheckForNull public abstract class QueueTaskDispatcher implements ExtensionPoint Deprecated public CheckForNull CauseOfBlockage canTake Node node Task task return null public CheckForNull CauseOfBlockage canTake Node node BuildableItem item return canTake node item task backward compatible behaviour public CheckForNull CauseOfBlockage canRun Queue Item item return null public static ExtensionList QueueTaskDispatcher all return ExtensionList lookup QueueTaskDispatcher classpackage hudson model queue import hudson model Label import hudson model Node import hudson model Queue import hudson model Queue Executable import hudson model Queue Task import hudson model ResourceList import java io IOException import java util Collection import javax annotation CheckForNull public abstract class QueueTaskFilter implements Queue Task private final Queue Task base protected QueueTaskFilter Task base this base base public Label getAssignedLabel return base getAssignedLabel public Node getLastBuiltOn return base getLastBuiltOn public boolean isBuildBlocked return base isBuildBlocked public String getWhyBlocked return base getWhyBlocked public CauseOfBlockage getCauseOfBlockage return base getCauseOfBlockage public String getName return base getName public String getFullDisplayName return base getFullDisplayName public long getEstimatedDuration return base getEstimatedDuration public CheckForNull Executable createExecutable throws IOException return base createExecutable public void checkAbortPermission base checkAbortPermission public boolean hasAbortPermission return base hasAbortPermission public String getUrl return base getUrl public boolean isConcurrentBuild return base isConcurrentBuild public String getDisplayName return base getDisplayName public ResourceList getResourceList return base getResourceList public Collection extends SubTask getSubTasks return base getSubTasks public final Task getOwnerTask return this public Object getSameNodeConstraint return base getSameNodeConstraintpackage hudson model queue import hudson model Queue Executable import java util concurrent ExecutionException import java util concurrent Future public interface QueueTaskFuture R extends Executable extends Future R Future R getStartCondition R waitForStart throws InterruptedException ExecutionExceptionpackage hudson search import static java lang annotation ElementType FIELD import static java lang annotation ElementType METHOD import java lang annotation Retention import static java lang annotation RetentionPolicy RUNTIME import java lang annotation Target Retention RUNTIME Target METHOD FIELD public interface QuickSilver String value defaultpackage hudson cli import hudson Extension import jenkins model Jenkins import org kohsuke args4j Option import java util logging Logger Extension public class QuietDownCommand extends CLICommand private static final Logger LOGGER Logger getLogger QuietDownCommand class getName Option name block usage Block until the system really quiets down and no builds are running public boolean block false Option name timeout usage If non zero only block up to the specified number of milliseconds public int timeout 0 Override public String getShortDescription return Messages QuietDownCommand ShortDescription Override protected int run throws Exception Jenkins getActiveInstance doQuietDown block timeout return 0Copyright 2004 2005 Mort Bay Consulting Pty Ltd Licensed under the Apache License Version 2 0 the License you may not use this file except in compliance with the License You may obtain a copy of the License at http www apache org licenses LICENSE 2 0 Unless required by applicable law or agreed to in writing software distributed under the License is distributed on an AS IS BASIS WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND either express or implied See the License for the specific language governing permissions and limitations under the License package hudson util import java util NoSuchElementException import java util StringTokenizer import java util List import java util ArrayList public class QuotedStringTokenizer extends StringTokenizer private final static String delim t n r private String string private String delim delim private boolean returnQuotes false private boolean returnDelimiters false private StringBuilder token private boolean hasToken false private int i 0 private int lastStart 0 private boolean double true private boolean single true public static String tokenize String str return new QuotedStringTokenizer str toArray public static String tokenize String str String delimiters return new QuotedStringTokenizer str delimiters toArray public QuotedStringTokenizer String str String delim boolean returnDelimiters boolean returnQuotes super string str if delim null delim delim returnDelimiters returnDelimiters returnQuotes returnQuotes if delim indexOf 0 delim indexOf 0 throw new Error Can t use quotes as delimiters delim token new StringBuilder string length 1024 512 string length 2 public QuotedStringTokenizer String str String delim boolean returnDelimiters this str delim returnDelimiters false public QuotedStringTokenizer String str String delim this str delim false false public QuotedStringTokenizer String str this str null false false public String toArray List String r new ArrayList String while hasMoreTokens r add nextToken return r toArray new String r size Override public boolean hasMoreTokens Already found a token if hasToken return true lastStart i int state 0 boolean escape false while i string length char c string charAt i switch state case 0 Start if delim indexOf c 0 if returnDelimiters token append c return hasToken true else if c single if returnQuotes token append c state 2 else if c double if returnQuotes token append c state 3 else token append c hasToken true state 1 continue case 1 Token hasToken true if escape escape false if ESCAPABLE CHARS indexOf c 0 token append token append c else if delim indexOf c 0 if returnDelimiters i return hasToken else if c single if returnQuotes token append c state 2 else if c double if returnQuotes token append c state 3 else if c escape true else token append c continue case 2 Single Quote hasToken true if escape escape false if ESCAPABLE CHARS indexOf c 0 token append token append c else if c if returnQuotes token append c state 1 else if c if returnQuotes token append c escape true else token append c continue case 3 Double Quote hasToken true if escape escape false if ESCAPABLE CHARS indexOf c 0 token append token append c else if c if returnQuotes token append c state 1 else if c if returnQuotes token append c escape true else token append c continue return hasToken Override public String nextToken throws NoSuchElementException if hasMoreTokens token null throw new NoSuchElementException String t token toString token setLength 0 hasToken false return t Override public String nextToken String delim throws NoSuchElementException delim delim i lastStart token setLength 0 hasToken false return nextToken Override public boolean hasMoreElements return hasMoreTokens Override public Object nextElement throws NoSuchElementException return nextToken Override public int countTokens return 1 public static String quote String s String delim if s null return null if s length 0 return for int i 0 i s length i char c s charAt i if c c c Character isWhitespace c delim indexOf c 0 StringBuffer b new StringBuffer s length 8 quote b s return b toString return s public static String quote String s if s null return null if s length 0 return StringBuffer b new StringBuffer s length 8 quote b s return b toString public static void quote StringBuffer buf String s synchronized buf buf append for int i 0 i s length i char c s charAt i switch c case buf append continue case buf append continue case n buf append n continue case r buf append r continue case t buf append t continue case f buf append f continue case b buf append b continue default buf append c continue buf append public static String unquote String s if s null return null if s length 2 return s char first s charAt 0 char last s charAt s length 1 if first last first first return s StringBuilder b new StringBuilder s length 2 boolean escape false for int i 1 i s length 1 i char c s charAt i if escape escape false switch c case n b append n break case r b append r break case t b append t break case f b append f break case b b append b break case u b append char convertHexDigit byte s charAt i 24 convertHexDigit byte s charAt i 16 convertHexDigit byte s charAt i 8 convertHexDigit byte s charAt i break default b append c else if c escape true continue else b append c return b toString public boolean getDouble return double public void setDouble boolean d double d public boolean getSingle return single public void setSingle boolean single single single public static byte convertHexDigit byte b if b 0 b 9 return byte b 0 if b a b f return byte b a 10 if b A b F return byte b A 10 return 0 private static final String ESCAPABLE CHARSpackage com kaku colorfulnews widget import android content Context import android util AttributeSet import android widget ImageView public class RatioImageView extends ImageView private int originalWidth 1 private int originalHeight 1 public RatioImageView Context context super context public RatioImageView Context context AttributeSet attrs super context attrs public RatioImageView Context context AttributeSet attrs int defStyleAttr super context attrs defStyleAttr public void setOriginalSize int originalWidth int originalHeight this originalWidth originalWidth this originalHeight originalHeight Override protected void onMeasure int widthMeasureSpec int heightMeasureSpec if originalWidth 0 originalHeight 0 float ratio float originalWidth float originalHeight int width MeasureSpec getSize widthMeasureSpec int height MeasureSpec getSize heightMeasureSpec if width 0 height int float width ratio setMeasuredDimension width height else super onMeasure widthMeasureSpec heightMeasureSpecpackage hudson model import hudson model Descriptor FormException import hudson slaves NodeProperty import javax annotation CheckForNull import javax annotation Nonnull import net sf json JSONObject import org kohsuke stapler StaplerRequest public interface ReconfigurableDescribable T extends ReconfigurableDescribable T extends Describable T CheckForNull T reconfigure Nonnull StaplerRequest req CheckForNull JSONObject form throws FormExceptionpackage hudson tasks import hudson Extension import hudson ExtensionPoint public abstract class Recorder extends Publisher implements ExtensionPoint SuppressWarnings deprecation super only Deprecated to discourage other subclasses protected Recorder public BuildStepDescriptor getDescriptor return BuildStepDescriptor super getDescriptorpackage com zxy recovery core import android app Activity import android app Application import android content Context import android os Build import com zxy recovery callback RecoveryActivityLifecycleCallback import com zxy recovery callback RecoveryCallback import com zxy recovery exception RecoveryException import com zxy recovery tools RecoveryLog import com zxy recovery tools RecoveryUtil public class Recovery private volatile static Recovery sInstance private static final Object LOCK new Object private Context mContext private boolean isDebug false private boolean isRecoverStack true private boolean isRecoverInBackground false private Class extends Activity mMainPageClass private RecoveryCallback mCallback private Recovery public static Recovery getInstance if sInstance null synchronized LOCK if sInstance null sInstance new Recovery return sInstance public void init Context context if context null throw new RecoveryException Context can not be null if context instanceof Application context context getApplicationContext mContext context registerRecoveryHandler registerRecoveryLifecycleCallback public Recovery debug boolean isDebug this isDebug isDebug return this public Recovery recoverStack boolean isRecoverStack this isRecoverStack isRecoverStack return this public Recovery recoverInBackground boolean isRecoverInBackground this isRecoverInBackground isRecoverInBackground return this public Recovery mainPage Class extends Activity clazz this mMainPageClass clazz return this public Recovery callback RecoveryCallback callback this mCallback callback return this private void registerRecoveryHandler RecoveryHandler newInstance Thread getDefaultUncaughtExceptionHandler setCallback mCallback register private void registerRecoveryLifecycleCallback Application mContext registerActivityLifecycleCallbacks new RecoveryActivityLifecycleCallback private void registerRecoveryProxy OS version in the 5 0 6 0 don t register agent if Build VERSION SDK INT Build VERSION CODES LOLLIPOP Build VERSION SDK INT Build VERSION CODES M return if mMainPageClass null return if RecoveryUtil isMainProcess RecoveryUtil checkNotNull mContext The context is not initialized return new Thread new Runnable Override public void run while true boolean isSuccess RecoveryComponentHook hookActivityManagerProxy RecoveryLog e hook is success isSuccess if isSuccess break start public Context getContext return RecoveryUtil checkNotNull mContext The context is not initialized public boolean isDebug return isDebug boolean isRecoverInBackground return isRecoverInBackground boolean isRecoverStack return isRecoverStack Class extends Activity getMainPageClass return mMainPageClasspackage com zxy recovery core import android content DialogInterface import android content Intent import android os Bundle import android support v7 app AlertDialog import android support v7 app AppCompatActivity import android support v7 widget Toolbar import android view KeyEvent import android view Menu import android view MenuItem import android view View import android widget Button import android widget ImageButton import android widget TextView import android widget Toast import com zxy recovery R import com zxy recovery tools RecoverySharedPrefsUtil import com zxy recovery tools RecoveryUtil import com zxy recovery tools Reflect import java io File import java io FileWriter import java io IOException import java text SimpleDateFormat import java util ArrayList import java util Date import java util Locale public final class RecoveryActivity extends AppCompatActivity public static final String RECOVERY MODE ACTIVE recovery mode active private static final String DEFAULT CRASH FILE DIR NAME recovery crash private boolean isDebugMode false private boolean isDebugModeActive false private RecoveryStore ExceptionData mExceptionData private Toolbar mToolbar private String mStackTrace private String mCause private Button mRecoverBtn private Button mRestartBtn private Button mRestartClearBtn private View mMainLayout private View mDebugLayout private TextView mExceptionTypeTv private TextView mClassNameTv private TextView mMethodNameTv private TextView mLineNumberTv private TextView mStackTraceTv private TextView mCauseTv private TextView mCrashTipsTv Override protected void onCreate Bundle savedInstanceState super onCreate savedInstanceState setContentView R layout activity recovery setupToolbar initView initData setupEvent private void setupToolbar mToolbar Toolbar findViewById R id toolbar setSupportActionBar mToolbar if getSupportActionBar null getSupportActionBar setDisplayShowTitleEnabled false mToolbar setTitle RecoveryUtil getAppName this mToolbar setNavigationOnClickListener new View OnClickListener Override public void onClick View v isDebugModeActive false showMainView setDisplayHomeAsUpEnabled false Override public boolean onCreateOptionsMenu Menu menu if isDebugMode return false if isDebugModeActive getMenuInflater inflate R menu menu recovery sub menu return true getMenuInflater inflate R menu menu recovery menu return true Override public boolean onOptionsItemSelected MenuItem item int id item getItemId if id R id action debug isDebugModeActive true showDebugView setDisplayHomeAsUpEnabled true else if id R id action save boolean isSuccess saveCrashData Toast makeText this isSuccess Save success Save failed Toast LENGTH SHORT show return super onOptionsItemSelected item private void initView mMainLayout findViewById R id recovery main layout mDebugLayout findViewById R id recovery debug layout mRecoverBtn Button findViewById R id btn recover mRestartBtn Button findViewById R id btn restart mRestartClearBtn Button findViewById R id btn restart clear mExceptionTypeTv TextView findViewById R id tv type mClassNameTv TextView findViewById R id tv class name mMethodNameTv TextView findViewById R id tv method name mLineNumberTv TextView findViewById R id tv line number mStackTraceTv TextView findViewById R id tv stack trace mCauseTv TextView findViewById R id tv cause mCrashTipsTv TextView findViewById R id tv crash tips private void initData isDebugMode isDebugMode if isDebugMode invalidateOptionsMenu mExceptionData getExceptionData mCause getCause mStackTrace getStackTrace private void setupEvent mRecoverBtn setOnClickListener new View OnClickListener Override public void onClick View v boolean restart RecoverySharedPrefsUtil shouldRestartApp if restart RecoverySharedPrefsUtil clear restart return if isRecoverStack recoverActivityStack else recoverTopActivity mRestartBtn setOnClickListener new View OnClickListener Override public void onClick View v boolean restart RecoverySharedPrefsUtil shouldRestartApp if restart RecoverySharedPrefsUtil clear restart mRestartClearBtn setOnClickListener new View OnClickListener Override public void onClick View v AlertDialog dialog new AlertDialog Builder RecoveryActivity this setTitle getResources getString R string recovery dialog tips setMessage getResources getString R string recovery dialog tips msg setPositiveButton getResources getString R string recovery dialog sure new DialogInterface OnClickListener Override public void onClick DialogInterface dialog int which if dialog null dialog dismiss RecoveryUtil clearApplicationData restart setNegativeButton getResources getString R string recovery dialog cancel new DialogInterface OnClickListener Override public void onClick DialogInterface dialog int which if dialog null dialog dismiss create dialog setCanceledOnTouchOutside false dialog show mCrashTipsTv setText String format getResources getString R string recovery crash tips msg RecoveryUtil getAppName this if mExceptionData null String type mExceptionData type null mExceptionData type String name mExceptionData className null mExceptionData className mExceptionTypeTv setText String format getResources getString R string recovery exception type type substring type lastIndexOf 1 mClassNameTv setText String format getResources getString R string recovery class name name substring name lastIndexOf 1 mMethodNameTv setText String format getResources getString R string recovery method name mExceptionData methodName mLineNumberTv setText String format getResources getString R string recovery line number mExceptionData lineNumber mCauseTv setText String valueOf mCause mStackTraceTv setText String valueOf mStackTrace private boolean isDebugMode return getIntent getBooleanExtra RecoveryStore IS DEBUG false private RecoveryStore ExceptionData getExceptionData return getIntent getParcelableExtra RecoveryStore EXCEPTION DATA private String getCause return getIntent getStringExtra RecoveryStore EXCEPTION CAUSE private String getStackTrace return getIntent getStringExtra RecoveryStore STACK TRACE private void restart Intent launchIntent getApplication getPackageManager getLaunchIntentForPackage this getPackageName if launchIntent null launchIntent addFlags Intent FLAG ACTIVITY NEW TASK Intent FLAG ACTIVITY CLEAR TASK startActivity launchIntent overridePendingTransition 0 0 finish private void recoverTopActivity Intent intent getRecoveryIntent if intent null RecoveryUtil isIntentAvailable this intent intent setExtrasClassLoader getClassLoader intent addFlags Intent FLAG ACTIVITY NEW TASK Intent FLAG ACTIVITY CLEAR TASK intent putExtra RECOVERY MODE ACTIVE true startActivity intent overridePendingTransition 0 0 finish return restart private boolean isRecoverStack boolean hasRecoverStack getIntent hasExtra RecoveryStore RECOVERY STACK return hasRecoverStack getIntent getBooleanExtra RecoveryStore RECOVERY STACK true private void recoverActivityStack ArrayList Intent intents getRecoveryIntents if intents null intents isEmpty ArrayList Intent availableIntents new ArrayList for Intent tmp intents if tmp null RecoveryUtil isIntentAvailable this tmp tmp setExtrasClassLoader getClassLoader availableIntents add tmp if availableIntents isEmpty availableIntents get availableIntents size 1 putExtra RECOVERY MODE ACTIVE true startActivities availableIntents toArray new Intent availableIntents size overridePendingTransition 0 0 finish return restart private Intent getRecoveryIntent boolean hasRecoverIntent getIntent hasExtra RecoveryStore RECOVERY INTENT if hasRecoverIntent return null return getIntent getParcelableExtra RecoveryStore RECOVERY INTENT private ArrayList Intent getRecoveryIntents boolean hasRecoveryIntents getIntent hasExtra RecoveryStore RECOVERY INTENTS if hasRecoveryIntents return null return getIntent getParcelableArrayListExtra RecoveryStore RECOVERY INTENTS private boolean saveCrashData SimpleDateFormat format new SimpleDateFormat yyyy MM dd HH mm ss Locale CHINA String date format format new Date System currentTimeMillis File dir new File getExternalFilesDir null File separator DEFAULT CRASH FILE DIR NAME if dir exists dir mkdirs File file new File dir String valueOf date txt FileWriter writer null try writer new FileWriter file writer write nException n mExceptionData null null mExceptionData toString n n writer write Cause n mCause n n writer write StackTrace n mStackTrace n n writer flush catch IOException e e printStackTrace return false finally if writer null try writer close catch IOException e e printStackTrace return true private void killProcess android os Process killProcess android os Process myPid System exit 10 private void setDisplayHomeAsUpEnabled boolean enabled if getSupportActionBar null getSupportActionBar setDisplayHomeAsUpEnabled enabled final ImageButton navButton ImageButton Reflect on Toolbar class field mNavButtonView get mToolbar if navButton null if enabled navButton setVisibility View VISIBLE else navButton setVisibility View GONE invalidateOptionsMenu private void showDebugView mMainLayout setVisibility View GONE mDebugLayout setVisibility View VISIBLE private void showMainView mMainLayout setVisibility View VISIBLE mDebugLayout setVisibility View GONE Override public boolean onKeyDown int keyCode KeyEvent event if event getKeyCode KeyEvent KEYCODE BACK isDebugModeActive isDebugModeActive false showMainView setDisplayHomeAsUpEnabled false return true return super onKeyDown keyCode event Override protected void onStop super onStop finish Override public void finish super finish killProcesspackage com zxy recovery callback import android app Activity import android app Application import android content Intent import android os Bundle import android view View import android view Window import com zxy recovery core Recovery import com zxy recovery core RecoveryActivity import com zxy recovery core RecoveryStore import com zxy recovery tools Reflect public class RecoveryActivityLifecycleCallback implements Application ActivityLifecycleCallbacks Override public void onActivityCreated final Activity activity Bundle savedInstanceState boolean isLegal RecoveryStore getInstance verifyActivity activity if isLegal return if activity getIntent getBooleanExtra RecoveryActivity RECOVERY MODE ACTIVE false Reflect on Recovery class method registerRecoveryProxy invoke Recovery getInstance Window window activity getWindow if window null View decorView window getDecorView if decorView null return decorView post new Runnable Override public void run RecoveryStore getInstance putActivity activity Object o activity getIntent clone RecoveryStore getInstance setIntent Intent o Override public void onActivityStarted Activity activity Override public void onActivityResumed Activity activity Override public void onActivityPaused Activity activity Override public void onActivityStopped Activity activity Override public void onActivitySaveInstanceState Activity activity Bundle outState Override public void onActivityDestroyed Activity activity RecoveryStore getInstance removeActivity activitypackage com zxy recovery callback public interface RecoveryCallback void stackTrace String stackTrace void cause String cause void exception String throwExceptionType String throwClassName String throwMethodName int throwLineNumberpackage com zxy recovery core import com zxy recovery tools RecoveryLog import com zxy recovery tools Reflect import java lang reflect Proxy final class RecoveryComponentHook static boolean hookActivityManagerProxy Singleton IActivityManager Object gDefault Reflect on android app ActivityManagerNative field gDefault get null if gDefault null return false Object currentActivityManagerProxy Reflect on android util Singleton field mInstance get gDefault if currentActivityManagerProxy null return false try ActivityManagerDelegate delegate new ActivityManagerDelegate currentActivityManagerProxy if currentActivityManagerProxy getClass isInstance delegate return true Class interfaces Class forName android app ActivityManagerNative getInterfaces Object proxy Proxy newProxyInstance Thread currentThread getContextClassLoader interfaces delegate Reflect on android util Singleton field mInstance set gDefault proxy catch ClassNotFoundException e e printStackTrace RecoveryLog e e toString return truepackage com zxy recovery exception public class RecoveryException extends RuntimeException public RecoveryException String message super message public RecoveryException String message Throwable cause super message causepackage com zxy recovery core import android content Intent import android text TextUtils import com zxy recovery callback RecoveryCallback import com zxy recovery tools DefaultHandlerUtil import com zxy recovery tools RecoverySharedPrefsUtil import com zxy recovery tools RecoveryUtil import java io PrintWriter import java io StringWriter final class RecoveryHandler implements Thread UncaughtExceptionHandler private Thread UncaughtExceptionHandler mDefaultUncaughtExceptionHandler private RecoveryCallback mCallback private RecoveryStore ExceptionData mExceptionData private String mStackTrace private String mCause private RecoveryHandler Thread UncaughtExceptionHandler defHandler mDefaultUncaughtExceptionHandler defHandler static RecoveryHandler newInstance Thread UncaughtExceptionHandler defHandler return new RecoveryHandler defHandler Override public synchronized void uncaughtException Thread t Throwable e RecoverySharedPrefsUtil recordCrashData StringWriter sw new StringWriter PrintWriter pw new PrintWriter sw e printStackTrace pw pw flush String stackTrace sw toString String cause e getMessage Throwable rootTr e while e getCause null e e getCause if e getStackTrace null e getStackTrace length 0 rootTr e String msg e getMessage if TextUtils isEmpty msg cause msg String exceptionType rootTr getClass getName String throwClassName String throwMethodName int throwLineNumber if rootTr getStackTrace length 0 StackTraceElement trace rootTr getStackTrace 0 throwClassName trace getClassName throwMethodName trace getMethodName throwLineNumber trace getLineNumber else throwClassName unknown throwMethodName unknown throwLineNumber 0 mExceptionData RecoveryStore ExceptionData newInstance type exceptionType className throwClassName methodName throwMethodName lineNumber throwLineNumber mStackTrace stackTrace mCause cause if mCallback null mCallback stackTrace stackTrace mCallback cause cause mCallback exception exceptionType throwClassName throwMethodName throwLineNumber if DefaultHandlerUtil isSystemDefaultUncaughtExceptionHandler mDefaultUncaughtExceptionHandler if mDefaultUncaughtExceptionHandler null startRecoverActivity mDefaultUncaughtExceptionHandler uncaughtException t e else startRecoverActivity RecoveryHandler setCallback RecoveryCallback callback mCallback callback return this private void startRecoverActivity if RecoveryUtil isAppInBackground Recovery getInstance getContext Recovery getInstance isRecoverInBackground killProcess return Intent intent new Intent intent setClass Recovery getInstance getContext RecoveryActivity class intent addFlags Intent FLAG ACTIVITY NEW TASK Intent FLAG ACTIVITY CLEAR TASK Intent FLAG ACTIVITY EXCLUDE FROM RECENTS if RecoveryStore getInstance getIntent null intent putExtra RecoveryStore RECOVERY INTENT RecoveryStore getInstance getIntent if RecoveryStore getInstance getIntents isEmpty intent putParcelableArrayListExtra RecoveryStore RECOVERY INTENTS RecoveryStore getInstance getIntents intent putExtra RecoveryStore RECOVERY STACK Recovery getInstance isRecoverStack intent putExtra RecoveryStore IS DEBUG Recovery getInstance isDebug if mExceptionData null intent putExtra RecoveryStore EXCEPTION DATA mExceptionData if mStackTrace null intent putExtra RecoveryStore STACK TRACE mStackTrace if mCause null intent putExtra RecoveryStore EXCEPTION CAUSE mCause Recovery getInstance getContext startActivity intent killProcess void register Thread setDefaultUncaughtExceptionHandler this private void killProcess android os Process killProcess android os Process myPid System exit 10package com zxy recovery tools import android util Log import com zxy recovery core Recovery public class RecoveryLog private static final String TAG Recovery public static void e String message if Recovery getInstance isDebug Log e TAG messagepackage com zxy recovery tools import com zxy recovery core CrashData import com zxy recovery core Recovery import com zxy recovery exception RecoveryException public class RecoverySharedPrefsUtil private static final long DEFAULT TIME INTERVAL 60 1000 private static final int DEFAULT MAX COUNT 3 private static final String SHARED PREFS NAME recovery info private static final String CRASH COUNT crash count private static final String CRASH TIME crash time private static final String SHOULD RESTART APP should restart app private RecoverySharedPrefsUtil throw new RecoveryException Stub public static void recordCrashData int count 0 long time 0L boolean shouldRestart false try count Integer parseInt get CRASH COUNT String valueOf 0 time Long parseLong get CRASH TIME String valueOf 0L catch Exception e count 0 time 0L RecoveryLog e e getMessage count Math max count 0 time Math max time 0L count 1 time time 0L System currentTimeMillis time long interval System currentTimeMillis time if count DEFAULT MAX COUNT interval DEFAULT TIME INTERVAL shouldRestart true count 0 time 0L else if count DEFAULT MAX COUNT interval DEFAULT TIME INTERVAL count 1 time System currentTimeMillis CrashData data CrashData newInstance count count time time restart shouldRestart RecoveryLog e data toString saveCrashData data private static void saveCrashData CrashData data if data null return SharedPreferencesCompat newBuilder Recovery getInstance getContext SHARED PREFS NAME put CRASH COUNT String valueOf data crashCount put CRASH TIME String valueOf data crashTime put SHOULD RESTART APP String valueOf data shouldRestart apply public static boolean shouldRestartApp return Boolean parseBoolean get SHOULD RESTART APP String valueOf false public static void clear SharedPreferencesCompat clear Recovery getInstance getContext SHARED PREFS NAME private static void put String key String value SharedPreferencesCompat put Recovery getInstance getContext SHARED PREFS NAME key value private static String get String key String defValue return SharedPreferencesCompat get Recovery getInstance getContext SHARED PREFS NAME key defValuepackage com zxy recovery core import android app Activity import android content ComponentName import android content Intent import android os Parcel import android os Parcelable import java lang ref WeakReference import java util ArrayList import java util List import java util concurrent CopyOnWriteArrayList import java util concurrent atomic AtomicInteger public final class RecoveryStore static final String RECOVERY INTENT recovery intent static final String RECOVERY INTENTS recovery intents static final String RECOVERY STACK recovery stack static final String IS DEBUG recovery is debug static final String STACK TRACE recovery stack trace static final String EXCEPTION DATA recovery exception data static final String EXCEPTION CAUSE recovery exception cause private volatile static RecoveryStore sInstance private static final Object LOCK new Object private List WeakReference Activity mRunningActivities private Intent mIntent private RecoveryStore mRunningActivities new CopyOnWriteArrayList public static RecoveryStore getInstance if sInstance null synchronized LOCK if sInstance null sInstance new RecoveryStore return sInstance public Intent getIntent return mIntent public synchronized void setIntent Intent intent mIntent intent public boolean verifyActivity Activity activity return activity null RecoveryActivity class isInstance activity public List WeakReference Activity getRunningActivities return mRunningActivities public void putActivity Activity activity WeakReference Activity weakReference new WeakReference activity mRunningActivities add weakReference public void removeActivity Activity activity for WeakReference Activity activityWeakReference mRunningActivities if activityWeakReference null continue Activity tmpActivity activityWeakReference get if tmpActivity null continue if tmpActivity activity mRunningActivities remove activityWeakReference break int getRunningActivityCount AtomicInteger count new AtomicInteger 0 for WeakReference Activity activityWeakReference mRunningActivities if activityWeakReference null continue Activity activity activityWeakReference get if activity null continue count set count incrementAndGet return count get ComponentName getBaseActivity for WeakReference Activity activityWeakReference mRunningActivities if activityWeakReference null continue Activity tmpActivity activityWeakReference get if tmpActivity null continue return tmpActivity getComponentName return null ArrayList Intent getIntents ArrayList Intent intentList new ArrayList for WeakReference Activity activityWeakReference mRunningActivities if activityWeakReference null continue Activity tmpActivity activityWeakReference get if tmpActivity null continue intentList add Intent tmpActivity getIntent clone return intentList static final class ExceptionData implements Parcelable String type String className String methodName int lineNumber Override public int describeContents return 0 Override public void writeToParcel Parcel dest int flags dest writeString this type dest writeString this className dest writeString this methodName dest writeInt this lineNumber ExceptionData public static ExceptionData newInstance return new ExceptionData public ExceptionData type String type this type type return this public ExceptionData className String className this className className return this public ExceptionData methodName String methodName this methodName methodName return this public ExceptionData lineNumber int lineNumber this lineNumber lineNumber return this protected ExceptionData Parcel in this type in readString this className in readString this methodName in readString this lineNumber in readInt public static final Creator ExceptionData CREATOR new Creator ExceptionData Override public ExceptionData createFromParcel Parcel source return new ExceptionData source Override public ExceptionData newArray int size return new ExceptionData size Override public String toString return ExceptionData className className type type methodName methodName lineNumber lineNumberpackage com zxy recovery tools import android app ActivityManager import android app Application import android content Context import android content Intent import android content pm ApplicationInfo import android content pm PackageManager import android content pm ResolveInfo import android os Environment import com zxy recovery core Recovery import com zxy recovery exception RecoveryException import com zxy recovery exception ReflectException import java io File import java util List public class RecoveryUtil private RecoveryUtil throw new RecoveryException Stub public static T T checkNotNull T t String message if t null throw new ReflectException String valueOf message return t public static boolean isIntentAvailable Context context Intent intent if context null intent null return false PackageManager packageManager context getApplicationContext getPackageManager List ResolveInfo list packageManager queryIntentActivities intent PackageManager MATCH DEFAULT ONLY return list size 0 public static boolean isAppInBackground Context context ActivityManager activityManager ActivityManager context getSystemService Context ACTIVITY SERVICE List ActivityManager RunningAppProcessInfo appProcesses activityManager getRunningAppProcesses if appProcesses null return true for ActivityManager RunningAppProcessInfo appProcess appProcesses if appProcess processName equals context getPackageName return appProcess importance ActivityManager RunningAppProcessInfo IMPORTANCE BACKGROUND return false public static String getAppName Context context PackageManager packageManager null ApplicationInfo applicationInfo null if context instanceof Application context context getApplicationContext try packageManager context getPackageManager applicationInfo packageManager getApplicationInfo context getPackageName 0 catch PackageManager NameNotFoundException e applicationInfo null CharSequence charSequence packageManager getApplicationLabel applicationInfo return charSequence null String charSequence public static boolean isMainProcess Context context try ActivityManager am ActivityManager context getSystemService Context ACTIVITY SERVICE List ActivityManager RunningAppProcessInfo processInfo am getRunningAppProcesses String mainProcessName context getPackageName int myPid android os Process myPid for ActivityManager RunningAppProcessInfo info processInfo if info pid myPid mainProcessName equals info processName return true catch Exception e e printStackTrace return false private static File getDataDir return new File File separator data File separator data File separator Recovery getInstance getContext getPackageName private static File getExternalDataDir File file null if Environment MEDIA MOUNTED equals Environment getExternalStorageState file Recovery getInstance getContext getExternalCacheDir return file null null file getParentFile private static boolean clearAppData File dir if dir null dir isDirectory dir exists return false File files dir listFiles int length files length for int i 0 i length i File file files i if file null continue if file isFile file exists boolean result file delete RecoveryLog e file getName result delete success delete failed continue if file isDirectory file exists clearAppData file return true public static void clearApplicationData clearAppData getDataDir clearAppData getExternalDataDirimport java util Date import org apache axis client Call import org apache axis client Stub import com adyen services common Amount import com adyen services payment PaymentLocator import com adyen services payment PaymentPortType import com adyen services payment PaymentRequest import com adyen services payment PaymentResult import com adyen services payment Recurring public class RecurringPayment public static void main String args try PaymentPortType ws new PaymentLocator getPaymentHttpPort new java net URL Credentials test address Basic HTTP Authentication Stub ws setProperty Call USERNAME PROPERTY Credentials ws user Stub ws setProperty Call PASSWORD PROPERTY Credentials pwd user PaymentRequest request new PaymentRequest request setMerchantAccount Credentials merchant account request setSelectedRecurringDetailReference recurring detail reference request setRecurring new Recurring RECURRING null request setAmount new Amount GBP 2500 request setReference Recurring Test 1 request setShopperEmail shoppedemail server com request setShopperReference shopperreference request setShopperInteraction ContAuth PaymentResult result ws authorise request System out println new Date System out println result getPspReference System out println result getResultCode System out println result getAuthCode System out println result getRefusalReason catch Exception ex ex printStackTracepackage com zxy recovery tools import android text TextUtils import com zxy recovery exception ReflectException import java lang reflect Constructor import java lang reflect Field import java lang reflect InvocationTargetException import java lang reflect Method import java lang reflect Modifier public class Reflect private Class mReflectObjectClazz private Reflect String className checkNotEmpty className ClassName can not be empty try this mReflectObjectClazz Class forName className catch ClassNotFoundException e throw new ReflectException Class className can not be found e getCause private Reflect Class clazz checkNotNull clazz Reflect class can not be null this mReflectObjectClazz clazz public static Reflect on String className return new Reflect className public static Reflect on Class clazz return new Reflect clazz public final ReflectMethod method String methodName Class types checkNotEmpty methodName MethodName can not be empty Method method try if types null types length 0 method mReflectObjectClazz getDeclaredMethod methodName else method mReflectObjectClazz getDeclaredMethod methodName types method setAccessible true return ReflectMethod create method catch NoSuchMethodException e e printStackTrace return ReflectMethod create null public static final class ReflectMethod private Method method private ReflectMethod Method method this method method static ReflectMethod create Method method return new ReflectMethod method public Method obtain return method public Object invoke Object invoker Object params if method null return null if invoker null if method getModifiers Modifier STATIC 0 throw new ReflectException Invoker can not be null try if params null params length 0 return method invoke invoker return method invoke invoker params catch IllegalAccessException e e printStackTrace catch InvocationTargetException e e printStackTrace return null public final ReflectField field String fieldName checkNotEmpty fieldName FieldName can not be empty try Field field mReflectObjectClazz getDeclaredField fieldName field setAccessible true return ReflectField create field catch NoSuchFieldException e e printStackTrace return ReflectField create null public static final class ReflectField private Field field private ReflectField Field field this field field static ReflectField create Field field return new ReflectField field public Field obtain return field public void set Object target Object value if field null return if target null if field getModifiers Modifier STATIC 0 throw new ReflectException Target object can not be null try field set target value catch IllegalAccessException e e printStackTrace public Object get Object target if field null return null if target null if field getModifiers Modifier STATIC 0 throw new ReflectException Target object can not be null try return field get target catch IllegalAccessException e e printStackTrace return null public final ReflectConstructor constructor Class types Constructor constructor try if types null types length 0 constructor mReflectObjectClazz getDeclaredConstructor else constructor mReflectObjectClazz getDeclaredConstructor types constructor setAccessible true return ReflectConstructor create constructor catch NoSuchMethodException e e printStackTrace return ReflectConstructor create null public static final class ReflectConstructor private Constructor constructor private ReflectConstructor Constructor constructor this constructor constructor static ReflectConstructor create Constructor constructor return new ReflectConstructor constructor public Constructor obtain return constructor public Object newInstance Object params if constructor null return null try if params null params length 0 return constructor newInstance return constructor newInstance params catch InstantiationException e e printStackTrace catch IllegalAccessException e e printStackTrace catch InvocationTargetException e e printStackTrace return null public Object newInstance if mReflectObjectClazz null return null try return mReflectObjectClazz newInstance catch InstantiationException e e printStackTrace catch IllegalAccessException e e printStackTrace return null private static T void checkNotNull T t String message if t null throw new ReflectException String valueOf message private static void checkNotEmpty String t String message if TextUtils isEmpty t throw new ReflectException String valueOf messagepackage com zxy recovery exception public class ReflectException extends RuntimeException public ReflectException super public ReflectException String detailMessage super detailMessage public ReflectException String detailMessage Throwable throwable super detailMessage throwable public ReflectException Throwable throwable super throwablepackage hudson util import org apache commons beanutils PropertyUtils import org kohsuke stapler ClassDescriptor import java beans PropertyDescriptor import java lang annotation Annotation import java lang reflect AnnotatedElement import java lang reflect Field import java lang reflect InvocationTargetException import java lang reflect Method import java lang reflect Type import java util AbstractList import java util HashMap import java util List import java util Map public class ReflectionUtils extends org springframework util ReflectionUtils public static Method getPublicMethodNamed Class c String methodName for Method m c getMethods if m getName equals methodName return m return null public static List Parameter getParameters Method m return new MethodInfo m public static Object getPublicProperty Object o String p throws InvocationTargetException NoSuchMethodException IllegalAccessException PropertyDescriptor pd PropertyUtils getPropertyDescriptor o p if pd null field try Field f o getClass getField p return f get o catch NoSuchFieldException e throw new IllegalArgumentException No such property p on o getClass else return PropertyUtils getProperty o p private static final class MethodInfo extends AbstractList Parameter private final Method method private final Class types private Type genericTypes private Annotation annotations private String names private MethodInfo Method method this method method types method getParameterTypes Override public Parameter get int index return new Parameter this index Override public int size return types length public Type genericTypes if genericTypes null genericTypes method getGenericParameterTypes return genericTypes public Annotation annotations if annotations null annotations method getParameterAnnotations return annotations public String names if names null names ClassDescriptor loadParameterNames method return names public static final class Parameter implements AnnotatedElement private final MethodInfo parent private final int index public Parameter MethodInfo parent int index this parent parent this index index public int index return index public Class type return parent types index public Type genericType return parent genericTypes index public Annotation annotations return parent annotations index public A extends Annotation A annotation Class A type for Annotation a annotations if a annotationType type return type cast a return null public String name String names parent names if index names length return names index return null Override public boolean isAnnotationPresent Class extends Annotation type return annotation type null Override public T extends Annotation T getAnnotation Class T type return annotation type Override public Annotation getAnnotations return annotations Override public Annotation getDeclaredAnnotations return annotations public static Object getVmDefaultValueForPrimitiveType Class type return defaultPrimitiveValue get type private static final Map Class Object defaultPrimitiveValue new HashMap Class Object static defaultPrimitiveValue put boolean class false defaultPrimitiveValue put int class 0 defaultPrimitiveValue put long class 0Lpackage jenkins import java io File public abstract class ReflectiveFilePathFilter extends FilePathFilter protected abstract boolean op String name File path throws SecurityException Override public boolean read File f throws SecurityException return op read f Override public boolean write File f throws SecurityException return op write f Override public boolean symlink File f throws SecurityException return op symlink f Override public boolean mkdirs File f throws SecurityException return op mkdirs f Override public boolean create File f throws SecurityException return op create f Override public boolean delete File f throws SecurityException return op delete f Override public boolean stat File f throws SecurityException return op stat fpackage hudson util jna import com sun jna ptr IntByReference import java io UnsupportedEncodingException import java util Collection import java util TreeMap import java util TreeSet public class RegistryKey private int handle private final RegistryKey root private final String path private RegistryKey int handle this handle handle root this path private RegistryKey RegistryKey ancestor String path int handle this handle handle this root ancestor root this path combine ancestor path path private static String combine String a String b if a length 0 return b if b length 0 return a return a b private static String convertBufferToString byte buf try return new String buf 0 buf length 2 UTF 16LE catch UnsupportedEncodingException e throw new AssertionError e impossible private static int convertBufferToInt byte buf return int buf 0 0xff int buf 1 0xff 8 int buf 2 0xff 16 int buf 3 0xff 24 public String getStringValue String valueName return convertBufferToString getValue valueName public int getIntValue String valueName return convertBufferToInt getValue valueName private byte getValue String valueName IntByReference pType lpcbData byte lpData new byte 1 pType new IntByReference lpcbData new IntByReference OUTER while true int r Advapi32 INSTANCE RegQueryValueEx handle valueName null pType lpData lpcbData switch r case WINERROR ERROR MORE DATA lpData new byte lpcbData getValue continue OUTER case WINERROR ERROR SUCCESS return lpData throw new JnaException r public void deleteValue String valueName check Advapi32 INSTANCE RegDeleteValue handle valueName private void check int r if r WINERROR ERROR SUCCESS throw new JnaException r public void setValue String name String value try byte bytes value getBytes UTF 16LE int newLength bytes length 2 for 0 padding byte with0 new byte newLength System arraycopy bytes 0 with0 0 newLength check Advapi32 INSTANCE RegSetValueEx handle name 0 WINNT REG SZ with0 with0 length catch UnsupportedEncodingException e throw new AssertionError e public void setValue String name int value byte data new byte 4 data 0 byte value 0xff data 1 byte value 8 0xff data 2 byte value 16 0xff data 3 byte value 24 0xff check Advapi32 INSTANCE RegSetValueEx handle name 0 WINNT REG DWORD data data length public boolean valueExists String name IntByReference pType lpcbData byte lpData new byte 1 pType new IntByReference lpcbData new IntByReference OUTER while true int r Advapi32 INSTANCE RegQueryValueEx handle name null pType lpData lpcbData switch r case WINERROR ERROR MORE DATA lpData new byte lpcbData getValue continue OUTER case WINERROR ERROR FILE NOT FOUND return false case WINERROR ERROR SUCCESS return true default throw new JnaException r public void delete check Advapi32 INSTANCE RegDeleteKey handle path dispose public Collection String getSubKeys WINBASE FILETIME lpftLastWriteTime TreeSet String subKeys new TreeSet String char lpName new char 256 IntByReference lpcName new IntByReference 256 lpftLastWriteTime new WINBASE FILETIME int dwIndex 0 while Advapi32 INSTANCE RegEnumKeyEx handle dwIndex lpName lpcName null null null lpftLastWriteTime WINERROR ERROR SUCCESS subKeys add new String lpName 0 lpcName getValue lpcName setValue 256 dwIndex return subKeys public RegistryKey open String subKeyName return open subKeyName 0xF003F public RegistryKey openReadonly String subKeyName return open subKeyName 0x20019 public RegistryKey open String subKeyName int access IntByReference pHandle new IntByReference check Advapi32 INSTANCE RegOpenKeyEx handle subKeyName 0 access pHandle return new RegistryKey this subKeyName pHandle getValue public TreeMap String Object getValues int dwIndex result char lpValueName byte lpData IntByReference lpcchValueName lpType lpcbData String name TreeMap String Object values new TreeMap String Object String CASE INSENSITIVE ORDER lpValueName new char 16384 lpcchValueName new IntByReference 16384 lpType new IntByReference lpData new byte 1 lpcbData new IntByReference lpcbData setValue 0 dwIndex 0 OUTER while true result Advapi32 INSTANCE RegEnumValue handle dwIndex lpValueName lpcchValueName null lpType lpData lpcbData switch result case WINERROR ERROR NO MORE ITEMS return values case WINERROR ERROR MORE DATA lpData new byte lpcbData getValue lpcchValueName new IntByReference 16384 continue OUTER case WINERROR ERROR SUCCESS name new String lpValueName 0 lpcchValueName getValue switch lpType getValue case WINNT REG SZ values put name convertBufferToString lpData break case WINNT REG DWORD values put name convertBufferToInt lpData break default break not supported yet break default check result dwIndex lpcbData setValue 0 Override protected void finalize throws Throwable super finalize dispose public void dispose if handle 0 Advapi32 INSTANCE RegCloseKey handle handle 0 Root keys public static final RegistryKey CLASSES ROOT new RegistryKey 0x80000000 public static final RegistryKey CURRENT USER new RegistryKey 0x80000001 public static final RegistryKey LOCAL MACHINE new RegistryKey 0x80000002 public static final RegistryKey USERS new RegistryKey 0x80000003package jenkins security s2m import hudson PluginWrapper import jenkins model Jenkins import javax annotation CheckForNull public class RejectedCallable public final Class clazz RejectedCallable Class clazz this clazz clazz public CheckForNull PluginWrapper getPlugin return Jenkins getInstance pluginManager whichPlugin clazzpackage jenkins security import hudson Extension import hudson init InitMilestone import hudson init Initializer import hudson model TaskListener import hudson util HttpResponses import hudson util SecretRewriter import hudson util VersionNumber import jenkins management AsynchronousAdministrativeMonitor import jenkins model Jenkins import jenkins util io FileBoolean import org jenkinsci Symbol import org kohsuke stapler HttpResponse import org kohsuke stapler StaplerProxy import org kohsuke stapler StaplerRequest import org kohsuke stapler interceptor RequirePOST import java io File import java io IOException import java io PrintStream import java security GeneralSecurityException import java util Date import java util logging Level import java util logging Logger Extension Symbol rekeySecret public class RekeySecretAdminMonitor extends AsynchronousAdministrativeMonitor implements StaplerProxy private final FileBoolean needed state needed private final FileBoolean done state done private final FileBoolean scanOnBoot state scanOnBoot public RekeySecretAdminMonitor throws IOException if JENKINS HOME existed 1 497 we need to offer rewrite this computation needs to be done and the value be captured since JENKINS HOME config xml can be saved later before the user has actually rewritten XML files Jenkins j Jenkins getInstance if j isUpgradedFromBefore new VersionNumber 1 496 new FileBoolean new File j getRootDir secret key not so secret isOff needed on public Object getTarget Jenkins getInstance checkPermission Jenkins ADMINISTER return this Override public boolean isActivated return needed isOn public boolean isDone return done isOn public void setNeeded needed on public boolean isScanOnBoot return scanOnBoot isOn RequirePOST public HttpResponse doScan StaplerRequest req throws IOException GeneralSecurityException if req hasParameter background start false else if req hasParameter schedule scanOnBoot on else if req hasParameter dismiss disable true else throw HttpResponses error 400 Invalid request submission req getParameterMap return HttpResponses redirectViaContextPath manage private FileBoolean state String name return new FileBoolean new File getBaseDir name Initializer fatal false after InitMilestone PLUGINS STARTED before InitMilestone EXTENSIONS AUGMENTED as early as possible but this needs to be late enough that the ConfidentialStore is available public void scanOnReboot throws InterruptedException IOException GeneralSecurityException FileBoolean flag scanOnBoot if flag isOn flag off start false join block the boot until the rewrite process is complete don t let the failure in RekeyThread block Jenkins boot Override public String getDisplayName return Messages RekeySecretAdminMonitor DisplayName Override protected File getLogFile return new File getBaseDir rekey log Override protected void fix TaskListener listener throws Exception LOGGER info Initiating a re keying of secrets See getLogFile SecretRewriter rewriter new SecretRewriter new File getBaseDir backups try PrintStream log listener getLogger log println Started re keying new Date int count rewriter rewriteRecursive Jenkins getInstance getRootDir listener log printf Completed re keying d files on s n count new Date new RekeySecretAdminMonitor done on LOGGER info Secret re keying completed catch Exception e LOGGER log Level SEVERE Fatal failure in re keying secrets e e printStackTrace listener error Fatal failure in rewriting secrets private static final Logger LOGGER Logger getLogger RekeySecretAdminMonitor class getNamepackage hudson import org kohsuke stapler QueryParameter import java lang annotation Documented import java lang annotation Retention import java lang annotation Target import static java lang annotation ElementType import static java lang annotation RetentionPolicy Documented Target PARAMETER Retention RUNTIME public interface RelativePath String valuepackage hudson cli import hudson Extension import jenkins model Jenkins Extension public class ReloadConfigurationCommand extends CLICommand Override public String getShortDescription return Messages ReloadConfigurationCommand ShortDescription Override protected int run throws Exception Jenkins getActiveInstance doReload return 0package hudson cli import hudson AbortException import hudson Extension import hudson model AbstractItem import hudson model AbstractProject import hudson model Item import jenkins model Jenkins import org kohsuke args4j Argument import java util HashSet import java util List import java util logging Level import java util logging Logger Extension public class ReloadJobCommand extends CLICommand Argument usage Name of the job s to reload required true multiValued true private List String jobs private static final Logger LOGGER Logger getLogger ReloadJobCommand class getName Override public String getShortDescription return Messages ReloadJobCommand ShortDescription Override protected int run throws Exception boolean errorOccurred false final Jenkins jenkins Jenkins getActiveInstance final HashSet String hs new HashSet String hs addAll jobs for String job s hs AbstractItem job null try TODO JENKINS 30786 Item item jenkins getItemByFullName job s if item instanceof AbstractItem job AbstractItem item else if item null LOGGER log Level WARNING Unsupported item type 0 item getClass getName if job null TODO JENKINS 30785 AbstractProject project AbstractProject findNearest job s throw new IllegalArgumentException project null No such job u2018 job s u2019 exists String format No such job u2018 s u2019 exists Perhaps you meant u2018 s u2019 job s project getFullName job checkPermission AbstractItem CONFIGURE job doReload catch Exception e if hs size 1 throw e final String errorMsg String format job s e getMessage stderr println errorMsg errorOccurred true continue if errorOccurred throw new AbortException CLI LISTPARAM SUMMARY ERROR TEXT return 0package jenkins management import hudson Extension import hudson model ManagementLink import org jenkinsci Symbol Extension ordinal Integer MAX VALUE 300 Symbol reload public class ReloadLink extends ManagementLink Override public String getIconFileName return refresh png public String getDisplayName return Messages ReloadLink DisplayName Override public String getDescription return Messages ReloadLink Description Override public String getUrlName return reload Override public boolean getRequiresConfirmation return truepackage hudson security import jenkins model Jenkins import jenkins security ConfidentialStore import org acegisecurity ui rememberme RememberMeServices import org acegisecurity Authentication import javax servlet http HttpServletRequest import javax servlet http HttpServletResponse public class RememberMeServicesProxy implements RememberMeServices private volatile RememberMeServices delegate public Authentication autoLogin HttpServletRequest request HttpServletResponse response RememberMeServices d delegate if d null return d autoLogin request response return null public void loginFail HttpServletRequest request HttpServletResponse response RememberMeServices d delegate if d null d loginFail request response public void loginSuccess HttpServletRequest request HttpServletResponse response Authentication successfulAuthentication RememberMeServices d delegate if d null d loginSuccess request response successfulAuthentication public void setDelegate RememberMeServices delegate this delegate delegatepackage hudson util import groovy lang Binding import groovy lang GroovyShell import hudson FilePath import hudson Functions import jenkins model Jenkins import hudson remoting AsyncFutureImpl import hudson remoting DelegatingCallable import hudson remoting Future import hudson remoting VirtualChannel import hudson security AccessControlled import jenkins security MasterToSlaveCallable import org codehaus groovy control CompilerConfiguration import org codehaus groovy control customizers ImportCustomizer import org kohsuke stapler StaplerRequest import org kohsuke stapler StaplerResponse import org kohsuke stapler WebMethod import javax annotation Nonnull import javax management JMException import javax management MBeanServer import javax management ObjectName import java io File import java io IOException import java io PrintWriter import java io StringWriter import java lang management ManagementFactory import java lang management ThreadInfo import java util Collections import java util LinkedHashMap import java util Map import java util TreeMap public final class RemotingDiagnostics public static Map Object Object getSystemProperties VirtualChannel channel throws IOException InterruptedException if channel null return Collections Object Object singletonMap N A N A return channel call new GetSystemProperties private static final class GetSystemProperties extends MasterToSlaveCallable Map Object Object RuntimeException public Map Object Object call return new TreeMap Object Object System getProperties private static final long serialVersionUID 1L public static Map String String getThreadDump VirtualChannel channel throws IOException InterruptedException if channel null return Collections singletonMap N A N A return channel call new GetThreadDump public static Future Map String String getThreadDumpAsync VirtualChannel channel throws IOException InterruptedException if channel null return new AsyncFutureImpl Map String String Collections singletonMap N A offline return channel callAsync new GetThreadDump private static final class GetThreadDump extends MasterToSlaveCallable Map String String RuntimeException public Map String String call Map String String r new LinkedHashMap String String ThreadInfo data Functions getThreadInfos Functions ThreadGroupMap map Functions sortThreadsAndGetGroupMap data for ThreadInfo ti data r put ti getThreadName Functions dumpThreadInfo ti map return r private static final long serialVersionUID 1L public static String executeGroovy String script Nonnull VirtualChannel channel throws IOException InterruptedException return channel call new Script script private static final class Script extends MasterToSlaveCallable String RuntimeException implements DelegatingCallable String RuntimeException private final String script private transient ClassLoader cl private Script String script this script script cl getClassLoader public ClassLoader getClassLoader return Jenkins getInstance getPluginManager uberClassLoader public String call throws RuntimeException if we run locally cl null Otherwise the delegating classloader will be available as context classloader if cl null cl Thread currentThread getContextClassLoader CompilerConfiguration cc new CompilerConfiguration cc addCompilationCustomizers new ImportCustomizer addStarImports jenkins jenkins model hudson hudson model GroovyShell shell new GroovyShell cl new Binding cc StringWriter out new StringWriter PrintWriter pw new PrintWriter out shell setVariable out pw try Object output shell evaluate script if output null pw println Result output catch Throwable t t printStackTrace pw return out toString public static FilePath getHeapDump VirtualChannel channel throws IOException InterruptedException return channel call new MasterToSlaveCallable FilePath IOException public FilePath call throws IOException final File hprof File createTempFile hudson heapdump hprof hprof delete try MBeanServer server ManagementFactory getPlatformMBeanServer server invoke new ObjectName com sun management type HotSpotDiagnostic dumpHeap new Object hprof getAbsolutePath true new String String class getName boolean class getName return new FilePath hprof catch JMException e throw new IOException e private static final long serialVersionUID 1L public static class HeapDump private final AccessControlled owner private final VirtualChannel channel public HeapDump AccessControlled owner VirtualChannel channel this owner owner this channel channel public void doIndex StaplerResponse rsp throws IOException rsp sendRedirect heapdump hprof WebMethod name heapdump hprof public void doHeapDump StaplerRequest req StaplerResponse rsp throws IOException InterruptedException owner checkPermission Jenkins RUN SCRIPTS rsp setContentType application octet stream FilePath dump obtain try dump copyTo rsp getCompressedOutputStream req finally dump delete public FilePath obtain throws IOException InterruptedException return RemotingDiagnostics getHeapDump channelpackage hudson cli import java util List import hudson Extension import hudson model TopLevelItem import hudson model DirectlyModifiableView import hudson model View import org kohsuke args4j Argument import org kohsuke args4j CmdLineException Extension public class RemoveJobFromViewCommand extends CLICommand Argument usage Name of the view required true index 0 private View view Argument usage Job names required true index 1 private List TopLevelItem jobs Override public String getShortDescription return Messages RemoveJobFromViewCommand ShortDescription Override protected int run throws Exception view checkPermission View CONFIGURE if view instanceof DirectlyModifiableView throw new IllegalStateException view getDisplayName view can not be modified directly for TopLevelItem job jobs DirectlyModifiableView view remove job return 0package hudson widgets import hudson Util import hudson model Descriptor import hudson util PackedMap import org apache commons jelly JellyContext import org apache commons jelly JellyTagException import org apache commons jelly Script import org kohsuke stapler HttpResponse import org kohsuke stapler StaplerRequest import org kohsuke stapler StaplerResponse import org kohsuke stapler bind JavaScriptMethod import org kohsuke stapler framework adjunct AdjunctsInPage import org kohsuke stapler jelly DefaultScriptInvoker import org xml sax SAXException import javax servlet ServletException import java io IOException import java util ArrayList import java util HashMap import java util List import java util Map import java util Set import java util logging Level import java util logging Logger public class RenderOnDemandClosure private final Script bodyStack private final Map String Object variables private final String currentDescriptorByNameUrl private final String adjuncts public RenderOnDemandClosure JellyContext context String attributesToCapture List Script bodyStack new ArrayList Script for JellyContext c context c null c c getParent Script script Script c getVariables get org apache commons jelly body if script null bodyStack add script this bodyStack bodyStack toArray new Script bodyStack size assert bodyStack isEmpty there must be at least one which is the direct child of l renderOnDemand Map String Object variables new HashMap String Object for String v Util fixNull attributesToCapture split variables put v intern context getVariable v capture the current base of context for descriptors currentDescriptorByNameUrl Descriptor getCurrentDescriptorByNameUrl this variables PackedMap of variables Set String adjuncts AdjunctsInPage get getIncluded this adjuncts new String adjuncts size int i 0 for String adjunct adjuncts this adjuncts i adjunct intern JavaScriptMethod public HttpResponse render return new HttpResponse public void generateResponse StaplerRequest req StaplerResponse rsp Object node throws IOException ServletException try new DefaultScriptInvoker Override protected JellyContext createContext StaplerRequest req StaplerResponse rsp Script script Object it JellyContext context super createContext req rsp script it for int i bodyStack length 1 i 0 i exclude bodyStack 0 context new JellyContext context context setVariable org apache commons jelly body bodyStack i try AdjunctsInPage get assumeIncluded adjuncts catch IOException e LOGGER log Level WARNING Failed to resurrect adjunct context e catch SAXException e LOGGER log Level WARNING Failed to resurrect adjunct context e return context Override protected void exportVariables StaplerRequest req StaplerResponse rsp Script script Object it JellyContext context super exportVariables req rsp script it context context setVariables variables req setAttribute currentDescriptorByNameUrl currentDescriptorByNameUrl invokeScript req rsp bodyStack 0 null catch JellyTagException e LOGGER log Level WARNING Failed to evaluate the template closure e throw new IOException Failed to evaluate the template closure e private static final Logger LOGGER Logger getLogger RenderOnDemandClosure class getNamepackage hudson util io import java io File import java io FileNotFoundException import java io FileOutputStream import java io IOException import java io OutputStream Deprecated public class ReopenableFileOutputStream extends OutputStream protected final File out private OutputStream current private boolean appendOnNextOpen false public ReopenableFileOutputStream File out this out out private synchronized OutputStream current throws IOException if current null try current new FileOutputStream out appendOnNextOpen catch FileNotFoundException e throw new IOException Failed to open out e return current Override public void write int b throws IOException current write b Override public void write byte b throws IOException current write b Override public void write byte b int off int len throws IOException current write b off len Override public void flush throws IOException current flush Override public synchronized void close throws IOException if current null current close appendOnNextOpen true current null public synchronized void rewind throws IOException close appendOnNextOpen falsepackage hudson util io import java io File import java io IOException Deprecated public class ReopenableRotatingFileOutputStream extends ReopenableFileOutputStream private final int size public ReopenableRotatingFileOutputStream File out int size super out this size size protected File getNumberedFileName int n if n 0 return out return new File out getPath n Override public void rewind throws IOException super rewind for int i size 1 i 0 i File fi getNumberedFileName i if fi exists File next getNumberedFileName i 1 next delete fi renameTo next public void deleteAll for int i 0 i size i getNumberedFileName i deletepackage hudson scm import hudson ExtensionPoint import hudson DescriptorExtensionList import hudson Extension import hudson model AbstractDescribableImpl import hudson model Descriptor import jenkins model Jenkins import java io IOException import java io Serializable import java net URL import java net MalformedURLException import org kohsuke stapler export ExportedBean ExportedBean public abstract class RepositoryBrowser E extends ChangeLogSet Entry extends AbstractDescribableImpl RepositoryBrowser implements ExtensionPoint Serializable public abstract URL getChangeSetLink E changeSet throws IOException protected static String trimHeadSlash String s if s startsWith return s substring 1 return s protected static URL normalizeToEndWithSlash URL url if url getPath endsWith return url normalize String q url getQuery q q null q try return new URL url url getPath q catch MalformedURLException e impossible throw new Error e public static DescriptorExtensionList RepositoryBrowser Descriptor RepositoryBrowser all return DescriptorExtensionList Jenkins getInstance getDescriptorList RepositoryBrowser class private static final long serialVersionUID 1Lpackage hudson scm import hudson model Descriptor import hudson model Descriptor FormException import hudson util DescriptorList import hudson Extension import org kohsuke stapler StaplerRequest import java util ArrayList import java util List import net sf json JSONObject public class RepositoryBrowsers Deprecated public static final List Descriptor RepositoryBrowser LIST new DescriptorList RepositoryBrowser Class RepositoryBrowser class public static List Descriptor RepositoryBrowser filter Class extends RepositoryBrowser t List Descriptor RepositoryBrowser r new ArrayList Descriptor RepositoryBrowser for Descriptor RepositoryBrowser d RepositoryBrowser all if d isSubTypeOf t r add d return r Deprecated public static T extends RepositoryBrowser T createInstance Class T type StaplerRequest req String fieldName throws FormException List Descriptor RepositoryBrowser list filter type String value req getParameter fieldName if value null value equals auto return null TODO There was a TODO in the original code which presumes passing something meaningful to the newInstance JSON param Now we just pass empty JSON in order to make the code compliant with the defined interface final JSONObject emptyJSON new JSONObject return type cast list get Integer parseInt value newInstance req emptyJSON public static T extends RepositoryBrowser T createInstance Class T type StaplerRequest req JSONObject parent String fieldName throws FormException JSONObject o JSONObject parent get fieldName if o null return null return req bindJSON type opackage com kaku colorfulnews listener public interface RequestCallBack T void beforeRequest void success T data void onError String errorMsgpackage com twitter sdk android unity import android app Activity import android content Intent import android os Bundle import com twitter sdk android core Callback import com twitter sdk android core Result import com twitter sdk android core TwitterException import com twitter sdk android core TwitterSession import com twitter sdk android core TwitterSessionHelper import com twitter sdk android core identity TwitterAuthClient public class RequestEmailActivity extends Activity TwitterAuthClient authClient Override protected void onCreate Bundle savedInstanceState super onCreate savedInstanceState final String session getIntent getStringExtra TwitterKit EXTRA TWITTER SESSION final TwitterSession twitterSession TwitterSessionHelper deserialize session new TwitterAuthClient requestEmail twitterSession new Callback String Override public void success Result String result final UnityMessage message new UnityMessage Builder setMethod RequestEmailComplete setData result data build message send finish Override public void failure TwitterException ex final String error new ApiError Serializer serialize new ApiError 0 ex getMessage final UnityMessage message new UnityMessage Builder setMethod RequestEmailFailed setData error build message send finish Override protected void onActivityResult int requestCode int resultCode Intent data super onActivityResult requestCode resultCode data authClient onActivityResult requestCode resultCode datapackage com twitter sdk android tweetui import com twitter sdk android core Callback import com twitter sdk android core Result import com twitter sdk android core TwitterException import com twitter sdk android core models Tweet class ResetTweetCallback extends Callback Tweet BaseTweetView baseTweetView TweetRepository tweetRepository Callback Tweet cb ResetTweetCallback BaseTweetView baseTweetView TweetRepository tweetRepository Callback Tweet cb this baseTweetView baseTweetView this tweetRepository tweetRepository this cb cb Override public void success Result Tweet result tweetRepository updateCache result data baseTweetView setTweet result data if cb null cb success result Override public void failure TwitterException exception if cb null cb failure exceptionpackage hudson model import javax annotation CheckForNull import javax annotation Nonnull public final class Resource public final Nonnull String displayName public final CheckForNull Resource parent public final int numConcurrentWrite public Resource CheckForNull Resource parent Nonnull String displayName this parent displayName 1 public Resource CheckForNull Resource parent Nonnull String displayName int numConcurrentWrite if numConcurrentWrite 1 throw new IllegalArgumentException this parent parent this displayName displayName this numConcurrentWrite numConcurrentWrite public Resource Nonnull String displayName this null displayName public boolean isCollidingWith Resource that int count assert that null for Resource r that r null r r parent if this equals r r numConcurrentWrite count return true for Resource r this r null r r parent if that equals r r numConcurrentWrite count return true return false Override public boolean equals Object o if this o return true if o null getClass o getClass return false Resource that Resource o return displayName equals that displayName eq this parent that parent private static boolean eq Object lhs Object rhs if lhs rhs return true if lhs null rhs null return false return lhs equals rhs Override public int hashCode return displayName hashCode Override public String toString StringBuilder buf new StringBuilder if parent null buf append parent append buf append displayName append append numConcurrentWrite append return buf toStringpackage hudson model public interface ResourceActivity ResourceList getResourceList String getDisplayNamepackage jenkins util import net sf json JSONObject import org kohsuke accmod Restricted import org kohsuke accmod restrictions NoExternalUse import javax annotation CheckForNull import javax annotation Nonnull import hudson PluginWrapper import java util logging Logger import java util Locale import java util Map import java util MissingResourceException import java util ResourceBundle import java util concurrent ConcurrentHashMap import jenkins model Jenkins Restricted NoExternalUse class public class ResourceBundleUtil private static final Logger logger Logger getLogger jenkins util ResourceBundle private static final Map String JSONObject bundles new ConcurrentHashMap private ResourceBundleUtil public static Nonnull JSONObject getBundle Nonnull String baseName throws MissingResourceException return getBundle baseName Locale getDefault public static Nonnull JSONObject getBundle Nonnull String baseName Nonnull Locale locale throws MissingResourceException String bundleKey baseName locale toString JSONObject bundleJSON bundles get bundleKey if bundleJSON null return bundleJSON ResourceBundle bundle getBundle baseName locale Jenkins class getClassLoader if bundle null Not in Jenkins core Check the plugins Jenkins jenkins Jenkins getInstance will never return null if jenkins null for PluginWrapper plugin jenkins getPluginManager getPlugins bundle getBundle baseName locale plugin classLoader if bundle null break if bundle null throw new MissingResourceException Can t find bundle for base name baseName locale locale baseName locale bundleJSON toJSONObject bundle bundles put bundleKey bundleJSON return bundleJSON private static CheckForNull ResourceBundle getBundle Nonnull String baseName Nonnull Locale locale Nonnull ClassLoader classLoader try return ResourceBundle getBundle baseName locale classLoader catch MissingResourceException e fall through and return null logger warning e getMessage return null private static JSONObject toJSONObject Nonnull ResourceBundle bundle JSONObject json new JSONObject for String key bundle keySet json put key bundle getString key return jsonpackage hudson model import hudson util AdaptedIterator import java util Set import java util Collection import java util AbstractCollection import java util Iterator import java util concurrent Callable import java util concurrent CopyOnWriteArraySet import javax annotation Nonnull public class ResourceController private final Set ResourceActivity inProgress new CopyOnWriteArraySet ResourceActivity private final Collection ResourceList resourceView new AbstractCollection ResourceList public Iterator ResourceList iterator return new AdaptedIterator ResourceActivity ResourceList inProgress iterator protected ResourceList adapt ResourceActivity item return item getResourceList public int size return inProgress size private ResourceList inUse ResourceList EMPTY public void execute Nonnull Runnable task final ResourceActivity activity throws InterruptedException final ResourceList resources activity getResourceList withLock new Runnable Override public void run while inUse isCollidingWith resources try TODO revalidate the resource list after re acquiring lock for now we just let the build fail await catch InterruptedException e throw new RuntimeException e we have a go inProgress add activity inUse ResourceList union inUse resources try task run finally TODO if AsynchronousExecution do that later withLock new Runnable Override public void run inProgress remove activity inUse ResourceList union resourceView signalAll public boolean canRun final ResourceList resources try return withLock new Callable Boolean Override public Boolean call return inUse isCollidingWith resources catch Exception e throw new IllegalStateException Inner callable does not throw exception public Resource getMissingResource final ResourceList resources try return withLock new Callable Resource Override public Resource call return resources getConflict inUse catch Exception e throw new IllegalStateException Inner callable does not throw exception public ResourceActivity getBlockingActivity ResourceActivity activity ResourceList res activity getResourceList for ResourceActivity a inProgress if res isCollidingWith a getResourceList return a return null protected void await throws InterruptedException wait protected void signalAll notifyAll protected void withLock Runnable runnable synchronized this runnable run protected V V withLock java util concurrent Callable V callable throws Exception synchronized this return callable callpackage hudson model import java util Set import java util HashSet import java util Map import java util HashMap import java util Arrays import java util Collection import java util Map Entry import java util logging Logger public final class ResourceList private static final Logger LOGGER Logger getLogger ResourceList class getName private final Set Resource all new HashSet Resource private final Map Resource Integer write new HashMap Resource Integer private static final Integer MAX INT Integer MAX VALUE public static ResourceList union ResourceList lists return union Arrays asList lists public static ResourceList union Collection ResourceList lists switch lists size case 0 return EMPTY case 1 return lists iterator next default ResourceList r new ResourceList for ResourceList l lists r all addAll l all for Entry Resource Integer e l write entrySet r write put e getKey unbox r write get e getKey e getValue return r public ResourceList r Resource r all add r return this public ResourceList w Resource r all add r write put r unbox write get r 1 return this public boolean isCollidingWith ResourceList that return getConflict that null public Resource getConflict ResourceList that Resource r getConflict this that if r null return r return getConflict that this private Resource getConflict ResourceList lhs ResourceList rhs for Entry Resource Integer r lhs write entrySet for Resource l rhs all Integer v rhs write get l if v null this is write write conflict v r getValue else Otherwise set it to a very large value since it s read write conflict v MAX INT if r getKey isCollidingWith l unbox v LOGGER info Collision with r and l return r getKey return null Override public String toString Map Resource String m new HashMap Resource String for Resource r all m put r R for Entry Resource Integer e write entrySet m put e getKey W e getValue return m toString private static int unbox Integer x return x null 0 x public static final ResourceList EMPTY new ResourceListpackage hudson import java util import javax servlet Filter import javax servlet FilterChain import javax servlet FilterConfig import javax servlet ServletException import javax servlet ServletRequest import javax servlet ServletResponse import javax servlet http HttpServletResponse import java io IOException public class ResponseHeaderFilter implements Filter private FilterConfig config public void init FilterConfig filterConfig throws ServletException config filterConfig public void doFilter ServletRequest req ServletResponse resp FilterChain chain throws IOException ServletException HttpServletResponse httpResp HttpServletResponse resp Enumeration e config getInitParameterNames for each configuration element while e hasMoreElements String headerName String e nextElement String headerValue config getInitParameter headerName set the header with the given name and value httpResp setHeader headerName headerValue chain doFilter req resp public void destroypackage hudson node monitors import hudson Util import hudson Extension import hudson model Computer import hudson remoting Callable import jenkins security MasterToSlaveCallable import net sf json JSONObject import org kohsuke stapler StaplerRequest import java io IOException import java io Serializable import java util Map import java util Map Entry import java util logging Logger import org kohsuke stapler export Exported import org kohsuke stapler export ExportedBean public class ResponseTimeMonitor extends NodeMonitor Extension public static final AbstractNodeMonitorDescriptor Data DESCRIPTOR new AbstractAsyncNodeMonitorDescriptor Data Override protected Callable Data IOException createCallable Computer c return new Step1 get c Override protected Map Computer Data monitor throws InterruptedException Map Computer Data base super monitor for Entry Computer Data e base entrySet Computer c e getKey Data d e getValue if d null if we failed to monitor put in the special value that indicates a failure e setValue d new Data get c 1L if d hasTooManyTimeouts isIgnored unlike other monitors whose failure still allow us to communicate with the agent the failure in this monitor indicates that we are just unable to make any requests to this agent So we should severe the connection as opposed to marking it temporarily off line which still keeps the underlying channel open c disconnect d LOGGER warning Messages ResponseTimeMonitor MarkedOffline c getName return base public String getDisplayName return Messages ResponseTimeMonitor DisplayName Override public NodeMonitor newInstance StaplerRequest req JSONObject formData throws FormException return new ResponseTimeMonitor private static final class Step1 extends MasterToSlaveCallable Data IOException private Data cur private Step1 Data cur this cur cur public Data call this method must be being invoked locally which means the roundtrip time is zero and zero forever return new Data cur 0 private Object writeReplace return new Step2 cur private static final long serialVersionUID 1L private static final class Step2 extends MasterToSlaveCallable Step3 IOException private final Data cur private final long start System currentTimeMillis public Step2 Data cur this cur cur public Step3 call this method must be being invoked locally which means the roundtrip time is zero and zero forever return new Step3 cur start private static final long serialVersionUID 1L private static final class Step3 implements Serializable private final Data cur private final long start private Step3 Data cur long start this cur cur this start start private Object readResolve long end System currentTimeMillis return new Data cur end start private static final long serialVersionUID 1L ExportedBean public static final class Data extends MonitorOfflineCause implements Serializable private final long past5 private Data Data old long newDataPoint if old null past5 new long newDataPoint else past5 new long Math min 5 old past5 length 1 int copyLen past5 length 1 System arraycopy old past5 old past5 length copyLen this past5 0 copyLen past5 past5 length 1 newDataPoint private int failureCount int cnt 0 for int i past5 length 1 i 0 past5 i 0 i cnt return cnt Exported public long getAverage long total 0 for long l past5 if l 0 total TIMEOUT else total l return total past5 length public boolean hasTooManyTimeouts return failureCount 5 Override public String toString StringBuilder buf new StringBuilder for long l past5 if buf length 0 buf append buf append l return buf toString int fc failureCount if fc 0 return Messages ResponseTimeMonitor TimeOut fc return getAverage ms Override public Class extends NodeMonitor getTrigger return ResponseTimeMonitor class private static final long serialVersionUID 1L private static final long TIMEOUT 5000 private static final Logger LOGGER Logger getLogger ResponseTimeMonitor class getNamepackage hudson model import hudson Extension import hudson ExtensionList import hudson ExtensionPoint import jenkins model Jenkins import java io IOException import jenkins model queue AsynchronousExecution public abstract class RestartListener implements ExtensionPoint public abstract boolean isReadyToRestart throws IOException InterruptedException public void onRestart public static ExtensionList RestartListener all return ExtensionList lookup RestartListener class public static boolean isAllReady throws IOException InterruptedException for RestartListener listener all if listener isReadyToRestart return false return true Extension public static class Default extends RestartListener Override public boolean isReadyToRestart throws IOException InterruptedException for Computer c Jenkins getInstance getComputers if c isOnline for Executor e c getExecutors if blocksRestart e return false for Executor e c getOneOffExecutors if blocksRestart e return false return true private static boolean blocksRestart Executor e if e isBusy AsynchronousExecution execution e getAsynchronousExecution if execution null return execution blocksRestart else return true else return falsepackage hudson lifecycle public class RestartNotSupportedException extends Exception public RestartNotSupportedException String reason super reason public RestartNotSupportedException String reason Throwable cause super reason causepackage jenkins import org jvnet localizer Localizable public class RestartRequiredException extends Exception public final Localizable message public RestartRequiredException Localizable message this message message public RestartRequiredException Localizable message Throwable cause super cause this message messagepackage hudson import org kohsuke accmod Restricted import java lang annotation Documented Documented public interface RestrictedSince String valuepackage jenkins util xml import org kohsuke accmod Restricted import org kohsuke accmod restrictions NoExternalUse import org xml sax EntityResolver import org xml sax InputSource import org xml sax SAXException import java io IOException Restricted NoExternalUse class public final class RestrictiveEntityResolver implements EntityResolver public final static RestrictiveEntityResolver INSTANCE new RestrictiveEntityResolver private RestrictiveEntityResolver prevent multiple instantiation super Override public InputSource resolveEntity String publicId String systemId throws SAXException IOException throw new SAXException Refusing to resolve entity with publicId publicId and systemId systemIdpackage hudson model import com thoughtworks xstream converters SingleValueConverter import com thoughtworks xstream converters basic AbstractSingleValueConverter import hudson cli declarative OptionHandlerExtension import hudson init Initializer import hudson util EditDistance import org apache commons beanutils Converter import org kohsuke args4j CmdLineException import org kohsuke args4j CmdLineParser import org kohsuke args4j OptionDef import org kohsuke args4j spi import org kohsuke stapler Stapler import org kohsuke stapler export CustomExportedBean import java io Serializable import java util ArrayList import java util List import javax annotation Nonnegative import javax annotation Nonnull public final class Result implements Serializable CustomExportedBean public static final Nonnull Result SUCCESS new Result SUCCESS BallColor BLUE 0 true public static final Nonnull Result UNSTABLE new Result UNSTABLE BallColor YELLOW 1 true public static final Nonnull Result FAILURE new Result FAILURE BallColor RED 2 true public static final Nonnull Result NOT BUILT new Result NOT BUILT BallColor NOTBUILT 3 false public static final Nonnull Result ABORTED new Result ABORTED BallColor ABORTED 4 false private final Nonnull String name public final Nonnegative int ordinal public final Nonnull BallColor color public final boolean completeBuild private Result Nonnull String name Nonnull BallColor color Nonnegative int ordinal boolean complete this name name this color color this ordinal ordinal this completeBuild complete public Nonnull Result combine Nonnull Result that if this ordinal that ordinal return that else return this public boolean isWorseThan Nonnull Result that return this ordinal that ordinal public boolean isWorseOrEqualTo Nonnull Result that return this ordinal that ordinal public boolean isBetterThan Nonnull Result that return this ordinal that ordinal public boolean isBetterOrEqualTo Nonnull Result that return this ordinal that ordinal public boolean isCompleteBuild return this completeBuild Override public Nonnull String toString return name public Nonnull String toExportedObject return name public static Nonnull Result fromString Nonnull String s for Result r all if s equalsIgnoreCase r name return r return FAILURE private static Nonnull List String getNames List String l new ArrayList String for Result r all l add r name return l Maintain each Result as a singleton deserialized like build result from an agent node private Object readResolve for Result r all if ordinal r ordinal return r return FAILURE private static final long serialVersionUID 1L private static final Result all new Result SUCCESS UNSTABLE FAILURE NOT BUILT ABORTED public static final SingleValueConverter conv new AbstractSingleValueConverter Override public boolean canConvert Class clazz return clazz Result class Override public Object fromString String s return Result fromString s OptionHandlerExtension public static final class OptionHandlerImpl extends OptionHandler Result public OptionHandlerImpl CmdLineParser parser OptionDef option Setter super Result setter super parser option setter Override public int parseArguments Parameters params throws CmdLineException String param params getParameter 0 Result v fromString param replace if v null throw new CmdLineException owner No such status param Did you mean EditDistance findNearest param replace toUpperCase getNames setter addValue v return 1 Override public String getDefaultMetaVariable return STATUS Initializer public static void init Stapler CONVERT UTILS register new Converter public Object convert Class type Object value return Result fromString value toString Result classpackage hudson model import org jvnet localizer Localizable import java util Locale public enum ResultTrend FIXED Messages ResultTrend Fixed SUCCESS Messages ResultTrend Success NOW UNSTABLE Messages ResultTrend NowUnstable STILL UNSTABLE Messages ResultTrend StillUnstable UNSTABLE Messages ResultTrend Unstable STILL FAILING Messages ResultTrend StillFailing FAILURE Messages ResultTrend Failure ABORTED Messages ResultTrend Aborted NOT BUILT Messages ResultTrend NotBuilt private final Localizable description private ResultTrend Localizable description this description description public String getDescription return this description toString public String getID return this description toString Locale ENGLISH toUpperCase Locale ENGLISH public static ResultTrend getResultTrend AbstractBuild build return getResultTrend Run build public static ResultTrend getResultTrend Run run Result result run getResult if result Result ABORTED return ABORTED else if result Result NOT BUILT return NOT BUILT if result Result SUCCESS if isFix run return FIXED else return SUCCESS Run previousBuild getPreviousNonAbortedBuild run if result Result UNSTABLE if previousBuild null return UNSTABLE if previousBuild getResult Result UNSTABLE return STILL UNSTABLE else if previousBuild getResult Result FAILURE return NOW UNSTABLE else return UNSTABLE else if result Result FAILURE if previousBuild null previousBuild getResult Result FAILURE return STILL FAILING else return FAILURE throw new IllegalArgumentException Unknown result result for build run private static Run getPreviousNonAbortedBuild Run build Run previousBuild build getPreviousBuild while previousBuild null if previousBuild getResult null previousBuild getResult Result ABORTED previousBuild getResult Result NOT BUILT previousBuild previousBuild getPreviousBuild else return previousBuild return previousBuild private static boolean isFix Run build if build getResult Result SUCCESS return false Run previousBuild getPreviousNonAbortedBuild build if previousBuild null return previousBuild getResult isWorseThan Result SUCCESS return falsepackage hudson slaves import hudson ExtensionPoint import hudson Util import hudson DescriptorExtensionList import hudson Extension import hudson model import hudson util DescriptorList import java util Collections import java util HashMap import jenkins model Jenkins import org jenkinsci Symbol import org kohsuke stapler DataBoundConstructor import javax annotation concurrent GuardedBy import java util concurrent TimeUnit import java util logging Level import java util logging Logger public abstract class RetentionStrategy T extends Computer extends AbstractDescribableImpl RetentionStrategy implements ExtensionPoint GuardedBy hudson model Queue lock public abstract long check T c public boolean isManualLaunchAllowed T c return true public boolean isAcceptingTasks T c return true public void start final T c Queue withLock new Runnable Override public void run check c public static DescriptorExtensionList RetentionStrategy Descriptor RetentionStrategy all return DescriptorExtensionList Jenkins getInstance getDescriptorList RetentionStrategy class Deprecated public static final DescriptorList RetentionStrategy LIST new DescriptorList RetentionStrategy Class RetentionStrategy class public static final RetentionStrategy Computer NOOP new RetentionStrategy Computer GuardedBy hudson model Queue lock public long check Computer c return 60 Override public void start Computer c c connect false Override public Descriptor RetentionStrategy getDescriptor return DESCRIPTOR private final DescriptorImpl DESCRIPTOR new DescriptorImpl class DescriptorImpl extends Descriptor RetentionStrategy public static final Always INSTANCE new Always public static class Always extends RetentionStrategy SlaveComputer DataBoundConstructor public Always GuardedBy hudson model Queue lock public long check SlaveComputer c if c isOffline c isConnecting c isLaunchSupported c tryReconnect return 1 Extension ordinal 100 Symbol always public static class DescriptorImpl extends Descriptor RetentionStrategy public String getDisplayName return Messages RetentionStrategy Always displayName public static class Demand extends RetentionStrategy SlaveComputer private static final Logger logger Logger getLogger Demand class getName private final long inDemandDelay private final long idleDelay DataBoundConstructor public Demand long inDemandDelay long idleDelay this inDemandDelay Math max 0 inDemandDelay this idleDelay Math max 1 idleDelay public long getInDemandDelay return inDemandDelay public long getIdleDelay return idleDelay Override GuardedBy hudson model Queue lock public long check final SlaveComputer c if c isOffline c isLaunchSupported final HashMap Computer Integer availableComputers new HashMap Computer Integer for Computer o Jenkins getInstance getComputers if o isOnline o isConnecting o isPartiallyIdle o isAcceptingTasks final int idleExecutors o countIdle if idleExecutors 0 availableComputers put o idleExecutors boolean needComputer false long demandMilliseconds 0 for Queue BuildableItem item Queue getInstance getBuildableItems can any of the currently idle executors take this task assume the answer is no until we can find such an executor boolean needExecutor true for Computer o Collections unmodifiableSet availableComputers keySet Node otherNode o getNode if otherNode null otherNode canTake item null needExecutor false final int availableExecutors availableComputers remove o if availableExecutors 1 availableComputers put o availableExecutors 1 else availableComputers remove o break this item cannot be built by any of the existing idle nodes but it can be built by c Node checkedNode c getNode if needExecutor checkedNode null checkedNode canTake item null demandMilliseconds System currentTimeMillis item buildableStartMilliseconds needComputer demandMilliseconds inDemandDelay 1000 60 break if needComputer we ve been in demand for long enough logger log Level INFO Launching computer 0 as it has been in demand for 1 new Object c getName Util getTimeSpanString demandMilliseconds c connect false else if c isIdle final long idleMilliseconds System currentTimeMillis c getIdleStartMilliseconds if idleMilliseconds idleDelay 1000 60 we ve been idle for long enough logger log Level INFO Disconnecting computer 0 as it has been idle for 1 new Object c getName Util getTimeSpanString idleMilliseconds c disconnect new OfflineCause IdleOfflineCause else no point revisiting until we can be confident we will be idle return TimeUnit MILLISECONDS toMinutes TimeUnit MINUTES toMillis idleDelay idleMilliseconds return 1 Extension Symbol demand public static class DescriptorImpl extends Descriptor RetentionStrategy Override public String getDisplayName return Messages RetentionStrategy Demand displayNameimport java util Date import org apache axis client Call import org apache axis client Stub import com adyen services payment Recurring import com adyen services recurring RecurringDetail import com adyen services recurring RecurringDetailsRequest import com adyen services recurring RecurringDetailsResult import com adyen services recurring RecurringLocator import com adyen services recurring RecurringPortType public class RetrieveRecurringCardDetails public static void main String args try RecurringPortType ws new RecurringLocator getRecurringHttpPort new java net URL Credentials recurring test address Basic HTTP Authentication Stub ws setProperty Call USERNAME PROPERTY Credentials ws user Stub ws setProperty Call PASSWORD PROPERTY Credentials pwd user RecurringDetailsRequest request new RecurringDetailsRequest request setMerchantAccount Credentials merchant account request setRecurring new Recurring RECURRING null request setShopperReference shopper0001 RecurringDetailsResult result ws listRecurringDetails request System out println new Date System out println result getLastKnownShopperEmail System out println result getShopperReference System out println result getCreationDate RecurringDetail details result getDetails for RecurringDetail detail details System out println System out println detail getName System out println detail getRecurringDetailReference System out println detail getVariant if detail getCard null System out println detail getCard getBrand System out println detail getCard getExpiryMonth System out println detail getCard getExpiryYear System out println detail getCard getHolderName System out println detail getCard getNumber catch Exception ex ex printStackTracepackage com kaku colorfulnews repository network import android support annotation NonNull import android util SparseArray import com kaku colorfulnews App import com kaku colorfulnews common ApiConstants import com kaku colorfulnews common HostType import com kaku colorfulnews mvp entity GirlData import com kaku colorfulnews mvp entity NewsDetail import com kaku colorfulnews mvp entity NewsSummary import com kaku colorfulnews utils NetUtil import com socks library KLog import java io File import java io IOException import java util List import java util Locale import java util Map import java util concurrent TimeUnit import okhttp3 Cache import okhttp3 CacheControl import okhttp3 Interceptor import okhttp3 OkHttpClient import okhttp3 Request import okhttp3 Response import okhttp3 ResponseBody import retrofit2 Retrofit import retrofit2 adapter rxjava RxJavaCallAdapterFactory import retrofit2 converter gson GsonConverterFactory import rx Observable public class RetrofitManager private NewsService mNewsService private static final long CACHE STALE SEC 60 60 24 2 private static final String CACHE CONTROL CACHE only if cached max stale CACHE STALE SEC private static final String CACHE CONTROL AGE max age 0 private static volatile OkHttpClient sOkHttpClient private static SparseArray RetrofitManager sRetrofitManager new SparseArray HostType TYPE COUNT public RetrofitManager HostType HostTypeChecker int hostType Retrofit retrofit new Retrofit Builder baseUrl ApiConstants getHost hostType client getOkHttpClient addConverterFactory GsonConverterFactory create addCallAdapterFactory RxJavaCallAdapterFactory create build mNewsService retrofit create NewsService class private OkHttpClient getOkHttpClient if sOkHttpClient null synchronized RetrofitManager class Cache cache new Cache new File App getAppContext getCacheDir HttpCache 1024 1024 100 if sOkHttpClient null sOkHttpClient new OkHttpClient Builder cache cache connectTimeout 6 TimeUnit SECONDS readTimeout 6 TimeUnit SECONDS writeTimeout 6 TimeUnit SECONDS addInterceptor mRewriteCacheControlInterceptor addNetworkInterceptor mRewriteCacheControlInterceptor addInterceptor mLoggingInterceptor build return sOkHttpClient private final Interceptor mRewriteCacheControlInterceptor new Interceptor Override public Response intercept Chain chain throws IOException Request request chain request if NetUtil isNetworkAvailable request request newBuilder cacheControl CacheControl FORCE CACHE build KLog d no network Response originalResponse chain proceed request if NetUtil isNetworkAvailable Headers String cacheControl request cacheControl toString return originalResponse newBuilder header Cache Control cacheControl removeHeader Pragma build else return originalResponse newBuilder header Cache Control public only if cached max stale CACHE STALE SEC removeHeader Pragma build private final Interceptor mLoggingInterceptor new Interceptor Override public Response intercept Chain chain throws IOException Request request chain request long t1 System nanoTime KLog i String format Sending request s on s n s request url chain connection request headers Response response chain proceed request long t2 System nanoTime KLog i String format Locale getDefault Received response for s in 1fms n s response request url t2 t1 1e6d response headers return response public static RetrofitManager getInstance int hostType RetrofitManager retrofitManager sRetrofitManager get hostType if retrofitManager null retrofitManager new RetrofitManager hostType sRetrofitManager put hostType retrofitManager return retrofitManager return retrofitManager NonNull private String getCacheControl return NetUtil isNetworkAvailable CACHE CONTROL AGE CACHE CONTROL CACHE public Observable Map String List NewsSummary getNewsListObservable String newsType String newsId int startPage return mNewsService getNewsList getCacheControl newsType newsId startPage public Observable Map String NewsDetail getNewsDetailObservable String postId KLog d Thread currentThread getName return mNewsService getNewDetail getCacheControl postId public Observable ResponseBody getNewsBodyHtmlPhoto String photoPath return mNewsService getNewsBodyHtmlPhoto photoPath public Observable GirlData getPhotoListObservable int size int page return mNewsService getPhotoList size pagepackage jenkins triggers import hudson Extension import hudson ExtensionList import hudson Util import hudson console ModelHyperlinkNote import hudson model AbstractBuild import hudson model AbstractProject import hudson model Action import hudson model AutoCompletionCandidates import hudson model Cause import hudson model CauseAction import hudson model DependencyGraph import hudson model Item import hudson model ItemGroup import hudson model Items import hudson model Job import hudson model Queue import hudson model Result import hudson model Run import hudson model TaskListener import hudson model listeners ItemListener import hudson model listeners RunListener import hudson model queue Tasks import hudson security ACL import hudson security ACLContext import hudson tasks BuildTrigger import hudson triggers Trigger import hudson triggers TriggerDescriptor import hudson util FormValidation import java io IOException import java util ArrayList import java util Collection import java util LinkedList import java util List import java util Map import java util StringTokenizer import java util WeakHashMap import java util logging Level import java util logging Logger import jenkins model DependencyDeclarer import jenkins model Jenkins import jenkins model ParameterizedJobMixIn import jenkins security QueueItemAuthenticatorConfiguration import org acegisecurity Authentication import org acegisecurity context SecurityContext import org acegisecurity context SecurityContextHolder import org apache commons lang StringUtils import org jenkinsci Symbol import org kohsuke stapler AncestorInPath import org kohsuke stapler DataBoundConstructor import org kohsuke stapler QueryParameter import javax annotation Nonnull SuppressWarnings rawtypes public final class ReverseBuildTrigger extends Trigger Job implements DependencyDeclarer private static final Logger LOGGER Logger getLogger ReverseBuildTrigger class getName private String upstreamProjects private final Result threshold DataBoundConstructor public ReverseBuildTrigger String upstreamProjects Result threshold this upstreamProjects upstreamProjects this threshold threshold public String getUpstreamProjects return upstreamProjects public Result getThreshold return threshold private boolean shouldTrigger Run upstreamBuild TaskListener listener Jenkins jenkins Jenkins getInstance if job null return false This checks Item READ also on parent folders note we are checking as the upstream auth currently boolean downstreamVisible jenkins getItemByFullName job getFullName job Authentication originalAuth Jenkins getAuthentication Job upstream upstreamBuild getParent Authentication auth Tasks getAuthenticationOf Queue Task job if auth equals ACL SYSTEM QueueItemAuthenticatorConfiguration get getAuthenticators isEmpty auth Jenkins ANONYMOUS cf BuildTrigger SecurityContext orig ACL impersonate auth try if jenkins getItemByFullName upstream getFullName upstream if downstreamVisible TODO ModelHyperlink listener getLogger println Messages ReverseBuildTrigger running as cannot even see for trigger f auth getName upstream getFullName job getFullName else LOGGER log Level WARNING Running as 0 cannot even see 1 for trigger from 2 but cannot tell 3 that new Object auth getName upstream job originalAuth getName return false No need to check Item BUILD on downstream because the downstream project s configurer has asked for this finally SecurityContextHolder setContext orig Result result upstreamBuild getResult return result null result isBetterOrEqualTo threshold Override public void buildDependencyGraph final AbstractProject downstream DependencyGraph graph for AbstractProject upstream Items fromNameList downstream getParent upstreamProjects AbstractProject class graph addDependency new DependencyGraph Dependency upstream downstream Override public boolean shouldTriggerBuild AbstractBuild upstreamBuild TaskListener listener List Action actions return shouldTrigger upstreamBuild listener Override public void start Nonnull Job project boolean newInstance super start project newInstance RunListenerImpl get invalidateCache Override public void stop super stop RunListenerImpl get invalidateCache Extension Symbol upstream public static final class DescriptorImpl extends TriggerDescriptor Override public String getDisplayName return Messages ReverseBuildTrigger build after other projects are built Override public boolean isApplicable Item item return item instanceof Job item instanceof ParameterizedJobMixIn ParameterizedJob public AutoCompletionCandidates doAutoCompleteUpstreamProjects QueryParameter String value AncestorInPath Item self AncestorInPath ItemGroup container return AutoCompletionCandidates ofJobNames Job class value self container public FormValidation doCheckUpstreamProjects AncestorInPath Job project QueryParameter String value if project hasPermission Item CONFIGURE return FormValidation ok StringTokenizer tokens new StringTokenizer Util fixNull value boolean hasProjects false while tokens hasMoreTokens String projectName tokens nextToken trim if StringUtils isNotBlank projectName Job item Jenkins getInstance getItem projectName project Job class if item null Job nearest Items findNearest Job class projectName project getParent String alternative nearest null nearest getRelativeNameFrom project return FormValidation error hudson tasks Messages BuildTrigger NoSuchProject projectName alternative hasProjects true if hasProjects return FormValidation error hudson tasks Messages BuildTrigger NoProjectSpecified return FormValidation ok Extension public static final class RunListenerImpl extends RunListener Run static RunListenerImpl get return ExtensionList lookup RunListener class get RunListenerImpl class private Map Job Collection ReverseBuildTrigger upstream2Trigger synchronized void invalidateCache upstream2Trigger null private Map Job Collection ReverseBuildTrigger calculateCache try ACLContext ACL as ACL SYSTEM final Map Job Collection ReverseBuildTrigger result new WeakHashMap for Job downstream Jenkins getInstance getAllItems Job class ReverseBuildTrigger trigger ParameterizedJobMixIn getTrigger downstream ReverseBuildTrigger class if trigger null continue List Job upstreams Items fromNameList downstream getParent trigger upstreamProjects Job class LOGGER log Level FINE from 0 see upstreams 1 new Object downstream upstreams for Job upstream upstreams if upstream instanceof AbstractProject downstream instanceof AbstractProject continue handled specially Collection ReverseBuildTrigger triggers result get upstream if triggers null triggers new LinkedList result put upstream triggers triggers remove trigger triggers add trigger return result Override public void onCompleted Nonnull Run r Nonnull TaskListener listener Collection ReverseBuildTrigger triggers synchronized this if upstream2Trigger null upstream2Trigger calculateCache Collection ReverseBuildTrigger triggers upstream2Trigger get r getParent if triggers null triggers isEmpty return triggers new ArrayList triggers for final ReverseBuildTrigger trigger triggers if trigger shouldTrigger r listener if trigger job isBuildable listener getLogger println hudson tasks Messages BuildTrigger Disabled ModelHyperlinkNote encodeTo trigger job continue String name ModelHyperlinkNote encodeTo trigger job trigger job getNextBuildNumber if ParameterizedJobMixIn scheduleBuild2 trigger job 1 new CauseAction new Cause UpstreamCause r null listener getLogger println hudson tasks Messages BuildTrigger Triggering name else listener getLogger println hudson tasks Messages BuildTrigger InQueue name Extension public static class ItemListenerImpl extends ItemListener Override public void onLocationChanged Item item final String oldFullName final String newFullName try ACLContext ACL as ACL SYSTEM for Job p Jenkins getInstance getAllItems Job class ReverseBuildTrigger t ParameterizedJobMixIn getTrigger p ReverseBuildTrigger class if t null String revised Items computeRelativeNamesAfterRenaming oldFullName newFullName t upstreamProjects p getParent if revised equals t upstreamProjects t upstreamProjects revised try p save catch IOException e LOGGER log Level WARNING Failed to persist project setting during rename from oldFullName to newFullName epackage hudson diagnosis import hudson Extension import hudson Util import hudson model AdministrativeMonitor import org jenkinsci Symbol import org kohsuke stapler HttpRedirect import org kohsuke stapler HttpResponse import org kohsuke stapler HttpResponses import org kohsuke stapler QueryParameter import java io IOException import java util logging Level import java util logging Logger import jenkins model Jenkins import org kohsuke stapler Stapler Extension Symbol reverseProxy public class ReverseProxySetupMonitor extends AdministrativeMonitor private static final Logger LOGGER Logger getLogger ReverseProxySetupMonitor class getName Override public boolean isActivated return true to always inject an HTML fragment to perform a test return true public HttpResponse doTest String referer Stapler getCurrentRequest getReferer Jenkins j Jenkins getInstance May need to send an absolute URL since handling of HttpRedirect with a relative URL does not currently honor X Forwarded Proto Port at all String redirect j getRootUrl administrativeMonitor id testForReverseProxySetup referer null Util rawEncode referer NO REFERER LOGGER log Level FINE coming from 0 and redirecting to 1 new Object referer redirect return new HttpRedirect redirect public void getTestForReverseProxySetup String rest Jenkins j Jenkins getInstance String inferred j getRootUrlFromRequest manage TODO this could also verify that j getRootUrl has been properly configured and send a different message if not if rest startsWith inferred not using equals due to JENKINS 24014 throw HttpResponses ok else LOGGER log Level WARNING 0 vs 1 new Object inferred rest throw HttpResponses errorWithoutStack 404 inferred vs rest public HttpResponse doAct QueryParameter String no throws IOException if no null dismiss disable true of course the irony is that this redirect won t work return HttpResponses redirectViaContextPath manage else return new HttpRedirect https wiki jenkins ci org display JENKINS Jenkins says my reverse proxy setup is broken Override public String getDisplayName return Messages ReverseProxySetupMonitor DisplayNamepackage hudson util io import java io File import java io FileNotFoundException import java io FileOutputStream import java io IOException import java io OutputStream public class RewindableFileOutputStream extends OutputStream protected final File out private boolean closed private OutputStream current public RewindableFileOutputStream File out this out out private synchronized OutputStream current throws IOException if current null if closed try current new FileOutputStream out false catch FileNotFoundException e throw new IOException Failed to open out e else throw new IOException out getName stream is closed return current Override public void write int b throws IOException current write b Override public void write byte b throws IOException current write b Override public void write byte b int off int len throws IOException current write b off len Override public void flush throws IOException current flush Override public synchronized void close throws IOException closeCurrent closed true public synchronized void rewind throws IOException closeCurrent private void closeCurrent throws IOException if current null current close current nullpackage hudson util io import java io File import java io IOException public class RewindableRotatingFileOutputStream extends RewindableFileOutputStream private final int size public RewindableRotatingFileOutputStream File out int size super out this size size protected File getNumberedFileName int n if n 0 return out return new File out getPath n Override public void rewind throws IOException super rewind for int i size 1 i 0 i File fi getNumberedFileName i if fi exists File next getNumberedFileName i 1 next delete fi renameTo next public void deleteAll for int i 0 i size i getNumberedFileName i deletepackage hudson util import java util AbstractList import java util List import java util logging Handler import java util logging LogRecord public class RingBufferLogHandler extends Handler private static final int DEFAULT RING BUFFER SIZE Integer getInteger RingBufferLogHandler class getName defaultSize 256 private int start 0 private final LogRecord records private volatile int size 0 Deprecated public RingBufferLogHandler this DEFAULT RING BUFFER SIZE public RingBufferLogHandler int ringSize records new LogRecord ringSize public synchronized void publish LogRecord record int len records length records start size len record if size len start start 1 len else size public synchronized void clear size 0 start 0 public List LogRecord getView return new AbstractList LogRecord public LogRecord get int index flip the order synchronized RingBufferLogHandler this return records start size index 1 records length public int size return size noop public void flush public void close throws SecurityExceptionpackage hudson util import com thoughtworks xstream converters UnmarshallingContext import com thoughtworks xstream converters collections CollectionConverter import com thoughtworks xstream converters reflection ReflectionProvider import com thoughtworks xstream converters reflection SerializableConverter import com thoughtworks xstream io HierarchicalStreamReader import com thoughtworks xstream mapper Mapper import com thoughtworks xstream XStream import com thoughtworks xstream XStreamException import java util Collection import java util concurrent CopyOnWriteArrayList import java util concurrent CopyOnWriteArraySet import jenkins util xstream CriticalXStreamException public class RobustCollectionConverter extends CollectionConverter private final SerializableConverter sc public RobustCollectionConverter XStream xs this xs getMapper xs getReflectionProvider public RobustCollectionConverter Mapper mapper ReflectionProvider reflectionProvider super mapper sc new SerializableConverter mapper reflectionProvider Override public boolean canConvert Class type return super canConvert type type CopyOnWriteArrayList class type CopyOnWriteArraySet class Override public Object unmarshal HierarchicalStreamReader reader UnmarshallingContext context CopyOnWriteArrayList used to serialize as custom serialization so read it in a compatible fashion String s reader getAttribute serialization if s null s equals custom return sc unmarshal reader context else return super unmarshal reader context Override protected void populateCollection HierarchicalStreamReader reader UnmarshallingContext context Collection collection while reader hasMoreChildren reader moveDown try Object item readItem reader context collection collection add item catch CriticalXStreamException e throw e catch XStreamException e RobustReflectionConverter addErrorInContext context e catch LinkageError e RobustReflectionConverter addErrorInContext context e reader moveUppackage hudson util import com thoughtworks xstream XStreamException import com thoughtworks xstream converters UnmarshallingContext import com thoughtworks xstream converters collections MapConverter import com thoughtworks xstream io HierarchicalStreamReader import com thoughtworks xstream mapper Mapper import java util Map import jenkins util xstream CriticalXStreamException SuppressWarnings rawtypes unchecked final class RobustMapConverter extends MapConverter private static final Object ERROR new Object RobustMapConverter Mapper mapper super mapper Override protected void putCurrentEntryIntoMap HierarchicalStreamReader reader UnmarshallingContext context Map map Map target Object key read reader context map Object value read reader context map if key ERROR value ERROR target put key value private Object read HierarchicalStreamReader reader UnmarshallingContext context Map map reader moveDown try return readItem reader context map catch CriticalXStreamException x throw x catch XStreamException x RobustReflectionConverter addErrorInContext context x return ERROR catch LinkageError x RobustReflectionConverter addErrorInContext context x return ERROR finally reader moveUppackage hudson util import com thoughtworks xstream XStreamException import com thoughtworks xstream converters ConversionException import com thoughtworks xstream converters Converter import com thoughtworks xstream converters MarshallingContext import com thoughtworks xstream converters SingleValueConverter import com thoughtworks xstream converters UnmarshallingContext import com thoughtworks xstream converters reflection ObjectAccessException import com thoughtworks xstream converters reflection PureJavaReflectionProvider import com thoughtworks xstream converters reflection ReflectionConverter import com thoughtworks xstream converters reflection ReflectionProvider import com thoughtworks xstream converters reflection SerializationMethodInvoker import com thoughtworks xstream core util Primitives import com thoughtworks xstream io ExtendedHierarchicalStreamWriterHelper import com thoughtworks xstream io HierarchicalStreamReader import com thoughtworks xstream io HierarchicalStreamWriter import com thoughtworks xstream mapper Mapper import hudson diagnosis OldDataMonitor import hudson model Saveable import java lang reflect Field import java util ArrayList import java util Collection import java util Collections import java util HashMap import java util HashSet import java util Iterator import java util LinkedList import java util Map import java util Set import java util concurrent locks ReadWriteLock import java util concurrent locks ReentrantReadWriteLock import static java util logging Level FINE import java util logging Logger import javax annotation Nonnull import javax annotation concurrent GuardedBy import jenkins util xstream CriticalXStreamException public class RobustReflectionConverter implements Converter protected final ReflectionProvider reflectionProvider protected final Mapper mapper protected transient SerializationMethodInvoker serializationMethodInvoker private transient ReflectionProvider pureJavaReflectionProvider private final Nonnull XStream2 ClassOwnership classOwnership private final ReadWriteLock criticalFieldsLock new ReentrantReadWriteLock GuardedBy criticalFieldsLock private final Map String Set String criticalFields new HashMap String Set String public RobustReflectionConverter Mapper mapper ReflectionProvider reflectionProvider this mapper reflectionProvider new XStream2 new PluginClassOwnership RobustReflectionConverter Mapper mapper ReflectionProvider reflectionProvider XStream2 ClassOwnership classOwnership this mapper mapper this reflectionProvider reflectionProvider assert classOwnership null this classOwnership classOwnership serializationMethodInvoker new SerializationMethodInvoker void addCriticalField Class clazz String field Lock the write lock criticalFieldsLock writeLock lock try If the class already exists then add a new field otherwise create the hash map field if criticalFields containsKey field criticalFields put field new HashSet String criticalFields get field add clazz getName finally Unlock criticalFieldsLock writeLock unlock private boolean hasCriticalField Class clazz String field Lock the write lock criticalFieldsLock readLock lock try Set String classesWithField criticalFields get field if classesWithField null return false if classesWithField contains clazz getName return false return true finally criticalFieldsLock readLock unlock public boolean canConvert Class type return true public void marshal Object original final HierarchicalStreamWriter writer final MarshallingContext context final Object source serializationMethodInvoker callWriteReplace original if source getClass original getClass writer addAttribute mapper aliasForAttribute resolves to mapper serializedClass source getClass OwnerContext oc OwnerContext find context oc startVisiting writer classOwnership ownerOf original getClass try doMarshal source writer context finally oc stopVisiting private static class OwnerContext extends LinkedList String static OwnerContext find MarshallingContext context OwnerContext c OwnerContext context get OwnerContext class if c null c new OwnerContext context put OwnerContext class c return c private void startVisiting HierarchicalStreamWriter writer String owner if owner null boolean redundant false for String parentOwner this if parentOwner null redundant parentOwner equals owner break if redundant writer addAttribute plugin owner addFirst owner private void stopVisiting removeFirst protected void doMarshal final Object source final HierarchicalStreamWriter writer final MarshallingContext context final Set seenFields new HashSet final Set seenAsAttributes new HashSet Attributes might be preferred to child elements reflectionProvider visitSerializableFields source new ReflectionProvider Visitor public void visit String fieldName Class type Class definedIn Object value SingleValueConverter converter mapper getConverterFromItemType fieldName type definedIn if converter null converter mapper getConverterFromItemType fieldName type if converter null converter mapper getConverterFromItemType type if converter null if value null final String str converter toString value if str null writer addAttribute mapper aliasForAttribute fieldName str seenAsAttributes add fieldName Child elements not covered already processed as attributes reflectionProvider visitSerializableFields source new ReflectionProvider Visitor public void visit String fieldName Class fieldType Class definedIn Object newObj if seenAsAttributes contains fieldName newObj null Mapper ImplicitCollectionMapping mapping mapper getImplicitCollectionDefForFieldName source getClass fieldName if mapping null if mapping getItemFieldName null Collection list Collection newObj for Iterator iter list iterator iter hasNext Object obj iter next writeField fieldName mapping getItemFieldName mapping getItemType definedIn obj else context convertAnother newObj else writeField fieldName fieldName fieldType definedIn newObj seenFields add fieldName private void writeField String fieldName String aliasName Class fieldType Class definedIn Object newObj try if mapper shouldSerializeMember definedIn aliasName return ExtendedHierarchicalStreamWriterHelper startNode writer mapper serializedMember definedIn aliasName fieldType Class actualType newObj getClass Class defaultType mapper defaultImplementationOf fieldType if actualType equals defaultType String serializedClassName mapper serializedClass actualType if serializedClassName equals mapper serializedClass defaultType writer addAttribute mapper aliasForSystemAttribute class serializedClassName if seenFields contains aliasName writer addAttribute mapper aliasForAttribute defined in mapper serializedClass definedIn Field field reflectionProvider getField definedIn fieldName marshallField context newObj field writer endNode catch RuntimeException e intercept an exception so that the stack trace shows how we end up marshalling the object in question throw new RuntimeException Failed to serialize definedIn getName fieldName for source getClass e protected void marshallField final MarshallingContext context Object newObj Field field Converter converter mapper getLocalConverter field getDeclaringClass field getName context convertAnother newObj converter public Object unmarshal final HierarchicalStreamReader reader final UnmarshallingContext context Object result instantiateNewInstance reader context result doUnmarshal result reader context return serializationMethodInvoker callReadResolve result public Object doUnmarshal final Object result final HierarchicalStreamReader reader final UnmarshallingContext context final SeenFields seenFields new SeenFields Iterator it reader getAttributeNames Remember outermost Saveable encountered for reporting below if result instanceof Saveable context get Saveable null context put Saveable result Process attributes before recursing into child elements while it hasNext String attrAlias String it next String attrName mapper attributeForAlias attrAlias Class classDefiningField determineWhichClassDefinesField reader boolean fieldExistsInClass fieldDefinedInClass result attrName if fieldExistsInClass Field field reflectionProvider getField result getClass attrName SingleValueConverter converter mapper getConverterFromAttribute field getDeclaringClass attrName field getType Class type field getType if converter null converter mapper getConverterFromItemType type if converter null Object value converter fromString reader getAttribute attrAlias if type isPrimitive type Primitives box type if value null type isAssignableFrom value getClass throw new ConversionException Cannot convert type value getClass getName to type type getName reflectionProvider writeField result attrName value classDefiningField seenFields add classDefiningField attrName Map implicitCollectionsForCurrentObject null while reader hasMoreChildren reader moveDown boolean critical false try String fieldName mapper realMember result getClass reader getNodeName for Class concrete result getClass concrete null concrete concrete getSuperclass Not quite right since a subclass could shadow a field but probably suffices if hasCriticalField concrete fieldName critical true break boolean implicitCollectionHasSameName mapper getImplicitCollectionDefForFieldName result getClass reader getNodeName null Class classDefiningField determineWhichClassDefinesField reader boolean fieldExistsInClass implicitCollectionHasSameName fieldDefinedInClass result fieldName Class type determineType reader fieldExistsInClass result fieldName classDefiningField final Object value if fieldExistsInClass Field field reflectionProvider getField result getClass fieldName value unmarshalField context result type field TODO the reflection provider should have returned the proper field in first place Class definedType reflectionProvider getFieldType result fieldName classDefiningField if definedType isPrimitive type definedType else value context convertAnother result type if value null type isAssignableFrom value getClass LOGGER warning Cannot convert type value getClass getName to type type getName behave as if we didn t see this element else if fieldExistsInClass reflectionProvider writeField result fieldName value classDefiningField seenFields add classDefiningField fieldName else implicitCollectionsForCurrentObject writeValueToImplicitCollection context value implicitCollectionsForCurrentObject result fieldName catch CriticalXStreamException e throw e catch XStreamException e if critical throw new CriticalXStreamException e addErrorInContext context e catch LinkageError e if critical throw e addErrorInContext context e reader moveUp Report any class field errors in Saveable objects if context get ReadError null context get Saveable result OldDataMonitor report Saveable result ArrayList Throwable context get ReadError context put ReadError null return result public static void addErrorInContext UnmarshallingContext context Throwable e LOGGER log FINE Failed to load e ArrayList Throwable list ArrayList Throwable context get ReadError if list null context put ReadError list new ArrayList Throwable list add e private boolean fieldDefinedInClass Object result String attrName during unmarshalling unmarshal into transient fields like XStream 1 1 3 boolean fieldExistsInClass reflectionProvider fieldDefinedInClass attrName result getClass return reflectionProvider getFieldOrNull result getClass attrName null protected Object unmarshalField final UnmarshallingContext context final Object result Class type Field field Converter converter mapper getLocalConverter field getDeclaringClass field getName return context convertAnother result type converter private Map writeValueToImplicitCollection UnmarshallingContext context Object value Map implicitCollections Object result String itemFieldName String fieldName mapper getFieldNameForItemTypeAndName context getRequiredType value getClass itemFieldName if fieldName null if implicitCollections null implicitCollections new HashMap lazy instantiation Collection collection Collection implicitCollections get fieldName if collection null Class fieldType mapper defaultImplementationOf reflectionProvider getFieldType result fieldName null if Collection class isAssignableFrom fieldType throw new ObjectAccessException Field fieldName of result getClass getName is configured for an implicit Collection but field is of type fieldType getName if pureJavaReflectionProvider null pureJavaReflectionProvider new PureJavaReflectionProvider collection Collection pureJavaReflectionProvider newInstance fieldType reflectionProvider writeField result fieldName collection null implicitCollections put fieldName collection collection add value return implicitCollections private Class determineWhichClassDefinesField HierarchicalStreamReader reader String definedIn reader getAttribute mapper aliasForAttribute defined in return definedIn null null mapper realClass definedIn protected Object instantiateNewInstance HierarchicalStreamReader reader UnmarshallingContext context String readResolveValue reader getAttribute mapper aliasForAttribute resolves to Class type readResolveValue null mapper realClass readResolveValue context getRequiredType Object currentObject context currentObject if currentObject null if type isInstance currentObject return currentObject return reflectionProvider newInstance type private static class SeenFields private Set seen new HashSet public void add Class definedInCls String fieldName String uniqueKey fieldName if definedInCls null uniqueKey definedInCls getName if seen contains uniqueKey throw new DuplicateFieldException uniqueKey else seen add uniqueKey private Class determineType HierarchicalStreamReader reader boolean validField Object result String fieldName Class definedInCls String classAttribute reader getAttribute mapper aliasForAttribute class Class fieldType reflectionProvider getFieldType result fieldName definedInCls if classAttribute null Class specifiedType mapper realClass classAttribute if fieldType isAssignableFrom specifiedType make sure that the specified type in XML is compatible with the field type this allows the code to evolve in more flexible way return specifiedType if validField Class itemType mapper getItemTypeForItemFieldName result getClass fieldName if itemType null return itemType else return mapper realClass reader getNodeName else return mapper defaultImplementationOf fieldType private Object readResolve serializationMethodInvoker new SerializationMethodInvoker return this public static class DuplicateFieldException extends ConversionException public DuplicateFieldException String msg super msg add duplicate field msg private static final Logger LOGGER Logger getLogger RobustReflectionConverter class getNamepackage jenkins security import org jenkinsci remoting Role public class Roles public static final Role MASTER new Role master public static final Role SLAVE new Role slave private Rolespackage hudson model import hudson ExtensionPoint import hudson Extension public interface RootAction extends Action ExtensionPointpackage com twitter sdk android tweetcomposer import android graphics Bitmap import android graphics BitmapShader import android graphics Canvas import android graphics Paint import android graphics Path import android graphics RectF import android graphics Shader import com squareup picasso Transformation import java util Arrays import static android graphics Bitmap createBitmap class RoundedCornerTransformation implements Transformation final float radii RoundedCornerTransformation float radii this radii radii Override public Bitmap transform Bitmap source final RectF rect new RectF 0 0 source getWidth source getHeight final Bitmap result createBitmap source getWidth source getHeight source getConfig final BitmapShader bitmapShader new BitmapShader source Shader TileMode CLAMP Shader TileMode CLAMP final Paint paint new Paint paint setAntiAlias true paint setShader bitmapShader final Path path new Path path addRoundRect rect radii Path Direction CCW final Canvas canvas new Canvas result canvas drawPath path paint source recycle return result Override public String key return RoundedCornerTransformation Arrays toString radii public static class Builder int topLeftRadius int topRightRadius int bottomRightRadius int bottomLeftRadius public Builder setRadius int radius topLeftRadius radius topRightRadius radius bottomRightRadius radius bottomLeftRadius radius return this public Builder setRadii int topLeftRadius int topRightRadius int bottomRightRadius int bottomLeftRadius this topLeftRadius topLeftRadius this topRightRadius topRightRadius this bottomRightRadius bottomRightRadius this bottomLeftRadius bottomLeftRadius return this RoundedCornerTransformation build if topLeftRadius 0 topRightRadius 0 bottomRightRadius 0 bottomLeftRadius 0 throw new IllegalStateException Radius must not be negative final float radii topLeftRadius topLeftRadius topRightRadius topRightRadius bottomRightRadius bottomRightRadius bottomLeftRadius bottomLeftRadius return new RoundedCornerTransformation radiipackage com twitter sdk android mopub internal import android content Context import android graphics Bitmap import android graphics BitmapShader import android graphics Canvas import android graphics Paint import android graphics Path import android graphics RectF import android graphics Shader import android graphics drawable BitmapDrawable import android util AttributeSet import android widget ImageView import static android graphics Bitmap createBitmap public class RoundedImageView extends ImageView private float roundedCornerRadii public RoundedImageView Context context AttributeSet attrs super context attrs 0 setDefaultCornerRadii public RoundedImageView Context context AttributeSet attrs int styleResId super context attrs styleResId setDefaultCornerRadii private void setDefaultCornerRadii setCornerRadii 0 0 0 0 public void setCornerRadii int topLeftRadius int topRightRadius int bottomLeftRadius int bottomRightRadius if topLeftRadius 0 topRightRadius 0 bottomRightRadius 0 bottomLeftRadius 0 throw new IllegalStateException Radius must not be negative roundedCornerRadii new float topLeftRadius topLeftRadius topRightRadius topRightRadius bottomLeftRadius bottomLeftRadius bottomRightRadius bottomRightRadius Override public void setImageBitmap Bitmap bitmap setImageDrawable new BitmapDrawable getResources transform bitmap private Bitmap transform Bitmap source final RectF rect new RectF 0 0 source getWidth source getHeight final Bitmap result createBitmap source getWidth source getHeight source getConfig final BitmapShader bitmapShader new BitmapShader source Shader TileMode CLAMP Shader TileMode CLAMP final Paint paint new Paint paint setAntiAlias true paint setShader bitmapShader final Path path new Path path addRoundRect rect roundedCornerRadii Path Direction CCW final Canvas canvas new Canvas result canvas drawPath path paint return resultpackage jenkins security import org apache commons codec binary Base64 import java io IOException import java security GeneralSecurityException import java security KeyFactory import java security KeyPair import java security KeyPairGenerator import java security PrivateKey import java security SecureRandom import java security interfaces RSAPrivateCrtKey import java security interfaces RSAPrivateKey import java security interfaces RSAPublicKey import java security spec PKCS8EncodedKeySpec import java security spec RSAPublicKeySpec public abstract class RSAConfidentialKey extends ConfidentialKey private RSAPrivateKey priv private RSAPublicKey pub public RSAConfidentialKey String id super id public RSAConfidentialKey Class owner String shortName this owner getName shortName protected synchronized RSAPrivateKey getPrivateKey try if priv null byte payload load if payload null KeyPairGenerator gen KeyPairGenerator getInstance RSA gen initialize 2048 new SecureRandom going beyond 2048 requires crypto extension KeyPair keys gen generateKeyPair priv RSAPrivateKey keys getPrivate pub RSAPublicKey keys getPublic store priv getEncoded else KeyFactory keyFactory KeyFactory getInstance RSA priv RSAPrivateKey keyFactory generatePrivate new PKCS8EncodedKeySpec payload RSAPrivateCrtKey pks RSAPrivateCrtKey priv pub RSAPublicKey keyFactory generatePublic new RSAPublicKeySpec pks getModulus pks getPublicExponent return priv catch IOException e throw new Error Failed to load the key getId e catch GeneralSecurityException e throw new Error Failed to load the key getId e public RSAPublicKey getPublicKey getPrivateKey return pub public String getEncodedPublicKey return new String Base64 encodeBase64 getPublicKey getEncodedpackage jenkins security import java io UnsupportedEncodingException import java security GeneralSecurityException import java security Signature import java security interfaces RSAPrivateKey public class RSADigitalSignatureConfidentialKey extends RSAConfidentialKey public RSADigitalSignatureConfidentialKey String id super id public RSADigitalSignatureConfidentialKey Class owner String shortName super owner shortName public String sign String msg try RSAPrivateKey key getPrivateKey Signature sig Signature getInstance SIGNING ALGORITHM with key getAlgorithm sig initSign key sig update msg getBytes UTF 8 return hudson remoting Base64 encode sig sign catch GeneralSecurityException e throw new SecurityException e catch UnsupportedEncodingException e throw new AssertionError e UTF 8 is mandatory static final String SIGNING ALGORITHM SHA256package hudson model import hudson FeedAdapter import jenkins model Jenkins import org kohsuke stapler StaplerRequest import org kohsuke stapler StaplerResponse import javax servlet ServletException import javax servlet http HttpServletResponse import java io IOException import java io PrintWriter import java util Collection public final class RSS public static void doTrackback Object it StaplerRequest req StaplerResponse rsp throws IOException ServletException String url req getParameter url rsp setStatus HttpServletResponse SC OK rsp setContentType application xml charset UTF 8 try PrintWriter pw rsp getWriter pw println response pw println error url null 0 1 error if url null pw println message url must be specified message pw println response public static E void forwardToRss String title String url Collection extends E entries FeedAdapter E adapter StaplerRequest req HttpServletResponse rsp throws IOException ServletException req setAttribute adapter adapter req setAttribute title title req setAttribute url url req setAttribute entries entries req setAttribute rootURL Jenkins getInstance getRootUrl String flavor req getParameter flavor if flavor null flavor atom flavor flavor replace Don t allow path to any jelly req getView Jenkins getInstance hudson flavor jelly forward req rsppackage hudson model import com jcraft jzlib GZIPInputStream import com thoughtworks xstream XStream import hudson AbortException import hudson BulkChange import hudson EnvVars import hudson ExtensionList import hudson ExtensionPoint import hudson FeedAdapter import hudson Functions import jenkins util SystemProperties import hudson Util import hudson XmlFile import hudson cli declarative CLIMethod import hudson console import hudson model Descriptor FormException import hudson model Run RunExecution import hudson model listeners RunListener import hudson model listeners SaveableListener import hudson model queue Executables import hudson model queue SubTask import hudson search SearchIndexBuilder import hudson security ACL import hudson security AccessControlled import hudson security Permission import hudson security PermissionGroup import hudson security PermissionScope import hudson tasks BuildWrapper import hudson util FormApply import hudson util LogTaskListener import hudson util ProcessTree import hudson util XStream2 import java io BufferedReader import java io ByteArrayInputStream import java io File import java io FileInputStream import java io FileOutputStream import java io IOException import java io InputStream import java io InputStreamReader import java io OutputStream import java io PrintWriter import java io Reader import java io StringWriter import java nio charset Charset import java text DateFormat import java text SimpleDateFormat import java util ArrayList import java util Arrays import java util Calendar import java util Collections import java util Comparator import java util Date import java util GregorianCalendar import java util HashMap import java util HashSet import java util LinkedHashMap import java util LinkedList import java util List import java util Locale import java util Map import java util Set import java util logging Level import static java util logging Level import java util logging Logger import javax annotation CheckForNull import javax annotation Nonnull import javax servlet ServletException import javax servlet http HttpServletResponse import jenkins model ArtifactManager import jenkins model ArtifactManagerConfiguration import jenkins model ArtifactManagerFactory import jenkins model BuildDiscarder import jenkins model Jenkins import jenkins model JenkinsLocationConfiguration import jenkins model PeepholePermalink import jenkins model RunAction2 import jenkins model StandardArtifactManager import jenkins model lazy BuildReference import jenkins model lazy LazyBuildMixIn import jenkins util VirtualFile import jenkins util io OnMaster import net sf json JSONObject import org acegisecurity AccessDeniedException import org acegisecurity Authentication import org apache commons io IOUtils import org apache commons jelly XMLOutput import org kohsuke accmod Restricted import org kohsuke accmod restrictions NoExternalUse import org kohsuke stapler import org kohsuke stapler export Exported import org kohsuke stapler export ExportedBean import org kohsuke stapler interceptor RequirePOST ExportedBean public abstract class Run JobT extends Job JobT RunT RunT extends Run JobT RunT extends Actionable implements ExtensionPoint Comparable RunT AccessControlled PersistenceRoot DescriptorByNameOwner OnMaster public static final long QUEUE ID UNKNOWN 1 protected transient final Nonnull JobT project public transient int number private long queueId Run QUEUE ID UNKNOWN Restricted NoExternalUse class protected volatile transient RunT previousBuild Restricted NoExternalUse class protected volatile transient RunT nextBuild volatile transient RunT previousBuildInProgress private CheckForNull String id protected long timestamp private long startTime protected volatile Result result protected volatile String description private volatile String displayName private volatile transient State state private static enum State NOT STARTED BUILDING POST PRODUCTION COMPLETED protected long duration protected String charset private boolean keepLog private volatile transient RunExecution runner private CheckForNull ArtifactManager artifactManager protected Run Nonnull JobT job throws IOException this job System currentTimeMillis this number project assignBuildNumber LOGGER log FINER new 0 1 new Object this hashCode protected Run Nonnull JobT job Nonnull Calendar timestamp this job timestamp getTimeInMillis protected Run Nonnull JobT job long timestamp this project job this timestamp timestamp this state State NOT STARTED protected Run Nonnull JobT project Nonnull File buildDir throws IOException this project project this previousBuildInProgress this loaded builds are always completed number Integer parseInt buildDir getName reload public void reload throws IOException this state State COMPLETED TODO ABORTED would perhaps make more sense than FAILURE this result Result FAILURE defensive measure value should be overwritten by unmarshal but just in case the saved data is inconsistent getDataFile unmarshal this load the rest of the data if state State COMPLETED LOGGER log FINER reload 0 1 new Object this hashCode else LOGGER log WARNING reload 0 1 with anomalous state 2 new Object this hashCode state not calling onLoad upon reload partly because we don t want to call that from Run constructor and partly because some existing use of onLoad isn t assuming that it can be invoked multiple times SuppressWarnings deprecation protected void onLoad for Action a getAllActions if a instanceof RunAction2 try RunAction2 a onLoad this catch RuntimeException x LOGGER log WARNING failed to load a from getDataFile x getActions remove a if possible might be in an inconsistent state else if a instanceof RunAction RunAction a onLoad if artifactManager null artifactManager onLoad this Deprecated public List Action getTransientActions List Action actions new ArrayList Action for TransientBuildActionFactory factory TransientBuildActionFactory all for Action created factory createFor this if created null LOGGER log WARNING null action added by 0 factory continue actions add created return Collections unmodifiableList actions SuppressWarnings deprecation Override public void addAction Nonnull Action a super addAction a if a instanceof RunAction2 RunAction2 a onAttached this else if a instanceof RunAction RunAction a onAttached this SuppressWarnings unchecked protected Nonnull RunT this return RunT this public int compareTo Nonnull RunT that return this number that number Exported public long getQueueId return queueId Restricted NoExternalUse class public void setQueueId long queueId this queueId queueId Exported public CheckForNull Result getResult return result public void setResult Nonnull Result r if state State BUILDING throw new IllegalStateException cannot change build result while in state result can only get worse if result null r isWorseThan result result r LOGGER log FINE this in getRootDir result is set to r LOGGER isLoggable Level FINER new Exception null public Nonnull List BuildBadgeAction getBadgeActions List BuildBadgeAction r getActions BuildBadgeAction class if isKeepLog r add new KeepLogBuildBadge return r Exported public boolean isBuilding return state compareTo State POST PRODUCTION 0 protected boolean isInProgress return state equals State BUILDING state equals State POST PRODUCTION public boolean isLogUpdated return state compareTo State COMPLETED 0 Exported public CheckForNull Executor getExecutor return this instanceof Queue Executable Executor of Queue Executable this null public CheckForNull Executor getOneOffExecutor for Computer c Jenkins getInstance getComputers for Executor e c getOneOffExecutors if e getCurrentExecutable this return e return null public final Nonnull Charset getCharset if charset null return Charset defaultCharset return Charset forName charset public Nonnull List Cause getCauses CauseAction a getAction CauseAction class if a null return Collections emptyList return Collections unmodifiableList a getCauses public CheckForNull T extends Cause T getCause Class T type for Cause c getCauses if type isInstance c return type cast c return null Exported public final boolean isKeepLog return getWhyKeepLog null public CheckForNull String getWhyKeepLog if keepLog return Messages Run MarkedExplicitly return null not marked at all public Nonnull JobT getParent return project Exported public Nonnull Calendar getTimestamp GregorianCalendar c new GregorianCalendar c setTimeInMillis timestamp return c public final Nonnull Date getTime return new Date timestamp public final long getTimeInMillis return timestamp public final long getStartTimeInMillis if startTime 0 return timestamp fallback approximate by the queuing time return startTime Exported public String getDescription return description public Nonnull String getTruncatedDescription final int maxDescrLength 100 if description null description length maxDescrLength return description final String ending final int sz description length maxTruncLength maxDescrLength ending length boolean inTag false int displayChars 0 int lastTruncatablePoint 1 for int i 0 i sz i char ch description charAt i if ch inTag true else if ch inTag false if displayChars maxTruncLength lastTruncatablePoint i 1 if inTag displayChars if displayChars maxTruncLength ch lastTruncatablePoint i String truncDesc description Could not find a preferred truncable index force a trunc at maxTruncLength if lastTruncatablePoint 1 lastTruncatablePoint maxTruncLength if displayChars maxDescrLength truncDesc truncDesc substring 0 lastTruncatablePoint ending return truncDesc public Nonnull String getTimestampString long duration new GregorianCalendar getTimeInMillis timestamp return Util getPastTimeString duration public Nonnull String getTimestampString2 return Util XS DATETIME FORMATTER format new Date timestamp public Nonnull String getDurationString if hasntStartedYet return Messages Run NotStartedYet else if isBuilding return Messages Run InProgressDuration Util getTimeSpanString System currentTimeMillis startTime return Util getTimeSpanString duration Exported public long getDuration return duration public Nonnull BallColor getIconColor if isBuilding already built return getResult color a new build is in progress BallColor baseColor RunT pb getPreviousBuild if pb null baseColor BallColor NOTBUILT else baseColor pb getIconColor return baseColor anime public boolean hasntStartedYet return state State NOT STARTED Override public String toString return project getFullName number Exported public String getFullDisplayName return project getFullDisplayName getDisplayName Exported public String getDisplayName return displayName null displayName number public boolean hasCustomDisplayName return displayName null public void setDisplayName String value throws IOException checkPermission UPDATE this displayName value save Exported visibility 2 public int getNumber return number protected Nonnull BuildReference RunT createReference return new BuildReference RunT getId this protected void dropLinks if nextBuild null nextBuild previousBuild previousBuild if previousBuild null previousBuild nextBuild nextBuild public CheckForNull RunT getPreviousBuild return previousBuild public final CheckForNull RunT getPreviousCompletedBuild RunT r getPreviousBuild while r null r isBuilding r r getPreviousBuild return r public final CheckForNull RunT getPreviousBuildInProgress if previousBuildInProgress this return null the most common case List RunT fixUp new ArrayList RunT RunT r this r is the source of the pointer so that we can add it to fix up if we find that the target of the pointer is inefficient RunT answer while true RunT n r previousBuildInProgress if n null no field computed yet n r getPreviousBuild fixUp add r if r n n null this indicates that we know there s no build in progress beyond this point answer null break if n isBuilding we now know n is the target we wanted answer n break fixUp add r r contains the stale previousBuildInProgress back pointer r n fix up so that the next look up will run faster for RunT f fixUp f previousBuildInProgress answer null f answer return answer public CheckForNull RunT getPreviousBuiltBuild RunT r getPreviousBuild in certain situations aborted m2 builds r getResult can still be null although it should theoretically never happen while r null r getResult null r getResult Result NOT BUILT r r getPreviousBuild return r public CheckForNull RunT getPreviousNotFailedBuild RunT r getPreviousBuild while r null r getResult Result FAILURE r r getPreviousBuild return r public CheckForNull RunT getPreviousFailedBuild RunT r getPreviousBuild while r null r getResult Result FAILURE r r getPreviousBuild return r public CheckForNull RunT getPreviousSuccessfulBuild RunT r getPreviousBuild while r null r getResult Result SUCCESS r r getPreviousBuild return r public Nonnull List RunT getPreviousBuildsOverThreshold int numberOfBuilds Nonnull Result threshold List RunT builds new ArrayList RunT numberOfBuilds RunT r getPreviousBuild while r null builds size numberOfBuilds if r isBuilding r getResult null r getResult isBetterOrEqualTo threshold builds add r r r getPreviousBuild return builds public CheckForNull RunT getNextBuild return nextBuild I really messed this up I m hoping to fix this some time it shouldn t have trailing and instead it should have leading public Nonnull String getUrl RUN may be accessed using permalinks as lastSuccessful or other so try to retrieve this base URL looking for this in the current request ancestors see also link AbstractItem getUrl StaplerRequest req Stapler getCurrentRequest if req null String seed Functions getNearestAncestorUrl req this if seed null trim off the context path portion and leading but add trailing return seed substring req getContextPath length 1 return project getUrl getNumber Exported visibility 2 name url Deprecated public final Nonnull String getAbsoluteUrl return project getAbsoluteUrl getNumber public final Nonnull String getSearchUrl return getNumber Exported public Nonnull String getId return id null id Integer toString number Override public CheckForNull Descriptor getDescriptorByName String className return Jenkins getInstance getDescriptorByName className Override public Nonnull File getRootDir return new File project getBuildDir Integer toString number public final Nonnull ArtifactManager getArtifactManager return artifactManager null artifactManager new StandardArtifactManager this public final synchronized Nonnull ArtifactManager pickArtifactManager throws IOException if artifactManager null return artifactManager else for ArtifactManagerFactory f ArtifactManagerConfiguration get getArtifactManagerFactories ArtifactManager mgr f managerFor this if mgr null artifactManager mgr save return mgr return new StandardArtifactManager this Deprecated public File getArtifactsDir return new File getRootDir archive Exported public Nonnull List Artifact getArtifacts return getArtifactsUpTo Integer MAX VALUE public Nonnull List Artifact getArtifactsUpTo int artifactsNumber ArtifactList r new ArtifactList try addArtifacts getArtifactManager root r null artifactsNumber catch IOException x LOGGER log Level WARNING null x r computeDisplayName return r public boolean getHasArtifacts return getArtifactsUpTo 1 isEmpty private int addArtifacts Nonnull VirtualFile dir Nonnull String path Nonnull String pathHref Nonnull ArtifactList r Nonnull Artifact parent int upTo throws IOException VirtualFile kids dir list Arrays sort kids int n 0 for VirtualFile sub kids String child sub getName String childPath path child String childHref pathHref Util rawEncode child String length sub isFile String valueOf sub length boolean collapsed kids length 1 parent null Artifact a if collapsed Collapse single items into parent node where possible a new Artifact parent getFileName child childPath sub isDirectory null childHref length parent getTreeNodeId r tree put a r tree remove parent else Use null href for a directory a new Artifact child childPath sub isDirectory null childHref length n r idSeq r tree put a parent null parent getTreeNodeId null if sub isDirectory n addArtifacts sub childPath childHref r a upTo n if n upTo break else Don t store collapsed path in ArrayList for correct data in external API r add collapsed new Artifact child a relativePath a href length a treeNodeId a if n upTo break return n public static final int LIST CUTOFF Integer parseInt SystemProperties getString hudson model Run ArtifactList listCutoff 16 public static final int TREE CUTOFF Integer parseInt SystemProperties getString hudson model Run ArtifactList treeCutoff 40 and then too many public final class ArtifactList extends ArrayList Artifact private static final long serialVersionUID 1L private LinkedHashMap Artifact String tree new LinkedHashMap Artifact String private int idSeq 0 public Map Artifact String getTree return tree public void computeDisplayName if size LIST CUTOFF return we are not going to display file names so no point in computing this int maxDepth 0 int len new int size String tokens new String size for int i 0 i tokens length i tokens i get i relativePath split maxDepth Math max maxDepth tokens i length len i 1 boolean collision int depth 0 do collision false Map String Integer names new HashMap String Integer for int i 0 i tokens length i String token tokens i String displayName combineLast token len i Integer j names put displayName i if j null collision true if j 0 len j len i names put displayName 1 occupy this name but don t let len i incremented with additional collisions while collision depth maxDepth for int i 0 i tokens length i get i displayPath combineLast tokens i len i OUTER for int n 1 n maxLen n if we just display the last n token would it be suffice for disambiguation Set String names new HashSet String for String token tokens if names add combineLast token n continue OUTER collision Increase n and try again this n successfully diambiguates for int i 0 i tokens length i String token tokens i get i displayPath combineLast token n return it s impossible to get here as that means we have the same artifacts archived twice but be defensive for Artifact a this a displayPath a relativePath private String combineLast String token int n StringBuilder buf new StringBuilder for int i Math max 0 token length n i token length i if buf length 0 buf append buf append token i return buf toString ExportedBean public class Artifact Exported visibility 3 public final String relativePath String displayPath private String name private String href private String treeNodeId private String length Artifact String name String relativePath String href String len String treeNodeId this name name this relativePath relativePath this href href this treeNodeId treeNodeId this length len Deprecated public Nonnull File getFile return new File getArtifactsDir relativePath Exported visibility 3 public String getFileName return name Exported visibility 3 public String getDisplayPath return displayPath public String getHref return href public String getLength return length public long getFileSize return Long decode length public String getTreeNodeId return treeNodeId Override public String toString return relativePath public Nonnull File getLogFile File rawF new File getRootDir log if rawF isFile return rawF File gzF new File getRootDir log gz if gzF isFile return gzF If both fail return the standard uncompressed log file return rawF public Nonnull InputStream getLogInputStream throws IOException File logFile getLogFile if logFile exists Checking if a gz file was return FileInputStream fis new FileInputStream logFile if logFile getName endsWith gz return new GZIPInputStream fis else return fis String message No such file logFile return new ByteArrayInputStream charset null message getBytes charset message getBytes public Nonnull Reader getLogReader throws IOException if charset null return new InputStreamReader getLogInputStream else return new InputStreamReader getLogInputStream charset public void writeLogTo long offset Nonnull XMLOutput out throws IOException try getLogText writeHtmlTo offset out asWriter catch IOException e try to fall back to the old getLogInputStream mainly to support gz compressed files In this case console annotation handling will be turned off InputStream input getLogInputStream try IOUtils copy input out asWriter finally IOUtils closeQuietly input public void writeWholeLogTo Nonnull OutputStream out throws IOException InterruptedException long pos 0 AnnotatedLargeText logText logText getLogText pos logText writeLogTo pos out while logText isComplete Instead of us hitting the log file as many times as possible instead we get the information once every second to avoid CPU usage getting very high Thread sleep 1000 logText getLogText pos logText writeLogTo pos out public Nonnull AnnotatedLargeText getLogText return new AnnotatedLargeText getLogFile getCharset isLogUpdated this Override protected Nonnull SearchIndexBuilder makeSearchIndex SearchIndexBuilder builder super makeSearchIndex add console add changes for Action a getAllActions if a getIconFileName null builder add a getUrlName return builder public Nonnull Api getApi return new Api this Override public void checkPermission Nonnull Permission p getACL checkPermission p Override public boolean hasPermission Nonnull Permission p return getACL hasPermission p Override public ACL getACL for now don t maintain ACL per run and do it at project level return getParent getACL public synchronized void deleteArtifacts throws IOException try getArtifactManager delete catch InterruptedException x throw new IOException x public void delete throws IOException File rootDir getRootDir if rootDir isDirectory throw new IOException this rootDir looks to have already been deleted siblings Arrays toString project getBuildDir list RunListener fireDeleted this synchronized this avoid holding a lock while calling plugin impls of onDeleted File tmp new File rootDir getParentFile rootDir getName if tmp exists Util deleteRecursive tmp TODO on Java 7 prefer Files move rootDir toPath tmp toPath StandardCopyOption ATOMIC MOVE boolean renamingSucceeded rootDir renameTo tmp Util deleteRecursive tmp some user reported that they see some left over xyz files in the workspace so just to make sure we ve really deleted it schedule the deletion on VM exit too if tmp exists tmp deleteOnExit if renamingSucceeded throw new IOException rootDir is in use LOGGER log FINE 0 1 successfully deleted new Object this rootDir removeRunFromParent SuppressWarnings unchecked seems this is too clever for Java s type system private void removeRunFromParent getParent removeRun RunT this static void reportCheckpoint Nonnull CheckPoint id Run RunExecution exec RunnerStack INSTANCE peek if exec null return exec checkpoints report id static void waitForCheckpoint Nonnull CheckPoint id CheckForNull BuildListener listener CheckForNull String waiter throws InterruptedException while true Run RunExecution exec RunnerStack INSTANCE peek if exec null return Run b exec getBuild getPreviousBuildInProgress if b null return no pending earlier build Run RunExecution runner b runner if runner null polled at the wrong moment try again Thread sleep 0 continue if runner checkpoints waitForCheckPoint id listener waiter return confirmed that the previous build reached the check point the previous build finished without ever reaching the check point try again Deprecated protected abstract class Runner extends RunExecution public abstract class RunExecution private final class CheckpointSet private final Set CheckPoint checkpoints new HashSet CheckPoint private boolean allDone protected synchronized void report Nonnull CheckPoint identifier checkpoints add identifier notifyAll protected synchronized boolean waitForCheckPoint Nonnull CheckPoint identifier CheckForNull BuildListener listener CheckForNull String waiter throws InterruptedException final Thread t Thread currentThread final String oldName t getName t setName oldName waiting for identifier on getFullDisplayName from waiter try boolean first true while allDone checkpoints contains identifier if first listener null waiter null listener getLogger println Messages Run is waiting for a checkpoint on waiter getFullDisplayName wait first false return checkpoints contains identifier finally t setName oldName private synchronized void allDone allDone true notifyAll private final CheckpointSet checkpoints new CheckpointSet private final Map Object Object attributes new HashMap Object Object public abstract Nonnull Result run Nonnull BuildListener listener throws Exception RunnerAbortedException public abstract void post Nonnull BuildListener listener throws Exception public abstract void cleanUp Nonnull BuildListener listener throws Exception public Nonnull RunT getBuild return this public Nonnull JobT getProject return this getParent public Nonnull Map Object Object getAttributes return attributes public static final class RunnerAbortedException extends RuntimeException private static final long serialVersionUID 1L Deprecated protected final void run Nonnull Runner job execute job protected final void execute Nonnull RunExecution job if result null return already built StreamBuildListener listener null runner job onStartBuilding try to set the state to COMPLETE in the end even if the thread dies abnormally otherwise the queue state becomes inconsistent long start System currentTimeMillis try try Computer computer Computer currentComputer Charset charset null if computer null charset computer getDefaultCharset this charset charset name listener createBuildListener job listener charset listener started getCauses Authentication auth Jenkins getAuthentication if auth equals ACL SYSTEM String name auth getName if auth equals Jenkins ANONYMOUS name ModelHyperlinkNote encodeTo User get name listener getLogger println Messages Run running as name RunListener fireStarted this listener updateSymlinks listener setResult job run listener LOGGER log INFO 0 main build action completed 1 new Object this result CheckPoint MAIN COMPLETED report catch ThreadDeath t throw t catch AbortException e orderly abortion result Result FAILURE listener error e getMessage LOGGER log FINE Build this aborted e catch RunnerAbortedException e orderly abortion result Result FAILURE LOGGER log FINE Build this aborted e catch InterruptedException e aborted result Executor currentExecutor abortResult listener getLogger println Messages Run BuildAborted Executor currentExecutor recordCauseOfInterruption Run this listener LOGGER log Level INFO this aborted e catch Throwable e handleFatalBuildProblem listener e result Result FAILURE even if the main build fails fatally try to run post build processing job post listener catch ThreadDeath t throw t catch Throwable e handleFatalBuildProblem listener e result Result FAILURE finally long end System currentTimeMillis duration Math max end start 0 see HUDSON 5844 advance the state the significance of doing this is that Jenkins will now see this build as completed things like triggering other builds requires this as pre condition see issue 980 LOGGER log FINER moving into POST PRODUCTION on 0 this state State POST PRODUCTION if listener null RunListener fireCompleted this listener try job cleanUp listener catch Exception e handleFatalBuildProblem listener e too late to update the result now listener finished result listener closeQuietly try save catch IOException e LOGGER log Level SEVERE Failed to save build record e try getParent logRotate catch Exception e LOGGER log Level SEVERE Failed to rotate log e finally onEndBuilding private StreamBuildListener createBuildListener Nonnull RunExecution job StreamBuildListener listener Charset charset throws IOException InterruptedException don t do buffering so that what s written to the listener gets reflected to the file immediately which can then be served to the browser immediately OutputStream logger new FileOutputStream getLogFile true RunT build job getBuild Global log filters for ConsoleLogFilter filter ConsoleLogFilter all logger filter decorateLogger build logger Project specific log filters if project instanceof BuildableItemWithBuildWrappers build instanceof AbstractBuild BuildableItemWithBuildWrappers biwbw BuildableItemWithBuildWrappers project for BuildWrapper bw biwbw getBuildWrappersList logger bw decorateLogger AbstractBuild build logger listener new StreamBuildListener logger charset return listener public final void updateSymlinks Nonnull TaskListener listener throws InterruptedException createSymlink listener lastSuccessful PermalinkProjectAction Permalink LAST SUCCESSFUL BUILD createSymlink listener lastStable PermalinkProjectAction Permalink LAST STABLE BUILD private void createSymlink Nonnull TaskListener listener Nonnull String name Nonnull PermalinkProjectAction Permalink target throws InterruptedException File buildDir getParent getBuildDir File rootDir getParent getRootDir String targetDir if buildDir equals new File rootDir builds targetDir builds File separator target getId else targetDir buildDir File separator target getId Util createSymlink rootDir targetDir name listener private void handleFatalBuildProblem Nonnull BuildListener listener Nonnull Throwable e if listener null LOGGER log FINE getDisplayName failed to build e if e instanceof IOException Util displayIOException IOException e listener e printStackTrace listener fatalError e getMessage else LOGGER log SEVERE getDisplayName failed to build and we don t even have a listener e protected void onStartBuilding LOGGER log FINER moving to BUILDING on 0 this state State BUILDING startTime System currentTimeMillis if runner null RunnerStack INSTANCE push runner RunListener fireInitialize this protected void onEndBuilding signal that we ve finished building state State COMPLETED LOGGER log FINER moving to COMPLETED on 0 this if runner null MavenBuilds may be created without their corresponding runners runner checkpoints allDone runner null RunnerStack INSTANCE pop if result null result Result FAILURE LOGGER log WARNING 0 No build result is set so marking as failure This should not happen this RunListener fireFinalized this public synchronized void save throws IOException if BulkChange contains this return getDataFile write this SaveableListener fireOnChange this getDataFile private Nonnull XmlFile getDataFile return new XmlFile XSTREAM new File getRootDir build xml Deprecated public Nonnull String getLog throws IOException return Util loadFile getLogFile getCharset public Nonnull List String getLog int maxLines throws IOException int lineCount 0 List String logLines new LinkedList String if maxLines 0 return logLines try BufferedReader reader new BufferedReader new InputStreamReader new FileInputStream getLogFile getCharset for String line reader readLine line null line reader readLine logLines add line lineCount If we have too many lines remove the oldest line This way we never have to hold the full contents of a huge log file in memory Adding to and removing from the ends of a linked list are cheap operations if lineCount maxLines logLines remove 0 If the log has been truncated include that information Use set replaces the first element rather than add so that the list doesn t grow beyond the specified maximum number of lines if lineCount maxLines logLines set 0 truncated lineCount maxLines 1 lines return ConsoleNote removeNotes logLines public void doBuildStatus StaplerRequest req StaplerResponse rsp throws IOException rsp sendRedirect2 req getContextPath images 48x48 getBuildStatusUrl public Nonnull String getBuildStatusUrl return getIconColor getImage public String getBuildStatusIconClassName return getIconColor getIconClassName public static class Summary public boolean isWorse public String message public Summary boolean worse String message this isWorse worse this message message public static abstract class StatusSummarizer implements ExtensionPoint public abstract CheckForNull Summary summarize Nonnull Run run Nonnull ResultTrend trend public Nonnull Summary getBuildStatusSummary if isBuilding return new Summary false Messages Run Summary Unknown ResultTrend trend ResultTrend getResultTrend this for StatusSummarizer summarizer ExtensionList lookup StatusSummarizer class Summary summary summarizer summarize this trend if summary null return summary switch trend case ABORTED return new Summary false Messages Run Summary Aborted case NOT BUILT return new Summary false Messages Run Summary NotBuilt case FAILURE return new Summary true Messages Run Summary BrokenSinceThisBuild case STILL FAILING RunT since getPreviousNotFailedBuild if since null return new Summary false Messages Run Summary BrokenForALongTime RunT failedBuild since getNextBuild return new Summary false Messages Run Summary BrokenSince failedBuild getDisplayName case NOW UNSTABLE case STILL UNSTABLE return new Summary false Messages Run Summary Unstable case UNSTABLE return new Summary true Messages Run Summary Unstable case SUCCESS return new Summary false Messages Run Summary Stable case FIXED return new Summary false Messages Run Summary BackToNormal return new Summary false Messages Run Summary Unknown public Nonnull DirectoryBrowserSupport doArtifact if Functions isArtifactsPermissionEnabled checkPermission ARTIFACTS return new DirectoryBrowserSupport this getArtifactManager root Messages Run ArtifactsBrowserTitle project getDisplayName getDisplayName package png true public void doBuildNumber StaplerResponse rsp throws IOException rsp setContentType text plain rsp setCharacterEncoding US ASCII rsp setStatus HttpServletResponse SC OK rsp getWriter print number public void doBuildTimestamp StaplerRequest req StaplerResponse rsp QueryParameter String format throws IOException rsp setContentType text plain rsp setCharacterEncoding US ASCII rsp setStatus HttpServletResponse SC OK DateFormat df format null DateFormat getDateTimeInstance DateFormat SHORT DateFormat SHORT Locale ENGLISH new SimpleDateFormat format req getLocale rsp getWriter print df format getTime public void doConsoleText StaplerRequest req StaplerResponse rsp throws IOException rsp setContentType text plain charset UTF 8 PlainTextConsoleOutputStream out new PlainTextConsoleOutputStream rsp getCompressedOutputStream req InputStream input getLogInputStream try IOUtils copy input out out flush finally IOUtils closeQuietly input IOUtils closeQuietly out Deprecated public void doProgressiveLog StaplerRequest req StaplerResponse rsp throws IOException getLogText doProgressText req rsp public boolean canToggleLogKeep if keepLog isKeepLog Definitely prevented return false TODO may be that keepLog is on perhaps toggler earlier yet isKeepLog would be true anyway In such a case this will incorrectly return true and logKeep jelly will allow the toggle However at least then after redirecting to the same page the toggle button will correctly disappear return true public void doToggleLogKeep StaplerRequest req StaplerResponse rsp throws IOException ServletException keepLog keepLog rsp forwardToPreviousPage req CLIMethod name keep build public final void keepLog throws IOException keepLog true public void keepLog boolean newValue throws IOException checkPermission newValue UPDATE DELETE keepLog newValue save RequirePOST public void doDoDelete StaplerRequest req StaplerResponse rsp throws IOException ServletException checkPermission DELETE We should not simply delete the build if it has been explicitly marked to be preserved or if the build should not be deleted due to dependencies String why getWhyKeepLog if why null sendError Messages Run UnableToDelete getFullDisplayName why req rsp return try delete catch IOException ex StringWriter writer new StringWriter ex printStackTrace new PrintWriter writer req setAttribute stackTraces writer req getView this delete retry jelly forward req rsp return rsp sendRedirect2 req getContextPath getParent getUrl public void setDescription String description throws IOException checkPermission UPDATE this description description save public synchronized void doSubmitDescription StaplerRequest req StaplerResponse rsp throws IOException ServletException setDescription req getParameter description rsp sendRedirect go to the top page Deprecated public Map String String getEnvVars LOGGER log WARNING deprecated call to Run getEnvVars n tat 0 new Throwable getStackTrace 1 try return getEnvironment new LogTaskListener LOGGER Level INFO catch IOException e return new EnvVars catch InterruptedException e return new EnvVars Deprecated public EnvVars getEnvironment throws IOException InterruptedException LOGGER log WARNING deprecated call to Run getEnvironment n tat 0 new Throwable getStackTrace 1 return getEnvironment new LogTaskListener LOGGER Level INFO public Nonnull EnvVars getEnvironment Nonnull TaskListener listener throws IOException InterruptedException Computer c Computer currentComputer Node n c null null c getNode EnvVars env getParent getEnvironment n listener env putAll getCharacteristicEnvVars apply them in a reverse order so that higher ordinal ones can modify values added by lower ordinal ones for EnvironmentContributor ec EnvironmentContributor all reverseView ec buildEnvironmentFor this env listener return env public Nonnull final EnvVars getCharacteristicEnvVars EnvVars env getParent getCharacteristicEnvVars env put BUILD NUMBER String valueOf number env put BUILD ID getId env put BUILD TAG jenkins getParent getFullName replace number return env public Nonnull String getExternalizableId return project getFullName getNumber public CheckForNull static Run fromExternalizableId String id throws IllegalArgumentException int hash id lastIndexOf if hash 0 throw new IllegalArgumentException Invalid id String jobName id substring 0 hash int number try number Integer parseInt id substring hash 1 catch NumberFormatException x throw new IllegalArgumentException x Jenkins j Jenkins getInstance Job job j getItemByFullName jobName Job class if job null return null return job getBuildByNumber number Exported public long getEstimatedDuration return project getEstimatedDuration RequirePOST public Nonnull HttpResponse doConfigSubmit StaplerRequest req throws IOException ServletException FormException checkPermission UPDATE try BulkChange bc new BulkChange this JSONObject json req getSubmittedForm submit json bc commit return FormApply success protected void submit JSONObject json throws IOException setDisplayName Util fixEmptyAndTrim json getString displayName setDescription json getString description public static final XStream XSTREAM new XStream2 public static final XStream2 XSTREAM2 XStream2 XSTREAM static XSTREAM alias build FreeStyleBuild class XSTREAM registerConverter Result conv private static final Logger LOGGER Logger getLogger Run class getName public static final Comparator Run ORDER BY DATE new Comparator Run public int compare Nonnull Run lhs Nonnull Run rhs long lt lhs getTimeInMillis long rt rhs getTimeInMillis if lt rt return 1 if lt rt return 1 return 0 public static final FeedAdapter Run FEED ADAPTER new DefaultFeedAdapter public static final FeedAdapter Run FEED ADAPTER LATEST new DefaultFeedAdapter Override public String getEntryID Run e can t use a meaningful year field unless we remember when the job was created return tag hudson dev java net 2008 e getParent getAbsoluteUrl public final class KeepLogBuildBadge implements BuildBadgeAction public CheckForNull String getIconFileName return null public CheckForNull String getDisplayName return null public CheckForNull String getUrlName return null public CheckForNull String getWhyKeepLog return Run this getWhyKeepLog public static final PermissionGroup PERMISSIONS new PermissionGroup Run class Messages Run Permissions Title public static final Permission DELETE new Permission PERMISSIONS Delete Messages Run DeletePermission Description Permission DELETE PermissionScope RUN public static final Permission UPDATE new Permission PERMISSIONS Update Messages Run UpdatePermission Description Permission UPDATE PermissionScope RUN public static final Permission ARTIFACTS new Permission PERMISSIONS Artifacts Messages Run ArtifactsPermission Description null Functions isArtifactsPermissionEnabled new PermissionScope PermissionScope RUN private static class DefaultFeedAdapter implements FeedAdapter Run public String getEntryTitle Run entry return entry entry getBuildStatusSummary message public String getEntryUrl Run entry return entry getUrl public String getEntryID Run entry return tag hudson dev java net entry getTimestamp get Calendar YEAR entry getParent getFullName entry getId public String getEntryDescription Run entry return entry getDescription public Calendar getEntryTimestamp Run entry return entry getTimestamp public String getEntryAuthor Run entry return JenkinsLocationConfiguration get getAdminAddress Override public Object getDynamic String token StaplerRequest req StaplerResponse rsp Object returnedResult super getDynamic token req rsp if returnedResult null check transient actions too for Action action getTransientActions String urlName action getUrlName if urlName null continue if urlName equals token return action Next Previous Build links on an action page like job Abc 123 testReport will also point to same action job Abc 124 testReport but other builds may not have the action tell browsers to redirect up to the build page returnedResult new RedirectUp return returnedResult public static class RedirectUp public void doDynamic StaplerResponse rsp throws IOException Compromise to handle both browsers auto redirect and programmatic access want accurate 404 response send 404 with javscript to redirect browsers rsp setStatus HttpServletResponse SC NOT FOUND rsp setContentType text html charset UTF 8 PrintWriter out rsp getWriter out println html head meta http equiv refresh content 1 url script window location replace script head body style background color white color white Not found body html out flushpackage hudson model import jenkins model RunAction2 Deprecated public interface RunAction extends Action void onLoad void onAttached Run r void onBuildCompletepackage jenkins model import hudson model Action import hudson model Run public interface RunAction2 extends Action void onAttached Run r void onLoad Run rpackage jenkins model import hudson Extension import hudson Util import hudson model Job import hudson model RootAction import hudson util AtomicFileWriter import hudson util StreamTaskListener import java io File import java io FileNotFoundException import java io IOException import java lang reflect Array import java lang reflect InvocationTargetException import java lang reflect Method import java net URISyntaxException import java net URL import java nio file Files import java text DateFormat import java text ParseException import java text SimpleDateFormat import java util ArrayList import java util Arrays import java util Collections import java util Date import java util HashSet import java util Iterator import java util List import java util Map import java util Set import java util TreeMap import java util logging Logger import java util regex Matcher import java util regex Pattern import javax annotation CheckForNull import javax annotation Nonnull import org apache commons io Charsets import org apache commons io FileUtils import org apache commons lang time FastDateFormat import org apache tools ant BuildException import org kohsuke accmod Restricted import org kohsuke accmod restrictions NoExternalUse import org kohsuke stapler StaplerProxy import org kohsuke stapler framework io WriterOutputStream import static java util logging Level Restricted NoExternalUse class public final class RunIdMigrator private final DateFormat legacyIdFormatter new SimpleDateFormat yyyy MM dd HH mm ss static final Logger LOGGER Logger getLogger RunIdMigrator class getName private static final String MAP FILE legacyIds private static final Map String Integer EMPTY new TreeMap String Integer private static final Set File offeredToUnmigrate Collections synchronizedSet new HashSet File private Nonnull Map String Integer idToNumber EMPTY public RunIdMigrator private boolean load File dir File f new File dir MAP FILE if f isFile return false if f length 0 return true idToNumber new TreeMap String Integer try for String line FileUtils readLines f int i line indexOf idToNumber put line substring 0 i Integer parseInt line substring i 1 catch Exception x IOException IndexOutOfBoundsException NumberFormatException LOGGER log WARNING could not read from f x return true private void save File dir File f new File dir MAP FILE try AtomicFileWriter w new AtomicFileWriter f try for Map Entry String Integer entry idToNumber entrySet w write entry getKey entry getValue n w commit finally w abort catch IOException x LOGGER log WARNING could not save changes to f x public void created File dir save dir public synchronized boolean migrate File dir CheckForNull File jenkinsHome if load dir LOGGER log FINER migration already performed for 0 dir return false if dir isDirectory LOGGER log FINE 0 was unexpectedly missing dir return false LOGGER log INFO Migrating build records in 0 dir doMigrate dir save dir if jenkinsHome null offeredToUnmigrate add jenkinsHome LOGGER log WARNING Build record migration https wiki jenkins ci org display JENKINS JENKINS 24380 Migration is one way If you need to downgrade Jenkins run 0 getUnmigrationCommandLine jenkinsHome return true private static String getUnmigrationCommandLine File jenkinsHome StringBuilder cp new StringBuilder for Class c new Class RunIdMigrator class Charsets class WriterOutputStream class BuildException class FastDateFormat class URL location c getProtectionDomain getCodeSource getLocation String locationS location toString if location getProtocol equals file try locationS new File location toURI getAbsolutePath catch URISyntaxException x never mind if cp length 0 cp append File pathSeparator cp append locationS return String format java classpath s s s cp RunIdMigrator class getName jenkinsHome private static final Pattern NUMBER ELT Pattern compile m number d number r n private void doMigrate File dir idToNumber new TreeMap String Integer File kids dir listFiles Need to process symlinks first so we can rename to them List File kidsList new ArrayList File Arrays asList kids Iterator File it kidsList iterator while it hasNext File kid it next String name kid getName try Integer parseInt name catch NumberFormatException x LOGGER log FINE ignoring nonnumeric entry 0 name continue try if Util isSymlink kid LOGGER log FINE deleting build number symlink 0 1 new Object name Util resolveSymlink kid else if kid isDirectory LOGGER log FINE ignoring build directory 0 name continue else LOGGER log WARNING need to delete anomalous file entry 0 name Util deleteFile kid it remove catch Exception x LOGGER log WARNING failed to process kid x it kidsList iterator while it hasNext File kid it next try String name kid getName try Integer parseInt name LOGGER log FINE skipping new build dir 0 name continue catch NumberFormatException x OK next if kid isDirectory LOGGER log FINE skipping non directory 0 name continue long timestamp try synchronized legacyIdFormatter timestamp legacyIdFormatter parse name getTime catch ParseException x LOGGER log WARNING found unexpected dir 0 name continue File buildXml new File kid build xml if buildXml isFile LOGGER log WARNING found no build xml in 0 name continue String xml FileUtils readFileToString buildXml Charsets UTF 8 Matcher m NUMBER ELT matcher xml if m find LOGGER log WARNING could not find number in 0 build xml name continue int number Integer parseInt m group 1 String nl m group 2 xml m replaceFirst id name id nl timestamp timestamp timestamp nl File newKid new File dir Integer toString number move kid newKid FileUtils writeStringToFile new File newKid build xml xml Charsets UTF 8 LOGGER log FINE fully processed 0 1 new Object name number idToNumber put name number catch Exception x LOGGER log WARNING failed to process kid x static void move File src File dest throws IOException try Files move src toPath dest toPath catch IOException x throw x catch Exception x throw new IOException x public synchronized int findNumber Nonnull String id Integer number idToNumber get id return number null number 0 public synchronized void delete File dir String id if idToNumber remove id null save dir public static void main String args throws Exception if args length 1 throw new Exception pass one parameter JENKINS HOME File root new File args 0 File jobs new File root jobs if jobs isDirectory throw new FileNotFoundException no such JENKINS HOME root new RunIdMigrator unmigrateJobsDir jobs private void unmigrateJobsDir File jobs throws Exception File jobDirs jobs listFiles if jobDirs null System err println jobs claimed to exist but cannot be listed return for File job jobDirs if job getName equals builds Might be maven modules matrix builds etc which are direct children of job unmigrateBuildsDir job File kids job listFiles if kids null continue for File kid kids if kid isDirectory continue if kid getName equals builds unmigrateBuildsDir kid else Might be jobs modules promotions etc we assume an ItemGroup getRootDirFor implementation returns grandchildren unmigrateJobsDir job call above handles children unmigrateJobsDir kid private static final Pattern ID ELT Pattern compile m id 0 9 id r n private static final Pattern TIMESTAMP ELT Pattern compile m timestamp d timestamp r n private void unmigrateBuildsDir File builds throws Exception File mapFile new File builds MAP FILE if mapFile isFile System err println builds does not look to have been migrated yet skipping return for File build builds listFiles int number try number Integer parseInt build getName catch NumberFormatException x continue File buildXml new File build build xml if buildXml isFile System err println buildXml did not exist continue String xml FileUtils readFileToString buildXml Charsets UTF 8 Matcher m TIMESTAMP ELT matcher xml if m find System err println buildXml did not contain timestamp as expected continue long timestamp Long parseLong m group 1 String nl m group 2 xml m replaceFirst number number number nl m ID ELT matcher xml String id if m find id m group 1 xml m replaceFirst else Post migration build We give it a new ID based on its timestamp id legacyIdFormatter format new Date timestamp FileUtils write buildXml xml Charsets UTF 8 if build renameTo new File builds id System err println build could not be renamed Util createSymlink builds id Integer toString number StreamTaskListener fromStderr Util deleteFile mapFile System err println builds has been restored to its original format Extension public static class UnmigrationInstruction implements RootAction StaplerProxy Override public String getIconFileName return null Override public String getDisplayName return null Override public String getUrlName return JENKINS 24380 Override public Object getTarget Jenkins getInstance checkPermission Jenkins ADMINISTER return this public String getCommand return RunIdMigrator getUnmigrationCommandLine Jenkins getInstance getRootDirpackage hudson util import com google common base Predicate import com google common collect Iterables import com google common collect Iterators import hudson model AbstractBuild import hudson model Job import hudson model Node import hudson model Result import hudson model Run import hudson model TopLevelItem import hudson model View import hudson util Iterators CountingPredicate import java util public class RunList R extends Run extends AbstractList R private Iterable R base private R first private Integer size public RunList base Collections emptyList public RunList Job j base j getBuilds public RunList View view this is a type unsafe operation Set Job jobs new HashSet Job for TopLevelItem item view getItems jobs addAll item getAllJobs List Iterable R runLists new ArrayList Iterable R for Job job jobs runLists add job getBuilds this base combine runLists public RunList Collection extends Job jobs List Iterable R runLists new ArrayList Iterable R for Job j jobs runLists add j getBuilds this base combine runLists private Iterable R combine Iterable Iterable R runLists return Iterables mergeSorted runLists new Comparator R public int compare R o1 R o2 long lhs o1 getTimeInMillis long rhs o2 getTimeInMillis if lhs rhs return 1 if lhs rhs return 1 return 0 private RunList Iterable R c base c Override public Iterator R iterator return base iterator Override Deprecated public int size if size null int sz 0 for R r this first r sz size sz return size Override Deprecated public R get int index return Iterators get iterator index Override public List R subList int fromIndex int toIndex List R r new ArrayList R Iterator R itr iterator Iterators skip itr fromIndex for int i toIndex fromIndex i 0 i r add itr next return r Override public int indexOf Object o int index 0 for R r this if r equals o return index index return 1 Override public int lastIndexOf Object o int a 1 int index 0 for R r this if r equals o a index index return a Override public boolean isEmpty return iterator hasNext Deprecated public R getFirstBuild size return first public R getLastBuild Iterator R itr iterator return itr hasNext itr next null public static R extends Run RunList R fromRuns Collection extends R runs return new RunList R Iterable runs public RunList R filter Predicate R predicate size null first null base Iterables filter base predicate return this private RunList R limit final CountingPredicate R predicate size null first null final Iterable R nested base base new Iterable R public Iterator R iterator return hudson util Iterators limit nested iterator predicate Override public String toString return Iterables toString this return this public RunList R limit final int n return limit new CountingPredicate R public boolean apply int index R input return index n public RunList R failureOnly return filter new Predicate R public boolean apply R r return r getResult Result SUCCESS public RunList R overThresholdOnly final Result threshold return filter new Predicate R public boolean apply R r return r getResult null r getResult isBetterOrEqualTo threshold public RunList R completedOnly return filter new Predicate R public boolean apply R r return r isBuilding public RunList R node final Node node return filter new Predicate R public boolean apply R r return r instanceof AbstractBuild AbstractBuild r getBuiltOn node public RunList R regressionOnly return filter new Predicate R public boolean apply R r return r getBuildStatusSummary isWorse public RunList R byTimestamp final long start final long end return limit new CountingPredicate R public boolean apply int index R r return start r getTimeInMillis filter new Predicate R public boolean apply R r return r getTimeInMillis end public RunList R newBuilds GregorianCalendar cal new GregorianCalendar cal add Calendar DAY OF YEAR 7 final long t cal getTimeInMillis can t publish on going builds return filter new Predicate R public boolean apply R r return r isBuilding put at least 10 builds but otherwise ignore old builds limit new CountingPredicate R public boolean apply int index R r return index 10 r getTimeInMillis tpackage hudson model listeners import hudson ExtensionPoint import hudson ExtensionListView import hudson Extension import hudson ExtensionList import hudson FilePath import hudson Functions import hudson Launcher import hudson model AbstractBuild import hudson model BuildListener import hudson model Environment import hudson model Job import hudson model JobProperty import hudson model Run import hudson model Run RunnerAbortedException import hudson model TaskListener import jenkins model Jenkins import hudson scm SCM import hudson tasks BuildWrapper import hudson util CopyOnWriteList import org jvnet tiger types Types import java io File import java io IOException import java lang reflect ParameterizedType import java lang reflect Type import java util logging Level import java util logging Logger import javax annotation Nonnull public abstract class RunListener R extends Run implements ExtensionPoint public final Class R targetType protected RunListener Class R targetType this targetType targetType protected RunListener Type type Types getBaseClass getClass RunListener class if type instanceof ParameterizedType targetType Types erasure Types getTypeArgument type 0 else throw new IllegalStateException getClass uses the raw type for extending RunListener public void onCompleted R r Nonnull TaskListener listener public void onFinalized R r public void onInitialize R r public void onStarted R r TaskListener listener public Environment setUpEnvironment AbstractBuild build Launcher launcher BuildListener listener throws IOException InterruptedException RunnerAbortedException return new Environment public void onDeleted R r Deprecated public void register all add this public void unregister all remove this Deprecated public static final CopyOnWriteList RunListener LISTENERS ExtensionListView createCopyOnWriteList RunListener class public static void fireCompleted Run r Nonnull TaskListener listener for RunListener l all if l targetType isInstance r try l onCompleted r listener catch Throwable e report e public static void fireInitialize Run r for RunListener l all if l targetType isInstance r try l onInitialize r catch Throwable e report e public static void fireStarted Run r TaskListener listener for RunListener l all if l targetType isInstance r try l onStarted r listener catch Throwable e report e public static void fireFinalized Run r if Jenkins getInstanceOrNull null TODO use Functions isExtensionsAvailable once JENKINS 33377 return for RunListener l all if l targetType isInstance r try l onFinalized r catch Throwable e report e public static void fireDeleted Run r for RunListener l all if l targetType isInstance r try l onDeleted r catch Throwable e report e public static ExtensionList RunListener all return ExtensionList lookup RunListener class private static void report Throwable e LOGGER log Level WARNING RunListener failed e private static final Logger LOGGER Logger getLogger RunListener class getNamepackage jenkins widgets import hudson model Run import hudson util RunList import java util ArrayList import java util List import jenkins util ProgressiveRendering import net sf json JSON import net sf json JSONArray import net sf json JSONObject import org kohsuke accmod Restricted import org kohsuke accmod restrictions NoExternalUse Restricted NoExternalUse class public abstract class RunListProgressiveRendering extends ProgressiveRendering private static final double MAX LIKELY RUNS 20 private final List JSONObject results new ArrayList JSONObject private Iterable extends Run builds public void setBuilds Iterable extends Run builds this builds builds Override protected void compute throws Exception double decay 1 for Run build builds if canceled return JSONObject element new JSONObject calculate build element synchronized this results add element decay 1 1 MAX LIKELY RUNS progress 1 decay Override protected synchronized JSON data JSONArray d JSONArray fromObject results results clear return d protected abstract void calculate Run build JSONObject elementpackage hudson model import java io File import java io IOException import java util Collections import java util Comparator import java util Iterator import java util Map import java util NoSuchElementException import java util SortedMap import java util logging Level import static java util logging Level import java util logging Logger import jenkins model RunIdMigrator import jenkins model lazy AbstractLazyLoadRunMap import static jenkins model lazy AbstractLazyLoadRunMap Direction import jenkins model lazy BuildReference import org apache commons collections comparators ReverseComparator import org kohsuke accmod Restricted import org kohsuke accmod restrictions NoExternalUse public final class RunMap R extends Run R extends AbstractLazyLoadRunMap R implements Iterable R private final SortedMap Integer R view Collections unmodifiableSortedMap this private Constructor R cons Restricted NoExternalUse class public RunIdMigrator runIdMigrator new RunIdMigrator TODO before first complete build patch up next previous build link Deprecated public RunMap super null will be set later public RunMap File baseDir Constructor cons super baseDir this cons cons public boolean remove R run return removeValue run public Iterator R iterator return new Iterator R R last null R next newestBuild public boolean hasNext return next null public R next last next if last null next last getPreviousBuild else throw new NoSuchElementException return last public void remove if last null throw new UnsupportedOperationException removeValue last Override public boolean removeValue R run run dropLinks runIdMigrator delete dir run getId return super removeValue run public SortedMap Integer R getView return view public R newestValue return search Integer MAX VALUE DESC public R oldestValue return search Integer MIN VALUE ASC Deprecated public static final Comparator Comparable COMPARATOR new Comparator Comparable public int compare Comparable o1 Comparable o2 return o1 compareTo o2 public interface Constructor R extends Run R R create File dir throws IOException Override protected final int getNumberOf R r return r getNumber Override protected final String getIdOf R r return r getId Override public R put R r Defense against JENKINS 23152 and its ilk File rootDir r getRootDir if rootDir isDirectory throw new IllegalStateException JENKINS 23152 rootDir already existed will not overwrite with r if r getClass getName equals hudson matrix MatrixRun JENKINS 26739 grandfathered in proposeNewNumber r getNumber rootDir mkdirs return super put r Override public R getById String id int n try n Integer parseInt id catch NumberFormatException x n runIdMigrator findNumber id return getByNumber n Override protected BuildReference R createReference R r return r createReference Override protected R retrieve File d throws IOException if new File d build xml exists if the build result file isn t in the directory ignore it try R b cons create d b onLoad if LOGGER isLoggable FINEST LOGGER log FINEST Loaded b getFullDisplayName in Thread currentThread getName new ThisIsHowItsLoaded return b catch IOException e LOGGER log Level WARNING could not load d e catch InstantiationError e LOGGER log Level WARNING could not load d e catch Exception e LOGGER log Level WARNING could not load d e return null Deprecated public void load Job job Constructor R cons this cons cons initBaseDir job getBuildDir private static final Logger LOGGER Logger getLogger RunMap class getName private static class ThisIsHowItsLoaded extends Exceptionpackage hudson model import hudson model Run RunExecution import java util Stack import java util Map import java util WeakHashMap import javax annotation CheckForNull final class RunnerStack private final Map Executor Stack RunExecution stack new WeakHashMap Executor Stack RunExecution synchronized void push RunExecution r Executor e Executor currentExecutor Stack RunExecution s stack get e if s null stack put e s new Stack RunExecution s push r synchronized void pop Executor e Executor currentExecutor Stack RunExecution s stack get e s pop if s isEmpty stack remove e synchronized CheckForNull RunExecution peek Executor e Executor currentExecutor if e null Stack RunExecution s stack get e if s null s isEmpty return s peek return null static final RunnerStack INSTANCE new RunnerStackpackage hudson model import jenkins model Jenkins import net sf json JSONObject import org jenkinsci Symbol import org kohsuke stapler DataBoundConstructor import org kohsuke stapler StaplerRequest import org kohsuke stapler export Exported import hudson Extension import hudson util EnumConverter import hudson util RunList import org kohsuke stapler Stapler import org kohsuke stapler QueryParameter public class RunParameterDefinition extends SimpleParameterDefinition public enum RunParameterFilter ALL STABLE SUCCESSFUL COMPLETED public String getName return name static Stapler CONVERT UTILS register new EnumConverter RunParameterFilter class private final String projectName private final String runId private final RunParameterFilter filter DataBoundConstructor public RunParameterDefinition String name String projectName String description RunParameterFilter filter super name description this projectName projectName this runId null this filter filter Deprecated public RunParameterDefinition String name String projectName String description delegate to updated constructor with additional RunParameterFilter parameter defaulted to ALL this name projectName description RunParameterFilter ALL private RunParameterDefinition String name String projectName String runId String description RunParameterFilter filter super name description this projectName projectName this runId runId this filter filter Override public ParameterDefinition copyWithDefaultValue ParameterValue defaultValue if defaultValue instanceof RunParameterValue RunParameterValue value RunParameterValue defaultValue return new RunParameterDefinition getName value getRunId getDescription getFilter else return this Exported public String getProjectName return projectName public Job getProject return Jenkins getInstance getItemByFullName projectName Job class public RunParameterFilter getFilter if filter is null default to RunParameterFilter ALL return null filter RunParameterFilter ALL filter public RunList getBuilds use getFilter method so we dont have to worry about null filter value switch getFilter case COMPLETED return getProject getBuilds overThresholdOnly Result ABORTED completedOnly case SUCCESSFUL return getProject getBuilds overThresholdOnly Result UNSTABLE completedOnly case STABLE return getProject getBuilds overThresholdOnly Result SUCCESS completedOnly default return getProject getBuilds Extension Symbol run runParam public static class DescriptorImpl extends ParameterDescriptor Override public String getDisplayName return Messages RunParameterDefinition DisplayName Override public String getHelpFile return help parameter run html Override public ParameterDefinition newInstance StaplerRequest req JSONObject formData throws FormException return req bindJSON RunParameterDefinition class formData public AutoCompletionCandidates doAutoCompleteProjectName QueryParameter String value return AutoCompletionCandidates ofJobNames Job class value null Jenkins getInstance Override public ParameterValue getDefaultParameterValue if runId null return createValue runId Run lastBuild null use getFilter so we dont have to worry about null filter value switch getFilter case COMPLETED lastBuild getProject getLastCompletedBuild break case SUCCESSFUL lastBuild getProject getLastSuccessfulBuild break case STABLE lastBuild getProject getLastStableBuild break default lastBuild getProject getLastBuild break if lastBuild null return createValue lastBuild getExternalizableId else return null Override public ParameterValue createValue StaplerRequest req JSONObject jo RunParameterValue value req bindJSON RunParameterValue class jo value setDescription getDescription return value public RunParameterValue createValue String value return new RunParameterValue getName value getDescriptionpackage hudson model import hudson EnvVars import jenkins model Jenkins import org kohsuke stapler DataBoundConstructor import org kohsuke stapler export Exported import javax annotation CheckForNull import java util Locale public class RunParameterValue extends ParameterValue private final String runId DataBoundConstructor public RunParameterValue String name String runId String description super name description this runId check runId public RunParameterValue String name String runId super name null this runId check runId private static String check String runId if runId null runId indexOf 1 throw new IllegalArgumentException runId else return runId public CheckForNull Run getRun return Run fromExternalizableId runId public String getRunId return runId private String split if runId null return null String r runId split if r length 2 return null return r Exported public String getJobName String r split return r null null r 0 Exported public String getNumber String r split return r null null r 1 Override public Run getValue return getRun Override public void buildEnvironment Run build EnvVars env Run run getRun String value null run UNKNOWN Jenkins getInstance getRootUrl run getUrl env put name value env put name jobName getJobName undocumented left for backward compatibility env put name JOBNAME getJobName prefer this version env put name number getNumber same as above env put name NUMBER getNumber if run is null default to the standard 1 display name format env put name NAME null run getNumber run getDisplayName since 1 504 String buildResult null run null run getResult UNKNOWN run getResult toString env put name RESULT buildResult since 1 517 env put name toUpperCase Locale ENGLISH value backward compatibility pre 1 345 Override public String toString return RunParameterValue getName getRunId Override public String getShortDescription Run run getRun return name null run getJobName getNumber run getFullDisplayNamepackage hudson util spring import org springframework beans factory config BeanDefinition import org springframework beans factory config BeanFactoryPostProcessor import org springframework beans factory support AbstractBeanDefinition import org springframework context support StaticApplicationContext import org springframework web context ServletContextAware import org springframework web context WebApplicationContext import javax servlet ServletContext import java util Collection import java util List interface RuntimeSpringConfiguration extends ServletContextAware BeanConfiguration addSingletonBean String name Class clazz WebApplicationContext getUnrefreshedApplicationContext BeanConfiguration addPrototypeBean String name Class clazz WebApplicationContext getApplicationContext BeanConfiguration addSingletonBean String name BeanConfiguration addPrototypeBean String name BeanConfiguration createSingletonBean Class clazz BeanConfiguration addSingletonBean String name Class clazz Collection args BeanConfiguration createSingletonBean Class clazz Collection constructorArguments void setServletContext ServletContext context BeanConfiguration createPrototypeBean String name BeanConfiguration createSingletonBean String name void addBeanConfiguration String beanName BeanConfiguration beanConfiguration void addBeanDefinition String name BeanDefinition bd boolean containsBean String name BeanConfiguration getBeanConfig String name AbstractBeanDefinition createBeanDefinition String name void registerPostProcessor BeanFactoryPostProcessor processor List String getBeanNames void registerBeansWithContext StaticApplicationContext applicationContext BeanConfiguration addAbstractBean String namepackage com kaku colorfulnews utils import rx Observable import rx subjects PublishSubject import rx subjects SerializedSubject import rx subjects Subject public class RxBus private static volatile RxBus sRxBus private final Subject Object Object mBus PublishSubject Observable public RxBus mBus new SerializedSubject PublishSubject create RxBus public static RxBus getInstance if sRxBus null synchronized RxBus class if sRxBus null sRxBus new RxBus return sRxBus public void post Object o mBus onNext o eventType eventType public T Observable T toObservable Class T eventType return mBus ofType eventType ofType filter cast return mBus filter new Func1 Object Boolean Override public Boolean call Object o return eventType isInstance o cast eventTypepackage com twitter sdk android core models import com google gson Gson import com google gson TypeAdapter import com google gson TypeAdapterFactory import com google gson reflect TypeToken import com google gson stream JsonReader import com google gson stream JsonWriter import java io IOException import java util Collections import java util List public class SafeListAdapter implements TypeAdapterFactory Override public T TypeAdapter T create final Gson gson final TypeToken T tokenType final TypeAdapter T delegate gson getDelegateAdapter this tokenType return new TypeAdapter T Override public void write JsonWriter out T value throws IOException delegate write out value Override public T read JsonReader arg0 throws IOException final T t delegate read arg0 if List class isAssignableFrom tokenType getRawType if t null return T Collections EMPTY LIST final List list List t return T Collections unmodifiableList list return tpackage com twitter sdk android core models import com google gson Gson import com google gson TypeAdapter import com google gson TypeAdapterFactory import com google gson reflect TypeToken import com google gson stream JsonReader import com google gson stream JsonWriter import java io IOException import java util Collections import java util Map public class SafeMapAdapter implements TypeAdapterFactory Override public T TypeAdapter T create final Gson gson final TypeToken T tokenType final TypeAdapter T delegate gson getDelegateAdapter this tokenType return new TypeAdapter T Override public void write JsonWriter out T value throws IOException delegate write out value Override public T read JsonReader arg0 throws IOException final T t delegate read arg0 if Map class isAssignableFrom tokenType getRawType if t null return T Collections EMPTY MAP final Map map Map t return T Collections unmodifiableMap map return tpackage hudson triggers import hudson model AperiodicWork import hudson model PeriodicWork import hudson security ACL import java util TimerTask import java util logging Level import java util logging Logger import org acegisecurity context SecurityContext import org acegisecurity context SecurityContextHolder public abstract class SafeTimerTask extends TimerTask public final void run background activity gets system credential just like executors get it SecurityContext oldContext ACL impersonate ACL SYSTEM try doRun catch Throwable t LOGGER log Level SEVERE Timer task this failed t finally SecurityContextHolder setContext oldContext protected abstract void doRun throws Exception private static final Logger LOGGER Logger getLogger SafeTimerTask class getNamepackage hudson model import hudson BulkChange import java io IOException public interface Saveable void save throws IOException Saveable NOOP new Saveable public void save throws IOExceptionpackage hudson model listeners import hudson ExtensionPoint import hudson Extension import hudson ExtensionList import hudson XmlFile import hudson model Saveable import java util logging Level import java util logging Logger public abstract class SaveableListener implements ExtensionPoint public void onChange Saveable o XmlFile file Deprecated public void register all add this public void unregister all remove this public static void fireOnChange Saveable o XmlFile file for SaveableListener l all try l onChange o file catch ThreadDeath t throw t catch Throwable t Logger getLogger SaveableListener class getName log Level WARNING null t public static ExtensionList SaveableListener all return ExtensionList lookup SaveableListener classpackage hudson model queue import hudson model Queue import hudson model Queue Item import hudson model Queue WaitingItem import javax annotation CheckForNull public abstract class ScheduleResult public boolean isCreated return false public boolean isRefused return false public CheckForNull Item getItem return null public CheckForNull WaitingItem getCreateItem return null public final boolean isAccepted return isRefused public static final class Created extends ScheduleResult private final WaitingItem item private Created WaitingItem item this item item Override public boolean isCreated return true Override public WaitingItem getCreateItem return item Override public Item getItem return item public static final class Existing extends ScheduleResult private final Item item private Existing Item item this item item Override public Item getItem return item public static final class Refused extends ScheduleResult Override public boolean isRefused return true public static Created created WaitingItem i return new Created i public static Existing existing Item i return new Existing i public static Refused refused return new Refusedpackage hudson scm import hudson AbortException import hudson DescriptorExtensionList import hudson Extension import hudson ExtensionPoint import hudson FilePath import hudson Launcher import hudson Util import hudson model AbstractBuild import hudson model AbstractProject import hudson model Action import hudson model Api import hudson model BuildListener import hudson model Describable import hudson model Descriptor import hudson model Job import hudson model Node import hudson model Run import hudson model TaskListener import hudson model TopLevelItemDescriptor import hudson model WorkspaceCleanupThread import hudson security Permission import hudson security PermissionGroup import hudson security PermissionScope import hudson tasks Builder import hudson util IOUtils import java io File import java io FileWriter import java io IOException import java util ArrayList import java util List import java util Map import javax annotation CheckForNull import javax annotation Nonnull import javax annotation Nullable import jenkins model Jenkins import jenkins util SystemProperties import org kohsuke stapler export Exported import org kohsuke stapler export ExportedBean ExportedBean public abstract class SCM implements Describable SCM ExtensionPoint SuppressWarnings FieldMayBeFinal private static boolean useAutoBrowserHolder SystemProperties getBoolean SCM class getName useAutoBrowserHolder private transient AutoBrowserHolder autoBrowserHolder public Api getApi return new Api this public CheckForNull RepositoryBrowser getBrowser return null Exported public String getType return getClass getName SuppressWarnings deprecation Exported name browser public final CheckForNull RepositoryBrowser getEffectiveBrowser RepositoryBrowser b getBrowser if b null return b if useAutoBrowserHolder if autoBrowserHolder null autoBrowserHolder new AutoBrowserHolder this return autoBrowserHolder get else return guessBrowser public boolean supportsPolling return true public boolean requiresWorkspaceForPolling return true public boolean processWorkspaceBeforeDeletion Nonnull Job project Nonnull FilePath workspace Nonnull Node node throws IOException InterruptedException if project instanceof AbstractProject return processWorkspaceBeforeDeletion AbstractProject project workspace node else return true Deprecated public boolean processWorkspaceBeforeDeletion AbstractProject project FilePath workspace Node node throws IOException InterruptedException if Util isOverridden SCM class getClass processWorkspaceBeforeDeletion Job class FilePath class Node class return processWorkspaceBeforeDeletion Job project workspace node else return true Deprecated public boolean pollChanges AbstractProject project Launcher launcher FilePath workspace TaskListener listener throws IOException InterruptedException up until 1 336 this method was abstract so everyone should have overridden this method without calling super pollChanges So the compatibility implementation is purely for new implementations that doesn t override this method throw new AbstractMethodError you must override compareRemoteRevisionWith public CheckForNull SCMRevisionState calcRevisionsFromBuild Nonnull Run build Nullable FilePath workspace Nullable Launcher launcher Nonnull TaskListener listener throws IOException InterruptedException if build instanceof AbstractBuild Util isOverridden SCM class getClass calcRevisionsFromBuild AbstractBuild class Launcher class TaskListener class return calcRevisionsFromBuild AbstractBuild build launcher listener else throw new AbstractMethodError you must override the new calcRevisionsFromBuild overload Deprecated public SCMRevisionState calcRevisionsFromBuild AbstractBuild build Launcher launcher TaskListener listener throws IOException InterruptedException return calcRevisionsFromBuild build launcher null build getWorkspace null launcher listener Deprecated public SCMRevisionState calcRevisionsFromBuild AbstractBuild build Launcher launcher TaskListener listener throws IOException InterruptedException return calcRevisionsFromBuild build launcher listener public PollingResult compareRemoteRevisionWith Nonnull Job project Nullable Launcher launcher Nullable FilePath workspace Nonnull TaskListener listener Nonnull SCMRevisionState baseline throws IOException InterruptedException if project instanceof AbstractProject Util isOverridden SCM class getClass compareRemoteRevisionWith AbstractProject class Launcher class FilePath class TaskListener class SCMRevisionState class return compareRemoteRevisionWith AbstractProject project launcher workspace listener baseline else throw new AbstractMethodError you must override the new overload of compareRemoteRevisionWith Deprecated protected PollingResult compareRemoteRevisionWith AbstractProject project Launcher launcher FilePath workspace TaskListener listener SCMRevisionState baseline throws IOException InterruptedException return compareRemoteRevisionWith Job project launcher workspace listener baseline public final PollingResult poll AbstractProject project Launcher launcher FilePath workspace TaskListener listener SCMRevisionState baseline throws IOException InterruptedException if is1 346OrLater This is to work around HUDSON 5827 in a general way don t let the SCM compareRemoteRevisionWith see SCMRevisionState that it didn t produce SCMRevisionState baseline2 if baseline SCMRevisionState NONE baseline2 baseline else baseline2 calcRevisionsFromBuild project getLastBuild launcher listener return compareRemoteRevisionWith project launcher workspace listener baseline2 else return pollChanges project launcher workspace listener PollingResult SIGNIFICANT PollingResult NO CHANGES private boolean is1 346OrLater for Class c getClass c SCM class c c getSuperclass try c getDeclaredMethod compareRemoteRevisionWith AbstractProject class Launcher class FilePath class TaskListener class SCMRevisionState class return true catch NoSuchMethodException e try c getDeclaredMethod compareRemoteRevisionWith Job class Launcher class FilePath class TaskListener class SCMRevisionState class return true catch NoSuchMethodException e2 return false public Nonnull String getKey return getType public void checkout Nonnull Run build Nonnull Launcher launcher Nonnull FilePath workspace Nonnull TaskListener listener CheckForNull File changelogFile CheckForNull SCMRevisionState baseline throws IOException InterruptedException if build instanceof AbstractBuild listener instanceof BuildListener Util isOverridden SCM class getClass checkout AbstractBuild class Launcher class FilePath class BuildListener class File class if changelogFile null changelogFile File createTempFile changelog xml try if checkout AbstractBuild build launcher workspace BuildListener listener changelogFile throw new AbortException finally Util deleteFile changelogFile else if checkout AbstractBuild build launcher workspace BuildListener listener changelogFile throw new AbortException else throw new AbstractMethodError you must override the new overload of checkout Deprecated public boolean checkout AbstractBuild build Launcher launcher FilePath workspace BuildListener listener Nonnull File changelogFile throws IOException InterruptedException AbstractBuild prev build getPreviousBuild checkout Run build launcher workspace listener changelogFile prev null prev getAction SCMRevisionState class null return true public void postCheckout Nonnull Run build Nonnull Launcher launcher Nonnull FilePath workspace Nonnull TaskListener listener throws IOException InterruptedException if build instanceof AbstractBuild listener instanceof BuildListener postCheckout AbstractBuild build launcher workspace BuildListener listener Deprecated public void postCheckout AbstractBuild build Launcher launcher FilePath workspace BuildListener listener throws IOException InterruptedException if Util isOverridden SCM class getClass postCheckout Run class Launcher class FilePath class TaskListener class postCheckout Run build launcher workspace listener TODO is an equivalent for Run needed public void buildEnvVars AbstractBuild build Map String String env default implementation is noop TODO perhaps deprecate all replace with a single getModuleRoots FilePath Run public FilePath getModuleRoot FilePath workspace AbstractBuild build For backwards compatibility call the one argument version of the method return getModuleRoot workspace Deprecated public FilePath getModuleRoot FilePath workspace if Util isOverridden SCM class getClass getModuleRoot FilePath class AbstractBuild class if the subtype already implements newer getModuleRoot FilePath AbstractBuild call that return getModuleRoot workspace null return workspace public FilePath getModuleRoots FilePath workspace AbstractBuild build if Util isOverridden SCM class getClass getModuleRoots FilePath class if the subtype derives legacy getModuleRoots FilePath delegate to it return getModuleRoots workspace otherwise the default implementation return new FilePath getModuleRoot workspace build Deprecated public FilePath getModuleRoots FilePath workspace if Util isOverridden SCM class getClass getModuleRoots FilePath class AbstractBuild class if the subtype already derives newer getModuleRoots FilePath AbstractBuild delegate to it return getModuleRoots workspace null otherwise the default implementation return new FilePath getModuleRoot workspace public abstract ChangeLogParser createChangeLogParser public SCMDescriptor getDescriptor return SCMDescriptor Jenkins getInstance getDescriptorOrDie getClass convenience methods Deprecated protected final boolean createEmptyChangeLog File changelogFile BuildListener listener String rootTag try createEmptyChangeLog changelogFile TaskListener listener rootTag return true catch IOException e e printStackTrace listener error e getMessage return false protected final void createEmptyChangeLog Nonnull File changelogFile Nonnull TaskListener listener Nonnull String rootTag throws IOException FileWriter w null try w new FileWriter changelogFile w write rootTag w close finally IOUtils closeQuietly w protected final String nullify String s if s null return null if s trim length 0 return null return s public static final PermissionGroup PERMISSIONS new PermissionGroup SCM class Messages SCM Permissions Title public static final Permission TAG new Permission PERMISSIONS Tag Messages SCM TagPermission Description Permission CREATE PermissionScope ITEM public static DescriptorExtensionList SCM SCMDescriptor all return Jenkins getInstance SCM SCMDescriptor getDescriptorList SCM class public static List SCMDescriptor for CheckForNull final Job project if project null return all final Descriptor pd Jenkins getInstance getDescriptor Class project getClass List SCMDescriptor r new ArrayList SCMDescriptor for SCMDescriptor scmDescriptor all if scmDescriptor isApplicable project continue if pd instanceof TopLevelItemDescriptor TopLevelItemDescriptor apd TopLevelItemDescriptor pd if apd isApplicable scmDescriptor continue r add scmDescriptor return r Deprecated public static List SCMDescriptor for final AbstractProject project return for Job project public CheckForNull RepositoryBrowser guessBrowser return nullpackage jenkins scm import hudson ExtensionPoint import hudson Launcher import hudson model AbstractBuild import hudson model AbstractBuild AbstractBuildExecution import hudson model AbstractDescribableImpl import hudson model AbstractProject import hudson model BuildListener import hudson model BuildableItemWithBuildWrappers import hudson model Executor import hudson scm SCM import hudson tasks BuildWrapper import java io File import java io IOException public abstract class SCMCheckoutStrategy extends AbstractDescribableImpl SCMCheckoutStrategy implements ExtensionPoint public void preCheckout AbstractBuild build Launcher launcher BuildListener listener throws IOException InterruptedException AbstractProject project build getProject if project instanceof BuildableItemWithBuildWrappers BuildableItemWithBuildWrappers biwbw BuildableItemWithBuildWrappers project for BuildWrapper bw biwbw getBuildWrappersList bw preCheckout build launcher listener public void checkout AbstractBuildExecution execution throws IOException InterruptedException execution defaultCheckout Override public SCMCheckoutStrategyDescriptor getDescriptor return SCMCheckoutStrategyDescriptor super getDescriptorpackage jenkins scm import com google common collect Lists import hudson DescriptorExtensionList import hudson model AbstractProject import hudson model Descriptor import jenkins model Jenkins import java util List public abstract class SCMCheckoutStrategyDescriptor extends Descriptor SCMCheckoutStrategy protected SCMCheckoutStrategyDescriptor Class extends SCMCheckoutStrategy clazz super clazz protected SCMCheckoutStrategyDescriptor public abstract boolean isApplicable AbstractProject project public static DescriptorExtensionList SCMCheckoutStrategy SCMCheckoutStrategyDescriptor all return Jenkins getInstance SCMCheckoutStrategy SCMCheckoutStrategyDescriptor getDescriptorList SCMCheckoutStrategy class public static List SCMCheckoutStrategyDescriptor for AbstractProject p List SCMCheckoutStrategyDescriptor r Lists newArrayList for SCMCheckoutStrategyDescriptor d all if d isApplicable p r add d return rpackage jenkins scm import hudson ExtensionList import hudson ExtensionPoint import hudson model Item import java util ArrayList import java util List import javax annotation CheckForNull import javax annotation Nonnull public abstract class SCMDecisionHandler implements ExtensionPoint public abstract boolean shouldPoll Nonnull Item item Nonnull public static ExtensionList SCMDecisionHandler all return ExtensionList lookup SCMDecisionHandler class CheckForNull public static SCMDecisionHandler firstShouldPollVeto Nonnull Item item for SCMDecisionHandler handler all if handler shouldPoll item return handler return null Nonnull public static List SCMDecisionHandler listShouldPollVetos Nonnull Item item List SCMDecisionHandler result new ArrayList for SCMDecisionHandler handler all if handler shouldPoll item result add handler return resultpackage hudson scm import hudson Util import hudson model AbstractProject import hudson model Descriptor import hudson model Job import java lang reflect Field import java util Collections import java util List import static java util logging Level WARNING import java util logging Logger public abstract class SCMDescriptor T extends SCM extends Descriptor SCM public transient final Class extends RepositoryBrowser repositoryBrowser Deprecated public volatile int generation 1 protected SCMDescriptor Class T clazz Class extends RepositoryBrowser repositoryBrowser super clazz this repositoryBrowser repositoryBrowser protected SCMDescriptor Class extends RepositoryBrowser repositoryBrowser this repositoryBrowser repositoryBrowser work around HUDSON 4514 The repositoryBrowser field was marked as non transient until 1 325 causing the field to be persisted and overwritten on the load method SuppressWarnings ConstantConditions Override public void load Class extends RepositoryBrowser rb repositoryBrowser super load if repositoryBrowser rb XStream may overwrite even the final field try Field f SCMDescriptor class getDeclaredField repositoryBrowser f setAccessible true f set this rb catch NoSuchFieldException e LOGGER log WARNING Failed to overwrite the repositoryBrowser field e catch IllegalAccessException e LOGGER log WARNING Failed to overwrite the repositoryBrowser field e Deprecated public boolean isBrowserReusable T x T y return false public boolean isApplicable Job project if project instanceof AbstractProject return isApplicable AbstractProject project else return false Deprecated public boolean isApplicable AbstractProject project if Util isOverridden SCMDescriptor class getClass isApplicable Job class return isApplicable Job project else return true public List Descriptor RepositoryBrowser getBrowserDescriptors if repositoryBrowser null return Collections emptyList return RepositoryBrowsers filter repositoryBrowser private static final Logger LOGGER Logger getLogger SCMDescriptor class getNamepackage hudson model import hudson scm PollingResult import hudson scm SCM import jenkins triggers SCMTriggerItem Deprecated public interface SCMedItem extends BuildableItem SCM getScm AbstractProject asProject Deprecated boolean pollSCMChanges TaskListener listener PollingResult poll TaskListener listenerpackage hudson model listeners import hudson Extension import hudson ExtensionPoint import hudson FilePath import hudson Launcher import hudson Util import hudson model AbstractBuild import hudson model Action import hudson model BuildListener import hudson model Run import hudson model TaskListener import hudson scm ChangeLogSet import hudson scm SCM import hudson scm SCMRevisionState import java io File import java util ArrayList import java util Collection import java util Collections import java util List import javax annotation CheckForNull import jenkins model Jenkins public abstract class SCMListener implements ExtensionPoint public void onCheckout Run build SCM scm FilePath workspace TaskListener listener CheckForNull File changelogFile CheckForNull SCMRevisionState pollingBaseline throws Exception public void onChangeLogParsed Run build SCM scm TaskListener listener ChangeLogSet changelog throws Exception if build instanceof AbstractBuild listener instanceof BuildListener Util isOverridden SCMListener class getClass onChangeLogParsed AbstractBuild class BuildListener class ChangeLogSet class onChangeLogParsed AbstractBuild build BuildListener listener changelog Deprecated public void onChangeLogParsed AbstractBuild build BuildListener listener ChangeLogSet changelog throws Exception if Util isOverridden SCMListener class getClass onChangeLogParsed Run class SCM class TaskListener class ChangeLogSet class onChangeLogParsed Run build build getProject getScm listener changelog SuppressWarnings deprecation public static Collection extends SCMListener all Jenkins j Jenkins getInstanceOrNull if j null TODO use Functions isExtensionsAvailable once JENKINS 33377 return Collections emptySet List SCMListener r new ArrayList SCMListener j getExtensionList SCMListener class for SCMListener l j getSCMListeners r add l return r Deprecated public final void register Jenkins getInstance getSCMListeners add this Deprecated public final boolean unregister return Jenkins getInstance getSCMListeners remove thispackage hudson model listeners import hudson ExtensionList import hudson ExtensionPoint import hudson scm PollingResult import hudson model AbstractProject import hudson model TaskListener import java io IOException public abstract class SCMPollListener implements ExtensionPoint TODO switch to Job public void onBeforePolling AbstractProject project TaskListener listener public void onPollingSuccess AbstractProject project TaskListener listener PollingResult result public void onPollingFailed AbstractProject project TaskListener listener Throwable exception public static void fireBeforePolling AbstractProject project TaskListener listener for SCMPollListener l all try l onBeforePolling project listener catch Exception e public static void firePollingSuccess AbstractProject project TaskListener listener PollingResult result for SCMPollListener l all try l onPollingSuccess project listener result catch Exception e public static void firePollingFailed AbstractProject project TaskListener listener Throwable exception for SCMPollListener l all try l onPollingFailed project listener exception catch Exception e public static ExtensionList SCMPollListener all return ExtensionList lookup SCMPollListener classpackage hudson scm import hudson FilePath import hudson Launcher import hudson model AbstractBuild import hudson model AbstractProject import hudson model Action import hudson model TaskListener public abstract class SCMRevisionState implements Action public String getIconFileName return null public String getDisplayName return null public String getUrlName return null public static SCMRevisionState NONE new None private static final class None extends SCMRevisionStatepackage hudson scm import hudson model AbstractProject import hudson model Descriptor FormException import hudson util DescriptorList import hudson Extension import java util List import org kohsuke stapler StaplerRequest import javax servlet ServletException public class SCMS Deprecated public static final List SCMDescriptor SCMS List new DescriptorList SCM SCM class SuppressWarnings deprecation public static SCM parseSCM StaplerRequest req AbstractProject target throws FormException ServletException SCM scm SCM all newInstanceFromRadioList req getSubmittedForm getJSONObject scm if scm null scm new NullSCM JENKINS 36043 workaround for AbstractMultiBranchProject submit scm getDescriptor generation return scm Deprecated public static SCM parseSCM StaplerRequest req throws FormException ServletException return parseSCM req nullpackage hudson triggers import antlr ANTLRException import com google common base Preconditions import hudson Extension import hudson Util import hudson console AnnotatedLargeText import hudson model AbstractBuild import hudson model AbstractProject import hudson model Action import hudson model AdministrativeMonitor import hudson model Cause import hudson model CauseAction import hudson model Item import hudson model Run import hudson scm SCM import hudson scm SCMDescriptor import hudson util FlushProofOutputStream import hudson util FormValidation import hudson util IOUtils import hudson util NamingThreadFactory import hudson util SequentialExecutionQueue import hudson util StreamTaskListener import hudson util TimeUnit2 import java io File import java io IOException import java io PrintStream import java nio charset Charset import java text DateFormat import java util ArrayList import java util Collection import java util Collections import java util Date import java util HashSet import java util List import java util Set import java util concurrent ExecutorService import java util concurrent Executors import java util concurrent ThreadFactory import java util logging Level import java util logging Logger import jenkins model Jenkins import jenkins model RunAction2 import jenkins scm SCMDecisionHandler import jenkins triggers SCMTriggerItem import jenkins util SystemProperties import net sf json JSONObject import org apache commons io FileUtils import org apache commons jelly XMLOutput import org jenkinsci Symbol import org kohsuke accmod Restricted import org kohsuke accmod restrictions DoNotUse import org kohsuke accmod restrictions NoExternalUse import org kohsuke stapler DataBoundConstructor import org kohsuke stapler DataBoundSetter import org kohsuke stapler QueryParameter import org kohsuke stapler StaplerRequest import org kohsuke stapler StaplerResponse import static java util logging Level WARNING public class SCMTrigger extends Trigger Item private boolean ignorePostCommitHooks DataBoundConstructor public SCMTrigger String scmpoll spec throws ANTLRException super scmpoll spec Deprecated public SCMTrigger String scmpoll spec boolean ignorePostCommitHooks throws ANTLRException super scmpoll spec this ignorePostCommitHooks ignorePostCommitHooks public boolean isIgnorePostCommitHooks return this ignorePostCommitHooks DataBoundSetter public void setIgnorePostCommitHooks boolean ignorePostCommitHooks this ignorePostCommitHooks ignorePostCommitHooks public String getScmpoll spec return super getSpec Override public void run if job null return run null public void run Action additionalActions if job null return DescriptorImpl d getDescriptor LOGGER fine Scheduling a polling for job if d synchronousPolling LOGGER fine Running the trigger directly without threading as it s already taken care of by Trigger Cron new Runner additionalActions run else schedule the polling even if we end up submitting this too many times that s OK the real exclusion control happens inside Runner LOGGER fine scheduling the trigger to asynchronously run d queue execute new Runner additionalActions d clogCheck Override public DescriptorImpl getDescriptor return DescriptorImpl super getDescriptor Override public Collection extends Action getProjectActions if job null return Collections emptyList return Collections singleton new SCMAction public File getLogFile return new File job getRootDir scm polling log Extension Symbol pollSCM public static class DescriptorImpl extends TriggerDescriptor private static ThreadFactory threadFactory return new NamingThreadFactory Executors defaultThreadFactory SCMTrigger private transient final SequentialExecutionQueue queue new SequentialExecutionQueue Executors newSingleThreadExecutor threadFactory public boolean synchronousPolling false private int maximumThreads public DescriptorImpl load resizeThreadPool public boolean isApplicable Item item return SCMTriggerItem SCMTriggerItems asSCMTriggerItem item null public ExecutorService getExecutor return queue getExecutors public boolean isClogged return queue isStarving STARVATION THRESHOLD public void clogCheck AdministrativeMonitor all get AdministrativeMonitorImpl class on isClogged public List Runner getRunners return Util filter queue getInProgress Runner class originally List SCMedItem but known to be used only for logging in which case the instances are not actually cast to SCMedItem anyway public List SCMTriggerItem getItemsBeingPolled List SCMTriggerItem r new ArrayList SCMTriggerItem for Runner i getRunners r add i getTarget return r public String getDisplayName return Messages SCMTrigger DisplayName public int getPollingThreadCount return maximumThreads public void setPollingThreadCount int n fool proof if n 0 n 0 if n 100 n 100 maximumThreads n resizeThreadPool Restricted NoExternalUse class public boolean isPollingThreadCountOptionVisible unless you have a fair number of projects this option is likely pointless so let s hide this option for new users to avoid confusing them unless it was already changed TODO switch to check for SCMTriggerItem return Jenkins getInstance getAllItems AbstractProject class size 10 getPollingThreadCount 0 synchronized void resizeThreadPool queue setExecutors maximumThreads 0 Executors newCachedThreadPool threadFactory Executors newFixedThreadPool maximumThreads threadFactory Override public boolean configure StaplerRequest req JSONObject json throws FormException String t json optString pollingThreadCount null if t null t length 0 setPollingThreadCount 0 else setPollingThreadCount Integer parseInt t Save configuration save return true public FormValidation doCheckPollingThreadCount QueryParameter String value if value null equals value trim return FormValidation ok return FormValidation validateNonNegativeInteger value Extension public static final class AdministrativeMonitorImpl extends AdministrativeMonitor Override public String getDisplayName return Messages SCMTrigger AdministrativeMonitorImpl DisplayName private boolean on public boolean isActivated return on public static class BuildAction implements RunAction2 private transient Run run Deprecated public transient AbstractBuild build public BuildAction Run run this run run build run instanceof AbstractBuild AbstractBuild run null Deprecated public BuildAction AbstractBuild build this Run build public Run getRun return run public File getPollingLogFile return new File run getRootDir polling log public String getIconFileName return clipboard png public String getDisplayName return Messages SCMTrigger BuildAction DisplayName public String getUrlName return pollingLog public void doPollingLog StaplerRequest req StaplerResponse rsp throws IOException rsp setContentType text plain charset UTF 8 Prevent jelly from flushing stream so Content Length header can be added afterwards FlushProofOutputStream out new FlushProofOutputStream rsp getCompressedOutputStream req try getPollingLogText writeLogTo 0 out finally IOUtils closeQuietly out public AnnotatedLargeText getPollingLogText return new AnnotatedLargeText BuildAction getPollingLogFile Charset defaultCharset true this public void writePollingLogTo long offset XMLOutput out throws IOException TODO resurrect compressed log file support getPollingLogText writeHtmlTo offset out asWriter Override public void onAttached Run r unnecessary existing constructor does this Override public void onLoad Run r run r build run instanceof AbstractBuild AbstractBuild run null public final class SCMAction implements Action public AbstractProject getOwner Item item getItem return item instanceof AbstractProject AbstractProject item null public Item getItem return job asItem public String getIconFileName return clipboard png public String getDisplayName Set SCMDescriptor descriptors new HashSet SCMDescriptor for SCM scm job getSCMs descriptors add scm getDescriptor return descriptors size 1 Messages SCMTrigger getDisplayName descriptors iterator next getDisplayName Messages SCMTrigger BuildAction DisplayName public String getUrlName return scmPollLog public String getLog throws IOException return Util loadFile getLogFile public void writeLogTo XMLOutput out throws IOException new AnnotatedLargeText SCMAction getLogFile Charset defaultCharset true this writeHtmlTo 0 out asWriter private static final Logger LOGGER Logger getLogger SCMTrigger class getName public class Runner implements Runnable private volatile long startTime private Action additionalActions public Runner this null public Runner Action actions Preconditions checkNotNull job Runner can t be instantiated when job is null if actions null additionalActions new Action 0 else additionalActions actions public File getLogFile return SCMTrigger this getLogFile public SCMTriggerItem getTarget return job public long getStartTime return startTime public String getDuration return Util getTimeSpanString System currentTimeMillis startTime private boolean runPolling try to make sure that the log file contains up to date text don t do buffering StreamTaskListener listener new StreamTaskListener getLogFile try PrintStream logger listener getLogger long start System currentTimeMillis logger println Started on DateFormat getDateTimeInstance format new Date boolean result job poll listener hasChanges logger println Done Took Util getTimeSpanString System currentTimeMillis start if result logger println Changes found else logger println No changes return result catch Error RuntimeException e e printStackTrace listener error Failed to record SCM polling for job LOGGER log Level SEVERE Failed to record SCM polling for job e throw e finally listener close catch IOException e LOGGER log Level SEVERE Failed to record SCM polling for job e return false public void run if job null return we can pre emtively check the SCMDecisionHandler instances here note that job poll listener should also check this SCMDecisionHandler veto SCMDecisionHandler firstShouldPollVeto job if veto null try StreamTaskListener listener new StreamTaskListener getLogFile listener getLogger println Skipping polling on DateFormat getDateTimeInstance format new Date due to veto from veto catch IOException e LOGGER log Level SEVERE Failed to record SCM polling for job e LOGGER log Level FINE Skipping polling for 0 due to veto from 1 new Object job getFullDisplayName veto return String threadName Thread currentThread getName Thread currentThread setName SCM polling for job try startTime System currentTimeMillis if runPolling SCMTriggerItem p job String name p getNextBuildNumber SCMTriggerCause cause try cause new SCMTriggerCause getLogFile catch IOException e LOGGER log WARNING Failed to parse the polling log e cause new SCMTriggerCause Action queueActions new Action additionalActions length 1 queueActions 0 new CauseAction cause System arraycopy additionalActions 0 queueActions 1 additionalActions length if p scheduleBuild2 p getQuietPeriod queueActions null LOGGER info SCM changes detected in job getFullDisplayName Triggering name else LOGGER info SCM changes detected in job getFullDisplayName Job is already in the queue finally Thread currentThread setName threadName as per the requirement of SequentialExecutionQueue value equality is necessary Override public boolean equals Object that return that instanceof Runner job Runner that job private Item job return job Override public int hashCode return job hashCode SuppressWarnings deprecation private SCMTriggerItem job return SCMTriggerItem SCMTriggerItems asSCMTriggerItem job public static class SCMTriggerCause extends Cause private String pollingLog private transient Run run public SCMTriggerCause File logFile throws IOException TODO charset of this log file this FileUtils readFileToString logFile public SCMTriggerCause String pollingLog this pollingLog pollingLog Deprecated public SCMTriggerCause this Override public void onLoad Run run this run run Override public void onAddedTo Run build this run build try BuildAction a new BuildAction build FileUtils writeStringToFile a getPollingLogFile pollingLog build replaceAction a catch IOException e LOGGER log WARNING Failed to persist the polling log e pollingLog null Override public String getShortDescription return Messages SCMTrigger SCMTriggerCause ShortDescription Restricted DoNotUse class public Run getRun return this run Override public boolean equals Object o return o instanceof SCMTriggerCause Override public int hashCode return 3 public static long STARVATION THRESHOLD SystemProperties getLong SCMTrigger class getName starvationThreshold TimeUnit2 HOURS toMillis 1package jenkins triggers import hudson model Action import hudson model Item import hudson model Job import hudson model TaskListener import hudson model queue QueueTaskFuture import hudson scm NullSCM import hudson scm PollingResult import hudson scm SCM import hudson triggers SCMTrigger import java util Collection import java util Collections import java util logging Level import java util logging Logger import javax annotation CheckForNull import javax annotation Nonnull import jenkins model ParameterizedJobMixIn import jenkins scm SCMDecisionHandler public interface SCMTriggerItem Item asItem int getNextBuildNumber int getQuietPeriod CheckForNull QueueTaskFuture scheduleBuild2 int quietPeriod Action actions Nonnull PollingResult poll Nonnull TaskListener listener CheckForNull SCMTrigger getSCMTrigger Nonnull Collection extends SCM getSCMs class SCMTriggerItems SuppressWarnings deprecation public static CheckForNull SCMTriggerItem asSCMTriggerItem Item item if item instanceof SCMTriggerItem return SCMTriggerItem item else if item instanceof hudson model SCMedItem return new Bridge hudson model SCMedItem item else return null private static final class Bridge implements SCMTriggerItem private final hudson model SCMedItem delegate Bridge hudson model SCMedItem delegate this delegate delegate Override public Item asItem return delegate asProject Override public int getNextBuildNumber return delegate asProject getNextBuildNumber Override public int getQuietPeriod return delegate asProject getQuietPeriod Override public QueueTaskFuture scheduleBuild2 int quietPeriod Action actions return delegate asProject scheduleBuild2 quietPeriod null actions Override public PollingResult poll TaskListener listener SCMDecisionHandler veto SCMDecisionHandler firstShouldPollVeto asItem if veto null veto shouldPoll asItem listener getLogger println Messages SCMTriggerItem PollingVetoed veto return PollingResult NO CHANGES return delegate poll listener Override public SCMTrigger getSCMTrigger return delegate asProject getTrigger SCMTrigger class Override public Collection extends SCM getSCMs return resolveMultiScmIfConfigured delegate asProject getScm public static Nonnull Collection extends SCM resolveMultiScmIfConfigured CheckForNull SCM scm if scm null scm instanceof NullSCM return Collections emptySet else if scm getClass getName equals org jenkinsci plugins multiplescms MultiSCM try return Collection extends SCM scm getClass getMethod getConfiguredSCMs invoke scm catch Exception x Logger getLogger SCMTriggerItem class getName log Level WARNING null x return Collections singleton scm else return Collections singleton scm private SCMTriggerItemspackage hudson util import com trilead ssh2 crypto Base64 import java io IOException import java io UnsupportedEncodingException public class Scrambler public static String scramble String secret if secret null return null try return new String Base64 encode secret getBytes UTF 8 catch UnsupportedEncodingException e throw new Error e impossible public static String descramble String scrambled if scrambled null return null try return new String Base64 decode scrambled toCharArray UTF 8 catch IOException e return corrupted datapackage com twitter sdk android tweetcomposer import com twitter sdk android core internal scribe EventNamespace import com twitter sdk android core internal scribe ScribeItem import java util List interface ScribeClient void scribe EventNamespace eventNamespace List ScribeItem itemspackage com twitter sdk android tweetcomposer import com twitter sdk android core internal scribe DefaultScribeClient import com twitter sdk android core internal scribe EventNamespace import com twitter sdk android core internal scribe ScribeItem import java util List class ScribeClientImpl implements ScribeClient private final DefaultScribeClient scribeClient public ScribeClientImpl DefaultScribeClient scribeClient this scribeClient scribeClient Override public void scribe EventNamespace eventNamespace List ScribeItem items if scribeClient null scribeClient scribe eventNamespace itemspackage com twitter sdk android core internal scribe public class ScribeConfig public static final String BASE URL https api twitter com public static final int DEFAULT MAX FILES TO KEEP 100 public static final int DEFAULT SEND INTERVAL SECONDS 10 60 10 minutes public final boolean isEnabled public final String baseUrl public final String pathVersion public final String pathType public final String sequence public final String userAgent public final int maxFilesToKeep public final int sendIntervalSeconds public ScribeConfig boolean isEnabled String baseUrl String pathVersion String pathType String sequence String userAgent int maxFilesToKeep int sendIntervalSeconds this isEnabled isEnabled this baseUrl baseUrl this pathVersion pathVersion this pathType pathType this sequence sequence this userAgent userAgent this maxFilesToKeep maxFilesToKeep this sendIntervalSeconds sendIntervalSecondspackage com twitter sdk android tweetcomposer import com twitter sdk android core internal scribe EventNamespace import com twitter sdk android core internal scribe ScribeItem final class ScribeConstants private ScribeConstants namespaces with client tfw become SyndicationClientEvent scribes to logs tfw client event static final String SCRIBE TFW CLIENT tfw static final String SCRIBE PAGE android static final String SCRIBE SECTION composer static final String SCRIBE COMPONENT static final String SCRIBE IMPRESSION ELEMENT static final String SCRIBE TWEET ELEMENT tweet static final String SCRIBE CANCEL ELEMENT cancel static final String SCRIBE IMPRESSION ACTION impression static final String SCRIBE CLICK ACTION click static final int SCRIBE PROMO APP CARD TYPE 8 static final EventNamespace Builder ComposerEventBuilder new EventNamespace Builder setClient SCRIBE TFW CLIENT setPage SCRIBE PAGE setSection SCRIBE SECTION static ScribeItem newCardScribeItem Card card promo app card is currently the only type of Card return new ScribeItem Builder setItemType ScribeItem TYPE TWEET setCardEvent new ScribeItem CardEvent SCRIBE PROMO APP CARD TYPE buildpackage com twitter sdk android core internal scribe import android text TextUtils import com google gson Gson import com google gson annotations SerializedName import io fabric sdk android services events EventTransform import java io IOException import java util Collections import java util List public class ScribeEvent private static final String CURRENT FORMAT VERSION 2 SerializedName event namespace final EventNamespace eventNamespace SerializedName ts final String timestamp SerializedName format version final String formatVersion SerializedName category final String category SerializedName items final List ScribeItem items public ScribeEvent String category EventNamespace eventNamespace long timestamp this category eventNamespace timestamp Collections ScribeItem emptyList public ScribeEvent String category EventNamespace eventNamespace long timestamp List ScribeItem items this category category this eventNamespace eventNamespace this timestamp String valueOf timestamp this formatVersion CURRENT FORMAT VERSION this items Collections unmodifiableList items Override public String toString return new StringBuilder append event namespace append eventNamespace append ts append timestamp append format version append formatVersion append category append category append items append TextUtils join items toString Override public boolean equals Object o if this o return true if o null getClass o getClass return false final ScribeEvent that ScribeEvent o if category null category equals that category that category null return false if eventNamespace null eventNamespace equals that eventNamespace that eventNamespace null return false if formatVersion null formatVersion equals that formatVersion that formatVersion null return false if timestamp null timestamp equals that timestamp that timestamp null return false if items null items equals that items that items null return false return true Override public int hashCode int result eventNamespace null eventNamespace hashCode 0 result 31 result timestamp null timestamp hashCode 0 result 31 result formatVersion null formatVersion hashCode 0 result 31 result category null category hashCode 0 result 31 result items null items hashCode 0 return result public static class Transform implements EventTransform ScribeEvent private final Gson gson public Transform Gson gson this gson gson Override public byte toBytes ScribeEvent event throws IOException return gson toJson event getBytes UTF 8package com twitter sdk android core internal scribe import java util Collections import java util List public class ScribeEventFactory public static ScribeEvent newScribeEvent EventNamespace ns long timestamp String language String advertisingId return newScribeEvent ns timestamp language advertisingId Collections ScribeItem emptyList public static ScribeEvent newScribeEvent EventNamespace ns String eventInfo long timestamp String language String advertisingId List ScribeItem items switch ns client case SyndicationClientEvent CLIENT NAME return new SyndicationClientEvent ns eventInfo timestamp language advertisingId items default return new SyndicatedSdkImpressionEvent ns timestamp language advertisingId itemspackage com twitter sdk android core internal scribe import io fabric sdk android FabricAndroidTestCase import io fabric sdk android services common CommonUtils import com google gson GsonBuilder import java io IOException import java io InputStream import java util Arrays import java util List public class ScribeEventTransformTest extends FabricAndroidTestCase static final String TEST MESSAGE TEST MESSAGE static final String TEST ITEM TYPE item type 6 static final String TEST DESCRIPTION description TEST MESSAGE private ScribeEvent Transform transform private EventNamespace eventNamespace private String scribeEventJsonString Override protected void setUp throws Exception super setUp transform new ScribeEvent Transform new GsonBuilder create eventNamespace new EventNamespace Builder setClient testclient setPage testpage setSection testsection setComponent testcomponent setElement testelement setAction testaction builder InputStream is null try is getContext getAssets open scribe event json scribeEventJsonString CommonUtils streamToString is trim finally CommonUtils closeQuietly is public void testToBytes throws IOException final ScribeEvent scribeEvent new ScribeEvent testcategory eventNamespace 1404426136717L final byte bytes transform toBytes scribeEvent assertEquals scribeEventJsonString new String bytes UTF 8 public void testToBytes withItems throws IOException final ScribeItem scribeItem ScribeItem fromMessage TEST MESSAGE final List ScribeItem itemList Arrays asList scribeItem final ScribeEvent scribeEvent new ScribeEvent testcategory eventNamespace 1404426136717L itemList final byte bytes transform toBytes scribeEvent assertTrue new String bytes UTF 8 contains TEST ITEM TYPE assertTrue new String bytes UTF 8 contains TEST DESCRIPTIONpackage com twitter sdk android core internal scribe import android content Context import io fabric sdk android services common CurrentTimeProvider import io fabric sdk android services events EventTransform import io fabric sdk android services events EventsFilesManager import io fabric sdk android services events QueueFileEventStorage import java io IOException import java util UUID class ScribeFilesManager extends EventsFilesManager ScribeEvent static final String FILE PREFIX se static final String FILE EXTENSION tap public ScribeFilesManager Context context EventTransform ScribeEvent transform CurrentTimeProvider currentTimeProvider QueueFileEventStorage eventsStorage int defaultMaxFilesToKeep throws IOException super context transform currentTimeProvider eventsStorage defaultMaxFilesToKeep Override protected String generateUniqueRollOverFileName final UUID targetUUIDComponent UUID randomUUID return new StringBuilder append FILE PREFIX append ROLL OVER FILE NAME SEPARATOR append targetUUIDComponent toString append ROLL OVER FILE NAME SEPARATOR append currentTimeProvider getCurrentTimeMillis append FILE EXTENSION toStringpackage com twitter sdk android core internal scribe import android content Context import android text TextUtils import io fabric sdk android services common CommonUtils import io fabric sdk android services common IdManager import io fabric sdk android services common QueueFile import io fabric sdk android services events FilesSender import com twitter sdk android core GuestSessionProvider import com twitter sdk android core Session import com twitter sdk android core SessionManager import com twitter sdk android core TwitterAuthConfig import com twitter sdk android core TwitterAuthToken import com twitter sdk android core internal network GuestAuthInterceptor import com twitter sdk android core internal network OAuth1aInterceptor import java io ByteArrayOutputStream import java io File import java io IOException import java io InputStream import java net HttpURLConnection import java util List import java util concurrent ExecutorService import java util concurrent atomic AtomicReference import javax net ssl SSLSocketFactory import okhttp3 Interceptor import okhttp3 OkHttpClient import okhttp3 Request import okhttp3 ResponseBody import retrofit2 Call import retrofit2 Response import retrofit2 Retrofit import retrofit2 http Field import retrofit2 http FormUrlEncoded import retrofit2 http Headers import retrofit2 http POST import retrofit2 http Path class ScribeFilesSender implements FilesSender private static final String SEND FILE FAILURE ERROR Failed sending files private static final byte START JSON ARRAY private static final byte COMMA private static final byte END JSON ARRAY private final Context context private final ScribeConfig scribeConfig private final long ownerId private final TwitterAuthConfig authConfig private final SessionManager extends Session TwitterAuthToken sessionManager private final GuestSessionProvider guestSessionProvider private final SSLSocketFactory sslSocketFactory private final AtomicReference ScribeService scribeService private final ExecutorService executorService private final IdManager idManager public ScribeFilesSender Context context ScribeConfig scribeConfig long ownerId TwitterAuthConfig authConfig SessionManager extends Session TwitterAuthToken sessionManager GuestSessionProvider guestSessionProvider SSLSocketFactory sslSocketFactory ExecutorService executorService IdManager idManager this context context this scribeConfig scribeConfig this ownerId ownerId this authConfig authConfig this sessionManager sessionManager this guestSessionProvider guestSessionProvider this sslSocketFactory sslSocketFactory this executorService executorService this idManager idManager this scribeService new AtomicReference Override public boolean send List File files if hasApiAdapter try final String scribeEvents getScribeEventsAsJsonArrayString files CommonUtils logControlled context scribeEvents final Response ResponseBody response upload scribeEvents if response code HttpURLConnection HTTP OK return true else CommonUtils logControlledError context SEND FILE FAILURE ERROR null if response code HttpURLConnection HTTP INTERNAL ERROR response code HttpURLConnection HTTP BAD REQUEST return true catch Exception e CommonUtils logControlledError context SEND FILE FAILURE ERROR e else CommonUtils logControlled context Cannot attempt upload at this time return false String getScribeEventsAsJsonArrayString List File files throws IOException final ByteArrayOutputStream out new ByteArrayOutputStream 1024 final boolean appendComma new boolean 1 out write START JSON ARRAY for File f files QueueFile qf null try qf new QueueFile f qf forEach new QueueFile ElementReader Override public void read InputStream in int length throws IOException final byte buf new byte length in read buf if appendComma 0 out write COMMA else First time through we don t append comma but subsequent times we do appendComma 0 true out write buf finally CommonUtils closeQuietly qf out write END JSON ARRAY return out toString UTF 8 private boolean hasApiAdapter return getScribeService null void setScribeService ScribeService restAdapter scribeService set restAdapter synchronized ScribeService getScribeService if scribeService get null final Session session getSession ownerId OkHttpClient client if isValidSession session client new OkHttpClient Builder sslSocketFactory sslSocketFactory addInterceptor new ConfigRequestInterceptor scribeConfig idManager addInterceptor new OAuth1aInterceptor session authConfig build else client new OkHttpClient Builder sslSocketFactory sslSocketFactory addInterceptor new ConfigRequestInterceptor scribeConfig idManager addInterceptor new GuestAuthInterceptor guestSessionProvider build final Retrofit retrofit new Retrofit Builder baseUrl scribeConfig baseUrl client client build scribeService compareAndSet null retrofit create ScribeService class return scribeService get private Session getSession long ownerId return sessionManager getSession ownerId private boolean isValidSession Session session return session null session getAuthToken null Response ResponseBody upload String scribeEvents throws IOException final ScribeService service getScribeService if TextUtils isEmpty scribeConfig sequence return service uploadSequence scribeConfig sequence scribeEvents execute else return service upload scribeConfig pathVersion scribeConfig pathType scribeEvents execute interface ScribeService Headers Content Type application x www form urlencoded charset UTF 8 FormUrlEncoded POST version jot type Call ResponseBody upload Path version String version Path type String type Field log String logs Headers Content Type application x www form urlencoded charset UTF 8 FormUrlEncoded POST scribe sequence Call ResponseBody uploadSequence Path sequence String sequence Field log String logs At a certain point we might need to allow either a custom RequestInterceptor to be set by the user of the ScribeClient or a custom map of headers to be supplied static class ConfigRequestInterceptor implements Interceptor private static final String USER AGENT HEADER User Agent private static final String CLIENT UUID HEADER X Client UUID private static final String POLLING HEADER X Twitter Polling private static final String POLLING HEADER VALUE true private final ScribeConfig scribeConfig private final IdManager idManager ConfigRequestInterceptor ScribeConfig scribeConfig IdManager idManager this scribeConfig scribeConfig this idManager idManager Override public okhttp3 Response intercept Chain chain throws IOException final Request Builder builder chain request newBuilder if TextUtils isEmpty scribeConfig userAgent builder header USER AGENT HEADER scribeConfig userAgent if TextUtils isEmpty idManager getDeviceUUID builder header CLIENT UUID HEADER idManager getDeviceUUID builder header POLLING HEADER POLLING HEADER VALUE return chain proceed builder buildpackage com twitter sdk android core internal scribe import android content Context import io fabric sdk android services events DisabledEventsStrategy import io fabric sdk android services events EventsFilesManager import io fabric sdk android services events EventsHandler import io fabric sdk android services events EventsStrategy import java util concurrent ScheduledExecutorService class ScribeHandler extends EventsHandler ScribeEvent public ScribeHandler Context context EventsStrategy ScribeEvent strategy EventsFilesManager filesManager ScheduledExecutorService executorService super context strategy filesManager executorService public void scribe ScribeEvent event recordEventAsync event false public void scribeAndFlush ScribeEvent event recordEventAsync event true Override protected EventsStrategy ScribeEvent getDisabledEventsStrategy return new DisabledEventsStrategypackage com twitter sdk android core internal scribe import com google gson annotations SerializedName import com twitter sdk android core internal VineCardUtils import com twitter sdk android core models Card import com twitter sdk android core models MediaEntity import com twitter sdk android core models Tweet import com twitter sdk android core models User import java io Serializable public class ScribeItem implements Serializable public static final int TYPE TWEET 0 public static final int TYPE USER 3 public static final int TYPE MESSAGE 6 SerializedName item type public final Integer itemType SerializedName id public final Long id SerializedName description public final String description SerializedName card event public final CardEvent cardEvent SerializedName media details public final MediaDetails mediaDetails private ScribeItem Integer itemType Long id String description CardEvent cardEvent MediaDetails mediaDetails this itemType itemType this id id this description description this cardEvent cardEvent this mediaDetails mediaDetails public static ScribeItem fromTweet Tweet tweet return new ScribeItem Builder setItemType TYPE TWEET setId tweet id build public static ScribeItem fromUser User user return new ScribeItem Builder setItemType TYPE USER setId user id build public static ScribeItem fromMessage String message return new ScribeItem Builder setItemType TYPE MESSAGE setDescription message build public static ScribeItem fromTweetCard long tweetId Card card return new ScribeItem Builder setItemType ScribeItem TYPE TWEET setId tweetId setMediaDetails createCardDetails tweetId card build public static ScribeItem fromMediaEntity long tweetId MediaEntity mediaEntity return new ScribeItem Builder setItemType ScribeItem TYPE TWEET setId tweetId setMediaDetails createMediaDetails tweetId mediaEntity build static ScribeItem MediaDetails createMediaDetails long tweetId MediaEntity mediaEntity return new ScribeItem MediaDetails tweetId getMediaType mediaEntity mediaEntity id static ScribeItem MediaDetails createCardDetails long tweetId Card card return new ScribeItem MediaDetails tweetId MediaDetails TYPE VINE Long valueOf VineCardUtils getPublisherId card static int getMediaType MediaEntity mediaEntity if MediaDetails GIF TYPE equals mediaEntity type return ScribeItem MediaDetails TYPE ANIMATED GIF else return ScribeItem MediaDetails TYPE CONSUMER Override public boolean equals Object o if this o return true if o null getClass o getClass return false final ScribeItem that ScribeItem o if itemType null itemType equals that itemType that itemType null return false if id null id equals that id that id null return false if description null description equals that description that description null return false if cardEvent null cardEvent equals that cardEvent that cardEvent null return false return mediaDetails null mediaDetails equals that mediaDetails that mediaDetails null Override public int hashCode int result itemType null itemType hashCode 0 result 31 result id null id hashCode 0 result 31 result description null description hashCode 0 result 31 result cardEvent null cardEvent hashCode 0 result 31 result mediaDetails null mediaDetails hashCode 0 return result public static class CardEvent implements Serializable public CardEvent int cardType promotionCardType cardType SerializedName promotion card type final int promotionCardType Override public boolean equals Object o if this o return true if o null getClass o getClass return false final CardEvent cardEvent CardEvent o return promotionCardType cardEvent promotionCardType Override public int hashCode return promotionCardType public static class MediaDetails implements Serializable public static final int TYPE CONSUMER 1 public static final int TYPE AMPLIFY 2 public static final int TYPE ANIMATED GIF 3 public static final int TYPE VINE 4 public static final String GIF TYPE animated gif SerializedName content id public final long contentId SerializedName media type public final int mediaType SerializedName publisher id public final long publisherId public MediaDetails long contentId int mediaType long publisherId this contentId contentId this mediaType mediaType this publisherId publisherId Override public boolean equals Object o if this o return true if o null getClass o getClass return false final MediaDetails that MediaDetails o if contentId that contentId return false if mediaType that mediaType return false return publisherId that publisherId Override public int hashCode int result int contentId contentId 32 result 31 result mediaType result 31 result int publisherId publisherId 32 return result public static class Builder private Integer itemType private Long id private String description private CardEvent cardEvent private MediaDetails mediaDetails public Builder setItemType int itemType this itemType itemType return this public Builder setId long id this id id return this public Builder setDescription String description this description description return this public Builder setCardEvent CardEvent cardEvent this cardEvent cardEvent return this public Builder setMediaDetails MediaDetails mediaDetails this mediaDetails mediaDetails return this public ScribeItem build return new ScribeItem itemType id description cardEvent mediaDetailspackage hudson cli util import hudson AbortException import jenkins security MasterToSlaveCallable import org apache commons io FileUtils import org apache commons io IOUtils import java io File import java io IOException import java io InputStream import java net MalformedURLException import java net URL public class ScriptLoader extends MasterToSlaveCallable String IOException private final String script public ScriptLoader String script this script script public String call throws IOException File f new File script if f exists return FileUtils readFileToString f URL url try url new URL script catch MalformedURLException e throw new AbortException Unable to find a script script try InputStream s url openStream return IOUtils toString spackage com kaku colorfulnews widget import android content Context import android support design widget CoordinatorLayout import android support design widget FloatingActionButton import android support v4 view ViewCompat import android util AttributeSet import android view View public class ScrollAwareFABBehavior extends FloatingActionButton Behavior public ScrollAwareFABBehavior Context context AttributeSet attrs super Override public boolean onStartNestedScroll final CoordinatorLayout coordinatorLayout final FloatingActionButton child final View directTargetChild final View target final int nestedScrollAxes Ensure we react to vertical scrolling return nestedScrollAxes ViewCompat SCROLL AXIS VERTICAL super onStartNestedScroll coordinatorLayout child directTargetChild target nestedScrollAxes Override public void onNestedScroll CoordinatorLayout coordinatorLayout FloatingActionButton child View target int dxConsumed int dyConsumed int dxUnconsumed int dyUnconsumed super onNestedScroll coordinatorLayout child target dxConsumed dyConsumed dxUnconsumed dyUnconsumed if dyConsumed 0 child getVisibility View VISIBLE child hide else if dyConsumed 0 child getVisibility View VISIBLE child showpackage com kaku colorfulnews event public class ScrollToTopEventpackage com twitter sdk android core models import com google gson annotations SerializedName import java util List public class Search SerializedName statuses public final List Tweet tweets SerializedName search metadata public final SearchMetadata searchMetadata public Search List Tweet tweets SearchMetadata searchMetadata this tweets tweets this searchMetadata searchMetadatapackage hudson search import hudson model ModelObject public interface SearchableModelObject extends ModelObject SearchItem Search getSearchpackage hudson search import hudson Extension import hudson ExtensionList import hudson ExtensionPoint public abstract class SearchFactory implements ExtensionPoint public abstract Search createFor SearchableModelObject owner public static ExtensionList SearchFactory all return ExtensionList lookup SearchFactory classpackage hudson search import java util List public interface SearchIndex void find String token List SearchItem result void suggest String token List SearchItem result SearchIndex EMPTY new SearchIndex public void find String token List SearchItem result no item to contribute public void suggest String token List SearchItem result nothing to suggestpackage hudson search import hudson model AbstractModelObject import java util ArrayList import java util List public final class SearchIndexBuilder private final List SearchItem items new ArrayList SearchItem private final List SearchIndex indices new ArrayList SearchIndex public SearchIndexBuilder addAllAnnotations SearchableModelObject o ParsedQuickSilver get o getClass addTo this o return this public SearchIndexBuilder add String urlAsWellAsName return add urlAsWellAsName urlAsWellAsName public SearchIndexBuilder add String url String name items add SearchItems create name url return this public SearchIndexBuilder add String url String names for String name names add url name return this public SearchIndexBuilder add SearchItem item items add item return this public SearchIndexBuilder add String url SearchableModelObject searchable String name items add SearchItems create name url searchable return this public SearchIndexBuilder add String url SearchableModelObject searchable String names for String name names add url searchable name return this public SearchIndexBuilder add SearchIndex index this indices add index return this public SearchIndexBuilder add SearchIndexBuilder index return add index make public SearchIndex make SearchIndex r new FixedSet items for SearchIndex index indices r new UnionSearchIndex r index return rpackage hudson search import hudson model Build public interface SearchItem String getSearchName String getSearchUrl SearchIndex getSearchIndexpackage hudson search public class SearchItems public static SearchItem create String searchName String url return create searchName url SearchIndex EMPTY public static SearchItem create final String searchName final String url final SearchIndex children return new SearchItem public String getSearchName return searchName public String getSearchUrl return url public SearchIndex getSearchIndex return children public static SearchItem create final String searchName final String url final SearchableModelObject searchable return new SearchItem public String getSearchName return searchName public String getSearchUrl return url public SearchIndex getSearchIndex return searchable getSearchIndexpackage com twitter sdk android core models import com google gson annotations SerializedName public class SearchMetadata SerializedName max id public final long maxId SerializedName since id public final long sinceId SerializedName refresh url public final String refreshUrl SerializedName next results public final String nextResults SerializedName count public final long count SerializedName completed in public final double completedIn SerializedName since id str public final String sinceIdStr SerializedName query public final String query SerializedName max id str public final String maxIdStr public SearchMetadata int maxId int sinceId String refreshUrl String nextResults int count double completedIn String sinceIdStr String query String maxIdStr this maxId maxId this sinceId sinceId this refreshUrl refreshUrl this nextResults nextResults this count count this completedIn completedIn this sinceIdStr sinceIdStr this query query this maxIdStr maxIdStrpackage hudson search import java util List public interface SearchResult extends List SuggestedItem boolean hasMoreResultspackage com twitter sdk android core services import com twitter sdk android core services params Geocode import com twitter sdk android core models Search import retrofit2 Call import retrofit2 http GET import retrofit2 http Query public interface SearchService GET 1 1 search tweets json tweet mode extended include cards true cards platform TwitterKit 13 Call Search tweets Query q String query EncodedQuery protects commas from encode Query value geocode encoded true Geocode geocode Query lang String lang Query locale String locale Query result type String resultType Query count Integer count Query until String until Query since id Long sinceId Query max id Long maxId Query include entities Boolean includeEntitiespackage com twitter sdk android tweetui import com twitter sdk android core Callback import com twitter sdk android core Result import com twitter sdk android core TwitterCore import com twitter sdk android core TwitterException import com twitter sdk android core models Search import com twitter sdk android core models Tweet import java util List import retrofit2 Call public class SearchTimeline extends BaseTimeline implements Timeline Tweet static final String FILTER RETWEETS filter retweets leading whitespace intentional private static final String SCRIBE SECTION search final String query final String resultType final String languageCode final Integer maxItemsPerRequest SearchTimeline TweetUi tweetUi String query String resultType String languageCode Integer maxItemsPerRequest super tweetUi this languageCode languageCode this maxItemsPerRequest maxItemsPerRequest this resultType resultType if the query is non null append the filter Retweets modifier this query query null null query FILTER RETWEETS Override public void next Long sinceId Callback TimelineResult Tweet cb createSearchRequest sinceId null enqueue new SearchCallback cb Override public void previous Long maxId Callback TimelineResult Tweet cb api quirk search api provides results that are inclusive of the maxId iff FILTER RETWEETS is added to the query which we currently always add decrement the maxId to get exclusive results createSearchRequest null decrementMaxId maxId enqueue new SearchCallback cb Override String getTimelineType return SCRIBE SECTION Call Search createSearchRequest final Long sinceId final Long maxId return TwitterCore getInstance getApiClient getSearchService tweets query null languageCode null resultType maxItemsPerRequest null sinceId maxId true class SearchCallback extends Callback Search final Callback TimelineResult Tweet cb SearchCallback Callback TimelineResult Tweet cb this cb cb Override public void success Result Search result final List Tweet tweets result data tweets final TimelineResult Tweet timelineResult new TimelineResult new TimelineCursor tweets tweets if cb null cb success new Result timelineResult result response Override public void failure TwitterException exception if cb null cb failure exception public enum ResultType RECENT recent POPULAR popular MIXED mixed FILTERED filtered final String type ResultType String type this type type public static class Builder private TweetUi tweetUi private String query private String lang private String resultType ResultType FILTERED type private Integer maxItemsPerRequest 30 public Builder this TweetUi getInstance public Builder TweetUi tweetUi if tweetUi null throw new IllegalArgumentException TweetUi instance must not be null this tweetUi tweetUi public Builder query String query this query query return this public Builder resultType ResultType resultType this resultType resultType type return this public Builder languageCode String languageCode this lang languageCode return this public Builder maxItemsPerRequest Integer maxItemsPerRequest this maxItemsPerRequest maxItemsPerRequest return this public SearchTimeline build if query null throw new IllegalStateException query must not be null return new SearchTimeline tweetUi query resultType lang maxItemsPerRequestpackage hudson util import com thoughtworks xstream converters Converter import com thoughtworks xstream converters MarshallingContext import com thoughtworks xstream converters UnmarshallingContext import com thoughtworks xstream io HierarchicalStreamReader import com thoughtworks xstream io HierarchicalStreamWriter import com trilead ssh2 crypto Base64 import jenkins util SystemProperties import jenkins model Jenkins import hudson Util import jenkins security CryptoConfidentialKey import org kohsuke stapler Stapler import javax crypto SecretKey import javax crypto Cipher import java io Serializable import java io UnsupportedEncodingException import java io IOException import java security GeneralSecurityException import java util regex Pattern import javax annotation CheckForNull import javax annotation Nonnull import org kohsuke accmod Restricted import org kohsuke accmod restrictions NoExternalUse public final class Secret implements Serializable Nonnull private final String value private Secret String value this value value Override Deprecated public String toString return value Nonnull public String getPlainText return value Override public boolean equals Object that return that instanceof Secret value equals Secret that value Override public int hashCode return value hashCode Deprecated static SecretKey getLegacyKey throws GeneralSecurityException String secret SECRET if secret null return Jenkins getInstance getSecretKeyAsAES128 return Util toAes128Key secret public String getEncryptedValue try Cipher cipher KEY encrypt add the magic suffix which works like a check sum return new String Base64 encode cipher doFinal value MAGIC getBytes UTF 8 catch GeneralSecurityException e throw new Error e impossible catch UnsupportedEncodingException e throw new Error e impossible Restricted NoExternalUse class public static final Pattern ENCRYPTED VALUE PATTERN Pattern compile A Za z0 9 0 2 CheckForNull public static Secret decrypt CheckForNull String data if data null return null try byte in Base64 decode data toCharArray Secret s tryDecrypt KEY decrypt in if s null return s try our historical key for backward compatibility Cipher cipher getCipher AES cipher init Cipher DECRYPT MODE getLegacyKey return tryDecrypt cipher in catch GeneralSecurityException e return null catch UnsupportedEncodingException e throw new Error e impossible catch IOException e return null static Secret tryDecrypt Cipher cipher byte in throws UnsupportedEncodingException try String plainText new String cipher doFinal in UTF 8 if plainText endsWith MAGIC return new Secret plainText substring 0 plainText length MAGIC length return null catch GeneralSecurityException e return null if the key doesn t match with the bytes it can result in BadPaddingException public static Cipher getCipher String algorithm throws GeneralSecurityException return PROVIDER null Cipher getInstance algorithm PROVIDER Cipher getInstance algorithm Nonnull public static Secret fromString CheckForNull String data data Util fixNull data Secret s decrypt data if s null s new Secret data return s Nonnull public static String toString CheckForNull Secret s return s null s value public static final class ConverterImpl implements Converter public ConverterImpl public boolean canConvert Class type return type Secret class public void marshal Object source HierarchicalStreamWriter writer MarshallingContext context Secret src Secret source writer setValue src getEncryptedValue public Object unmarshal HierarchicalStreamReader reader final UnmarshallingContext context return fromString reader getValue private static final String MAGIC MAGIC private static final String PROVIDER SystemProperties getString Secret class getName provider static String SECRET null private static final CryptoConfidentialKey KEY new CryptoConfidentialKey Secret class getName private static final long serialVersionUID 1L static Stapler CONVERT UTILS register new org apache commons beanutils Converter public Secret convert Class type Object value return Secret fromString value toString Secret classpackage hudson util import com trilead ssh2 crypto Base64 import hudson model TaskListener import org apache commons io FileUtils import javax crypto Cipher import javax crypto SecretKey import java io BufferedReader import java io BufferedWriter import java io File import java io FileInputStream import java io IOException import java io InputStreamReader import java io PrintWriter import java nio file LinkOption import java security GeneralSecurityException import java security InvalidKeyException import java util HashSet import java util Set public class SecretRewriter private final Cipher cipher private final SecretKey key private int count private final File backupDirectory private Set String callstack new HashSet String public SecretRewriter File backupDirectory throws GeneralSecurityException cipher Secret getCipher AES key Secret getLegacyKey this backupDirectory backupDirectory private String tryRewrite String s throws IOException InvalidKeyException if s length 24 return s Encrypting in Secret produces 24 letter characters so this must be the minimum length if isBase64 s return s decode throws IOException if the input is not base64 and this is also a very quick way to filter byte in try in Base64 decode s toCharArray catch IOException e return s not a valid base64 cipher init Cipher DECRYPT MODE key Secret sec Secret tryDecrypt cipher in if sec null matched return sec getEncryptedValue replace by the new encrypted value else not encrypted with the legacy key leave it unmodified return s public boolean rewrite File f File backup throws InvalidKeyException IOException AtomicFileWriter w new AtomicFileWriter f UTF 8 try boolean modified false did we actually change anything try PrintWriter out new PrintWriter new BufferedWriter w try FileInputStream fin new FileInputStream f BufferedReader r new BufferedReader new InputStreamReader fin UTF 8 String line StringBuilder buf new StringBuilder while line r readLine null int copied 0 buf setLength 0 while true int sidx line indexOf copied if sidx 0 break int eidx line indexOf sidx if eidx 0 break String elementText line substring sidx 1 eidx String replacement tryRewrite elementText if replacement equals elementText modified true buf append line substring copied sidx 1 buf append replacement copied eidx buf append line substring copied out println buf toString if modified if backup null backup getParentFile mkdirs FileUtils copyFile f backup w commit return modified finally w abort synchronized to prevent accidental concurrent use this instance is not thread safe public synchronized int rewriteRecursive File dir TaskListener listener throws InvalidKeyException return rewriteRecursive dir listener private int rewriteRecursive File dir String relative TaskListener listener throws InvalidKeyException String canonical try canonical dir toPath toRealPath new LinkOption 0 toString catch IOException e canonical dir getAbsolutePath if callstack add canonical listener getLogger println Cycle detected dir return 0 try File children dir listFiles if children null return 0 int rewritten 0 for File child children String cn child getName if cn endsWith xml if count 100 0 listener getLogger println Scanning child try File backup null if backupDirectory null backup new File backupDirectory relative cn if rewrite child backup if backup null listener getLogger println Copied child to backup as a backup listener getLogger println Rewritten child rewritten catch IOException e e printStackTrace listener error Failed to rewrite child if child isDirectory if isIgnoredDir child rewritten rewriteRecursive child relative length 0 cn relative cn listener return rewritten finally callstack remove canonical protected boolean isIgnoredDir File dir ignoring the workspace and the artifacts directories Both of them are potentially large and they do not store any secrets String n dir getName return n equals workspace n equals artifacts n equals plugins no mutable data here n equals jenkins security RekeySecretAdminMonitor we don t want to rewrite backups n equals n equals private static boolean isBase64 char ch return 0 ch ch 128 IS BASE64 ch private static boolean isBase64 String s for int i 0 i s length i if isBase64 s charAt i return false return true private static final boolean IS BASE64 new boolean 128 static String chars ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789 for int i 0 i chars length i IS BASE64 chars charAt i truepackage jenkins security import hudson Extension import hudson ExtensionPoint import jenkins util SystemProperties import hudson model Api import java util logging Logger import jenkins model Jenkins import org kohsuke accmod Restricted import org kohsuke accmod restrictions NoExternalUse import org kohsuke stapler StaplerRequest public interface SecureRequester extends ExtensionPoint boolean permit StaplerRequest req Object bean Restricted NoExternalUse class Extension class Default implements SecureRequester private static final String PROP hudson model Api INSECURE private static final boolean INSECURE SystemProperties getBoolean PROP static if INSECURE Logger getLogger SecureRequester class getName warning PROP system property is deprecated implement SecureRequester instead Override public boolean permit StaplerRequest req Object bean return INSECURE Jenkins getInstance isUseSecuritypackage org codehaus groovy runtime import java io Serializable public class Security218 implements Serializablepackage jenkins security import jenkins util InterceptingExecutorService import org acegisecurity context SecurityContext import java util concurrent Callable import java util concurrent ExecutorService import static org acegisecurity context SecurityContextHolder public class SecurityContextExecutorService extends InterceptingExecutorService public SecurityContextExecutorService ExecutorService service super service Override protected Runnable wrap final Runnable r final SecurityContext callingContext getContext return new Runnable public void run SecurityContext old getContext setContext callingContext try r run finally setContext old Override protected V Callable V wrap final Callable V c final SecurityContext callingContext getContext return new Callable V public V call throws Exception SecurityContext old getContext setContext callingContext try return c call finally setContext oldpackage jenkins diagnostics import hudson Extension import hudson model AdministrativeMonitor import jenkins model Jenkins import org jenkinsci Symbol import org kohsuke stapler StaplerRequest import org kohsuke stapler StaplerResponse import java io IOException Extension Symbol securityIsOff public class SecurityIsOffMonitor extends AdministrativeMonitor Override public String getDisplayName return Messages SecurityIsOffMonitor DisplayName Override public boolean isActivated return Jenkins getInstance isUseSecurity public void doAct StaplerRequest req StaplerResponse rsp throws IOException if req hasParameter no disable true rsp sendRedirect req getContextPath manage else rsp sendRedirect req getContextPath configureSecuritypackage jenkins security import hudson ExtensionList import hudson ExtensionPoint import hudson security AbstractPasswordBasedSecurityRealm import hudson security SecurityRealm import java util ArrayList import java util List import java util logging Level import java util logging Logger import javax annotation Nonnull import org acegisecurity GrantedAuthority import org acegisecurity userdetails UserDetails public abstract class SecurityListener implements ExtensionPoint private static final Logger LOGGER Logger getLogger SecurityListener class getName protected abstract void authenticated Nonnull UserDetails details protected abstract void failedToAuthenticate Nonnull String username protected abstract void loggedIn Nonnull String username protected abstract void failedToLogIn Nonnull String username protected abstract void loggedOut Nonnull String username public static void fireAuthenticated Nonnull UserDetails details if LOGGER isLoggable Level FINE List String groups new ArrayList String for GrantedAuthority auth details getAuthorities if auth equals SecurityRealm AUTHENTICATED AUTHORITY groups add auth getAuthority LOGGER log Level FINE authenticated 0 1 new Object details getUsername groups for SecurityListener l all l authenticated details public static void fireFailedToAuthenticate Nonnull String username LOGGER log Level FINE failed to authenticate 0 username for SecurityListener l all l failedToAuthenticate username public static void fireLoggedIn Nonnull String username LOGGER log Level FINE logged in 0 username for SecurityListener l all l loggedIn username public static void fireFailedToLogIn Nonnull String username LOGGER log Level FINE failed to log in 0 username for SecurityListener l all l failedToLogIn username public static void fireLoggedOut Nonnull String username LOGGER log Level FINE logged out 0 username for SecurityListener l all l loggedOut username private static List SecurityListener all return ExtensionList lookup SecurityListener classpackage hudson security public enum SecurityMode UNSECURED LEGACY SECUREDpackage hudson security import groovy lang Binding import hudson ExtensionPoint import hudson DescriptorExtensionList import hudson Extension import hudson cli CLICommand import hudson model AbstractDescribableImpl import hudson model Descriptor import jenkins model IdStrategy import jenkins model Jenkins import hudson security FederatedLoginService FederatedIdentity import hudson security captcha CaptchaSupport import hudson util DescriptorList import hudson util PluginServletFilter import hudson util spring BeanBuilder import org acegisecurity Authentication import org acegisecurity AuthenticationManager import org acegisecurity GrantedAuthorityImpl import org acegisecurity GrantedAuthority import org acegisecurity context SecurityContext import org acegisecurity context SecurityContextHolder import org acegisecurity ui rememberme RememberMeServices import static org acegisecurity ui rememberme TokenBasedRememberMeServices ACEGI SECURITY HASHED REMEMBER ME COOKIE KEY import org acegisecurity userdetails UserDetailsService import org acegisecurity userdetails UserDetails import org acegisecurity userdetails UsernameNotFoundException import org apache commons lang StringUtils import org kohsuke accmod Restricted import org kohsuke accmod restrictions DoNotUse import org kohsuke stapler HttpResponse import org kohsuke stapler Stapler import org kohsuke stapler StaplerRequest import org kohsuke stapler StaplerResponse import org springframework context ApplicationContext import org springframework web context WebApplicationContext import org springframework dao DataAccessException import javax servlet Filter import javax servlet FilterConfig import javax servlet ServletException import javax servlet http HttpSession import javax servlet http Cookie import java io IOException import java io UnsupportedEncodingException import java util List import java util Map import java util logging Logger public abstract class SecurityRealm extends AbstractDescribableImpl SecurityRealm implements ExtensionPoint private CaptchaSupport captchaSupport public abstract SecurityComponents createSecurityComponents public IdStrategy getUserIdStrategy return IdStrategy CASE INSENSITIVE public IdStrategy getGroupIdStrategy return getUserIdStrategy public CliAuthenticator createCliAuthenticator final CLICommand command return new CliAuthenticator public Authentication authenticate return command getTransportAuthentication Override public Descriptor SecurityRealm getDescriptor return super getDescriptor public String getAuthenticationGatewayUrl return j acegi security check public String getLoginUrl return login public boolean canLogOut return true protected String getPostLogOutUrl StaplerRequest req Authentication auth return req getContextPath public CaptchaSupport getCaptchaSupport return captchaSupport public void setCaptchaSupport CaptchaSupport captchaSupport this captchaSupport captchaSupport public List Descriptor CaptchaSupport getCaptchaSupportDescriptors return CaptchaSupport all public void doLogout StaplerRequest req StaplerResponse rsp throws IOException ServletException HttpSession session req getSession false if session null session invalidate Authentication auth SecurityContextHolder getContext getAuthentication SecurityContextHolder clearContext reset remember me cookie Cookie cookie new Cookie ACEGI SECURITY HASHED REMEMBER ME COOKIE KEY cookie setPath req getContextPath length 0 req getContextPath rsp addCookie cookie rsp sendRedirect2 getPostLogOutUrl req auth public boolean allowsSignup Class clz getClass return clz getClassLoader getResource clz getName replace signup jelly null public UserDetails loadUserByUsername String username throws UsernameNotFoundException DataAccessException return getSecurityComponents userDetails loadUserByUsername username public GroupDetails loadGroupByGroupname String groupname throws UsernameNotFoundException DataAccessException throw new UserMayOrMayNotExistException groupname public GroupDetails loadGroupByGroupname String groupname boolean fetchMembers throws UsernameNotFoundException DataAccessException return loadGroupByGroupname groupname public HttpResponse commenceSignup FederatedIdentity identity throw new UnsupportedOperationException public final void doCaptcha StaplerRequest req StaplerResponse rsp throws IOException if captchaSupport null String id req getSession getId rsp setContentType image png rsp addHeader Cache Control no cache captchaSupport generateImage id rsp getOutputStream protected final boolean validateCaptcha String text if captchaSupport null String id Stapler getCurrentRequest getSession getId return captchaSupport validateCaptcha id text If no Captcha Support then bogus validation always returns true return true public static T T findBean Class T type ApplicationContext context Map m context getBeansOfType type switch m size case 0 throw new IllegalArgumentException No beans of type are defined case 1 return type cast m values iterator next default throw new IllegalArgumentException Multiple beans of type are defined m private transient SecurityComponents securityComponents public synchronized SecurityComponents getSecurityComponents if this securityComponents null this securityComponents this createSecurityComponents return this securityComponents public Filter createFilter FilterConfig filterConfig LOGGER entering SecurityRealm class getName createFilter Binding binding new Binding SecurityComponents sc getSecurityComponents binding setVariable securityComponents sc binding setVariable securityRealm this BeanBuilder builder new BeanBuilder builder parse filterConfig getServletContext getResourceAsStream WEB INF security SecurityFilters groovy binding WebApplicationContext context builder createApplicationContext return Filter context getBean filter public static final SecurityRealm NO AUTHENTICATION new None Restricted DoNotUse class public static String getFrom String from null returnValue null final StaplerRequest request Stapler getCurrentRequest Try to obtain a return point either from the Session or from the QueryParameter in this order if request null request getSession false null from String request getSession getAttribute from else if request null from request getParameter from If entry point was not found try to deduce it from the request URI except pages related to login process if from null request null request getRequestURI null request getRequestURI equals loginError request getRequestURI equals login from request getRequestURI If deduced entry point isn t deduced yet or the content is a blank value use the root web point as a fallback from StringUtils defaultIfBlank from trim Encode the return value try returnValue java net URLEncoder encode from UTF 8 catch UnsupportedEncodingException e Return encoded value or at least in the case exception occurred during encode or if the encoded content is blank value return StringUtils isBlank returnValue returnValue private static class None extends SecurityRealm public SecurityComponents createSecurityComponents return new SecurityComponents new AuthenticationManager public Authentication authenticate Authentication authentication return authentication new UserDetailsService public UserDetails loadUserByUsername String username throws UsernameNotFoundException DataAccessException throw new UsernameNotFoundException username Override public Descriptor SecurityRealm getDescriptor return null Override public GroupDetails loadGroupByGroupname String groupname throws UsernameNotFoundException DataAccessException throw new UsernameNotFoundException groupname Override public Filter createFilter FilterConfig filterConfig return new ChainedServletFilter private Object readResolve return NO AUTHENTICATION public static final class SecurityComponents public final AuthenticationManager manager public final UserDetailsService userDetails public final RememberMeServices rememberMe public SecurityComponents we use AuthenticationManagerProxy here just as an implementation that fails all the time not as a proxy No one is supposed to use this as a proxy this new AuthenticationManagerProxy public SecurityComponents AuthenticationManager manager we use UserDetailsServiceProxy here just as an implementation that fails all the time not as a proxy No one is supposed to use this as a proxy this manager new UserDetailsServiceProxy public SecurityComponents AuthenticationManager manager UserDetailsService userDetails this manager userDetails createRememberMeService userDetails public SecurityComponents AuthenticationManager manager UserDetailsService userDetails RememberMeServices rememberMe assert manager null userDetails null rememberMe null this manager manager this userDetails userDetails this rememberMe rememberMe SuppressWarnings deprecation private static RememberMeServices createRememberMeService UserDetailsService uds create our default TokenBasedRememberMeServices which depends on the availability of the secret key TokenBasedRememberMeServices2 rms new TokenBasedRememberMeServices2 rms setUserDetailsService uds rms setKey Jenkins getInstance getSecretKey rms setParameter remember me this is the form field name in login jelly return rms Deprecated public static final DescriptorList SecurityRealm LIST new DescriptorList SecurityRealm SecurityRealm class public static DescriptorExtensionList SecurityRealm Descriptor SecurityRealm all return Jenkins getInstance SecurityRealm Descriptor SecurityRealm getDescriptorList SecurityRealm class private static final Logger LOGGER Logger getLogger SecurityRealm class getName public static final GrantedAuthority AUTHENTICATED AUTHORITY new GrantedAuthorityImpl authenticatedpackage hudson cli import java io OutputStream import java io IOException import java io SequenceInputStream abstract class SequenceOutputStream extends OutputStream protected static class Block final OutputStream out long capacity public Block OutputStream out long capacity this out out this capacity capacity private Block block protected SequenceOutputStream Block block this block block Override public void write byte b int off int len throws IOException while len 0 int sz int Math min len block capacity block out write b off sz block capacity sz len sz off sz swapIfNeeded public void write int b throws IOException block out write b block capacity swapIfNeeded private void swapIfNeeded throws IOException if block capacity 0 return block out close block next block Override public void flush throws IOException block out flush Override public void close throws IOException block out close block null protected abstract Block next Block current throws IOExceptionpackage hudson util import javax annotation Nonnull import java util HashMap import java util Map import java util Set import java util HashSet import java util concurrent Executor import java util concurrent ExecutorService public class SequentialExecutionQueue implements Executor private final Map Runnable QueueEntry entries new HashMap Runnable QueueEntry private ExecutorService executors private final Set QueueEntry inProgress new HashSet QueueEntry public SequentialExecutionQueue ExecutorService executors this executors executors public synchronized ExecutorService getExecutors return executors public synchronized void setExecutors ExecutorService svc ExecutorService old this executors this executors svc gradually executions will be taken over by a new pool old shutdown public synchronized void execute Nonnull Runnable item QueueEntry e entries get item if e null e new QueueEntry item entries put item e e submit else e queued true public synchronized boolean isStarving long threshold long now System currentTimeMillis for QueueEntry e entries values if now e submissionTime threshold return true return false public synchronized Set Runnable getInProgress Set Runnable items new HashSet Runnable for QueueEntry entry inProgress items add entry item return items private final class QueueEntry implements Runnable private final Runnable item private boolean queued private long submissionTime private QueueEntry Runnable item this item item this queued true Caller must have a lock private void submit submissionTime System currentTimeMillis executors submit this public void run try synchronized SequentialExecutionQueue this assert queued queued false inProgress add this item run finally synchronized SequentialExecutionQueue this if queued another polling for this job is requested while we were doing the polling do it again submit else entries remove item inProgress remove thispackage jenkins util import net sf json JSONObject import org kohsuke stapler DataBoundConstructor public class ServerTcpPort private int value private String type DataBoundConstructor public ServerTcpPort int value String type this value value this type type public ServerTcpPort JSONObject o type o getString type value o optInt value public int getPort if type equals fixed return value if type equals random return 0 return 1package hudson util import java io BufferedReader import java io IOException import java io InputStreamReader import java net URL import java util Collection import java util Enumeration import java util List import java util ArrayList import java util logging Level import java util logging Logger import static java util logging Level WARNING public class Service public static T List T loadInstances ClassLoader classLoader Class T type throws IOException List T result new ArrayList T final Enumeration URL e classLoader getResources META INF services type getName while e hasMoreElements URL url e nextElement try BufferedReader configFile new BufferedReader new InputStreamReader url openStream UTF 8 String line while line configFile readLine null line line trim if line startsWith line length 0 continue try Class t classLoader loadClass line if type isAssignableFrom t continue invalid type result add type cast t newInstance catch ClassNotFoundException x LOGGER log WARNING Failed to load line x catch InstantiationException x LOGGER log WARNING Failed to load line x catch IllegalAccessException x LOGGER log WARNING Failed to load line x return result public static T void load Class T spi ClassLoader cl Collection Class extends T result try Enumeration URL e cl getResources META INF services spi getName while e hasMoreElements final URL url e nextElement try BufferedReader r new BufferedReader new InputStreamReader url openStream UTF 8 String line while line r readLine null if line startsWith continue comment line line line trim if line length 0 continue empty line ignore try result add cl loadClass line asSubclass spi catch ClassNotFoundException x LOGGER log Level WARNING Failed to load line x catch IOException x LOGGER log Level WARNING Failed to load url x catch IOException x LOGGER log Level WARNING Failed to look up service providers for spi x private static final Logger LOGGER Logger getLogger Service class getNamepackage com kaku colorfulnews di component import android content Context import com kaku colorfulnews di module ServiceModule import com kaku colorfulnews di scope ContextLife import com kaku colorfulnews di scope PerService import dagger Component PerService Component dependencies ApplicationComponent class modules ServiceModule class public interface ServiceComponent ContextLife Service Context getServiceContext ContextLife Application Context getApplicationContextpackage com kaku colorfulnews di module import android app Service import android content Context import com kaku colorfulnews di scope ContextLife import com kaku colorfulnews di scope PerService import dagger Module import dagger Provides Module public class ServiceModule private Service mService public ServiceModule Service service mService service Provides PerService ContextLife Service public Context ProvideServiceContext return mServicepackage com twitter sdk android core import com google gson annotations SerializedName public class Session T extends AuthToken SerializedName auth token private final T authToken SerializedName id private final long id public Session T authToken long id if authToken null throw new IllegalArgumentException AuthToken must not be null this authToken authToken this id id public T getAuthToken return authToken public long getId return id Override public boolean equals Object o if this o return true if o null getClass o getClass return false final Session session Session o if id session id return false return authToken null authToken equals session authToken session authToken null Override public int hashCode int result authToken null authToken hashCode 0 result 31 result int id id 32 return resultpackage hudson cli import hudson Extension import jenkins model Jenkins Extension public class SessionIdCommand extends CLICommand Override public String getShortDescription return Messages SessionIdCommand ShortDescription protected int run stdout println Jenkins SESSION HASH return 0package com twitter sdk android core import java util Map public interface SessionManager T extends Session T getActiveSession void setActiveSession T session void clearActiveSession T getSession long id void setSession long id T session void clearSession long id Map Long T getSessionMappackage com twitter sdk android core internal import android app Activity import android text format DateUtils import io fabric sdk android ActivityLifecycleManager import io fabric sdk android services common SystemCurrentTimeProvider import com twitter sdk android core Session import com twitter sdk android core SessionManager import java util Calendar import java util TimeZone import java util concurrent ExecutorService public class SessionMonitor T extends Session protected final MonitorState monitorState private final SystemCurrentTimeProvider time private final SessionManager T sessionManager private final ExecutorService executorService private final SessionVerifier sessionVerifier public SessionMonitor SessionManager T sessionManager ExecutorService executorService SessionVerifier T sessionVerifier this sessionManager new SystemCurrentTimeProvider executorService new MonitorState sessionVerifier SessionMonitor SessionManager T sessionManager SystemCurrentTimeProvider time ExecutorService executorService MonitorState monitorState SessionVerifier sessionVerifier this time time this sessionManager sessionManager this executorService executorService this monitorState monitorState this sessionVerifier sessionVerifier public void monitorActivityLifecycle ActivityLifecycleManager activityLifecycleManager activityLifecycleManager registerCallbacks new ActivityLifecycleManager Callbacks Override public void onActivityStarted Activity activity triggerVerificationIfNecessary public void triggerVerificationIfNecessary final Session session sessionManager getActiveSession final long currentTime time getCurrentTimeMillis final boolean startVerification session null monitorState beginVerification currentTime if startVerification executorService submit new Runnable Override public void run verifyAll protected void verifyAll for T session sessionManager getSessionMap values sessionVerifier verifySession session monitorState endVerification time getCurrentTimeMillis protected static class MonitorState private static final long TIME THRESHOLD IN MILLIS 6 DateUtils HOUR IN MILLIS public boolean verifying public long lastVerification private final Calendar utcCalendar public MonitorState this utcCalendar Calendar getInstance TimeZone getTimeZone UTC public synchronized boolean beginVerification long currentTime final boolean isPastThreshold currentTime lastVerification TIME THRESHOLD IN MILLIS final boolean dayHasChanged isOnSameDate currentTime lastVerification if verifying isPastThreshold dayHasChanged return verifying true return false public synchronized void endVerification long currentTime verifying false lastVerification currentTime private boolean isOnSameDate long timeA long timeB utcCalendar setTimeInMillis timeA final int dayA utcCalendar get Calendar DAY OF YEAR final int yearA utcCalendar get Calendar YEAR utcCalendar setTimeInMillis timeB final int dayB utcCalendar get Calendar DAY OF YEAR final int yearB utcCalendar get Calendar YEAR return dayA dayB yearA yearBpackage com twitter sdk android core internal import com twitter sdk android core Session public interface SessionVerifier T extends Session void verifySession T sessionpackage hudson cli import hudson Extension import hudson model AbstractProject import hudson model Run import java io Serializable import org apache commons io IOUtils import org kohsuke args4j Argument Extension public class SetBuildDescriptionCommand extends CLICommand implements Serializable Override public String getShortDescription return Messages SetBuildDescriptionCommand ShortDescription Argument metaVar JOB usage Name of the job to build required true index 0 public transient AbstractProject job Argument metaVar BUILD usage Number of the build required true index 1 public int number Argument metaVar DESCRIPTION required true usage Description to be set to read from stdin index 2 public String description protected int run throws Exception Run run job getBuildByNumber number if run null throw new IllegalArgumentException No such build number run checkPermission Run UPDATE if equals description description IOUtils toString stdin run setDescription description return 0package hudson cli import hudson Extension import hudson model AbstractProject import hudson model Run import org apache commons io IOUtils import org kohsuke args4j Argument import java io Serializable Extension public class SetBuildDisplayNameCommand extends CLICommand implements Serializable private static final long serialVersionUID 6665171784136358536L Override public String getShortDescription return Messages SetBuildDisplayNameCommand ShortDescription Argument metaVar JOB usage Name of the job to build required true index 0 public transient AbstractProject job Argument metaVar BUILD usage Number of the build required true index 1 public int number Argument metaVar DISPLAYNAME required true usage DisplayName to be set to read from stdin index 2 public String displayName Override protected int run throws Exception Run run job getBuildByNumber number if run null throw new IllegalArgumentException Build number does not exist run checkPermission Run UPDATE if equals displayName displayName IOUtils toString stdin run setDisplayName displayName return 0package hudson cli import hudson Extension import hudson model ParametersAction import hudson model Run import hudson model StringParameterValue import org kohsuke args4j Argument import java util Collections Extension public class SetBuildParameterCommand extends CommandDuringBuild Argument index 0 metaVar NAME required true usage Name of the build variable public String name Argument index 1 metaVar VALUE required true usage Value of the build variable public String value Override public String getShortDescription return Messages SetBuildParameterCommand ShortDescription Override protected int run throws Exception Run r getCurrentlyBuilding r checkPermission Run UPDATE StringParameterValue p new StringParameterValue name value ParametersAction a r getAction ParametersAction class if a null r replaceAction a createUpdated Collections singleton p else r addAction new ParametersAction p return 0package hudson cli import hudson Extension import hudson model Result import hudson model Run import org kohsuke args4j Argument Extension public class SetBuildResultCommand extends CommandDuringBuild Argument metaVar RESULT required true public Result result Override public String getShortDescription return Messages SetBuildResultCommand ShortDescription Override protected int run throws Exception Run r getCurrentlyBuilding r checkPermission Run UPDATE r setResult result return 0package jenkins mvn import hudson ExtensionPoint import hudson FilePath import hudson model AbstractBuild import hudson model AbstractDescribableImpl import hudson model Descriptor import hudson model TaskListener import javax servlet ServletException import net sf json JSONObject import org kohsuke stapler StaplerRequest public abstract class SettingsProvider extends AbstractDescribableImpl SettingsProvider implements ExtensionPoint public abstract FilePath supplySettings AbstractBuild build TaskListener listener public static SettingsProvider parseSettingsProvider StaplerRequest req throws Descriptor FormException ServletException JSONObject settings req getSubmittedForm getJSONObject settings if settings null return new DefaultSettingsProvider return req bindJSON SettingsProvider class settings public static final FilePath getSettingsFilePath SettingsProvider settings AbstractBuild build TaskListener listener FilePath settingsPath null if settings null settingsPath settings supplySettings build listener return settingsPath public static final String getSettingsRemotePath SettingsProvider settings AbstractBuild build TaskListener listener FilePath fp getSettingsFilePath settings build listener return fp null null fp getRemotepackage jenkins mvn import com infradna tool bridge method injector WithBridgeMethods import hudson DescriptorExtensionList import hudson model Descriptor import java util List import jenkins model Jenkins public abstract class SettingsProviderDescriptor extends Descriptor SettingsProvider WithBridgeMethods List class public static DescriptorExtensionList SettingsProvider SettingsProviderDescriptor all return Jenkins getInstance SettingsProvider SettingsProviderDescriptor getDescriptorList SettingsProvider classpackage jenkins install import static org apache commons io FileUtils readFileToString import static org apache commons lang StringUtils defaultIfBlank import java io IOException import java util Locale import java util UUID import java util logging Level import java util logging Logger import javax annotation CheckForNull import javax servlet Filter import javax servlet FilterChain import javax servlet FilterConfig import javax servlet ServletException import javax servlet ServletRequest import javax servlet ServletResponse import javax servlet http HttpServletRequest import javax servlet http HttpServletRequestWrapper import javax servlet http HttpServletResponse import jenkins util SystemProperties import org acegisecurity Authentication import org acegisecurity context SecurityContextHolder import org acegisecurity providers UsernamePasswordAuthenticationToken import org acegisecurity userdetails UsernameNotFoundException import org kohsuke accmod Restricted import org kohsuke accmod restrictions NoExternalUse import org kohsuke stapler HttpResponse import org kohsuke stapler StaplerRequest import org kohsuke stapler StaplerResponse import hudson BulkChange import hudson Extension import hudson FilePath import hudson ProxyConfiguration import hudson model PageDecorator import hudson model UpdateCenter import hudson model UpdateSite import hudson model User import hudson security FullControlOnceLoggedInAuthorizationStrategy import hudson security HudsonPrivateSecurityRealm import hudson security SecurityRealm import hudson security csrf DefaultCrumbIssuer import hudson util HttpResponses import hudson util PluginServletFilter import hudson util VersionNumber import java io File import java net HttpRetryException import java net HttpURLConnection import java net URL import java net URLConnection import java util Iterator import java util List import jenkins model Jenkins import jenkins security s2m AdminWhitelistRule import net sf json JSONArray import net sf json JSONObject import org apache commons io FileUtils import org apache commons io IOUtils import org kohsuke accmod restrictions DoNotUse Restricted NoExternalUse class Extension public class SetupWizard extends PageDecorator public static String initialSetupAdminUserName admin private static final Logger LOGGER Logger getLogger SetupWizard class getName private static boolean isUsingSecurityToken false void init boolean newInstall throws IOException InterruptedException Jenkins jenkins Jenkins getInstance if newInstall this was determined to be a new install don t run the update wizard here setCurrentLevel Jenkins getVersion Create an admin user by default with a difficult password FilePath iapf getInitialAdminPasswordFile if jenkins getSecurityRealm null jenkins getSecurityRealm SecurityRealm NO AUTHENTICATION this seems very fragile try BulkChange bc new BulkChange jenkins HudsonPrivateSecurityRealm securityRealm new HudsonPrivateSecurityRealm false false null jenkins setSecurityRealm securityRealm String randomUUID UUID randomUUID toString replace toLowerCase Locale ENGLISH create an admin user securityRealm createAccount SetupWizard initialSetupAdminUserName randomUUID JENKINS 33599 write to a file in the jenkins home directory most native packages of Jenkins creates a machine user account jenkins to run Jenkins and use group jenkins for admins So we allow groups to read this file iapf touch System currentTimeMillis iapf chmod 0640 iapf write randomUUID System lineSeparator UTF 8 Lock Jenkins down FullControlOnceLoggedInAuthorizationStrategy authStrategy new FullControlOnceLoggedInAuthorizationStrategy authStrategy setAllowAnonymousRead false jenkins setAuthorizationStrategy authStrategy Disable jnlp by default but honor system properties jenkins setSlaveAgentPort SystemProperties getInteger Jenkins class getName slaveAgentPort 1 require a crumb issuer jenkins setCrumbIssuer new DefaultCrumbIssuer false set master slave security jenkins getInjector getInstance AdminWhitelistRule class setMasterKillSwitch false jenkins save bc commit if iapf exists String setupKey iapf readToString trim String ls System lineSeparator LOGGER info ls ls ls ls ls ls Jenkins initial setup is required An admin user has been created and a password generated ls Please use the following password to proceed to installation ls ls setupKey ls ls This may also be found at iapf getRemote ls ls ls ls ls try PluginServletFilter addFilter FORCE SETUP WIZARD FILTER if we re not using security defaults we should not show the security token screen users will likely be sent to a login screen instead isUsingSecurityToken isUsingSecurityDefaults catch ServletException e throw new RuntimeException Unable to add PluginServletFilter for the SetupWizard e try Make sure plugin metadata is up to date UpdateCenter updateDefaultSite catch Exception e LOGGER log Level WARNING e getMessage e public boolean isUsingSecurityToken try return isUsingSecurityToken only ever show the unlock page if using the security token Jenkins getInstance getInstallState isSetupComplete isUsingSecurityDefaults catch Exception e ignore return false boolean isUsingSecurityDefaults Jenkins j Jenkins getInstance if j getSecurityRealm instanceof HudsonPrivateSecurityRealm HudsonPrivateSecurityRealm securityRealm HudsonPrivateSecurityRealm j getSecurityRealm try if securityRealm getAllUsers size 1 HudsonPrivateSecurityRealm Details details securityRealm loadUserByUsername SetupWizard initialSetupAdminUserName FilePath iapf getInitialAdminPasswordFile if iapf exists if details isPasswordCorrect iapf readToString trim return true catch UsernameNotFoundException IOException InterruptedException e return false Not initial security setup if no transitional admin user password found return false public void doCreateAdminUser StaplerRequest req StaplerResponse rsp throws IOException ServletException Jenkins j Jenkins getInstance j checkPermission Jenkins ADMINISTER This will be set up by default if not something changed ok to fail HudsonPrivateSecurityRealm securityRealm HudsonPrivateSecurityRealm j getSecurityRealm User admin securityRealm getUser SetupWizard initialSetupAdminUserName try if admin null admin delete assume the new user may well be admin User u securityRealm createAccountByAdmin req rsp jenkins install SetupWizard setupWizardFirstUser jelly req getContextPath if u null if admin null admin null Success Delete the temporary password file try getInitialAdminPasswordFile delete catch InterruptedException e throw new IOException e InstallUtil proceedToNextStateFrom InstallState CREATE ADMIN USER and then login Authentication a new UsernamePasswordAuthenticationToken u getId req getParameter password1 a securityRealm getSecurityComponents manager authenticate a SecurityContextHolder getContext setAuthentication a finally if admin null admin save recreate this initial user if something failed void setCurrentLevel VersionNumber v throws IOException FileUtils writeStringToFile getUpdateStateFile v toString static File getUpdateStateFile return new File Jenkins getInstance getRootDir jenkins install UpgradeWizard state Restricted NoExternalUse class CheckForNull public VersionNumber getCurrentLevel VersionNumber from new VersionNumber 1 0 File state getUpdateStateFile if state exists try from new VersionNumber defaultIfBlank readFileToString state 1 0 trim catch IOException ex LOGGER log Level SEVERE Cannot read the current version file ex return null return from Restricted DoNotUse class WebOnly public HttpResponse doPlatformPluginList throws IOException jenkins install SetupWizard setupWizard Jenkins getInstance getSetupWizard if setupWizard null if InstallState UPGRADE equals Jenkins getInstance getInstallState JSONArray initialPluginData getPlatformPluginUpdates if initialPluginData null return HttpResponses okJSON initialPluginData else JSONArray initialPluginData getPlatformPluginList if initialPluginData null return HttpResponses okJSON initialPluginData return HttpResponses okJSON Restricted DoNotUse class WebOnly public HttpResponse doRestartStatus throws IOException JSONObject response new JSONObject Jenkins jenkins Jenkins getInstance response put restartRequired jenkins getUpdateCenter isRestartRequiredForCompletion response put restartSupported jenkins getLifecycle canRestart return HttpResponses okJSON response CheckForNull public JSONArray getPlatformPluginUpdates final VersionNumber version getCurrentLevel if version null return null return getPlatformPluginsForUpdate version Jenkins getVersion CheckForNull JSONArray getPlatformPluginList Jenkins getInstance checkPermission Jenkins ADMINISTER JSONArray initialPluginList null updateSiteList for UpdateSite updateSite Jenkins getInstance getUpdateCenter getSiteList String updateCenterJsonUrl updateSite getUrl String suggestedPluginUrl updateCenterJsonUrl replace update center json platform plugins json try URLConnection connection ProxyConfiguration open new URL suggestedPluginUrl try if connection instanceof HttpURLConnection int responseCode HttpURLConnection connection getResponseCode if HttpURLConnection HTTP OK responseCode throw new HttpRetryException Invalid response code responseCode from URL suggestedPluginUrl responseCode String initialPluginJson IOUtils toString connection getInputStream utf 8 initialPluginList JSONArray fromObject initialPluginJson break updateSiteList catch Exception e not found or otherwise unavailable LOGGER log Level FINE e getMessage e continue updateSiteList catch Exception e LOGGER log Level FINE e getMessage e if initialPluginList null fall back to local file try ClassLoader cl getClass getClassLoader URL localPluginData cl getResource jenkins install platform plugins json String initialPluginJson IOUtils toString localPluginData openStream utf 8 initialPluginList JSONArray fromObject initialPluginJson catch Exception e LOGGER log Level SEVERE e getMessage e return initialPluginList JSONArray getPlatformPluginsForUpdate VersionNumber from VersionNumber to Jenkins jenkins Jenkins getInstance JSONArray pluginCategories JSONArray fromObject getPlatformPluginList toString for Iterator categoryIterator pluginCategories iterator categoryIterator hasNext Object category categoryIterator next if category instanceof JSONObject JSONObject cat JSONObject category JSONArray plugins cat getJSONArray plugins nextPlugin for Iterator pluginIterator plugins iterator pluginIterator hasNext Object pluginData pluginIterator next if pluginData instanceof JSONObject JSONObject plugin JSONObject pluginData if plugin has added String sinceVersion plugin getString added if sinceVersion null VersionNumber v new VersionNumber sinceVersion if v compareTo to 0 v compareTo from 0 This plugin is valid we ll leave suggested state to match the experience during install but only add it if it s currently uninstalled String pluginName plugin getString name if null jenkins getPluginManager getPlugin pluginName Also check that a compatible version exists in an update site boolean foundCompatibleVersion false for UpdateSite site jenkins getUpdateCenter getSiteList UpdateSite Plugin sitePlug site getPlugin pluginName if sitePlug null sitePlug isForNewerHudson sitePlug isNeededDependenciesForNewerJenkins foundCompatibleVersion true break if foundCompatibleVersion continue nextPlugin pluginIterator remove if plugins isEmpty categoryIterator remove return pluginCategories public FilePath getInitialAdminPasswordFile return Jenkins getInstance getRootPath child secrets initialAdminPassword public HttpResponse doCompleteInstall throws IOException ServletException completeSetup return HttpResponses okJSON void completeSetup throws IOException ServletException Jenkins getInstance checkPermission Jenkins ADMINISTER InstallUtil saveLastExecVersion setCurrentLevel Jenkins getVersion PluginServletFilter removeFilter FORCE SETUP WIZARD FILTER isUsingSecurityToken false this should not be considered new anymore InstallUtil proceedToNextStateFrom InstallState INITIAL SETUP COMPLETED public List InstallState getInstallStates return InstallState all public InstallState getInstallState String name if name null return null return InstallState valueOf name private final Filter FORCE SETUP WIZARD FILTER new Filter Override public void init FilterConfig cfg throws ServletException Override public void doFilter ServletRequest request ServletResponse response FilterChain chain throws IOException ServletException Force root requests to the setup wizard if request instanceof HttpServletRequest HttpServletRequest req HttpServletRequest request String requestURI req getRequestURI if requestURI equals req getContextPath requestURI endsWith HttpServletResponse response sendRedirect req getContextPath return else if req getRequestURI equals req getContextPath Jenkins getInstance checkPermission Jenkins ADMINISTER chain doFilter new HttpServletRequestWrapper req public String getRequestURI return getContextPath setupWizard response return fall through to handling the request normally chain doFilter request response Override public void destroypackage hudson util ssh import com trilead ssh2 Connection import com trilead ssh2 SFTPException import com trilead ssh2 SFTPv3Client import com trilead ssh2 SFTPv3FileAttributes import com trilead ssh2 SFTPv3FileHandle import com trilead ssh2 sftp ErrorCodes import java io IOException import java io InputStream import java io OutputStream Deprecated public class SFTPClient extends SFTPv3Client public SFTPClient Connection conn throws IOException super conn public boolean exists String path throws IOException return stat path null public SFTPv3FileAttributes stat String path throws IOException try return stat path catch SFTPException e int c e getServerErrorCode if c ErrorCodes SSH FX NO SUCH FILE c ErrorCodes SSH FX NO SUCH PATH return null else throw e public void mkdirs String path int posixPermission throws IOException SFTPv3FileAttributes atts stat path if atts null atts isDirectory return int idx path lastIndexOf if idx 0 mkdirs path substring 0 idx posixPermission try mkdir path posixPermission catch IOException e throw new IOException Failed to mkdir path e public OutputStream writeToFile String path throws IOException final SFTPv3FileHandle h createFile path return new OutputStream private long offset 0 public void write int b throws IOException write new byte byte b Override public void write byte b int off int len throws IOException SFTPClient this write h offset b off len offset len Override public void close throws IOException closeFile h public InputStream read String file throws IOException final SFTPv3FileHandle h openFileRO file return new InputStream private long offset 0 public int read throws IOException byte b new byte 1 if read b 0 return 1 return b 0 Override public int read byte b int off int len throws IOException int r SFTPClient this read h offset b off len if r 0 return 1 offset r return r Override public long skip long n throws IOException offset n return n Override public void close throws IOException closeFile h public void chmod String path int permissions throws IOException SFTPv3FileAttributes atts new SFTPv3FileAttributes atts permissions permissions setstat path attspackage com zxy recovery tools import android content Context import android content SharedPreferences import android os Process import android support annotation NonNull import android text TextUtils import java util Map import java util Set import java util concurrent ExecutorService import java util concurrent Executors import java util concurrent ThreadFactory public class SharedPreferencesCompat private SharedPreferencesCompat throw new SharedPreferencesException Stub private static SharedPreferences getSharedPrefs Context context String sharedPrefsName checkNotNull context Context can not be null checkNotEmpty sharedPrefsName SharedPreferences name can not be empty return context getSharedPreferences sharedPrefsName Context MODE PRIVATE public static void put Context context String sharedPrefsName String key String value checkNotEmpty key SharedPreferences key can not be empty checkNotNull value SharedPreferences value can not be null SharedPreferences Editor editor getSharedPrefs context sharedPrefsName edit editor putString key value SharedPreferencesEditorCompat apply editor public static String get Context context String sharedPrefsName String key String defValue checkNotEmpty key SharedPreferences key can not be empty return getSharedPrefs context sharedPrefsName getString key defValue public static void clear Context context String sharedPrefsName SharedPreferences Editor editor getSharedPrefs context sharedPrefsName edit editor clear SharedPreferencesEditorCompat apply editor public static void remove Context context String sharedPrefsName String key checkNotEmpty key SharedPreferences key can not be empty SharedPreferences Editor editor getSharedPrefs context sharedPrefsName edit editor remove key SharedPreferencesEditorCompat apply editor public static Map String getAll Context context String sharedPrefsName checkNotNull context Context can not be null return getSharedPrefs context sharedPrefsName getAll public static boolean contains Context context String sharedPrefsName String key checkNotEmpty key SharedPreferences key can not be empty return getSharedPrefs context sharedPrefsName contains key public static Set String getStringSet Context context String sharedPrefsName String key Set String defValues checkNotEmpty key SharedPreferences key can not be empty return getSharedPrefs context sharedPrefsName getStringSet key defValues public static Builder newBuilder Context context String sharedPrefsName return new Builder context sharedPrefsName public static final class Builder private SharedPreferences Editor mEditor private Builder Context context String sharedPrefsName mEditor getSharedPrefs context sharedPrefsName edit public Builder put String key String value checkNotEmpty key SharedPreferences key can not be empty checkNotNull value SharedPreferences value can not be null mEditor putString key value return this public void apply SharedPreferencesEditorCompat apply mEditor private static T void checkNotNull T t String message if t null throw new SharedPreferencesException String valueOf message private static void checkNotEmpty String t String message if TextUtils isEmpty t throw new SharedPreferencesException String valueOf message private static final class SharedPreferencesException extends RuntimeException public SharedPreferencesException String message Throwable cause super message cause public SharedPreferencesException String message super message private static final class SharedPreferencesEditorCompat private static final ExecutorService SINGLE THREAD POOL static SINGLE THREAD POOL Executors newFixedThreadPool 1 new SharedPreferencesThreadFactory static void apply final SharedPreferences Editor editor try editor apply catch Throwable e SINGLE THREAD POOL submit new Runnable Override public void run editor commit private static final class SharedPreferencesThreadFactory implements ThreadFactory private static final String THREAD NAME SharedPreferencesThread Override public Thread newThread NonNull final Runnable r Runnable wrapper new Runnable Override public void run try Process setThreadPriority Process THREAD PRIORITY BACKGROUND catch Throwable t t printStackTrace r run Thread thread new Thread wrapper THREAD NAME if thread isDaemon thread setDaemon false return threadpackage com twitter sdk android core identity import android app Activity import android content Context import android content Intent import android content pm PackageManager import android os Bundle import android os ResultReceiver import android view View import android widget TextView import com twitter sdk android core R import com twitter sdk android core TwitterCore import com twitter sdk android core TwitterSession import io fabric sdk android Fabric public class ShareEmailActivity extends Activity static final String EXTRA RESULT RECEIVER result receiver static final String EXTRA SESSION ID session id ShareEmailController controller private TwitterSession session Override protected void onCreate Bundle savedInstanceState super onCreate savedInstanceState setContentView R layout tw activity share email try final Intent startIntent getIntent final ResultReceiver resultReceiver getResultReceiver startIntent session getSession startIntent controller new ShareEmailController new ShareEmailClient session resultReceiver final TextView shareEmailDescView TextView findViewById R id tw share email desc setUpShareEmailDesc this shareEmailDescView catch IllegalArgumentException e Fabric getLogger e TwitterCore TAG Failed to create ShareEmailActivity e finish private ResultReceiver getResultReceiver Intent intent final ResultReceiver resultReceiver intent getParcelableExtra EXTRA RESULT RECEIVER if resultReceiver null throw new IllegalArgumentException ResultReceiver must not be null This activity should not be started directly return resultReceiver private TwitterSession getSession Intent intent TODO Make session parcelable and pass actual session final long sessionId intent getLongExtra EXTRA SESSION ID TwitterSession UNKNOWN USER ID final TwitterSession session TwitterCore getInstance getSessionManager getSession sessionId if session null throw new IllegalArgumentException No TwitterSession for id sessionId return session void setUpShareEmailDesc Context context TextView shareEmailDescView final PackageManager packageManager context getPackageManager shareEmailDescView setText getResources getString R string tw share email desc packageManager getApplicationLabel context getApplicationInfo session getUserName public void onClickNotNow View view controller cancelRequest finish public void onClickAllow View view controller executeRequest finish Override public void onBackPressed controller cancelRequest super onBackPressedpackage com twitter sdk android core identity import android content Context import android content Intent import android content pm ApplicationInfo import android content pm PackageManager import android widget Button import android widget TextView import io fabric sdk android FabricActivityTestCase import io fabric sdk android FabricTestUtils import com twitter sdk android core Callback import com twitter sdk android core R import com twitter sdk android core SessionManager import com twitter sdk android core TwitterAuthConfig import com twitter sdk android core TwitterCore import com twitter sdk android core TwitterSession import static org mockito Matchers any import static org mockito Mockito mock import static org mockito Mockito verify import static org mockito Mockito when public class ShareEmailActivityTest extends FabricActivityTestCase ShareEmailActivity private static final String TEST APP NAME app name private static final String TEST USER NAME user name private static final long TEST SESSION ID 1L private static final long TEST SESSION ID2 2L private Context context private TwitterSession mockSession private ShareEmailController mockController public ShareEmailActivityTest super ShareEmailActivity class Override protected void setUp throws Exception super setUp context getInstrumentation getTargetContext final TwitterCore twitterCore new TwitterCore new TwitterAuthConfig FabricTestUtils resetFabric FabricTestUtils with context twitterCore mockSession mock TwitterSession class when mockSession getUserName thenReturn TEST USER NAME when mockSession getId thenReturn TEST SESSION ID mockController mock TestShareEmailController class final SessionManager TwitterSession sessionManager TwitterCore getInstance getSessionManager sessionManager setActiveSession mockSession Override protected void tearDown throws Exception FabricTestUtils resetFabric super tearDown private void init final ShareEmailResultReceiver resultReceiver new ShareEmailResultReceiver mock Callback class final Intent intent new Intent context ShareEmailActivity class putExtra ShareEmailActivity EXTRA RESULT RECEIVER resultReceiver putExtra ShareEmailActivity EXTRA SESSION ID TEST SESSION ID init intent private void init Intent intent final ShareEmailActivity activity startActivity intent null null activity controller mockController public void testOnCreate extraResultReceiverMissing final Intent intent new Intent context ShareEmailActivity class init intent assertTrue isFinishCalled public void testOnCreate extraSessionIdMissing final ShareEmailResultReceiver resultReceiver new ShareEmailResultReceiver mock Callback class final Intent intent new Intent context ShareEmailActivity class putExtra ShareEmailActivity EXTRA RESULT RECEIVER resultReceiver init intent assertTrue isFinishCalled public void testOnCreate extraSessionIdUnknown final ShareEmailResultReceiver resultReceiver new ShareEmailResultReceiver mock Callback class final Intent intent new Intent context ShareEmailActivity class putExtra ShareEmailActivity EXTRA RESULT RECEIVER resultReceiver putExtra ShareEmailActivity EXTRA SESSION ID TwitterSession UNKNOWN USER ID init intent assertTrue isFinishCalled public void testOnCreate extraSessionIdNotFound final ShareEmailResultReceiver resultReceiver new ShareEmailResultReceiver mock Callback class final Intent intent new Intent context ShareEmailActivity class putExtra ShareEmailActivity EXTRA RESULT RECEIVER resultReceiver putExtra ShareEmailActivity EXTRA SESSION ID TEST SESSION ID2 init intent assertTrue isFinishCalled public void testOnClickNotNow init final Button button Button getActivity findViewById R id tw not now btn button performClick verify mockController cancelRequest public void testOnClickAllow init final Button button Button getActivity findViewById R id tw allow btn button performClick verify mockController executeRequest public void testSetUpShareEmailDesc init final TextView textView new TextView context final Context mockContext mock Context class final PackageManager mockPackageManager mock PackageManager class when mockContext getPackageManager thenReturn mockPackageManager when mockPackageManager getApplicationLabel any ApplicationInfo class thenReturn TEST APP NAME getActivity setUpShareEmailDesc mockContext textView assertEquals context getString R string tw share email desc TEST APP NAME TEST USER NAME textView getText toString public void testOnBackPressed init getActivity onBackPressed verify mockController cancelRequestpackage com twitter sdk android core identity import android app Activity import com twitter sdk android core Callback import com twitter sdk android core TwitterApiClient import com twitter sdk android core TwitterSession import com twitter sdk android core models User import retrofit2 Call import retrofit2 http GET import retrofit2 http Query class ShareEmailClient extends TwitterApiClient static final int RESULT CODE CANCELED Activity RESULT CANCELED static final int RESULT CODE OK Activity RESULT OK static final int RESULT CODE ERROR Activity RESULT FIRST USER static final String RESULT DATA EMAIL email static final String RESULT DATA MSG msg static final String RESULT DATA ERROR error ShareEmailClient TwitterSession session super session protected void getEmail Callback User callback getService EmailService class verifyCredentials true true enqueue callback interface EmailService GET 1 1 account verify credentials json include email true Call User verifyCredentials Query include entities Boolean includeEntities Query skip status Boolean skipStatuspackage com twitter sdk android core identity import io fabric sdk android FabricAndroidTestCase import io fabric sdk android FabricTestUtils import retrofit2 Call import com twitter sdk android core Callback import com twitter sdk android core TestFixtures import com twitter sdk android core TwitterAuthConfig import com twitter sdk android core TwitterCore import com twitter sdk android core TwitterSession import com twitter sdk android core models User import static org mockito Matchers anyBoolean import static org mockito Matchers eq import static org mockito Mockito mock import static org mockito Mockito verify import static org mockito Mockito when public class ShareEmailClientTest extends FabricAndroidTestCase private ShareEmailClient EmailService mockEmailService private ShareEmailClient shareEmailClient public void setUp throws Exception super setUp FabricTestUtils resetFabric FabricTestUtils with getContext new TwitterCore new TwitterAuthConfig TestFixtures KEY TestFixtures SECRET mockEmailService mock ShareEmailClient EmailService class when mockEmailService verifyCredentials anyBoolean anyBoolean thenReturn mock Call class shareEmailClient new ShareEmailClient mock TwitterSession class Override protected T T getService Class T cls if cls equals EmailService class return T mockEmailService else return super getService cls Override protected void tearDown throws Exception FabricTestUtils resetFabric super tearDown public void testGetEmail throws Exception final Callback User mockCallback mock Callback class shareEmailClient getEmail mockCallback verify mockEmailService verifyCredentials eq true eq truepackage com twitter sdk android core identity import android os Bundle import android os ResultReceiver import com twitter sdk android core Callback import com twitter sdk android core Result import com twitter sdk android core TwitterCore import com twitter sdk android core TwitterException import com twitter sdk android core models User import io fabric sdk android Fabric class ShareEmailController private static final String EMPTY EMAIL private final ShareEmailClient emailClient private final ResultReceiver resultReceiver public ShareEmailController ShareEmailClient emailClient ResultReceiver resultReceiver this emailClient emailClient this resultReceiver resultReceiver public void executeRequest emailClient getEmail newCallback Callback User newCallback return new Callback User Override public void success Result User result handleSuccess result data Override public void failure TwitterException exception Fabric getLogger e TwitterCore TAG Failed to get email address exception Create new exception that can be safely serialized since Retrofit errors may throw a NotSerializableException sendResultCodeError new TwitterException Failed to get email address void handleSuccess User user if user email null sendResultCodeError new TwitterException Your application may not have access to email addresses or the user may not have an email address To request access please visit https support twitter com forms platform else if EMPTY EMAIL equals user email sendResultCodeError new TwitterException This user does not have an email address else sendResultCodeOk user email void sendResultCodeOk String email final Bundle bundle new Bundle bundle putString ShareEmailClient RESULT DATA EMAIL email resultReceiver send ShareEmailClient RESULT CODE OK bundle void sendResultCodeError TwitterException exception final Bundle bundle new Bundle bundle putSerializable ShareEmailClient RESULT DATA ERROR exception resultReceiver send ShareEmailClient RESULT CODE ERROR bundle public void cancelRequest final Bundle bundle new Bundle bundle putSerializable ShareEmailClient RESULT DATA MSG The user chose not to share their email address at this time resultReceiver send ShareEmailClient RESULT CODE CANCELED bundlepackage com twitter sdk android core identity import android os Bundle import android os ResultReceiver import com twitter sdk android core Callback import com twitter sdk android core Result import com twitter sdk android core TwitterException class ShareEmailResultReceiver extends ResultReceiver private final Callback String callback public ShareEmailResultReceiver Callback String callback super null if callback null throw new IllegalArgumentException Callback must not be null this callback callback Override public void onReceiveResult int resultCode Bundle resultData switch resultCode case ShareEmailClient RESULT CODE OK callback success new Result resultData getString ShareEmailClient RESULT DATA EMAIL null break case ShareEmailClient RESULT CODE CANCELED callback failure new TwitterException resultData getString ShareEmailClient RESULT DATA MSG break case ShareEmailClient RESULT CODE ERROR callback failure TwitterException resultData getSerializable ShareEmailClient RESULT DATA ERROR break default throw new IllegalArgumentException Invalid result code resultCodepackage com twitter sdk android tweetui import android content Context import android content Intent import android content res Resources import android view View import com twitter sdk android core IntentUtils import com twitter sdk android core models Tweet import io fabric sdk android Fabric class ShareTweetAction implements View OnClickListener final Tweet tweet final TweetUi tweetUi final TweetScribeClient tweetScribeClient ShareTweetAction Tweet tweet TweetUi tweetUi this tweet tweetUi new TweetScribeClientImpl tweetUi For testing only ShareTweetAction Tweet tweet TweetUi tweetUi TweetScribeClient tweetScribeClient super this tweet tweet this tweetUi tweetUi this tweetScribeClient tweetScribeClient Override public void onClick View v onClick v getContext v getResources void scribeShareAction tweetScribeClient share tweet void onClick Context context Resources resources if tweet null tweet user null return scribeShareAction final String shareSubject getShareSubject resources final String shareContent getShareContent resources final Intent shareIntent getShareIntent shareSubject shareContent final String shareText resources getString R string tw share tweet final Intent chooser Intent createChooser shareIntent shareText launchShareIntent chooser context String getShareContent Resources resources return resources getString R string tw share content format tweet user screenName tweet id String getShareSubject Resources resources return resources getString R string tw share subject format tweet user name tweet user screenName void launchShareIntent Intent chooser Context context if IntentUtils safeStartActivity context chooser Fabric getLogger e TweetUi LOGTAG Activity cannot be found to handle share intent Intent getShareIntent String subject String content final Intent intent new Intent intent setAction Intent ACTION SEND intent putExtra Intent EXTRA SUBJECT subject intent putExtra Intent EXTRA TEXT content intent setType text plain return intentpackage hudson tasks import hudson FilePath import hudson Functions import hudson Util import hudson Extension import hudson model AbstractProject import hudson remoting VirtualChannel import hudson util FormValidation import java io IOException import java io ObjectStreamException import hudson util LineEndingConversion import jenkins security MasterToSlaveCallable import net sf json JSONObject import org jenkinsci Symbol import org kohsuke accmod Restricted import org kohsuke accmod restrictions DoNotUse import org kohsuke stapler DataBoundConstructor import org kohsuke stapler DataBoundSetter import org kohsuke stapler StaplerRequest import org kohsuke stapler QueryParameter import java util List import java util ArrayList import java util Arrays import java util logging Level import java util logging Logger import javax annotation CheckForNull public class Shell extends CommandInterpreter DataBoundConstructor public Shell String command super LineEndingConversion convertEOL command LineEndingConversion EOLType Unix private Integer unstableReturn private static String addLineFeedForNonASCII String s if s startsWith if s indexOf n 0 return n s return s public String buildCommandLine FilePath script if command startsWith interpreter override int end command indexOf n if end 0 end command length List String args new ArrayList String args addAll Arrays asList Util tokenize command substring 0 end trim args add script getRemote args set 0 args get 0 substring 2 trim off return args toArray new String args size else return new String getDescriptor getShellOrDefault script getChannel xe script getRemote protected String getContents return addLineFeedForNonASCII LineEndingConversion convertEOL command LineEndingConversion EOLType Unix protected String getFileExtension return sh CheckForNull public final Integer getUnstableReturn return new Integer 0 equals unstableReturn null unstableReturn DataBoundSetter public void setUnstableReturn Integer unstableReturn this unstableReturn unstableReturn Override protected boolean isErrorlevelForUnstableBuild int exitCode return this unstableReturn null exitCode 0 this unstableReturn equals exitCode Override public DescriptorImpl getDescriptor return DescriptorImpl super getDescriptor private Object readResolve throws ObjectStreamException return new Shell command Extension Symbol shell public static class DescriptorImpl extends BuildStepDescriptor Builder private String shell public DescriptorImpl load public boolean isApplicable Class extends AbstractProject jobType return true public String getShell return shell Deprecated public String getShellOrDefault if shell null return Functions isWindows sh bin sh return shell public String getShellOrDefault VirtualChannel channel if shell null return shell String interpreter null try interpreter channel call new Shellinterpreter catch IOException e LOGGER log Level WARNING null e catch InterruptedException e LOGGER log Level WARNING null e if interpreter null interpreter getShellOrDefault return interpreter public void setShell String shell this shell Util fixEmptyAndTrim shell save public String getDisplayName return Messages Shell DisplayName Restricted DoNotUse class public FormValidation doCheckUnstableReturn QueryParameter String value value Util fixEmptyAndTrim value if value null return FormValidation ok long unstableReturn try unstableReturn Long parseLong value catch NumberFormatException e return FormValidation error hudson model Messages Hudson NotANumber if unstableReturn 0 return FormValidation warning hudson tasks Messages Shell invalid exit code zero if unstableReturn 1 unstableReturn 255 return FormValidation error hudson tasks Messages Shell invalid exit code range unstableReturn return FormValidation ok Override public boolean configure StaplerRequest req JSONObject data throws FormException req bindJSON this data return super configure req data public FormValidation doCheckShell QueryParameter String value Executable requires admin permission return FormValidation validateExecutable value private static final class Shellinterpreter extends MasterToSlaveCallable String IOException private static final long serialVersionUID 1L public String call throws IOException return Functions isWindows sh bin sh private static final Logger LOGGER Logger getLogger Shell class getNamepackage hudson util jna import com sun jna Native import com sun jna win32 StdCallLibrary public interface Shell32 extends StdCallLibrary Shell32 INSTANCE Shell32 Native loadLibrary shell32 Shell32 class boolean ShellExecuteEx SHELLEXECUTEINFO lpExecInfopackage hudson util jna import com sun jna Pointer import com sun jna Structure import com sun jna Union import java util Arrays import java util List public class SHELLEXECUTEINFO extends Structure public int cbSize size public int fMask public Pointer hwnd public String lpVerb public String lpFile public String lpParameters public String lpDirectory public int nShow 1 public Pointer hInstApp public Pointer lpIDList public String lpClass public Pointer hkeyClass public int dwHotKey public DUMMYUNIONNAME union DUMMYUNIONNAME public Pointer hProcess public static final int SEE MASK NOCLOSEPROCESS 0x40 public static final int SW HIDE 0 public static final int SW SHOW 0 Override protected List getFieldOrder return Arrays asList cbSize fMask hwnd lpVerb lpFile lpParameters lpDirectory nShow hInstApp lpIDList lpClass hkeyClass dwHotKey DUMMYUNIONNAME hProcess public static class DUMMYUNIONNAME union extends Union public Pointer hIcon public Pointer hMonitor public DUMMYUNIONNAME union super public DUMMYUNIONNAME union Pointer hIcon or hMonitor super this hMonitor this hIcon hIcon or hMonitor setType Pointer class public static class ByReference extends DUMMYUNIONNAME union implements Structure ByReference public static class ByValue extends DUMMYUNIONNAME union implements Structure ByValuepackage hudson util import org jfree chart axis CategoryAxis import org jfree ui RectangleEdge import java awt geom Rectangle2D public final class ShiftedCategoryAxis extends NoOverlapCategoryAxis public ShiftedCategoryAxis String label super label Override protected double calculateCategorySize int categoryCount Rectangle2D area RectangleEdge edge we cut the left half of the first item and the right half of the last item so we have more space return super calculateCategorySize categoryCount 1 area edge Override public double getCategoryEnd int category int categoryCount Rectangle2D area RectangleEdge edge return super getCategoryStart category categoryCount area edge calculateCategorySize categoryCount area edge 2 Override public double getCategoryMiddle int category int categoryCount Rectangle2D area RectangleEdge edge return super getCategoryStart category categoryCount area edge Override public double getCategoryStart int category int categoryCount Rectangle2D area RectangleEdge edge return super getCategoryStart category categoryCount area edge calculateCategorySize categoryCount area edge 2package jenkins management import hudson Extension import hudson model ManagementLink import jenkins model Jenkins import org jenkinsci Symbol Extension ordinal Integer MIN VALUE Symbol shutDown public class ShutdownLink extends ManagementLink Override public String getIconFileName return system log out png public String getDisplayName return Jenkins getInstance isQuietingDown Messages ShutdownLink DisplayName cancel Messages ShutdownLink DisplayName prepare Override public String getDescription return Jenkins getInstance isQuietingDown Messages ShutdownLink Description Override public String getUrlName return Jenkins getInstance isQuietingDown cancelQuietDown quietDown Override public boolean getRequiresPOST return truepackage hudson security import org acegisecurity Authentication import org acegisecurity GrantedAuthority import org acegisecurity acls sid PrincipalSid import org acegisecurity acls sid GrantedAuthoritySid import org acegisecurity acls sid Sid import javax annotation Nonnull import java util logging Logger import static java util logging Level FINE import static java util logging Level FINER public abstract class SidACL extends ACL Override public boolean hasPermission Nonnull Authentication a Permission permission if a SYSTEM if LOGGER isLoggable FINE LOGGER fine hasPermission a permission SYSTEM user has full access return true Boolean b hasPermission a permission if LOGGER isLoggable FINE LOGGER fine hasPermission a permission b null null thus false b if b null b false default to rejection return b protected Boolean hasPermission Nonnull Authentication a Permission permission ACL entries for this principal takes precedence Boolean b hasPermission new PrincipalSid a permission if LOGGER isLoggable FINER LOGGER finer hasPermission PrincipalSID a getPrincipal permission b if b null return b after that we check if the groups this principal belongs to has any ACL entries here we are using GrantedAuthority as a group for GrantedAuthority ga a getAuthorities b hasPermission new GrantedAuthoritySid ga permission if LOGGER isLoggable FINER LOGGER finer hasPermission GroupSID ga getAuthority permission b if b null return b permissions granted to everyone and anonymous users are granted to everyone for Sid sid AUTOMATIC SIDS b hasPermission sid permission if LOGGER isLoggable FINER LOGGER finer hasPermission sid permission b if b null return b return null protected abstract Boolean hasPermission Sid p Permission permission protected String toString Sid p if p instanceof GrantedAuthoritySid return GrantedAuthoritySid p getGrantedAuthority if p instanceof PrincipalSid return PrincipalSid p getPrincipal if p EVERYONE return role everyone hmm return p toString public final SidACL newInheritingACL final SidACL parent final SidACL child this return new SidACL protected Boolean hasPermission Sid p Permission permission Boolean b child hasPermission p permission if b null return b return parent hasPermission p permission private static final Logger LOGGER Logger getLogger SidACL class getNamepackage jenkins tasks import hudson AbortException import hudson Extension import hudson FilePath import hudson Launcher import hudson model AbstractProject import hudson model Action import hudson model InvisibleAction import hudson model Job import hudson model Run import hudson model TaskListener import hudson tasks BuildStep import hudson tasks Builder import hudson tasks Publisher import java io IOException import java util Collection import java util LinkedList import java util List import javax annotation Nonnull import jenkins model DependencyDeclarer import jenkins model RunAction2 import jenkins model TransientActionFactory import org kohsuke accmod Restricted import org kohsuke accmod restrictions DoNotUse public interface SimpleBuildStep extends BuildStep void perform Nonnull Run run Nonnull FilePath workspace Nonnull Launcher launcher Nonnull TaskListener listener throws InterruptedException IOException interface LastBuildAction extends Action Collection extends Action getProjectActions SuppressWarnings rawtypes Restricted DoNotUse class Extension public static final class LastBuildActionFactory extends TransientActionFactory Job Override public Class Job type return Job class Nonnull Override public Collection extends Action createFor Nonnull Job j List Action actions new LinkedList Run r j getLastSuccessfulBuild if r null for LastBuildAction a r getActions LastBuildAction class actions addAll a getProjectActions TODO should there be an option to check lastCompletedBuild even if it failed Not useful for say TestResultAction since if you have a build that fails before recording test results the job would then have no TestResultProjectAction return actionspackage jenkins tasks import hudson AbortException import hudson EnvVars import hudson FilePath import hudson Launcher import hudson console ConsoleLogFilter import hudson model AbstractBuild import hudson model AbstractProject import hudson model Action import hudson model BuildListener import hudson model Run import hudson model TaskListener import hudson tasks BuildWrapper import java io IOException import java io OutputStream import java io Serializable import java util Collection import java util Collections import java util HashMap import java util Map import java util Set import javax annotation CheckForNull import javax annotation Nonnull SuppressWarnings rawtypes inherited public abstract class SimpleBuildWrapper extends BuildWrapper public abstract void setUp Context context Run build FilePath workspace Launcher launcher TaskListener listener EnvVars initialEnvironment throws IOException InterruptedException public static final class Context private Disposer disposer private final Map String String env new HashMap String String public Nonnull Map String String getEnv return env public void env String key String value if env containsKey key throw new IllegalStateException just one binding for key env put key value public CheckForNull Disposer getDisposer return disposer public void setDisposer Nonnull Disposer disposer if this disposer null throw new IllegalStateException just one disposer this disposer disposer public static abstract class Disposer implements Serializable public abstract void tearDown Run build FilePath workspace Launcher launcher TaskListener listener throws IOException InterruptedException protected boolean runPreCheckout return false Override public final Environment setUp AbstractBuild build final Launcher launcher BuildListener listener throws IOException InterruptedException if runPreCheckout return new Environment else final Context c new Context setUp c build build getWorkspace launcher listener build getEnvironment listener return new EnvironmentWrapper c launcher Override public final void preCheckout AbstractBuild build final Launcher launcher BuildListener listener throws IOException InterruptedException if runPreCheckout final Context c new Context setUp c build build getWorkspace launcher listener build getEnvironment listener build getEnvironments add new EnvironmentWrapper c launcher private class EnvironmentWrapper extends Environment private final Context c private final Launcher launcher EnvironmentWrapper Context c Launcher launcher this c c this launcher launcher Override public void buildEnvVars Map String String env if env instanceof EnvVars EnvVars env overrideAll c env else env putAll c env Override public boolean tearDown AbstractBuild build BuildListener listener throws IOException InterruptedException if c disposer null c disposer tearDown build build getWorkspace launcher listener return true public CheckForNull ConsoleLogFilter createLoggerDecorator Nonnull Run build return null Override public final OutputStream decorateLogger AbstractBuild build OutputStream logger throws IOException InterruptedException Run RunnerAbortedException ConsoleLogFilter filter createLoggerDecorator build return filter null filter decorateLogger build logger logger Override public Launcher decorateLauncher AbstractBuild build Launcher launcher BuildListener listener throws IOException InterruptedException Run RunnerAbortedException return super decorateLauncher build launcher listener TODO reasonable to decorate Launcher within a dynamic scope but this signature does not mix well with Context pattern Called from AbstractBuildExecution createLauncher how do we track what is decorating what Would have to keep something like a LaunchedDecorator not an actual Launcher in Context And createLauncher is called before even preCheckout so much too early for the Context to have been prepared Could perhaps create a proxy Launcher whose launch method checks some field in the Context remembered for the build Override public void makeBuildVariables AbstractBuild build Map String String variables super makeBuildVariables build variables Override public void makeSensitiveBuildVariables AbstractBuild build Set String sensitiveVariables super makeSensitiveBuildVariables build sensitiveVariables TODO determine if there is a meaningful way to generalize this perhaps as a new Run Action recording sensitiveVariables Complicated by the fact that in principle someone could call getSensitiveBuildVariables before the wrapper starts and actually sets those variables though in practice the likely use cases would come later and perhaps it is acceptable to omit the names of variables which are yet to be set Also unclear if there is any use case for calling this method after the build is done or Jenkins is restarted most likely it is only used during the build itself Would be much cleaner if EnvVars itself recorded which keys had sensitive values Override public final Collection extends Action getProjectActions AbstractProject job return Collections emptySetpackage hudson model import org kohsuke stapler StaplerRequest import hudson cli CLICommand import java io IOException public abstract class SimpleParameterDefinition extends ParameterDefinition protected SimpleParameterDefinition String name super name protected SimpleParameterDefinition String name String description super name description public abstract ParameterValue createValue String value Override public final ParameterValue createValue StaplerRequest req String value req getParameterValues getName if value null return getDefaultParameterValue else if value length 1 throw new IllegalArgumentException Illegal number of parameter values for getName value length else return createValue value 0 Override public final ParameterValue createValue CLICommand command String value throws IOException InterruptedException return createValue valuepackage hudson slaves import antlr ANTLRException import hudson Extension import static hudson Util fixNull import hudson model Computer import hudson model Descriptor import hudson model Queue import hudson scheduler CronTabList import hudson util FormValidation import org jenkinsci Symbol import org kohsuke stapler DataBoundConstructor import org kohsuke stapler QueryParameter import javax annotation concurrent GuardedBy import java io InvalidObjectException import java io ObjectStreamException import java util Calendar import java util GregorianCalendar import java util concurrent ExecutionException import java util logging Level import java util logging Logger import static java util logging Level INFO public class SimpleScheduledRetentionStrategy extends RetentionStrategy SlaveComputer private static final Logger LOGGER Logger getLogger SimpleScheduledRetentionStrategy class getName private final String startTimeSpec private transient CronTabList tabs private transient Calendar lastChecked private transient long nextStop Long MIN VALUE private transient long nextStart Long MIN VALUE private transient long lastStop Long MAX VALUE private transient long lastStart Long MAX VALUE private final int upTimeMins private final boolean keepUpWhenActive DataBoundConstructor public SimpleScheduledRetentionStrategy String startTimeSpec int upTimeMins boolean keepUpWhenActive throws ANTLRException this startTimeSpec startTimeSpec this keepUpWhenActive keepUpWhenActive this tabs CronTabList create startTimeSpec this lastChecked new GregorianCalendar this upTimeMins Math max 1 upTimeMins this lastChecked add Calendar MINUTE 1 public int getUpTimeMins return upTimeMins public boolean isKeepUpWhenActive return keepUpWhenActive public String getStartTimeSpec return startTimeSpec private synchronized void updateStartStopWindow if lastStart Long MAX VALUE lastStop Long MAX VALUE we need to initialize get some useful default values for the lastStart and lastStop they should be in the past and at least less than any useful real last start stop so default lastStart now upTime 3 and lastStop now upTime 2 Calendar time new GregorianCalendar time add Calendar MINUTE upTimeMins time add Calendar MINUTE upTimeMins time add Calendar MINUTE upTimeMins lastStart time getTimeInMillis time add Calendar MINUTE upTimeMins lastStop time getTimeInMillis we re only interested in the last start if it is less than the upTimeMins ago any older and last Start is not relevant as the node should be stopped time new GregorianCalendar time add Calendar MINUTE upTimeMins time add Calendar MINUTE 1 while System currentTimeMillis 1000 time getTimeInMillis if tabs check time lastStart time getTimeInMillis time add Calendar MINUTE upTimeMins lastStop time getTimeInMillis break time add Calendar MINUTE 1 nextStart lastStart nextStop lastStop if nextStop System currentTimeMillis next stop is in the past lastStart nextStart lastStop nextStop we don t want to look too far into the future Calendar time new GregorianCalendar time add Calendar MINUTE Math min 15 upTimeMins long stopLooking time getTimeInMillis time setTimeInMillis nextStop while stopLooking time getTimeInMillis if tabs check time nextStart time getTimeInMillis time add Calendar MINUTE upTimeMins nextStop time getTimeInMillis break time add Calendar MINUTE 1 protected synchronized Object readResolve throws ObjectStreamException try tabs CronTabList create startTimeSpec lastChecked new GregorianCalendar this lastChecked add Calendar MINUTE 1 nextStop Long MIN VALUE nextStart Long MIN VALUE lastStop Long MAX VALUE lastStart Long MAX VALUE catch ANTLRException e InvalidObjectException x new InvalidObjectException e getMessage x initCause e throw x return this Override public boolean isManualLaunchAllowed final SlaveComputer c return isOnlineScheduled GuardedBy hudson model Queue lock public synchronized long check final SlaveComputer c boolean shouldBeOnline isOnlineScheduled LOGGER log Level FINE Checking computer 0 against schedule online 1 shouldBeOnline 2 new Object c getName c isOnline shouldBeOnline if shouldBeOnline c isOffline LOGGER log INFO Trying to launch computer 0 as schedule says it should be on line at this point in time new Object c getName if c isLaunchSupported Computer threadPoolForRemoting submit new Runnable public void run try c connect true get if c isOnline LOGGER log INFO Launched computer 0 per schedule new Object c getName if keepUpWhenActive c isOnline c isAcceptingTasks LOGGER log INFO Enabling new jobs for computer 0 as it has started its scheduled uptime new Object c getName c setAcceptingTasks true catch InterruptedException ExecutionException e else if shouldBeOnline c isOnline if keepUpWhenActive if c isIdle c isAcceptingTasks c setAcceptingTasks false LOGGER log INFO Disabling new jobs for computer 0 as it has finished its scheduled uptime new Object c getName return 1 else if c isIdle c isAcceptingTasks Queue withLock new Runnable Override public void run if c isIdle LOGGER log INFO Disconnecting computer 0 as it has finished its scheduled uptime new Object c getName c disconnect OfflineCause create Messages SimpleScheduledRetentionStrategy FinishedUpTime else c setAcceptingTasks false else if c isIdle c isAcceptingTasks Queue withLock new Runnable Override public void run if c isIdle LOGGER log INFO Disconnecting computer 0 as it has finished all jobs running when it completed its scheduled uptime new Object c getName c disconnect OfflineCause create Messages SimpleScheduledRetentionStrategy FinishedUpTime else no need to get the queue lock as the user has selected the break builds option LOGGER log INFO Disconnecting computer 0 as it has finished its scheduled uptime new Object c getName c disconnect OfflineCause create Messages SimpleScheduledRetentionStrategy FinishedUpTime return 1 private boolean isOnlineScheduled updateStartStopWindow long now System currentTimeMillis return lastStart now lastStop now nextStart now nextStop now Extension Symbol schedule public static class DescriptorImpl extends Descriptor RetentionStrategy public String getDisplayName return Messages SimpleScheduledRetentionStrategy displayName public FormValidation doCheck QueryParameter String value try String msg CronTabList create fixNull value checkSanity if msg null return FormValidation warning msg return FormValidation ok catch ANTLRException e return FormValidation error e getMessagepackage hudson model import com google common collect ImmutableSet import hudson DescriptorExtensionList import hudson FilePath import hudson Launcher import hudson Launcher RemoteLauncher import hudson Util import hudson model Descriptor FormException import hudson remoting Callable import hudson slaves CommandLauncher import hudson slaves ComputerLauncher import hudson slaves DumbSlave import hudson slaves JNLPLauncher import hudson slaves NodeDescriptor import hudson slaves NodeProperty import hudson slaves NodePropertyDescriptor import hudson slaves RetentionStrategy import hudson slaves SlaveComputer import hudson util ClockDifference import hudson util DescribableList import hudson util FormValidation import java io File import java io IOException import java io InputStream import java io Serializable import java net MalformedURLException import java net URL import java net URLConnection import java util ArrayList import java util Collection import java util List import java util Set import javax annotation CheckForNull import javax annotation Nonnull import javax servlet ServletException import jenkins model Jenkins import jenkins security MasterToSlaveCallable import jenkins slaves WorkspaceLocator import jenkins util SystemProperties import org apache commons io IOUtils import org apache commons lang StringUtils import org kohsuke accmod Restricted import org kohsuke accmod restrictions NoExternalUse import org kohsuke stapler DataBoundSetter import org kohsuke stapler HttpResponse import org kohsuke stapler QueryParameter import org kohsuke stapler StaplerRequest import org kohsuke stapler StaplerResponse public abstract class Slave extends Node implements Serializable protected String name private String description protected final String remoteFS private int numExecutors 2 private Mode mode Mode NORMAL private RetentionStrategy retentionStrategy private ComputerLauncher launcher private String label private DescribableList NodeProperty NodePropertyDescriptor nodeProperties new DescribableList NodeProperty NodePropertyDescriptor Jenkins getInstance getNodesObject private transient volatile Set Label labels private String userId public Slave String name String nodeDescription String remoteFS String numExecutors Mode mode String labelString ComputerLauncher launcher RetentionStrategy retentionStrategy List extends NodeProperty nodeProperties throws FormException IOException this name nodeDescription remoteFS Util tryParseNumber numExecutors 1 intValue mode labelString launcher retentionStrategy nodeProperties Deprecated public Slave String name String nodeDescription String remoteFS int numExecutors Mode mode String labelString ComputerLauncher launcher RetentionStrategy retentionStrategy throws FormException IOException this name nodeDescription remoteFS numExecutors mode labelString launcher retentionStrategy new ArrayList public Slave Nonnull String name String remoteFS ComputerLauncher launcher throws FormException IOException this name name this remoteFS remoteFS this launcher launcher public Slave Nonnull String name String nodeDescription String remoteFS int numExecutors Mode mode String labelString ComputerLauncher launcher RetentionStrategy retentionStrategy List extends NodeProperty nodeProperties throws FormException IOException this name name this description nodeDescription this numExecutors numExecutors this mode mode this remoteFS Util fixNull remoteFS trim this label Util fixNull labelString trim this launcher launcher this retentionStrategy retentionStrategy getAssignedLabels compute labels now this nodeProperties replaceBy nodeProperties Slave node Slave Jenkins getInstance getNode name if node null this userId node getUserId agent has already existed else User user User current userId user null user getId anonymous if name equals throw new FormException Messages Slave InvalidConfig NoName null if remoteFS equals throw new FormException Messages Slave InvalidConfig NoRemoteDir name null if this numExecutors 0 throw new FormException Messages Slave InvalidConfig Executors name null public String getUserId return userId public void setUserId String userId this userId userId public ComputerLauncher getLauncher return launcher null new JNLPLauncher launcher public void setLauncher ComputerLauncher launcher this launcher launcher public String getRemoteFS return remoteFS public String getNodeName return name Override public String toString return getClass getName name public void setNodeName String name this name name DataBoundSetter public void setNodeDescription String value this description value public String getNodeDescription return description public int getNumExecutors return numExecutors DataBoundSetter public void setNumExecutors int n this numExecutors n public Mode getMode return mode DataBoundSetter public void setMode Mode mode this mode mode public DescribableList NodeProperty NodePropertyDescriptor getNodeProperties assert nodeProperties null return nodeProperties DataBoundSetter public void setNodeProperties List extends NodeProperty properties throws IOException nodeProperties replaceBy properties public RetentionStrategy getRetentionStrategy return retentionStrategy null RetentionStrategy Always INSTANCE retentionStrategy DataBoundSetter public void setRetentionStrategy RetentionStrategy availabilityStrategy this retentionStrategy availabilityStrategy public String getLabelString return Util fixNull label trim Override DataBoundSetter public void setLabelString String labelString throws IOException this label Util fixNull labelString trim Compute labels now getAssignedLabels Override public Callable ClockDifference IOException getClockDifferenceCallable return new GetClockDifference1 public Computer createComputer return new SlaveComputer this public FilePath getWorkspaceFor TopLevelItem item for WorkspaceLocator l WorkspaceLocator all FilePath workspace l locate item this if workspace null return workspace FilePath r getWorkspaceRoot if r null return null offline return r child item getFullName CheckForNull public FilePath getRootPath final SlaveComputer computer getComputer if computer null if computer is null then channel is null and thus we were going to return null anyway return null else return createPath StringUtils defaultString computer getAbsoluteRemoteFs remoteFS public CheckForNull FilePath getWorkspaceRoot FilePath r getRootPath if r null return null return r child WORKSPACE ROOT public static final class JnlpJar implements HttpResponse private final String fileName public JnlpJar String fileName this fileName fileName public void doIndex StaplerRequest req StaplerResponse rsp throws IOException ServletException URLConnection con connect since we end up redirecting users to jnlpJars foo jar set the content disposition so that browsers can download them in the right file name see http support microsoft com kb 260519 and http www boutell com newfaq creating forcedownload html rsp setHeader Content Disposition attachment filename fileName InputStream in con getInputStream rsp serveFile req in con getLastModified con getContentLength jar in close public void generateResponse StaplerRequest req StaplerResponse rsp Object node throws IOException ServletException doIndex req rsp private URLConnection connect throws IOException URL res getURL return res openConnection public URL getURL throws MalformedURLException String name fileName Prevent the access to war contents prevent the folder escaping SECURITY 195 if ALLOWED JNLPJARS FILES contains name throw new MalformedURLException The specified file path fileName is not allowed due to security reasons if name equals hudson cli jar name jenkins cli jar URL res Jenkins getInstance servletContext getResource WEB INF name if res null during the development this path doesn t have the files res new URL new File getAbsoluteFile toURI toURL target jenkins WEB INF name return res public byte readFully throws IOException try InputStream in connect getInputStream return IOUtils toByteArray in public Launcher createLauncher TaskListener listener SlaveComputer c getComputer if c null listener error Issue with creating launcher for agent name return new Launcher DummyLauncher listener else return new RemoteLauncher listener c getChannel c isUnix decorateFor this public SlaveComputer getComputer return SlaveComputer toComputer Override public boolean equals Object o if this o return true if o null getClass o getClass return false final Slave that Slave o return name equals that name Override public int hashCode return name hashCode protected Object readResolve convert the old format to the new one if launcher null launcher agentCommand null agentCommand trim length 0 new JNLPLauncher new CommandLauncher agentCommand if nodeProperties null nodeProperties new DescribableList NodeProperty NodePropertyDescriptor Jenkins getInstance getNodesObject return this public SlaveDescriptor getDescriptor Descriptor d Jenkins getInstance getDescriptorOrDie getClass if d instanceof SlaveDescriptor return SlaveDescriptor d throw new IllegalStateException d getClass needs to extend from SlaveDescriptor public static abstract class SlaveDescriptor extends NodeDescriptor public FormValidation doCheckNumExecutors QueryParameter String value return FormValidation validatePositiveInteger value public FormValidation doCheckRemoteFS QueryParameter String value throws IOException ServletException if Util fixEmptyAndTrim value null return FormValidation error Messages Slave Remote Director Mandatory if value startsWith value startsWith net return FormValidation warning Messages Slave Network Mounted File System Warning if Util isRelativePath value return FormValidation warning Messages Slave Remote Relative Path Warning return FormValidation ok Nonnull Restricted NoExternalUse class intedned for use by Jelly EL only plus hack in DelegatingComputerLauncher public final List Descriptor ComputerLauncher computerLauncherDescriptors CheckForNull Slave it DescriptorExtensionList ComputerLauncher Descriptor ComputerLauncher all Jenkins getInstance ComputerLauncher Descriptor ComputerLauncher getDescriptorList ComputerLauncher class return it null DescriptorVisibilityFilter applyType clazz all DescriptorVisibilityFilter apply it all Nonnull SuppressWarnings unchecked used by Jelly EL only Restricted NoExternalUse class used by Jelly EL only public final List Descriptor RetentionStrategy retentionStrategyDescriptors CheckForNull Slave it return it null DescriptorVisibilityFilter applyType clazz RetentionStrategy all DescriptorVisibilityFilter apply it RetentionStrategy all Nonnull SuppressWarnings unchecked used by Jelly EL only Restricted NoExternalUse class used by Jelly EL only public final List NodePropertyDescriptor nodePropertyDescriptors CheckForNull Slave it List NodePropertyDescriptor result new ArrayList NodePropertyDescriptor Collection NodePropertyDescriptor list Collection Jenkins getInstance getDescriptorList NodeProperty class for NodePropertyDescriptor npd it null DescriptorVisibilityFilter applyType clazz list DescriptorVisibilityFilter apply it list if npd isApplicable clazz result add npd return result backward compatibility Deprecated private transient String agentCommand private static final class GetClockDifference1 extends MasterToSlaveCallable ClockDifference IOException public ClockDifference call this method must be being invoked locally which means the clock is in sync return new ClockDifference 0 private Object writeReplace return new GetClockDifference2 private static final long serialVersionUID 1L private static final class GetClockDifference2 extends MasterToSlaveCallable GetClockDifference3 IOException private final long startTime System currentTimeMillis public GetClockDifference3 call return new GetClockDifference3 startTime private static final long serialVersionUID 1L private static final class GetClockDifference3 implements Serializable private final long remoteTime System currentTimeMillis private final long startTime public GetClockDifference3 long startTime this startTime startTime private Object readResolve long endTime System currentTimeMillis return new ClockDifference startTime endTime 2 remoteTime private static final String WORKSPACE ROOT SystemProperties getString Slave class getName workspaceRoot workspace private static final Set String ALLOWED JNLPJARS FILES ImmutableSet of slave jar remoting jar jenkins cli jar hudson cli jarpackage hudson slaves import hudson AbortException import hudson FilePath import hudson Util import hudson console ConsoleLogFilter import hudson model Computer import hudson model Executor import hudson model ExecutorListener import hudson model Node import hudson model Queue import hudson model Slave import hudson model TaskListener import hudson model User import hudson remoting Channel import hudson remoting ChannelBuilder import hudson remoting Launcher import hudson remoting VirtualChannel import hudson security ACL import hudson slaves OfflineCause ChannelTermination import hudson util Futures import hudson util IOUtils import hudson util NullStream import hudson util RingBufferLogHandler import hudson util StreamTaskListener import hudson util io RewindableFileOutputStream import hudson util io RewindableRotatingFileOutputStream import jenkins model Jenkins import jenkins security ChannelConfigurator import jenkins security MasterToSlaveCallable import jenkins slaves EncryptedSlaveAgentJnlpFile import jenkins slaves JnlpSlaveAgentProtocol import jenkins slaves systemInfo SlaveSystemInfo import jenkins util SystemProperties import org acegisecurity context SecurityContext import org acegisecurity context SecurityContextHolder import org kohsuke stapler HttpRedirect import org kohsuke stapler HttpResponse import org kohsuke stapler QueryParameter import org kohsuke stapler StaplerRequest import org kohsuke stapler StaplerResponse import org kohsuke stapler WebMethod import org kohsuke stapler interceptor RequirePOST import javax annotation CheckForNull import javax annotation OverridingMethodsMustInvokeSuper import javax servlet ServletException import java io File import java io IOException import java io InputStream import java io OutputStream import java io PrintStream import java nio charset Charset import java security Security import java util ArrayList import java util Collections import java util List import java util concurrent Future import java util logging Handler import java util logging Level import java util logging LogRecord import java util logging Logger import static hudson slaves SlaveComputer LogHolder SLAVE LOG HANDLER public class SlaveComputer extends Computer private volatile Channel channel private volatile transient boolean acceptingTasks true private Charset defaultCharset private Boolean isUnix private ComputerLauncher launcher private final RewindableFileOutputStream log private final TaskListener taskListener private transient int numRetryAttempt private volatile Future lastConnectActivity null private Object constructed new Object private transient volatile String absoluteRemoteFs public SlaveComputer Slave slave super slave this log new RewindableRotatingFileOutputStream getLogFile 10 this taskListener new StreamTaskListener decorate this log assert slave getNumExecutors 0 Computer created with 0 executors private OutputStream decorate OutputStream os for ConsoleLogFilter f ConsoleLogFilter all try os f decorateLogger this os catch IOException InterruptedException e LOGGER log Level WARNING Failed to filter log with f e return os Override OverridingMethodsMustInvokeSuper public boolean isAcceptingTasks our boolean flag is an override on any additional programmatic reasons why this agent might not be accepting tasks return acceptingTasks super isAcceptingTasks public String getJnlpMac return JnlpSlaveAgentProtocol SLAVE SECRET mac getName public void setAcceptingTasks boolean acceptingTasks this acceptingTasks acceptingTasks Override public Boolean isUnix return isUnix CheckForNull Override public Slave getNode Node node super getNode if node null node instanceof Slave return Slave node else logger log Level WARNING found an unexpected kind of node 0 from 1 with nodeName 2 new Object node this nodeName return null public TaskListener getListener return taskListener Override public String getIcon Future l lastConnectActivity if l null l isDone return computer flash gif return super getIcon Deprecated Override public boolean isJnlpAgent return launcher instanceof JNLPLauncher Override public boolean isLaunchSupported return launcher isLaunchSupported public ComputerLauncher getLauncher return launcher protected Future connect boolean forceReconnect if channel null return Futures precomputed null if forceReconnect isConnecting return lastConnectActivity if forceReconnect isConnecting logger fine Forcing a reconnect on getName closeChannel return lastConnectActivity Computer threadPoolForRemoting submit new java util concurrent Callable Object public Object call throws Exception do this on another thread so that the lengthy launch operation which is typical won t block UI thread ACL impersonate ACL SYSTEM background activity should run like a super user try log rewind try for ComputerListener cl ComputerListener all cl preLaunch SlaveComputer this taskListener offlineCause null launcher launch SlaveComputer this taskListener catch AbortException e taskListener error e getMessage throw e catch IOException e Util displayIOException e taskListener e printStackTrace taskListener error Messages ComputerLauncher unexpectedError throw e catch InterruptedException e e printStackTrace taskListener error Messages ComputerLauncher abortedLaunch throw e catch Exception e e printStackTrace taskListener error Messages ComputerLauncher unexpectedError throw e finally if channel null offlineCause null offlineCause new OfflineCause LaunchFailed for ComputerListener cl ComputerListener all cl onLaunchFailure SlaveComputer this taskListener if channel null throw new IOException Agent failed to connect even though the launcher didn t report it See the log output for details return null Override public void taskAccepted Executor executor Queue Task task super taskAccepted executor task if launcher instanceof ExecutorListener ExecutorListener launcher taskAccepted executor task getNode can return null at indeterminate times when nodes go offline Slave node getNode if node null node getRetentionStrategy instanceof ExecutorListener ExecutorListener node getRetentionStrategy taskAccepted executor task Override public void taskCompleted Executor executor Queue Task task long durationMS super taskCompleted executor task durationMS if launcher instanceof ExecutorListener ExecutorListener launcher taskCompleted executor task durationMS RetentionStrategy r getRetentionStrategy if r instanceof ExecutorListener ExecutorListener r taskCompleted executor task durationMS Override public void taskCompletedWithProblems Executor executor Queue Task task long durationMS Throwable problems super taskCompletedWithProblems executor task durationMS problems if launcher instanceof ExecutorListener ExecutorListener launcher taskCompletedWithProblems executor task durationMS problems RetentionStrategy r getRetentionStrategy if r instanceof ExecutorListener ExecutorListener r taskCompletedWithProblems executor task durationMS problems Override public boolean isConnecting Future l lastConnectActivity return isOffline l null l isDone public OutputStream openLogFile try log rewind return log catch IOException e logger log Level SEVERE Failed to create log file getLogFile e return new NullStream private final Object channelLock new Object public void setChannel InputStream in OutputStream out TaskListener taskListener Channel Listener listener throws IOException InterruptedException setChannel in out taskListener getLogger listener public void setChannel InputStream in OutputStream out OutputStream launchLog Channel Listener listener throws IOException InterruptedException ChannelBuilder cb new ChannelBuilder nodeName threadPoolForRemoting withMode Channel Mode NEGOTIATE withHeaderStream launchLog for ChannelConfigurator cc ChannelConfigurator all cc onChannelBuilding cb this Channel channel cb build in out setChannel channel launchLog listener public int getClassLoadingCount throws IOException InterruptedException return channel call new LoadingCount false public int getClassLoadingPrefetchCacheCount throws IOException InterruptedException if channel remoteCapability supportsPrefetch return 1 return channel call new LoadingPrefetchCacheCount public int getResourceLoadingCount throws IOException InterruptedException return channel call new LoadingCount true public long getClassLoadingTime throws IOException InterruptedException return channel call new LoadingTime false public long getResourceLoadingTime throws IOException InterruptedException return channel call new LoadingTime true CheckForNull public String getAbsoluteRemoteFs return channel null null absoluteRemoteFs static class LoadingCount extends MasterToSlaveCallable Integer RuntimeException private final boolean resource LoadingCount boolean resource this resource resource Override public Integer call Channel c Channel current return resource c resourceLoadingCount get c classLoadingCount get static class LoadingPrefetchCacheCount extends MasterToSlaveCallable Integer RuntimeException Override public Integer call return Channel current classLoadingPrefetchCacheCount get static class LoadingTime extends MasterToSlaveCallable Long RuntimeException private final boolean resource LoadingTime boolean resource this resource resource Override public Long call Channel c Channel current return resource c resourceLoadingTime get c classLoadingTime get public void setChannel Channel channel OutputStream launchLog Channel Listener listener throws IOException InterruptedException if this channel null throw new IllegalStateException Already connected final TaskListener taskListener new StreamTaskListener launchLog PrintStream log taskListener getLogger channel setProperty SlaveComputer class this channel addListener new Channel Listener Override public void onClosed Channel c IOException cause Orderly shutdown will have null exception if cause null offlineCause new ChannelTermination cause cause printStackTrace taskListener error Connection terminated else taskListener getLogger println Connection terminated closeChannel try launcher afterDisconnect SlaveComputer this taskListener catch Throwable t LogRecord lr new LogRecord Level SEVERE Launcher 0 s afterDisconnect method propagated an exception when 1 s connection was closed 2 lr setThrown t lr setParameters new Object launcher SlaveComputer this getName t getMessage logger log lr if listener null channel addListener listener String slaveVersion channel call new SlaveVersion log println Slave jar version slaveVersion boolean isUnix channel call new DetectOS log println isUnix hudson model Messages Slave UnixSlave hudson model Messages Slave WindowsSlave String defaultCharsetName channel call new DetectDefaultCharset Slave node getNode if node null Node has been disabled removed during the connection throw new IOException Node nodeName has been deleted during the channel setup String remoteFS node getRemoteFS if Util isRelativePath remoteFS remoteFS channel call new AbsolutePath remoteFS log println NOTE Relative remote path resolved to remoteFS if isUnix remoteFS contains remoteFS contains log println WARNING remoteFS looks suspiciously like Windows path Maybe you meant remoteFS replace FilePath root new FilePath channel remoteFS reference counting problem is known to happen such as JENKINS 9017 and so as a preventive measure we pin the base classloader so that it ll never get GCed When this classloader gets released it ll have a catastrophic impact on the communication channel pinClassLoader getClass getClassLoader channel call new SlaveInitializer DEFAULT RING BUFFER SIZE SecurityContext old ACL impersonate ACL SYSTEM try for ComputerListener cl ComputerListener all cl preOnline this channel root taskListener finally SecurityContextHolder setContext old offlineCause null update the data structure atomically to prevent others from seeing a channel that s not properly initialized yet synchronized channelLock if this channel null check again we used to have this entire method in a big sycnhronization block but Channel constructor blocks for an external process to do the connection if CommandLauncher is used and that cannot be interrupted because it blocks at InputStream so if the process hangs it hangs the thread in a lock and since Hudson will try to relaunch we ll end up queuing the lot of threads in a pseudo deadlock This implementation prevents that by avoiding a lock HUDSON 1705 is likely a manifestation of this channel close throw new IllegalStateException Already connected isUnix isUnix numRetryAttempt 0 this channel channel this absoluteRemoteFs remoteFS defaultCharset Charset forName defaultCharsetName synchronized statusChangeLock statusChangeLock notifyAll old ACL impersonate ACL SYSTEM try for ComputerListener cl ComputerListener all cl onOnline this taskListener finally SecurityContextHolder setContext old log println Agent successfully connected and online Jenkins getInstance getQueue scheduleMaintenance Override public Channel getChannel return channel public Charset getDefaultCharset return defaultCharset public List LogRecord getLogRecords throws IOException InterruptedException if channel null return Collections emptyList else return channel call new SlaveLogFetcher RequirePOST public HttpResponse doDoDisconnect QueryParameter String offlineMessage throws IOException ServletException if channel null does nothing in case computer is already disconnected checkPermission DISCONNECT offlineMessage Util fixEmptyAndTrim offlineMessage disconnect new OfflineCause UserCause User current offlineMessage return new HttpRedirect Override public Future disconnect OfflineCause cause super disconnect cause return Computer threadPoolForRemoting submit new Runnable public void run do this on another thread so that any lengthy disconnect operation which could be typical won t block UI thread launcher beforeDisconnect SlaveComputer this taskListener closeChannel launcher afterDisconnect SlaveComputer this taskListener RequirePOST public void doLaunchSlaveAgent StaplerRequest req StaplerResponse rsp throws IOException ServletException if channel null req getView this already launched jelly forward req rsp return connect true TODO would be nice to redirect the user to launching wait page then spend a few seconds there and poll for the completion periodically rsp sendRedirect log public void tryReconnect numRetryAttempt if numRetryAttempt 6 numRetryAttempt 12 0 initially retry several times quickly and after that do it infrequently logger info Attempting to reconnect nodeName connect true Deprecated public Slave JnlpJar getJnlpJars String fileName return new Slave JnlpJar fileName WebMethod name slave agent jnlp public HttpResponse doSlaveAgentJnlp StaplerRequest req StaplerResponse res throws IOException ServletException return new EncryptedSlaveAgentJnlpFile this slave agent jnlp jelly getName CONNECT Override protected void kill super kill closeChannel IOUtils closeQuietly log try Util deleteRecursive getLogDir catch IOException ex logger log Level WARNING Unable to delete agent logs ex public RetentionStrategy getRetentionStrategy Slave n getNode return n null RetentionStrategy INSTANCE n getRetentionStrategy private void closeChannel TODO race condition between this and the setChannel method Channel c synchronized channelLock c channel channel null absoluteRemoteFs null isUnix null if c null try c close catch IOException e logger log Level SEVERE Failed to terminate channel to getDisplayName e for ComputerListener cl ComputerListener all cl onOffline this offlineCause Override protected void setNode final Node node super setNode node launcher grabLauncher node maybe the configuration was changed to relaunch the agent so try to re launch now constructed null test is an ugly hack to avoid launching before the object is fully constructed if constructed null if node instanceof Slave Queue withLock new Runnable Override public void run Slave node getRetentionStrategy check SlaveComputer this else connect false protected ComputerLauncher grabLauncher Node node return Slave node getLauncher public String getSlaveVersion throws IOException InterruptedException return channel call new SlaveVersion public String getOSDescription throws IOException InterruptedException return channel call new DetectOS Unix Windows private static final Logger logger Logger getLogger SlaveComputer class getName private static final class SlaveVersion extends MasterToSlaveCallable String IOException public String call throws IOException try return Launcher VERSION catch Throwable ex return 1 335 Older slave jar won t have VERSION private static final class DetectOS extends MasterToSlaveCallable Boolean IOException public Boolean call throws IOException return File pathSeparatorChar private static final class AbsolutePath extends MasterToSlaveCallable String IOException private static final long serialVersionUID 1L private final String relativePath private AbsolutePath String relativePath this relativePath relativePath public String call throws IOException return new File relativePath getAbsolutePath private static final class DetectDefaultCharset extends MasterToSlaveCallable String IOException public String call throws IOException return Charset defaultCharset name static final class LogHolder static RingBufferLogHandler SLAVE LOG HANDLER private static class SlaveInitializer extends MasterToSlaveCallable Void RuntimeException final int ringBufferSize public SlaveInitializer int ringBufferSize this ringBufferSize ringBufferSize public Void call SLAVE LOG HANDLER new RingBufferLogHandler ringBufferSize avoid double installation of the handler JNLP slaves can reconnect to the master multiple times and each connection gets a different RemoteClassLoader so we need to evict them by class name not by their identity for Handler h LOGGER getHandlers if h getClass getName equals SLAVE LOG HANDLER getClass getName LOGGER removeHandler h LOGGER addHandler SLAVE LOG HANDLER remove Sun PKCS11 provider if present See http wiki jenkins ci org display JENKINS Solaris Issue 6276483 try Security removeProvider SunPKCS11 Solaris catch SecurityException e ignore this error Channel current setProperty slave Boolean TRUE indicate that this side of the channel is the slave side return null private static final long serialVersionUID 1L private static final Logger LOGGER Logger getLogger public static VirtualChannel getChannelToMaster if Jenkins getInstanceOrNull null check if calling thread is on master or on slave return FilePath localChannel if this method is called from within the agent computation thread this should work Channel c Channel current if c null Boolean TRUE equals c getProperty slave return c return null public static List SlaveSystemInfo getSystemInfoExtensions return SlaveSystemInfo all private static class SlaveLogFetcher extends MasterToSlaveCallable List LogRecord RuntimeException public List LogRecord call return new ArrayList LogRecord SLAVE LOG HANDLER getView use RingBufferLogHandler class name to configure for backward compatibility private static final int DEFAULT RING BUFFER SIZE SystemProperties getInteger RingBufferLogHandler class getName defaultSize 256 private static final Logger LOGGER Logger getLogger SlaveComputer class getNamepackage jenkins slaves restarter import hudson ExtensionList import hudson ExtensionPoint import java io Serializable import java util logging Logger public abstract class SlaveRestarter implements ExtensionPoint Serializable public abstract boolean canWork public abstract void restart throws Exception public static ExtensionList SlaveRestarter all return ExtensionList lookup SlaveRestarter class private static final Logger LOGGER Logger getLogger SlaveRestarter class getName private static final long serialVersionUID 1Lpackage jenkins slaves systemInfo import hudson ExtensionList import hudson ExtensionPoint import hudson model Computer public abstract class SlaveSystemInfo implements ExtensionPoint public abstract String getDisplayName public static ExtensionList SlaveSystemInfo all return ExtensionList lookup SlaveSystemInfo classpackage jenkins security import hudson remoting Callable import org jenkinsci remoting RoleChecker public abstract class SlaveToMasterCallable V T extends Throwable implements Callable V T Override public void checkRoles RoleChecker checker throws SecurityException checker check this Roles MASTER private static final long serialVersionUID 1Lpackage jenkins import hudson FilePath FileCallable import jenkins security Roles import org jenkinsci remoting RoleChecker public abstract class SlaveToMasterFileCallable T implements FileCallable T Override public void checkRoles RoleChecker checker throws SecurityException checker check this Roles MASTER private static final long serialVersionUID 1Lpackage hudson lifecycle import jenkins model Jenkins import java io IOException public class SolarisSMFLifecycle extends Lifecycle Override public void restart throws IOException InterruptedException Jenkins h Jenkins getInstanceOrNull guard against repeated concurrent calls to restart if h null h cleanUp System exit 0package jenkins import javax annotation Nullable import java io File public final class SoloFilePathFilter extends FilePathFilter private final FilePathFilter base private SoloFilePathFilter FilePathFilter base this base base public static Nullable SoloFilePathFilter wrap Nullable FilePathFilter base if base null return null return new SoloFilePathFilter base private boolean noFalse String op File f boolean b if b throw new SecurityException agent may not op f nSee http jenkins ci org security 144 for more details return true Override public boolean read File f throws SecurityException return noFalse read f base read f Override public boolean write File f throws SecurityException return noFalse write f base write f Override public boolean symlink File f throws SecurityException return noFalse symlink f base write f Override public boolean mkdirs File f throws SecurityException return noFalse mkdirs f base mkdirs f Override public boolean create File f throws SecurityException return noFalse create f base create f Override public boolean delete File f throws SecurityException return noFalse delete f base delete f Override public boolean stat File f throws SecurityException return noFalse stat f base stat fpackage jenkins model lazy import java util AbstractList import java util Arrays class SortedIntList extends AbstractList Integer private int data private int size public SortedIntList int capacity this data new int capacity this size 0 public SortedIntList SortedIntList that this data new int that size 8 System arraycopy that data 0 this data 0 that size this size that size public int find int probe return binarySearch data 0 size probe Override public boolean contains Object o return o instanceof Integer contains Integer o intValue public boolean contains int i return find i 0 Override public Integer get int index if size index throw new IndexOutOfBoundsException return data index Override public int size return size public int max return size 0 data size 1 0 Override public boolean add Integer i return add i intValue public boolean add int i ensureCapacity size 1 data size i return true private void ensureCapacity int i if data length i int r new int Math max data length 2 i System arraycopy data 0 r 0 size data r public int lower int v return Boundary LOWER apply find v public int higher int v return Boundary HIGHER apply find v public int floor int v return Boundary FLOOR apply find v public int ceil int v return Boundary CEIL apply find v public boolean isInRange int idx return 0 idx idx size public void sort Arrays sort data 0 size public void copyInto int dest System arraycopy data 0 dest 0 size public void removeValue int n int idx find n if idx 0 return System arraycopy data idx 1 data idx size idx 1 size private static int binarySearch int a int start int end int key int lo start hi end 1 search range is lo hi invariant lo hi while lo hi int pivot lo hi 2 int v a pivot if v key needs to search upper half lo pivot 1 else if v key needs to search lower half hi pivot 1 else eureka return pivot return lo 1 insertion pointpackage jenkins model lazy import java util AbstractList import java util ArrayList import java util Collections import java util List class SortedList T extends Comparable T extends AbstractList T private List T data public SortedList List T data this data new ArrayList T data assert isSorted public int find T probe return Collections binarySearch data probe Override public boolean contains Object o return find T o 0 public T get int idx return data get idx Override public int size return data size Override public T remove int index return data remove index Override public boolean remove Object o return data remove o public int lower T v return Boundary LOWER apply find v public int higher T v return Boundary HIGHER apply find v public int floor T v return Boundary FLOOR apply find v public int ceil T v return Boundary CEIL apply find v public boolean isInRange int idx return 0 idx idx data size private boolean isSorted for int i 1 i data size i if data get i compareTo data get i 1 0 return false return truepackage com twitter sdk android tweetui internal import android annotation SuppressLint import android text Layout import android text Spanned import android view MotionEvent import android view View import android widget TextView public class SpanClickHandler private final View view private Layout layout private float left private float top private HighlightedClickableSpan highlightedClickableSpan public static void enableClicksOnSpans TextView textView final SpanClickHandler helper new SpanClickHandler textView null textView setOnTouchListener new View OnTouchListener SuppressLint ClickableViewAccessibility Override public boolean onTouch View view MotionEvent event final TextView textView TextView view final Layout layout textView getLayout if layout null helper layout layout helper left textView getTotalPaddingLeft textView getScrollX helper top textView getTotalPaddingTop textView getScrollY return helper handleTouchEvent event return false public SpanClickHandler View view Layout layout this view view this layout layout public void setPosition float left float top this left left this top top public boolean handleTouchEvent MotionEvent event final CharSequence text layout getText final Spanned spannedText text instanceof Spanned Spanned text null if spannedText null return false final int action event getAction MotionEvent ACTION MASK final int x int event getX left final int y int event getY top if x 0 x layout getWidth y 0 y layout getHeight deselectSpan return false Get the clicked line and check x is within the text on this line final int line layout getLineForVertical y if x layout getLineLeft line x layout getLineRight line deselectSpan return false if action MotionEvent ACTION DOWN final int offset layout getOffsetForHorizontal line x final HighlightedClickableSpan span spannedText getSpans offset offset HighlightedClickableSpan class if span length 0 selectSpan span 0 return true else if action MotionEvent ACTION UP final HighlightedClickableSpan selectedSpan highlightedClickableSpan if selectedSpan null selectedSpan onClick view deselectSpan return true return false private void selectSpan HighlightedClickableSpan span span select true highlightedClickableSpan span invalidate private void deselectSpan final HighlightedClickableSpan selectedSpan highlightedClickableSpan if selectedSpan null selectedSpan isSelected selectedSpan select false highlightedClickableSpan null invalidate private void invalidate view invalidate int left int top int left layout getWidth int top layout getHeightpackage hudson security import org acegisecurity Authentication import org acegisecurity acls sid Sid import java util ArrayList import java util List import java util logging Logger import static java util logging Level FINE public class SparseACL extends SidACL public static final class Entry Sid has value equality semantics public final Sid sid public final Permission permission public final boolean allowed public Entry Sid sid Permission permission boolean allowed this sid sid this permission permission this allowed allowed private final List Entry entries new ArrayList Entry private ACL parent public SparseACL ACL parent this parent parent public void add Entry e entries add e public void add Sid sid Permission permission boolean allowed add new Entry sid permission allowed Override public boolean hasPermission Authentication a Permission permission if a SYSTEM return true Boolean b hasPermission a permission if b null return b if parent null if LOGGER isLoggable FINE LOGGER fine hasPermission a permission is delegating to parent ACL parent return parent hasPermission a permission the ultimate default is to reject everything return false Override protected Boolean hasPermission Sid p Permission permission for permission null permission permission impliedBy for Entry e entries if e permission permission e sid equals p return e allowed return null private static final Logger LOGGER Logger getLogger SparseACL class getNamepackage com kaku colorfulnews mvp ui activities import android animation ValueAnimator import android content Intent import android os Bundle import android support annotation Nullable import android support v7 app AppCompatActivity import android view animation Animation import android view animation AnimationUtils import android widget ImageView import android widget TextView import com daimajia androidanimations library Techniques import com daimajia androidanimations library YoYo import com kaku colorfulnews R import com socks library KLog import java util concurrent TimeUnit import butterknife BindView import butterknife ButterKnife import rx Observable import rx android schedulers AndroidSchedulers import rx functions Action1 import rx schedulers Schedulers public class SplashActivity extends AppCompatActivity BindView R id logo outer iv ImageView mLogoOuterIv BindView R id logo inner iv ImageView mLogoInnerIv boolean isShowingRubberEffect false BindView R id app name tv TextView mAppNameTv Override protected void onCreate Nullable Bundle savedInstanceState super onCreate savedInstanceState overridePendingTransition R anim zoomin 0 setContentView R layout activity splash ButterKnife bind this initAnimation private void initAnimation startLogoInner1 startLogoOuterAndAppName private void startLogoInner1 Animation animation AnimationUtils loadAnimation this R anim anim top in mLogoInnerIv startAnimation animation private void startLogoOuterAndAppName final ValueAnimator valueAnimator ValueAnimator ofFloat 0 1 valueAnimator setDuration 1000 valueAnimator addUpdateListener new ValueAnimator AnimatorUpdateListener Override public void onAnimationUpdate ValueAnimator animation float fraction animation getAnimatedFraction KLog d fraction fraction if fraction 0 8 isShowingRubberEffect isShowingRubberEffect true startLogoOuter startShowAppName finishActivity else if fraction 0 95 valueAnimator cancel startLogoInner2 valueAnimator start private void startLogoOuter YoYo with Techniques RubberBand duration 1000 playOn mLogoOuterIv private void startShowAppName YoYo with Techniques FadeIn duration 1000 playOn mAppNameTv private void startLogoInner2 YoYo with Techniques Bounce duration 1000 playOn mLogoInnerIv private void finishActivity Observable timer 1000 TimeUnit MILLISECONDS subscribeOn Schedulers io observeOn AndroidSchedulers mainThread subscribe new Action1 Long Override public void call Long aLong startActivity new Intent SplashActivity this NewsActivity class overridePendingTransition 0 android R anim fade out finishpackage com twitter sdk android core identity import android app Activity import android content ComponentName import android content Context import android content Intent import android content pm PackageInfo import android content pm PackageManager import android content pm Signature import io fabric sdk android Fabric import com twitter sdk android core Callback import com twitter sdk android core IntentUtils import com twitter sdk android core TwitterCore import com twitter sdk android core TwitterAuthConfig import com twitter sdk android core TwitterSession class SSOAuthHandler extends AuthHandler Package name of the Twitter for Android application static final String TWITTER PACKAGE NAME com twitter android Package name of the Twitter Dogfood Android application static final String DOGFOOD PACKAGE NAME com twitter android beta Class name of the Activity responsible for Single sign on flow static final String SSO CLASS NAME TWITTER PACKAGE NAME SingleSignOnActivity Twitter for Android application signature static final String TWITTER SIGNATURE 3082025d308201c6a00302010202044bd76cce300d06092 a864886f70d01010505003073310b3009060355040613025553310b3009060355040813024341311630 140603550407130d53616e204672616e636973636f31163014060355040a130d547769747465722c204 96e632e310f300d060355040b13064d6f62696c65311630140603550403130d4c656c616e6420526563 686973301e170d3130303432373233303133345a170d3438303832353233303133345a3073310b30090 60355040613025553310b3009060355040813024341311630140603550407130d53616e204672616e63 6973636f31163014060355040a130d547769747465722c20496e632e310f300d060355040b13064d6f6 2696c65311630140603550403130d4c656c616e642052656368697330819f300d06092a864886f70d01 0101050003818d003081890281810086233c2e51c62232d49cc932e470713d63a6a1106b38f9e442e01 bc79ca4f95c72b2cb3f1369ef7dea6036bff7c4b2828cb3787e7657ad83986751ced5b131fcc6f413ef b7334e32ed9787f9e9a249ae108fa66009ac7a7932c25d37e1e07d4f9f66aa494c270dbac87d261c966 8d321c2fba4ef2800e46671a597ff2eac5d7f0203010001300d06092a864886f70d0101050500038181 003e1f01cb6ea8be8d2cecef5cd2a64c97ba8728aa5f08f8275d00508d64d139b6a72c5716b40a040df 0eeeda04de9361107e123ee8d3dc05e70c8a355f46dbadf1235443b0b214c57211afd4edd147451c443 d49498d2a7ff27e45a99c39b9e47429a1dae843ba233bf8ca81296dbe1dc5c5434514d995b027924680 9392a219b Twitter Android Dogfood application signature static final String DOGFOOD SIGNATURE 308203523082023aa00302010202044fd0006b300d06092a864 886f70d0101050500306b310b3009060355040613025553310b30090603550408130243413116301406 03550407130d53616e204672616e636973636f3110300e060355040a130754776974746572310f300d0 60355040b13064d6f62696c65311430120603550403130b4a6f6e617468616e204c65301e170d313230 3630373031313431395a170d3339313032343031313431395a306b310b3009060355040613025553310 b3009060355040813024341311630140603550407130d53616e204672616e636973636f3110300e0603 55040a130754776974746572310f300d060355040b13064d6f62696c65311430120603550403130b4a6 f6e617468616e204c6530820122300d06092a864886f70d01010105000382010f003082010a02820101 0089e6cbdfed4288a9c0a215d33d4fa978a5bdd20be426ef4b497d358a9fd1c6efec9684f059f6955e6 0e5fda1b5910bb2d097e7421a78f9c81e95cd8ef3bf50add7f8d9f073c0478736a6c7fd38c587155978 3a76420d37f3f874f2114ec02532e85587791d24037485b1b95ec8cbc75b52042867988b51c7c3589d5 b5972fd20a2e8a7c9ced986873f5008a418b2921daa7cfb78afc174eecdb8a79dc0961bea9740d09c46 56ac9b8c86263a788e35af1d4a3f86ce053a1aefb5369def91614a390219f896f378712376baa05934a 341798950e229f4f735b86004952b259f23cc9fc3b8c1bc8171984884dc92940e91f2e9a78a84a78f0c 2946b7e37bbf3b9b0203010001300d06092a864886f70d010105050003820101001cf15250365e66cc8 7bb5054de1661266cf87907841016b20dfa1f9f59842020cbc33f9b4d41717db0428d11696a0bade6a4 950a48cc4fa8ae56c850647379a5c2d977436b644162c453dd36b7745ccb9ff0b5fc070125024de73da b6dcda5c69372e978a49865f569927199ed0f61d7cbee1839079a7da2e83f8c90f7421a8c81b3f17f1c c05d52aedac9acd6e092ffd9ad572960e779a5b91a78e1aeb2b3c7b24464bd223c745e40abd74fc5863 10809520d183443fcca3c6ade3be458afedbd3325df9c0e552636e35bb55b240eb8c0ba3973c4fb8121 3f22363be2d70e85014650c2f4fc679747a7ec31ea7b08da7dd9b9ba279a7fbbc1bd440fbe831bf4 private static final String EXTRA CONSUMER KEY ck private static final String EXTRA CONSUMER SECRET cs public SSOAuthHandler TwitterAuthConfig authConfig Callback TwitterSession callback int requestCode super authConfig callback requestCode Override public boolean authorize Activity activity return startAuthActivityForResult activity private boolean startAuthActivityForResult Activity activity final PackageManager pm activity getPackageManager final String packageName availableSSOPackage pm if packageName null Fabric getLogger e TwitterCore TAG SSO app signature check failed null return false final ComponentName ssoActivity new ComponentName packageName SSO CLASS NAME final TwitterAuthConfig authConfig getAuthConfig final Intent intent new Intent setComponent ssoActivity if IntentUtils isActivityAvailable activity intent Fabric getLogger e TwitterCore TAG SSO auth activity not found null return false intent putExtra EXTRA CONSUMER KEY authConfig getConsumerKey putExtra EXTRA CONSUMER SECRET authConfig getConsumerSecret try activity startActivityForResult intent requestCode return true catch Exception e Fabric getLogger e TwitterCore TAG SSO exception occurred e return false public static String availableSSOPackage PackageManager pm if checkAppSignature pm TWITTER PACKAGE NAME TWITTER SIGNATURE return TWITTER PACKAGE NAME else if checkAppSignature pm DOGFOOD PACKAGE NAME DOGFOOD SIGNATURE return DOGFOOD PACKAGE NAME else return null public static boolean isAvailable Context context final PackageManager pm context getPackageManager return checkAppSignature pm TWITTER PACKAGE NAME TWITTER SIGNATURE checkAppSignature pm DOGFOOD PACKAGE NAME DOGFOOD SIGNATURE private static boolean checkAppSignature PackageManager pm String packageName String requiredSignature PackageInfo p try p pm getPackageInfo packageName PackageManager GET SIGNATURES catch PackageManager NameNotFoundException e return false for Signature s p signatures if requiredSignature equals s toCharsString return false return truepackage hudson util import org jfree chart axis CategoryAxis import org jfree chart axis ValueAxis import org jfree chart entity EntityCollection import org jfree chart labels CategoryToolTipGenerator import org jfree chart plot CategoryPlot import org jfree chart renderer AreaRendererEndType import org jfree chart renderer category CategoryItemRendererState import org jfree chart renderer category StackedAreaRenderer import org jfree chart urls CategoryURLGenerator import org jfree data category CategoryDataset import org jfree ui RectangleEdge import java awt Graphics2D import java awt Polygon import java awt Paint import java awt geom Rectangle2D public class StackedAreaRenderer2 extends StackedAreaRenderer implements CategoryToolTipGenerator CategoryURLGenerator public StackedAreaRenderer2 setEndType AreaRendererEndType TRUNCATE setItemURLGenerator this setToolTipGenerator this public String generateURL CategoryDataset dataset int row int column return null public String generateToolTip CategoryDataset dataset int row int column return null Override public Paint getItemPaint int row int column return super getItemPaint row column Mostly copied from the base class Override public void drawItem Graphics2D g2 CategoryItemRendererState state Rectangle2D dataArea CategoryPlot plot CategoryAxis domainAxis ValueAxis rangeAxis CategoryDataset dataset int row int column int pass plot non null values Number dataValue dataset getValue row column if dataValue null return double value dataValue doubleValue leave the y values y1 y0 untranslated as it is going to be be stacked up later by previous series values after this it will be translated double xx1 domainAxis getCategoryMiddle column getColumnCount dataArea plot getDomainAxisEdge double previousHeightx1 getPreviousHeight dataset row column double y1 value previousHeightx1 RectangleEdge location plot getRangeAxisEdge double yy1 rangeAxis valueToJava2D y1 dataArea location g2 setPaint getItemPaint row column g2 setStroke getItemStroke row column add an item entity if this information is being collected EntityCollection entities state getEntityCollection in column zero the only job to do is draw any visible item labels and this is done in the second pass if column 0 if pass 1 draw item labels if visible if isItemLabelVisible row column drawItemLabel g2 plot getOrientation dataset row column xx1 yy1 y1 0 0 else Number previousValue dataset getValue row column 1 if previousValue null double xx0 domainAxis getCategoryMiddle column 1 getColumnCount dataArea plot getDomainAxisEdge double y0 previousValue doubleValue Get the previous height but this will be different for both y0 and y1 as the previous series values could differ double previousHeightx0 getPreviousHeight dataset row column 1 Now stack the current y values on top of the previous values y0 previousHeightx0 Now translate the previous heights double previousHeightxx0 rangeAxis valueToJava2D previousHeightx0 dataArea location double previousHeightxx1 rangeAxis valueToJava2D previousHeightx1 dataArea location Now translate the current y values double yy0 rangeAxis valueToJava2D y0 dataArea location if pass 0 left half Polygon p new Polygon p addPoint int xx0 int yy0 p addPoint int xx0 xx1 2 int yy0 yy1 2 p addPoint int xx0 xx1 2 int previousHeightxx0 previousHeightxx1 2 p addPoint int xx0 int previousHeightxx0 g2 setPaint getItemPaint row column 1 g2 setStroke getItemStroke row column 1 g2 fill p if entities null addItemEntity entities dataset row column 1 p right half p new Polygon p addPoint int xx1 int yy1 p addPoint int xx0 xx1 2 int yy0 yy1 2 p addPoint int xx0 xx1 2 int previousHeightxx0 previousHeightxx1 2 p addPoint int xx1 int previousHeightxx1 g2 setPaint getItemPaint row column g2 setStroke getItemStroke row column g2 fill p if entities null addItemEntity entities dataset row column p else if isItemLabelVisible row column drawItemLabel g2 plot getOrientation dataset row column xx1 yy1 y1 0 0package jenkins model item category import hudson Extension Extension ordinal 100 public class StandaloneProjectsCategory extends ItemCategory public static final String ID standalone projects Override public String getId return ID Override public String getDescription return Messages StandaloneProjects Description Override public String getDisplayName return Messages StandaloneProjects DisplayName Override public int getMinToShow return ItemCategory MIN TOSHOWpackage jenkins model import hudson FilePath import hudson Launcher import hudson Util import hudson model BuildListener import hudson model Run import java io File import java io IOException import java util Map import java util logging Level import java util logging Logger import jenkins util VirtualFile public class StandardArtifactManager extends ArtifactManager private static final Logger LOG Logger getLogger StandardArtifactManager class getName protected transient Run build public StandardArtifactManager Run build onLoad build Override public final void onLoad Run build this build build Override public void archive FilePath workspace Launcher launcher BuildListener listener final Map String String artifacts throws IOException InterruptedException File dir getArtifactsDir String description transfer of artifacts size files TODO improve when just one file workspace copyRecursiveTo new FilePath ExplicitlySpecifiedDirScanner artifacts new FilePath dir description Override public final boolean delete throws IOException InterruptedException File ad getArtifactsDir if ad exists LOG log Level FINE no such directory 0 to delete for 1 new Object ad build return false LOG log Level FINE deleting 0 for 1 new Object ad build Util deleteRecursive ad return true Override public VirtualFile root return VirtualFile forFile getArtifactsDir SuppressWarnings deprecation private File getArtifactsDir return build getArtifactsDirpackage jenkins slaves import hudson Extension import hudson FilePath import jenkins util SystemProperties import hudson model Computer import hudson model TaskListener import hudson remoting Channel import hudson remoting StandardOutputStream import hudson slaves ComputerListener import hudson util jna GNUCLibrary import jenkins security MasterToSlaveCallable import java io File import java io FileDescriptor import java io FileOutputStream import java io IOException import java io OutputStream import java lang reflect Constructor import java util logging Logger Extension public class StandardOutputSwapper extends ComputerListener Override public void preOnline Computer c Channel channel FilePath root TaskListener listener if disabled return try if channel call new ChannelSwapper listener getLogger println Evacuated stdout catch Throwable e LOGGER fine Fatal problem swapping file descriptors c getName private static final class ChannelSwapper extends MasterToSlaveCallable Boolean Exception public Boolean call throws Exception if File pathSeparatorChar return false Windows Channel c Channel current StandardOutputStream sos StandardOutputStream c getProperty StandardOutputStream class if sos null swap sos return true OutputStream o c getUnderlyingOutput if o instanceof StandardOutputStream swap StandardOutputStream o return true return false private void swap StandardOutputStream stdout throws IOException NoSuchMethodException InstantiationException IllegalAccessException java lang reflect InvocationTargetException duplicate the OS file descriptor and create FileOutputStream around it int out GNUCLibrary LIBC dup 1 if out 0 throw new IOException Failed to dup 1 Constructor FileDescriptor c FileDescriptor class getDeclaredConstructor int class c setAccessible true FileOutputStream fos new FileOutputStream c newInstance out swap it into channel so that it ll use the new file descriptor stdout swap fos close fd 1 stdout and duplicate fd 2 stderr into fd 1 stdout GNUCLibrary LIBC close 1 GNUCLibrary LIBC dup2 2 1 private static final Logger LOGGER Logger getLogger StandardOutputSwapper class getName public static boolean disabled SystemProperties getBoolean StandardOutputSwapper class getName disabledpackage jenkins management import hudson Extension import hudson model ManagementLink import org jenkinsci Symbol Extension ordinal Integer MAX VALUE 700 Symbol loadStatistics public class StatisticsLink extends ManagementLink Override public String getIconFileName return monitor png public String getDisplayName return Messages StatisticsLink DisplayName Override public String getDescription return Messages StatisticsLink Description Override public String getUrlName return load statisticspackage hudson views import hudson Extension import hudson model StatusIcon import org jenkinsci Symbol import org kohsuke stapler DataBoundConstructor public class StatusColumn extends ListViewColumn DataBoundConstructor public StatusColumn Extension ordinal DEFAULT COLUMNS ORDINAL ICON START 1 Symbol status public static class DescriptorImpl extends ListViewColumnDescriptor Override public String getDisplayName return Messages StatusColumn DisplayNamepackage com twitter sdk android tweetcomposer import com twitter sdk android core models Tweet import retrofit2 Call import retrofit2 http Field import retrofit2 http FormUrlEncoded import retrofit2 http POST public interface StatusesService FormUrlEncoded POST 1 1 statuses update json Call Tweet update Field status String status Field card uri String cardUripackage hudson model public interface StatusIcon String getImageOf String size String getDescriptionpackage hudson model import jenkins model Jenkins import org jvnet localizer LocaleProvider import org jvnet localizer Localizable import org kohsuke stapler Stapler public final class StockStatusIcon extends AbstractStatusIcon private final Localizable description private final String image public StockStatusIcon String image Localizable description this image image this description description public String getImageOf String size return Stapler getCurrentRequest getContextPath Jenkins RESOURCE PATH images size image public String getDescription return description toString LocaleProvider getLocalepackage hudson model import hudson util StreamTaskListener import java io File import java io IOException import java io OutputStream import java io PrintStream import java nio charset Charset import java util List public class StreamBuildListener extends StreamTaskListener implements BuildListener public StreamBuildListener OutputStream out Charset charset super out charset public StreamBuildListener File out Charset charset throws IOException super out charset public StreamBuildListener OutputStream w super w Deprecated public StreamBuildListener PrintStream w super w public StreamBuildListener PrintStream w Charset charset super w charset public void started List Cause causes PrintStream l getLogger if causes null causes isEmpty l println Started else for Cause cause causes TODO elide duplicates as per CauseAction getCauseCounts used in summary jelly cause print this public void finished Result result getLogger println Finished result private static final long serialVersionUID 1Lpackage hudson util import java io IOException import java io InputStream import java io OutputStream public class StreamCopyThread extends Thread private final InputStream in private final OutputStream out private final boolean closeOut public StreamCopyThread String threadName InputStream in OutputStream out boolean closeOut super threadName this in in if out null throw new NullPointerException out is null this out out this closeOut closeOut public StreamCopyThread String threadName InputStream in OutputStream out this threadName in out false Override public void run try try byte buf new byte 8192 int len while len in read buf 0 out write buf 0 len finally it doesn t make sense not to close InputStream that s already EOF ed so there s no closeIn flag in close if closeOut out close catch IOException e TODO what to dopackage hudson util import org apache tools ant types Resource import java io InputStream import java io IOException public class StreamResource extends Resource private final InputStream in public StreamResource String name InputStream in this in in setName name Override public InputStream getInputStream throws IOException return inpackage hudson util import hudson CloseProofOutputStream import hudson console ConsoleNote import hudson console HudsonExceptionNote import hudson model TaskListener import hudson remoting RemoteOutputStream import java io Closeable import java io File import java io FileOutputStream import java io IOException import java io ObjectInputStream import java io ObjectOutputStream import java io OutputStream import java io OutputStreamWriter import java io PrintStream import java io PrintWriter import java io Serializable import java io UnsupportedEncodingException import java io Writer import java nio charset Charset import java util logging Level import java util logging Logger import org kohsuke stapler framework io WriterOutputStream public class StreamTaskListener extends AbstractTaskListener implements Serializable Closeable private PrintStream out private Charset charset Deprecated public StreamTaskListener PrintStream out this out null public StreamTaskListener OutputStream out this out null public StreamTaskListener OutputStream out Charset charset try if charset null this out out instanceof PrintStream PrintStream out new PrintStream out false else this out new PrintStream out false charset name this charset charset catch UnsupportedEncodingException e it s not very pretty to do this but otherwise we d have to touch too many call sites throw new Error e public StreamTaskListener File out throws IOException this out null public StreamTaskListener File out Charset charset throws IOException don t do buffering so that what s written to the listener gets reflected to the file immediately which can then be served to the browser immediately this new FileOutputStream out charset public StreamTaskListener File out boolean append Charset charset throws IOException don t do buffering so that what s written to the listener gets reflected to the file immediately which can then be served to the browser immediately this new FileOutputStream out append charset public StreamTaskListener Writer w throws IOException this new WriterOutputStream w Deprecated public StreamTaskListener throws IOException this new NullStream public static StreamTaskListener fromStdout return new StreamTaskListener System out Charset defaultCharset public static StreamTaskListener fromStderr return new StreamTaskListener System err Charset defaultCharset public PrintStream getLogger return out private PrintWriter error String prefix String msg out print prefix out println msg the idiom in Hudson is to use the returned writer for writing stack trace so put the marker here to indicate an exception if the stack trace isn t actually written HudsonExceptionNote annotate recovers gracefully try annotate new HudsonExceptionNote catch IOException e for signature compatibility we have to swallow this error return new PrintWriter charset null new OutputStreamWriter out charset new OutputStreamWriter out true public PrintWriter error String msg return error ERROR msg public PrintWriter error String format Object args return error String format format args public PrintWriter fatalError String msg return error FATAL msg public PrintWriter fatalError String format Object args return fatalError String format format args public void annotate ConsoleNote ann throws IOException ann encodeTo out private void writeObject ObjectOutputStream out throws IOException out writeObject new RemoteOutputStream new CloseProofOutputStream this out out writeObject charset null null charset name private void readObject ObjectInputStream in throws IOException ClassNotFoundException out new PrintStream OutputStream in readObject true String name String in readObject charset name null null Charset forName name public void close throws IOException out close public void closeQuietly try close catch IOException e LOGGER log Level WARNING Failed to close e private static final long serialVersionUID 1L private static final Logger LOGGER Logger getLogger StreamTaskListener class getNamepackage hudson util import com thoughtworks xstream converters basic AbstractSingleValueConverter import com thoughtworks xstream converters basic StringConverter Deprecated public class StringConverter2 extends AbstractSingleValueConverter public boolean canConvert Class type return type equals String class public Object fromString String str return strpackage hudson model import hudson Extension import net sf json JSONObject import org jenkinsci Symbol import org kohsuke stapler DataBoundConstructor import org kohsuke stapler StaplerRequest public class StringParameterDefinition extends SimpleParameterDefinition private String defaultValue DataBoundConstructor public StringParameterDefinition String name String defaultValue String description super name description this defaultValue defaultValue public StringParameterDefinition String name String defaultValue this name defaultValue null Override public ParameterDefinition copyWithDefaultValue ParameterValue defaultValue if defaultValue instanceof StringParameterValue StringParameterValue value StringParameterValue defaultValue return new StringParameterDefinition getName value value getDescription else return this public String getDefaultValue return defaultValue public void setDefaultValue String defaultValue this defaultValue defaultValue Override public StringParameterValue getDefaultParameterValue StringParameterValue v new StringParameterValue getName defaultValue getDescription return v Extension Symbol string stringParam public static class DescriptorImpl extends ParameterDescriptor Override public String getDisplayName return Messages StringParameterDefinition DisplayName Override public String getHelpFile return help parameter string html Override public ParameterValue createValue StaplerRequest req JSONObject jo StringParameterValue value req bindJSON StringParameterValue class jo value setDescription getDescription return value public ParameterValue createValue String value return new StringParameterValue getName value getDescriptionpackage hudson model import hudson EnvVars import org kohsuke stapler DataBoundConstructor import org kohsuke stapler export Exported import java util Locale import hudson util VariableResolver public class StringParameterValue extends ParameterValue Exported visibility 4 public final String value DataBoundConstructor public StringParameterValue String name String value this name value null public StringParameterValue String name String value String description super name description this value value Override public void buildEnvironment Run build EnvVars env env put name value env put name toUpperCase Locale ENGLISH value backward compatibility pre 1 345 Override public VariableResolver String createVariableResolver AbstractBuild build return new VariableResolver String public String resolve String name return StringParameterValue this name equals name value null Override public Object getValue return value Override public int hashCode final int prime 31 int result super hashCode result prime result value null 0 value hashCode return result Override public boolean equals Object obj if this obj return true if super equals obj return false if getClass obj getClass return false StringParameterValue other StringParameterValue obj if value null if other value null return false else if value equals other value return false return true Override public String toString return StringParameterValue getName value Override public String getShortDescription return name valuepackage hudson import net sf json JSONArray import net sf json JSONObject import org kohsuke stapler StaplerRequest import javax servlet ServletException import java util Collections import java util List public class StructuredForm Deprecated public static JSONObject get StaplerRequest req throws ServletException return req getSubmittedForm public static List JSONObject toList JSONObject parent String propertyName Object v parent get propertyName if v null return Collections emptyList if v instanceof JSONObject return Collections singletonList JSONObject v if v instanceof JSONArray return List JSONArray v throw new IllegalArgumentExceptionpackage hudson os import com sun solaris EmbeddedSu import hudson FilePath import hudson Launcher LocalLauncher import hudson Util import hudson model Computer import hudson model TaskListener import hudson remoting Callable import hudson remoting Launcher import hudson remoting LocalChannel import hudson remoting VirtualChannel import hudson remoting Which import hudson slaves Channels import hudson util ArgumentListBuilder import java io File import java io IOException import java io PrintStream import java util Collections import static hudson util jna GNUCLibrary public abstract class SU private SU not meant to be instantiated public static VirtualChannel start final TaskListener listener final String rootUsername final String rootPassword throws IOException InterruptedException if File pathSeparatorChar on Windows return newLocalChannel TODO perhaps use RunAs to run as an Administrator String os Util fixNull System getProperty os name if os equals Linux return new UnixSu protected String sudoExe return sudo protected Process sudoWithPass ArgumentListBuilder args throws IOException args prepend sudoExe S listener getLogger println Util join args toList ProcessBuilder pb new ProcessBuilder args toCommandArray Process p pb start TODO use p to detect prompt TODO detect if the password didn t work PrintStream ps new PrintStream p getOutputStream ps println rootPassword ps println rootPassword ps println rootPassword return p start listener rootPassword if os equals SunOS return new UnixSu protected String sudoExe return usr bin pfexec protected Process sudoWithPass ArgumentListBuilder args throws IOException listener getLogger println Running with embedded su ProcessBuilder pb new ProcessBuilder args prepend sudoExe toCommandArray return EmbeddedSu startWithSu rootUsername rootPassword pb in solaris pfexec never asks for a password so username null means we won t be using password this helps disambiguate empty password start listener rootUsername null null rootPassword TODO Mac unsupported platform take a chance return newLocalChannel private static LocalChannel newLocalChannel return FilePath localChannel public static V T extends Throwable V execute TaskListener listener String rootUsername String rootPassword final Callable V T closure throws T IOException InterruptedException VirtualChannel ch start listener rootUsername rootPassword try return ch call closure finally ch close ch join 3000 give some time for orderly shutdown but don t block forever private static abstract class UnixSu protected abstract String sudoExe protected abstract Process sudoWithPass ArgumentListBuilder args throws IOException VirtualChannel start TaskListener listener String rootPassword throws IOException InterruptedException final int uid LIBC geteuid if uid 0 already running as root return newLocalChannel String javaExe System getProperty java home bin java File slaveJar Which jarFile Launcher class ArgumentListBuilder args new ArgumentListBuilder add javaExe if slaveJar isFile args add jar add slaveJar else in production code this never happens but during debugging this is convenientud args add cp add slaveJar add hudson remoting Launcher class getName if rootPassword null try sudo in the hope that the user has the permission to do so without password return new LocalLauncher listener launchChannel args prepend sudoExe toCommandArray listener getLogger null Collections String String emptyMap else try sudo with the given password Also run in pfexec so that we can elevate the privileges Process proc sudoWithPass args return Channels forProcess args toStringWithQuote Computer threadPoolForRemoting proc listener getLoggerpackage hudson util import hudson PluginManager UberClassLoader import jenkins model Jenkins import org kohsuke asm5 ClassWriter import org kohsuke asm5 MethodVisitor import org kohsuke asm5 Type import java lang reflect Constructor import static org kohsuke asm5 Opcodes public class SubClassGenerator extends ClassLoader public SubClassGenerator ClassLoader parent super parent public T Class extends T generate Class T base String name ClassWriter cw new ClassWriter 0 cw visit 49 ACC PUBLIC name replace null Type getInternalName base null for Constructor c base getDeclaredConstructors Class et c getExceptionTypes String exceptions new String et length for int i 0 i et length i exceptions i Type getInternalName et i String methodDescriptor getMethodDescriptor c MethodVisitor m cw visitMethod c getModifiers init methodDescriptor null exceptions m visitCode int index 1 m visitVarInsn ALOAD 0 for Class param c getParameterTypes Type t Type getType param m visitVarInsn t getOpcode ILOAD index index t getSize m visitMethodInsn INVOKESPECIAL Type getInternalName base init methodDescriptor m visitInsn RETURN m visitMaxs index index m visitEnd cw visitEnd byte image cw toByteArray Class extends T c defineClass name image 0 image length asSubclass base Jenkins h Jenkins getInstanceOrNull if h null null only during tests UberClassLoader h pluginManager uberClassLoader addNamedClass name c can t change the field type as it breaks binary compatibility return c private String getMethodDescriptor Constructor c StringBuilder buf new StringBuilder buf append for Class p c getParameterTypes buf append Type getDescriptor p buf append V return buf toStringpackage hudson model queue import hudson model AbstractProject import hudson model Executor import hudson model Label import hudson model Node import hudson model Queue Executable import hudson model Queue Task import hudson model ResourceActivity import javax annotation Nonnull import java io IOException import javax annotation CheckForNull public interface SubTask extends ResourceActivity Label getAssignedLabel Node getLastBuiltOn long getEstimatedDuration CheckForNull Executable createExecutable throws IOException Nonnull Task getOwnerTask Object getSameNodeConstraintpackage hudson model queue import hudson Extension import hudson ExtensionList import hudson ExtensionPoint import hudson model AbstractProject import java util Collection import java util Collections public abstract class SubTaskContributor implements ExtensionPoint public Collection extends SubTask forProject AbstractProject p return Collections emptyList public static ExtensionList SubTaskContributor all return ExtensionList lookup SubTaskContributor classpackage hudson search import hudson model Item import hudson model ItemGroup public class SuggestedItem private final SuggestedItem parent public final SearchItem item private String path public SuggestedItem SearchItem top this null top public SuggestedItem SuggestedItem parent SearchItem item this parent parent this item item public String getPath if path null return path if parent null return path item getSearchName else StringBuilder buf new StringBuilder getPath buf return path buf toString private void getPath StringBuilder buf if parent null buf append item getSearchName else parent getPath buf buf append append item getSearchName public String getUrl StringBuilder buf new StringBuilder getUrl buf return buf toString private static SuggestedItem build SearchableModelObject searchContext Item top ItemGroup extends Item parent top getParent if parent instanceof Item Item parentItem Item parent return new SuggestedItem build searchContext parentItem top return new SuggestedItem top public static SuggestedItem build SearchableModelObject searchContext SearchItem si if si instanceof Item return build searchContext Item si return new SuggestedItem si private void getUrl StringBuilder buf if parent null parent getUrl buf String f item getSearchUrl if f startsWith buf setLength 0 buf append f else if buf length 0 buf charAt buf length 1 buf append buf append fpackage hudson node monitors import hudson Util import hudson Extension import hudson Functions import hudson model Computer import jenkins model Jenkins import jenkins security MasterToSlaveCallable import net sf json JSONObject import org jenkinsci Symbol import org jvnet hudson MemoryMonitor import org jvnet hudson MemoryUsage import org kohsuke stapler StaplerRequest import org kohsuke stapler export ExportedBean import org kohsuke stapler export Exported import java io IOException public class SwapSpaceMonitor extends NodeMonitor public String toHtml MemoryUsage usage if usage availableSwapSpace 1 return N A String humanReadableSpace Functions humanReadableByteSize usage availableSwapSpace long free usage availableSwapSpace free 1024L convert to KB free 1024L convert to MB if free 256 usage totalSwapSpace usage availableSwapSpace 5 return humanReadableSpace if we have more than 256MB free or less than 80 filled up it s OK Otherwise considered dangerously low return Util wrapToErrorSpan humanReadableSpace public long toMB MemoryUsage usage if usage availableSwapSpace 1 return 1 long free usage availableSwapSpace free 1024L convert to KB free 1024L convert to MB return free Override public String getColumnCaption Hide this column from non admins return Jenkins getInstance hasPermission Jenkins ADMINISTER super getColumnCaption null public static AbstractNodeMonitorDescriptor MemoryUsage DESCRIPTOR Extension Symbol swapSpace public static class DescriptorImpl extends AbstractAsyncNodeMonitorDescriptor MemoryUsage public DescriptorImpl DESCRIPTOR this Override protected MonitorTask createCallable Computer c return new MonitorTask public String getDisplayName return Messages SwapSpaceMonitor DisplayName Override public NodeMonitor newInstance StaplerRequest req JSONObject formData throws FormException return new SwapSpaceMonitor private static class MonitorTask extends MasterToSlaveCallable MemoryUsage IOException public MemoryUsage call throws IOException MemoryMonitor mm try mm MemoryMonitor get catch IOException e return report e catch LinkageError e JENKINS 15796 return report e return new MemoryUsage2 mm monitor private T extends Throwable MemoryUsage report T e throws T if warned warned true throw e else JENKINS 2194 return null private static final long serialVersionUID 1L private static boolean warned false ExportedBean public static class MemoryUsage2 extends MemoryUsage private static final long serialVersionUID 2216994637932270352L public MemoryUsage2 MemoryUsage mem super mem totalPhysicalMemory mem availablePhysicalMemory mem totalSwapSpace mem availableSwapSpace Exported public long getTotalPhysicalMemory return totalPhysicalMemory Exported public long getAvailablePhysicalMemory return availablePhysicalMemory Exported public long getTotalSwapSpace return totalSwapSpace Exported public long getAvailableSwapSpace return availableSwapSpacepackage com twitter sdk android core internal scribe import com google gson annotations SerializedName import java util Collections import java util List public class SyndicatedSdkImpressionEvent extends ScribeEvent public static final String CLIENT NAME android private static final String SCRIBE CATEGORY syndicated sdk impression SerializedName external ids public final ExternalIds externalIds SerializedName device id created at public final long deviceIdCreatedAt SerializedName language public final String language public SyndicatedSdkImpressionEvent EventNamespace eventNamespace long timestamp String language String adId this eventNamespace timestamp language adId Collections ScribeItem emptyList public SyndicatedSdkImpressionEvent EventNamespace eventNamespace long timestamp String language String adId List ScribeItem items super SCRIBE CATEGORY eventNamespace timestamp items this language language this externalIds new ExternalIds adId this deviceIdCreatedAt 0 see field comment public class ExternalIds SerializedName AD ID public final String adId public ExternalIds String adId this adId adIdpackage com twitter sdk android core internal scribe import com google gson annotations SerializedName import java util List public class SyndicationClientEvent extends ScribeEvent public static final String CLIENT NAME tfw private static final String SCRIBE CATEGORY tfw client event SerializedName language public final String language SerializedName event info public final String eventInfo SerializedName external ids public final ExternalIds externalIds public SyndicationClientEvent EventNamespace eventNamespace String eventInfo long timestamp String language String adId List ScribeItem items super SCRIBE CATEGORY eventNamespace timestamp items this language language this eventInfo eventInfo externalIds new ExternalIds adId public class ExternalIds SerializedName 6 public final String adId public ExternalIds String adId this adId adIdpackage jenkins management import hudson Extension import hudson model ManagementLink import org jenkinsci Symbol Extension ordinal Integer MAX VALUE 500 Symbol systemInfo public class SystemInfoLink extends ManagementLink Override public String getIconFileName return computer png public String getDisplayName return Messages SystemInfoLink DisplayName Override public String getDescription return Messages SystemInfoLink Description Override public String getUrlName return systemInfopackage jenkins management import hudson Extension import hudson model ManagementLink import org jenkinsci Symbol Extension ordinal Integer MAX VALUE 600 Symbol log public class SystemLogLink extends ManagementLink Override public String getIconFileName return clipboard png public String getDisplayName return Messages SystemLogLink DisplayName Override public String getDescription return Messages SystemLogLink Description Override public String getUrlName return logpackage jenkins util import edu umd cs findbugs annotations CheckForNull import edu umd cs findbugs annotations Nullable import edu umd cs findbugs annotations SuppressFBWarnings import hudson EnvVars import java util logging Level import java util logging Logger import javax servlet ServletContext import javax servlet ServletContextEvent import javax servlet ServletContextListener import jenkins util io OnMaster import org apache commons lang StringUtils import org kohsuke accmod Restricted import org kohsuke accmod restrictions NoExternalUse TODO Define a correct design of this engine later Should be accessible in libs remoting stapler and Jenkins modules too Restricted NoExternalUse class public class SystemProperties implements ServletContextListener OnMaster this class implements ServletContextListener and is declared in WEB INF web xml CheckForNull private static ServletContext theContext private static final Logger LOGGER Logger getLogger SystemProperties class getName public SystemProperties Override SuppressFBWarnings value ST WRITE TO STATIC FROM INSTANCE METHOD justification Currently Jenkins instance may have one ond only one context public void contextInitialized ServletContextEvent event theContext event getServletContext CheckForNull public static String getString String key String value System getProperty key keep passing on any exceptions if value null if LOGGER isLoggable Level CONFIG LOGGER log Level CONFIG Property system 0 1 new Object key value return value value tryGetValueFromContext key if value null if LOGGER isLoggable Level CONFIG LOGGER log Level CONFIG Property context 0 1 new Object key value return value if LOGGER isLoggable Level CONFIG LOGGER log Level CONFIG Property not found 0 1 new Object key value return null public static String getString String key CheckForNull String def String value System getProperty key keep passing on any exceptions if value null if LOGGER isLoggable Level CONFIG LOGGER log Level CONFIG Property system 0 1 new Object key value return value value tryGetValueFromContext key if value null if LOGGER isLoggable Level CONFIG LOGGER log Level CONFIG Property context 0 1 new Object key value return value value def if LOGGER isLoggable Level CONFIG LOGGER log Level CONFIG Property default 0 1 new Object key value return value public static boolean getBoolean String name return getBoolean name false public static boolean getBoolean String name boolean def String v getString name if v null return Boolean parseBoolean v return def CheckForNull public static Boolean optBoolean String name String v getString name return v null null Boolean parseBoolean v CheckForNull public static Integer getInteger String name return getInteger name null public static Integer getInteger String name Integer def String v getString name if v null try return Integer decode v catch NumberFormatException e Ignore fallback to default if LOGGER isLoggable Level CONFIG LOGGER log Level CONFIG Property Value is not integer 0 1 new Object name v return def CheckForNull public static Long getLong String name return getLong name null public static Long getLong String name Long def String v getString name if v null try return Long decode v catch NumberFormatException e Ignore fallback to default if LOGGER isLoggable Level CONFIG LOGGER log Level CONFIG Property Value is not long 0 1 new Object name v return def CheckForNull private static String tryGetValueFromContext String key if StringUtils isNotBlank key theContext null try String value theContext getInitParameter key if value null return value catch SecurityException ex Log exception and go on LOGGER log Level CONFIG Access to the property 0 is prohibited key return null Override public void contextDestroyed ServletContextEvent event nothing to dopackage jenkins slaves systemInfo import hudson Extension import org jenkinsci Symbol Extension ordinal 3 Symbol systemProperties public class SystemPropertySlaveInfo extends SlaveSystemInfo Override public String getDisplayName return Messages SystemPropertySlaveInfo DisplayNamepackage com kaku colorfulnews utils import android annotation TargetApi import android app Activity import android os Build import android view View TargetApi Build VERSION CODES KITKAT public class SystemUiVisibilityUtil private static final int FLAG IMMERSIVE View SYSTEM UI FLAG IMMERSIVE SYSTEM UI FLAG HIDE NAVIGATION View SYSTEM UI FLAG HIDE NAVIGATION View SYSTEM UI FLAG FULLSCREEN Activity public static void exit Activity activity if Build VERSION SDK INT 19 addFlags activity getWindow getDecorView FLAG IMMERSIVE public static void addFlags View decorView int flags decorView setSystemUiVisibility decorView getSystemUiVisibility flags public static void enter Activity activity if Build VERSION SDK INT 19 clearFlags activity getWindow getDecorView FLAG IMMERSIVE public static void clearFlags View view int flags view setSystemUiVisibility view getSystemUiVisibility flags flags view getSystemUiVisibility flagspackage hudson util import org xml sax helpers XMLFilterImpl import org xml sax XMLFilter import org xml sax ContentHandler import org xml sax Attributes import org xml sax SAXException import org apache commons jelly XMLOutput import java util Locale import java util Stack import java util Map import java util HashMap import java util Set import java util HashSet import java util Arrays public class TableNestChecker extends XMLFilterImpl private final Stack Checker elements new Stack Checker private final Stack String tagNames new Stack String public static void applyTo XMLOutput xo xo setContentHandler new TableNestChecker xo getContentHandler public TableNestChecker elements push ALL ALLOWED public TableNestChecker ContentHandler target this setContentHandler target Override public void startElement String uri String localName String qName Attributes atts throws SAXException String tagName localName toUpperCase Locale ENGLISH make sure that this tag occurs in the proper context if elements peek isAllowed tagName throw new SAXException tagName is not allowed inside tagNames peek Checker next CHECKERS get tagName if next null next ALL ALLOWED elements push next tagNames push tagName super startElement uri localName qName atts Override public void endElement String uri String localName String qName throws SAXException elements pop tagNames pop super endElement uri localName qName private interface Checker boolean isAllowed String childTag private static final Checker ALL ALLOWED new Checker public boolean isAllowed String childTag return true private static final class InList implements Checker private final Set String tags private InList String tags this tags new HashSet String Arrays asList tags public boolean isAllowed String childTag return tags contains childTag private static final Map String Checker CHECKERS new HashMap String Checker static CHECKERS put TABLE new InList TR THEAD TBODY InList rows new InList TR CHECKERS put THEAD rows CHECKERS put THEAD rows CHECKERS put TR new InList TD THpackage hudson util import java util AbstractList import java util ArrayList import java util List public class TagCloud T extends AbstractList TagCloud T Entry public final class Entry public final T item public final float weight public Entry T item float weight this item item this weight weight public float scale TODO it s not obvious if linear scaling is the right approach or not return weight 9 max public String getClassName return tag int scale public interface WeightFunction T float weight T item private final List Entry entries new ArrayList Entry private float max 1 public TagCloud Iterable extends T inputs WeightFunction T f for T input inputs float w Math abs f weight input max Math max w max entries add new Entry input w public Entry get int index return entries get index public int size return entries sizepackage hudson util io import hudson Functions import hudson os PosixException import hudson util FileVisitor import hudson util IOUtils import java io File import java io FileInputStream import java io IOException import java io OutputStream import org apache commons compress archivers tar TarArchiveEntry import org apache commons compress archivers tar TarArchiveOutputStream import org apache commons compress archivers tar TarConstants import org apache commons compress utils BoundedInputStream final class TarArchiver extends Archiver private final byte buf new byte 8192 private final TarArchiveOutputStream tar TarArchiver OutputStream out tar new TarArchiveOutputStream out tar setBigNumberMode TarArchiveOutputStream BIGNUMBER STAR tar setLongFileMode TarArchiveOutputStream LONGFILE GNU Override public void visitSymlink File link String target String relativePath throws IOException TarArchiveEntry e new TarArchiveEntry relativePath TarConstants LF SYMLINK try int mode IOUtils mode link if mode 1 e setMode mode catch PosixException x ignore e setLinkName target tar putArchiveEntry e tar closeArchiveEntry entriesWritten Override public boolean understandsSymlink return true public void visit File file String relativePath throws IOException if Functions isWindows relativePath relativePath replace if file isDirectory relativePath TarArchiveEntry te new TarArchiveEntry relativePath int mode IOUtils mode file if mode 1 te setMode mode te setModTime file lastModified long size 0 if file isDirectory size file length te setSize size tar putArchiveEntry te try if file isDirectory ensure we don t write more bytes than the declared when we created the entry try FileInputStream fin new FileInputStream file BoundedInputStream in new BoundedInputStream fin size int len while len in read buf 0 tar write buf 0 len catch IOException e log the exception in any case IOException ioE new IOException Error writing to tar file from file e throw ioE finally always close the entry tar closeArchiveEntry entriesWritten public void close throws IOException tar closepackage hudson org apache tools tar import org apache tools tar TarBuffer import org apache tools tar TarEntry import java io FilterInputStream import java io IOException import java io InputStream import java io OutputStream import java io ByteArrayOutputStream Deprecated public class TarInputStream extends FilterInputStream CheckStyle VisibilityModifier OFF bc protected boolean debug protected boolean hasHitEOF protected long entrySize protected long entryOffset protected byte readBuf protected TarBuffer buffer protected TarEntry currEntry protected byte oneBuf CheckStyle VisibilityModifier ON public TarInputStream InputStream is this is TarBuffer DEFAULT BLKSIZE TarBuffer DEFAULT RCDSIZE public TarInputStream InputStream is int blockSize this is blockSize TarBuffer DEFAULT RCDSIZE public TarInputStream InputStream is int blockSize int recordSize super is this buffer new TarBuffer is blockSize recordSize this readBuf null this oneBuf new byte 1 this debug false this hasHitEOF false public void setDebug boolean debug this debug debug this buffer setDebug debug public void close throws IOException this buffer close public int getRecordSize return this buffer getRecordSize public int available throws IOException if this entrySize this entryOffset Integer MAX VALUE return Integer MAX VALUE return int this entrySize this entryOffset public long skip long numToSkip throws IOException REVIEW This is horribly inefficient but it ensures that we properly skip over bytes via the TarBuffer byte skipBuf new byte 8 1024 long skip numToSkip while skip 0 int realSkip int skip skipBuf length skipBuf length skip int numRead this read skipBuf 0 realSkip if numRead 1 break skip numRead return numToSkip skip public boolean markSupported return false public void mark int markLimit public void reset public TarEntry getNextEntry throws IOException if this hasHitEOF return null if this currEntry null long numToSkip this entrySize this entryOffset if this debug System err println TarInputStream SKIP currENTRY this currEntry getName SZ this entrySize OFF this entryOffset skipping numToSkip bytes if numToSkip 0 this skip numToSkip this readBuf null byte headerBuf this buffer readRecord if headerBuf null if this debug System err println READ NULL RECORD this hasHitEOF true else if this buffer isEOFRecord headerBuf if this debug System err println READ EOF RECORD this hasHitEOF true if this hasHitEOF this currEntry null else this currEntry new TarEntry headerBuf if this debug System err println TarInputStream SET CURRENTRY this currEntry getName size this currEntry getSize this entryOffset 0 this entrySize this currEntry getSize if this currEntry null this currEntry isGNULongNameEntry read in the name ByteArrayOutputStream baos new ByteArrayOutputStream byte buf new byte 256 int length while length read buf 0 baos write buf 0 length getNextEntry if this currEntry null Bugzilla 40334 Malformed tar file long entry name not followed by entry return null String longName baos toString UTF 8 remove trailing null terminator if longName length 0 longName charAt longName length 1 0 longName longName substring 0 longName length 1 this currEntry setName longName return this currEntry public int read throws IOException int num this read this oneBuf 0 1 return num 1 1 int this oneBuf 0 0xFF public int read byte buf int offset int numToRead throws IOException int totalRead 0 if this entryOffset this entrySize return 1 if numToRead this entryOffset this entrySize numToRead int this entrySize this entryOffset if this readBuf null int sz numToRead this readBuf length this readBuf length numToRead System arraycopy this readBuf 0 buf offset sz if sz this readBuf length this readBuf null else int newLen this readBuf length sz byte newBuf new byte newLen System arraycopy this readBuf sz newBuf 0 newLen this readBuf newBuf totalRead sz numToRead sz offset sz while numToRead 0 byte rec this buffer readRecord if rec null Unexpected EOF throw new IOException unexpected EOF with numToRead bytes unread int sz numToRead int recLen rec length if recLen sz System arraycopy rec 0 buf offset sz this readBuf new byte recLen sz System arraycopy rec sz this readBuf 0 recLen sz else sz recLen System arraycopy rec 0 buf offset recLen totalRead sz numToRead sz offset sz this entryOffset totalRead return totalRead public void copyEntryContents OutputStream out throws IOException byte buf new byte 32 1024 while true int numRead this read buf 0 buf length if numRead 1 break out write buf 0 numReadpackage hudson org apache tools tar import org apache tools tar TarBuffer import org apache tools tar TarConstants import org apache tools tar TarEntry import java io FilterOutputStream import java io OutputStream import java io IOException Deprecated public class TarOutputStream extends FilterOutputStream public static final int LONGFILE ERROR 0 public static final int LONGFILE TRUNCATE 1 public static final int LONGFILE GNU 2 CheckStyle VisibilityModifier OFF bc protected boolean debug protected long currSize protected String currName protected long currBytes protected byte oneBuf protected byte recordBuf protected int assemLen protected byte assemBuf protected TarBuffer buffer protected int longFileMode LONGFILE ERROR CheckStyle VisibilityModifier ON private boolean closed false public TarOutputStream OutputStream os this os TarBuffer DEFAULT BLKSIZE TarBuffer DEFAULT RCDSIZE public TarOutputStream OutputStream os int blockSize this os blockSize TarBuffer DEFAULT RCDSIZE public TarOutputStream OutputStream os int blockSize int recordSize super os this buffer new TarBuffer os blockSize recordSize this debug false this assemLen 0 this assemBuf new byte recordSize this recordBuf new byte recordSize this oneBuf new byte 1 public void setLongFileMode int longFileMode this longFileMode longFileMode public void setDebug boolean debugF this debug debugF public void setBufferDebug boolean debug this buffer setDebug debug public void finish throws IOException See Bugzilla 28776 for a discussion on this http issues apache org bugzilla show bug cgi id 28776 this writeEOFRecord this writeEOFRecord public void close throws IOException if closed this finish this buffer close out close closed true public int getRecordSize return this buffer getRecordSize public void putNextEntry TarEntry entry throws IOException if entry getName length TarConstants NAMELEN if longFileMode LONGFILE GNU create a TarEntry for the LongLink the contents of which are the entry s name TarEntry longLinkEntry new TarEntry TarConstants GNU LONGLINK TarConstants LF GNUTYPE LONGNAME byte name entry getName getBytes UTF 8 longLinkEntry setSize name length 1 putNextEntry longLinkEntry write name write 0 closeEntry else if longFileMode LONGFILE TRUNCATE throw new RuntimeException file name entry getName is too long TarConstants NAMELEN bytes entry writeEntryHeader this recordBuf this buffer writeRecord this recordBuf this currBytes 0 if entry isDirectory this currSize 0 else this currSize entry getSize currName entry getName public void closeEntry throws IOException if this assemLen 0 for int i this assemLen i this assemBuf length i this assemBuf i 0 this buffer writeRecord this assemBuf this currBytes this assemLen this assemLen 0 if this currBytes this currSize throw new IOException entry currName closed at this currBytes before the this currSize bytes specified in the header were written public void write int b throws IOException this oneBuf 0 byte b this write this oneBuf 0 1 public void write byte wBuf throws IOException this write wBuf 0 wBuf length public void write byte wBuf int wOffset int numToWrite throws IOException if this currBytes numToWrite this currSize throw new IOException request to write numToWrite bytes exceeds size in header of this currSize bytes for entry currName We have to deal with assembly The programmer can be writing little 32 byte chunks for all we know and we must assemble complete records for writing REVIEW Maybe this should be in TarBuffer Could that help to eliminate some of the buffer copying if this assemLen 0 if this assemLen numToWrite this recordBuf length int aLen this recordBuf length this assemLen System arraycopy this assemBuf 0 this recordBuf 0 this assemLen System arraycopy wBuf wOffset this recordBuf this assemLen aLen this buffer writeRecord this recordBuf this currBytes this recordBuf length wOffset aLen numToWrite aLen this assemLen 0 else System arraycopy wBuf wOffset this assemBuf this assemLen numToWrite wOffset numToWrite this assemLen numToWrite numToWrite 0 When we get here we have EITHER o An empty assemble buffer o No bytes to write numToWrite 0 while numToWrite 0 if numToWrite this recordBuf length System arraycopy wBuf wOffset this assemBuf this assemLen numToWrite this assemLen numToWrite break this buffer writeRecord wBuf wOffset int num this recordBuf length this currBytes num numToWrite num wOffset num private void writeEOFRecord throws IOException for int i 0 i this recordBuf length i this recordBuf i 0 this buffer writeRecord this recordBufpackage hudson model import hudson console AnnotatedLargeText import org kohsuke stapler framework io LargeText import org kohsuke stapler StaplerRequest import org kohsuke stapler StaplerResponse import javax servlet ServletException import javax servlet http HttpServletResponse import java lang ref WeakReference import java io IOException import hudson security Permission import hudson security ACL public abstract class TaskAction extends AbstractModelObject implements Action protected transient volatile TaskThread workerThread protected transient WeakReference AnnotatedLargeText log protected abstract Permission getPermission protected abstract ACL getACL Override public abstract String getIconFileName Deprecated public LargeText getLog return obtainLog public AnnotatedLargeText obtainLog WeakReference AnnotatedLargeText l log if l null return null return l get public String getSearchUrl return getUrlName public TaskThread getWorkerThread return workerThread public void doProgressiveLog StaplerRequest req StaplerResponse rsp throws IOException AnnotatedLargeText text obtainLog if text null text doProgressText req rsp return rsp setStatus HttpServletResponse SC OK public void doProgressiveHtml StaplerRequest req StaplerResponse rsp throws IOException AnnotatedLargeText text obtainLog if text null text doProgressiveHtml req rsp return rsp setStatus HttpServletResponse SC OK public synchronized void doClearError StaplerRequest req StaplerResponse rsp throws IOException ServletException getACL checkPermission getPermission if workerThread null workerThread isRunning workerThread null rsp sendRedirectpackage hudson model import hudson console ConsoleNote import hudson console HyperlinkNote import hudson util AbstractTaskListener import hudson util NullStream import hudson util StreamTaskListener import java io IOException import java io PrintStream import java io PrintWriter import java io Serializable import java util Formatter public interface TaskListener extends Serializable PrintStream getLogger void annotate ConsoleNote ann throws IOException void hyperlink String url String text throws IOException PrintWriter error String msg PrintWriter error String format Object args PrintWriter fatalError String msg PrintWriter fatalError String format Object args TaskListener NULL new StreamTaskListener new NullStreampackage hudson init import com google inject Injector import hudson model Hudson import jenkins model Jenkins import org jvnet hudson annotation indexer Index import org jvnet hudson reactor Milestone import org jvnet hudson reactor MilestoneImpl import org jvnet hudson reactor Reactor import org jvnet hudson reactor Task import org jvnet hudson reactor TaskBuilder import org jvnet localizer ResourceBundleHolder import java io IOException import java lang annotation Annotation import java lang reflect InvocationTargetException import java lang reflect Method import java lang reflect Modifier import java util ArrayList import java util Collection import java util HashSet import java util List import java util MissingResourceException import java util Set import java util logging Logger import static java util logging Level WARNING abstract class TaskMethodFinder T extends Annotation extends TaskBuilder private static final Logger LOGGER Logger getLogger TaskMethodFinder class getName protected final ClassLoader cl private final Set Method discovered new HashSet Method private final Class T type private final Class extends Enum milestoneType public TaskMethodFinder Class T type Class extends Enum milestoneType ClassLoader cl this type type this milestoneType milestoneType this cl cl working around the restriction that Java doesn t allow annotation types to extend interfaces protected abstract String displayNameOf T i protected abstract String requiresOf T i protected abstract String attainsOf T i protected abstract Milestone afterOf T i protected abstract Milestone beforeOf T i protected abstract boolean fatalOf T i public Collection Task discoverTasks Reactor session throws IOException List Task result new ArrayList Task for Method e Index list type cl Method class if filter e continue already reported once T i e getAnnotation type if i null continue stale index result add new TaskImpl i e return result protected boolean filter Method e return discovered add e protected String getDisplayNameOf Method e T i Class c e getDeclaringClass String key displayNameOf i if key length 0 return c getSimpleName e getName try ResourceBundleHolder rb ResourceBundleHolder get c getClassLoader loadClass c getPackage getName Messages return rb format key catch ClassNotFoundException x LOGGER log WARNING Failed to load x getMessage for e toString x return key catch MissingResourceException x LOGGER log WARNING Could not find key key in c getPackage getName Messages x return key protected void invoke Method e try Class pt e getParameterTypes Object args new Object pt length for int i 0 i args length i args i lookUp pt i e invoke Modifier isStatic e getModifiers null lookUp e getDeclaringClass args catch IllegalAccessException x throw Error new IllegalAccessError initCause x catch InvocationTargetException x throw new Error x private Object lookUp Class type Jenkins j Jenkins getInstance assert j null This method is only invoked after the Jenkins singleton instance has been set if type Jenkins class type Hudson class return j Injector i j getInjector if i null return i getInstance type throw new IllegalArgumentException Unable to inject type public class TaskImpl implements Task final Collection Milestone requires final Collection Milestone attains private final T i private final Method e private TaskImpl T i Method e this i i this e e requires toMilestones requiresOf i afterOf i attains toMilestones attainsOf i beforeOf i public T getAnnotation return i public Method getMethod return e public Collection Milestone requires return requires public Collection Milestone attains return attains public String getDisplayName return getDisplayNameOf e i public boolean failureIsFatal return fatalOf i public void run Reactor session invoke e public String toString return e toString private Collection Milestone toMilestones String tokens Milestone m List Milestone r new ArrayList Milestone for String s tokens try r add Milestone Enum valueOf milestoneType s catch IllegalArgumentException x r add new MilestoneImpl s r add m return rpackage hudson model queue import hudson model Queue Item import hudson model Queue Task import hudson security ACL import org acegisecurity Authentication import java util Collection import java util Collections import javax annotation Nonnull import jenkins security QueueItemAuthenticator import jenkins security QueueItemAuthenticatorConfiguration public class Tasks public static Collection extends SubTask getSubTasksOf Task task try return task getSubTasks catch AbstractMethodError e return Collections singleton task public static Object getSameNodeConstraintOf SubTask t try return t getSameNodeConstraint catch AbstractMethodError e return null public static Nonnull Task getOwnerTaskOf Nonnull SubTask t try return t getOwnerTask catch AbstractMethodError e return Task t Nonnull public static Authentication getDefaultAuthenticationOf Task t try return t getDefaultAuthentication catch AbstractMethodError e return ACL SYSTEM Nonnull public static Authentication getDefaultAuthenticationOf Task t Item item try return t getDefaultAuthentication item catch AbstractMethodError e return getDefaultAuthenticationOf t public static Nonnull Authentication getAuthenticationOf Nonnull Task t for QueueItemAuthenticator qia QueueItemAuthenticatorConfiguration get getAuthenticators Authentication a qia authenticate t if a null return a return getDefaultAuthenticationOf tpackage hudson model import hudson console AnnotatedLargeText import hudson util StreamTaskListener import java io File import java io IOException import java io Reader import java lang ref WeakReference import java nio charset Charset import org kohsuke stapler framework io LargeText import org kohsuke stapler framework io ByteBuffer public abstract class TaskThread extends Thread Deprecated private final LargeText text private final AnnotatedLargeText TaskAction log private TaskListener listener private final TaskAction owner private volatile boolean isRunning protected TaskThread TaskAction owner ListenerAndText output FIXME this failed to compile super owner getBuild toString owner getDisplayName Please implement more general way how to get information about action owner if you want it in the thread s name super owner getDisplayName this owner owner this text this log output text this listener output listener this isRunning true public Reader readAll throws IOException this method can be invoked from another thread return text readAll protected final void associateWith TaskAction action action workerThread this action log new WeakReference AnnotatedLargeText log Override public void start associateWith owner super start public boolean isRunning return isRunning protected ListenerAndText createListener throws IOException return ListenerAndText forMemory Override public final void run isRunning true try perform listener listener getLogger println Completed owner workerThread null catch InterruptedException e listener getLogger println Aborted catch Exception e e printStackTrace listener getLogger finally listener null isRunning false log markAsComplete protected abstract void perform TaskListener listener throws Exception public static final class ListenerAndText final TaskListener listener final AnnotatedLargeText TaskAction text public ListenerAndText TaskListener listener AnnotatedLargeText TaskAction text this listener listener this text text Deprecated public static ListenerAndText forMemory return forMemory null Deprecated public static ListenerAndText forFile File f throws IOException return forFile f null public static ListenerAndText forMemory TaskAction context StringWriter is synchronized ByteBuffer log new ByteBuffer return new ListenerAndText new StreamTaskListener log new AnnotatedLargeText TaskAction log Charset defaultCharset false context public static ListenerAndText forFile File f TaskAction context throws IOException return new ListenerAndText new StreamTaskListener f new AnnotatedLargeText TaskAction f Charset defaultCharset false contextpackage hudson import java io ByteArrayInputStream import java io SequenceInputStream import java io Writer import java nio charset Charset import java security interfaces RSAPublicKey import javax annotation Nullable import jenkins model Jenkins import jenkins model identity InstanceIdentityProvider import jenkins util SystemProperties import hudson slaves OfflineCause import java io DataOutputStream import java io InputStream import java io OutputStream import java io UnsupportedEncodingException import java net SocketAddress import java util Arrays import jenkins AgentProtocol import java io BufferedWriter import java io DataInputStream import java io IOException import java io OutputStreamWriter import java io PrintWriter import java net BindException import java net InetSocketAddress import java net Socket import java nio channels ServerSocketChannel import java util logging Level import java util logging Logger import org apache commons codec binary Base64 import org apache commons io Charsets import org apache commons io IOUtils import org apache commons io output NullOutputStream import org apache commons lang StringUtils public final class TcpSlaveAgentListener extends Thread private final ServerSocketChannel serverSocket private volatile boolean shuttingDown public final int configuredPort public TcpSlaveAgentListener int port throws IOException super TCP agent listener port port try serverSocket ServerSocketChannel open serverSocket socket bind new InetSocketAddress port catch BindException e throw BindException new BindException Failed to listen on port port because it s already in use initCause e this configuredPort port LOGGER log Level FINE JNLP agent listener started on TCP port 0 getPort start public int getPort return serverSocket socket getLocalPort public int getAdvertisedPort return CLI PORT null CLI PORT getPort Nullable public String getIdentityPublicKey RSAPublicKey key InstanceIdentityProvider RSA getPublicKey return key null null new String Base64 encodeBase64 key getEncoded Charset forName UTF 8 public String getAgentProtocolNames return StringUtils join Jenkins getInstance getAgentProtocols Override public void run try the loop eventually terminates when the socket is closed while shuttingDown Socket s serverSocket accept socket this prevents a connection from silently terminated by the router in between or the other peer and that goes without unnoticed However the time out is often very long for example 2 hours by default in Linux that this alone is enough to prevent that s setKeepAlive true we take care of buffering on our own s setTcpNoDelay true new ConnectionHandler s start catch IOException e if shuttingDown LOGGER log Level SEVERE Failed to accept JNLP agent connections e public void shutdown shuttingDown true try SocketAddress localAddress serverSocket getLocalAddress if localAddress instanceof InetSocketAddress InetSocketAddress address InetSocketAddress localAddress Socket client new Socket address getHostName address getPort client setSoTimeout 1000 waking the acceptor loop should be quick new PingAgentProtocol connect client catch IOException e LOGGER log Level FINE Failed to send Ping to wake acceptor loop e try serverSocket close catch IOException e LOGGER log Level WARNING Failed to close down TCP port e private final class ConnectionHandler extends Thread private final Socket s private final int id public ConnectionHandler Socket s this s s synchronized getClass id iotaGen setName TCP agent connection handler id with s getRemoteSocketAddress Override public void run try LOGGER log Level INFO Accepted connection 0 from 1 new Object id s getRemoteSocketAddress DataInputStream in new DataInputStream s getInputStream PrintWriter out new PrintWriter new BufferedWriter new OutputStreamWriter s getOutputStream UTF 8 true DEPRECATED newer protocol shouldn t use PrintWriter but should use DataOutputStream peek the first few bytes to determine what to do with this client byte head new byte 10 in readFully head String header new String head Charsets US ASCII if header startsWith GET this looks like an HTTP client respondHello header s return otherwise assume this is AgentProtocol and start from the beginning String s new DataInputStream new SequenceInputStream new ByteArrayInputStream head in readUTF if s startsWith Protocol String protocol s substring 9 AgentProtocol p AgentProtocol of protocol if p null if Jenkins getInstance getAgentProtocols contains protocol p handle this s else error out Disabled protocol s else error out Unknown protocol s else error out Unrecognized protocol s catch InterruptedException e LOGGER log Level WARNING Connection id aborted e try s close catch IOException try to clean up the socket catch IOException e LOGGER log Level WARNING Connection id failed e try s close catch IOException try to clean up the socket private void respondHello String header Socket s throws IOException try Writer o new OutputStreamWriter s getOutputStream UTF 8 if header startsWith GET o write HTTP 1 0 200 OK r n o write Content Type text plain charset UTF 8 r n o write r n o write Jenkins Agent Protocols getAgentProtocolNames r n o write Jenkins Version Jenkins VERSION r n o write Jenkins Session Jenkins SESSION HASH r n o write Client s getInetAddress getHostAddress r n o write Server s getLocalAddress getHostAddress r n o flush s shutdownOutput else o write HTTP 1 0 404 Not Found r n o write Content Type text plain charset UTF 8 r n o write r n o write Not Found r n o flush s shutdownOutput InputStream i s getInputStream IOUtils copy i new NullOutputStream s shutdownInput finally s close private void error PrintWriter out String msg throws IOException out println msg LOGGER log Level WARNING Connection id is aborted msg s close Extension public static class PingAgentProtocol extends AgentProtocol private final byte ping public PingAgentProtocol try ping Ping n getBytes UTF 8 catch UnsupportedEncodingException e throw new IllegalStateException JLS mandates support for UTF 8 charset e Override public boolean isRequired return true Override public String getName return Ping Override public String getDisplayName return Messages TcpSlaveAgentListener PingAgentProtocol displayName Override public void handle Socket socket throws IOException InterruptedException try OutputStream stream socket getOutputStream try LOGGER log Level FINE Received ping request from 0 socket getRemoteSocketAddress stream write ping stream flush LOGGER log Level FINE Sent ping response to 0 socket getRemoteSocketAddress finally stream close finally socket close public boolean connect Socket socket throws IOException try DataOutputStream out null InputStream in null try LOGGER log Level FINE Requesting ping from 0 socket getRemoteSocketAddress out new DataOutputStream socket getOutputStream out writeUTF Protocol Ping in socket getInputStream byte response new byte ping length int responseLength in read response if responseLength ping length Arrays equals response ping LOGGER log Level FINE Received ping response from 0 socket getRemoteSocketAddress return true else LOGGER log Level FINE Expected ping response from 0 of 1 got 2 new Object socket getRemoteSocketAddress new String ping UTF 8 new String response 0 responseLength UTF 8 return false finally IOUtils closeQuietly out IOUtils closeQuietly in finally socket close public static class ConnectionFromCurrentPeer extends OfflineCause public String toString return The current peer is reconnecting private static int iotaGen 1 private static final Logger LOGGER Logger getLogger TcpSlaveAgentListener class getName public static String CLI HOST NAME SystemProperties getString TcpSlaveAgentListener class getName hostName public static Integer CLI PORT SystemProperties getInteger TcpSlaveAgentListener class getName portpackage hudson node monitors import hudson Extension import hudson FilePath import jenkins MasterToSlaveFileCallable import hudson model Computer import hudson model Node import hudson remoting Callable import jenkins model Jenkins import hudson node monitors DiskSpaceMonitorDescriptor DiskSpace import hudson remoting VirtualChannel import org jenkinsci Symbol import org kohsuke stapler DataBoundConstructor import java io File import java io IOException import java text ParseException public class TemporarySpaceMonitor extends AbstractDiskSpaceMonitor DataBoundConstructor public TemporarySpaceMonitor String freeSpaceThreshold throws ParseException super freeSpaceThreshold public TemporarySpaceMonitor public DiskSpace getFreeSpace Computer c return DESCRIPTOR get c Override public String getColumnCaption Hide this column from non admins return Jenkins getInstance hasPermission Jenkins ADMINISTER super getColumnCaption null public static DiskSpaceMonitorDescriptor DESCRIPTOR Extension Symbol tmpSpace public static class DescriptorImpl extends DiskSpaceMonitorDescriptor public DescriptorImpl DESCRIPTOR this public String getDisplayName return Messages TemporarySpaceMonitor DisplayName Override protected Callable DiskSpace IOException createCallable Computer c Node node c getNode if node null return null FilePath p node getRootPath if p null return null return p asCallableWith new GetTempSpace public static DiskSpaceMonitorDescriptor install return DESCRIPTOR protected static final class GetTempSpace extends MasterToSlaveFileCallable DiskSpace public DiskSpace invoke File f VirtualChannel channel throws IOException if the disk is really filled up we can t even create a single file so calling File createTempFile and figuring out the directory won t reliably work f new File System getProperty java io tmpdir long s f getUsableSpace if s 0 return null return new DiskSpace f getCanonicalPath s private static final long serialVersionUID 1Lpackage hudson init import org jvnet hudson annotation indexer Indexed import java lang annotation Documented import java lang annotation Retention import java lang annotation Target import static hudson init TermMilestone import static java lang annotation ElementType METHOD import static java lang annotation RetentionPolicy RUNTIME Indexed Documented Retention RUNTIME Target METHOD public interface Terminator TermMilestone after default STARTED TermMilestone before default COMPLETED String requires default String attains default String displayName defaultpackage hudson init import org jvnet hudson reactor Milestone public class TerminatorFinder extends TaskMethodFinder Terminator public TerminatorFinder ClassLoader cl super Terminator class TermMilestone class cl Override protected String displayNameOf Terminator i return i displayName Override protected String requiresOf Terminator i return i requires Override protected String attainsOf Terminator i return i attains Override protected Milestone afterOf Terminator i return i after Override protected Milestone beforeOf Terminator i return i before Override protected boolean fatalOf Terminator i return falsepackage hudson init import org jvnet hudson reactor Executable import org jvnet hudson reactor Milestone import org jvnet hudson reactor TaskBuilder import org jvnet hudson reactor TaskGraphBuilder public enum TermMilestone implements Milestone STARTED Started termination COMPLETED Completed termination private final String message TermMilestone String message this message message public static TaskBuilder ordering TaskGraphBuilder b new TaskGraphBuilder TermMilestone v values for int i 0 i v length 1 i b add null Executable NOOP requires v i attains v i 1 return b Override public String toString return messagepackage com zxy recovery test import android app Activity import android content Intent import android os Bundle import android view View public class TestActivity extends BaseActivity Override protected void onCreate Bundle savedInstanceState super onCreate savedInstanceState setContentView R layout activity test new Thread new Runnable int i 0 Override public void run while true if i 3 Activity activity null activity finish try Thread sleep 1000 catch InterruptedException e e printStackTrace i start public void onClick View view if view getId R id btn Activity activity null activity finish else if view getId R id btn2 Intent intent new Intent TestActivity this TestActivity2 class startActivity intentpackage com zxy recovery test import android app Activity import android content Intent import android os Bundle import android view View public class TestActivity2 extends BaseActivity Override protected void onCreate Bundle savedInstanceState super onCreate savedInstanceState setContentView R layout activity test2 public void onClick View view if view getId R id btn Activity activity null activity finish else if view getId R id btn2 startActivity new Intent this MainActivity classpackage com twitter sdk android core identity public class TestAuthState extends AuthStatepackage com twitter sdk android core public final class TestFixtures public static final String KEY key public static final String TOKEN token public static final String SECRET secret public static final long USER ID 11Lpackage com twitter sdk android core identity import android webkit WebView import android widget ProgressBar import com twitter sdk android core TwitterAuthConfig import com twitter sdk android core internal oauth OAuth1aService public class TestOAuthController extends OAuthController TestOAuthController ProgressBar spinner WebView webView TwitterAuthConfig authConfig OAuth1aService oAuth1aService Listener listener super spinner webView authConfig oAuth1aService listenerpackage com twitter sdk android core identity import com twitter sdk android core TwitterSession public class TestShareEmailClient extends ShareEmailClient public TestShareEmailClient TwitterSession session super sessionpackage com twitter sdk android core identity import android os ResultReceiver public class TestShareEmailController extends ShareEmailController public TestShareEmailController ShareEmailClient emailClient ResultReceiver resultReceiver super emailClient resultReceiverpackage com twitter sdk android core identity import android content Context import android content pm PackageInfo import android content pm PackageManager import android content pm Signature import static org mockito Mockito public final class TestUtils private TestUtils Private constructor public static void setupTwitterInstalled Context mockContext throws PackageManager NameNotFoundException setupTwitterInstalled mockContext SSOAuthHandler TWITTER SIGNATURE public static void setupTwitterInstalled Context mockContext String signature throws PackageManager NameNotFoundException final PackageManager mockPm mock PackageManager class final PackageInfo mockPackageInfo mock PackageInfo class mockPackageInfo signatures new Signature new Signature signature when mockContext getPackageManager thenReturn mockPm when mockPm getPackageInfo SSOAuthHandler TWITTER PACKAGE NAME PackageManager GET SIGNATURES thenReturn mockPackageInfo when mockPm getPackageInfo SSOAuthHandler DOGFOOD PACKAGE NAME PackageManager GET SIGNATURES thenThrow new PackageManager NameNotFoundException public static void setupNoSSOAppInstalled Context mockContext throws PackageManager NameNotFoundException final PackageManager mockPm mock PackageManager class when mockContext getPackageManager thenReturn mockPm when mockPm getPackageInfo SSOAuthHandler TWITTER PACKAGE NAME PackageManager GET SIGNATURES thenThrow new PackageManager NameNotFoundException when mockPm getPackageInfo SSOAuthHandler DOGFOOD PACKAGE NAME PackageManager GET SIGNATURES thenThrow new PackageManager NameNotFoundExceptionpackage hudson util import com google common collect import javax annotation Nonnull import java io BufferedReader import java io File import java io FileInputStream import java io FileReader import java io IOException import java io InputStreamReader import java io PrintWriter import java io RandomAccessFile import java io Reader import java io StringWriter import java nio charset Charset import java util Iterator public class TextFile public final File file public TextFile File file this file file public boolean exists return file exists public void delete file delete public String read throws IOException StringWriter out new StringWriter PrintWriter w new PrintWriter out try BufferedReader in new BufferedReader new InputStreamReader new FileInputStream file UTF 8 String line while line in readLine null w println line return out toString public Iterable String lines return new Iterable String Override public Iterator String iterator try final BufferedReader in new BufferedReader new InputStreamReader new FileInputStream file UTF 8 return new AbstractIterator String Override protected String computeNext try String r in readLine if r null in close return endOfData return r catch IOException e throw new RuntimeException e catch IOException e throw new RuntimeException e public void write String text throws IOException file getParentFile mkdirs AtomicFileWriter w new AtomicFileWriter file try w write text w commit finally w abort public Nonnull String head int numChars throws IOException char buf new char numChars int read 0 Reader r new FileReader file try while read numChars int d r read buf read buf length read if d 0 break read d return new String buf 0 read finally org apache commons io IOUtils closeQuietly r public Nonnull String fastTail int numChars Charset cs throws IOException try RandomAccessFile raf new RandomAccessFile file r long len raf length err on the safe side and assume each char occupies 4 bytes additional 1024 byte margin is to bring us back in sync in case we started reading from non char boundary long pos Math max 0 len numChars 4 1024 raf seek pos byte tail new byte int len pos raf readFully tail String tails cs decode java nio ByteBuffer wrap tail toString return new String tails substring Math max 0 tails length numChars trim the baggage of substring by allocating a new String public Nonnull String fastTail int numChars throws IOException return fastTail numChars Charset defaultCharset public String readTrim throws IOException return read trim Override public String toString return file toStringpackage hudson model import hudson Extension import net sf json JSONObject import org jenkinsci Symbol import org kohsuke stapler DataBoundConstructor import org kohsuke stapler StaplerRequest public class TextParameterDefinition extends StringParameterDefinition DataBoundConstructor public TextParameterDefinition String name String defaultValue String description super name defaultValue description Extension Symbol text textParam public static class DescriptorImpl extends ParameterDescriptor Override public String getDisplayName return Messages TextParameterDefinition DisplayName Override public ParameterValue createValue StaplerRequest req JSONObject jo TextParameterValue value req bindJSON TextParameterValue class jo value setDescription getDescription return value Override public ParameterValue createValue String value return new TextParameterValue getName value getDescriptionpackage hudson model import org kohsuke stapler DataBoundConstructor public class TextParameterValue extends StringParameterValue DataBoundConstructor public TextParameterValue String name String value super name value public TextParameterValue String name String value String description super name value description Override public String toString return TextParameterValue getName valuepackage jenkins slaves systemInfo import hudson Extension import org jenkinsci Symbol Extension ordinal 1 Symbol threadDump public class ThreadDumpSlaveInfo extends SlaveSystemInfo Override public String getDisplayName return Messages ThreadDumpSlaveInfo DisplayNamepackage jenkins util import org apache commons beanutils Converter import org kohsuke stapler QueryParameter import java util concurrent TimeUnit import javax annotation CheckForNull public class TimeDuration private final long millis public TimeDuration long millis this millis millis public int getTime return int millis public long getTimeInMillis return millis public long as TimeUnit t return t convert millis TimeUnit MILLISECONDS public static CheckForNull TimeDuration fromString CheckForNull String delay if delay null return null try TODO more unit handling if delay endsWith sec delay delay substring 0 delay length 3 if delay endsWith secs delay delay substring 0 delay length 4 return new TimeDuration Long parseLong delay catch NumberFormatException e throw new IllegalArgumentException Invalid time duration value delay public static class StaplerConverterImpl implements Converter public Object convert Class type Object value if value null return null if value instanceof String return fromString String value throw new UnsupportedOperationExceptionpackage com twitter sdk android tweetui import com twitter sdk android core Callback public interface Timeline T void next Long minPosition final Callback TimelineResult T cb void previous Long maxPosition final Callback TimelineResult T cbpackage com twitter sdk android tweetui import com twitter sdk android core models Identifiable import java util List public class TimelineCursor public final Long minPosition public final Long maxPosition public TimelineCursor Long minPosition Long maxPosition this minPosition minPosition this maxPosition maxPosition TimelineCursor List extends Identifiable items this minPosition items size 0 items get items size 1 getId null this maxPosition items size 0 items get 0 getId nullpackage com twitter sdk android tweetui internal import android database DataSetObservable import android database DataSetObserver import com twitter sdk android core Callback import com twitter sdk android core Result import com twitter sdk android core TwitterException import com twitter sdk android core models Identifiable import com twitter sdk android tweetui Timeline import com twitter sdk android tweetui TimelineResult import java util ArrayList import java util List public class TimelineDelegate T extends Identifiable once capacity is exceeded additional items will not be loaded static final long CAPACITY 200L timeline that next and previous items are loaded from final Timeline T timeline Observable for Adapter DataSetObservers for ListViews final DataSetObservable listAdapterObservable final TimelineStateHolder timelineStateHolder List T itemList public TimelineDelegate Timeline T timeline this timeline null null TimelineDelegate Timeline T timeline DataSetObservable observable List T items if timeline null throw new IllegalArgumentException Timeline must not be null this timeline timeline this timelineStateHolder new TimelineStateHolder if observable null listAdapterObservable new DataSetObservable else listAdapterObservable observable if items null itemList new ArrayList else itemList items public void refresh Callback TimelineResult T developerCb reset scrollStateHolder cursors to be null loadNext will get latest items timelineStateHolder resetCursors load latest timeline items and replace existing items loadNext timelineStateHolder positionForNext new RefreshCallback developerCb timelineStateHolder public void next Callback TimelineResult T developerCb loadNext timelineStateHolder positionForNext new NextCallback developerCb timelineStateHolder public void previous loadPrevious timelineStateHolder positionForPrevious new PreviousCallback timelineStateHolder public int getCount return itemList size public T getItem int position if isLastPosition position previous return itemList get position public long getItemId int position final Identifiable item itemList get position return item getId public void setItemById T item for int i 0 i itemList size i if item getId itemList get i getId itemList set i item notifyDataSetChanged boolean withinMaxCapacity return itemList size CAPACITY boolean isLastPosition int position return position itemList size 1 void loadNext Long minPosition Callback TimelineResult T cb if withinMaxCapacity if timelineStateHolder startTimelineRequest timeline next minPosition cb else cb failure new TwitterException Request already in flight else cb failure new TwitterException Max capacity reached void loadPrevious Long maxPosition Callback TimelineResult T cb if withinMaxCapacity if timelineStateHolder startTimelineRequest timeline previous maxPosition cb else cb failure new TwitterException Request already in flight else cb failure new TwitterException Max capacity reached class DefaultCallback extends Callback TimelineResult T final Callback TimelineResult T developerCallback final TimelineStateHolder timelineStateHolder DefaultCallback Callback TimelineResult T developerCb TimelineStateHolder timelineStateHolder this developerCallback developerCb this timelineStateHolder timelineStateHolder Override public void success Result TimelineResult T result timelineStateHolder finishTimelineRequest if developerCallback null developerCallback success result Override public void failure TwitterException exception timelineStateHolder finishTimelineRequest if developerCallback null developerCallback failure exception class NextCallback extends DefaultCallback NextCallback Callback TimelineResult T developerCb TimelineStateHolder timelineStateHolder super developerCb timelineStateHolder Override public void success Result TimelineResult T result if result data items size 0 final ArrayList T receivedItems new ArrayList result data items receivedItems addAll itemList itemList receivedItems notifyDataSetChanged timelineStateHolder setNextCursor result data timelineCursor do nothing when zero items are received Subsequent next call does not change super success result class RefreshCallback extends NextCallback RefreshCallback Callback TimelineResult T developerCb TimelineStateHolder timelineStateHolder super developerCb timelineStateHolder Override public void success Result TimelineResult T result if result data items size 0 itemList clear super success result class PreviousCallback extends DefaultCallback PreviousCallback TimelineStateHolder timelineStateHolder super null timelineStateHolder Override public void success Result TimelineResult T result if result data items size 0 itemList addAll result data items notifyDataSetChanged timelineStateHolder setPreviousCursor result data timelineCursor do nothing when zero items are received Subsequent next call does not change super success result public void registerDataSetObserver DataSetObserver observer listAdapterObservable registerObserver observer public void unregisterDataSetObserver DataSetObserver observer listAdapterObservable unregisterObserver observer public void notifyDataSetChanged listAdapterObservable notifyChanged public void notifyDataSetInvalidated listAdapterObservable notifyInvalidatedpackage com twitter sdk android tweetui import android content Context import android database DataSetObserver import android widget BaseAdapter import com twitter sdk android core Callback import com twitter sdk android core models Identifiable import com twitter sdk android tweetui internal TimelineDelegate abstract class TimelineListAdapter T extends Identifiable extends BaseAdapter protected final Context context protected final TimelineDelegate T delegate public TimelineListAdapter Context context Timeline T timeline this context new TimelineDelegate timeline TimelineListAdapter Context context TimelineDelegate T delegate if context null throw new IllegalArgumentException Context must not be null this context context this delegate delegate delegate refresh null public void refresh Callback TimelineResult T cb delegate refresh cb Override public int getCount return delegate getCount Override public T getItem int position return delegate getItem position Override public long getItemId int position return delegate getItemId position Override public void registerDataSetObserver DataSetObserver observer delegate registerDataSetObserver observer Override public void unregisterDataSetObserver DataSetObserver observer delegate unregisterDataSetObserver observer Override public void notifyDataSetChanged delegate notifyDataSetChanged Override public void notifyDataSetInvalidated delegate notifyDataSetInvalidatedpackage com twitter sdk android tweetui import java util List public class TimelineResult T public final TimelineCursor timelineCursor public final List T items public TimelineResult TimelineCursor timelineCursor List T items this timelineCursor timelineCursor this items itemspackage com twitter sdk android tweetui internal import com twitter sdk android tweetui TimelineCursor import java util concurrent atomic AtomicBoolean public class TimelineStateHolder cursor for Timeline next calls TimelineCursor nextCursor cursor for Timeline previous calls TimelineCursor previousCursor true while a request is in flight false otherwise public final AtomicBoolean requestInFlight new AtomicBoolean false public TimelineStateHolder intentionally blank public TimelineStateHolder TimelineCursor nextCursor TimelineCursor previousCursor this nextCursor nextCursor this previousCursor previousCursor public void resetCursors nextCursor null previousCursor null public Long positionForNext return nextCursor null null nextCursor maxPosition public Long positionForPrevious return previousCursor null null previousCursor minPosition public void setNextCursor TimelineCursor timelineCursor nextCursor timelineCursor setCursorsIfNull timelineCursor public void setPreviousCursor TimelineCursor timelineCursor previousCursor timelineCursor setCursorsIfNull timelineCursor public void setCursorsIfNull TimelineCursor timelineCursor if nextCursor null nextCursor timelineCursor if previousCursor null previousCursor timelineCursor public boolean startTimelineRequest return requestInFlight compareAndSet false true public void finishTimelineRequest requestInFlight set falsepackage jenkins util import hudson util DaemonThreadFactory import hudson util NamingThreadFactory import javax annotation Nonnull import java util concurrent ScheduledExecutorService public class Timer private static ScheduledExecutorService executorService Nonnull public static synchronized ScheduledExecutorService get if executorService null corePoolSize is set to 10 but will only be created if needed ScheduledThreadPoolExecutor acts as a fixed sized pool using corePoolSize threads executorService new ErrorLoggingScheduledThreadPoolExecutor 10 new NamingThreadFactory new DaemonThreadFactory jenkins util Timer return executorService public static synchronized void shutdown if executorService null executorService shutdownNow executorService null private Timerpackage hudson triggers import antlr ANTLRException import hudson Extension import static hudson Util fixNull import hudson model BuildableItem import hudson model Cause import hudson model Item import hudson scheduler CronTabList import hudson scheduler Hash import hudson util FormValidation import java text DateFormat import java util ArrayList import java util Calendar import java util Collection import org jenkinsci Symbol import org kohsuke stapler AncestorInPath import org kohsuke stapler DataBoundConstructor import org kohsuke stapler QueryParameter import javax annotation Nonnull public class TimerTrigger extends Trigger BuildableItem DataBoundConstructor public TimerTrigger Nonnull String spec throws ANTLRException super spec Override public void run if job null return job scheduleBuild 0 new TimerTriggerCause Extension Symbol cron public static class DescriptorImpl extends TriggerDescriptor public boolean isApplicable Item item return item instanceof BuildableItem public String getDisplayName return Messages TimerTrigger DisplayName backward compatibility public FormValidation doCheck QueryParameter String value AncestorInPath Item item return doCheckSpec value item public FormValidation doCheckSpec QueryParameter String value AncestorInPath Item item try CronTabList ctl CronTabList create fixNull value item null Hash from item getFullName null Collection FormValidation validations new ArrayList updateValidationsForSanity validations ctl updateValidationsForNextRun validations ctl return FormValidation aggregate validations catch ANTLRException e if value trim indexOf n 1 value contains return FormValidation error Messages TimerTrigger MissingWhitespace return FormValidation error e getMessage private void updateValidationsForSanity Collection FormValidation validations CronTabList ctl String msg ctl checkSanity if msg null validations add FormValidation warning msg private void updateValidationsForNextRun Collection FormValidation validations CronTabList ctl Calendar prev ctl previous Calendar next ctl next if prev null next null DateFormat fmt DateFormat getDateTimeInstance DateFormat FULL DateFormat FULL validations add FormValidation ok Messages TimerTrigger would last have run at would next run at fmt format prev getTime fmt format next getTime else validations add FormValidation warning Messages TimerTrigger no schedules so will never run public static class TimerTriggerCause extends Cause Override public String getShortDescription return Messages TimerTrigger TimerTriggerCause ShortDescription Override public boolean equals Object o return o instanceof TimerTriggerCause Override public int hashCode return 5package hudson model import hudson CopyOnWrite import org kohsuke stapler export ExportedBean import org kohsuke stapler export Exported import java io Serializable ExportedBean public final class TimeSeries implements Serializable private final float decay CopyOnWrite private volatile float history private final int historySize public TimeSeries float initialValue float decay int historySize this history new float initialValue this decay decay this historySize historySize public void update float newData float data history 0 decay newData 1 decay float r new float Math min history length 1 historySize System arraycopy history 0 r 1 Math min history length r length 1 r 0 data history r Exported public float getHistory return history Exported public float getLatest return history 0 Override public String toString return Float toString history 0 private static final long serialVersionUID 1Lpackage hudson util import java util concurrent TimeUnit public enum TimeUnit2 NANOSECONDS Override public long toNanos long d return d Override public long toMicros long d return d C1 C0 Override public long toMillis long d return d C2 C0 Override public long toSeconds long d return d C3 C0 Override public long toMinutes long d return d C4 C0 Override public long toHours long d return d C5 C0 Override public long toDays long d return d C6 C0 Override public long convert long d TimeUnit2 u return u toNanos d Override public long convert long d TimeUnit u return u toNanos d int excessNanos long d long m return int d m C2 MICROSECONDS Override public long toNanos long d return x d C1 C0 MAX C1 C0 Override public long toMicros long d return d Override public long toMillis long d return d C2 C1 Override public long toSeconds long d return d C3 C1 Override public long toMinutes long d return d C4 C1 Override public long toHours long d return d C5 C1 Override public long toDays long d return d C6 C1 Override public long convert long d TimeUnit2 u return u toMicros d Override public long convert long d TimeUnit u return u toMicros d int excessNanos long d long m return int d C1 m C2 MILLISECONDS Override public long toNanos long d return x d C2 C0 MAX C2 C0 Override public long toMicros long d return x d C2 C1 MAX C2 C1 Override public long toMillis long d return d Override public long toSeconds long d return d C3 C2 Override public long toMinutes long d return d C4 C2 Override public long toHours long d return d C5 C2 Override public long toDays long d return d C6 C2 Override public long convert long d TimeUnit2 u return u toMillis d Override public long convert long d TimeUnit u return u toMillis d int excessNanos long d long m return 0 SECONDS Override public long toNanos long d return x d C3 C0 MAX C3 C0 Override public long toMicros long d return x d C3 C1 MAX C3 C1 Override public long toMillis long d return x d C3 C2 MAX C3 C2 Override public long toSeconds long d return d Override public long toMinutes long d return d C4 C3 Override public long toHours long d return d C5 C3 Override public long toDays long d return d C6 C3 Override public long convert long d TimeUnit2 u return u toSeconds d Override public long convert long d TimeUnit u return u toSeconds d int excessNanos long d long m return 0 MINUTES Override public long toNanos long d return x d C4 C0 MAX C4 C0 Override public long toMicros long d return x d C4 C1 MAX C4 C1 Override public long toMillis long d return x d C4 C2 MAX C4 C2 Override public long toSeconds long d return x d C4 C3 MAX C4 C3 Override public long toMinutes long d return d Override public long toHours long d return d C5 C4 Override public long toDays long d return d C6 C4 Override public long convert long d TimeUnit2 u return u toMinutes d Override public long convert long d TimeUnit u return SECONDS toMinutes u toSeconds d int excessNanos long d long m return 0 HOURS Override public long toNanos long d return x d C5 C0 MAX C5 C0 Override public long toMicros long d return x d C5 C1 MAX C5 C1 Override public long toMillis long d return x d C5 C2 MAX C5 C2 Override public long toSeconds long d return x d C5 C3 MAX C5 C3 Override public long toMinutes long d return x d C5 C4 MAX C5 C4 Override public long toHours long d return d Override public long toDays long d return d C6 C5 Override public long convert long d TimeUnit2 u return u toHours d Override public long convert long d TimeUnit u return SECONDS toHours u toSeconds d int excessNanos long d long m return 0 DAYS Override public long toNanos long d return x d C6 C0 MAX C6 C0 Override public long toMicros long d return x d C6 C1 MAX C6 C1 Override public long toMillis long d return x d C6 C2 MAX C6 C2 Override public long toSeconds long d return x d C6 C3 MAX C6 C3 Override public long toMinutes long d return x d C6 C4 MAX C6 C4 Override public long toHours long d return x d C6 C5 MAX C6 C5 Override public long toDays long d return d Override public long convert long d TimeUnit2 u return u toDays d Override public long convert long d TimeUnit u return SECONDS toDays u toSeconds d int excessNanos long d long m return 0 Handy constants for conversion methods static final long C0 1L static final long C1 C0 1000L static final long C2 C1 1000L static final long C3 C2 1000L static final long C4 C3 60L static final long C5 C4 60L static final long C6 C5 24L static final long MAX Long MAX VALUE static long x long d long m long over if d over return Long MAX VALUE if d over return Long MIN VALUE return d m To maintain full signature compatibility with 1 5 and to improve the clarity of the generated javadoc see 6287639 Abstract methods in enum classes should not be listed as abstract method convert etc are not declared abstract but otherwise act as abstract methods public long convert long sourceDuration TimeUnit2 sourceUnit throw new AbstractMethodError public long convert long sourceDuration TimeUnit sourceUnit throw new AbstractMethodError public long toNanos long duration throw new AbstractMethodError public long toMicros long duration throw new AbstractMethodError public long toMillis long duration throw new AbstractMethodError public long toSeconds long duration throw new AbstractMethodError public long toMinutes long duration throw new AbstractMethodError public long toHours long duration throw new AbstractMethodError public long toDays long duration throw new AbstractMethodError abstract int excessNanos long d long m public void timedWait Object obj long timeout throws InterruptedException if timeout 0 long ms toMillis timeout int ns excessNanos timeout ms obj wait ms ns public void timedJoin Thread thread long timeout throws InterruptedException if timeout 0 long ms toMillis timeout int ns excessNanos timeout ms thread join ms ns public void sleep long timeout throws InterruptedException if timeout 0 long ms toMillis timeout int ns excessNanos timeout ms Thread sleep ms nspackage com twitter sdk android tweetui import android content Context import android content res TypedArray import android util AttributeSet import android widget ImageButton public class ToggleImageButton extends ImageButton private static final int STATE TOGGLED ON R attr state toggled on boolean isToggledOn String contentDescriptionOn String contentDescriptionOff final boolean toggleOnClick public ToggleImageButton Context context this context null public ToggleImageButton Context context AttributeSet attrs this context attrs 0 public ToggleImageButton Context context AttributeSet attrs int defStyle super context attrs defStyle TypedArray a null try a context getTheme obtainStyledAttributes attrs R styleable ToggleImageButton defStyle 0 final String contentDescriptionOn a getString R styleable ToggleImageButton contentDescriptionOn final String contentDescriptionOff a getString R styleable ToggleImageButton contentDescriptionOff this contentDescriptionOn contentDescriptionOn null String getContentDescription contentDescriptionOn this contentDescriptionOff contentDescriptionOff null String getContentDescription contentDescriptionOff toggleOnClick a getBoolean R styleable ToggleImageButton toggleOnClick true setToggledOn false finally if a null a recycle Override public int onCreateDrawableState int extraSpace final int drawableState super onCreateDrawableState extraSpace 2 if isToggledOn mergeDrawableStates drawableState STATE TOGGLED ON return drawableState Override public boolean performClick if toggleOnClick toggle return super performClick public void setToggledOn boolean isToggledOn this isToggledOn isToggledOn setContentDescription isToggledOn contentDescriptionOn contentDescriptionOff refreshDrawableState public void toggle setToggledOn isToggledOn public boolean isToggledOn return isToggledOnpackage hudson security import hudson Functions import jenkins model Jenkins import jenkins security HMACConfidentialKey import jenkins security ImpersonatingUserDetailsService import jenkins security LastGrantedAuthoritiesProperty import org acegisecurity Authentication import org acegisecurity ui rememberme TokenBasedRememberMeServices import org acegisecurity userdetails UserDetails import org acegisecurity userdetails UserDetailsService import org apache commons codec binary Base64 import org springframework util Assert import javax servlet http Cookie import javax servlet http HttpServletRequest import javax servlet http HttpServletResponse import java lang reflect InvocationTargetException import java lang reflect Method import java util Date public class TokenBasedRememberMeServices2 extends TokenBasedRememberMeServices Override public void setUserDetailsService UserDetailsService userDetailsService super setUserDetailsService new ImpersonatingUserDetailsService userDetailsService Override protected String makeTokenSignature long tokenExpiryTime UserDetails userDetails String expectedTokenSignature MAC mac userDetails getUsername tokenExpiryTime N A getKey return expectedTokenSignature Override protected String retrievePassword Authentication successfulAuthentication return N A Override public void loginSuccess HttpServletRequest request HttpServletResponse response Authentication successfulAuthentication Exit if the principal hasn t asked to be remembered if rememberMeRequested request getParameter if logger isDebugEnabled logger debug Did not send remember me cookie principal did not set parameter getParameter return Jenkins j Jenkins getInstanceOrNull if j null j isDisableRememberMe if logger isDebugEnabled logger debug Did not send remember me cookie because Remember Me is disabled in security configuration principal did set parameter getParameter TODO log warning when receiving remember me request despite the feature being disabled return Assert notNull successfulAuthentication getPrincipal Assert notNull successfulAuthentication getCredentials Assert isInstanceOf UserDetails class successfulAuthentication getPrincipal long expiryTime System currentTimeMillis tokenValiditySeconds 1000 String username UserDetails successfulAuthentication getPrincipal getUsername String signatureValue makeTokenSignature expiryTime UserDetails successfulAuthentication getPrincipal String tokenValue username expiryTime signatureValue String tokenValueBase64 new String Base64 encodeBase64 tokenValue getBytes response addCookie makeValidCookie tokenValueBase64 request tokenValiditySeconds if logger isDebugEnabled logger debug Added remember me cookie for user username expiry new Date expiryTime Override public Authentication autoLogin HttpServletRequest request HttpServletResponse response try return super autoLogin request response catch Exception e cancelCookie request response Failed to handle remember me cookie Functions printThrowable e return null Override protected Cookie makeValidCookie String tokenValueBase64 HttpServletRequest request long maxAge Cookie cookie super makeValidCookie tokenValueBase64 request maxAge if we can mark the cookie HTTP only do so to protect this cookie even in case of XSS vulnerability if SET HTTP ONLY null try SET HTTP ONLY invoke cookie true catch IllegalAccessException e ignore catch InvocationTargetException e ignore if the user is running Jenkins over HTTPS we also want to prevent the cookie from leaking in HTTP whether the login is done over HTTPS or not would be a good enough approximation of whether Jenkins runs in HTTPS or not so use that if request isSecure cookie setSecure true return cookie private static final HMACConfidentialKey MAC new HMACConfidentialKey TokenBasedRememberMeServices class mac private static final Method SET HTTP ONLY static Method m null try m Cookie class getMethod setHttpOnly boolean class catch NoSuchMethodException x 3 0 SET HTTP ONLY mpackage jenkins tools import hudson Extension import jenkins model GlobalConfigurationCategory Extension public class ToolConfigurationCategory extends GlobalConfigurationCategory Override public String getShortDescription return jenkins management Messages ConfigureTools Description public String getDisplayName return jenkins management Messages ConfigureTools DisplayNamepackage hudson tools import edu umd cs findbugs annotations SuppressFBWarnings import hudson model Descriptor import hudson util DescribableList import hudson util FormValidation import java io File import java io IOException import java lang reflect Array import java lang reflect ParameterizedType import java lang reflect Type import java util Collections import java util List import jenkins model GlobalConfigurationCategory import jenkins model Jenkins import jenkins tools ToolConfigurationCategory import net sf json JSONObject import org jvnet tiger types Types import org kohsuke stapler QueryParameter import org kohsuke stapler StaplerRequest public abstract class ToolDescriptor T extends ToolInstallation extends Descriptor ToolInstallation private T installations SuppressWarnings unchecked public T getInstallations if installations null return installations clone Type bt Types getBaseClass getClass ToolDescriptor class if bt instanceof ParameterizedType ParameterizedType pt ParameterizedType bt this t is the closest approximation of T of Descriptor T Class t Types erasure pt getActualTypeArguments 0 return T Array newInstance t 0 else can t infer the type Fallback return emptyArray unsafeCast TODO Get rid of it It s unsafe according to http stackoverflow com questions 2927391 whats the reason i cant create generic array types in java SuppressWarnings unchecked SuppressFBWarnings value BC IMPOSSIBLE DOWNCAST justification Such casting is generally unsafe but we use it as a last resort private T emptyArray unsafeCast return T new Object 0 public void setInstallations T installations this installations installations clone public List ToolPropertyDescriptor getPropertyDescriptors return PropertyDescriptor ToolPropertyDescriptor ToolInstallation for ToolProperty all clazz Override public GlobalConfigurationCategory getCategory return GlobalConfigurationCategory get ToolConfigurationCategory class public List extends ToolInstaller getDefaultInstallers return Collections emptyList public DescribableList ToolProperty ToolPropertyDescriptor getDefaultProperties throws IOException DescribableList ToolProperty ToolPropertyDescriptor r new DescribableList ToolProperty ToolPropertyDescriptor NOOP List extends ToolInstaller installers getDefaultInstallers if installers isEmpty r add new InstallSourceProperty installers return r Override SuppressWarnings unchecked cast to T public boolean configure StaplerRequest req JSONObject json throws FormException setInstallations req bindJSONToList clazz json get tool toArray T Array newInstance clazz 0 return true public FormValidation doCheckHome QueryParameter File value this can be used to check the existence of a file on the server so needs to be protected Jenkins getInstance checkPermission Jenkins ADMINISTER if value getPath isEmpty return FormValidation ok if value isDirectory return FormValidation warning Messages ToolDescriptor NotADirectory value return checkHomeDirectory value protected FormValidation checkHomeDirectory File home return FormValidation ok public FormValidation doCheckName QueryParameter String value return FormValidation validateRequired valuepackage hudson tools import hudson DescriptorExtensionList import hudson EnvVars import hudson Extension import hudson ExtensionPoint import hudson diagnosis OldDataMonitor import hudson model import hudson slaves NodeSpecific import hudson util DescribableList import hudson util XStream2 import java io Serializable import java io IOException import java util List import com thoughtworks xstream annotations XStreamSerializable import com thoughtworks xstream converters UnmarshallingContext import javax annotation CheckForNull import javax annotation Nonnull import jenkins model Jenkins public abstract class ToolInstallation extends AbstractDescribableImpl ToolInstallation implements Serializable ExtensionPoint private final String name private String home XStreamSerializable private transient DescribableList ToolProperty ToolPropertyDescriptor properties new DescribableList ToolProperty ToolPropertyDescriptor Saveable NOOP Deprecated public ToolInstallation String name String home this name name this home home public ToolInstallation String name String home List extends ToolProperty properties this name name this home home if properties null try this properties replaceBy properties for ToolProperty p properties setTool p this catch IOException e throw new AssertionError e no Saveable so can t happen helper function necessary to avoid a warning private T extends ToolInstallation void setTool ToolProperty T prop ToolInstallation t prop setTool prop type cast t public String getName return name public CheckForNull String getHome return home public void buildEnvVars EnvVars env public DescribableList ToolProperty ToolPropertyDescriptor getProperties assert properties null return properties public ToolInstallation translate Nonnull Node node EnvVars envs TaskListener listener throws IOException InterruptedException ToolInstallation t this if t instanceof NodeSpecific NodeSpecific n NodeSpecific t t ToolInstallation n forNode node listener if t instanceof EnvironmentSpecific EnvironmentSpecific e EnvironmentSpecific t t ToolInstallation e forEnvironment envs return t public ToolInstallation translate AbstractBuild buildInProgress TaskListener listener throws IOException InterruptedException assert buildInProgress isBuilding return translate buildInProgress getBuiltOn buildInProgress getEnvironment listener listener SuppressWarnings deprecation protected String translateFor Node node TaskListener log throws IOException InterruptedException return ToolLocationNodeProperty getToolHome node this log protected Object readResolve if properties null properties new DescribableList ToolProperty ToolPropertyDescriptor Saveable NOOP for ToolProperty p properties setTool p this return this Override public String toString return getClass getSimpleName name protected static abstract class ToolConverter extends XStream2 PassthruConverter ToolInstallation public ToolConverter XStream2 xstream super xstream protected void callback ToolInstallation obj UnmarshallingContext context String s if obj home null s oldHomeField obj null obj home s OldDataMonitor report context 1 286 protected abstract String oldHomeField ToolInstallation obj public static DescriptorExtensionList ToolInstallation ToolDescriptor all use getDescriptorList and not getExtensionList to pick up legacy instances return Jenkins getInstance ToolInstallation ToolDescriptor getDescriptorList ToolInstallation class private static final long serialVersionUID 1Lpackage hudson tools import hudson ExtensionPoint import hudson FilePath import hudson Util import hudson model Describable import jenkins model Jenkins import hudson model Label import hudson model Node import hudson model TaskListener import java io File import java io IOException import org kohsuke accmod Restricted import org kohsuke accmod restrictions NoExternalUse import org kohsuke stapler DataBoundConstructor public abstract class ToolInstaller implements Describable ToolInstaller ExtensionPoint private final String label protected transient ToolInstallation tool protected ToolInstaller String label this label Util fixEmptyAndTrim label protected void setTool ToolInstallation t this tool t public final String getLabel return label public boolean appliesTo Node node Label l Jenkins getInstance getLabel label return l null l contains node public abstract FilePath performInstallation ToolInstallation tool Node node TaskListener log throws IOException InterruptedException protected final FilePath preferredLocation ToolInstallation tool Node node if node null throw new IllegalArgumentException must pass non null node String home Util fixEmptyAndTrim tool getHome if home null home sanitize tool getDescriptor getId File separatorChar sanitize tool getName FilePath root node getRootPath if root null throw new IllegalArgumentException Node node getDisplayName seems to be offline return root child tools child home private String sanitize String s return s null s replaceAll A Za z0 9 null public ToolInstallerDescriptor getDescriptor return ToolInstallerDescriptor Jenkins getInstance getDescriptorOrDie getClass Restricted NoExternalUse class public static final class ToolInstallerList public ToolInstallerEntry list Restricted NoExternalUse class public static final class ToolInstallerEntry public String id public String name public String url public ToolInstallerEntry public ToolInstallerEntry String id String name String url this id id this name name this url urlpackage hudson tools import hudson DescriptorExtensionList import hudson model Descriptor import jenkins model Jenkins import java util List import java util ArrayList public abstract class ToolInstallerDescriptor T extends ToolInstaller extends Descriptor ToolInstaller public boolean isApplicable Class extends ToolInstallation toolType return true public static DescriptorExtensionList ToolInstaller ToolInstallerDescriptor all return Jenkins getInstance ToolInstaller ToolInstallerDescriptor getDescriptorList ToolInstaller class public static List ToolInstallerDescriptor for Class extends ToolInstallation type List ToolInstallerDescriptor r new ArrayList ToolInstallerDescriptor for ToolInstallerDescriptor d all if d isApplicable type r add d return rpackage hudson tools import hudson DescriptorExtensionList import hudson Extension import hudson model Descriptor import jenkins model Jenkins import hudson model Node import hudson model TaskListener import hudson slaves NodeProperty import hudson slaves NodePropertyDescriptor import hudson slaves NodeSpecific import java io IOException import java util ArrayList import org jenkinsci Symbol import org kohsuke stapler DataBoundConstructor import java util Arrays import java util Collections import java util List public class ToolLocationNodeProperty extends NodeProperty Node private final List ToolLocation locations DataBoundConstructor public ToolLocationNodeProperty List ToolLocation locations if locations null locations new ArrayList ToolLocation this locations locations public ToolLocationNodeProperty ToolLocation locations this Arrays asList locations public List ToolLocation getLocations return Collections unmodifiableList locations public String getHome ToolInstallation installation for ToolLocation location locations if location getName equals installation getName location getType installation getDescriptor return location getHome return null Deprecated public static String getToolHome Node node ToolInstallation installation TaskListener log throws IOException InterruptedException String result null node specific configuration takes precedence ToolLocationNodeProperty property node getNodeProperties get ToolLocationNodeProperty class if property null result property getHome installation if result null return result consult translators for ToolLocationTranslator t ToolLocationTranslator all result t getToolHome node installation log if result null return result fall back is no op return installation getHome Extension Symbol toolLocation public static class DescriptorImpl extends NodePropertyDescriptor public String getDisplayName return Messages ToolLocationNodeProperty displayName public DescriptorExtensionList ToolInstallation ToolDescriptor getToolDescriptors return ToolInstallation all public String getKey ToolInstallation installation return installation getDescriptor getClass getName installation getName Override public boolean isApplicable Class extends Node nodeType return nodeType Jenkins class public static final class ToolLocation private final String type private final String name private final String home private transient volatile ToolDescriptor descriptor public ToolLocation ToolDescriptor type String name String home this descriptor type this type type getClass getName this name name this home home DataBoundConstructor public ToolLocation String key String home this type key substring 0 key indexOf this name key substring key indexOf 1 this home home public String getName return name public String getHome return home SuppressWarnings deprecation TODO this was mistakenly made to be the ToolDescriptor class name rather than id as you would expect now baked into serial form public ToolDescriptor getType if descriptor null descriptor ToolDescriptor Descriptor find type return descriptor public String getKey return type namepackage hudson tools import hudson ExtensionList import hudson ExtensionPoint import hudson slaves NodeSpecific import hudson model Node import hudson model TaskListener import java io File import java io IOException public abstract class ToolLocationTranslator implements ExtensionPoint public abstract String getToolHome Node node ToolInstallation installation TaskListener log throws IOException InterruptedException public static ExtensionList ToolLocationTranslator all return ExtensionList lookup ToolLocationTranslator classpackage hudson tools import hudson DescriptorExtensionList import hudson ExtensionPoint import hudson model Describable import jenkins model Jenkins public abstract class ToolProperty T extends ToolInstallation implements Describable ToolProperty ExtensionPoint protected transient T tool protected void setTool T tool this tool tool public ToolPropertyDescriptor getDescriptor return ToolPropertyDescriptor Jenkins getInstance getDescriptorOrDie getClass public abstract Class T type public static DescriptorExtensionList ToolProperty ToolPropertyDescriptor all return DescriptorExtensionList Jenkins getInstance getDescriptorList ToolProperty classpackage hudson tools import hudson Extension public abstract class ToolPropertyDescriptor extends PropertyDescriptor ToolProperty ToolInstallation protected ToolPropertyDescriptor Class extends ToolProperty clazz super clazz protected ToolPropertyDescriptorpackage hudson diagnosis import hudson model AdministrativeMonitor import jenkins model Jenkins import hudson Extension import org jenkinsci Symbol import org kohsuke stapler StaplerRequest import org kohsuke stapler StaplerResponse import java io IOException Extension Symbol tooManyJobsButNoView public class TooManyJobsButNoView extends AdministrativeMonitor Override public String getDisplayName return Messages TooManyJobsButNoView DisplayName public boolean isActivated Jenkins h Jenkins getInstance return h getViews size 1 h getItemMap size THRESHOLD public void doAct StaplerRequest req StaplerResponse rsp throws IOException if req hasParameter no disable true rsp sendRedirect req getContextPath manage else rsp sendRedirect req getContextPath newView public static final int THRESHOLD 16package hudson model import hudson Extension import hudson ExtensionPoint public interface TopLevelItem extends Item ExtensionPoint Describable TopLevelItem TopLevelItemDescriptor getDescriptorpackage hudson model import hudson ExtensionList import jenkins model Jenkins import jenkins model item category ItemCategory import org acegisecurity AccessDeniedException import org apache commons jelly Script import org apache commons jelly XMLOutput import org apache commons lang StringUtils import org jenkins ui icon Icon import org jenkins ui icon IconSet import org jenkins ui icon IconSpec import org kohsuke stapler MetaClass import org kohsuke stapler Stapler import org kohsuke stapler StaplerRequest import org kohsuke stapler WebApp import org kohsuke stapler jelly DefaultScriptInvoker import org kohsuke stapler jelly JellyClassTearOff import javax annotation CheckForNull import javax annotation Nonnull import java io StringWriter import java util logging Level import java util logging Logger public abstract class TopLevelItemDescriptor extends Descriptor TopLevelItem implements IconSpec private static final Logger LOGGER Logger getLogger TopLevelItemDescriptor class getName protected TopLevelItemDescriptor Class extends TopLevelItem clazz super clazz protected TopLevelItemDescriptor public boolean isApplicable Descriptor descriptor return true public boolean isApplicableIn ItemGroup parent return true public final void checkApplicableIn ItemGroup parent if isApplicableIn parent throw new AccessDeniedException Messages TopLevelItemDescriptor NotApplicableIn getDisplayName parent getFullDisplayName public boolean testInstance TopLevelItem i return clazz isInstance i Override public String getDisplayName return super getDisplayName Nonnull public String getDescription Stapler stapler Stapler getCurrent if stapler null try WebApp webapp WebApp getCurrent MetaClass meta webapp getMetaClass this Script s meta loadTearOff JellyClassTearOff class findScript newInstanceDetail if s null return DefaultScriptInvoker dsi new DefaultScriptInvoker StringWriter sw new StringWriter XMLOutput xml dsi createXMLOutput sw true dsi invokeScript Stapler getCurrentRequest Stapler getCurrentResponse s this xml return sw toString catch Exception e LOGGER log Level WARNING null e return else return Nonnull public String getCategoryId return ItemCategory UncategorizedCategory ID CheckForNull Deprecated public String getIconFilePathPattern return null CheckForNull Deprecated public String getIconFilePath String size if StringUtils isBlank getIconFilePathPattern return getIconFilePathPattern replace size size return null Override public String getIconClassName Oh the fun of somebody adding a legacy way of referencing images into 2 0 code String pattern getIconFilePathPattern if pattern null here we go with the dance of the IconSet s String path pattern replace size 24x24 we ll strip the icon md to get the class name if path indexOf 1 this one is easy too easy also will never happen return IconSet toNormalizedIconNameClass path if Jenkins RESOURCE PATH length 0 path startsWith Jenkins RESOURCE PATH will to live falling path path substring Jenkins RESOURCE PATH length Icon icon IconSet icons getIconByUrl path if icon null return icon getClassSpec replaceAll s icon md s replaceAll s return null Deprecated public TopLevelItem newInstance StaplerRequest req throws FormException throw new UnsupportedOperationException Deprecated public TopLevelItem newInstance String name return newInstance Jenkins getInstance name public abstract TopLevelItem newInstance ItemGroup parent String name public static ExtensionList TopLevelItemDescriptor all return Items allpackage hudson cli handlers import hudson model TopLevelItem import org kohsuke MetaInfServices import org kohsuke args4j CmdLineParser import org kohsuke args4j OptionDef import org kohsuke args4j spi OptionHandler import org kohsuke args4j spi Setter MetaInfServices OptionHandler class public class TopLevelItemOptionHandler extends GenericItemOptionHandler TopLevelItem public TopLevelItemOptionHandler CmdLineParser parser OptionDef option Setter TopLevelItem setter super parser option setter Override protected Class TopLevelItem type return TopLevelItem class Override public String getDefaultMetaVariable return JOB TODO or should we pick up default value ITEMpackage com kaku colorfulnews utils import rx Observable import rx android schedulers AndroidSchedulers import rx schedulers Schedulers public class TransformUtils public static T Observable Transformer T T defaultSchedulers return new Observable Transformer T T Override public Observable T call Observable T tObservable return tObservable unsubscribeOn Schedulers io subscribeOn Schedulers io observeOn AndroidSchedulers mainThreadpackage jenkins model import hudson ExtensionPoint import hudson model Action import hudson model Actionable import hudson model TopLevelItem import java util Collection import javax annotation Nonnull public abstract class TransientActionFactory T implements ExtensionPoint public abstract Class T type public abstract Nonnull Collection extends Action createFor Nonnull T targetpackage hudson model import hudson Extension import hudson ExtensionList import hudson ExtensionPoint import java util Collection import java util Collections import jenkins model TransientActionFactory Deprecated public abstract class TransientBuildActionFactory implements ExtensionPoint public Collection extends Action createFor Run target if target instanceof AbstractBuild return createFor AbstractBuild target else return Collections emptyList Deprecated public Collection extends Action createFor AbstractBuild target return Collections emptyList public static ExtensionList TransientBuildActionFactory all return ExtensionList lookup TransientBuildActionFactory classpackage hudson model import hudson ExtensionList import hudson ExtensionPoint import java util ArrayList import java util Collection import java util List import jenkins model TransientActionFactory public abstract class TransientComputerActionFactory implements ExtensionPoint public abstract Collection extends Action createFor Computer target public static ExtensionList TransientComputerActionFactory all return ExtensionList lookup TransientComputerActionFactory class public static List Action createAllFor Computer target List Action result new ArrayList Action for TransientComputerActionFactory f all result addAll f createFor target return resultpackage jenkins model import hudson ExtensionList import hudson ExtensionPoint import hudson model Fingerprint import java util List public abstract class TransientFingerprintFacetFactory implements ExtensionPoint public abstract void createFor Fingerprint target List FingerprintFacet result public static ExtensionList TransientFingerprintFacetFactory all return ExtensionList lookup TransientFingerprintFacetFactory classpackage hudson model import hudson Extension import hudson ExtensionList import hudson ExtensionPoint import hudson tasks BuildStep import java util Collection import jenkins model TransientActionFactory public abstract class TransientProjectActionFactory implements ExtensionPoint public abstract Collection extends Action createFor AbstractProject target public static ExtensionList TransientProjectActionFactory all return ExtensionList lookup TransientProjectActionFactory classpackage hudson model import hudson Extension import hudson ExtensionList import hudson ExtensionPoint import jenkins model Jenkins import java util Collection import java util Collections public abstract class TransientUserActionFactory implements ExtensionPoint public Collection extends Action createFor User target return Collections emptyList public static ExtensionList TransientUserActionFactory all return ExtensionList lookup TransientUserActionFactory classpackage hudson model import hudson ExtensionList import hudson ExtensionPoint import java util ArrayList import java util List public abstract class TransientViewActionFactory implements ExtensionPoint public abstract List Action createFor View v public static ExtensionList TransientViewActionFactory all return ExtensionList lookup TransientViewActionFactory class public static List Action createAllFor View v List Action result new ArrayList Action for TransientViewActionFactory f all result addAll f createFor v return resultpackage jenkins util import java io Serializable import java util Map import org apache commons lang StringUtils import com thoughtworks xstream XStream import com thoughtworks xstream converters Converter import com thoughtworks xstream converters MarshallingContext import com thoughtworks xstream converters UnmarshallingContext import com thoughtworks xstream io HierarchicalStreamReader import com thoughtworks xstream io HierarchicalStreamWriter CHECKSTYLE OFF SuppressWarnings PMD public final class TreeString implements Serializable private static final long serialVersionUID 3621959682117480904L private TreeString parent private char label TreeString this null TreeString final TreeString parent final String label assert parent null label length 0 if there s a parent label can t be empty this parent parent this label label toCharArray string created as a substring of another string can have a lot of garbage attached to it String getLabel return new String label TreeString split final String prefix assert getLabel startsWith prefix char suffix new char label length prefix length System arraycopy label prefix length suffix 0 suffix length TreeString middle new TreeString parent prefix label suffix parent middle return middle private int depth int i 0 for TreeString p this p null p p parent i return i Override public boolean equals final Object rhs if rhs null return false return rhs getClass TreeString class TreeString rhs getLabel equals getLabel Override public int hashCode int h parent null 0 parent hashCode for int i 0 i label length i h 31 h label i assert toString hashCode h return h Override public String toString char tokens new char depth int i tokens length int sz 0 for TreeString p this p null p p parent tokens i p label sz p label length StringBuilder buf new StringBuilder sz for char token tokens buf append token return buf toString void dedup final Map String char table String l getLabel char v table get l if v null label v else table put l label public boolean isBlank return StringUtils isBlank toString public static String toString final TreeString t return t null null t toString public static TreeString of final String s if s null return null return new TreeString null s SuppressWarnings all public static final class ConverterImpl implements Converter public ConverterImpl final XStream xs public void marshal final Object source final HierarchicalStreamWriter writer final MarshallingContext context writer setValue source null null source toString public Object unmarshal final HierarchicalStreamReader reader final UnmarshallingContext context TreeStringBuilder builder TreeStringBuilder context get TreeStringBuilder class if builder null context put TreeStringBuilder class builder new TreeStringBuilder dedup at the end final TreeStringBuilder builder builder context addCompletionCallback new Runnable public void run builder dedup 0 return builder intern reader getValue public boolean canConvert final Class type return type TreeString classpackage jenkins util import java util Collections import java util HashMap import java util Map SuppressWarnings PMD all CHECKSTYLE OFF public class TreeStringBuilder Child root new Child new TreeString private static class Child private final TreeString node private Map String Child children NO CHILDREN private Child final TreeString node this node node public Child intern final String s if s length 0 return this makeWritable for Map Entry String Child e children entrySet int plen commonPrefix e getKey s if plen 0 if plen e getKey length insert a node between this and e value Child c e getValue String prefix s substring 0 plen Child middle c split prefix add middle instead of c children remove e getKey children put prefix middle return middle intern s substring plen else entire key is suffix return e getValue intern s substring plen no common prefix an entirely new node Child t children get s if t null children put s t new Child new TreeString node s return t private void makeWritable if children NO CHILDREN children new HashMap String Child private Child split final String prefix String suffix node getLabel substring prefix length Child middle new Child node split prefix middle makeWritable middle children put suffix this return middle private int commonPrefix final String a final String b int m Math min a length b length for int i 0 i m i if a charAt i b charAt i return i return m private void dedup final Map String char table node dedup table for Child child children values child dedup table public TreeString intern final String s if s null return null return root intern s node public TreeString intern final TreeString s if s null return null return root intern s toString node public void dedup root dedup new HashMap String char private static final Map String Child NO CHILDREN Collections emptyMappackage hudson model import hudson model Descriptor FormException import hudson util CaseInsensitiveComparator import hudson Indenter import hudson Extension import jenkins util SystemProperties import hudson views ViewsTabBar import jenkins model Jenkins import org kohsuke stapler DataBoundConstructor import org kohsuke stapler StaplerRequest import org kohsuke stapler StaplerResponse import javax servlet ServletException import java io IOException import java util Collection import java util Collections import java util List import java util Set import java util TreeSet import java util concurrent CopyOnWriteArrayList import org kohsuke stapler interceptor RequirePOST public class TreeView extends View implements ViewGroup private final Set String jobNames new TreeSet String CaseInsensitiveComparator INSTANCE private final CopyOnWriteArrayList View views new CopyOnWriteArrayList View DataBoundConstructor public TreeView String name super name public Indenter createFixedIndenter String d final int depth Integer parseInt d return new Indenter protected int getNestLevel Job job return depth public synchronized List TopLevelItem getItems return Jenkins getInstance getItems List TopLevelItem items new ArrayList TopLevelItem jobNames size for String name jobNames TopLevelItem item Hudson getInstance getItem name if item null items add item return items public boolean contains TopLevelItem item return true return jobNames contains item getName RequirePOST public TopLevelItem doCreateItem StaplerRequest req StaplerResponse rsp throws IOException ServletException ItemGroup extends TopLevelItem ig getOwnerItemGroup if ig instanceof ModifiableItemGroup TopLevelItem item ModifiableItemGroup extends TopLevelItem ig doCreateItem req rsp if item null jobNames add item getName owner save return item return null TODO listen for changes that might affect jobNames protected void submit StaplerRequest req throws IOException ServletException FormException public boolean canDelete View view return true public void deleteView View view throws IOException views remove view public Collection View getViews return Collections unmodifiableList views public View getView String name for View v views if v getViewName equals name return v return null public View getPrimaryView return null public void onViewRenamed View view String oldName String newName noop public void doCreateView StaplerRequest req StaplerResponse rsp throws IOException ServletException FormException checkPermission View CREATE views add View create req rsp this save this feature is not public yet Extension public static ViewDescriptor register if SystemProperties getBoolean hudson TreeView return new DescriptorImpl else return null public static final class DescriptorImpl extends ViewDescriptor public String getDisplayName return Tree View public ViewsTabBar getViewsTabBar return Jenkins getInstance getViewsTabBar public ItemGroup extends TopLevelItem getItemGroup return getOwnerItemGroup public List Action getViewActions return owner getViewActionspackage hudson triggers import hudson DependencyRunner import hudson DependencyRunner ProjectRunnable import hudson DescriptorExtensionList import hudson Extension import hudson ExtensionPoint import hudson model AbstractProject import hudson model Action import hudson model Build import hudson model Describable import hudson scheduler Hash import jenkins model Jenkins import hudson model Item import hudson model PeriodicWork import hudson model Project import hudson model TopLevelItem import hudson model TopLevelItemDescriptor import hudson scheduler CronTab import hudson scheduler CronTabList import java io InvalidObjectException import java io ObjectStreamException import java util ArrayList import java util Calendar import java util Collection import java util Collections import java util Date import java util GregorianCalendar import java util List import java util concurrent Future import java util logging Level import java util logging Logger import antlr ANTLRException import javax annotation CheckForNull import javax annotation Nonnull import edu umd cs findbugs annotations SuppressFBWarnings import hudson model Items import jenkins model ParameterizedJobMixIn import org jenkinsci Symbol public abstract class Trigger J extends Item implements Describable Trigger ExtensionPoint public void start J project boolean newInstance this job project try reparse the tabs with the job as the hash if spec null this tabs CronTabList create spec Hash from project getFullName else LOGGER log Level WARNING The job 0 has a null crontab spec which is incorrect job getFullName catch ANTLRException e this shouldn t fail because we ve already parsed stuff in the constructor so if it fails use whatever tabs that we already have LOGGER log Level WARNING String format Failed to parse crontab spec s in job s spec project getFullName e public void run public void stop Deprecated public Action getProjectAction return null public Collection extends Action getProjectActions delegate to getJobAction singular for backward compatible behavior Action a getProjectAction if a null return Collections emptyList return Collections singletonList a public TriggerDescriptor getDescriptor return TriggerDescriptor Jenkins getInstance getDescriptorOrDie getClass protected final String spec protected transient CronTabList tabs CheckForNull protected transient J job protected Trigger Nonnull String cronTabSpec throws ANTLRException this spec cronTabSpec this tabs CronTabList create cronTabSpec protected Trigger this spec this tabs new CronTabList Collections CronTab emptyList public final String getSpec return spec protected Object readResolve throws ObjectStreamException try tabs CronTabList create spec catch ANTLRException e InvalidObjectException x new InvalidObjectException e getMessage x initCause e throw x return this Extension Symbol cron public static class Cron extends PeriodicWork private final Calendar cal new GregorianCalendar public Cron cal set Calendar SECOND 0 cal set Calendar MILLISECOND 0 public long getRecurrencePeriod return MIN public long getInitialDelay return MIN Calendar getInstance get Calendar SECOND 1000 public void doRun while new Date getTime cal getTimeInMillis LOGGER log Level FINE cron checking 0 cal getTime try checkTriggers cal catch Throwable e LOGGER log Level WARNING Cron thread throw an exception e SafeTimerTask run would also catch this but be sure to increment cal too cal add Calendar MINUTE 1 private static Future previousSynchronousPolling public static void checkTriggers final Calendar cal Jenkins inst Jenkins getInstance Are we using synchronous polling SCMTrigger DescriptorImpl scmd inst getDescriptorByType SCMTrigger DescriptorImpl class if scmd synchronousPolling LOGGER fine using synchronous polling Check that previous synchronous polling job is done to prevent piling up too many jobs if previousSynchronousPolling null previousSynchronousPolling isDone Process SCMTriggers in the order of dependencies Note that the crontab spec expressed per project is ignored only the global setting is honored The polling job is submitted only if the previous job has terminated FIXME allow to set a global crontab spec previousSynchronousPolling scmd getExecutor submit new DependencyRunner new ProjectRunnable public void run AbstractProject p for Trigger t Collection Trigger p getTriggers values if t instanceof SCMTrigger LOGGER fine synchronously triggering SCMTrigger for project t job getName t run else LOGGER fine synchronous polling has detected unfinished jobs will not trigger additional jobs Process all triggers except SCMTriggers when synchronousPolling is set for ParameterizedJobMixIn ParameterizedJob p inst getAllItems ParameterizedJobMixIn ParameterizedJob class for Trigger t p getTriggers values if t instanceof SCMTrigger scmd synchronousPolling if t null t spec null t tabs null LOGGER log Level FINE cron checking 0 with spec 1 new Object p t spec trim if t tabs check cal LOGGER log Level CONFIG cron triggered 0 p try t run catch Throwable e t run is a plugin and some of them throw RuntimeException and other things don t let that cancel the polling activity report and move on LOGGER log Level WARNING t getClass getName run failed for p e else LOGGER log Level FINER did not trigger 0 p else LOGGER log Level WARNING The job 0 has a syntactically incorrect config and is missing the cron spec for a trigger p getFullName private static final Logger LOGGER Logger getLogger Trigger class getName SuppressWarnings MS SHOULD BE FINAL Deprecated public static CheckForNull java util Timer timer public static DescriptorExtensionList Trigger TriggerDescriptor all return DescriptorExtensionList Jenkins getInstance getDescriptorList Trigger class public static List TriggerDescriptor for Item i List TriggerDescriptor r new ArrayList for TriggerDescriptor t all if t isApplicable i continue if i instanceof TopLevelItem ugly TopLevelItemDescriptor tld TopLevelItem i getDescriptor tld shouldn t be really null in contract but we often write test Describables that doesn t have a Descriptor if tld null tld isApplicable t continue r add t return rpackage hudson triggers import hudson model Descriptor import hudson model Item import hudson scm SCM public abstract class TriggerDescriptor extends Descriptor Trigger protected TriggerDescriptor Class extends Trigger clazz super clazz protected TriggerDescriptor public abstract boolean isApplicable Item itempackage hudson triggers import hudson model Item import hudson util DescriptorList import hudson Extension import java util List Deprecated public class Triggers Deprecated public static final List TriggerDescriptor TRIGGERS List new DescriptorList Trigger Class Trigger class Descriptor toList SCMTrigger DESCRIPTOR TimerTrigger DESCRIPTOR Deprecated public static List TriggerDescriptor getApplicableTriggers Item i return Trigger for ipackage com twitter sdk android core models import com google gson annotations SerializedName import java util List public class Tweet implements Identifiable public static final long INVALID ID 1L SerializedName coordinates public final Coordinates coordinates SerializedName created at public final String createdAt SerializedName current user retweet public final Object currentUserRetweet SerializedName entities public final TweetEntities entities SerializedName extended entities public final TweetEntities extendedEtities SerializedName favorite count public final Integer favoriteCount SerializedName favorited public final boolean favorited SerializedName filter level public final String filterLevel SerializedName id public final long id SerializedName id str public final String idStr SerializedName in reply to screen name public final String inReplyToScreenName SerializedName in reply to status id public final long inReplyToStatusId SerializedName in reply to status id str public final String inReplyToStatusIdStr SerializedName in reply to user id public final long inReplyToUserId SerializedName in reply to user id str public final String inReplyToUserIdStr SerializedName lang public final String lang SerializedName place public final Place place SerializedName possibly sensitive public final boolean possiblySensitive SerializedName scopes public final Object scopes SerializedName quoted status id public final long quotedStatusId SerializedName quoted status id str public final String quotedStatusIdStr SerializedName quoted status public final Tweet quotedStatus SerializedName retweet count public final int retweetCount SerializedName retweeted public final boolean retweeted SerializedName retweeted status public final Tweet retweetedStatus SerializedName source public final String source SerializedName value text alternate full text public final String text SerializedName display text range public final List Integer displayTextRange SerializedName truncated public final boolean truncated SerializedName user public final User user SerializedName withheld copyright public final boolean withheldCopyright SerializedName withheld in countries public final List String withheldInCountries SerializedName withheld scope public final String withheldScope SerializedName card public final Card card public Tweet Coordinates coordinates String createdAt Object currentUserRetweet TweetEntities entities TweetEntities extendedEtities Integer favoriteCount boolean favorited String filterLevel long id String idStr String inReplyToScreenName long inReplyToStatusId String inReplyToStatusIdStr long inReplyToUserId String inReplyToUserIdStr String lang Place place boolean possiblySensitive Object scopes long quotedStatusId String quotedStatusIdStr Tweet quotedStatus int retweetCount boolean retweeted Tweet retweetedStatus String source String text List Integer displayTextRange boolean truncated User user boolean withheldCopyright List String withheldInCountries String withheldScope Card card this coordinates coordinates this createdAt createdAt this currentUserRetweet currentUserRetweet this entities entities this extendedEtities extendedEtities this favoriteCount favoriteCount this favorited favorited this filterLevel filterLevel this id id this idStr idStr this inReplyToScreenName inReplyToScreenName this inReplyToStatusId inReplyToStatusId this inReplyToStatusIdStr inReplyToStatusIdStr this inReplyToUserId inReplyToUserId this inReplyToUserIdStr inReplyToUserIdStr this lang lang this place place this possiblySensitive possiblySensitive this scopes scopes this quotedStatusId quotedStatusId this quotedStatusIdStr quotedStatusIdStr this quotedStatus quotedStatus this retweetCount retweetCount this retweeted retweeted this retweetedStatus retweetedStatus this source source this text text this displayTextRange displayTextRange this truncated truncated this user user this withheldCopyright withheldCopyright this withheldInCountries withheldInCountries this withheldScope withheldScope this card card Override public long getId return this id Override public boolean equals Object o if o null return false if o instanceof Tweet return false final Tweet other Tweet o return this id other id Override public int hashCode return int this idpackage com twitter sdk android tweetui import android content Context import android util AttributeSet import android widget ImageButton import android widget LinearLayout import com twitter sdk android core Callback import com twitter sdk android core models Tweet public class TweetActionBarView extends LinearLayout final DependencyProvider dependencyProvider ToggleImageButton likeButton ImageButton shareButton Callback Tweet actionCallback public TweetActionBarView Context context this context null new DependencyProvider public TweetActionBarView Context context AttributeSet attrs this context attrs new DependencyProvider TweetActionBarView Context context AttributeSet attrs DependencyProvider dependencyProvider super context attrs this dependencyProvider dependencyProvider Override protected void onFinishInflate super onFinishInflate findSubviews void setOnActionCallback Callback Tweet actionCallback this actionCallback actionCallback void findSubviews likeButton ToggleImageButton findViewById R id tw tweet like button shareButton ImageButton findViewById R id tw tweet share button void setTweet Tweet tweet setLike tweet setShare tweet void setLike Tweet tweet final TweetUi tweetUi dependencyProvider getTweetUi if tweet null likeButton setToggledOn tweet favorited final LikeTweetAction likeTweetAction new LikeTweetAction tweet tweetUi actionCallback likeButton setOnClickListener likeTweetAction void setShare Tweet tweet final TweetUi tweetUi dependencyProvider getTweetUi if tweet null shareButton setOnClickListener new ShareTweetAction tweet tweetUi static class DependencyProvider TweetUi getTweetUi return TweetUi getInstancepackage com twitter sdk android core models import java util Collections import java util List public class TweetBuilder private Coordinates coordinates private String createdAt private Object currentUserRetweet private TweetEntities entities private TweetEntities extendedEtities private Integer favoriteCount private boolean favorited private String filterLevel private long id Tweet INVALID ID private String idStr private String inReplyToScreenName private long inReplyToStatusId private String inReplyToStatusIdStr private long inReplyToUserId private String inReplyToUserIdStr private String lang private Place place private boolean possiblySensitive private Object scopes private long quotedStatusId private String quotedStatusIdStr private Tweet quotedStatus private int retweetCount private boolean retweeted private Tweet retweetedStatus private String source private String text private List Integer displayTextRange Collections EMPTY LIST private boolean truncated private User user private boolean withheldCopyright private List String withheldInCountries Collections EMPTY LIST private String withheldScope private Card card public TweetBuilder setCoordinates Coordinates coordinates this coordinates coordinates return this public TweetBuilder setCreatedAt String createdAt this createdAt createdAt return this public TweetBuilder setCurrentUserRetweet Object currentUserRetweet this currentUserRetweet currentUserRetweet return this public TweetBuilder setEntities TweetEntities entities this entities entities return this public TweetBuilder setExtendedEntities TweetEntities extendedEtities this extendedEtities extendedEtities return this public TweetBuilder setFavoriteCount Integer favoriteCount this favoriteCount favoriteCount return this public TweetBuilder setFavorited boolean favorited this favorited favorited return this public TweetBuilder setFilterLevel String filterLevel this filterLevel filterLevel return this public TweetBuilder setId long id this id id return this public TweetBuilder setIdStr String idStr this idStr idStr return this public TweetBuilder setInReplyToScreenName String inReplyToScreenName this inReplyToScreenName inReplyToScreenName return this public TweetBuilder setInReplyToStatusId long inReplyToStatusId this inReplyToStatusId inReplyToStatusId return this public TweetBuilder setInReplyToStatusIdStr String inReplyToStatusIdStr this inReplyToStatusIdStr inReplyToStatusIdStr return this public TweetBuilder setInReplyToUserId long inReplyToUserId this inReplyToUserId inReplyToUserId return this public TweetBuilder setInReplyToUserIdStr String inReplyToUserIdStr this inReplyToUserIdStr inReplyToUserIdStr return this public TweetBuilder setLang String lang this lang lang return this public TweetBuilder setPlace Place place this place place return this public TweetBuilder setPossiblySensitive boolean possiblySensitive this possiblySensitive possiblySensitive return this public TweetBuilder setScopes Object scopes this scopes scopes return this public TweetBuilder setQuotedStatusId long quotedStatusId this quotedStatusId quotedStatusId return this public TweetBuilder setQuotedStatusIdStr String quotedStatusIdStr this quotedStatusIdStr quotedStatusIdStr return this public TweetBuilder setQuotedStatus Tweet quotedStatus this quotedStatus quotedStatus return this public TweetBuilder setRetweetCount int retweetCount this retweetCount retweetCount return this public TweetBuilder setRetweeted boolean retweeted this retweeted retweeted return this public TweetBuilder setRetweetedStatus Tweet retweetedStatus this retweetedStatus retweetedStatus return this public TweetBuilder setSource String source this source source return this public TweetBuilder setText String text this text text return this public TweetBuilder setDisplayTextRange List Integer displayTextRange this displayTextRange displayTextRange return this public TweetBuilder setTruncated boolean truncated this truncated truncated return this public TweetBuilder setUser User user this user user return this public TweetBuilder setWithheldCopyright boolean withheldCopyright this withheldCopyright withheldCopyright return this public TweetBuilder setWithheldInCountries List String withheldInCountries this withheldInCountries withheldInCountries return this public TweetBuilder setWithheldScope String withheldScope this withheldScope withheldScope return this public TweetBuilder setCard Card card this card card return this public TweetBuilder copy Tweet tweet this coordinates tweet coordinates this createdAt tweet createdAt this currentUserRetweet tweet currentUserRetweet this entities tweet entities this extendedEtities tweet extendedEtities this favoriteCount tweet favoriteCount this favorited tweet favorited this filterLevel tweet filterLevel this id tweet id this idStr tweet idStr this inReplyToScreenName tweet inReplyToScreenName this inReplyToStatusId tweet inReplyToStatusId this inReplyToStatusIdStr tweet inReplyToStatusIdStr this inReplyToUserId tweet inReplyToUserId this inReplyToUserIdStr tweet inReplyToStatusIdStr this lang tweet lang this place tweet place this possiblySensitive tweet possiblySensitive this scopes tweet scopes this quotedStatusId tweet quotedStatusId this quotedStatusIdStr tweet quotedStatusIdStr this quotedStatus tweet quotedStatus this retweetCount tweet retweetCount this retweeted tweet retweeted this retweetedStatus tweet retweetedStatus this source tweet source this text tweet text this displayTextRange tweet displayTextRange this truncated tweet truncated this user tweet user this withheldCopyright tweet withheldCopyright this withheldInCountries tweet withheldInCountries this withheldScope tweet withheldScope this card tweet card return this public Tweet build return new Tweet coordinates createdAt currentUserRetweet entities extendedEtities favoriteCount favorited filterLevel id idStr inReplyToScreenName inReplyToStatusId inReplyToStatusIdStr inReplyToUserId inReplyToUserIdStr lang place possiblySensitive scopes quotedStatusId quotedStatusIdStr quotedStatus retweetCount retweeted retweetedStatus source text displayTextRange truncated user withheldCopyright withheldInCountries withheldScope cardpackage com twitter sdk android tweetcomposer import android content Context import android content Intent import android content pm PackageManager import android content pm ResolveInfo import android net Uri import android text TextUtils import com twitter sdk android core GuestSessionProvider import com twitter sdk android core Session import com twitter sdk android core SessionManager import com twitter sdk android core TwitterCore import com twitter sdk android core TwitterSession import com twitter sdk android core internal scribe DefaultScribeClient import io fabric sdk android Fabric import io fabric sdk android Kit import io fabric sdk android services concurrency DependsOn import io fabric sdk android services network UrlUtils import java net URL import java util List import java util concurrent ConcurrentHashMap DependsOn TwitterCore class public class TweetComposer extends Kit Void private static final String MIME TYPE PLAIN TEXT text plain private static final String MIME TYPE JPEG image jpeg private static final String TWITTER PACKAGE NAME com twitter android private static final String WEB INTENT https twitter com intent tweet text s url s private static final String KIT SCRIBE NAME TweetComposer private final ConcurrentHashMap Session ComposerApiClient apiClients String advertisingId SessionManager TwitterSession sessionManager GuestSessionProvider guestSessionProvider private ScribeClient scribeClient public TweetComposer this apiClients new ConcurrentHashMap scribeClient new ScribeClientImpl null Override public String getVersion return BuildConfig VERSION NAME BuildConfig BUILD NUMBER protected boolean onPreExecute sessionManager TwitterCore getInstance getSessionManager guestSessionProvider TwitterCore getInstance getGuestSessionProvider return super onPreExecute Override protected Void doInBackground advertisingId getIdManager getAdvertisingId scribeClient new ScribeClientImpl new DefaultScribeClient this KIT SCRIBE NAME sessionManager guestSessionProvider getIdManager return null Override public String getIdentifier return BuildConfig GROUP BuildConfig ARTIFACT ID public ComposerApiClient getApiClient TwitterSession session checkInitialized if apiClients containsKey session apiClients putIfAbsent session new ComposerApiClient session return apiClients get session public static TweetComposer getInstance checkInitialized return Fabric getKit TweetComposer class protected ScribeClient getScribeClient return scribeClient private static void checkInitialized if Fabric getKit TweetComposer class null throw new IllegalStateException Must start Twitter Kit with Fabric with first String getAdvertisingId return advertisingId public static class Builder private final Context context private String text private URL url private Uri imageUri public Builder Context context if context null throw new IllegalArgumentException Context must not be null this context context public Builder text String text if text null throw new IllegalArgumentException text must not be null if this text null throw new IllegalStateException text already set this text text return this public Builder url URL url if url null throw new IllegalArgumentException url must not be null if this url null throw new IllegalStateException url already set this url url return this public Builder image Uri imageUri if imageUri null throw new IllegalArgumentException imageUri must not be null if this imageUri null throw new IllegalStateException imageUri already set this imageUri imageUri return this public Intent createIntent Intent intent createTwitterIntent if intent null intent createWebIntent return intent Intent createTwitterIntent final Intent intent new Intent Intent ACTION SEND final StringBuilder builder new StringBuilder if TextUtils isEmpty text builder append text if url null if builder length 0 builder append builder append url toString intent putExtra Intent EXTRA TEXT builder toString intent setType MIME TYPE PLAIN TEXT if imageUri null intent putExtra Intent EXTRA STREAM imageUri intent setType MIME TYPE JPEG final PackageManager packManager context getPackageManager final List ResolveInfo resolvedInfoList packManager queryIntentActivities intent PackageManager MATCH DEFAULT ONLY for ResolveInfo resolveInfo resolvedInfoList if resolveInfo activityInfo packageName startsWith TWITTER PACKAGE NAME intent setClassName resolveInfo activityInfo packageName resolveInfo activityInfo name return intent return null Intent createWebIntent final String url this url null this url toString final String tweetUrl String format WEB INTENT UrlUtils urlEncode text UrlUtils urlEncode url return new Intent Intent ACTION VIEW Uri parse tweetUrl public void show final Intent intent createIntent context startActivity intentpackage com twitter sdk android tweetui import android content res Resources import android text format DateUtils import java text ParseException import java text SimpleDateFormat import java util Calendar import java util Date import java util Locale Cribbed from twitter android internal renamed and formatted to our standards methods here should only be accessed on the main thread final class TweetDateUtils Sat Mar 14 02 34 20 0000 2009 static final SimpleDateFormat DATE TIME RFC822 new SimpleDateFormat EEE MMM dd HH mm ss Z yyyy Locale ENGLISH static final SimpleDateFormat RELATIVE DATE FORMAT new SimpleDateFormat MM dd yy Locale ENGLISH static final long INVALID DATE 1 private TweetDateUtils static long apiTimeToLong String apiTime if apiTime null return INVALID DATE try return DATE TIME RFC822 parse apiTime getTime catch ParseException e return INVALID DATE static boolean isValidTimestamp String timestamp return TweetDateUtils apiTimeToLong timestamp TweetDateUtils INVALID DATE public static String dotPrefix String timestamp if timestamp charAt 0 return timestamp return timestamp static String getRelativeTimeString Resources res long currentTimeMillis long timestamp final long diff currentTimeMillis timestamp if diff 0 if diff DateUtils MINUTE IN MILLIS Less than a minute ago final int secs int diff 1000 return res getQuantityString R plurals tw time secs secs secs else if diff DateUtils HOUR IN MILLIS Less than an hour ago final int mins int diff DateUtils MINUTE IN MILLIS return res getQuantityString R plurals tw time mins mins mins else if diff DateUtils DAY IN MILLIS Less than a day ago final int hours int diff DateUtils HOUR IN MILLIS return res getQuantityString R plurals tw time hours hours hours else final Calendar now Calendar getInstance now setTimeInMillis currentTimeMillis final Calendar c Calendar getInstance c setTimeInMillis timestamp final Date d new Date timestamp if now get Calendar YEAR c get Calendar YEAR Same year RELATIVE DATE FORMAT applyPattern res getString R string tw relative date format short else Outside of our year RELATIVE DATE FORMAT applyPattern res getString R string tw relative date format long return RELATIVE DATE FORMAT format d RELATIVE DATE FORMAT applyPattern res getString R string tw relative date format long return RELATIVE DATE FORMAT format new Date timestamppackage com twitter sdk android core models import com google gson annotations SerializedName import java util Collections import java util List public class TweetEntities SerializedName urls public final List UrlEntity urls SerializedName user mentions public final List MentionEntity userMentions SerializedName media public final List MediaEntity media SerializedName hashtags public final List HashtagEntity hashtags public TweetEntities List UrlEntity urls List MentionEntity userMentions List MediaEntity media List HashtagEntity hashtags this urls getSafeList urls this userMentions getSafeList userMentions this media getSafeList media this hashtags getSafeList hashtags private T List T getSafeList List T entities Entities may be null if Gson does not find object to parse When that happens make sure to return an empty list if entities null return Collections EMPTY LIST else return Collections unmodifiableList entitiespackage com twitter sdk android tweetui import com twitter sdk android core models Tweet public interface TweetLinkClickListener void onLinkClick Tweet tweet String urlpackage com twitter sdk android tweetui import com twitter sdk android core models MediaEntity import com twitter sdk android core models Tweet public interface TweetMediaClickListener void onMediaEntityClick Tweet tweet MediaEntity entitypackage com twitter sdk android tweetui internal import android os Build import com twitter sdk android core models MediaEntity import com twitter sdk android core models Tweet import com twitter sdk android core models VideoInfo import java util ArrayList import java util List final public class TweetMediaUtils public static final String PHOTO TYPE photo public static final String VIDEO TYPE video public static final String GIF TYPE animated gif private static final String CONTENT TYPE MP4 video mp4 private static final String CONTENT TYPE HLS application x mpegURL private TweetMediaUtils static public MediaEntity getPhotoEntity Tweet tweet final List MediaEntity mediaEntityList getAllMediaEntities tweet for int i mediaEntityList size 1 i 0 i final MediaEntity entity mediaEntityList get i if entity type null isPhotoType entity return entity return null static public boolean hasPhoto Tweet tweet return getPhotoEntity tweet null static public MediaEntity getVideoEntity Tweet tweet for MediaEntity mediaEntity getAllMediaEntities tweet if mediaEntity type null isVideoType mediaEntity return mediaEntity return null static public boolean hasSupportedVideo Tweet tweet final MediaEntity entity getVideoEntity tweet return entity null getSupportedVariant entity null static boolean isPhotoType MediaEntity mediaEntity return PHOTO TYPE equals mediaEntity type static boolean isVideoType MediaEntity mediaEntity return VIDEO TYPE equals mediaEntity type GIF TYPE equals mediaEntity type static public VideoInfo Variant getSupportedVariant MediaEntity mediaEntity for VideoInfo Variant variant mediaEntity videoInfo variants if isVariantSupported variant return variant return null static public boolean isLooping MediaEntity mediaEntity return GIF TYPE equals mediaEntity type static boolean isVariantSupported VideoInfo Variant variant if Build VERSION SDK INT Build VERSION CODES LOLLIPOP CONTENT TYPE HLS equals variant contentType return true else if CONTENT TYPE MP4 equals variant contentType return true return false static List MediaEntity getAllMediaEntities Tweet tweet final List MediaEntity entities new ArrayList if tweet entities null tweet entities media null entities addAll tweet entities media if tweet extendedEtities null tweet extendedEtities media null entities addAll tweet extendedEtities media return entitiespackage com twitter sdk android tweetui internal import android content Context import android graphics Canvas import android graphics drawable Drawable import android util AttributeSet import android widget ImageView import com twitter sdk android core internal util AspectRatioImageView public class TweetMediaView extends AspectRatioImageView Overlay overlay new Overlay null public TweetMediaView Context context super context public TweetMediaView Context context AttributeSet attrs super context attrs Override protected void onDraw Canvas canvas super onDraw canvas overlay draw canvas Override protected void drawableStateChanged super drawableStateChanged overlay setDrawableState getDrawableState Override protected void onMeasure int widthMeasureSpec int heightMeasureSpec super onMeasure widthMeasureSpec heightMeasureSpec overlay setDrawableBounds getMeasuredWidth getMeasuredHeight Override protected void onSizeChanged int width int height int oldWidth int oldHeight super onSizeChanged width height oldWidth oldHeight overlay setDrawableBounds width height Override public void invalidateDrawable Drawable drawable if drawable overlay drawable invalidate else super invalidateDrawable drawable public void setOverlayDrawable Drawable drawable overlay cleanupDrawable this if drawable null drawable setCallback this overlay new Overlay drawable overlay setDrawableState getDrawableState requestLayout static protected class Overlay final Drawable drawable Overlay Drawable drawable this drawable drawable protected void cleanupDrawable ImageView imageView if drawable null drawable setCallback null imageView unscheduleDrawable drawable protected void setDrawableBounds int width int height if drawable null drawable setBounds 0 0 width height protected void setDrawableState int state if drawable null drawable isStateful drawable setState state protected void draw Canvas canvas if drawable null drawable draw canvaspackage com twitter sdk android tweetui import android os Handler import android support v4 util LruCache import android text TextUtils import com twitter sdk android core Callback import com twitter sdk android core Result import com twitter sdk android core SessionManager import com twitter sdk android core TwitterAuthException import com twitter sdk android core TwitterCore import com twitter sdk android core TwitterException import com twitter sdk android core TwitterSession import com twitter sdk android core models Tweet import java util List import io fabric sdk android Fabric class TweetRepository Cache size units are in number of entries an average Tweet is roughly 900 bytes in memory private static final int DEFAULT CACHE SIZE 20 private final TwitterCore twitterCore private final Handler mainHandler private final SessionManager TwitterSession userSessionManagers leave this package accessible for testing final LruCache Long Tweet tweetCache final LruCache Long FormattedTweetText formatCache TweetRepository Handler mainHandler SessionManager TwitterSession userSessionManagers this mainHandler userSessionManagers TwitterCore getInstance Testing only TweetRepository Handler mainHandler SessionManager TwitterSession userSessionManagers TwitterCore twitterCore this twitterCore twitterCore this mainHandler mainHandler this userSessionManagers userSessionManagers tweetCache new LruCache DEFAULT CACHE SIZE formatCache new LruCache DEFAULT CACHE SIZE FormattedTweetText formatTweetText final Tweet tweet if tweet null return null final FormattedTweetText cached formatCache get tweet id if cached null return cached final FormattedTweetText formattedTweetText TweetTextUtils formatTweetText tweet if formattedTweetText null TextUtils isEmpty formattedTweetText text formatCache put tweet id formattedTweetText return formattedTweetText void updateCache final Tweet tweet tweetCache put tweet id tweet private void deliverTweet final Tweet tweet final Callback Tweet cb if cb null return mainHandler post new Runnable Override public void run cb success new Result tweet null void favorite final long tweetId final Callback Tweet cb getUserSession new LoggingCallback TwitterSession cb Fabric getLogger Override public void success Result TwitterSession result twitterCore getApiClient result data getFavoriteService create tweetId false enqueue cb void unfavorite final long tweetId final Callback Tweet cb getUserSession new LoggingCallback TwitterSession cb Fabric getLogger Override public void success Result TwitterSession result twitterCore getApiClient result data getFavoriteService destroy tweetId false enqueue cb void retweet final long tweetId final Callback Tweet cb getUserSession new LoggingCallback TwitterSession cb Fabric getLogger Override public void success Result TwitterSession result twitterCore getApiClient result data getStatusesService retweet tweetId false enqueue cb void unretweet final long tweetId final Callback Tweet cb getUserSession new LoggingCallback TwitterSession cb Fabric getLogger Override public void success Result TwitterSession result twitterCore getApiClient result data getStatusesService unretweet tweetId false enqueue cb void getUserSession final Callback TwitterSession cb final TwitterSession session userSessionManagers getActiveSession if session null cb failure new TwitterAuthException User authorization required else cb success new Result session null void loadTweet final long tweetId final Callback Tweet cb final Tweet cachedTweet tweetCache get tweetId if cachedTweet null deliverTweet cachedTweet cb return twitterCore getApiClient getStatusesService show tweetId null null null enqueue new SingleTweetCallback cb void loadTweets final List Long tweetIds final Callback List Tweet cb final String commaSepIds TextUtils join tweetIds twitterCore getApiClient getStatusesService lookup commaSepIds null null null enqueue new MultiTweetsCallback tweetIds cb class SingleTweetCallback extends Callback Tweet final Callback Tweet cb SingleTweetCallback Callback Tweet cb this cb cb Override public void success Result Tweet result final Tweet tweet result data updateCache tweet if cb null cb success new Result tweet result response Override public void failure TwitterException exception cb failure exception class MultiTweetsCallback extends Callback List Tweet final Callback List Tweet cb final List Long tweetIds MultiTweetsCallback List Long tweetIds Callback List Tweet cb this cb cb this tweetIds tweetIds Override public void success Result List Tweet result if cb null final List Tweet sorted Utils orderTweets tweetIds result data cb success new Result sorted result response Override public void failure TwitterException exception cb failure exceptionpackage com twitter sdk android tweetui import com twitter sdk android core models Tweet public interface TweetScribeClient void impression Tweet tweet String viewName boolean actionEnabled void share Tweet tweet void favorite Tweet tweet void unfavorite Tweet tweet void click Tweet tweet String viewNamepackage com twitter sdk android tweetui import com twitter sdk android core internal scribe EventNamespace import com twitter sdk android core internal scribe ScribeItem import com twitter sdk android core internal scribe SyndicatedSdkImpressionEvent import com twitter sdk android core internal scribe SyndicationClientEvent import com twitter sdk android core models Tweet import java util ArrayList import java util List class TweetScribeClientImpl implements TweetScribeClient tfw client event specific names static final String TFW CLIENT EVENT PAGE android static final String TFW CLIENT EVENT SECTION tweet static final String TFW CLIENT EVENT ELEMENT intentionally blank syndicated sdk impression specific names static final String SYNDICATED SDK IMPRESSION PAGE tweet static final String SYNDICATED SDK IMPRESSION COMPONENT static final String SYNDICATED SDK IMPRESSION ELEMENT intentionally blank general names static final String SCRIBE CLICK ACTION click static final String SCRIBE IMPRESSION ACTION impression static final String SCRIBE FAVORITE ACTION favorite static final String SCRIBE UNFAVORITE ACTION unfavorite static final String SCRIBE SHARE ACTION share static final String SCRIBE ACTIONS ELEMENT actions final TweetUi tweetUi TweetScribeClientImpl TweetUi tweetUi this tweetUi tweetUi Override public void impression Tweet tweet String viewName boolean actionEnabled final List ScribeItem items new ArrayList items add ScribeItem fromTweet tweet tweetUi scribe getTfwImpressionNamespace viewName actionEnabled items tweetUi scribe getSyndicatedImpressionNamespace viewName items Override public void share Tweet tweet final List ScribeItem items new ArrayList items add ScribeItem fromTweet tweet tweetUi scribe getTfwShareNamespace items Override public void favorite Tweet tweet final List ScribeItem items new ArrayList items add ScribeItem fromTweet tweet tweetUi scribe getTfwFavoriteNamespace items Override public void unfavorite Tweet tweet final List ScribeItem items new ArrayList items add ScribeItem fromTweet tweet tweetUi scribe getTfwUnfavoriteNamespace items Override public void click Tweet tweet String viewName final List ScribeItem items new ArrayList items add ScribeItem fromTweet tweet tweetUi scribe getTfwClickNamespace viewName items static EventNamespace getTfwImpressionNamespace String viewName boolean actionEnabled return new EventNamespace Builder setClient SyndicationClientEvent CLIENT NAME setPage TFW CLIENT EVENT PAGE setSection TFW CLIENT EVENT SECTION setComponent viewName setElement actionEnabled SCRIBE ACTIONS ELEMENT TFW CLIENT EVENT ELEMENT setAction SCRIBE IMPRESSION ACTION builder static EventNamespace getTfwUnfavoriteNamespace return new EventNamespace Builder setClient SyndicationClientEvent CLIENT NAME setPage TFW CLIENT EVENT PAGE setSection TFW CLIENT EVENT SECTION setElement SCRIBE ACTIONS ELEMENT setAction SCRIBE UNFAVORITE ACTION builder static EventNamespace getTfwFavoriteNamespace return new EventNamespace Builder setClient SyndicationClientEvent CLIENT NAME setPage TFW CLIENT EVENT PAGE setSection TFW CLIENT EVENT SECTION setElement SCRIBE ACTIONS ELEMENT setAction SCRIBE FAVORITE ACTION builder static EventNamespace getTfwShareNamespace return new EventNamespace Builder setClient SyndicationClientEvent CLIENT NAME setPage TFW CLIENT EVENT PAGE setSection TFW CLIENT EVENT SECTION setElement SCRIBE ACTIONS ELEMENT setAction SCRIBE SHARE ACTION builder static EventNamespace getTfwClickNamespace String viewName return new EventNamespace Builder setClient SyndicationClientEvent CLIENT NAME setPage TFW CLIENT EVENT PAGE setSection TFW CLIENT EVENT SECTION setComponent viewName setElement TFW CLIENT EVENT ELEMENT setAction SCRIBE CLICK ACTION builder static EventNamespace getSyndicatedImpressionNamespace String viewName return new EventNamespace Builder setClient SyndicatedSdkImpressionEvent CLIENT NAME setPage SYNDICATED SDK IMPRESSION PAGE setSection viewName setComponent SYNDICATED SDK IMPRESSION COMPONENT setElement SYNDICATED SDK IMPRESSION ELEMENT setAction SCRIBE IMPRESSION ACTION builderpackage com twitter sdk android tweetui import android text SpannableStringBuilder import android text Spanned import android text TextUtils import android text style CharacterStyle import android view View import com twitter sdk android tweetui internal ClickableLinkSpan import java util ArrayList import java util Collections import java util Comparator import java util List final class TweetTextLinkifier private static final String PHOTO TYPE photo private TweetTextLinkifier static CharSequence linkifyUrls FormattedTweetText tweetText final LinkClickListener listener boolean stripLastPhotoEntity final int linkColor final int linkHighlightColor if tweetText null return null if TextUtils isEmpty tweetText text return tweetText text final SpannableStringBuilder spannable new SpannableStringBuilder tweetText text final List FormattedUrlEntity urls tweetText urlEntities final List FormattedMediaEntity media tweetText mediaEntities final FormattedMediaEntity lastPhoto if stripLastPhotoEntity lastPhoto getLastPhotoEntity tweetText else lastPhoto null final List FormattedUrlEntity combined mergeAndSortEntities urls media addUrlEntities spannable combined lastPhoto listener linkColor linkHighlightColor return spannable static List FormattedUrlEntity mergeAndSortEntities final List FormattedUrlEntity urls final List FormattedMediaEntity media if media null return urls final ArrayList FormattedUrlEntity combined new ArrayList urls combined addAll media Collections sort combined new Comparator FormattedUrlEntity Override public int compare FormattedUrlEntity lhs FormattedUrlEntity rhs if lhs null rhs null return 1 if lhs null rhs null return 1 if lhs null rhs null return 0 if lhs start rhs start return 1 if lhs start rhs start return 1 return 0 return combined private static void addUrlEntities final SpannableStringBuilder spannable final List FormattedUrlEntity entities final FormattedMediaEntity lastPhoto final LinkClickListener listener final int linkColor final int linkHighlightColor if entities null entities isEmpty return int offset 0 int len int start int end for final FormattedUrlEntity url entities start url start offset end url end offset if start 0 end spannable length replace the last photo url with empty string we can use the start indices as as simple check since none of this will work anyways if we have overlapping entities if lastPhoto null lastPhoto start url start spannable replace start end len end start end len offset len else if TextUtils isEmpty url displayUrl spannable replace start end url displayUrl len end start url displayUrl length end len offset len final CharacterStyle span new ClickableLinkSpan linkHighlightColor linkColor false Override public void onClick View widget if listener null return listener onUrlClicked url url spannable setSpan span start end Spanned SPAN EXCLUSIVE EXCLUSIVE private static FormattedMediaEntity getLastPhotoEntity final FormattedTweetText formattedTweetText if formattedTweetText null return null final List FormattedMediaEntity mediaEntityList formattedTweetText mediaEntities if mediaEntityList isEmpty return null FormattedMediaEntity entity for int i mediaEntityList size 1 i 0 i entity mediaEntityList get i if PHOTO TYPE equals entity type return entity return nullpackage com twitter sdk android tweetui import android text TextUtils import com twitter sdk android core models MediaEntity import com twitter sdk android core models Tweet import com twitter sdk android core models UrlEntity import com twitter sdk android tweetui internal util HtmlEntities import java util ArrayList import java util List final class TweetTextUtils private TweetTextUtils static FormattedTweetText formatTweetText Tweet tweet if tweet null return null final FormattedTweetText adjustedTweet new FormattedTweetText convertEntities adjustedTweet tweet format adjustedTweet tweet return adjustedTweet static void convertEntities FormattedTweetText formattedTweetText Tweet tweet if tweet entities null return final List UrlEntity coreUrls tweet entities urls if coreUrls null for UrlEntity entity coreUrls final FormattedUrlEntity formattedUrlEntity new FormattedUrlEntity entity formattedTweetText urlEntities add formattedUrlEntity final List MediaEntity coreMedia tweet entities media if coreMedia null for MediaEntity entity coreMedia final FormattedMediaEntity formattedMediaEntity new FormattedMediaEntity entity formattedTweetText mediaEntities add formattedMediaEntity static void format FormattedTweetText formattedTweetText Tweet tweet if TextUtils isEmpty tweet text return final HtmlEntities Unescaped u HtmlEntities HTML40 unescape tweet text final StringBuilder result new StringBuilder u unescaped adjustIndicesForEscapedChars formattedTweetText urlEntities u indices adjustIndicesForEscapedChars formattedTweetText mediaEntities u indices adjustIndicesForSupplementaryChars result formattedTweetText formattedTweetText text result toString static void adjustIndicesForEscapedChars List extends FormattedUrlEntity entities List int indices if entities null indices null indices isEmpty return final int size indices size int m 0 marker int diff 0 accumulated difference int inDiff end difference for escapes in range int len escaped length int start escaped start int end escaped end int i reusable index int index For each of the entities update the start and end indices Note tweet entities are sorted for FormattedUrlEntity entity entities inDiff 0 Go through the escaped entities indices for i m i size i index indices get i start index 0 end index 1 len is actually end start 1 1 len end start if end entity start bump position of the next marker diff len m else if end entity end inDiff len Once we ve accumulated diffs calc the offset entity start entity start diff entity end entity end diff inDiff static void adjustIndicesForSupplementaryChars StringBuilder content FormattedTweetText formattedTweetText final List Integer highSurrogateIndices new ArrayList final int len content length 1 for int i 0 i len i if Character isHighSurrogate content charAt i Character isLowSurrogate content charAt i 1 highSurrogateIndices add i adjustEntitiesWithOffsets formattedTweetText urlEntities highSurrogateIndices adjustEntitiesWithOffsets formattedTweetText mediaEntities highSurrogateIndices static void adjustEntitiesWithOffsets List extends FormattedUrlEntity entities List Integer indices if entities null indices null return for FormattedUrlEntity entity entities find all indices start and update offsets by that much final int start entity start int offset 0 for Integer index indices if index offset start offset 1 else break entity start entity start offset entity end entity end offsetpackage com twitter sdk android tweetui import android content Context import android view View import android view ViewGroup import com twitter sdk android core Callback import com twitter sdk android core Result import com twitter sdk android core TwitterException import com twitter sdk android core models Tweet import com twitter sdk android tweetui internal TimelineDelegate public class TweetTimelineListAdapter extends TimelineListAdapter Tweet protected Callback Tweet actionCallback final protected int styleResId public TweetTimelineListAdapter Context context Timeline Tweet timeline this context timeline R style tw TweetLightStyle null TweetTimelineListAdapter Context context Timeline Tweet timeline int styleResId Callback Tweet cb this context new TimelineDelegate timeline styleResId cb TweetTimelineListAdapter Context context TimelineDelegate Tweet delegate int styleResId Callback Tweet cb super context delegate this styleResId styleResId this actionCallback new ReplaceTweetCallback delegate cb Override public View getView int position View convertView ViewGroup parent View rowView convertView final Tweet tweet getItem position if rowView null final BaseTweetView tv new CompactTweetView context tweet styleResId tv setOnActionCallback actionCallback rowView tv else BaseTweetView rowView setTweet tweet return rowView static class ReplaceTweetCallback extends Callback Tweet TimelineDelegate Tweet delegate Callback Tweet cb ReplaceTweetCallback TimelineDelegate Tweet delegate Callback Tweet cb this delegate delegate this cb cb Override public void success Result Tweet result delegate setItemById result data if cb null cb success result Override public void failure TwitterException exception if cb null cb failure exception public static class Builder private Context context private Timeline Tweet timeline private Callback Tweet actionCallback private int styleResId R style tw TweetLightStyle public Builder Context context this context context public Builder setTimeline Timeline Tweet timeline this timeline timeline return this public Builder setViewStyle int styleResId this styleResId styleResId return this public Builder setOnActionCallback Callback Tweet actionCallback this actionCallback actionCallback return this public TweetTimelineListAdapter build return new TweetTimelineListAdapter context timeline styleResId actionCallbackpackage com twitter sdk android tweetui import io fabric sdk android Fabric import io fabric sdk android Kit import io fabric sdk android services concurrency DependsOn import com squareup picasso Picasso import com twitter sdk android core GuestSessionProvider import com twitter sdk android core SessionManager import com twitter sdk android core TwitterCore import com twitter sdk android core TwitterSession import com twitter sdk android core internal scribe DefaultScribeClient import com twitter sdk android core internal scribe EventNamespace import com twitter sdk android core internal scribe ScribeItem import java util List DependsOn TwitterCore class public class TweetUi extends Kit Boolean static final String LOGTAG TweetUi static final String NOT STARTED ERROR Must start TweetUi Kit in Fabric with private static final String KIT SCRIBE NAME TweetUi SessionManager TwitterSession sessionManager GuestSessionProvider guestSessionProvider DefaultScribeClient scribeClient private TweetRepository tweetRepository private Picasso imageLoader public static TweetUi getInstance checkInitialized return Fabric getKit TweetUi class Override public String getIdentifier return BuildConfig GROUP BuildConfig ARTIFACT ID Override public String getVersion return BuildConfig VERSION NAME BuildConfig BUILD NUMBER Override protected boolean onPreExecute super onPreExecute final TwitterCore twitterCore TwitterCore getInstance sessionManager twitterCore getSessionManager guestSessionProvider twitterCore getGuestSessionProvider tweetRepository new TweetRepository getFabric getMainHandler twitterCore getSessionManager return true Override protected Boolean doInBackground imageLoader Picasso with getContext setUpScribeClient return true private static void checkInitialized if Fabric getKit TweetUi class null throw new IllegalStateException NOT STARTED ERROR private void setUpScribeClient scribeClient new DefaultScribeClient this KIT SCRIBE NAME sessionManager guestSessionProvider getIdManager void scribe EventNamespace namespaces if scribeClient null return for EventNamespace ns namespaces scribeClient scribe ns void scribe EventNamespace ns List ScribeItem items if scribeClient null return scribeClient scribe ns items TweetRepository getTweetRepository return tweetRepository Testing purposes only void setTweetRepository TweetRepository tweetRepository this tweetRepository tweetRepository Picasso getImageLoader return imageLoader Testing purposes only void setImageLoader Picasso imageLoader this imageLoader imageLoaderpackage com twitter sdk android tweetcomposer import android app IntentService import android content Intent import android net Uri import com twitter sdk android core Callback import com twitter sdk android core Result import com twitter sdk android core TwitterAuthToken import com twitter sdk android core TwitterException import com twitter sdk android core TwitterSession import com twitter sdk android core models Media import com twitter sdk android core models Tweet import com twitter sdk android tweetcomposer internal CardCreate import com twitter sdk android tweetcomposer internal CardData import java io File import io fabric sdk android Fabric import okhttp3 MediaType import okhttp3 RequestBody public class TweetUploadService extends IntentService public static final String UPLOAD SUCCESS com twitter sdk android tweetcomposer UPLOAD SUCCESS public static final String UPLOAD FAILURE com twitter sdk android tweetcomposer UPLOAD FAILURE public static final String EXTRA TWEET ID EXTRA TWEET ID public static final String EXTRA RETRY INTENT EXTRA RETRY INTENT static final String TAG TweetUploadService static final String EXTRA USER TOKEN EXTRA USER TOKEN static final String EXTRA TWEET TEXT EXTRA TWEET TEXT static final String EXTRA TWEET CARD EXTRA TWEET CARD private static final int PLACEHOLDER ID 1 private static final String PLACEHOLDER SCREEN NAME DependencyProvider dependencyProvider TwitterSession twitterSession String tweetText Card tweetCard Intent intent public TweetUploadService this new DependencyProvider testing purposes TweetUploadService DependencyProvider dependencyProvider super TweetUploadService this dependencyProvider dependencyProvider Override protected void onHandleIntent Intent intent final TwitterAuthToken token intent getParcelableExtra EXTRA USER TOKEN this intent intent twitterSession new TwitterSession token PLACEHOLDER ID PLACEHOLDER SCREEN NAME tweetText intent getStringExtra EXTRA TWEET TEXT tweetCard Card intent getSerializableExtra EXTRA TWEET CARD if Card isAppCard tweetCard uploadAppCardTweet twitterSession tweetText tweetCard else uploadTweet twitterSession tweetText void uploadTweet TwitterSession session final String text final ComposerApiClient client dependencyProvider getComposerApiClient session client getComposerStatusesService update text null enqueue new Callback Tweet Override public void success Result Tweet result sendSuccessBroadcast result data getId stopSelf Override public void failure TwitterException exception fail exception void uploadAppCardTweet TwitterSession session final String text final Card card final ComposerApiClient client dependencyProvider getComposerApiClient session final Uri uri Uri parse card imageUri final String path FileUtils getPath TweetUploadService this uri if path null fail new TwitterException Uri file path resolved to null return final File file new File path final String mimeType FileUtils getMimeType file final RequestBody media RequestBody create MediaType parse mimeType file client getMediaService upload media null null enqueue new Callback Media Override public void success Result Media result final CardData cardData CardDataFactory createAppCardData card result data mediaId dependencyProvider getAdvertisingId client getCardService create cardData enqueue new Callback CardCreate Override public void success Result CardCreate result final String cardUri result data cardUri client getComposerStatusesService update text cardUri enqueue new Callback Tweet Override public void success Result Tweet result sendSuccessBroadcast result data getId stopSelf Override public void failure TwitterException exception fail exception Override public void failure TwitterException exception fail exception Override public void failure TwitterException exception fail exception void fail TwitterException e sendFailureBroadcast intent Fabric getLogger e TAG Post Tweet failed e stopSelf void sendSuccessBroadcast long tweetId final Intent intent new Intent UPLOAD SUCCESS intent putExtra EXTRA TWEET ID tweetId sendBroadcast intent void sendFailureBroadcast Intent original final Intent intent new Intent UPLOAD FAILURE intent putExtra EXTRA RETRY INTENT original sendBroadcast intent static class DependencyProvider ComposerApiClient getComposerApiClient TwitterSession session return TweetComposer getInstance getApiClient session String getAdvertisingId return TweetComposer getInstance getAdvertisingIdpackage com twitter sdk android tweetui import android net Uri import android text TextUtils import com twitter sdk android core Callback import com twitter sdk android core Result import com twitter sdk android core models Tweet import java util List import java util Locale import io fabric sdk android Fabric public final class TweetUtils private static final String PERMALINK FORMAT https twitter com s status d private static final String UNKNOWN SCREEN NAME twitter unknown static final String LOAD TWEET DEBUG loadTweet failure for Tweet Id d private TweetUtils public static void loadTweet final long tweetId final Callback Tweet cb TweetUi getInstance getTweetRepository loadTweet tweetId new com twitter sdk android tweetui LoggingCallback Tweet cb Fabric getLogger Override public void success Result Tweet result if cb null cb success result public static void loadTweets final List Long tweetIds final Callback List Tweet cb TweetUi getInstance getTweetRepository loadTweets tweetIds new com twitter sdk android tweetui LoggingCallback List Tweet cb Fabric getLogger Override public void success Result List Tweet result if cb null cb success result static boolean isTweetResolvable Tweet tweet return tweet null tweet id 0 tweet user null TextUtils isEmpty tweet user screenName static Tweet getDisplayTweet Tweet tweet if tweet null tweet retweetedStatus null return tweet else return tweet retweetedStatus static Uri getPermalink String screenName long tweetId if tweetId 0 return null String permalink if TextUtils isEmpty screenName permalink String format Locale US PERMALINK FORMAT UNKNOWN SCREEN NAME tweetId else permalink String format Locale US PERMALINK FORMAT screenName tweetId return Uri parse permalinkpackage com twitter sdk android tweetui import android content Context import android util AttributeSet import android widget ImageView import com twitter sdk android core models Tweet public class TweetView extends BaseTweetView private static final String VIEW TYPE NAME default public TweetView Context context Tweet tweet super context tweet public TweetView Context context Tweet tweet int styleResId super context tweet styleResId TweetView Context context Tweet tweet int styleResId DependencyProvider dependencyProvider super context tweet styleResId dependencyProvider public TweetView Context context AttributeSet attrs super context attrs public TweetView Context context AttributeSet attrs int defStyle super context attrs defStyle Override protected int getLayout return R layout tw tweet Override void render super render setVerifiedCheck tweet private void setVerifiedCheck Tweet tweet if tweet null tweet user null tweet user verified verifiedCheckView setVisibility ImageView VISIBLE else verifiedCheckView setVisibility ImageView GONE Override String getViewTypeName return VIEW TYPE NAMEpackage com twitter sdk android import android app Activity import com twitter sdk android core Callback import com twitter sdk android core SessionManager import com twitter sdk android core TwitterApiClient import com twitter sdk android core TwitterSession import com twitter sdk android tweetcomposer TweetComposer import io fabric sdk android Fabric import io fabric sdk android Kit import com twitter sdk android core TwitterCore import com twitter sdk android core TwitterAuthConfig import com twitter sdk android tweetui TweetUi import io fabric sdk android KitGroup import java util Arrays import java util Collection import java util Collections public class Twitter extends Kit implements KitGroup public final TwitterCore core public final TweetUi tweetUi public final TweetComposer tweetComposer public final Collection extends Kit kits public static Twitter getInstance return Fabric getKit Twitter class private static void checkInitialized if getInstance null throw new IllegalStateException Must start Twitter Kit with Fabric with first public Twitter TwitterAuthConfig config core new TwitterCore config tweetUi new TweetUi tweetComposer new TweetComposer kits Collections unmodifiableCollection Arrays asList core tweetUi tweetComposer Override public String getVersion return BuildConfig VERSION NAME BuildConfig BUILD NUMBER Override public String getIdentifier return BuildConfig GROUP BuildConfig ARTIFACT ID Override public Collection extends Kit getKits return kits Override protected Object doInBackground Nothing to do return null public static void logIn Activity activity Callback TwitterSession callback checkInitialized getInstance core logIn activity callback public static void logOut checkInitialized getInstance core logOut public static SessionManager TwitterSession getSessionManager checkInitialized return getInstance core getSessionManager public static TwitterApiClient getApiClient checkInitialized return getInstance core getApiClient public static TwitterApiClient getApiClient TwitterSession session checkInitialized return getInstance core getApiClient sessionpackage com twitter sdk android core internal import android net Uri import android os Build public class TwitterApi public static final String BASE HOST api twitter com public static final String BASE HOST URL https BASE HOST private final String baseHostUrl public TwitterApi this BASE HOST URL public TwitterApi String baseHostUrl this baseHostUrl baseHostUrl public String getBaseHostUrl return baseHostUrl public Uri Builder buildUponBaseHostUrl String paths final Uri Builder builder Uri parse getBaseHostUrl buildUpon if paths null for String p paths builder appendPath p return builder public static String buildUserAgent String clientName String version final StringBuilder ua new StringBuilder clientName append append version NOTE We currently do not provide client version code information append append Build MODEL append append Build VERSION RELEASE append append Build MANUFACTURER append append Build MODEL append append Build BRAND append append Build PRODUCT NOTE We do not add client source preload or wifi information append return ua toStringpackage com twitter sdk android core import com twitter sdk android core internal TwitterApi import com twitter sdk android core internal network OkHttpClientHelper import com twitter sdk android core models BindingValues import com twitter sdk android core models BindingValuesAdapter import com twitter sdk android core models SafeListAdapter import com twitter sdk android core models SafeMapAdapter import com twitter sdk android core services AccountService import com twitter sdk android core services CollectionService import com twitter sdk android core services ConfigurationService import com twitter sdk android core services FavoriteService import com twitter sdk android core services ListService import com twitter sdk android core services MediaService import com twitter sdk android core services SearchService import com twitter sdk android core services StatusesService import com google gson Gson import com google gson GsonBuilder import java util concurrent ConcurrentHashMap import okhttp3 OkHttpClient import retrofit2 Retrofit import retrofit2 converter gson GsonConverterFactory public class TwitterApiClient final ConcurrentHashMap Class Object services final Retrofit retrofit TwitterApiClient OkHttpClient client TwitterApi twitterApi this services new ConcurrentHashMap final Gson gson new GsonBuilder registerTypeAdapterFactory new SafeListAdapter registerTypeAdapterFactory new SafeMapAdapter registerTypeAdapter BindingValues class new BindingValuesAdapter create retrofit new Retrofit Builder client client baseUrl twitterApi getBaseHostUrl addConverterFactory GsonConverterFactory create gson build public TwitterApiClient TwitterSession session this OkHttpClientHelper getOkHttpClient session TwitterCore getInstance getAuthConfig TwitterCore getInstance getSSLSocketFactory new TwitterApi public TwitterApiClient this OkHttpClientHelper getOkHttpClient TwitterCore getInstance getGuestSessionProvider TwitterCore getInstance getSSLSocketFactory new TwitterApi public AccountService getAccountService return getService AccountService class public FavoriteService getFavoriteService return getService FavoriteService class public StatusesService getStatusesService return getService StatusesService class public SearchService getSearchService return getService SearchService class public ListService getListService return getService ListService class public CollectionService getCollectionService return getService CollectionService class public ConfigurationService getConfigurationService return getService ConfigurationService class public MediaService getMediaService return getService MediaService class SuppressWarnings unchecked protected T T getService Class T cls if services contains cls services putIfAbsent cls retrofit create cls return T services get clspackage com twitter sdk android core import io fabric sdk android FabricAndroidTestCase import io fabric sdk android FabricTestUtils import okhttp3 OkHttpClient import com twitter sdk android core internal TwitterApi import com twitter sdk android core services FavoriteService import com twitter sdk android core services StatusesService import static org mockito Mockito mock public class TwitterApiClientTest extends FabricAndroidTestCase public void testGetService sdkNotStarted try FabricTestUtils resetFabric new TwitterApiClient mock TwitterSession class fail catch IllegalStateException ise assertEquals Must Initialize Fabric before using singleton ise getMessage public void testConstructor noSession throws Exception try final TwitterCore twitterCore TwitterCoreTestUtils createTwitterCore new TwitterAuthConfig null null FabricTestUtils with getContext twitterCore new TwitterApiClient null fail catch IllegalArgumentException ie assertEquals Session must not be null ie getMessage finally FabricTestUtils resetFabric public void testGetService cachedService throws Exception final TwitterApiClient client newTwitterApiClient final StatusesService service client getService StatusesService class assertSame service client getService StatusesService class public void testGetService differentServices throws Exception final TwitterApiClient client newTwitterApiClient final FavoriteService service client getService FavoriteService class assertNotSame service client getService StatusesService class private TwitterApiClient newTwitterApiClient return new TwitterApiClient mock OkHttpClient class new TwitterApipackage com twitter sdk android core internal public class TwitterApiConstants public static final int MAX TWEET CHARS 140 public static class Base public static final String PARAM ID id public static final String FIELD ID id public static class Errors extends Base public static final String ERRORS errors error when app auth token not recognized such as when expired public static final int APP AUTH ERROR CODE 89 error when a tweet has already been favorited public static final int ALREADY FAVORITED 139 error when a tweet has already been unfavorited public static final int ALREADY UNFAVORITED 144 error when guest auth token not recognized such as when expired public static final int GUEST AUTH ERROR CODE 239 legacy errors are errors that are returned by the api in a different format where there is no array of errors public static final int LEGACY ERROR 0package com twitter sdk android core public class TwitterApiErrorConstants phone normalization errors public static final int DEVICE REGISTRATION INVALID INPUT 44 public static final int REGISTRATION INVALID INPUT 300 public static final int REGISTRATION PHONE NORMALIZATION FAILED 303 device already registered by other user public static final int DEVICE ALREADY REGISTERED 285 rate limit for sms exceeded public static final int RATE LIMIT EXCEEDED 88 registration general error public static final int REGISTRATION GENERAL ERROR 284 public static final int REGISTRATION OPERATION FAILED 302 spammer phone number public static final int SPAMMER 240 public static final int COULD NOT AUTHENTICATE 32 public static final int CLIENT NOT PRIVILEGED 87 public static final int UNKNOWN ERROR 1 Unrecoverable errors public static final int OPERATOR UNSUPPORTED 286 public static final int USER IS NOT SDK USER 269 public static final int EXPIRED LOGIN VERIFICATION REQUEST 235 public static final int MISSING LOGIN VERIFICATION REQUEST 237 public static final int DEVICE REGISTRATION RATE EXCEEDED 299 public static final int PAGE NOT EXIST 34 public static final int EMAIL ALREADY REGISTERED 120package com twitter sdk android core import android text TextUtils import com google gson Gson import com google gson JsonSyntaxException import com twitter sdk android core models ApiError import com twitter sdk android core models ApiErrors import io fabric sdk android Fabric import retrofit2 Response public class TwitterApiException extends TwitterException public static final int DEFAULT ERROR CODE 0 private final ApiError apiError private final TwitterRateLimit twitterRateLimit private final int code private final Response response public TwitterApiException Response response this response readApiError response readApiRateLimit response response code TwitterApiException Response response ApiError apiError TwitterRateLimit twitterRateLimit int code super createExceptionMessage code this apiError apiError this twitterRateLimit twitterRateLimit this code code this response response public int getStatusCode return code public int getErrorCode return apiError null DEFAULT ERROR CODE apiError code public String getErrorMessage return apiError null null apiError message public TwitterRateLimit getTwitterRateLimit return twitterRateLimit public Response getResponse return response public static TwitterRateLimit readApiRateLimit Response response return new TwitterRateLimit response headers public static ApiError readApiError Response response try The response buffer can only be read once so we clone the underlying buffer so the response can be consumed down stream if necessary final String body response errorBody source buffer clone readUtf8 if TextUtils isEmpty body return parseApiError body catch Exception e Fabric getLogger e TwitterCore TAG Unexpected response e return null static ApiError parseApiError String body final Gson gson new Gson try final ApiErrors apiErrors gson fromJson body ApiErrors class if apiErrors errors isEmpty return apiErrors errors get 0 catch JsonSyntaxException e Fabric getLogger e TwitterCore TAG Invalid json body e return null static String createExceptionMessage int code return HTTP request failed Status codepackage com twitter sdk android core identity import android app Activity import android content Context import android content Intent import io fabric sdk android Fabric import com twitter sdk android core Callback import com twitter sdk android core Result import com twitter sdk android core SessionManager import com twitter sdk android core TwitterAuthException import com twitter sdk android core TwitterCore import com twitter sdk android core TwitterAuthConfig import com twitter sdk android core TwitterException import com twitter sdk android core TwitterSession import com twitter sdk android core internal scribe DefaultScribeClient import com twitter sdk android core internal scribe EventNamespace import com twitter sdk android core internal scribe TwitterCoreScribeClientHolder public class TwitterAuthClient private static class AuthStateLazyHolder private static final AuthState INSTANCE new AuthState private static final String SCRIBE CLIENT android private static final String SCRIBE LOGIN PAGE login private static final String SCRIBE SHARE EMAIL PAGE shareemail private static final String SCRIBE SECTION intentionally blank private static final String SCRIBE COMPONENT intentionally blank private static final String SCRIBE ELEMENT intentionally blank private static final String SCRIBE ACTION impression final AuthState authState final SessionManager TwitterSession sessionManager private final Context context private final TwitterAuthConfig authConfig public int getRequestCode return authConfig getRequestCode public TwitterAuthClient this TwitterCore getInstance getContext TwitterCore getInstance getAuthConfig TwitterCore getInstance getSessionManager AuthStateLazyHolder INSTANCE TwitterAuthClient Context context TwitterAuthConfig authConfig SessionManager TwitterSession sessionManager AuthState authState this authState authState this context context this authConfig authConfig this sessionManager sessionManager public void authorize Activity activity Callback TwitterSession callback if activity null throw new IllegalArgumentException Activity must not be null if callback null throw new IllegalArgumentException Callback must not be null if activity isFinishing Fabric getLogger e TwitterCore TAG Cannot authorize activity is finishing null else handleAuthorize activity callback private void handleAuthorize Activity activity Callback TwitterSession callback scribeAuthorizeImpression final CallbackWrapper callbackWrapper new CallbackWrapper sessionManager callback if authorizeUsingSSO activity callbackWrapper authorizeUsingOAuth activity callbackWrapper callbackWrapper failure new TwitterAuthException Authorize failed private boolean authorizeUsingSSO Activity activity CallbackWrapper callbackWrapper if SSOAuthHandler isAvailable activity Fabric getLogger d TwitterCore TAG Using SSO return authState beginAuthorize activity new SSOAuthHandler authConfig callbackWrapper authConfig getRequestCode else return false private boolean authorizeUsingOAuth Activity activity CallbackWrapper callbackWrapper Fabric getLogger d TwitterCore TAG Using OAuth return authState beginAuthorize activity new OAuthHandler authConfig callbackWrapper authConfig getRequestCode private void scribeAuthorizeImpression final DefaultScribeClient scribeClient getScribeClient if scribeClient null return final EventNamespace ns new EventNamespace Builder setClient SCRIBE CLIENT setPage SCRIBE LOGIN PAGE setSection SCRIBE SECTION setComponent SCRIBE COMPONENT setElement SCRIBE ELEMENT setAction SCRIBE ACTION builder scribeClient scribe ns public void onActivityResult int requestCode int resultCode Intent data Fabric getLogger d TwitterCore TAG onActivityResult called with requestCode resultCode if authState isAuthorizeInProgress Fabric getLogger e TwitterCore TAG Authorize not in progress null else final AuthHandler authHandler authState getAuthHandler if authHandler null authHandler handleOnActivityResult requestCode resultCode data authState endAuthorize public void requestEmail TwitterSession session Callback String callback if session null throw new IllegalArgumentException Session must not be null if callback null throw new IllegalArgumentException Callback must not be null scribeRequestEmail context startActivity newShareEmailIntent session callback protected DefaultScribeClient getScribeClient return TwitterCoreScribeClientHolder getScribeClient private void scribeRequestEmail final DefaultScribeClient scribeClient getScribeClient if scribeClient null return final EventNamespace ns new EventNamespace Builder setClient SCRIBE CLIENT setPage SCRIBE SHARE EMAIL PAGE setSection SCRIBE SECTION setComponent SCRIBE COMPONENT setElement SCRIBE ELEMENT setAction SCRIBE ACTION builder scribeClient scribe ns Intent newShareEmailIntent TwitterSession session Callback String callback return new Intent context ShareEmailActivity class setFlags Intent FLAG ACTIVITY NEW TASK putExtra ShareEmailActivity EXTRA SESSION ID session getId putExtra ShareEmailActivity EXTRA RESULT RECEIVER new ShareEmailResultReceiver callback static class CallbackWrapper extends Callback TwitterSession private final SessionManager TwitterSession sessionManager private final Callback TwitterSession callback public CallbackWrapper SessionManager TwitterSession sessionManager Callback TwitterSession callback this sessionManager sessionManager this callback callback Override public void success Result TwitterSession result Fabric getLogger d TwitterCore TAG Authorization completed successfully sessionManager setActiveSession result data callback success result Override public void failure TwitterException exception Fabric getLogger e TwitterCore TAG Authorization completed with an error exception callback failure exceptionpackage com twitter sdk android core identity import android app Activity import android content ComponentName import android content Context import android content Intent import android content pm PackageManager import io fabric sdk android FabricAndroidTestCase import io fabric sdk android FabricTestUtils import io fabric sdk android KitStub import com twitter sdk android core Callback import com twitter sdk android core Result import com twitter sdk android core SessionManager import com twitter sdk android core TestFixtures import com twitter sdk android core TwitterAuthConfig import com twitter sdk android core TwitterAuthException import com twitter sdk android core TwitterSession import com twitter sdk android core internal scribe DefaultScribeClient import com twitter sdk android core internal scribe EventNamespace import org mockito ArgumentCaptor import static org mockito Mockito public class TwitterAuthClientTest extends FabricAndroidTestCase private static final int TEST REQUEST CODE 100 private Context mockContext private TwitterAuthConfig mockAuthConfig private SessionManager TwitterSession mockSessionManager private AuthState mockAuthState private Callback TwitterSession mockCallback private DefaultScribeClient mockScribeClient private TwitterAuthClient authClient Override protected void setUp throws Exception super setUp mockContext mock Context class when mockContext getPackageName thenReturn getClass getPackage toString mockAuthConfig mock TwitterAuthConfig class when mockAuthConfig getRequestCode thenReturn TEST REQUEST CODE mockSessionManager mock SessionManager class mockAuthState mock TestAuthState class mockCallback mock Callback class mockScribeClient mock DefaultScribeClient class authClient new TwitterAuthClient mockContext mockAuthConfig mockSessionManager mockAuthState public void testConstructor noParameters throws Exception FabricTestUtils with getContext new KitStub try new TwitterAuthClient fail Expected IllegalStateException to be thrown catch IllegalStateException e assertEquals Must start Twitter Kit with Fabric with first e getMessage finally FabricTestUtils resetFabric public void testGetRequestCode assertEquals TEST REQUEST CODE authClient getRequestCode public void testAuthorize activityNull try authClient authorize null mock Callback class fail Expected IllegalArgumentException to be thrown catch IllegalArgumentException e assertEquals Activity must not be null e getMessage public void testAuthorize activityIsFinishing final Activity mockActivity mock Activity class when mockActivity isFinishing thenReturn true Verify that when activity is finishing no further work is done authClient authorize mockActivity mockCallback verifyZeroInteractions mockAuthState public void testAuthorize callbackNull try authClient authorize mock Activity class null fail Expected IllegalArgumentException to be thrown catch IllegalArgumentException e assertEquals Callback must not be null e getMessage public void testAuthorize authorizeInProgress throws PackageManager NameNotFoundException final Activity mockActivity mock Activity class TestUtils setupNoSSOAppInstalled mockActivity when mockAuthState isAuthorizeInProgress thenReturn true Verify that when authorize is in progress callback is notified of error authClient authorize mockActivity mockCallback verify mockCallback failure any TwitterAuthException class public void testAuthorize ssoAvailable throws PackageManager NameNotFoundException final Activity mockActivity mock Activity class TestUtils setupTwitterInstalled mockActivity when mockAuthState beginAuthorize any Activity class any AuthHandler class thenReturn true Verify that when SSO is available SSOAuthHandler is used to complete the authorization flow authClient authorize mockActivity mockCallback verify mockAuthState beginAuthorize eq mockActivity any SSOAuthHandler class public void testAuthorize ssoAvailableViaTwitterDogfood throws PackageManager NameNotFoundException final Activity mockActivity mock Activity class TestUtils setupTwitterInstalled mockActivity when mockAuthState beginAuthorize any Activity class any AuthHandler class thenReturn true Verify that when SSO is available SSOAuthHandler is used to complete the authorization flow authClient authorize mockActivity mockCallback verify mockAuthState beginAuthorize eq mockActivity any SSOAuthHandler class public void testAuthorize ssoNotAvailable throws PackageManager NameNotFoundException final Activity mockActivity mock Activity class TestUtils setupNoSSOAppInstalled mockActivity when mockAuthState beginAuthorize any Activity class any AuthHandler class thenReturn true Verify that when SSO is not available OAuthHandler is used to complete the authorization flow authClient authorize mockActivity mockCallback verify mockAuthState beginAuthorize eq mockActivity any OAuthHandler class public void testAuthorize bothSsoAndOAuthFail throws PackageManager NameNotFoundException final Activity mockActivity mock Activity class TestUtils setupTwitterInstalled mockActivity when mockAuthState beginAuthorize any Activity class any AuthHandler class thenReturn false authClient authorize mockActivity mockCallback verify mockAuthState times 2 beginAuthorize eq mockActivity any AuthHandler class final ArgumentCaptor TwitterAuthException argCaptor ArgumentCaptor forClass TwitterAuthException class verify mockCallback failure argCaptor capture assertEquals Authorize failed argCaptor getValue getMessage public void testAuthorize scribesImpression throws PackageManager NameNotFoundException final Activity mockActivity mock Activity class TestUtils setupNoSSOAppInstalled mockActivity authClient new TwitterAuthClient mockContext mockAuthConfig mockSessionManager mockAuthState Override protected DefaultScribeClient getScribeClient return mockScribeClient authClient authorize mockActivity mockCallback verify mockScribeClient scribe any EventNamespace class public void testAuthorize scribeHandlesNullClient throws PackageManager NameNotFoundException final Activity mockActivity mock Activity class TestUtils setupNoSSOAppInstalled mockActivity authClient new TwitterAuthClient mockContext mockAuthConfig mockSessionManager mockAuthState Override protected DefaultScribeClient getScribeClient return null try authClient authorize mockActivity mockCallback catch NullPointerException e fail should not crash with null scribe client public void testOnActivityResult noAuthorizeInProgress when mockAuthState isAuthorizeInProgress thenReturn false Verify that if authorize is in progress onActivityResult returns early authClient onActivityResult TEST REQUEST CODE Activity RESULT OK mock Intent class verify mockAuthState isAuthorizeInProgress verifyNoMoreInteractions mockAuthState public void testOnActivityResult handleOnActivityResultTrue setUpAuthStateOnActivityResult true Verify that when the activity result is handled auth state is updated to end authClient onActivityResult TEST REQUEST CODE Activity RESULT OK mock Intent class verify mockAuthState isAuthorizeInProgress verify mockAuthState getAuthHandler verify mockAuthState endAuthorize public void testOnActivityResult handleOnActivityResultFalse setUpAuthStateOnActivityResult false Verify that when the activity result is not handled auth state is not updated to end authClient onActivityResult TEST REQUEST CODE Activity RESULT OK mock Intent class verify mockAuthState isAuthorizeInProgress verify mockAuthState getAuthHandler verifyNoMoreInteractions mockAuthState private void setUpAuthStateOnActivityResult boolean handled final AuthHandler mockAuthHandler mock AuthHandler class when mockAuthHandler handleOnActivityResult anyInt anyInt any Intent class thenReturn handled when mockAuthState isAuthorizeInProgress thenReturn true when mockAuthState getAuthHandler thenReturn mockAuthHandler public void testRequestEmail nullSession try authClient requestEmail null mock Callback class fail Expected IllegalArgumentException to be thrown catch IllegalArgumentException e assertEquals Session must not be null e getMessage public void testRequestEmail final TwitterSession mockSession mock TwitterSession class when mockSession getId thenReturn TestFixtures USER ID authClient requestEmail mockSession mock Callback class final ArgumentCaptor Intent argCaptor ArgumentCaptor forClass Intent class verify mockContext startActivity argCaptor capture assertShareEmailIntent argCaptor getValue public void testRequestEmail nullCallback try authClient requestEmail mock TwitterSession class null fail Expected IllegalArgumentException to be thrown catch IllegalArgumentException e assertEquals Callback must not be null e getMessage public void testRequestEmail scribesImpression final TwitterSession mockSession mock TwitterSession class when mockSession getId thenReturn TestFixtures USER ID authClient new TwitterAuthClient mockContext mockAuthConfig mockSessionManager mockAuthState Override protected DefaultScribeClient getScribeClient return mockScribeClient authClient requestEmail mockSession mock Callback class verify mockScribeClient scribe any EventNamespace class public void testReqestEmail scribeHandlesNullClient final TwitterSession mockSession mock TwitterSession class when mockSession getId thenReturn TestFixtures USER ID authClient new TwitterAuthClient mockContext mockAuthConfig mockSessionManager mockAuthState Override protected DefaultScribeClient getScribeClient return null try authClient requestEmail mockSession mock Callback class catch NullPointerException e fail should handle null scribe client public void testNewShareEmailIntent final TwitterSession mockSession mock TwitterSession class when mockSession getId thenReturn TestFixtures USER ID final Intent intent authClient newShareEmailIntent mockSession mock Callback class assertShareEmailIntent intent private void assertShareEmailIntent Intent intent final ComponentName component new ComponentName mockContext ShareEmailActivity class getName assertEquals component intent getComponent assertEquals Intent FLAG ACTIVITY NEW TASK intent getFlags assertEquals TestFixtures USER ID intent getLongExtra ShareEmailActivity EXTRA SESSION ID TwitterSession UNKNOWN USER ID assertNotNull intent getParcelableExtra ShareEmailActivity EXTRA RESULT RECEIVER public void testCallbackWrapper success final TwitterAuthClient CallbackWrapper callbackWrapper new TwitterAuthClient CallbackWrapper mockSessionManager mockCallback final TwitterSession mockSession mock TwitterSession class final Result TwitterSession mockResult new Result mockSession null callbackWrapper success mockResult verify mockSessionManager setActiveSession eq mockSession verify mockCallback success eq mockResult public void testCallbackWrapper failure final TwitterAuthClient CallbackWrapper callbackWrapper new TwitterAuthClient CallbackWrapper mockSessionManager mockCallback final TwitterAuthException mockException mock TwitterAuthException class callbackWrapper failure mockException verifyZeroInteractions mockSessionManager verify mockCallback failure eq mockExceptionpackage com twitter sdk android core import android os Parcel import android os Parcelable public class TwitterAuthConfig implements Parcelable public static final int DEFAULT AUTH REQUEST CODE 140 public static final Parcelable Creator TwitterAuthConfig CREATOR new Parcelable Creator TwitterAuthConfig public TwitterAuthConfig createFromParcel Parcel in return new TwitterAuthConfig in public TwitterAuthConfig newArray int size return new TwitterAuthConfig size private final String consumerKey private final String consumerSecret public TwitterAuthConfig String consumerKey String consumerSecret if consumerKey null consumerSecret null throw new IllegalArgumentException TwitterAuthConfig must not be created with null consumer key or secret this consumerKey sanitizeAttribute consumerKey this consumerSecret sanitizeAttribute consumerSecret private TwitterAuthConfig Parcel in consumerKey in readString consumerSecret in readString public String getConsumerKey return consumerKey public String getConsumerSecret return consumerSecret public int getRequestCode return DEFAULT AUTH REQUEST CODE static String sanitizeAttribute String input if input null return input trim else return null Override public int describeContents return 0 Override public void writeToParcel Parcel out int flags out writeString consumerKey out writeString consumerSecretpackage com twitter sdk android core import android os Parcel import io fabric sdk android FabricAndroidTestCase public class TwitterAuthConfigTest extends FabricAndroidTestCase private static final String NO PARAM ERROR MSG TwitterAuthConfig must not be created with null consumer key or secret private TwitterAuthConfig authConfig Override protected void setUp throws Exception super setUp authConfig new TwitterAuthConfig TestFixtures KEY TestFixtures SECRET public void testParcelable final Parcel parcel Parcel obtain authConfig writeToParcel parcel 0 parcel setDataPosition 0 final TwitterAuthConfig parceledAuthConfig TwitterAuthConfig CREATOR createFromParcel parcel assertEquals TestFixtures KEY parceledAuthConfig getConsumerKey assertEquals TestFixtures SECRET parceledAuthConfig getConsumerSecret public void testGetRequestCode assertEquals TwitterAuthConfig DEFAULT AUTH REQUEST CODE authConfig getRequestCode public void testSanitizeAttribute nullAttribute assertNull TwitterAuthConfig sanitizeAttribute null public void testSanitizeAttribute sanitizedString final String test test assertEquals test TwitterAuthConfig sanitizeAttribute test public void testSanitizeAttribute trailingWhitespace final String test test assertEquals test TwitterAuthConfig sanitizeAttribute test public void testConstructor nullKey try new TwitterAuthConfig null secret fail catch IllegalArgumentException ie assertEquals NO PARAM ERROR MSG ie getMessage public void testConstructor nullSecret try new TwitterAuthConfig key null fail catch IllegalArgumentException ie assertEquals NO PARAM ERROR MSG ie getMessage public void testConstructor nullArguments try new TwitterAuthConfig null null fail catch IllegalArgumentException ie assertEquals NO PARAM ERROR MSG ie getMessagepackage com twitter sdk android core public class TwitterAuthException extends TwitterException private static final long serialVersionUID 577033016879783994L public TwitterAuthException String detailMessage super detailMessage public TwitterAuthException String detailMessage Throwable throwable super detailMessage throwablepackage com twitter sdk android core import android os Parcel import android os Parcelable import com google gson annotations SerializedName public class TwitterAuthToken extends AuthToken implements Parcelable public static final Parcelable Creator TwitterAuthToken CREATOR new Parcelable Creator TwitterAuthToken public TwitterAuthToken createFromParcel Parcel in return new TwitterAuthToken in public TwitterAuthToken newArray int size return new TwitterAuthToken size SerializedName token public final String token SerializedName secret public final String secret public TwitterAuthToken String token String secret super this token token this secret secret for testing purposes TwitterAuthToken String token String secret long createdAt super createdAt this token token this secret secret private TwitterAuthToken Parcel in super this token in readString this secret in readString Override public boolean isExpired Twitter does not expire OAuth1a tokens return false Override public String toString final StringBuilder sb new StringBuilder append token append this token append secret append this secret return sb toString Override public int describeContents return 0 Override public void writeToParcel Parcel out int flags out writeString token out writeString secret Override public boolean equals Object o if this o return true if o instanceof TwitterAuthToken return false final TwitterAuthToken that TwitterAuthToken o if secret null secret equals that secret that secret null return false if token null token equals that token that token null return false return true Override public int hashCode int result token null token hashCode 0 result 31 result secret null secret hashCode 0 return resultpackage com twitter sdk android core internal import com google gson annotations SerializedName import com twitter sdk android core models Tweet import com twitter sdk android core models User import java util List import java util Map public class TwitterCollection public TwitterCollection Content contents Metadata metadata this contents contents this metadata metadata SerializedName objects public final Content contents SerializedName response public final Metadata metadata public static final class Content SerializedName tweets public final Map Long Tweet tweetMap SerializedName users public final Map Long User userMap public Content Map Long Tweet tweetMap Map Long User userMap this tweetMap tweetMap this userMap userMap public static final class Metadata public Metadata String timelineId Position position List TimelineItem timelines this timelineId timelineId this position position this timelineItems timelines SerializedName timeline id public final String timelineId SerializedName position public final Position position SerializedName timeline public final List TimelineItem timelineItems public static final class Position SerializedName min position public final Long minPosition SerializedName max position public final Long maxPosition public Position Long maxPosition Long minPosition this maxPosition maxPosition this minPosition minPosition public static class TimelineItem public TimelineItem TweetItem tweetItem this tweetItem tweetItem SerializedName tweet public final TweetItem tweetItem public static final class TweetItem public TweetItem Long id this id id SerializedName id public final Long idpackage com twitter sdk android core import android app Activity import io fabric sdk android Fabric import io fabric sdk android Kit import io fabric sdk android services network NetworkUtils import io fabric sdk android services persistence PreferenceStoreImpl import com twitter sdk android core identity TwitterAuthClient import com twitter sdk android core internal MigrationHelper import com twitter sdk android core internal SessionMonitor import com twitter sdk android core internal TwitterApi import com twitter sdk android core internal TwitterSessionVerifier import com twitter sdk android core internal oauth OAuth2Service import com twitter sdk android core internal scribe TwitterCoreScribeClientHolder import java util concurrent ConcurrentHashMap import javax net ssl SSLSocketFactory public class TwitterCore extends Kit Boolean public static final String TAG Twitter static final String PREF KEY ACTIVE TWITTER SESSION active twittersession static final String PREF KEY TWITTER SESSION twittersession static final String PREF KEY ACTIVE GUEST SESSION active guestsession static final String PREF KEY GUEST SESSION guestsession static final String SESSION PREF FILE NAME session store SessionManager TwitterSession twitterSessionManager SessionManager GuestSession guestSessionManager SessionMonitor TwitterSession sessionMonitor private final TwitterAuthConfig authConfig private final ConcurrentHashMap Session TwitterApiClient apiClients private volatile TwitterApiClient guestClient private volatile GuestSessionProvider guestSessionProvider private volatile SSLSocketFactory sslSocketFactory public TwitterCore TwitterAuthConfig authConfig this authConfig new ConcurrentHashMap Session TwitterApiClient null Testing only TwitterCore TwitterAuthConfig authConfig ConcurrentHashMap Session TwitterApiClient apiClients TwitterApiClient guestClient this authConfig authConfig this apiClients apiClients this guestClient guestClient public static TwitterCore getInstance checkInitialized return Fabric getKit TwitterCore class Override public String getVersion return BuildConfig VERSION NAME BuildConfig BUILD NUMBER public TwitterAuthConfig getAuthConfig return authConfig public SSLSocketFactory getSSLSocketFactory checkInitialized if sslSocketFactory null createSSLSocketFactory return sslSocketFactory private synchronized void createSSLSocketFactory if sslSocketFactory null try sslSocketFactory NetworkUtils getSSLSocketFactory new TwitterPinningInfoProvider getContext Fabric getLogger d TAG Custom SSL pinning enabled catch Exception e Fabric getLogger e TAG Exception setting up custom SSL pinning e Override protected boolean onPreExecute final MigrationHelper migrationHelper new MigrationHelper migrationHelper migrateSessionStore getContext getIdentifier getIdentifier SESSION PREF FILE NAME xml twitterSessionManager new PersistedSessionManager new PreferenceStoreImpl getContext SESSION PREF FILE NAME new TwitterSession Serializer PREF KEY ACTIVE TWITTER SESSION PREF KEY TWITTER SESSION guestSessionManager new PersistedSessionManager new PreferenceStoreImpl getContext SESSION PREF FILE NAME new GuestSession Serializer PREF KEY ACTIVE GUEST SESSION PREF KEY GUEST SESSION sessionMonitor new SessionMonitor twitterSessionManager getFabric getExecutorService new TwitterSessionVerifier return true Override protected Boolean doInBackground Trigger restoration of session twitterSessionManager getActiveSession guestSessionManager getActiveSession getSSLSocketFactory getGuestSessionProvider initializeScribeClient Monitor activity lifecycle after sessions have been restored Otherwise we would not have any sessions to monitor anyways sessionMonitor monitorActivityLifecycle getFabric getActivityLifecycleManager return true Override public String getIdentifier return BuildConfig GROUP BuildConfig ARTIFACT ID private static void checkInitialized if Fabric getKit TwitterCore class null throw new IllegalStateException Must start Twitter Kit with Fabric with first private void initializeScribeClient TwitterCoreScribeClientHolder initialize this getSessionManager getGuestSessionProvider getIdManager public void logIn Activity activity Callback TwitterSession callback checkInitialized new TwitterAuthClient authorize activity callback public void logOut checkInitialized final SessionManager TwitterSession sessionManager getSessionManager if sessionManager null sessionManager clearActiveSession public SessionManager TwitterSession getSessionManager checkInitialized return twitterSessionManager public GuestSessionProvider getGuestSessionProvider checkInitialized if guestSessionProvider null createGuestSessionProvider return guestSessionProvider private synchronized void createGuestSessionProvider if guestSessionProvider null final OAuth2Service service new OAuth2Service this getSSLSocketFactory new TwitterApi guestSessionProvider new GuestSessionProvider service guestSessionManager public TwitterApiClient getApiClient checkInitialized final TwitterSession session twitterSessionManager getActiveSession if session null return getGuestApiClient return getApiClient session public TwitterApiClient getApiClient TwitterSession session checkInitialized if apiClients containsKey session apiClients putIfAbsent session new TwitterApiClient session return apiClients get session public TwitterApiClient getGuestApiClient checkInitialized if guestClient null createGuestClient return guestClient private synchronized void createGuestClient if guestClient null guestClient new TwitterApiClientpackage com twitter sdk android core internal scribe import com twitter sdk android core GuestSessionProvider import com twitter sdk android core Session import com twitter sdk android core SessionManager import com twitter sdk android core TwitterAuthToken import com twitter sdk android core TwitterCore import io fabric sdk android services common IdManager public class TwitterCoreScribeClientHolder private static final String KIT NAME TwitterCore private static DefaultScribeClient instance public static DefaultScribeClient getScribeClient return instance public static void initialize TwitterCore kit SessionManager extends Session TwitterAuthToken sessionManagers GuestSessionProvider guestSessionProvider IdManager idManager instance new DefaultScribeClient kit KIT NAME sessionManagers guestSessionProvider idManagerpackage com twitter sdk android core import android app Activity import io fabric sdk android Fabric import io fabric sdk android FabricAndroidTestCase import io fabric sdk android FabricTestUtils import io fabric sdk android KitStub import java util Arrays import java util List import java util concurrent Callable import java util concurrent ExecutorService import java util concurrent Executors import java util concurrent Future import javax net ssl SSLSocketFactory import static org mockito Mockito mock import static org mockito Mockito when public class TwitterCoreTest extends FabricAndroidTestCase private static final String TWITTER NOT INIT ERROR MSG Must start Twitter Kit with Fabric with first private static final String FABRIC NOT INIT ERROR MSG Must Initialize Fabric before using singleton private TwitterCore twitterCore Override protected void setUp throws Exception super setUp twitterCore new TwitterCore new TwitterAuthConfig Override protected void tearDown throws Exception super tearDown FabricTestUtils resetFabric public void testLogOut noSdkStart try TwitterCore getInstance logOut fail Should fail if Fabric is not instantiated catch IllegalStateException ex assertEquals FABRIC NOT INIT ERROR MSG ex getMessage public void testLogOut sdkStartNoTwitterKit throws Exception FabricTestUtils with getContext new KitStub Result try TwitterCore getInstance logOut fail Should fail if Twitter is not instantiated with Fabric catch IllegalStateException ie assertEquals TWITTER NOT INIT ERROR MSG ie getMessage public void testLogIn noSdkStart final Callback TwitterSession mockCallback mock Callback class try TwitterCore getInstance logIn mock Activity class mockCallback fail Should fail if Fabric is not instantiated catch IllegalStateException ie assertEquals FABRIC NOT INIT ERROR MSG ie getMessage public void testLogIn sdkStartNoTwitterKit throws Exception FabricTestUtils with getContext new KitStub Result final Callback TwitterSession mockCallback mock Callback class try TwitterCore getInstance logIn mock Activity class mockCallback fail Should fail if Twitter is not instantiated with Fabric catch IllegalStateException ie assertEquals TWITTER NOT INIT ERROR MSG ie getMessage public void testGuestSessionManager noSdkStart try TwitterCore getInstance getGuestSessionProvider fail Should fail if Fabric is not instantiated catch IllegalStateException ie assertEquals FABRIC NOT INIT ERROR MSG ie getMessage public void testGuestSessionManager sdkStartNoTwitterKit throws Exception FabricTestUtils with getContext new KitStub Result try TwitterCore getInstance getGuestSessionProvider fail Should fail if Twitter is not instantiated with Fabric catch IllegalStateException ie assertEquals TWITTER NOT INIT ERROR MSG ie getMessage public void testGetIdentifier final String identifier BuildConfig GROUP BuildConfig ARTIFACT ID assertEquals identifier twitterCore getIdentifier public void testGetSSLSocketFactory noSdkStart try twitterCore getSSLSocketFactory fail Should fail if Fabric is not instantiated catch IllegalStateException ex assertEquals FABRIC NOT INIT ERROR MSG ex getMessage public void testGetSSLSocketFactory sdkStartNoTwitterKit throws Exception FabricTestUtils with getContext new KitStub Result try twitterCore getSSLSocketFactory fail Should fail if Twitter is not instantiated with Fabric catch IllegalStateException ex assertEquals TWITTER NOT INIT ERROR MSG ex getMessage public void testGetSessionManager throws Exception FabricTestUtils with getContext twitterCore assertNotNull twitterCore getSessionManager public void testGetSessionManager twitterNotInitialized throws Exception FabricTestUtils with getContext new KitStub try twitterCore getSessionManager fail Should fail if Twitter is not instantiated with Fabric catch IllegalStateException ex assertEquals TWITTER NOT INIT ERROR MSG ex getMessage public void testGetAppSessionManager throws Exception FabricTestUtils with getContext twitterCore assertNotNull twitterCore getGuestSessionProvider public void testGetAppSessionManager twitterNotInitialized throws Exception FabricTestUtils with getContext new KitStub try twitterCore getGuestSessionProvider fail Should fail if Twitter is not instantiated with Fabric catch IllegalStateException ex assertEquals TWITTER NOT INIT ERROR MSG ex getMessage public void testGetApiClient activeSessionExists throws Exception FabricTestUtils with getContext twitterCore twitterCore twitterSessionManager setUpSessionManager mock TwitterSession class assertNotNull twitterCore getApiClient public void testGetApiClient twitterNotInitialized throws Exception FabricTestUtils with getContext new KitStub Result try twitterCore getApiClient fail Should fail if Twitter is not instantiated with Fabric catch IllegalStateException ex assertEquals TWITTER NOT INIT ERROR MSG ex getMessage public void testGetApiClient withSession throws Exception FabricTestUtils with getContext twitterCore assertNotNull twitterCore getApiClient mock TwitterSession class public void testGetApiClient withSessionTwitterNotInitialized throws Exception FabricTestUtils with getContext new KitStub Result try twitterCore getApiClient mock TwitterSession class fail Should fail if Twitter is not instantiated with Fabric catch IllegalStateException ex assertEquals TWITTER NOT INIT ERROR MSG ex getMessage public void testGetGuestApiClient twitterNotInitialized throws Exception FabricTestUtils with getContext new KitStub Result try twitterCore getGuestApiClient fail Should fail if Twitter is not instantiated with Fabric catch IllegalStateException ex assertEquals TWITTER NOT INIT ERROR MSG ex getMessage private T extends Session SessionManager T setUpSessionManager T session final SessionManager T sessionManager mock SessionManager class when sessionManager getActiveSession thenReturn session return sessionManager public void testGetSSLSocketFactory contention throws Exception We don t want to use FabricTestUtils here because we want to test this when onBackground is also running Fabric with getContext twitterCore final List SSLSocketFactoryCallable callables Arrays asList new SSLSocketFactoryCallable twitterCore new SSLSocketFactoryCallable twitterCore final ExecutorService executorService Executors newFixedThreadPool callables size final List Future SSLSocketFactory socketFactories executorService invokeAll callables assertNotNull socketFactories get 0 get assertNotNull socketFactories get 1 get assertSame socketFactories get 0 get socketFactories get 1 get private static class SSLSocketFactoryCallable implements Callable SSLSocketFactory private TwitterCore twitter protected SSLSocketFactoryCallable TwitterCore twitter this twitter twitter Override public SSLSocketFactory call return twitter getSSLSocketFactorypackage com twitter sdk android core import java util concurrent ConcurrentHashMap public final class TwitterCoreTestUtils private TwitterCoreTestUtils public static TwitterCore createTwitterCore TwitterAuthConfig authConfig ConcurrentHashMap Session TwitterApiClient clients TwitterApiClient guestClient return new TwitterCore authConfig clients guestClientpackage com twitter sdk android core public class TwitterException extends RuntimeException public TwitterException String detailMessage super detailMessage public TwitterException String detailMessage Throwable throwable super detailMessage throwablepackage com twitter sdk android unity import android app Activity import android content Intent import android net Uri import com google gson Gson import com twitter sdk android core TwitterCore import com twitter sdk android core TwitterSession import com twitter sdk android core TwitterSessionHelper import com twitter sdk android tweetcomposer Card import com twitter sdk android tweetcomposer ComposerActivity import com unity3d player UnityPlayer public class TwitterKit public static final String GAME OBJECT NAME TwitterGameObject public static final String EXTRA TWITTER SESSION EXTRA TWITTER SESSION public static void login final Activity currentActivity UnityPlayer currentActivity final Intent intent new Intent currentActivity LoginActivity class currentActivity startActivity intent public static void requestEmail String session final Activity currentActivity UnityPlayer currentActivity final Intent intent new Intent currentActivity RequestEmailActivity class intent putExtra EXTRA TWITTER SESSION session currentActivity startActivity intent public static void logout TwitterCore getInstance logOut public static String session final TwitterSession session TwitterCore getInstance getSessionManager getActiveSession return TwitterSessionHelper serialize session public static void compose String session String config String hashtags final Activity currentActivity UnityPlayer currentActivity final CardConfig cardConfig new Gson fromJson config CardConfig class final Card card new Card AppCardBuilder currentActivity imageUri Uri parse cardConfig imageUri googlePlayId cardConfig appGooglePlayId iPadId cardConfig appIPadId iPhoneId cardConfig appIPhoneId build final Intent intent new ComposerActivity Builder currentActivity session TwitterSessionHelper deserialize session card card hashtags hashtags createIntent currentActivity startActivity intent static class CardConfig final public String appIPhoneId final public String appIPadId final public String appGooglePlayId final public String imageUri CardConfig String imageUri String appGooglePlayId String appIPadId String appIPhoneId this imageUri imageUri this appGooglePlayId appGooglePlayId this appIPadId appIPadId this appIPhoneId appIPhoneIdpackage com twitter sdk android tweetui import com twitter sdk android core Callback import com twitter sdk android core TwitterCore import com twitter sdk android core models Tweet import java util List import retrofit2 Call public class TwitterListTimeline extends BaseTimeline implements Timeline Tweet private static final String SCRIBE SECTION list final Long listId final String slug final String ownerScreenName final Long ownerId final Integer maxItemsPerRequest final Boolean includeRetweets TwitterListTimeline TweetUi tweetUi Long listId String slug Long ownerId String ownerScreenName Integer maxItemsPerRequest Boolean includeRetweets super tweetUi this listId listId this slug slug this ownerId ownerId this ownerScreenName ownerScreenName this maxItemsPerRequest maxItemsPerRequest this includeRetweets includeRetweets Override public void next Long sinceId Callback TimelineResult Tweet cb createListTimelineRequest sinceId null enqueue new TweetsCallback cb Override public void previous Long maxId Callback TimelineResult Tweet cb lists statuses api provides results which are inclusive of the maxId decrement the maxId to get exclusive results createListTimelineRequest null decrementMaxId maxId enqueue new TweetsCallback cb Call List Tweet createListTimelineRequest final Long sinceId final Long maxId return TwitterCore getInstance getApiClient getListService statuses listId slug ownerScreenName ownerId sinceId maxId maxItemsPerRequest true includeRetweets Override String getTimelineType return SCRIBE SECTION public static class Builder private final TweetUi tweetUi private Long listId private String slug private Long ownerId private String ownerScreenName private Integer maxItemsPerRequest 30 private Boolean includeRetweets public Builder this TweetUi getInstance public Builder TweetUi tweetUi if tweetUi null throw new IllegalArgumentException TweetUi instance must not be null this tweetUi tweetUi public Builder id Long id this listId id return this public Builder slugWithOwnerId String slug Long ownerId this slug slug this ownerId ownerId return this public Builder slugWithOwnerScreenName String slug String ownerScreenName this slug slug this ownerScreenName ownerScreenName return this public Builder maxItemsPerRequest Integer maxItemsPerRequest this maxItemsPerRequest maxItemsPerRequest return this public Builder includeRetweets Boolean includeRetweets this includeRetweets includeRetweets return this public TwitterListTimeline build user must provide either an id or slug not both if listId null slug null throw new IllegalStateException must specify either a list id or slug owner pair user provides a slug but ownerId and ownerScreenName are null if slug null ownerId null ownerScreenName null throw new IllegalStateException slug owner pair must set owner via ownerId or ownerScreenName return new TwitterListTimeline tweetUi listId slug ownerId ownerScreenName maxItemsPerRequest includeRetweetspackage com twitter sdk android core identity import android app Activity import android annotation TargetApi import android content Context import android content Intent import android content res Resources import android graphics Typeface import android os Build import android util AttributeSet import android util TypedValue import android view View import android widget Button import com twitter sdk android core Callback import com twitter sdk android core R import com twitter sdk android core TwitterCore import com twitter sdk android core TwitterSession import io fabric sdk android Fabric import java lang ref WeakReference import io fabric sdk android services common CommonUtils public class TwitterLoginButton extends Button final static String TAG TwitterCore TAG static final String ERROR MSG NO ACTIVITY TwitterLoginButton requires an activity Override getActivity to provide the activity for this button final WeakReference Activity activityRef volatile TwitterAuthClient authClient OnClickListener onClickListener Callback TwitterSession callback public TwitterLoginButton Context context this context null public TwitterLoginButton Context context AttributeSet attrs this context attrs android R attr buttonStyle public TwitterLoginButton Context context AttributeSet attrs int defStyle this context attrs defStyle null TwitterLoginButton Context context AttributeSet attrs int defStyle TwitterAuthClient authClient super context attrs defStyle this activityRef new WeakReference getActivity this authClient authClient setupButton checkTwitterCoreAndEnable TargetApi Build VERSION CODES LOLLIPOP private void setupButton final Resources res getResources super setCompoundDrawablesWithIntrinsicBounds res getDrawable R drawable tw ic logo default null null null super setCompoundDrawablePadding res getDimensionPixelSize R dimen tw login btn drawable padding super setText R string tw login btn txt super setTextColor res getColor R color tw solid white super setTextSize TypedValue COMPLEX UNIT PX res getDimensionPixelSize R dimen tw login btn text size super setTypeface Typeface DEFAULT BOLD super setPadding res getDimensionPixelSize R dimen tw login btn left padding 0 res getDimensionPixelSize R dimen tw login btn right padding 0 super setBackgroundResource R drawable tw login btn super setOnClickListener new LoginClickListener if Build VERSION SDK INT Build VERSION CODES LOLLIPOP super setAllCaps false public void setCallback Callback TwitterSession callback if callback null throw new IllegalArgumentException Callback cannot be null this callback callback public Callback TwitterSession getCallback return callback public void onActivityResult int requestCode int resultCode Intent data if requestCode getTwitterAuthClient getRequestCode getTwitterAuthClient onActivityResult requestCode resultCode data protected Activity getActivity if getContext instanceof Activity return Activity getContext else if isInEditMode return null else throw new IllegalStateException ERROR MSG NO ACTIVITY Override public void setOnClickListener OnClickListener onClickListener this onClickListener onClickListener private class LoginClickListener implements OnClickListener Override public void onClick View view checkCallback callback checkActivity activityRef get getTwitterAuthClient authorize activityRef get callback if onClickListener null onClickListener onClick view private void checkCallback Callback callback if callback null CommonUtils logOrThrowIllegalStateException TwitterCore TAG Callback must not be null did you call setCallback private void checkActivity Activity activity if activity null activity isFinishing CommonUtils logOrThrowIllegalStateException TwitterCore TAG ERROR MSG NO ACTIVITY TwitterAuthClient getTwitterAuthClient if authClient null synchronized TwitterLoginButton class if authClient null authClient new TwitterAuthClient return authClient private void checkTwitterCoreAndEnable Default Enabled in edit mode if isInEditMode return try TwitterCore getInstance catch IllegalStateException ex Disable if TwitterCore hasn t started Fabric getLogger e TAG ex getMessage setEnabled falsepackage com twitter sdk android core identity import android app Activity import android content Intent import android util Log import android view View import io fabric sdk android Fabric import io fabric sdk android FabricAndroidTestCase import io fabric sdk android FabricTestUtils import io fabric sdk android KitStub import io fabric sdk android Logger import com twitter sdk android core Callback import com twitter sdk android core TwitterAuthConfig import com twitter sdk android core TwitterCore import com twitter sdk android core TwitterSession import org mockito ArgumentCaptor import static org mockito Mockito public class TwitterLoginButtonTest extends FabricAndroidTestCase private static final int TEST REQUEST CODE 100 private Activity mockActivity private TwitterAuthClient mockAuthClient private Callback TwitterSession mockCallback private View OnClickListener mockViewClickListener private TwitterLoginButton loginButton Override protected void setUp throws Exception super setUp mockActivity mock Activity class mockAuthClient mock TwitterAuthClient class when mockAuthClient getRequestCode thenReturn TEST REQUEST CODE doNothing when mockAuthClient authorize any Activity class any Callback class doNothing when mockAuthClient onActivityResult anyInt anyInt any Intent class mockCallback mock Callback class mockViewClickListener mock View OnClickListener class loginButton new TwitterLoginButton getContext null 0 mockAuthClient This is to allow us to test TwitterLoginButton without having to set up a real activity Override protected Activity getActivity return mockActivity public void testConstructor contextNotActivity try loginButton new TwitterLoginButton getContext null 0 mockAuthClient fail Constructor should throw an exception when provided context is not an activity catch IllegalStateException e assertEquals TwitterLoginButton ERROR MSG NO ACTIVITY e getMessage public void testConstructor contextNotActivityEditModeTrue loginButton new TwitterLoginButton getContext null 0 mockAuthClient Override public boolean isInEditMode return true assertNull loginButton getActivity public void testConstructor nullTwitterAuthClient final TwitterLoginButton button new TwitterLoginButton getContext Override protected Activity getActivity return mock Activity class assertNull button authClient public void testConstructor editMode throws Exception final TwitterLoginButton button new TwitterLoginButton getContext Override protected Activity getActivity return mock Activity class Override public boolean isInEditMode return true assertTrue button isEnabled public void testConstructor twitterNotStarted throws Exception try final Fabric fabric new Fabric Builder getContext debuggable true logger mock Logger class kits new KitStub build FabricTestUtils with fabric final TwitterLoginButton button new TwitterLoginButton getContext Override protected Activity getActivity return mock Activity class final Logger logger Fabric getLogger verify logger e eq TwitterLoginButton TAG eq Must start Twitter Kit with Fabric with first assertFalse button isEnabled finally FabricTestUtils resetFabric public void testConstructor twitterStarted throws Exception try final Fabric fabric new Fabric Builder getContext debuggable true kits new TwitterCore new TwitterAuthConfig logger mock Logger class build FabricTestUtils with fabric final TwitterLoginButton button new TwitterLoginButton getContext Override protected Activity getActivity return mock Activity class final Logger logger Fabric getLogger verify logger never e eq TwitterLoginButton TAG eq Must start Twitter Kit with Fabric with first assertTrue button isEnabled finally FabricTestUtils resetFabric public void testSetCallback callbackNull try loginButton setCallback null fail setCallback should throw an exception when called with null callback catch IllegalArgumentException e assertEquals Callback cannot be null e getMessage public void testGetCallback final Callback TwitterSession mockCallback mock Callback class loginButton setCallback mockCallback assertSame mockCallback loginButton getCallback public void testOnClick loginButton setCallback mockCallback loginButton performClick verify mockAuthClient authorize eq mockActivity eq mockCallback public void testOnClick withOnClickListener loginButton setCallback mockCallback loginButton setOnClickListener mockViewClickListener loginButton performClick verify mockAuthClient authorize eq mockActivity eq mockCallback verify mockViewClickListener onClick eq loginButton public void testOnClick callbackNullDebuggableTrue throws Exception final Fabric fabric new Fabric Builder getContext kits new KitStub debuggable true build FabricTestUtils with fabric try loginButton performClick fail onClick should throw an exception when called and there is no callback catch IllegalStateException e assertEquals Callback must not be null did you call setCallback e getMessage finally FabricTestUtils resetFabric public void testOnClick callbackNullDebuggableFalse throws Exception final Fabric fabric setUpLogTest FabricTestUtils with fabric try loginButton performClick assertLogMessage Callback must not be null did you call setCallback finally FabricTestUtils resetFabric public void testOnClick activityNullDebuggableTrue throws Exception final Fabric fabric new Fabric Builder getContext kits new KitStub debuggable true build FabricTestUtils with fabric loginButton new TwitterLoginButton getContext null 0 mockAuthClient This is to allow us to test TwitterLoginButton without having to set up a real activity Override protected Activity getActivity return null loginButton setCallback mockCallback try loginButton performClick fail onClick should throw an exception when called and there is no activity catch IllegalStateException e assertEquals TwitterLoginButton ERROR MSG NO ACTIVITY e getMessage finally FabricTestUtils resetFabric public void testOnClick activityNullDebuggableFalse throws Exception final Fabric fabric setUpLogTest FabricTestUtils with fabric loginButton new TwitterLoginButton getContext null 0 mockAuthClient This is to allow us to test TwitterLoginButton without having to set up a real activity Override protected Activity getActivity return null loginButton setCallback mockCallback try loginButton performClick assertLogMessage TwitterLoginButton ERROR MSG NO ACTIVITY finally FabricTestUtils resetFabric public void testOnClick activityFinishingDebuggableFalse throws Exception final Fabric fabric setUpLogTest FabricTestUtils with fabric loginButton new TwitterLoginButton getContext null 0 mockAuthClient This is to allow us to test TwitterLoginButton without having to set up a real activity Override protected Activity getActivity final Activity mockActivity mock Activity class when mockActivity isFinishing thenReturn true return mockActivity loginButton setCallback mockCallback try loginButton performClick assertLogMessage TwitterLoginButton ERROR MSG NO ACTIVITY finally FabricTestUtils resetFabric private Fabric setUpLogTest final Logger mockLogger mock Logger class when mockLogger isLoggable TwitterCore TAG Log WARN thenReturn true final Fabric fabric new Fabric Builder getContext kits new KitStub debuggable false logger mockLogger build return fabric private void assertLogMessage String expectedMessage final ArgumentCaptor String argumentCaptor ArgumentCaptor forClass String class verify Fabric getLogger w eq TwitterCore TAG argumentCaptor capture assertEquals expectedMessage argumentCaptor getValue public void testOnActivityResult requestCodeMatches final int requestCode TEST REQUEST CODE final int resultCode Activity RESULT OK final Intent mockData mock Intent class loginButton onActivityResult requestCode resultCode mockData verify mockAuthClient getRequestCode verify mockAuthClient onActivityResult requestCode resultCode mockData public void testOnActivityResult requestCodeDoesNotMatch final int requestCode 1 final int resultCode Activity RESULT OK final Intent mockData mock Intent class loginButton onActivityResult requestCode resultCode mockData verify mockAuthClient getRequestCode verifyNoMoreInteractions mockAuthClient public void testGetTwitterAuthClient throws Exception try final Fabric fabric new Fabric Builder getContext kits new TwitterCore new TwitterAuthConfig build FabricTestUtils with fabric final TwitterLoginButton button new TwitterLoginButton getContext Override protected Activity getActivity return mock Activity class final TwitterAuthClient client button getTwitterAuthClient assertNotNull client finally FabricTestUtils resetFabric public void testGetTwitterAuthClient duplicateCalls throws Exception try final Fabric fabric new Fabric Builder getContext kits new TwitterCore new TwitterAuthConfig build FabricTestUtils with fabric final TwitterLoginButton button new TwitterLoginButton getContext Override protected Activity getActivity return mock Activity class final TwitterAuthClient client button getTwitterAuthClient final TwitterAuthClient client2 button getTwitterAuthClient assertSame client client2 finally FabricTestUtils resetFabricpackage com twitter sdk android mopub import android app Activity import android support annotation NonNull import android support annotation Nullable import android text TextUtils import android widget Adapter import com mopub nativeads MoPubAdAdapter import com mopub nativeads MoPubNativeAdPositioning import com mopub nativeads RequestParameters public class TwitterMoPubAdAdapter extends MoPubAdAdapter private final static String TWITTERKIT KEYWORD src twitterkit public TwitterMoPubAdAdapter Activity activity Adapter originalAdapter super activity originalAdapter public TwitterMoPubAdAdapter Activity activity Adapter originalAdapter MoPubNativeAdPositioning MoPubServerPositioning adPositioning super activity originalAdapter adPositioning public TwitterMoPubAdAdapter Activity activity Adapter originalAdapter MoPubNativeAdPositioning MoPubClientPositioning adPositioning super activity originalAdapter adPositioning Override public void loadAds NonNull final String adUnitId loadAds adUnitId null Override public void loadAds NonNull final String adUnitId Nullable final RequestParameters requestParams final RequestParameters Builder builder new RequestParameters Builder if requestParams null final String keywords TextUtils isEmpty requestParams getKeywords TWITTERKIT KEYWORD requestParams getKeywords TWITTERKIT KEYWORD builder keywords keywords builder location requestParams getLocation else builder keywords TWITTERKIT KEYWORD super loadAds adUnitId builder buildpackage com twitter sdk android core import android content Context import io fabric sdk android services network PinningInfoProvider import java io InputStream import java util Collection import java util HashMap class TwitterPinningInfoProvider implements PinningInfoProvider private static final String PINS static final HashMap String String pinMap new HashMap pinMap put VERISIGN CLASS1 2343d148a255899b947d461a797ec04cfed170b7 pinMap put VERISIGN CLASS1 G3 5519b278acb281d7eda7abc18399c3bb690424b5 pinMap put VERISIGN CLASS2 G2 1237ba4517eead2926fdc1cdfebeedf2ded9145c pinMap put VERISIGN CLASS2 G3 5abec575dcaef3b08e271943fc7f250c3df661e3 pinMap put VERISIGN CLASS3 G2 1a21b4952b6293ce18b365ec9c0e934cb381e6d4 pinMap put VERISIGN CLASS3 G3 22f19e2ec6eaccfc5d2346f4c2e8f6c554dd5e07 pinMap put VERISIGN CLASS3 G4 ed663135d31bd4eca614c429e319069f94c12650 pinMap put VERISIGN CLASS3 G5 b181081a19a4c0941ffae89528c124c99b34acc7 pinMap put VERISIGN CLASS4 G3 3c03436868951cf3692ab8b426daba8fe922e5bd pinMap put VERISIGN UNIVERSAL bbc23e290bb328771dad3ea24dbdf423bd06b03d pinMap put GEOTRUST GLOBAL c07a98688d89fbab05640c117daa7d65b8cacc4e pinMap put GEOTRUST GLOBAL2 713836f2023153472b6eba6546a9101558200509 pinMap put GEOTRUST PRIMARY b01989e7effb4aafcb148f58463976224150e1ba pinMap put GEOTRUST PRIMARY G2 bdbea71bab7157f9e475d954d2b727801a822682 pinMap put GEOTRUST PRIMARY G3 9ca98d00af740ddd8180d21345a58b8f2e9438d6 pinMap put GEOTRUST UNIVERAL 87e85b6353c623a3128cb0ffbbf551fe59800e22 pinMap put GEOTRUST UNIVERSAL2 5e4f538685dd4f9eca5fdc0d456f7d51b1dc9b7b pinMap put DIGICERT GLOBAL ROOT d52e13c1abe349dae8b49594ef7c3843606466bd pinMap put DIGICERT EV ROOT 83317e62854253d6d7783190ec919056e991b9e3 pinMap put DIGICERT ASSUREDID ROOT 68330e61358521592983a3c8d2d2e1406e7ab3c1 pinMap put TWITTER1 56fef3c2147d4ed38837fdbd3052387201e5778d final Collection String values pinMap values PINS values toArray new String values size private final Context appContext public TwitterPinningInfoProvider Context context appContext context getApplicationContext Override public InputStream getKeyStoreStream return appContext getResources openRawResource R raw tw cacerts Override public String getKeyStorePassword keystore required to have a password but these certificates are public return changeit Override public String getPins return PINS Override public long getPinCreationTimeInMillis return BuildConfig BUILD TIMEpackage com twitter sdk android core import okhttp3 Headers public class TwitterRateLimit private final static String LIMIT KEY x rate limit limit private final static String REMAINING KEY x rate limit remaining private final static String RESET KEY x rate limit reset private int requestLimit private int remainingRequest private long resetSeconds TwitterRateLimit final Headers headers if headers null throw new IllegalArgumentException headers must not be null for int i 0 i headers size i if LIMIT KEY equals headers name i requestLimit Integer valueOf headers value i else if REMAINING KEY equals headers name i remainingRequest Integer valueOf headers value i else if RESET KEY equals headers name i resetSeconds Long valueOf headers value i public int getLimit return requestLimit public int getRemaining return remainingRequest public long getReset return resetSecondspackage com twitter sdk android core import android text TextUtils import io fabric sdk android Fabric import io fabric sdk android services persistence SerializationStrategy import com google gson annotations SerializedName import com google gson Gson public class TwitterSession extends Session TwitterAuthToken public static final long UNKNOWN USER ID 1L public static final String UNKNOWN USER NAME SerializedName user name private final String userName public TwitterSession TwitterAuthToken authToken long userId String userName super authToken userId this userName userName public long getUserId return getId public String getUserName return userName Override public boolean equals Object o if this o return true if o null getClass o getClass return false if super equals o return false final TwitterSession that TwitterSession o return userName null userName equals that userName that userName null Override public int hashCode int result super hashCode result 31 result userName null userName hashCode 0 return result static class Serializer implements SerializationStrategy TwitterSession private final Gson gson public Serializer this gson new Gson Override public String serialize TwitterSession session if session null session getAuthToken null try return gson toJson session catch Exception e Fabric getLogger d TwitterCore TAG e getMessage return Override public TwitterSession deserialize String serializedSession if TextUtils isEmpty serializedSession try return gson fromJson serializedSession TwitterSession class catch Exception e Fabric getLogger d TwitterCore TAG e getMessage return nullpackage com twitter sdk android core public class TwitterSessionHelper public static String serialize TwitterSession session final TwitterSession Serializer serializer new TwitterSession Serializer return serializer serialize session public static TwitterSession deserialize String session final TwitterSession Serializer serializer new TwitterSession Serializer return serializer deserialize sessionpackage com twitter sdk android core internal import com twitter sdk android core TwitterApiClient import com twitter sdk android core TwitterSession import com twitter sdk android core internal scribe DefaultScribeClient import com twitter sdk android core internal scribe EventNamespace import com twitter sdk android core internal scribe TwitterCoreScribeClientHolder import com twitter sdk android core services AccountService import java io IOException public class TwitterSessionVerifier implements SessionVerifier TwitterSession static final String SCRIBE CLIENT android static final String SCRIBE PAGE credentials static final String SCRIBE SECTION intentionally blank static final String SCRIBE COMPONENT intentionally blank static final String SCRIBE ELEMENT intentionally blank static final String SCRIBE ACTION impression private final AccountServiceProvider accountServiceProvider private final DefaultScribeClient scribeClient public TwitterSessionVerifier this accountServiceProvider new AccountServiceProvider this scribeClient TwitterCoreScribeClientHolder getScribeClient TwitterSessionVerifier AccountServiceProvider accountServiceProvider DefaultScribeClient scribeClient this accountServiceProvider accountServiceProvider this scribeClient scribeClient public void verifySession final TwitterSession session final AccountService accountService accountServiceProvider getAccountService session try scribeVerifySession accountService verifyCredentials true false execute catch IOException RuntimeException e We ignore failures since we will attempt the verification again the next time the verification period comes up This has the potential to lose events but we are not aiming towards 100 capture rate private void scribeVerifySession if scribeClient null return final EventNamespace ns new EventNamespace Builder setClient SCRIBE CLIENT setPage SCRIBE PAGE setSection SCRIBE SECTION setComponent SCRIBE COMPONENT setElement SCRIBE ELEMENT setAction SCRIBE ACTION builder scribeClient scribe ns protected static class AccountServiceProvider public AccountService getAccountService TwitterSession session return new TwitterApiClient session getAccountServicepackage com twitter sdk android mopub import android content Context import android content res TypedArray import android graphics drawable Drawable import android graphics drawable GradientDrawable import android graphics drawable LayerDrawable import android graphics drawable ShapeDrawable import android graphics drawable StateListDrawable import android graphics drawable shapes RectShape import android os Build import android util AttributeSet import android view LayoutInflater import android widget FrameLayout import android widget ImageView import android widget LinearLayout import android widget RelativeLayout import android widget TextView import com twitter sdk android mopub internal RoundedImageView public class TwitterStaticNativeAd extends FrameLayout LinearLayout containerLayout RoundedImageView mainImageView RelativeLayout cardLayout ImageView adIconView TextView adTitleView TextView adTextView TextView callToActionView ImageView privacyInfoView style colors int containerBackgroundColor int cardBackgroundColor int primaryTextColor int ctaBackgroundColor int cardBorderColor private static final int DEFAULT AD STYLE R style tw ad LightStyle public TwitterStaticNativeAd Context context this context null public TwitterStaticNativeAd Context context AttributeSet attrs this context attrs DEFAULT AD STYLE public TwitterStaticNativeAd Context context AttributeSet attrs int styleResId super context attrs findSubviews initAttributes styleResId setStyleAttributes private void findSubviews LayoutInflater from getContext inflate R layout tw native ad this true containerLayout LinearLayout findViewById R id tw ad mopub layout mainImageView RoundedImageView findViewById R id native ad main image cardLayout RelativeLayout findViewById R id native ad card adIconView ImageView findViewById R id native ad icon image adTitleView TextView findViewById R id native ad title adTextView TextView findViewById R id native ad text callToActionView TextView findViewById R id native ad cta privacyInfoView ImageView findViewById R id native ad privacy info icon image private void initAttributes int styleResId final TypedArray a getContext getTheme obtainStyledAttributes styleResId R styleable tw native ad try readStyleAttributes a finally a recycle private void readStyleAttributes TypedArray typedArray containerBackgroundColor typedArray getColor R styleable tw native ad tw ad container bg color getResources getColor R color tw ad light container bg color cardBackgroundColor typedArray getColor R styleable tw native ad tw ad card bg color getResources getColor R color tw ad light card bg color primaryTextColor typedArray getColor R styleable tw native ad tw ad text primary color getResources getColor R color tw ad light text primary color ctaBackgroundColor typedArray getColor R styleable tw native ad tw ad cta button color getResources getColor R color tw ad cta default private void setStyleAttributes containerLayout setBackgroundColor containerBackgroundColor adTitleView setTextColor primaryTextColor adTextView setTextColor primaryTextColor final int adViewRadius int getResources getDimension R dimen tw ad view radius mainImageView setCornerRadii adViewRadius adViewRadius 0 0 final TextView privacyTextView TextView findViewById R id native ad privacy text privacyTextView setTextColor ColorUtils calculateContrastingColor containerBackgroundColor setCardStyling setCallToActionStyling private void setCardStyling final boolean isLightBg ColorUtils isLightColor containerBackgroundColor if isLightBg cardBorderColor getResources getColor R color tw ad light card border color else cardBorderColor getResources getColor R color tw ad dark card border color final ShapeDrawable bgDrawable new ShapeDrawable new RectShape bgDrawable getPaint setColor cardBackgroundColor final ShapeDrawable borderDrawable new ShapeDrawable new RectShape borderDrawable getPaint setColor cardBorderColor final Drawable layers new Drawable 2 layers 0 borderDrawable layers 1 bgDrawable final LayerDrawable layerDrawable new LayerDrawable layers layerDrawable setLayerInset 0 0 0 0 0 layerDrawable setLayerInset 1 1 0 1 0 if Build VERSION SDK INT Build VERSION CODES JELLY BEAN cardLayout setBackground layerDrawable else cardLayout setBackgroundDrawable layerDrawable private void setCallToActionStyling final int calculatedCTATextColor ColorUtils calculateCtaTextColor ctaBackgroundColor callToActionView setTextColor calculatedCTATextColor Setup StateListDrawable obj with two gradient drawables First is the selected item with lighter darker bg color of original Second is unselected item with the call to action background color Also set the default ad view radius for bottomLeft and bottomRight corners final StateListDrawable stateListDrawable new StateListDrawable final int adViewRadius int getResources getDimension R dimen tw ad view radius final float ctaViewRadii new float 0 0 0 0 adViewRadius adViewRadius adViewRadius adViewRadius final GradientDrawable selectedItem new GradientDrawable selectedItem setCornerRadii ctaViewRadii final int ctaPressedBgColor ColorUtils calculateCtaOnTapColor ctaBackgroundColor selectedItem setColor ctaPressedBgColor stateListDrawable addState new int android R attr state pressed selectedItem final GradientDrawable unselectedItem new GradientDrawable unselectedItem setCornerRadii ctaViewRadii unselectedItem setColor ctaBackgroundColor stateListDrawable addState new int unselectedItem if Build VERSION SDK INT Build VERSION CODES JELLY BEAN callToActionView setBackground stateListDrawable else callToActionView setBackgroundDrawable stateListDrawablepackage com twitter sdk android mopub import android app Activity import android view View import android view ViewGroup import com mopub nativeads BaseNativeAd import com mopub nativeads MoPubAdRenderer import com mopub nativeads NativeImageHelper import com mopub nativeads NativeRendererHelper import com mopub nativeads StaticNativeAd public class TwitterStaticNativeAdRenderer implements MoPubAdRenderer StaticNativeAd private static final int DEFAULT STYLE R style tw ad LightStyle private final int styleResId public TwitterStaticNativeAdRenderer this styleResId DEFAULT STYLE public TwitterStaticNativeAdRenderer int styleResId this styleResId styleResId Override public View createAdView final Activity activity final ViewGroup parent return new TwitterStaticNativeAd activity null styleResId Override public void renderAdView final View view final StaticNativeAd staticNativeAd update TwitterStaticNativeAd view staticNativeAd Override public boolean supports final BaseNativeAd nativeAd return nativeAd instanceof StaticNativeAd private void update final TwitterStaticNativeAd staticNativeView final StaticNativeAd staticNativeAd NativeRendererHelper addTextView staticNativeView adTitleView staticNativeAd getTitle NativeRendererHelper addTextView staticNativeView adTextView staticNativeAd getText NativeRendererHelper addTextView staticNativeView callToActionView staticNativeAd getCallToAction NativeImageHelper loadImageView staticNativeAd getMainImageUrl staticNativeView mainImageView NativeImageHelper loadImageView staticNativeAd getIconImageUrl staticNativeView adIconView NativeRendererHelper addPrivacyInformationIcon staticNativeView privacyInfoView staticNativeAd getPrivacyInformationIconImageUrl staticNativeAd getPrivacyInformationIconClickThroughUrlpackage com twitter sdk android mopub import android graphics Bitmap import android graphics drawable Drawable import android view View import android view ViewGroup import android widget ImageView import android widget TextView import com mopub nativeads BaseNativeAd import com mopub nativeads MoPubCustomEventVideoNative import com mopub nativeads StaticNativeAd import com mopub network MaxWidthImageLoader import com mopub network Networking import com mopub volley toolbox ImageLoader import com twitter sdk android mopub internal RoundedImageView import org junit Before import org junit Rule import org junit Test import org junit rules ExpectedException import org junit runner RunWith import org mockito Mock import org mockito MockitoAnnotations import org mockito invocation InvocationOnMock import org mockito stubbing Answer import org robolectric RobolectricGradleTestRunner import org robolectric RuntimeEnvironment import org robolectric annotation Config import static org junit Assert assertFalse import static org junit Assert assertTrue import static org mockito Matchers any import static org mockito Matchers anyString import static org mockito Mockito doAnswer import static org mockito Mockito doReturn import static org mockito Mockito mock import static org mockito Mockito verify RunWith RobolectricGradleTestRunner class Config constants BuildConfig class sdk 21 public class TwitterStaticNativeAdRendererTest private static final String TEST TITLE title private static final String TEST TEXT text private static final String TEST CTA cta private static final String TEST URL https twitter com private TwitterStaticNativeAdRenderer twitterStaticNativeAdRenderer private StaticNativeAd staticNativeAd private TwitterStaticNativeAd twitterStaticNativeAd Mock private ViewGroup viewGroup Mock private MaxWidthImageLoader mockImageLoader Mock private ImageLoader ImageContainer mockImageContainer Mock private Bitmap mockBitmap Rule public ExpectedException thrown ExpectedException none Before public void setUp throws Exception MockitoAnnotations initMocks this Networking setImageLoaderForTesting mockImageLoader doReturn mockBitmap when mockImageContainer getBitmap doAnswer new Answer Void Override public Void answer InvocationOnMock invocation throws Throwable final Object args invocation getArguments ImageLoader ImageListener args 1 onResponse mockImageContainer true return null when mockImageLoader get anyString any ImageLoader ImageListener class twitterStaticNativeAdRenderer new TwitterStaticNativeAdRenderer twitterStaticNativeAd new TwitterStaticNativeAd RuntimeEnvironment application twitterStaticNativeAd adTextView mock TextView class twitterStaticNativeAd adTitleView mock TextView class twitterStaticNativeAd callToActionView mock TextView class twitterStaticNativeAd mainImageView mock RoundedImageView class twitterStaticNativeAd adIconView mock ImageView class twitterStaticNativeAd privacyInfoView mock ImageView class staticNativeAd new StaticNativeAd staticNativeAd setTitle TEST TITLE staticNativeAd setText TEST TEXT staticNativeAd setCallToAction TEST CTA staticNativeAd setClickDestinationUrl TEST URL staticNativeAd setMainImageUrl TEST URL staticNativeAd setIconImageUrl TEST URL Test expected NullPointerException class public void testCreateAdView withNullContext shouldThrowNPE twitterStaticNativeAdRenderer createAdView null viewGroup Test expected NullPointerException class public void testRenderAdView withNullView shouldThrowNPE twitterStaticNativeAdRenderer renderAdView null staticNativeAd Test expected NullPointerException class public void testRenderAdView withNullNativeAd shouldThrowNPE twitterStaticNativeAdRenderer renderAdView twitterStaticNativeAd null Test public void testRenderAdView shouldReturnPopulatedView twitterStaticNativeAdRenderer renderAdView twitterStaticNativeAd staticNativeAd verify twitterStaticNativeAd adTitleView setText TEST TITLE verify twitterStaticNativeAd adTextView setText TEST TEXT verify twitterStaticNativeAd callToActionView setText TEST CTA verify twitterStaticNativeAd mainImageView setImageBitmap mockBitmap verify twitterStaticNativeAd adIconView setImageBitmap mockBitmap verify twitterStaticNativeAd privacyInfoView setImageDrawable any Drawable class verify twitterStaticNativeAd privacyInfoView setOnClickListener any View OnClickListener class Test public void testSupports withCorrectInstanceOfBaseNativeAd shouldReturnTrue throws Exception assertTrue twitterStaticNativeAdRenderer supports new StaticNativeAd assertFalse twitterStaticNativeAdRenderer supports mock BaseNativeAd class assertFalse twitterStaticNativeAdRenderer supports mock MoPubCustomEventVideoNative MoPubVideoNativeAd classpackage com twitter sdk android mopub import android test AndroidTestCase import org junit Test import org junit runner RunWith import org robolectric RobolectricGradleTestRunner import org robolectric RuntimeEnvironment import org robolectric annotation Config RunWith RobolectricGradleTestRunner class Config constants BuildConfig class sdk 21 public class TwitterStaticNativeAdTest extends AndroidTestCase Test public void testStyleAttrsForDefaultTheme final TwitterStaticNativeAd nativeAd new TwitterStaticNativeAd RuntimeEnvironment application final int expectedContainerBgColor nativeAd getResources getColor R color tw ad light container bg color final int expectedCardBgColor nativeAd getResources getColor R color tw ad light card bg color final int expectedPrimaryTextColor nativeAd getResources getColor R color tw ad light text primary color final int ctaBackgroundColor nativeAd getResources getColor R color tw ad cta default final int cardBorderColor nativeAd getResources getColor R color tw ad light card border color assertEquals expectedContainerBgColor nativeAd containerBackgroundColor assertEquals expectedCardBgColor nativeAd cardBackgroundColor assertEquals expectedPrimaryTextColor nativeAd primaryTextColor assertEquals ctaBackgroundColor nativeAd ctaBackgroundColor assertEquals cardBorderColor nativeAd cardBorderColor Test public void testStyleAttrsForDarkTheme final TwitterStaticNativeAd nativeAd new TwitterStaticNativeAd RuntimeEnvironment application null R style tw ad DarkStyle final int expectedContainerBgColor nativeAd getResources getColor R color tw ad dark container bg color final int expectedCardBgColor nativeAd getResources getColor R color tw ad dark card bg color final int expectedPrimaryTextColor nativeAd getResources getColor R color tw ad dark text primary color final int ctaBackgroundColor nativeAd getResources getColor R color tw ad cta default final int cardBorderColor nativeAd getResources getColor R color tw ad dark card border color assertEquals expectedContainerBgColor nativeAd containerBackgroundColor assertEquals expectedCardBgColor nativeAd cardBackgroundColor assertEquals expectedPrimaryTextColor nativeAd primaryTextColor assertEquals ctaBackgroundColor nativeAd ctaBackgroundColor assertEquals cardBorderColor nativeAd cardBorderColorpackage hudson import java net SocketAddress public abstract class UDPBroadcastFragment implements ExtensionPoint public abstract void buildFragment StringBuilder buf SocketAddress sender public static ExtensionList UDPBroadcastFragment all return ExtensionList lookup UDPBroadcastFragment classpackage hudson import jenkins util SystemProperties import edu umd cs findbugs annotations SuppressFBWarnings import hudson model Hudson import jenkins model Jenkins import hudson util OneShotEvent import java io IOException import java net DatagramPacket import java net InetAddress import java net MulticastSocket import java net SocketAddress import java net SocketException import java net UnknownHostException import java nio channels ClosedByInterruptException import java util logging Level import java util logging Logger public class UDPBroadcastThread extends Thread private final Jenkins jenkins public final OneShotEvent ready new OneShotEvent private MulticastSocket mcs private boolean shutdown static boolean udpHandlingProblem for tests Deprecated public UDPBroadcastThread Hudson jenkins throws IOException this Jenkins jenkins public UDPBroadcastThread Jenkins jenkins throws IOException super Jenkins UDP PORT monitoring thread this jenkins jenkins mcs new MulticastSocket PORT SuppressFBWarnings ST WRITE TO STATIC FROM INSTANCE METHOD Override public void run try mcs joinGroup MULTICAST ready signal while true byte buf new byte 2048 DatagramPacket p new DatagramPacket buf buf length mcs receive p SocketAddress sender p getSocketAddress prepare a response TcpSlaveAgentListener tal jenkins getTcpSlaveAgentListener StringBuilder rsp new StringBuilder hudson tag rsp version Jenkins VERSION tag rsp url jenkins getRootUrl tag rsp server id jenkins getLegacyInstanceId tag rsp slave port tal null null tal getPort for UDPBroadcastFragment f UDPBroadcastFragment all f buildFragment rsp sender rsp append hudson byte response rsp toString getBytes UTF 8 mcs send new DatagramPacket response response length sender catch ClosedByInterruptException e shut down catch SocketException e if shutdown forcibly closed return if we failed to listen to UDP just silently abandon it as a stack trace makes people unnecessarily concerned for a feature that currently does no good LOGGER log Level INFO Cannot listen to UDP port 0 skipping 1 new Object PORT e LOGGER log Level FINE null e catch IOException e if shutdown return forcibly closed LOGGER log Level WARNING UDP handling problem e udpHandlingProblem true private void tag StringBuilder buf String tag Object value if value null return buf append append tag append append value append append tag append public void shutdown shutdown true mcs close interrupt public static final int PORT SystemProperties getInteger hudson udp 33848 private static final Logger LOGGER Logger getLogger UDPBroadcastThread class getName public static InetAddress MULTICAST static try MULTICAST InetAddress getByAddress new byte byte 239 byte 77 byte 124 byte 213 catch UnknownHostException e throw new Error epackage hudson util import org apache commons codec binary Base64 import java io DataInputStream import java io FilterInputStream import java io IOException import java io InputStream public class UnbufferedBase64InputStream extends FilterInputStream private byte encoded new byte 4 private byte decoded private int pos private final DataInputStream din public UnbufferedBase64InputStream InputStream in super in din new DataInputStream in initial placement to force the decoding in the next read pos 4 decoded encoded Override public int read throws IOException if decoded length 0 return 1 EOF if pos decoded length din readFully encoded decoded Base64 decodeBase64 encoded if decoded length 0 return 1 EOF pos 0 return decoded pos 0xFF Override public int read byte b int off int len throws IOException int i for i 0 i len i int ch read if ch 0 break b off i byte ch return i 0 1 i Override public long skip long n throws IOException long r 0 while n 0 int ch read if ch 0 break n r return rpackage hudson search import java util List public class UnionSearchIndex implements SearchIndex public static SearchIndex combine SearchIndex sets SearchIndex p EMPTY for SearchIndex q sets allow some of the inputs to be null and also recognize EMPTY if q null q EMPTY if p EMPTY p q else p new UnionSearchIndex p q return p private final SearchIndex lhs rhs public UnionSearchIndex SearchIndex lhs SearchIndex rhs this lhs lhs this rhs rhs public void find String token List SearchItem result lhs find token result rhs find token result public void suggest String token List SearchItem result lhs suggest token result rhs suggest token resultpackage com twitter sdk android unity import com unity3d player UnityPlayer class UnityMessage final String data final String method UnityMessage String method String data this method method this data data public static class Builder String data String method public Builder setData String data this data data return this public Builder setMethod String method this method method return this public UnityMessage build return new UnityMessage method data public void send UnityPlayer UnitySendMessage TwitterKit GAME OBJECT NAME method datapackage hudson lifecycle import com sun akuma JavaVMArguments import com sun jna Native import com sun jna StringArray import java io IOException import static hudson util jna GNUCLibrary import hudson Platform import jenkins model Jenkins public class UnixLifecycle extends Lifecycle private JavaVMArguments args private Throwable failedToObtainArgs public UnixLifecycle throws IOException try args JavaVMArguments current if we are running as daemon don t fork into background one more time during restart args remove daemon catch UnsupportedOperationException e can t restart failedToObtainArgs e catch LinkageError e see HUDSON 3875 failedToObtainArgs e Override public void restart throws IOException InterruptedException Jenkins h Jenkins getInstanceOrNull guard against repeated concurrent calls to restart if h null h cleanUp close all files upon exec except stdin stdout and stderr int sz LIBC getdtablesize for int i 3 i sz i int flags LIBC fcntl i F GETFD if flags 0 continue LIBC fcntl i F SETFD flags FD CLOEXEC exec to self String exe args get 0 LIBC execvp exe new StringArray args toArray new String args size throw new IOException Failed to exec exe LIBC strerror Native getLastError Override public void verifyRestartable throws RestartNotSupportedException see http lists apple com archives cocoa dev 2005 Oct msg00836 html and http factor language blogspot com 2007 07 execve returning enotsup on mac os x html on Mac execv fails with ENOTSUP if the caller is multi threaded resulting in an error like the one described in http www nabble com Restarting hudson not working on MacOS to24641779 html according to http www mail archive com wine devel winehq org msg66797 html this now works on Snow Leopard if Platform isDarwin Platform isSnowLeopardOrLater throw new RestartNotSupportedException Restart is not supported on Mac OS X if args null throw new RestartNotSupportedException Failed to obtain the command line arguments of the process failedToObtainArgspackage jenkins slaves restarter import com sun akuma Daemon import com sun akuma JavaVMArguments import com sun jna Native import com sun jna StringArray import hudson Extension import java io File import java io IOException import java util logging Logger import static hudson util jna GNUCLibrary import static java util logging Level Extension public class UnixSlaveRestarter extends SlaveRestarter private transient JavaVMArguments args Override public boolean canWork try if File pathSeparatorChar return false quick test to reject non Unix without loading all the rest of the classes args JavaVMArguments current go through the whole motion to make sure all the relevant classes are loaded now LIBC getdtablesize int v LIBC fcntl 99999 F GETFD LIBC fcntl 99999 F SETFD v Daemon getCurrentExecutable LIBC execv positively no such executable new StringArray new String a b c return true catch UnsupportedOperationException e LOGGER log FINE getClass unsuitable e return false catch LinkageError e LOGGER log FINE getClass unsuitable e return false catch IOException e LOGGER log FINE getClass unsuitable e return false public void restart throws Exception close all files upon exec except stdin stdout and stderr int sz LIBC getdtablesize for int i 3 i sz i int flags LIBC fcntl i F GETFD if flags 0 continue LIBC fcntl i F SETFD flags FD CLOEXEC exec to self String exe Daemon getCurrentExecutable LIBC execv exe new StringArray args toArray new String args size throw new IOException Failed to exec exe LIBC strerror Native getLastError private static final Logger LOGGER Logger getLogger UnixSlaveRestarter class getName private static final long serialVersionUID 1Lpackage jenkins model import hudson model Computer import hudson model LoadStatistics import hudson model Node import hudson model Node Mode import hudson model OverallLoadStatistics import hudson model Queue import hudson model Queue Task import hudson model queue SubTask import hudson util Iterators import java util Iterator public class UnlabeledLoadStatistics extends LoadStatistics private final Iterable Node nodes new UnlabeledNodesIterable UnlabeledLoadStatistics super 0 0 Override public int computeIdleExecutors int r 0 for Computer c Jenkins getInstance getComputers Node node c getNode if node null node getMode Mode NORMAL c isOnline c isConnecting c isAcceptingTasks r c countIdle return r Override public int computeTotalExecutors int r 0 for Computer c Jenkins getInstance getComputers Node node c getNode if node null node getMode Mode NORMAL c isOnline r c countExecutors return r Override public int computeQueueLength return Jenkins getInstance getQueue strictCountBuildableItemsFor null Override protected Iterable Node getNodes return nodes Override protected boolean matches Queue Item item SubTask subTask return item getAssignedLabelFor subTask null private static class UnlabeledNodesIterable implements Iterable Node Override public Iterator Node iterator return new UnlabeledNodesIterator private static class UnlabeledNodesIterator extends Iterators FilterIterator Node protected UnlabeledNodesIterator super Jenkins getActiveInstance getNodes iterator Override protected boolean filter Node n return n null n getMode Mode NORMAL public void remove why does Iterators FilterIterator do the stupid thing and allow remove remove should remove the object last returned by next but it won t if hasNext is called the way Iterators FilterIterator is written it should just return a read only view which is what we do throw new UnsupportedOperationException removepackage hudson model import hudson ExtensionPoint public interface UnprotectedRootAction extends RootAction ExtensionPointpackage hudson security import org apache commons jelly JellyTagException import org acegisecurity AcegiSecurityException import org acegisecurity ui ExceptionTranslationFilter import javax servlet Filter import javax servlet FilterConfig import javax servlet ServletException import javax servlet ServletRequest import javax servlet ServletResponse import javax servlet FilterChain import java io IOException public class UnwrapSecurityExceptionFilter implements Filter public void init FilterConfig filterConfig throws ServletException public void doFilter ServletRequest request ServletResponse response FilterChain chain throws IOException ServletException try chain doFilter request response catch ServletException e Throwable t e getRootCause if t instanceof JellyTagException JellyTagException jte JellyTagException t Throwable cause jte getCause if cause instanceof AcegiSecurityException AcegiSecurityException se AcegiSecurityException cause throw new ServletException se throw e public void destroypackage hudson model import hudson BulkChange import hudson Extension import hudson ExtensionPoint import hudson Functions import hudson PluginManager import hudson PluginWrapper import hudson ProxyConfiguration import hudson security ACLContext import jenkins util SystemProperties import hudson Util import hudson XmlFile import static hudson init InitMilestone PLUGINS STARTED import static java util logging Level INFO import static java util logging Level WARNING import hudson init Initializer import hudson lifecycle Lifecycle import hudson lifecycle RestartNotSupportedException import hudson model UpdateSite Data import hudson model UpdateSite Plugin import hudson model listeners SaveableListener import hudson remoting AtmostOneThreadExecutor import hudson security ACL import hudson util DaemonThreadFactory import hudson util FormValidation import hudson util HttpResponses import hudson util NamingThreadFactory import hudson util IOException2 import hudson util IOUtils import hudson util PersistedList import hudson util XStream2 import jenkins MissingDependencyException import jenkins RestartRequiredException import jenkins install InstallUtil import jenkins model Jenkins import jenkins util io OnMaster import net sf json JSONObject import org acegisecurity Authentication import org acegisecurity context SecurityContext import org apache commons codec binary Base64 import org apache commons io input CountingInputStream import org apache commons io output NullOutputStream import org jenkinsci Symbol import org jvnet localizer Localizable import org kohsuke accmod restrictions DoNotUse import org kohsuke stapler HttpResponse import org kohsuke stapler StaplerRequest import org kohsuke stapler StaplerResponse import javax annotation Nonnull import javax net ssl SSLHandshakeException import javax servlet ServletException import java io File import java io FileOutputStream import java io IOException import java io OutputStream import java lang reflect Constructor import java net HttpRetryException import java net HttpURLConnection import java net MalformedURLException import java net URL import java net URLConnection import java net UnknownHostException import java security DigestOutputStream import java security MessageDigest import java security NoSuchAlgorithmException import java util ArrayList import java util Collections import java util HashMap import java util HashSet import java util LinkedHashMap import java util List import java util Map import java util Set import java util TreeSet import java util UUID import java util Vector import java util concurrent ConcurrentHashMap import java util concurrent ExecutionException import java util concurrent ExecutorService import java util concurrent Executors import java util concurrent Future import java util concurrent atomic AtomicInteger import java util jar Attributes import java util jar JarFile import java util logging Level import java util logging Logger import javax annotation CheckForNull import org acegisecurity context SecurityContextHolder import org kohsuke accmod Restricted import org kohsuke accmod restrictions NoExternalUse import org kohsuke stapler export Exported import org kohsuke stapler export ExportedBean import org kohsuke stapler interceptor RequirePOST ExportedBean public class UpdateCenter extends AbstractModelObject implements Saveable OnMaster private static final String UPDATE CENTER URL SystemProperties getString UpdateCenter class getName updateCenterUrl http updates jenkins ci org private static final int PLUGIN DOWNLOAD READ TIMEOUT SystemProperties getInteger UpdateCenter class getName pluginDownloadReadTimeoutSeconds 60 1000 public static final String PREDEFINED UPDATE SITE ID default public static final String ID DEFAULT SystemProperties getString UpdateCenter class getName defaultUpdateSiteId PREDEFINED UPDATE SITE ID Restricted NoExternalUse class public static final String ID UPLOAD upload private final ExecutorService installerService new AtmostOneThreadExecutor new NamingThreadFactory new DaemonThreadFactory Update center installer thread protected final ExecutorService updateService Executors newCachedThreadPool new NamingThreadFactory new DaemonThreadFactory Update site data downloader private final Vector UpdateCenterJob jobs new Vector UpdateCenterJob private final Set UpdateSite sourcesUsed new HashSet UpdateSite private final PersistedList UpdateSite sites new PersistedList UpdateSite this private UpdateCenterConfiguration config private boolean requiresRestart Restricted NoExternalUse class static enum ConnectionStatus PRECHECK SKIPPED CHECKING UNCHECKED OK FAILED static final String INTERNET internet static final String UPDATE SITE updatesite public UpdateCenter configure new UpdateCenterConfiguration UpdateCenter Nonnull UpdateCenterConfiguration configuration configure configuration Nonnull public static UpdateCenter createUpdateCenter CheckForNull UpdateCenterConfiguration config String requiredClassName SystemProperties getString UpdateCenter class getName className null if requiredClassName null Use the defaul Update Center LOGGER log Level FINE Using the default Update Center implementation return createDefaultUpdateCenter config LOGGER log Level FINE Using the custom update center 0 requiredClassName try final Class clazz Class forName requiredClassName asSubclass UpdateCenter class if UpdateCenter class isAssignableFrom clazz LOGGER log Level SEVERE The specified custom Update Center 0 is not an instance of 1 Falling back to default new Object requiredClassName UpdateCenter class getName return createDefaultUpdateCenter config final Class extends UpdateCenter ucClazz clazz asSubclass UpdateCenter class final Constructor extends UpdateCenter defaultConstructor ucClazz getConstructor final Constructor extends UpdateCenter configConstructor ucClazz getConstructor UpdateCenterConfiguration class LOGGER log Level FINE Using the constructor 0 Update Center configuration for 1 new Object config null with without requiredClassName return config null configConstructor newInstance config defaultConstructor newInstance catch ClassCastException e Should never happen LOGGER log WARNING UpdateCenter class 0 does not extend hudson model UpdateCenter Using default requiredClassName catch NoSuchMethodException e LOGGER log WARNING String format UpdateCenter class s does not define one of the required constructors Using default requiredClassName e catch Exception e LOGGER log WARNING String format Unable to instantiate custom plugin manager s Using default requiredClassName e return createDefaultUpdateCenter config Nonnull private static UpdateCenter createDefaultUpdateCenter CheckForNull UpdateCenterConfiguration config return config null new UpdateCenter config new UpdateCenter public Api getApi Jenkins getInstance checkPermission Jenkins ADMINISTER return new Api this public void configure UpdateCenterConfiguration config if config null this config config Exported public List UpdateCenterJob getJobs synchronized jobs return new ArrayList UpdateCenterJob jobs public UpdateCenterJob getJob int id synchronized jobs for UpdateCenterJob job jobs if job id id return job return null public InstallationJob getJob Plugin plugin List UpdateCenterJob jobList getJobs Collections reverse jobList for UpdateCenterJob job jobList if job instanceof InstallationJob InstallationJob ij InstallationJob job if ij plugin name equals plugin name ij plugin sourceId equals plugin sourceId return ij return null Restricted DoNotUse class public HttpResponse doConnectionStatus StaplerRequest request Jenkins getInstance checkPermission Jenkins ADMINISTER try String siteId request getParameter siteId if siteId null siteId ID DEFAULT else if siteId equals default If the request explicitly requires the default ID ship it siteId ID DEFAULT ConnectionCheckJob checkJob getConnectionCheckJob siteId if checkJob null UpdateSite site getSite siteId if site null checkJob addConnectionCheckJob site if checkJob null boolean isOffline false for ConnectionStatus status checkJob connectionStates values if ConnectionStatus FAILED equals status isOffline true break if isOffline retry connection states if determined to be offline checkJob run isOffline false for ConnectionStatus status checkJob connectionStates values if ConnectionStatus FAILED equals status isOffline true break if isOffline also need to download the metadata updateAllSites return HttpResponses okJSON checkJob connectionStates else return HttpResponses errorJSON String format Cannot check connection status of the update site with ID s This update center cannot be resolved siteId catch Exception e return HttpResponses errorJSON String format ERROR s e getMessage Restricted DoNotUse class WebOnly public HttpResponse doIncompleteInstallStatus Jenkins getInstance checkPermission Jenkins ADMINISTER try Map String String jobs InstallUtil getPersistedInstallStatus if jobs null jobs Collections emptyMap return HttpResponses okJSON jobs catch Exception e return HttpResponses errorJSON String format ERROR s e getMessage Restricted NoExternalUse class public synchronized void persistInstallStatus List UpdateCenterJob jobs getJobs boolean activeInstalls false for UpdateCenterJob job jobs if job instanceof InstallationJob InstallationJob installationJob InstallationJob job if installationJob status isSuccess activeInstalls true if activeInstalls InstallUtil persistInstallStatus jobs save this info else InstallUtil clearInstallStatus clear this info Restricted DoNotUse class public HttpResponse doInstallStatus StaplerRequest request Jenkins getInstance checkPermission Jenkins ADMINISTER try String correlationId request getParameter correlationId Map String Object response new HashMap response put state Jenkins getInstance getInstallState name List Map String String installStates new ArrayList response put jobs installStates List UpdateCenterJob jobCopy getJobs for UpdateCenterJob job jobCopy if job instanceof InstallationJob UUID jobCorrelationId job getCorrelationId if correlationId null jobCorrelationId null correlationId equals jobCorrelationId toString InstallationJob installationJob InstallationJob job Map String String pluginInfo new LinkedHashMap pluginInfo put name installationJob plugin name pluginInfo put version installationJob plugin version pluginInfo put title installationJob plugin title pluginInfo put installStatus installationJob status getType pluginInfo put requiresRestart Boolean toString installationJob status requiresRestart if jobCorrelationId null pluginInfo put correlationId jobCorrelationId toString installStates add pluginInfo return HttpResponses okJSON JSONObject fromObject response catch Exception e return HttpResponses errorJSON String format ERROR s e getMessage public HudsonUpgradeJob getHudsonJob List UpdateCenterJob jobList getJobs Collections reverse jobList for UpdateCenterJob job jobList if job instanceof HudsonUpgradeJob return HudsonUpgradeJob job return null public PersistedList UpdateSite getSites return sites Exported name sites public List UpdateSite getSiteList return sites toList CheckForNull public UpdateSite getSite String id return getById id public String getLastUpdatedString long newestTs 0 for UpdateSite s sites if s getDataTimestamp newestTs newestTs s getDataTimestamp if newestTs 0 return Messages UpdateCenter n a return Util getPastTimeString System currentTimeMillis newestTs CheckForNull public UpdateSite getById String id for UpdateSite s sites if s getId equals id return s return null CheckForNull public UpdateSite getCoreSource for UpdateSite s sites Data data s getData if data null data core null return s return null Deprecated public String getDefaultBaseUrl return config getUpdateCenterUrl public CheckForNull Plugin getPlugin String artifactId for UpdateSite s sites Plugin p s getPlugin artifactId if p null return p return null RequirePOST public void doUpgrade StaplerResponse rsp throws IOException ServletException Jenkins getInstance checkPermission Jenkins ADMINISTER HudsonUpgradeJob job new HudsonUpgradeJob getCoreSource Jenkins getAuthentication if Lifecycle get canRewriteHudsonWar sendError Jenkins upgrade not supported in this running mode return LOGGER info Scheduling the core upgrade addJob job rsp sendRedirect2 public HttpResponse doInvalidateData Jenkins getInstance checkPermission Jenkins ADMINISTER for UpdateSite site sites site doInvalidateData return HttpResponses ok public void doSafeRestart StaplerRequest request StaplerResponse response throws IOException ServletException synchronized jobs if isRestartScheduled Jenkins getInstance checkPermission Jenkins ADMINISTER addJob new RestartJenkinsJob getCoreSource LOGGER info Scheduling Jenkins reboot response sendRedirect2 public void doCancelRestart StaplerResponse response throws IOException ServletException synchronized jobs for UpdateCenterJob job jobs if job instanceof RestartJenkinsJob if RestartJenkinsJob job cancel LOGGER info Scheduled Jenkins reboot unscheduled response sendRedirect2 Exported public boolean isRestartRequiredForCompletion return requiresRestart public boolean isRestartScheduled for UpdateCenterJob job getJobs if job instanceof RestartJenkinsJob RestartJenkinsJob RestartJenkinsJobStatus status RestartJenkinsJob job status if status instanceof RestartJenkinsJob Pending status instanceof RestartJenkinsJob Running return true return false public boolean isDowngradable return new File Lifecycle get getHudsonWar bak exists RequirePOST public void doDowngrade StaplerResponse rsp throws IOException ServletException Jenkins getInstance checkPermission Jenkins ADMINISTER if isDowngradable sendError Jenkins downgrade is not possible probably backup does not exist return HudsonDowngradeJob job new HudsonDowngradeJob getCoreSource Jenkins getAuthentication LOGGER info Scheduling the core downgrade addJob job rsp sendRedirect2 public void doRestart StaplerResponse rsp throws IOException ServletException Jenkins getInstance checkPermission Jenkins ADMINISTER HudsonDowngradeJob job new HudsonDowngradeJob getCoreSource Jenkins getAuthentication LOGGER info Scheduling the core downgrade addJob job rsp sendRedirect2 public String getBackupVersion try try JarFile backupWar new JarFile new File Lifecycle get getHudsonWar bak Attributes attrs backupWar getManifest getMainAttributes String v attrs getValue Jenkins Version if v null v attrs getValue Hudson Version return v catch IOException e LOGGER log Level WARNING Failed to read backup version e return null synchronized Future UpdateCenterJob addJob UpdateCenterJob job addConnectionCheckJob job site return job submit private Nonnull ConnectionCheckJob addConnectionCheckJob Nonnull UpdateSite site Create a connection check job if the site was not already in the sourcesUsed set i e the first job in the jobs list relating to a site must be the connection check job if sourcesUsed add site ConnectionCheckJob connectionCheckJob newConnectionCheckJob site connectionCheckJob submit return connectionCheckJob else Find the existing connection check job for that site and return it ConnectionCheckJob connectionCheckJob getConnectionCheckJob site if connectionCheckJob null return connectionCheckJob else throw new IllegalStateException Illegal addition of an UpdateCenter job without calling UpdateCenter addJob No ConnectionCheckJob found for the site Restricted NoExternalUse class ConnectionCheckJob newConnectionCheckJob UpdateSite site return new ConnectionCheckJob site private CheckForNull ConnectionCheckJob getConnectionCheckJob Nonnull String siteId UpdateSite site getSite siteId if site null return null return getConnectionCheckJob site private CheckForNull ConnectionCheckJob getConnectionCheckJob Nonnull UpdateSite site synchronized jobs for UpdateCenterJob job jobs if job instanceof ConnectionCheckJob job site getId equals site getId return ConnectionCheckJob job return null public String getDisplayName return Update center public String getSearchUrl return updateCenter public synchronized void save if BulkChange contains this return try getConfigFile write sites SaveableListener fireOnChange this getConfigFile catch IOException e LOGGER log Level WARNING Failed to save getConfigFile e public synchronized void load throws IOException XmlFile file getConfigFile if file exists try sites replaceBy PersistedList file unmarshal sites toList catch IOException e LOGGER log Level WARNING Failed to load file e boolean defaultSiteExists false for UpdateSite site sites replace the legacy site with the new site if site isLegacyDefault sites remove site else if ID DEFAULT equals site getId defaultSiteExists true if defaultSiteExists sites add createDefaultUpdateSite else if sites isEmpty If there aren t already any UpdateSources add the default one to maintain compatibility with existing UpdateCenterConfiguration create the default one as specified by UpdateCenterConfiguration sites add createDefaultUpdateSite protected UpdateSite createDefaultUpdateSite return new UpdateSite PREDEFINED UPDATE SITE ID config getUpdateCenterUrl update center json private XmlFile getConfigFile return new XmlFile XSTREAM new File Jenkins getInstance root UpdateCenter class getName xml Exported public List Plugin getAvailables Map String Plugin pluginMap new LinkedHashMap String Plugin for UpdateSite site sites for Plugin plugin site getAvailables final Plugin existing pluginMap get plugin name if existing null pluginMap put plugin name plugin else if existing version equals plugin version allow secondary update centers to publish different versions TODO refactor to consolidate multiple versions of the same plugin within the one row final String altKey plugin name plugin version if pluginMap containsKey altKey pluginMap put altKey plugin return new ArrayList Plugin pluginMap values public PluginEntry getCategorizedAvailables TreeSet PluginEntry entries new TreeSet PluginEntry for Plugin p getAvailables if p categories null p categories length 0 entries add new PluginEntry p getCategoryDisplayName null else for String c p categories entries add new PluginEntry p getCategoryDisplayName c return entries toArray new PluginEntry entries size private static String getCategoryDisplayName String category if category null return Messages UpdateCenter PluginCategory misc try return String Messages class getMethod UpdateCenter PluginCategory category replace invoke null catch Exception ex return Messages UpdateCenter PluginCategory unrecognized category public List Plugin getUpdates Map String Plugin pluginMap new LinkedHashMap String Plugin for UpdateSite site sites for Plugin plugin site getUpdates final Plugin existing pluginMap get plugin name if existing null pluginMap put plugin name plugin else if existing version equals plugin version allow secondary update centers to publish different versions TODO refactor to consolidate multiple versions of the same plugin within the one row final String altKey plugin name plugin version if pluginMap containsKey altKey pluginMap put altKey plugin return new ArrayList Plugin pluginMap values public List FormValidation updateAllSites throws InterruptedException ExecutionException List Future FormValidation futures new ArrayList Future FormValidation for UpdateSite site getSites Future FormValidation future site updateDirectly DownloadService signatureCheck if future null futures add future List FormValidation results new ArrayList FormValidation for Future FormValidation f futures results add f get return results Extension Symbol coreUpdate public static final class CoreUpdateMonitor extends AdministrativeMonitor Override public String getDisplayName return Messages UpdateCenter CoreUpdateMonitor DisplayName public boolean isActivated Data data getData return data null data hasCoreUpdates public Data getData UpdateSite cs Jenkins getInstance getUpdateCenter getCoreSource if cs null return cs getData return null SuppressWarnings UnusedDeclaration public static class UpdateCenterConfiguration implements ExtensionPoint public UpdateCenterConfiguration public void checkConnection ConnectionCheckJob job String connectionCheckUrl throws IOException testConnection new URL connectionCheckUrl public void checkUpdateCenter ConnectionCheckJob job String updateCenterUrl throws IOException testConnection toUpdateCenterCheckUrl updateCenterUrl static URL toUpdateCenterCheckUrl String updateCenterUrl throws MalformedURLException URL url if updateCenterUrl startsWith http updateCenterUrl startsWith https url new URL updateCenterUrl updateCenterUrl indexOf 1 uctest uctest else url new URL updateCenterUrl return url public void preValidate DownloadJob job URL src throws IOException public void postValidate DownloadJob job File src throws IOException public File download DownloadJob job URL src throws IOException MessageDigest sha1 null try sha1 MessageDigest getInstance SHA 1 catch NoSuchAlgorithmException ignored Irrelevant as the Java spec says SHA 1 must exist Still if this fails the DownloadJob will just have computedSha1 null and that is expected to be handled by caller CountingInputStream in null OutputStream out null URLConnection con null try con connect job src JENKINS 34174 set timeout for downloads may hang indefinitely particularly noticeable during 2 0 install when downloading many plugins con setReadTimeout PLUGIN DOWNLOAD READ TIMEOUT int total con getContentLength in new CountingInputStream con getInputStream byte buf new byte 8192 int len File dst job getDestination File tmp new File dst getPath tmp out new FileOutputStream tmp if sha1 null out new DigestOutputStream out sha1 LOGGER info Downloading job getName Thread t Thread currentThread String oldName t getName t setName oldName src try while len in read buf 0 out write buf 0 len job status job new Installing total 1 1 in getCount 100 total catch IOException e throw new IOException Failed to load src to tmp e finally IOUtils closeQuietly out t setName oldName if total 1 total tmp length don t know exactly how this happens but report like http www ashlux com wordpress 2009 08 14 hudson and the sonar plugin fail maveninstallation nosuchmethoderror indicates that this kind of inconsistency can happen So let s be defensive throw new IOException Inconsistent file length expected total but only got tmp length if sha1 null byte digest sha1 digest job computedSHA1 Base64 encodeBase64String digest return tmp catch IOException e assist troubleshooting in case of e g too many redirects by printing actual URL String extraMessage if con null con getURL null src toString equals con getURL toString Two URLs are considered equal if different hosts resolve to same IP Prefer to log in case of string inequality because who knows how the server responds to different host name in the request header Also since it involved name resolution it d be an expensive operation extraMessage redirected to con getURL throw new IOException2 Failed to download from src extraMessage e finally IOUtils closeQuietly in IOUtils closeQuietly out protected URLConnection connect DownloadJob job URL src throws IOException return ProxyConfiguration open src public void install DownloadJob job File src File dst throws IOException job replace dst src public void upgrade DownloadJob job File src File dst throws IOException job replace dst src Deprecated public String getConnectionCheckUrl return http www google com Deprecated public String getUpdateCenterUrl return UPDATE CENTER URL Deprecated public String getPluginRepositoryBaseUrl return http jenkins ci org private void testConnection URL url throws IOException try URLConnection connection URLConnection ProxyConfiguration open url if connection instanceof HttpURLConnection int responseCode HttpURLConnection connection getResponseCode if HttpURLConnection HTTP OK responseCode throw new HttpRetryException Invalid response code responseCode from URL url responseCode else Util copyStreamAndClose connection getInputStream new NullOutputStream catch SSLHandshakeException e if e getMessage contains PKIX path building failed fix up this crappy error message from JDK throw new IOException Failed to validate the SSL certificate of url e ExportedBean public abstract class UpdateCenterJob implements Runnable Exported public final int id iota incrementAndGet public final UpdateSite site private UUID correlationId null protected Throwable error protected UpdateCenterJob UpdateSite site this site site public Api getApi return new Api this public UUID getCorrelationId return correlationId public void setCorrelationId UUID correlationId if this correlationId null throw new IllegalStateException Illegal call to set the correlationId Already set this correlationId correlationId Deprecated public void schedule submit Exported public String getType return getClass getSimpleName public Future UpdateCenterJob submit LOGGER fine Scheduling this to installerService TODO seems like this access to jobs should be synchronized no It might get synch d accidentally via the addJob method but that wouldn t be good jobs add this return installerService submit this this Exported public String getErrorMessage return error null error getMessage null public Throwable getError return error public class RestartJenkinsJob extends UpdateCenterJob Exported inline true public volatile RestartJenkinsJobStatus status new Pending private String authentication public synchronized boolean cancel if status instanceof Pending status new Canceled return true return false public RestartJenkinsJob UpdateSite site super site this authentication Jenkins getAuthentication getName public synchronized void run if status instanceof Pending return status new Running try safeRestart records the current authentication for the log so set it to the managing user try ACLContext ACL as User get authentication false Collections emptyMap Jenkins getInstance safeRestart catch RestartNotSupportedException exception ignore if restart is not allowed status new Failure error exception ExportedBean public abstract class RestartJenkinsJobStatus Exported public final int id iota incrementAndGet public class Pending extends RestartJenkinsJobStatus Exported public String getType return getClass getSimpleName public class Running extends RestartJenkinsJobStatus public class Failure extends RestartJenkinsJobStatus public class Canceled extends RestartJenkinsJobStatus public final class ConnectionCheckJob extends UpdateCenterJob private final Vector String statuses new Vector String final Map String ConnectionStatus connectionStates new ConcurrentHashMap public ConnectionCheckJob UpdateSite site super site connectionStates put ConnectionStatus INTERNET ConnectionStatus PRECHECK connectionStates put ConnectionStatus UPDATE SITE ConnectionStatus PRECHECK public void run connectionStates put ConnectionStatus INTERNET ConnectionStatus UNCHECKED connectionStates put ConnectionStatus UPDATE SITE ConnectionStatus UNCHECKED if ID UPLOAD equals site getId return LOGGER fine Doing a connectivity check Future internetCheck null try final String connectionCheckUrl site getConnectionCheckUrl if connectionCheckUrl null connectionStates put ConnectionStatus INTERNET ConnectionStatus CHECKING statuses add Messages UpdateCenter Status CheckingInternet Run the internet check in parallel internetCheck updateService submit new Runnable Override public void run try config checkConnection ConnectionCheckJob this connectionCheckUrl catch Exception e if e getMessage contains Connection timed out Google can t be down so this is probably a proxy issue connectionStates put ConnectionStatus INTERNET ConnectionStatus FAILED statuses add Messages UpdateCenter Status ConnectionFailed connectionCheckUrl return connectionStates put ConnectionStatus INTERNET ConnectionStatus OK else LOGGER log WARNING Update site 0 does not declare the connection check URL Skipping the network availability check site getId connectionStates put ConnectionStatus INTERNET ConnectionStatus SKIPPED connectionStates put ConnectionStatus UPDATE SITE ConnectionStatus CHECKING statuses add Messages UpdateCenter Status CheckingJavaNet config checkUpdateCenter this site getUrl connectionStates put ConnectionStatus UPDATE SITE ConnectionStatus OK statuses add Messages UpdateCenter Status Success catch UnknownHostException e connectionStates put ConnectionStatus UPDATE SITE ConnectionStatus FAILED statuses add Messages UpdateCenter Status UnknownHostException e getMessage addStatus e error e catch Exception e connectionStates put ConnectionStatus UPDATE SITE ConnectionStatus FAILED statuses add Functions printThrowable e error e if internetCheck null try Wait for internet check to complete internetCheck get catch Exception e LOGGER log Level WARNING Error completing internet connectivity check e getMessage e private void addStatus UnknownHostException e statuses add pre Functions xmlEscape Functions printThrowable e pre public String getStatuses synchronized statuses return statuses toArray new String statuses size public class EnableJob extends InstallationJob public EnableJob UpdateSite site Authentication auth Nonnull Plugin plugin boolean dynamicLoad super plugin site auth dynamicLoad public Plugin getPlugin return plugin Override public void run try PluginWrapper installed plugin getInstalled synchronized installed if installed isEnabled try installed enable catch IOException e LOGGER log Level SEVERE Failed to enable plugin getDisplayName e error e status new Failure e if dynamicLoad try remove the existing disabled inactive plugin to force a new one to load pm dynamicLoad getDestination true catch Exception e LOGGER log Level SEVERE Failed to dynamically load plugin getDisplayName e error e requiresRestart true status new Failure e else requiresRestart true catch Throwable e LOGGER log Level SEVERE An unexpected error occurred while attempting to enable plugin getDisplayName e error e requiresRestart true status new Failure e if status instanceof Pending status new Success public class NoOpJob extends EnableJob public NoOpJob UpdateSite site Authentication auth Nonnull Plugin plugin super site auth plugin false Override public void run do nothing status new Success public abstract class DownloadJob extends UpdateCenterJob Exported inline true public volatile InstallationStatus status new Pending protected abstract URL getURL throws MalformedURLException protected abstract File getDestination Exported public abstract String getName protected abstract void onSuccess CheckForNull protected String getComputedSHA1 return computedSHA1 private String computedSHA1 private Authentication authentication public Authentication getUser return this authentication protected DownloadJob UpdateSite site Authentication authentication super site this authentication authentication public void run try LOGGER info Starting the installation of getName on behalf of getUser getName run LOGGER info Installation successful getName status new Success onSuccess catch InstallationStatus e status e if status isSuccess onSuccess requiresRestart status requiresRestart catch MissingDependencyException e LOGGER log Level SEVERE Failed to install 0 1 new Object getName e getMessage status new Failure e error e catch Throwable e LOGGER log Level SEVERE Failed to install getName e status new Failure e error e protected void run throws IOException InstallationStatus URL src getURL config preValidate this src File dst getDestination File tmp config download this src config postValidate this tmp config install this tmp dst protected void replace File dst File src throws IOException File bak Util changeExtension dst bak bak delete dst renameTo bak dst delete any failure up to here is no big deal if src renameTo dst throw new IOException Failed to rename src to dst ExportedBean public abstract class InstallationStatus extends Throwable public final int id iota incrementAndGet Exported public boolean isSuccess return false Exported public final String getType return getClass getSimpleName public boolean requiresRestart return false public class Failure extends InstallationStatus public final Throwable problem public Failure Throwable problem this problem problem public String getProblemStackTrace return Functions printThrowable problem public class SuccessButRequiresRestart extends Success private final Localizable message public SuccessButRequiresRestart Localizable message this message message public String getMessage return message toString Override public boolean requiresRestart return true public class Success extends InstallationStatus Override public boolean isSuccess return true public class Skipped extends InstallationStatus Override public boolean isSuccess return true public class Pending extends InstallationStatus public class Installing extends InstallationStatus public final int percentage public Installing int percentage this percentage percentage private void verifyChecksums String expectedSHA1 String actualSha1 File downloadedFile throws IOException if expectedSHA1 null if actualSha1 null refuse to install if SHA 1 could not be computed throw new IOException Failed to compute SHA 1 of downloaded file refusing installation if expectedSHA1 equals actualSha1 throw new IOException Downloaded file downloadedFile getAbsolutePath does not match expected SHA 1 expected expectedSHA1 actual actualSha1 keep downloadedFile around for investigating what s going on public class InstallationJob extends DownloadJob Exported public final Plugin plugin protected final PluginManager pm Jenkins getInstance getPluginManager protected final boolean dynamicLoad Deprecated public InstallationJob Plugin plugin UpdateSite site Authentication auth this plugin site auth false public InstallationJob Plugin plugin UpdateSite site Authentication auth boolean dynamicLoad super site auth this plugin plugin this dynamicLoad dynamicLoad protected URL getURL throws MalformedURLException return new URL plugin url protected File getDestination File baseDir pm rootDir return new File baseDir plugin name jpi private File getLegacyDestination File baseDir pm rootDir return new File baseDir plugin name hpi public String getName return plugin getDisplayName Override public void run throws IOException InstallationStatus if wasInstalled Do this first so we can avoid duplicate downloads too check to see if the plugin is already installed at the same version and skip it LOGGER info Skipping duplicate install of plugin getDisplayName plugin version throw new Skipped TODO set skipped once we have a status indicator for it return try super run if this is a bundled plugin make sure it won t get overwritten PluginWrapper pw plugin getInstalled if pw null pw isBundled SecurityContext oldContext ACL impersonate ACL SYSTEM try pw doPin finally SecurityContextHolder setContext oldContext if dynamicLoad try pm dynamicLoad getDestination catch RestartRequiredException e throw new SuccessButRequiresRestart e message catch Exception e throw new IOException Failed to dynamically deploy this plugin e else throw new SuccessButRequiresRestart Messages UpdateCenter DownloadButNotActivated finally synchronized this There may be other threads waiting on completion LOGGER fine Install complete for plugin getDisplayName plugin version some status other than Installing or Downloading needs to be set here link isAlreadyInstalling it will be overwritten by link DownloadJob run status new Skipped notifyAll protected boolean wasInstalled synchronized UpdateCenter this for UpdateCenterJob job getJobs if job this oldest entries first if we reach this instance we need it to continue installing return false if job instanceof InstallationJob InstallationJob ij InstallationJob job if ij plugin equals plugin ij plugin version equals plugin version wait until other install is completed synchronized ij if ij status instanceof Installing ij status instanceof Pending try LOGGER fine Waiting for other plugin install of plugin getDisplayName plugin version ij wait catch InterruptedException e throw new RuntimeException e return true return false protected void onSuccess pm pluginUploaded true Override public String toString return super toString plugin plugin title Override protected void replace File dst File src throws IOException verifyChecksums plugin getSha1 getComputedSHA1 src File bak Util changeExtension dst bak bak delete final File legacy getLegacyDestination if legacy exists if legacy renameTo bak legacy delete if dst exists if dst renameTo bak dst delete if src renameTo dst throw new IOException Failed to rename src to dst public final class PluginDowngradeJob extends DownloadJob public final Plugin plugin private final PluginManager pm Jenkins getInstance getPluginManager public PluginDowngradeJob Plugin plugin UpdateSite site Authentication auth super site auth this plugin plugin protected URL getURL throws MalformedURLException return new URL plugin url protected File getDestination File baseDir pm rootDir final File legacy new File baseDir plugin name hpi if legacy exists return legacy return new File baseDir plugin name jpi protected File getBackup File baseDir pm rootDir return new File baseDir plugin name bak public String getName return plugin getDisplayName Override public void run try LOGGER info Starting the downgrade of getName on behalf of getUser getName run LOGGER info Downgrade successful getName status new Success onSuccess catch Throwable e LOGGER log Level SEVERE Failed to downgrade getName e status new Failure e error e Override protected void run throws IOException File dst getDestination File backup getBackup config install this backup dst Override protected void replace File dst File backup throws IOException dst delete any failure up to here is no big deal if backup renameTo dst throw new IOException Failed to rename backup to dst protected void onSuccess pm pluginUploaded true Override public String toString return super toString plugin plugin title public final class HudsonUpgradeJob extends DownloadJob public HudsonUpgradeJob UpdateSite site Authentication auth super site auth protected URL getURL throws MalformedURLException return new URL site getData core url protected File getDestination return Lifecycle get getHudsonWar public String getName return jenkins war protected void onSuccess status new Success Override protected void replace File dst File src throws IOException String expectedSHA1 site getData core getSha1 verifyChecksums expectedSHA1 getComputedSHA1 src Lifecycle get rewriteHudsonWar src public final class HudsonDowngradeJob extends DownloadJob public HudsonDowngradeJob UpdateSite site Authentication auth super site auth protected URL getURL throws MalformedURLException return new URL site getData core url protected File getDestination return Lifecycle get getHudsonWar public String getName return jenkins war protected void onSuccess status new Success Override public void run try LOGGER info Starting the downgrade of getName on behalf of getUser getName run LOGGER info Downgrading successful getName status new Success onSuccess catch Throwable e LOGGER log Level SEVERE Failed to downgrade getName e status new Failure e error e Override protected void run throws IOException File backup new File Lifecycle get getHudsonWar bak File dst getDestination config install this backup dst Override protected void replace File dst File src throws IOException Lifecycle get rewriteHudsonWar src public static final class PluginEntry implements Comparable PluginEntry public Plugin plugin public String category private PluginEntry Plugin p String c plugin p category c public int compareTo PluginEntry o int r category compareTo o category if r 0 r plugin name compareToIgnoreCase o plugin name return r Extension public static class PageDecoratorImpl extends PageDecorator Initializer after PLUGINS STARTED fatal false public static void init Jenkins h throws IOException h getUpdateCenter load Restricted NoExternalUse class public static void updateDefaultSite final UpdateSite site Jenkins getInstance getUpdateCenter getSite UpdateCenter ID DEFAULT if site null LOGGER log Level SEVERE Upgrading Jenkins Cannot retrieve the default Update Site 0 Plugin installation may fail UpdateCenter ID DEFAULT return try Need to do the following because the plugin manager will attempt to access JENKINS HOME updates ID DEFAULT json Needs to be up to date site updateDirectlyNow true catch Exception e LOGGER log WARNING Upgrading Jenkins Failed to update the default Update Site UpdateCenter ID DEFAULT Plugin upgrades may fail e private static final AtomicInteger iota new AtomicInteger private static final Logger LOGGER Logger getLogger UpdateCenter class getName Deprecated public static boolean neverUpdate SystemProperties getBoolean UpdateCenter class getName never public static final XStream2 XSTREAM new XStream2 static XSTREAM alias site UpdateSite class XSTREAM alias sites PersistedList classpackage hudson cli import hudson Extension import hudson model AbstractItem import org kohsuke args4j Argument import javax xml transform Source import javax xml transform stream StreamSource Extension public class UpdateJobCommand extends CLICommand Argument metaVar JOB usage Name of the job required true public AbstractItem job Override public String getShortDescription return Messages UpdateJobCommand ShortDescription protected int run throws Exception job updateByXml Source new StreamSource stdin return 0package hudson cli import java io IOException import javax servlet ServletException import hudson Extension import hudson model Node import org kohsuke args4j Argument Extension public class UpdateNodeCommand extends CLICommand Argument metaVar NODE usage Name of the node required true public Node node Override public String getShortDescription return Messages UpdateNodeCommand ShortDescription Override protected int run throws IOException ServletException node toComputer updateByXml stdin return 0package hudson model import hudson ClassicPluginStrategy import hudson PluginManager import hudson PluginWrapper import hudson Util import hudson lifecycle Lifecycle import hudson model UpdateCenter UpdateCenterJob import hudson util FormValidation import hudson util FormValidation Kind import hudson util HttpResponses import hudson util TextFile import static hudson util TimeUnit2 import hudson util VersionNumber import java io File import java io IOException import java net URI import java net URL import java net URLEncoder import java security GeneralSecurityException import java util ArrayList import java util Collections import java util HashMap import java util List import java util Map import java util Set import java util TreeMap import java util UUID import java util concurrent Callable import java util concurrent Future import java util logging Level import java util logging Logger import javax annotation CheckForNull import javax annotation Nonnull import jenkins model Jenkins import jenkins model DownloadSettings import jenkins util JSONSignatureValidator import jenkins util SystemProperties import net sf json JSONException import net sf json JSONObject import org apache commons io IOUtils import org apache commons lang StringUtils import org kohsuke accmod Restricted import org kohsuke accmod restrictions NoExternalUse import org kohsuke stapler DataBoundConstructor import org kohsuke stapler HttpResponse import org kohsuke stapler StaplerRequest import org kohsuke stapler export Exported import org kohsuke stapler export ExportedBean import org kohsuke stapler interceptor RequirePOST ExportedBean public class UpdateSite private transient volatile long dataTimestamp private transient volatile long lastAttempt private transient volatile long retryWindow private transient long dataLastReadFromFile private transient Data data private final String id private final String url private static final String signatureValidatorPrefix update site public UpdateSite String id String url this id id this url url Exported public String getId return id Exported public long getDataTimestamp assert dataTimestamp 0 return dataTimestamp public CheckForNull Future FormValidation updateDirectly final boolean signatureCheck if getDataFile exists isDue return Jenkins getInstance getUpdateCenter updateService submit new Callable FormValidation Override public FormValidation call throws Exception return updateDirectlyNow signatureCheck else return null Restricted NoExternalUse class public Nonnull FormValidation updateDirectlyNow boolean signatureCheck throws IOException return updateData DownloadService loadJSON new URL getUrl id URLEncoder encode getId UTF 8 version URLEncoder encode Jenkins VERSION UTF 8 signatureCheck public FormValidation doPostBack StaplerRequest req throws IOException GeneralSecurityException DownloadSettings checkPostBackAccess return updateData IOUtils toString req getInputStream UTF 8 true private FormValidation updateData String json boolean signatureCheck throws IOException dataTimestamp System currentTimeMillis JSONObject o JSONObject fromObject json try int v o getInt updateCenterVersion if v 1 throw new IllegalArgumentException Unrecognized update center version v catch JSONException x throw new IllegalArgumentException Could not find numeric updateCenterVersion in json x if signatureCheck FormValidation e verifySignature o if e kind Kind OK LOGGER severe e toString return e LOGGER info Obtained the latest update center data file for UpdateSource id retryWindow 0 getDataFile write json return FormValidation ok public FormValidation doVerifySignature throws IOException return verifySignature getJSONObject protected UpdateCenter InstallationJob createInstallationJob Plugin plugin UpdateCenter uc boolean dynamicLoad return uc new InstallationJob plugin this Jenkins getAuthentication dynamicLoad private FormValidation verifySignature JSONObject o throws IOException return getJsonSignatureValidator verifySignature o Deprecated Nonnull protected JSONSignatureValidator getJsonSignatureValidator return getJsonSignatureValidator null Nonnull protected JSONSignatureValidator getJsonSignatureValidator CheckForNull String name if name null name signatureValidatorPrefix id return new JSONSignatureValidator name public boolean isDue if neverUpdate return false if dataTimestamp 0 dataTimestamp getDataFile file lastModified long now System currentTimeMillis retryWindow Math max retryWindow SECONDS toMillis 15 boolean due now dataTimestamp DAY now lastAttempt retryWindow if due lastAttempt now retryWindow Math min retryWindow 2 HOURS toMillis 1 exponential back off but at most 1 hour return due RequirePOST public HttpResponse doInvalidateData Jenkins getInstance checkPermission Jenkins ADMINISTER dataTimestamp 0 return HttpResponses ok public Data getData TextFile df getDataFile if df exists dataLastReadFromFile df file lastModified JSONObject o getJSONObject if o null data new Data o dataLastReadFromFile df file lastModified else data null return data public JSONObject getJSONObject TextFile df getDataFile if df exists try return JSONObject fromObject df read catch JSONException e LOGGER log Level SEVERE Failed to parse df e df delete if we keep this file it will cause repeated failures return null catch IOException e LOGGER log Level SEVERE Failed to parse df e df delete if we keep this file it will cause repeated failures return null else return null Exported public List Plugin getAvailables List Plugin r new ArrayList Plugin Data data getData if data null return Collections emptyList for Plugin p data plugins values if p getInstalled null r add p return r public Plugin getPlugin String artifactId Data dt getData if dt null return null return dt plugins get artifactId public Api getApi return new Api this Exported CheckForNull public String getConnectionCheckUrl Data dt getData if dt null return http www google com return dt connectionCheckUrl private TextFile getDataFile return new TextFile new File Jenkins getInstance getRootDir updates getId json Exported public List Plugin getUpdates Data data getData if data null return Collections emptyList fail to determine List Plugin r new ArrayList Plugin for PluginWrapper pw Jenkins getInstance getPluginManager getPlugins Plugin p pw getUpdateInfo if p null r add p return r Exported public boolean hasUpdates Data data getData if data null return false for PluginWrapper pw Jenkins getInstance getPluginManager getPlugins if pw isBundled pw getUpdateInfo null do not advertize updates to bundled plugins since we generally want users to get them as a part of jenkins war updates This also avoids unnecessary pinning of plugins return true return false Exported public String getUrl return url CheckForNull Restricted NoExternalUse class public String getMetadataUrlForDownloadable String downloadable String siteUrl getUrl String updateSiteMetadataUrl null int baseUrlEnd siteUrl indexOf update center json if baseUrlEnd 1 String siteBaseUrl siteUrl substring 0 baseUrlEnd updateSiteMetadataUrl siteBaseUrl updates downloadable else LOGGER log Level WARNING Url 0 does not look like an update center siteUrl return updateSiteMetadataUrl Deprecated public String getDownloadUrl if url equals http updates jenkins ci org update center json Jenkins getInstance isRootUrlSecure return https url substring 4 return url public boolean isLegacyDefault return id equals UpdateCenter PREDEFINED UPDATE SITE ID url startsWith http hudson ci org url startsWith http updates hudson labs org public final class Data public final String sourceId public final Entry core public final Map String Plugin plugins new TreeMap String Plugin String CASE INSENSITIVE ORDER public final String connectionCheckUrl Data JSONObject o this sourceId String o get id JSONObject c o optJSONObject core if c null core new Entry sourceId c url else core null for Map Entry String JSONObject e Set Map Entry String JSONObject o getJSONObject plugins entrySet Plugin p new Plugin sourceId e getValue JENKINS 33308 include implied dependencies for older plugins that may need them List PluginWrapper Dependency implicitDeps ClassicPluginStrategy getImpliedDependencies p name p requiredCore if implicitDeps isEmpty for PluginWrapper Dependency dep implicitDeps if p dependencies containsKey dep shortName p dependencies put dep shortName dep version plugins put e getKey p connectionCheckUrl String o get connectionCheckUrl public boolean hasCoreUpdates return core null core isNewerThan Jenkins VERSION public boolean canUpgrade return Lifecycle get canRewriteHudsonWar ExportedBean public static class Entry Exported public final String sourceId Exported public final String name Exported public final String version Exported public final String url non private non final for test Restricted NoExternalUse class String sha1 public Entry String sourceId JSONObject o this sourceId o null Entry String sourceId JSONObject o String baseURL this sourceId sourceId this name o getString name this version o getString version Trim this to prevent issues when the other end used Base64 encodeBase64String that added newlines to the end in old commons codec Not the case on updates jenkins ci org but let s be safe this sha1 Util fixEmptyAndTrim o optString sha1 String url o getString url if URI create url isAbsolute if baseURL null throw new IllegalArgumentException Cannot resolve url without a base URL url URI create baseURL resolve url toString this url url TODO Exported assuming we want this in the API public String getSha1 return sha1 public boolean isNewerThan String currentVersion try return new VersionNumber currentVersion compareTo new VersionNumber version 0 catch IllegalArgumentException e couldn t parse as the version number return false public Api getApi return new Api this public final class Plugin extends Entry Exported public final String wiki Exported public final String title Exported public final String excerpt Exported public final String compatibleSinceVersion Exported public final String requiredCore Exported public final String categories Exported public final Map String String dependencies new HashMap String String Exported public final Map String String optionalDependencies new HashMap String String DataBoundConstructor public Plugin String sourceId JSONObject o super sourceId o UpdateSite this url this wiki get o wiki this title get o title this excerpt get o excerpt this compatibleSinceVersion get o compatibleSinceVersion this requiredCore get o requiredCore this categories o has labels String o getJSONArray labels toArray new String 0 null for Object jo o getJSONArray dependencies JSONObject depObj JSONObject jo Make sure there s a name attribute and that the optional value isn t true if get depObj name null if get depObj optional equals false dependencies put get depObj name get depObj version else optionalDependencies put get depObj name get depObj version private String get JSONObject o String prop if o has prop return o getString prop else return null public String getDisplayName String displayName if title null displayName title else displayName name return StringUtils removeStart displayName Jenkins Exported public PluginWrapper getInstalled PluginManager pm Jenkins getInstance getPluginManager return pm getPlugin name Exported public boolean isCompatibleWithInstalledVersion PluginWrapper installedVersion getInstalled if installedVersion null if compatibleSinceVersion null if new VersionNumber installedVersion getVersion isOlderThan new VersionNumber compatibleSinceVersion return false return true Exported public List Plugin getNeededDependencies List Plugin deps new ArrayList Plugin for Map Entry String String e dependencies entrySet Plugin depPlugin Jenkins getInstance getUpdateCenter getPlugin e getKey if depPlugin null LOGGER log Level WARNING Could not find dependency 0 of 1 new Object e getKey name continue VersionNumber requiredVersion new VersionNumber e getValue Is the plugin installed already If not add it PluginWrapper current depPlugin getInstalled if current null deps add depPlugin If the dependency plugin is installed is the version we depend on newer than what s installed If so upgrade else if current isOlderThan requiredVersion deps add depPlugin JENKINS 34494 or if the plugin is disabled this will allow us to enable it else if current isEnabled deps add depPlugin for Map Entry String String e optionalDependencies entrySet Plugin depPlugin Jenkins getInstance getUpdateCenter getPlugin e getKey if depPlugin null continue VersionNumber requiredVersion new VersionNumber e getValue PluginWrapper current depPlugin getInstalled If the optional dependency plugin is installed is the version we depend on newer than what s installed If so upgrade if current null current isOlderThan requiredVersion deps add depPlugin return deps public boolean isForNewerHudson try return requiredCore null new VersionNumber requiredCore isNewerThan new VersionNumber Jenkins VERSION replaceFirst SHOT private SHOT catch NumberFormatException nfe return true If unable to parse version public VersionNumber getNeededDependenciesRequiredCore VersionNumber versionNumber null try versionNumber requiredCore null null new VersionNumber requiredCore catch NumberFormatException nfe unable to parse version for Plugin p getNeededDependencies VersionNumber v p getNeededDependenciesRequiredCore if versionNumber null v isNewerThan versionNumber versionNumber v return versionNumber public boolean isNeededDependenciesForNewerJenkins for Plugin p getNeededDependencies if p isForNewerHudson p isNeededDependenciesForNewerJenkins return true return false public boolean isNeededDependenciesCompatibleWithInstalledVersion for Plugin p getNeededDependencies if p isCompatibleWithInstalledVersion p isNeededDependenciesCompatibleWithInstalledVersion return false return true Deprecated public void install deploy public Future UpdateCenterJob deploy return deploy false public Future UpdateCenterJob deploy boolean dynamicLoad return deploy dynamicLoad null Restricted NoExternalUse class public Future UpdateCenterJob deploy boolean dynamicLoad CheckForNull UUID correlationId Jenkins getInstance checkPermission Jenkins ADMINISTER UpdateCenter uc Jenkins getInstance getUpdateCenter for Plugin dep getNeededDependencies UpdateCenter InstallationJob job uc getJob dep if job null job status instanceof UpdateCenter DownloadJob Failure LOGGER log Level INFO Adding dependent install of dep name for plugin name dep deploy dynamicLoad else LOGGER log Level INFO Dependent install of dep name for plugin name already added skipping PluginWrapper pw getInstalled if pw null JENKINS 34494 check for this plugin being disabled Future UpdateCenterJob enableJob null if pw isEnabled UpdateCenter EnableJob job uc new EnableJob UpdateSite this null this dynamicLoad job setCorrelationId correlationId enableJob uc addJob job if pw getVersionNumber equals new VersionNumber version return enableJob null enableJob uc addJob uc new NoOpJob UpdateSite this null this UpdateCenter InstallationJob job createInstallationJob this uc dynamicLoad job setCorrelationId correlationId return uc addJob job public Future UpdateCenterJob deployBackup Jenkins getInstance checkPermission Jenkins ADMINISTER UpdateCenter uc Jenkins getInstance getUpdateCenter return uc addJob uc new PluginDowngradeJob this UpdateSite this Jenkins getAuthentication RequirePOST public HttpResponse doInstall throws IOException deploy false return HttpResponses redirectTo RequirePOST public HttpResponse doInstallNow throws IOException deploy true return HttpResponses redirectTo RequirePOST public HttpResponse doDowngrade throws IOException deployBackup return HttpResponses redirectTo private static final long DAY DAYS toMillis 1 private static final Logger LOGGER Logger getLogger UpdateSite class getName The name uses UpdateCenter for compatibility reason public static boolean neverUpdate SystemProperties getBoolean UpdateCenter class getName neverpackage hudson cli import javax xml transform stream StreamSource import hudson Extension import hudson model View import org kohsuke args4j Argument Extension public class UpdateViewCommand extends CLICommand Argument usage Name of the view to update required true private View view Override public String getShortDescription return Messages UpdateViewCommand ShortDescription Override protected int run throws Exception view updateByXml new StreamSource stdin return 0package jenkins install import static java util logging Level FINE import java io File import java io IOException import java util concurrent TimeUnit import java util logging Level import java util logging Logger import javax inject Provider import javax servlet http HttpSession import org apache commons io FileUtils import org kohsuke accmod Restricted import org kohsuke accmod restrictions NoExternalUse import org kohsuke stapler HttpResponse import org kohsuke stapler Stapler import org kohsuke stapler WebApp import org kohsuke stapler interceptor RequirePOST import hudson Extension import hudson util HttpResponses import jenkins model Jenkins import net sf json JSONArray Restricted NoExternalUse class public class UpgradeWizard extends InstallState private volatile boolean isUpToDate true private static final String SHOW UPGRADE WIZARD FLAG UpgradeWizard class getName show UpgradeWizard super UPGRADE false public static UpgradeWizard get return UpgradeWizard InstallState UPGRADE Override public void initializeState Initializing this state is directly related to running the detached plugin checks these should be consolidated somehow updateUpToDate If there are no platform updates proceed to running if isUpToDate if Jenkins getInstance getSetupWizard getPlatformPluginUpdates isEmpty Jenkins getInstance setInstallState InstallState RUNNING Override public boolean isSetupComplete return isDue private void updateUpToDate If we don t have any platform plugins it s considered up to date in terms of the updater try JSONArray platformPlugins Jenkins getInstance getSetupWizard getPlatformPluginUpdates isUpToDate platformPlugins isEmpty catch Exception e LOGGER log Level WARNING Unable to get the platform plugin update list e public boolean isDue if isUpToDate return false only admin users should see this if Jenkins getInstance hasPermission Jenkins ADMINISTER return false only show when Jenkins is fully up running WebApp wa WebApp getCurrent if wa null wa getApp instanceof Jenkins return false return System currentTimeMillis SetupWizard getUpdateStateFile lastModified public boolean isShowUpgradeWizard HttpSession session Stapler getCurrentRequest getSession false if session null return Boolean TRUE equals session getAttribute SHOW UPGRADE WIZARD FLAG return false public HttpResponse doShowUpgradeWizard throws Exception Jenkins getInstance checkPermission Jenkins ADMINISTER HttpSession session Stapler getCurrentRequest getSession true session setAttribute SHOW UPGRADE WIZARD FLAG true return HttpResponses redirectToContextRoot public HttpResponse doHideUpgradeWizard Jenkins getInstance checkPermission Jenkins ADMINISTER HttpSession session Stapler getCurrentRequest getSession false if session null session removeAttribute SHOW UPGRADE WIZARD FLAG return HttpResponses redirectToContextRoot RequirePOST public HttpResponse doSnooze throws IOException Jenkins getInstance checkPermission Jenkins ADMINISTER File f SetupWizard getUpdateStateFile FileUtils touch f f setLastModified System currentTimeMillis TimeUnit DAYS toMillis 1 LOGGER log FINE Snoozed the upgrade wizard notice return HttpResponses redirectToContextRoot Extension public static class ListenForInstallComplete extends InstallStateFilter Override public InstallState getNextInstallState InstallState current Provider InstallState proceed InstallState next proceed get if InstallState INITIAL SETUP COMPLETED equals current UpgradeWizard get isUpToDate true return next private static final Logger LOGGER Logger getLogger UpgradeWizard class getNamepackage jenkins model import hudson Extension import hudson ExtensionList import hudson init InitMilestone import hudson init Initializer Extension public class Uptime private long startTime public long getStartTime return startTime public long getUptime return System currentTimeMillis startTime Initializer after InitMilestone JOB LOADED public void init startTime System currentTimeMillispackage hudson console import hudson Extension import hudson MarkupText import hudson MarkupText SubText import org jenkinsci Symbol import java util regex Pattern Extension Symbol url public class UrlAnnotator extends ConsoleAnnotatorFactory Object Override public ConsoleAnnotator newInstance Object context return new UrlConsoleAnnotator private static class UrlConsoleAnnotator extends ConsoleAnnotator public ConsoleAnnotator annotate Object context MarkupText text for SubText t text findTokens URL int prev t start 1 char ch prev 0 text charAt prev int idx OPEN indexOf ch if idx 0 if inside a bracket exclude the end bracket t t subText 0 t getText indexOf CLOSE charAt idx t href t getText return this private static final long serialVersionUID 1L private static final Pattern URL Pattern compile b http https file ftp s s private static final String OPEN private static final String CLOSEpackage hudson import java io IOException import java net URL import java net URLConnection public abstract class URLConnectionDecorator implements ExtensionPoint public abstract void decorate URLConnection con throws IOException public static ExtensionList URLConnectionDecorator all return ExtensionList lookup URLConnectionDecorator classpackage com twitter sdk android core models import com google gson annotations SerializedName public class UrlEntity extends Entity SerializedName url public final String url SerializedName expanded url public final String expandedUrl SerializedName display url public final String displayUrl public UrlEntity String url String expandedUrl String displayUrl int start int end super start end this url url this expandedUrl expandedUrl this displayUrl displayUrlpackage com kaku colorfulnews widget import android graphics drawable ColorDrawable import android graphics drawable Drawable import android support annotation NonNull import android support annotation Nullable import android text Html import android widget TextView import com kaku colorfulnews App import com kaku colorfulnews R import com kaku colorfulnews common HostType import com kaku colorfulnews repository network RetrofitManager import com kaku colorfulnews utils MyUtils import com socks library KLog import java io File import java io FileOutputStream import java io IOException import java io InputStream import okhttp3 ResponseBody import rx Subscriber import rx Subscription import rx android schedulers AndroidSchedulers import rx functions Func1 import rx schedulers Schedulers public class URLImageGetter implements Html ImageGetter private TextView mTextView private int mPicWidth private String mNewsBody private int mPicCount private int mPicTotal private static final String mFilePath App getAppContext getCacheDir getAbsolutePath public Subscription mSubscription public URLImageGetter TextView textView String newsBody int picTotal mTextView textView mPicWidth mTextView getWidth mNewsBody newsBody mPicTotal picTotal Override public Drawable getDrawable final String source Drawable drawable File file new File mFilePath source hashCode if file exists mPicCount drawable getDrawableFromDisk file else drawable getDrawableFromNet source return drawable Nullable private Drawable getDrawableFromDisk File file Drawable drawable Drawable createFromPath file getAbsolutePath if drawable null int picHeight calculatePicHeight drawable drawable setBounds 0 0 mPicWidth picHeight return drawable private int calculatePicHeight Drawable drawable float imgWidth drawable getIntrinsicWidth float imgHeight drawable getIntrinsicHeight float rate imgHeight imgWidth return int mPicWidth rate NonNull private Drawable getDrawableFromNet final String source mSubscription RetrofitManager getInstance HostType NEWS DETAIL HTML PHOTO getNewsBodyHtmlPhoto source unsubscribeOn Schedulers io subscribeOn Schedulers io observeOn AndroidSchedulers mainThread map new Func1 ResponseBody Boolean Override public Boolean call ResponseBody response return WritePicToDisk response source subscribe new Subscriber Boolean Override public void onCompleted KLog i Override public void onError Throwable e KLog e e toString Override public void onNext Boolean isLoadSuccess KLog i mPicCount if isLoadSuccess mPicCount mPicTotal 1 mTextView setText Html fromHtml mNewsBody URLImageGetter this null return createPicPlaceholder NonNull private Boolean WritePicToDisk ResponseBody response String source File file new File mFilePath source hashCode InputStream in null FileOutputStream out null try in response byteStream out new FileOutputStream file byte buffer new byte 1024 int len while len in read buffer 1 out write buffer 0 len return true catch Exception e KLog e e toString return false finally try if in null in close if out null out close catch IOException e KLog e SuppressWarnings deprecation NonNull private Drawable createPicPlaceholder Drawable drawable int color MyUtils getColor R color image place holder R color image place holder night drawable new ColorDrawable App getAppContext getResources getColor color drawable setBounds 0 0 mPicWidth mPicWidth 3 return drawablepackage hudson model import com trilead ssh2 crypto Base64 import hudson PluginWrapper import hudson Util import hudson Extension import hudson node monitors ArchitectureMonitor DescriptorImpl import hudson util IOUtils import hudson util Secret import static hudson util TimeUnit2 DAYS import jenkins model Jenkins import net sf json JSONObject import org apache commons io output ByteArrayOutputStream import org kohsuke stapler StaplerRequest import javax crypto Cipher import javax crypto CipherOutputStream import javax crypto KeyGenerator import javax crypto SecretKey import javax crypto CipherInputStream import javax crypto spec IvParameterSpec import javax crypto spec SecretKeySpec import java io IOException import java io OutputStreamWriter import java io FilterOutputStream import java io OutputStream import java io FilterInputStream import java io InputStream import java io DataInputStream import java security GeneralSecurityException import java security Key import java security KeyFactory import java security PublicKey import java security interfaces RSAKey import java security interfaces RSAPublicKey import java security spec X509EncodedKeySpec import java util ArrayList import java util List import com jcraft jzlib GZIPOutputStream import jenkins util SystemProperties Extension public class UsageStatistics extends PageDecorator private final String keyImage private volatile transient RSAPublicKey key private volatile transient long lastAttempt 1 public UsageStatistics this DEFAULT KEY BYTES public UsageStatistics String keyImage this keyImage keyImage load public boolean isDue user opted out no data collection if Jenkins getInstance isUsageStatisticsCollected DISABLED return false long now System currentTimeMillis if now lastAttempt DAY lastAttempt now return true return false private RSAPublicKey getKey try if key null KeyFactory keyFactory KeyFactory getInstance RSA key RSAPublicKey keyFactory generatePublic new X509EncodedKeySpec Util fromHexString keyImage return key catch GeneralSecurityException e throw new Error e impossible public String getStatData throws IOException Jenkins j Jenkins getInstance JSONObject o new JSONObject o put stat 1 o put install j getLegacyInstanceId o put servletContainer j servletContext getServerInfo o put version Jenkins VERSION List JSONObject nodes new ArrayList JSONObject for Computer c j getComputers JSONObject n new JSONObject if c getNode j n put master true n put jvm vendor System getProperty java vm vendor n put jvm name System getProperty java vm name n put jvm version System getProperty java version n put executors c getNumExecutors DescriptorImpl descriptor j getDescriptorByType DescriptorImpl class n put os descriptor get c nodes add n o put nodes nodes List JSONObject plugins new ArrayList JSONObject for PluginWrapper pw j getPluginManager getPlugins if pw isActive continue treat disabled plugins as if they are uninstalled JSONObject p new JSONObject p put name pw getShortName p put version pw getVersion plugins add p o put plugins plugins JSONObject jobs new JSONObject List TopLevelItem items j getAllItems TopLevelItem class for TopLevelItemDescriptor d Items all int cnt 0 for TopLevelItem item items if item getDescriptor d cnt jobs put d getJsonSafeClassName cnt o put jobs jobs try ByteArrayOutputStream baos new ByteArrayOutputStream json UTF 8 encode gzip encrypt base64 string OutputStreamWriter w new OutputStreamWriter new GZIPOutputStream new CombinedCipherOutputStream baos getKey AES UTF 8 try o write w finally IOUtils closeQuietly w return new String Base64 encode baos toByteArray catch GeneralSecurityException e throw new Error e impossible Override public boolean configure StaplerRequest req JSONObject json throws FormException try for backward compatibility reasons this configuration is stored in Jenkins Jenkins getInstance setNoUsageStatistics json has usageStatisticsCollected null true return true catch IOException e throw new FormException e usageStatisticsCollected public static final class CombinedCipherOutputStream extends FilterOutputStream public CombinedCipherOutputStream OutputStream out Cipher asym String algorithm throws IOException GeneralSecurityException super out create a new symmetric cipher key used for this stream String keyAlgorithm getKeyAlgorithm algorithm SecretKey symKey KeyGenerator getInstance keyAlgorithm generateKey place the symmetric key by encrypting it with asymmetric cipher out write asym doFinal symKey getEncoded the rest of the data will be encrypted by this symmetric cipher Cipher sym Secret getCipher algorithm sym init Cipher ENCRYPT MODE symKey keyAlgorithm equals algorithm null new IvParameterSpec symKey getEncoded super out new CipherOutputStream out sym public CombinedCipherOutputStream OutputStream out RSAKey key String algorithm throws IOException GeneralSecurityException this out toCipher key Cipher ENCRYPT MODE algorithm public static final class CombinedCipherInputStream extends FilterInputStream public CombinedCipherInputStream InputStream in Cipher asym String algorithm int keyLength throws IOException GeneralSecurityException super in String keyAlgorithm getKeyAlgorithm algorithm first read the symmetric key cipher byte symKeyBytes new byte keyLength 8 new DataInputStream in readFully symKeyBytes SecretKey symKey new SecretKeySpec asym doFinal symKeyBytes keyAlgorithm the rest of the data will be decrypted by this symmetric cipher Cipher sym Secret getCipher algorithm sym init Cipher DECRYPT MODE symKey keyAlgorithm equals algorithm null new IvParameterSpec symKey getEncoded super in new CipherInputStream in sym public CombinedCipherInputStream InputStream in RSAKey key String algorithm throws IOException GeneralSecurityException this in toCipher key Cipher DECRYPT MODE algorithm key getModulus bitLength private static String getKeyAlgorithm String algorithm int index algorithm indexOf return index 0 algorithm substring 0 index algorithm private static Cipher toCipher RSAKey key int mode throws GeneralSecurityException Cipher cipher Cipher getInstance RSA cipher init mode Key key return cipher private static final String DEFAULT KEY BYTES 30819f300d06092a864886f70d010101050003818d0030818902818100c14970473bd90fd1f2d20e4fa6e36ea21f7d46db2f4104a3a8f2eb097d6e26278dfadf3fe9ed05bbbb00a4433f4b7151e6683a169182e6ff2f6b4f2bb6490b2cddef73148c37a2a7421fc75f99fb0fadab46f191806599a208652f4829fd6f76e13195fb81ff3f2fce15a8e9a85ebe15c07c90b34ebdb416bd119f0d74105f3b0203010001 private static final long DAY DAYS toMillis 1 public static boolean DISABLED SystemProperties getBoolean UsageStatistics class getName disabledpackage hudson model import jenkins security UserDetailsCache import jenkins util SystemProperties import com google common base Predicate import com infradna tool bridge method injector WithBridgeMethods import hudson import hudson model Descriptor FormException import hudson model listeners SaveableListener import hudson security ACL import hudson security AccessControlled import hudson security Permission import hudson security SecurityRealm import hudson security UserMayOrMayNotExistException import hudson util FormApply import hudson util FormValidation import hudson util RunList import hudson util XStream2 import jenkins model IdStrategy import jenkins model Jenkins import jenkins model ModelObjectWithContextMenu import jenkins security ImpersonatingUserDetailsService import jenkins security LastGrantedAuthoritiesProperty import net sf json JSONObject import org acegisecurity Authentication import org acegisecurity GrantedAuthority import org acegisecurity providers UsernamePasswordAuthenticationToken import org acegisecurity providers anonymous AnonymousAuthenticationToken import org acegisecurity userdetails UserDetails import org acegisecurity userdetails UsernameNotFoundException import org jenkinsci Symbol import org springframework dao DataAccessException import org kohsuke accmod Restricted import org kohsuke accmod restrictions NoExternalUse import org kohsuke stapler StaplerRequest import org kohsuke stapler StaplerResponse import org kohsuke stapler export Exported import org kohsuke stapler export ExportedBean import org apache commons io filefilter DirectoryFileFilter import org kohsuke stapler interceptor RequirePOST import javax annotation concurrent GuardedBy import javax servlet ServletException import javax servlet http HttpServletResponse import java io File import java io IOException import java io FileFilter import java util ArrayList import java util Arrays import java util Collection import java util Collections import java util Comparator import java util HashSet import java util Iterator import java util List import java util Map import java util Objects import java util Set import java util concurrent ConcurrentHashMap import java util concurrent ConcurrentMap import java util concurrent ExecutionException import java util concurrent locks ReadWriteLock import java util concurrent locks ReentrantReadWriteLock import java util logging Level import java util logging Logger import javax annotation CheckForNull import javax annotation Nonnull import javax annotation Nullable import org apache commons lang StringUtils ExportedBean public class User extends AbstractModelObject implements AccessControlled DescriptorByNameOwner Saveable Comparable User ModelObjectWithContextMenu private static final String UKNOWN USERNAME unknown private static final String ILLEGAL PERSISTED USERNAMES new String ACL ANONYMOUS USERNAME ACL SYSTEM USERNAME UKNOWN USERNAME private transient final String id private volatile String fullName private volatile String description CopyOnWrite private volatile List UserProperty properties new ArrayList UserProperty private User String id String fullName this id id this fullName fullName load Nonnull public static IdStrategy idStrategy Jenkins j Jenkins getInstance SecurityRealm realm j getSecurityRealm if realm null return IdStrategy CASE INSENSITIVE return realm getUserIdStrategy public int compareTo User that return idStrategy compare this id that id private synchronized void load properties clear XmlFile config getConfigFile try if config exists config unmarshal this catch IOException e LOGGER log Level SEVERE Failed to load config e remove nulls that have failed to load for Iterator UserProperty itr properties iterator itr hasNext if itr next null itr remove allocate default instances if needed doing so after load makes sure that newly added user properties do get reflected for UserPropertyDescriptor d UserProperty all if getProperty d clazz null UserProperty up d newInstance this if up null properties add up for UserProperty p properties p setUser this Exported public String getId return id public Nonnull String getUrl return user Util rawEncode idStrategy keyFor id public Nonnull String getSearchUrl return user Util rawEncode idStrategy keyFor id Exported visibility 999 public Nonnull String getAbsoluteUrl return Jenkins getInstance getRootUrl getUrl Exported visibility 999 public Nonnull String getFullName return fullName public void setFullName String name if Util fixEmptyAndTrim name null name id this fullName name Exported public CheckForNull String getDescription return description public void setDescription String description this description description public Map Descriptor UserProperty UserProperty getProperties return Descriptor toMap properties public synchronized void addProperty Nonnull UserProperty p throws IOException UserProperty old getProperty p getClass List UserProperty ps new ArrayList UserProperty properties if old null ps remove old ps add p p setUser this properties ps save Exported name property inline true public List UserProperty getAllProperties return Collections unmodifiableList properties public T extends UserProperty T getProperty Class T clazz for UserProperty p properties if clazz isInstance p return clazz cast p return null public Nonnull Authentication impersonate throws UsernameNotFoundException try UserDetails u new ImpersonatingUserDetailsService Jenkins getInstance getSecurityRealm getSecurityComponents userDetails loadUserByUsername id return new UsernamePasswordAuthenticationToken u getUsername u getAuthorities catch UserMayOrMayNotExistException e backend can t load information about other users so use the stored information if available catch UsernameNotFoundException e if the user no longer exists in the backend we need to refuse impersonating this user if ALLOW NON EXISTENT USER TO LOGIN throw e catch DataAccessException e seems like it s in the same boat as UserMayOrMayNotExistException seems like a legitimate user we have no idea about proceed with minimum access return new UsernamePasswordAuthenticationToken id new GrantedAuthority SecurityRealm AUTHENTICATED AUTHORITY public synchronized void doSubmitDescription StaplerRequest req StaplerResponse rsp throws IOException ServletException checkPermission Jenkins ADMINISTER description req getParameter description save rsp sendRedirect go to the top page public static Nonnull User getUnknown return getById UKNOWN USERNAME true Deprecated public static Nullable User get String idOrFullName boolean create return get idOrFullName create Collections emptyMap public static Nullable User get String idOrFullName boolean create Map context if idOrFullName null return null sort resolvers by priority List CanonicalIdResolver resolvers new ArrayList CanonicalIdResolver ExtensionList lookup CanonicalIdResolver class Collections sort resolvers String id null for CanonicalIdResolver resolver resolvers id resolver resolveCanonicalId idOrFullName context if id null LOGGER log Level FINE 0 mapped 1 to 2 new Object resolver idOrFullName id break DefaultUserCanonicalIdResolver will always return a non null id if all other CanonicalIdResolver failed if id null throw new IllegalStateException The user id should be always non null thanks to DefaultUserCanonicalIdResolver return getOrCreate id idOrFullName create private static Nullable User getOrCreate Nonnull String id Nonnull String fullName boolean create String idkey idStrategy keyFor id byNameLock readLock lock User u try u byName get idkey finally byNameLock readLock unlock final File configFile getConfigFileFor id if configFile isFile configFile getParentFile isDirectory check for legacy users and migrate if safe to do so File legacy getLegacyConfigFilesFor id if legacy null legacy length 0 for File legacyUserDir legacy final XmlFile legacyXml new XmlFile XSTREAM new File legacyUserDir config xml try Object o legacyXml read if o instanceof User if idStrategy equals id legacyUserDir getName idStrategy filenameOf legacyUserDir getName equals legacyUserDir getName if legacyUserDir renameTo configFile getParentFile LOGGER log Level WARNING Failed to migrate user record from 0 to 1 new Object legacyUserDir configFile getParentFile break else LOGGER log Level FINE Unexpected object loaded from 0 1 new Object legacyUserDir o catch IOException e LOGGER log Level FINE String format Exception trying to load user from s s new Object legacyUserDir e getMessage e if u null create configFile exists User tmp new User id fullName User prev byNameLock readLock lock try prev byName putIfAbsent idkey u tmp finally byNameLock readLock unlock if prev null u prev if some has already put a value in the map use it if LOGGER isLoggable Level FINE fullName equals prev getFullName LOGGER log Level FINE mismatch on fullName fullName vs prev getFullName for id new Throwable else if id equals fullName configFile exists JENKINS 16332 since the fullName may not be recoverable from the id and various code may store the id only we must save the fullName try u save catch IOException x LOGGER log Level WARNING null x return u public static Nonnull User get String idOrFullName return get idOrFullName true public static CheckForNull User current return get Jenkins getAuthentication public static CheckForNull User get CheckForNull Authentication a if a null a instanceof AnonymousAuthenticationToken return null Since we already know this is a name we can just call getOrCreate with the name directly String id a getName return getById id true public static Nullable User getById String id boolean create return getOrCreate id id create private static volatile long lastScanned public static Nonnull Collection User getAll final IdStrategy strategy idStrategy if System currentTimeMillis lastScanned 10000 occasionally scan the file system to check new users whether we should do this only once at start up or not is debatable set this right away to avoid another thread from doing the same thing while we do this having two threads doing the work won t cause race condition but it s waste of time lastScanned System currentTimeMillis File subdirs getRootDir listFiles FileFilter DirectoryFileFilter INSTANCE if subdirs null return Collections emptyList shall never happen for File subdir subdirs if new File subdir config xml exists String name strategy idFromFilename subdir getName User getOrCreate name name true lastScanned System currentTimeMillis byNameLock readLock lock ArrayList User r try r new ArrayList User byName values finally byNameLock readLock unlock Collections sort r new Comparator User public int compare User o1 User o2 return strategy compare o1 getId o2 getId return r public static void reload byNameLock readLock lock try for User u byName values u load finally byNameLock readLock unlock UserDetailsCache get invalidateAll public static void clear byNameLock writeLock lock try byName clear finally byNameLock writeLock unlock public static void rekey final IdStrategy strategy idStrategy byNameLock writeLock lock try for Map Entry String User e byName entrySet String idkey strategy keyFor e getValue id if idkey equals e getKey need to remap byName remove e getKey byName putIfAbsent idkey e getValue finally byNameLock writeLock unlock UserDetailsCache get invalidateAll public Nonnull String getDisplayName return getFullName private boolean relatedTo Nonnull AbstractBuild b if b hasParticipant this return true for Cause cause b getCauses if cause instanceof Cause UserIdCause String userId Cause UserIdCause cause getUserId if userId null idStrategy equals userId getId return true return false WithBridgeMethods List class public Nonnull RunList getBuilds return new RunList Run Jenkins getInstance getAllItems Job class filter new Predicate Run Override public boolean apply Run r return r instanceof AbstractBuild relatedTo AbstractBuild r public Nonnull Set AbstractProject getProjects Set AbstractProject r new HashSet AbstractProject for AbstractProject p Jenkins getInstance getAllItems AbstractProject class if p hasParticipant this r add p return r public Override String toString return fullName protected final XmlFile getConfigFile return new XmlFile XSTREAM getConfigFileFor id private static final File getConfigFileFor String id return new File getRootDir idStrategy filenameOf id config xml private static final File getLegacyConfigFilesFor final String id return getRootDir listFiles new FileFilter Override public boolean accept File pathname return pathname isDirectory new File pathname config xml isFile idStrategy equals pathname getName id private static File getRootDir return new File Jenkins getInstance getRootDir users public static boolean isIdOrFullnameAllowed CheckForNull String id TODO StringUtils isBlank checks the null falue but FindBugs is not smart enough Remove it later if id null StringUtils isBlank id return false final String trimmedId id trim for String invalidId ILLEGAL PERSISTED USERNAMES if trimmedId equalsIgnoreCase invalidId return false return true public synchronized void save throws IOException FormValidation if isIdOrFullnameAllowed id throw FormValidation error Messages User IllegalUsername id if isIdOrFullnameAllowed fullName throw FormValidation error Messages User IllegalFullname fullName if BulkChange contains this return getConfigFile write this SaveableListener fireOnChange this getConfigFile public synchronized void delete throws IOException final IdStrategy strategy idStrategy byNameLock readLock lock try byName remove strategy keyFor id finally byNameLock readLock unlock Util deleteRecursive new File getRootDir strategy filenameOf id UserDetailsCache get invalidate strategy keyFor id public Api getApi return new Api this RequirePOST public void doConfigSubmit StaplerRequest req StaplerResponse rsp throws IOException ServletException FormException checkPermission Jenkins ADMINISTER JSONObject json req getSubmittedForm String oldFullName this fullName fullName json getString fullName description json getString description List UserProperty props new ArrayList UserProperty int i 0 for UserPropertyDescriptor d UserProperty all UserProperty p getProperty d clazz JSONObject o json optJSONObject userProperty i if o null if p null p p reconfigure req o else p d newInstance req o p setUser this if p null props add p this properties props save if oldFullName null oldFullName equals this fullName UserDetailsCache get invalidate oldFullName FormApply success generateResponse req rsp this RequirePOST public void doDoDelete StaplerRequest req StaplerResponse rsp throws IOException ServletException checkPermission Jenkins ADMINISTER if idStrategy equals id Jenkins getAuthentication getName rsp sendError HttpServletResponse SC BAD REQUEST Cannot delete self return delete rsp sendRedirect2 public void doRssAll StaplerRequest req StaplerResponse rsp throws IOException ServletException rss req rsp all builds getBuilds Run FEED ADAPTER public void doRssFailed StaplerRequest req StaplerResponse rsp throws IOException ServletException rss req rsp regression builds getBuilds regressionOnly Run FEED ADAPTER public void doRssLatest StaplerRequest req StaplerResponse rsp throws IOException ServletException final List Run lastBuilds new ArrayList Run for AbstractProject p Jenkins getInstance getAllItems AbstractProject class for AbstractBuild b p getLastBuild b null b b getPreviousBuild if relatedTo b lastBuilds add b break rss req rsp latest build RunList fromRuns lastBuilds Run FEED ADAPTER LATEST private void rss StaplerRequest req StaplerResponse rsp String suffix RunList runs FeedAdapter adapter throws IOException ServletException RSS forwardToRss getDisplayName suffix getUrl runs newBuilds adapter req rsp GuardedBy byNameLock private static final ConcurrentMap String User byName new ConcurrentHashMap String User private static final ReadWriteLock byNameLock new ReentrantReadWriteLock public static final XStream2 XSTREAM new XStream2 private static final Logger LOGGER Logger getLogger User class getName static XSTREAM alias user User class public ACL getACL final ACL base Jenkins getInstance getAuthorizationStrategy getACL this always allow a non anonymous user full control of himself return new ACL public boolean hasPermission Authentication a Permission permission return idStrategy equals a getName id a instanceof AnonymousAuthenticationToken base hasPermission a permission public void checkPermission Permission permission getACL checkPermission permission public boolean hasPermission Permission permission return getACL hasPermission permission public boolean canDelete final IdStrategy strategy idStrategy return hasPermission Jenkins ADMINISTER strategy equals id Jenkins getAuthentication getName new File getRootDir strategy filenameOf id exists public Nonnull List String getAuthorities if Jenkins getInstance hasPermission Jenkins ADMINISTER return Collections emptyList List String r new ArrayList String Authentication authentication try authentication impersonate catch UsernameNotFoundException x LOGGER log Level FINE cannot look up authorities for id x return Collections emptyList for GrantedAuthority a authentication getAuthorities if a equals SecurityRealm AUTHENTICATED AUTHORITY continue String n a getAuthority if n null idStrategy equals n id r add n Collections sort r String CASE INSENSITIVE ORDER return r public Descriptor getDescriptorByName String className return Jenkins getInstance getDescriptorByName className public Object getDynamic String token for Action action getTransientActions if Objects equals action getUrlName token return action for Action action getPropertyActions if Objects equals action getUrlName token return action return null public List Action getPropertyActions List Action actions new ArrayList Action for UserProperty userProp getProperties values if userProp instanceof Action actions add Action userProp return Collections unmodifiableList actions public List Action getTransientActions List Action actions new ArrayList Action for TransientUserActionFactory factory TransientUserActionFactory all actions addAll factory createFor this return Collections unmodifiableList actions public ContextMenu doContextMenu StaplerRequest request StaplerResponse response throws Exception return new ContextMenu from this request response Restricted NoExternalUse class static Set String getIllegalPersistedUsernames TODO This method is designed for further extensibility via system properties To be extended in a follow up issue final Set String res new HashSet res addAll Arrays asList ILLEGAL PERSISTED USERNAMES return res public static abstract class CanonicalIdResolver extends AbstractDescribableImpl CanonicalIdResolver implements ExtensionPoint Comparable CanonicalIdResolver public static final String REALM realm public int compareTo CanonicalIdResolver o reverse priority order int i getPriority int j o getPriority return i j 1 i j 0 1 public abstract CheckForNull String resolveCanonicalId String idOrFullName Map String context public int getPriority return 1 Extension Symbol fullName public static class FullNameIdResolver extends CanonicalIdResolver Override public String resolveCanonicalId String idOrFullName Map String context for User user getAll if idOrFullName equals user getFullName return user getId return null Override public int getPriority return 1 lower than default Extension Restricted NoExternalUse class public static class UserIDCanonicalIdResolver extends User CanonicalIdResolver private static boolean SECURITY 243 FULL DEFENSE SystemProperties getBoolean User class getName SECURITY 243 FULL DEFENSE true private static final ThreadLocal Boolean resolving new ThreadLocal Boolean Override protected Boolean initialValue return false Override public String resolveCanonicalId String idOrFullName Map String context User existing getById idOrFullName false if existing null return existing getId if SECURITY 243 FULL DEFENSE if resolving get resolving set true try UserDetails userDetails UserDetailsCache get loadUserByUsername idOrFullName return userDetails getUsername catch UsernameNotFoundException x LOGGER log Level FINE not sure whether idOrFullName is a valid username or not x catch DataAccessException ExecutionException x LOGGER log Level FINE could not look up idOrFullName x finally resolving set false return null Override public int getPriority should always come first so that ID that are ids get mapped correctly return Integer MAX VALUE public static boolean ALLOW NON EXISTENT USER TO LOGIN SystemProperties getBoolean User class getName allowNonExistentUserToLoginpackage hudson tasks import java util logging Logger import java util regex Matcher import java util regex Pattern import jenkins model Jenkins import hudson Extension import hudson ExtensionList import hudson ExtensionPoint import hudson Functions import hudson model User import javax annotation CheckForNull public abstract class UserAvatarResolver implements ExtensionPoint static Pattern iconSizeRegex Pattern compile d x d public abstract String findAvatarFor User u int width int height public static String resolve User u String avatarSize String avatar resolveOrNull u avatarSize return avatar null avatar Jenkins getInstance getRootUrl Functions getResourcePath images avatarSize user png public static CheckForNull String resolveOrNull User u String avatarSize Matcher matcher iconSizeRegex matcher avatarSize if matcher matches matcher groupCount 2 int width Integer parseInt matcher group 1 int height Integer parseInt matcher group 2 for UserAvatarResolver r all String name r findAvatarFor u width height if name null return name else LOGGER warning String format Could not split up the avatar size s into a width and height avatarSize return null public static ExtensionList UserAvatarResolver all return ExtensionList lookup UserAvatarResolver class private static final Logger LOGGER Logger getLogger UserAvatarResolver class getNamepackage com twitter sdk android core models import java util List public class UserBuilder private boolean contributorsEnabled private String createdAt private boolean defaultProfile private boolean defaultProfileImage private String description private String email private UserEntities entities private int favouritesCount private boolean followRequestSent private int followersCount private int friendsCount private boolean geoEnabled private long id User INVALID ID private String idStr private boolean isTranslator private String lang private int listedCount private String location private String name private String profileBackgroundColor private String profileBackgroundImageUrl private String profileBackgroundImageUrlHttps private boolean profileBackgroundTile private String profileBannerUrl private String profileImageUrl private String profileImageUrlHttps private String profileLinkColor private String profileSidebarBorderColor private String profileSidebarFillColor private String profileTextColor private boolean profileUseBackgroundImage private boolean protectedUser private String screenName private boolean showAllInlineMedia private Tweet status private int statusesCount private String timeZone private String url private int utcOffset private boolean verified private List String withheldInCountries private String withheldScope public UserBuilder setContributorsEnabled boolean contributorsEnabled this contributorsEnabled contributorsEnabled return this public UserBuilder setCreatedAt String createdAt this createdAt createdAt return this public UserBuilder setDefaultProfile boolean defaultProfile this defaultProfile defaultProfile return this public UserBuilder setDefaultProfileImage boolean defaultProfileImage this defaultProfileImage defaultProfileImage return this public UserBuilder setDescription String description this description description return this public UserBuilder setEmail String email this email email return this public UserBuilder setEntities UserEntities entities this entities entities return this public UserBuilder setFavouritesCount int favouritesCount this favouritesCount favouritesCount return this public UserBuilder setFollowRequestSent boolean followRequestSent this followRequestSent followRequestSent return this public UserBuilder setFollowersCount int followersCount this followersCount followersCount return this public UserBuilder setFriendsCount int friendsCount this friendsCount friendsCount return this public UserBuilder setGeoEnabled boolean geoEnabled this geoEnabled geoEnabled return this public UserBuilder setId long id this id id return this public UserBuilder setIdStr String idStr this idStr idStr return this public UserBuilder setIsTranslator boolean isTranslator this isTranslator isTranslator return this public UserBuilder setLang String lang this lang lang return this public UserBuilder setListedCount int listedCount this listedCount listedCount return this public UserBuilder setLocation String location this location location return this public UserBuilder setName String name this name name return this public UserBuilder setProfileBackgroundColor String profileBackgroundColor this profileBackgroundColor profileBackgroundColor return this public UserBuilder setProfileBackgroundImageUrl String profileBackgroundImageUrl this profileBackgroundImageUrl profileBackgroundImageUrl return this public UserBuilder setProfileBackgroundImageUrlHttps String profileBackgroundImageUrlHttps this profileBackgroundImageUrlHttps profileBackgroundImageUrlHttps return this public UserBuilder setProfileBackgroundTile boolean profileBackgroundTile this profileBackgroundTile profileBackgroundTile return this public UserBuilder setProfileBannerUrl String profileBannerUrl this profileBannerUrl profileBannerUrl return this public UserBuilder setProfileImageUrl String profileImageUrl this profileImageUrl profileImageUrl return this public UserBuilder setProfileImageUrlHttps String profileImageUrlHttps this profileImageUrlHttps profileImageUrlHttps return this public UserBuilder setProfileLinkColor String profileLinkColor this profileLinkColor profileLinkColor return this public UserBuilder setProfileSidebarBorderColor String profileSidebarBorderColor this profileSidebarBorderColor profileSidebarBorderColor return this public UserBuilder setProfileSidebarFillColor String profileSidebarFillColor this profileSidebarFillColor profileSidebarFillColor return this public UserBuilder setProfileTextColor String profileTextColor this profileTextColor profileTextColor return this public UserBuilder setProfileUseBackgroundImage boolean profileUseBackgroundImage this profileUseBackgroundImage profileUseBackgroundImage return this public UserBuilder setProtectedUser boolean protectedUser this protectedUser protectedUser return this public UserBuilder setScreenName String screenName this screenName screenName return this public UserBuilder setShowAllInlineMedia boolean showAllInlineMedia this showAllInlineMedia showAllInlineMedia return this public UserBuilder setStatus Tweet status this status status return this public UserBuilder setStatusesCount int statusesCount this statusesCount statusesCount return this public UserBuilder setTimeZone String timeZone this timeZone timeZone return this public UserBuilder setUrl String url this url url return this public UserBuilder setUtcOffset int utcOffset this utcOffset utcOffset return this public UserBuilder setVerified boolean verified this verified verified return this public UserBuilder setWithheldInCountries List String withheldInCountries this withheldInCountries withheldInCountries return this public UserBuilder setWithheldScope String withheldScope this withheldScope withheldScope return this public User build return new User contributorsEnabled createdAt defaultProfile defaultProfileImage description email entities favouritesCount followRequestSent followersCount friendsCount geoEnabled id idStr isTranslator lang listedCount location name profileBackgroundColor profileBackgroundImageUrl profileBackgroundImageUrlHttps profileBackgroundTile profileBannerUrl profileImageUrl profileImageUrlHttps profileLinkColor profileSidebarBorderColor profileSidebarFillColor profileTextColor profileUseBackgroundImage protectedUser screenName showAllInlineMedia status statusesCount timeZone url utcOffset verified withheldInCountries withheldScopepackage jenkins security import com google common cache Cache import com google common util concurrent UncheckedExecutionException import hudson Extension import hudson ExtensionList import hudson security UserMayOrMayNotExistException import jenkins model Jenkins import jenkins util SystemProperties import org acegisecurity userdetails UserDetails import org acegisecurity userdetails UsernameNotFoundException import org kohsuke accmod Restricted import org kohsuke accmod restrictions NoExternalUse import org springframework dao DataAccessException import javax annotation CheckForNull import javax annotation Nonnull import java util concurrent Callable import java util concurrent ExecutionException import java util concurrent TimeUnit import static com google common cache CacheBuilder newBuilder Extension public final class UserDetailsCache private static final String SYS PROP NAME UserDetailsCache class getName EXPIRE AFTER WRITE SEC private static Integer EXPIRE AFTER WRITE SEC SystemProperties getInteger SYS PROP NAME int TimeUnit MINUTES toSeconds 2 private final Cache String UserDetails detailsCache private final Cache String Boolean existanceCache Restricted NoExternalUse class public UserDetailsCache if EXPIRE AFTER WRITE SEC null EXPIRE AFTER WRITE SEC 0 just in case someone is trying to trick us EXPIRE AFTER WRITE SEC SystemProperties getInteger SYS PROP NAME int TimeUnit MINUTES toSeconds 2 if EXPIRE AFTER WRITE SEC 0 The property could also be set to a negative value EXPIRE AFTER WRITE SEC int TimeUnit MINUTES toSeconds 2 detailsCache newBuilder softValues expireAfterWrite EXPIRE AFTER WRITE SEC TimeUnit SECONDS build existanceCache newBuilder softValues expireAfterWrite EXPIRE AFTER WRITE SEC TimeUnit SECONDS build public static UserDetailsCache get return ExtensionList lookup UserDetailsCache class get UserDetailsCache class CheckForNull public UserDetails getCached String idOrFullName throws UsernameNotFoundException Boolean exists existanceCache getIfPresent idOrFullName if exists null exists throw new UserMayOrMayNotExistException String format s does not exist idOrFullName else return detailsCache getIfPresent idOrFullName Nonnull public UserDetails loadUserByUsername String idOrFullName throws UsernameNotFoundException DataAccessException ExecutionException Boolean exists existanceCache getIfPresent idOrFullName if exists null exists throw new UsernameNotFoundException String format s does not exist idOrFullName else try return detailsCache get idOrFullName new Retriever idOrFullName catch ExecutionException UncheckedExecutionException e if e getCause instanceof UsernameNotFoundException throw UsernameNotFoundException e getCause else if e getCause instanceof DataAccessException throw DataAccessException e getCause else throw e public void invalidateAll existanceCache invalidateAll detailsCache invalidateAll public void invalidate final String idOrFullName existanceCache invalidate idOrFullName detailsCache invalidate idOrFullName private class Retriever implements Callable UserDetails private final String idOrFullName private Retriever final String idOrFullName this idOrFullName idOrFullName Override public UserDetails call throws Exception try Jenkins jenkins Jenkins getInstance UserDetails userDetails jenkins getSecurityRealm loadUserByUsername idOrFullName if userDetails null existanceCache put this idOrFullName Boolean FALSE throw new NullPointerException hudson security SecurityRealm should never return null jenkins getSecurityRealm returned null for idOrFullName idOrFullName existanceCache put this idOrFullName Boolean TRUE return userDetails catch UsernameNotFoundException e existanceCache put this idOrFullName Boolean FALSE throw e catch DataAccessException e existanceCache invalidate this idOrFullName throw epackage hudson security import org acegisecurity userdetails UserDetails import org acegisecurity userdetails UserDetailsService import org acegisecurity userdetails UsernameNotFoundException import org springframework dao DataAccessException public class UserDetailsServiceProxy implements UserDetailsService private volatile UserDetailsService delegate public UserDetails loadUserByUsername String username throws UsernameNotFoundException DataAccessException UserDetailsService uds delegate fix the reference for concurrency support if uds null throw new UserMayOrMayNotExistException Messages UserDetailsServiceProxy UnableToQuery username return uds loadUserByUsername username public void setDelegate UserDetailsService core this delegate corepackage com twitter sdk android core models import com google gson annotations SerializedName import java util Collections import java util List public class UserEntities SerializedName url public final UrlEntities url SerializedName description public final UrlEntities description public UserEntities UrlEntities url UrlEntities description this url url this description description public static class UrlEntities SerializedName urls public final List UrlEntity urls public UrlEntities List UrlEntity urls this urls getSafeList urls private T List T getSafeList List T entities Entities may be null if Gson does not find object to parse When that happens make sure to return an empty list if entities null return Collections EMPTY LIST else return Collections unmodifiableList entitiespackage hudson security import org acegisecurity userdetails UsernameNotFoundException import org acegisecurity userdetails UserDetailsService public class UserMayOrMayNotExistException extends UsernameNotFoundException public UserMayOrMayNotExistException String msg super msg public UserMayOrMayNotExistException String msg Object extraInformation super msg extraInformation public UserMayOrMayNotExistException String msg Throwable t super msg tpackage hudson tasks import hudson Extension import hudson ExtensionList import hudson ExtensionListView import hudson ExtensionPoint import hudson model User import java util List public abstract class UserNameResolver implements ExtensionPoint public abstract String findNameFor User u public static String resolve User u for UserNameResolver r all String name r findNameFor u if name null return name return null public static ExtensionList UserNameResolver all return ExtensionList lookup UserNameResolver class Deprecated public static final List UserNameResolver LIST ExtensionListView createList UserNameResolver classpackage hudson model import hudson Extension import hudson util DescriptorList import java util List Deprecated public class UserProperties Deprecated public static final List UserPropertyDescriptor LIST List new DescriptorList UserProperty UserProperty classpackage hudson model import hudson ExtensionPoint import hudson DescriptorExtensionList import hudson model Descriptor FormException import jenkins model Jenkins import net sf json JSONObject import org kohsuke stapler StaplerRequest import org kohsuke stapler export ExportedBean ExportedBean public abstract class UserProperty implements ReconfigurableDescribable UserProperty ExtensionPoint protected transient User user final void setUser User u this user u descriptor must be of the UserPropertyDescriptor type public UserPropertyDescriptor getDescriptor return UserPropertyDescriptor Jenkins getInstance getDescriptorOrDie getClass public static DescriptorExtensionList UserProperty UserPropertyDescriptor all return Jenkins getInstance UserProperty UserPropertyDescriptor getDescriptorList UserProperty class public UserProperty reconfigure StaplerRequest req JSONObject form throws FormException return form null null getDescriptor newInstance req formpackage hudson model public abstract class UserPropertyDescriptor extends Descriptor UserProperty protected UserPropertyDescriptor Class extends UserProperty clazz super clazz protected UserPropertyDescriptor public abstract UserProperty newInstance User user public boolean isEnabled return truepackage hudson search import hudson Extension import hudson model User import hudson model UserProperty import hudson model UserPropertyDescriptor import net sf json JSONObject import org jenkinsci Symbol import org kohsuke stapler StaplerRequest import org kohsuke stapler export Exported public class UserSearchProperty extends hudson model UserProperty private final boolean insensitiveSearch public UserSearchProperty boolean insensitiveSearch this insensitiveSearch insensitiveSearch Exported public boolean getInsensitiveSearch return insensitiveSearch public static boolean isCaseInsensitive User user User current boolean caseInsensitive false if user null user getProperty UserSearchProperty class getInsensitiveSearch Searching for anonymous user is case sensitive caseInsensitive true return caseInsensitive Extension Symbol search public static final class DescriptorImpl extends UserPropertyDescriptor public String getDisplayName return Messages UserSearchProperty DisplayName public UserProperty newInstance User user return new UserSearchProperty false default setting is case sensitive searching Override public UserProperty newInstance StaplerRequest req JSONObject formData throws FormException return new UserSearchProperty formData optBoolean insensitiveSearchpackage com twitter sdk android tweetui import com twitter sdk android core Callback import com twitter sdk android core TwitterCore import com twitter sdk android core models Tweet import java util List import retrofit2 Call public class UserTimeline extends BaseTimeline implements Timeline Tweet private static final String SCRIBE SECTION user final Long userId final String screenName final Integer maxItemsPerRequest final Boolean includeReplies final Boolean includeRetweets UserTimeline TweetUi tweetUi Long userId String screenName Integer maxItemsPerRequest Boolean includeReplies Boolean includeRetweets super tweetUi this userId userId this screenName screenName this maxItemsPerRequest maxItemsPerRequest null includeReplies should default to false this includeReplies includeReplies null false includeReplies this includeRetweets includeRetweets Override public void next Long sinceId Callback TimelineResult Tweet cb createUserTimelineRequest sinceId null enqueue new TweetsCallback cb Override public void previous Long maxId Callback TimelineResult Tweet cb user timeline api provides results which are inclusive decrement the maxId to get exclusive results createUserTimelineRequest null decrementMaxId maxId enqueue new TweetsCallback cb Override String getTimelineType return SCRIBE SECTION Call List Tweet createUserTimelineRequest final Long sinceId final Long maxId return TwitterCore getInstance getApiClient getStatusesService userTimeline userId screenName maxItemsPerRequest sinceId maxId false includeReplies null includeRetweets public static class Builder private final TweetUi tweetUi private Long userId private String screenName private Integer maxItemsPerRequest 30 private Boolean includeReplies private Boolean includeRetweets public Builder this TweetUi getInstance public Builder TweetUi tweetUi if tweetUi null throw new IllegalArgumentException TweetUi instance must not be null this tweetUi tweetUi public Builder userId Long userId this userId userId return this public Builder screenName String screenName this screenName screenName return this public Builder maxItemsPerRequest Integer maxItemsPerRequest this maxItemsPerRequest maxItemsPerRequest return this public Builder includeReplies Boolean includeReplies this includeReplies includeReplies return this public Builder includeRetweets Boolean includeRetweets this includeRetweets includeRetweets return this public UserTimeline build return new UserTimeline tweetUi userId screenName maxItemsPerRequest includeReplies includeRetweetspackage com twitter sdk android core internal import android text TextUtils import com twitter sdk android core models User public final class UserUtils private UserUtils see https dev twitter com overview general user profile images and banners see also https confluence twitter biz display PLATFORM Image Types and Sizes public enum AvatarSize NORMAL normal BIGGER bigger MINI mini ORIGINAL original REASONABLY SMALL reasonably small private final String suffix AvatarSize String suffix this suffix suffix String getSuffix return suffix public static String getProfileImageUrlHttps User user AvatarSize size if user null user profileImageUrlHttps null final String url user profileImageUrlHttps if size null url null return url switch size case NORMAL case BIGGER case MINI case ORIGINAL case REASONABLY SMALL return url replace AvatarSize NORMAL getSuffix size getSuffix default return url else return null public static CharSequence formatScreenName CharSequence screenName if TextUtils isEmpty screenName return if screenName charAt 0 return screenName return screenNamepackage com twitter sdk android core models import com google gson annotations SerializedName public class UserValue SerializedName id str public final String idStr public UserValue String idStr this idStr idStrpackage hudson import jenkins util SystemProperties import com sun jna Native import edu umd cs findbugs annotations SuppressFBWarnings import edu umd cs findbugs annotations SuppressFBWarnings import hudson Proc LocalProc import hudson model TaskListener import hudson os PosixAPI import hudson util QuotedStringTokenizer import hudson util VariableResolver import hudson util jna WinIOException import org apache commons io IOUtils import org apache commons lang time FastDateFormat import org apache tools ant BuildException import org apache tools ant Project import org apache tools ant taskdefs Chmod import org apache tools ant taskdefs Copy import org apache tools ant types FileSet import org kohsuke accmod Restricted import org kohsuke accmod restrictions NoExternalUse import jnr posix FileStat import jnr posix POSIX import javax crypto SecretKey import javax crypto spec SecretKeySpec import java io import java lang reflect Method import java lang reflect Modifier import java net InetAddress import java net URI import java net URISyntaxException import java net UnknownHostException import java nio ByteBuffer import java nio CharBuffer import java nio charset CharacterCodingException import java nio charset Charset import java nio charset CharsetEncoder import java nio file FileAlreadyExistsException import java nio file FileSystemException import java nio file Files import java nio file Path import java nio file Paths import java security MessageDigest import java security NoSuchAlgorithmException import java text NumberFormat import java text ParseException import java util import java util concurrent TimeUnit import java util concurrent atomic AtomicBoolean import java util logging Level import java util logging Logger import java util regex Matcher import java util regex Pattern import hudson util jna Kernel32Utils import static hudson util jna GNUCLibrary LIBC import java security DigestInputStream import javax annotation CheckForNull import javax annotation Nonnull import javax annotation Nullable import org apache commons codec digest DigestUtils public class Util Constant number of milliseconds in various time units private static final long ONE SECOND MS 1000 private static final long ONE MINUTE MS 60 ONE SECOND MS private static final long ONE HOUR MS 60 ONE MINUTE MS private static final long ONE DAY MS 24 ONE HOUR MS private static final long ONE MONTH MS 30 ONE DAY MS private static final long ONE YEAR MS 365 ONE DAY MS Nonnull public static T List T filter Nonnull Iterable base Nonnull Class T type List T r new ArrayList T for Object i base if type isInstance i r add type cast i return r Nonnull public static T List T filter Nonnull List base Nonnull Class T type return filter Iterable base type private static final Pattern VARIABLE Pattern compile A Za z0 9 A Za z0 9 Nullable public static String replaceMacro CheckForNull String s Nonnull Map String String properties return replaceMacro s new VariableResolver ByMap String properties Nullable public static String replaceMacro CheckForNull String s Nonnull VariableResolver String resolver if s null return null int idx 0 while true Matcher m VARIABLE matcher s if m find idx return s String key m group substring 1 escape the dollar sign or get the key to resolve String value if key charAt 0 value else if key charAt 0 key key substring 1 key length 1 value resolver resolve key if value null idx m end skip this else s s substring 0 m start value s substring m end idx m start value length Nonnull public static String loadFile Nonnull File logfile throws IOException return loadFile logfile Charset defaultCharset Nonnull public static String loadFile Nonnull File logfile Nonnull Charset charset throws IOException if logfile exists return StringBuilder str new StringBuilder int logfile length try BufferedReader r new BufferedReader new InputStreamReader new FileInputStream logfile charset char buf new char 1024 int len while len r read buf 0 buf length 0 str append buf 0 len return str toString public static void deleteContentsRecursive Nonnull File file throws IOException for int numberOfAttempts 1 numberOfAttempts try tryOnceDeleteContentsRecursive file break success catch IOException ex boolean threadWasInterrupted pauseBetweenDeletes numberOfAttempts if numberOfAttempts DELETION MAX threadWasInterrupted throw new IOException deleteFailExceptionMessage file numberOfAttempts threadWasInterrupted ex public static void deleteFile Nonnull File f throws IOException for int numberOfAttempts 1 numberOfAttempts try tryOnceDeleteFile f break success catch IOException ex boolean threadWasInterrupted pauseBetweenDeletes numberOfAttempts if numberOfAttempts DELETION MAX threadWasInterrupted throw new IOException deleteFailExceptionMessage f numberOfAttempts threadWasInterrupted ex private static void tryOnceDeleteFile File f throws IOException if f delete if f exists we are trying to delete a file that no longer exists so this is not an error return perhaps this file is read only makeWritable f makeWritable f getParentFile if f delete f exists trouble shooting Files deleteIfExists f toPath see https java net projects hudson lists users archive 2008 05 message 357 I suspect other processes putting files in this directory File files f listFiles if files null files length 0 throw new IOException Unable to delete f getPath files in dir Arrays asList files throw new IOException Unable to delete f getPath private static void makeWritable Nonnull File f if f setWritable true return TODO do we still need to try anything else try chmod this becomes no op if this is not Unix try Chmod chmod new Chmod chmod setProject new Project chmod setFile f chmod setPerm u w chmod execute catch BuildException e LOGGER log Level INFO Failed to chmod f e try try libc chmod POSIX posix PosixAPI jnr String path f getAbsolutePath FileStat stat posix stat path posix chmod path stat mode 0200 u w catch Throwable t LOGGER log Level FINE Failed to chmod 2 f t public static void deleteRecursive Nonnull File dir throws IOException for int numberOfAttempts 1 numberOfAttempts try tryOnceDeleteRecursive dir break success catch IOException ex boolean threadWasInterrupted pauseBetweenDeletes numberOfAttempts if numberOfAttempts DELETION MAX threadWasInterrupted throw new IOException deleteFailExceptionMessage dir numberOfAttempts threadWasInterrupted ex private static void tryOnceDeleteRecursive File dir throws IOException if isSymlink dir tryOnceDeleteContentsRecursive dir tryOnceDeleteFile dir private static void tryOnceDeleteContentsRecursive File directory throws IOException File directoryContents directory listFiles if directoryContents null return the directory didn t exist in the first place IOException firstCaught null for File child directoryContents try tryOnceDeleteRecursive child catch IOException justCaught if firstCaught null firstCaught justCaught if firstCaught null throw firstCaught SuppressFBWarnings value DM GC justification Garbage collection happens only when GC AFTER FAILED DELETE is true It s an experimental feature in Jenkins private static boolean pauseBetweenDeletes int numberOfAttemptsSoFar long delayInMs if numberOfAttemptsSoFar DELETION MAX return false if GC AFTER FAILED DELETE System gc if WAIT BETWEEN DELETION RETRIES 0 delayInMs WAIT BETWEEN DELETION RETRIES else delayInMs numberOfAttemptsSoFar WAIT BETWEEN DELETION RETRIES if delayInMs 0 return Thread interrupted try Thread sleep delayInMs return false catch InterruptedException e return true private static String deleteFailExceptionMessage File whatWeWereTryingToRemove int retryCount boolean wasInterrupted StringBuilder sb new StringBuilder sb append Unable to delete sb append whatWeWereTryingToRemove sb append Tried sb append retryCount sb append time if retryCount 1 sb append s if DELETION MAX 1 sb append of a maximum of sb append DELETION MAX sb append if GC AFTER FAILED DELETE sb append garbage collecting if WAIT BETWEEN DELETION RETRIES 0 GC AFTER FAILED DELETE sb append and if WAIT BETWEEN DELETION RETRIES 0 sb append waiting sb append getTimeSpanString Math abs WAIT BETWEEN DELETION RETRIES if WAIT BETWEEN DELETION RETRIES 0 sb append sb append getTimeSpanString Math abs WAIT BETWEEN DELETION RETRIES DELETION MAX if WAIT BETWEEN DELETION RETRIES 0 GC AFTER FAILED DELETE sb append between attempts if wasInterrupted sb append The delete operation was interrupted before it completed successfully sb append return sb toString Taken from http svn apache org viewvc maven shared trunk file management src main java org apache maven shared model fileset util FileSetManager java view markup public static boolean isSymlink Nonnull File file throws IOException if Functions isWindows try return Kernel32Utils isJunctionOrSymlink file catch UnsupportedOperationException LinkageError e fall through Boolean r isSymlinkJava7 file if r null return r String name file getName if name equals name equals return false File fileInCanonicalParent File parentDir file getParentFile if parentDir null fileInCanonicalParent file else fileInCanonicalParent new File parentDir getCanonicalPath name return fileInCanonicalParent getCanonicalFile equals fileInCanonicalParent getAbsoluteFile SuppressFBWarnings NP BOOLEAN RETURN NULL private static Boolean isSymlinkJava7 Nonnull File file throws IOException try Path path file toPath return Files isSymbolicLink path catch Exception x throw IOException new IOException x toString initCause x public static boolean isRelativePath String path if path startsWith return false if path startsWith path length 3 path indexOf 3 1 return false a UNC path which is the most absolute you can get on windows if path length 3 path charAt 1 never mind that the drive mappings can be changed between sessions we just want to know if the 3rd character is a or a is acceptable too char p path charAt 0 if A p p Z a p p z return path charAt 2 path charAt 2 return true public static File createTempDir throws IOException File tmp File createTempFile hudson tmp if tmp delete throw new IOException Failed to delete tmp if tmp mkdirs throw new IOException Failed to create a new directory tmp return tmp private static final Pattern errorCodeParser Pattern compile CreateProcess error 0 9 public static void displayIOException Nonnull IOException e Nonnull TaskListener listener String msg getWin32ErrorMessage e if msg null listener getLogger println msg CheckForNull public static String getWin32ErrorMessage Nonnull IOException e return getWin32ErrorMessage Throwable e CheckForNull public static String getWin32ErrorMessage Throwable e String msg e getMessage if msg null Matcher m errorCodeParser matcher msg if m matches try ResourceBundle rb ResourceBundle getBundle hudson win32errors return rb getString error m group 1 catch Exception silently recover from resource related failures if e getCause null return getWin32ErrorMessage e getCause return null no message CheckForNull public static String getWin32ErrorMessage int n try ResourceBundle rb ResourceBundle getBundle hudson win32errors return rb getString error n catch MissingResourceException e LOGGER log Level WARNING Failed to find resource bundle e return null Nonnull public static String getHostName try return InetAddress getLocalHost getHostName catch UnknownHostException e return localhost public static void copyStream Nonnull InputStream in Nonnull OutputStream out throws IOException byte buf new byte 8192 int len while len in read buf 0 out write buf 0 len public static void copyStream Nonnull Reader in Nonnull Writer out throws IOException char buf new char 8192 int len while len in read buf 0 out write buf 0 len public static void copyStreamAndClose Nonnull InputStream in Nonnull OutputStream out throws IOException try copyStream in out finally IOUtils closeQuietly in IOUtils closeQuietly out public static void copyStreamAndClose Nonnull Reader in Nonnull Writer out throws IOException try copyStream in out finally IOUtils closeQuietly in IOUtils closeQuietly out Nonnull public static String tokenize Nonnull String s CheckForNull String delimiter return QuotedStringTokenizer tokenize s delimiter Nonnull public static String tokenize Nonnull String s return tokenize s t n r f Nonnull public static String mapToEnv Nonnull Map String String m String r new String m size int idx 0 for final Map Entry String String e m entrySet r idx e getKey e getValue return r public static int min int x Nonnull int values for int i values if i x x i return x CheckForNull public static String nullify CheckForNull String v return fixEmpty v Nonnull public static String removeTrailingSlash Nonnull String s if s endsWith return s substring 0 s length 1 else return s Nullable public static String ensureEndsWith CheckForNull String subject CheckForNull String suffix if subject null return null if subject endsWith suffix return subject return subject suffix Nonnull public static String getDigestOf Nonnull InputStream source throws IOException try MessageDigest md5 MessageDigest getInstance MD5 byte buffer new byte 1024 try DigestInputStream in new DigestInputStream source md5 while in read buffer 0 simply discard the input return toHexString md5 digest catch NoSuchAlgorithmException e throw new IOException MD5 not installed e impossible Nonnull public static String getDigestOf Nonnull String text try return getDigestOf new ByteArrayInputStream text getBytes UTF 8 catch IOException e throw new Error e Nonnull public static String getDigestOf Nonnull File file throws IOException try InputStream is new FileInputStream file return getDigestOf new BufferedInputStream is Nonnull public static SecretKey toAes128Key Nonnull String s try turn secretKey into 256 bit hash MessageDigest digest MessageDigest getInstance SHA 256 digest reset digest update s getBytes UTF 8 Due to the stupid US export restriction JDK only ships 128bit version return new SecretKeySpec digest digest 0 128 8 AES catch NoSuchAlgorithmException e throw new Error e catch UnsupportedEncodingException e throw new Error e Nonnull public static String toHexString Nonnull byte data int start int len StringBuilder buf new StringBuilder for int i 0 i len i int b data start i 0xFF if b 16 buf append 0 buf append Integer toHexString b return buf toString Nonnull public static String toHexString Nonnull byte bytes return toHexString bytes 0 bytes length Nonnull public static byte fromHexString Nonnull String data byte r new byte data length 2 for int i 0 i data length i 2 r i 2 byte Integer parseInt data substring i i 2 16 return r Nonnull public static String getTimeSpanString long duration Break the duration up in to units long years duration ONE YEAR MS duration ONE YEAR MS long months duration ONE MONTH MS duration ONE MONTH MS long days duration ONE DAY MS duration ONE DAY MS long hours duration ONE HOUR MS duration ONE HOUR MS long minutes duration ONE MINUTE MS duration ONE MINUTE MS long seconds duration ONE SECOND MS duration ONE SECOND MS long millisecs duration if years 0 return makeTimeSpanString years Messages Util year years months Messages Util month months else if months 0 return makeTimeSpanString months Messages Util month months days Messages Util day days else if days 0 return makeTimeSpanString days Messages Util day days hours Messages Util hour hours else if hours 0 return makeTimeSpanString hours Messages Util hour hours minutes Messages Util minute minutes else if minutes 0 return makeTimeSpanString minutes Messages Util minute minutes seconds Messages Util second seconds else if seconds 10 return Messages Util second seconds else if seconds 1 return Messages Util second seconds float millisecs 100 10 render 1 2 sec else if millisecs 100 return Messages Util second float millisecs 10 100 render 0 12 sec else return Messages Util millisecond millisecs Nonnull private static String makeTimeSpanString long bigUnit Nonnull String bigLabel long smallUnit Nonnull String smallLabel String text bigLabel if bigUnit 10 text smallLabel return text Nonnull public static String getPastTimeString long duration return Messages Util pastTime getTimeSpanString duration Nonnull Deprecated public static String combine long n Nonnull String suffix String s Long toString n suffix if n 1 Just adding an s won t work in most natural languages even English has exception to the rule e g copy copies s s return s Nonnull public static T List T createSubList Nonnull Collection source Nonnull Class T type List T r new ArrayList T for Object item source if type isInstance item r add type cast item return r Nonnull public static String encode Nonnull String s try boolean escaped false StringBuilder out new StringBuilder s length ByteArrayOutputStream buf new ByteArrayOutputStream OutputStreamWriter w new OutputStreamWriter buf UTF 8 for int i 0 i s length i int c s charAt i if c 128 c out append char c else 1 char UTF8 w write c w flush for byte b buf toByteArray out append out append toDigit b 4 0xF out append toDigit b 0xF buf reset escaped true return escaped out toString s catch IOException e throw new Error e impossible private static final boolean uriMap new boolean 123 static String raw 0123456789 ABCDEFGHIJKLMNOPQRSTUVWXYZ abcdefghijklmnopqrstuvwxyz so these are encoded int i Encode control chars and space for i 0 i 33 i uriMap i true for int j 0 j raw length i j uriMap i raw charAt j If we add encodeQuery just add a 2nd map to encode queryMap 38 queryMap 43 queryMap 61 true Nonnull public static String rawEncode Nonnull String s boolean escaped false StringBuilder out null CharsetEncoder enc null CharBuffer buf null char c for int i 0 m s length i m i c s charAt i if c 122 uriMap c if escaped out new StringBuilder i m i 3 out append s substring 0 i enc Charset forName UTF 8 newEncoder buf CharBuffer allocate 1 escaped true 1 char UTF8 buf put 0 c buf rewind try ByteBuffer bytes enc encode buf while bytes hasRemaining byte b bytes get out append out append toDigit b 4 0xF out append toDigit b 0xF catch CharacterCodingException ex else if escaped out append c return escaped out toString s private static char toDigit int n return char n 10 0 n A n 10 public static String singleQuote String s return s Nonnull public static String escape Nonnull String text if text null return null StringBuilder buf new StringBuilder text length 64 for int i 0 i text length i char ch text charAt i if ch n buf append br else if ch buf append lt else if ch buf append gt else if ch buf append amp else if ch buf append quot else if ch buf append 039 else if ch All spaces in a block of consecutive spaces are converted to non breaking space nbsp except for the last one This allows significant whitespace to be retained without prohibiting wrapping char nextCh i 1 text length text charAt i 1 0 buf append nextCh nbsp else buf append ch return buf toString Nonnull public static String xmlEscape Nonnull String text StringBuilder buf new StringBuilder text length 64 for int i 0 i text length i char ch text charAt i if ch buf append lt else if ch buf append gt else if ch buf append amp else buf append ch return buf toString public static void touch Nonnull File file throws IOException new FileOutputStream file close public static void copyFile Nonnull File src Nonnull File dst throws BuildException Copy cp new Copy cp setProject new org apache tools ant Project cp setTofile dst cp setFile src cp setOverwrite true cp execute Nonnull public static String fixNull CheckForNull String s if s null return else return s CheckForNull public static String fixEmpty CheckForNull String s if s null s length 0 return null return s CheckForNull public static String fixEmptyAndTrim CheckForNull String s if s null return null return fixEmpty s trim Nonnull public static T List T fixNull CheckForNull List T l return l null l Collections T emptyList Nonnull public static T Set T fixNull CheckForNull Set T l return l null l Collections T emptySet Nonnull public static T Collection T fixNull CheckForNull Collection T l return l null l Collections T emptySet Nonnull public static T Iterable T fixNull CheckForNull Iterable T l return l null l Collections T emptySet Nonnull public static String getFileName Nonnull String filePath int idx filePath lastIndexOf if idx 0 return getFileName filePath substring idx 1 idx filePath lastIndexOf if idx 0 return getFileName filePath substring idx 1 return filePath Nonnull public static String join Nonnull Collection strings Nonnull String separator StringBuilder buf new StringBuilder boolean first true for Object s strings if first first false else buf append separator buf append s return buf toString Nonnull public static T List T join Nonnull Collection extends T items int size 0 for Collection extends T item items size item size List T r new ArrayList T size for Collection extends T item items r addAll item return r Nonnull public static FileSet createFileSet Nonnull File baseDir Nonnull String includes CheckForNull String excludes FileSet fs new FileSet fs setDir baseDir fs setProject new Project StringTokenizer tokens tokens new StringTokenizer includes while tokens hasMoreTokens String token tokens nextToken trim fs createInclude setName token if excludes null tokens new StringTokenizer excludes while tokens hasMoreTokens String token tokens nextToken trim fs createExclude setName token return fs Nonnull public static FileSet createFileSet Nonnull File baseDir Nonnull String includes return createFileSet baseDir includes null public static void createSymlink Nonnull File baseDir Nonnull String targetPath Nonnull String symlinkPath Nonnull TaskListener listener throws InterruptedException try if createSymlinkJava7 baseDir targetPath symlinkPath return if NO SYMLINK return File symlinkFile new File baseDir symlinkPath if Functions isWindows if symlinkFile exists symlinkFile delete File dst new File symlinkFile targetPath try Kernel32Utils createSymbolicLink symlinkFile targetPath dst isDirectory catch WinIOException e if e getErrorCode 1314 warnWindowsSymlink return throw e catch UnsatisfiedLinkError e not available on this Windows return else String errmsg if a file or a directory exists here delete it first try simple delete first whether exists or not as it may be symlink pointing to non existent target but fallback to rm rf to delete non empty dir if symlinkFile delete symlinkFile exists ignore a failure new LocalProc new String rm rf symlinkPath new String 0 listener getLogger baseDir join Integer r null if SYMLINK ESCAPEHATCH try r LIBC symlink targetPath symlinkFile getAbsolutePath if r 0 r Native getLastError errmsg LIBC strerror r catch LinkageError e if JNA is unavailable fall back we still prefer to try JNA first as PosixAPI supports even smaller platforms POSIX posix PosixAPI jnr if posix isNative TODO should we rethrow PosixException as IOException here r posix symlink targetPath symlinkFile getAbsolutePath if r null if all else fail fall back to the most expensive approach of forking a process TODO is this really necessary JavaPOSIX should do this automatically r new LocalProc new String ln s targetPath symlinkPath new String 0 listener getLogger baseDir join if r 0 listener getLogger println String format ln s s s failed d s targetPath symlinkFile r errmsg catch IOException e PrintStream log listener getLogger log printf ln s s failed n targetPath new File baseDir symlinkPath Util displayIOException e listener e printStackTrace log private static boolean createSymlinkJava7 Nonnull File baseDir Nonnull String targetPath Nonnull String symlinkPath throws IOException try Path path new File baseDir symlinkPath toPath Path target Paths get targetPath new String 0 final int maxNumberOfTries 4 final int timeInMillis 100 for int tryNumber 1 tryNumber maxNumberOfTries tryNumber Files deleteIfExists path try Files createSymbolicLink path target break catch FileAlreadyExistsException fileAlreadyExistsException if tryNumber maxNumberOfTries TimeUnit MILLISECONDS sleep timeInMillis trying to defeat likely ongoing race condition continue LOGGER warning symlink FileAlreadyExistsException thrown maxNumberOfTries times cannot createSymbolicLink throw fileAlreadyExistsException return true catch UnsupportedOperationException e return true no symlinks on this platform catch FileSystemException e if Functions isWindows warnWindowsSymlink return true return false catch IOException x throw x catch Exception x throw IOException new IOException x toString initCause x private static final AtomicBoolean warnedSymlinks new AtomicBoolean private static void warnWindowsSymlink if warnedSymlinks compareAndSet false true LOGGER warning Symbolic links enabled on this platform but disabled for this user run as administrator or use Local Security Policy Security Settings Local Policies User Rights Assignment Create symbolic links Deprecated public static String resolveSymlink File link TaskListener listener throws InterruptedException IOException return resolveSymlink link CheckForNull public static File resolveSymlinkToFile Nonnull File link throws InterruptedException IOException String target resolveSymlink link if target null return null File f new File target if f isAbsolute return f absolute symlink return new File link getParentFile target relative symlink CheckForNull public static String resolveSymlink Nonnull File link throws InterruptedException IOException try Path path link toPath return Files readSymbolicLink path toString catch UnsupportedOperationException FileSystemException x no symlinks on this platform windows or not a link Thrown Incorrect function on JDK 7u21 in Windows 2012 when called on a non symlink rather than NotLinkException contrary to documentation Maybe only when not on NTFS return null catch IOException x throw x catch Exception x throw IOException new IOException x toString initCause x Deprecated public static String encodeRFC2396 String url try return new URI null url null toASCIIString catch URISyntaxException e LOGGER warning Failed to encode url could this ever happen return url Nonnull public static String wrapToErrorSpan Nonnull String s s span class error style display inline block s span return s CheckForNull public static Number tryParseNumber CheckForNull String numberStr CheckForNull Number defaultNumber if numberStr null numberStr length 0 return defaultNumber try return NumberFormat getNumberInstance parse numberStr catch ParseException e return defaultNumber public static boolean isOverridden Nonnull Class base Nonnull Class derived Nonnull String methodName Nonnull Class types return getMethod base methodName types equals getMethod derived methodName types private static Method getMethod Nonnull Class clazz Nonnull String methodName Nonnull Class types Method res null try res clazz getDeclaredMethod methodName types private static or final methods can not be overridden if res null Modifier isPrivate res getModifiers Modifier isFinal res getModifiers Modifier isStatic res getModifiers res null catch NoSuchMethodException e Method not found in clazz let s search in superclasses Class superclass clazz getSuperclass if superclass null res getMethod superclass methodName types catch SecurityException e throw new AssertionError e if res null throw new IllegalArgumentException String format Method s not found in s or it is private final or static methodName clazz getName return res Nonnull public static File changeExtension Nonnull File dst Nonnull String ext String p dst getPath int pos p lastIndexOf if pos 0 return new File p ext else return new File p substring 0 pos ext Nullable public static String intern CheckForNull String s return s null s s intern Deprecated RestrictedSince 1 651 2 2 TODO Restricted NoExternalUse class public static boolean isAbsoluteUri Nonnull String uri int idx uri indexOf if idx 0 return false no can t be absolute and must not be before return idx indexOf uri idx indexOf uri idx indexOf uri public static boolean isSafeToRedirectTo Nonnull String uri return isAbsoluteUri uri uri startsWith private static int indexOf Nonnull String s char ch int idx s indexOf ch if idx 0 return s length return idx Nonnull public static Properties loadProperties Nonnull String properties throws IOException Properties p new Properties p load new StringReader properties return p Restricted NoExternalUse class public static void closeAndLogFailures CheckForNull Closeable toClose Nonnull Logger logger Nonnull String closeableName Nonnull String closeableOwner if toClose null return try toClose close catch IOException ex logger log Level WARNING String format Failed to close s of s closeableName closeableOwner ex public static final FastDateFormat XS DATETIME FORMATTER FastDateFormat getInstance yyyy MM dd T HH mm ss Z new SimpleTimeZone 0 GMT Note RFC822 dates must not be localized public static final FastDateFormat RFC822 DATETIME FORMATTER FastDateFormat getInstance EEE dd MMM yyyy HH mm ss Z Locale US private static final Logger LOGGER Logger getLogger Util class getName public static boolean NO SYMLINK SystemProperties getBoolean Util class getName noSymLink public static boolean SYMLINK ESCAPEHATCH SystemProperties getBoolean Util class getName symlinkEscapeHatch Restricted value NoExternalUse class static int DELETION MAX Math max 1 SystemProperties getInteger Util class getName maxFileDeletionRetries 3 intValue Restricted value NoExternalUse class static int WAIT BETWEEN DELETION RETRIES SystemProperties getInteger Util class getName deletionRetryWait 100 intValue Restricted value NoExternalUse class static boolean GC AFTER FAILED DELETE SystemProperties getBoolean Util class getName performGCOnFailedDeletepackage com twitter sdk android tweetui import com twitter sdk android core models Tweet import java util ArrayList import java util HashMap import java util List final class Utils private Utils static Long numberOrDefault String candidate long defaultLong try return Long parseLong candidate catch NumberFormatException e return defaultLong static String stringOrEmpty String candidate return stringOrDefault candidate static String stringOrDefault String candidate String defaultString return candidate null candidate defaultString static CharSequence charSeqOrEmpty CharSequence candidate return charSeqOrDefault candidate static CharSequence charSeqOrDefault CharSequence candidate CharSequence defaultSequence return candidate null candidate defaultSequence static List Tweet orderTweets List Long tweetIds List Tweet tweets final HashMap Long Tweet idToTweet new HashMap final ArrayList Tweet ordered new ArrayList for Tweet tweet tweets idToTweet put tweet id tweet for Long id tweetIds if idToTweet containsKey id ordered add idToTweet get id return orderedpackage hudson util import java util Collection import java util Map public interface VariableResolver V V resolve String name VariableResolver NONE new VariableResolver public Object resolve String name return null final class ByMap V implements VariableResolver V private final Map String V data public ByMap Map String V data this data data public V resolve String name return data get name final class Union V implements VariableResolver V private final VariableResolver extends V resolvers public Union VariableResolver extends V resolvers this resolvers resolvers clone public Union Collection extends VariableResolver extends V resolvers this resolvers resolvers toArray new VariableResolver resolvers size public V resolve String name for VariableResolver extends V r resolvers V v r resolve name if v null return v return nullpackage hudson cli import hudson Extension import jenkins model Jenkins Extension public class VersionCommand extends CLICommand Override public String getShortDescription return Messages VersionCommand ShortDescription protected int run CLICommand main checks Hudson READ permission no other check needed stdout println Jenkins VERSION return 0package com twitter sdk android tweetui internal import android annotation SuppressLint import android content Context import android os Handler import android os Message import android util AttributeSet import android view LayoutInflater import android view View import android widget FrameLayout import android widget ImageButton import android widget SeekBar import android widget TextView import com twitter sdk android tweetui R public class VideoControlView extends FrameLayout static final long PROGRESS BAR TICKS 1000L static final int FADE DURATION MS 150 private static final int SHOW PROGRESS MSG 1001 MediaPlayerControl player ImageButton stateControl TextView currentTime TextView duration SeekBar seekBar public VideoControlView Context context super context public VideoControlView Context context AttributeSet attrs super context attrs public VideoControlView Context context AttributeSet attrs int defStyleAttr super context attrs defStyleAttr SuppressLint HandlerLeak private final Handler handler new Handler Override public void handleMessage Message msg if msg what SHOW PROGRESS MSG if player null return updateProgress updateStateControl if isShowing player isPlaying msg obtainMessage SHOW PROGRESS MSG sendMessageDelayed msg 500 public void setMediaPlayer MediaPlayerControl player this player player Override protected void onFinishInflate super onFinishInflate initSubviews void initSubviews final LayoutInflater inflater LayoutInflater getContext getSystemService Context LAYOUT INFLATER SERVICE inflater inflate R layout tw video control this stateControl ImageButton findViewById R id tw state control currentTime TextView findViewById R id tw current time duration TextView findViewById R id tw duration seekBar SeekBar findViewById R id tw progress seekBar setMax int PROGRESS BAR TICKS seekBar setOnSeekBarChangeListener createProgressChangeListener stateControl setOnClickListener createStateControlClickListener setDuration 0 setCurrentTime 0 setProgress 0 0 0 OnClickListener createStateControlClickListener return new OnClickListener Override public void onClick View view if player isPlaying player pause else player start show SeekBar OnSeekBarChangeListener createProgressChangeListener return new SeekBar OnSeekBarChangeListener Override public void onProgressChanged SeekBar seekBar int progress boolean fromUser if fromUser return final int duration player getDuration final long position duration progress PROGRESS BAR TICKS player seekTo int position setCurrentTime int position Override public void onStartTrackingTouch SeekBar seekBar handler removeMessages SHOW PROGRESS MSG Override public void onStopTrackingTouch SeekBar seekBar handler sendEmptyMessage SHOW PROGRESS MSG void updateProgress final int duration player getDuration final int currentTime player getCurrentPosition final int bufferPercentage player getBufferPercentage setDuration duration setCurrentTime currentTime setProgress currentTime duration bufferPercentage void setDuration int durationMillis duration setText MediaTimeUtils getPlaybackTime durationMillis void setCurrentTime int currentTimeMillis currentTime setText MediaTimeUtils getPlaybackTime currentTimeMillis void setProgress int currentTimeMillis int durationMillis int bufferPercentage final long pos durationMillis 0 PROGRESS BAR TICKS currentTimeMillis durationMillis 0 seekBar setProgress int pos seekBar setSecondaryProgress bufferPercentage 10 void updateStateControl if player isPlaying setPauseDrawable else if player getCurrentPosition Math max player getDuration 500 0 setReplayDrawable else setPlayDrawable void setPlayDrawable stateControl setImageResource R drawable tw video play btn stateControl setContentDescription getContext getString R string tw play void setPauseDrawable stateControl setImageResource R drawable tw video pause btn stateControl setContentDescription getContext getString R string tw pause void setReplayDrawable stateControl setImageResource R drawable tw video replay btn stateControl setContentDescription getContext getString R string tw replay void hide handler removeMessages SHOW PROGRESS MSG AnimationUtils fadeOut this FADE DURATION MS void show handler sendEmptyMessage SHOW PROGRESS MSG AnimationUtils fadeIn this FADE DURATION MS public boolean isShowing return getVisibility View VISIBLE public void update handler sendEmptyMessage SHOW PROGRESS MSG public interface MediaPlayerControl void start void pause int getDuration int getCurrentPosition void seekTo int position boolean isPlaying int getBufferPercentagepackage com twitter sdk android core models import com google gson annotations SerializedName import java io Serializable import java util List public class VideoInfo implements Serializable SerializedName aspect ratio public final List Integer aspectRatio SerializedName duration millis public final long durationMillis SerializedName variants public final List Variant variants public VideoInfo List Integer aspectRatio long durationMillis List Variant variants this aspectRatio aspectRatio this durationMillis durationMillis this variants variants public static class Variant implements Serializable SerializedName bitrate public final long bitrate SerializedName content type public final String contentType SerializedName url public final String url public Variant long bitrate String contentType String url this bitrate bitrate this contentType contentType this url urlpackage com twitter sdk android tweetui import com twitter sdk android core internal scribe ScribeItem public interface VideoScribeClient void impression ScribeItem card void play ScribeItem cardpackage com twitter sdk android tweetui import com twitter sdk android core internal scribe EventNamespace import com twitter sdk android core internal scribe ScribeItem import com twitter sdk android core internal scribe SyndicationClientEvent import java util ArrayList import java util List class VideoScribeClientImpl implements VideoScribeClient static final String TFW CLIENT EVENT PAGE android static final String TFW CLIENT EVENT SECTION video static final String SCRIBE IMPRESSION ACTION impression static final String SCRIBE PLAY ACTION play final TweetUi tweetUi VideoScribeClientImpl TweetUi tweetUi this tweetUi tweetUi Override public void impression ScribeItem scribeItem final List ScribeItem items new ArrayList items add scribeItem tweetUi scribe getTfwImpressionNamespace items Override public void play ScribeItem scribeItem final List ScribeItem items new ArrayList items add scribeItem tweetUi scribe getTfwPlayNamespace items static EventNamespace getTfwImpressionNamespace return new EventNamespace Builder setClient SyndicationClientEvent CLIENT NAME setPage TFW CLIENT EVENT PAGE setSection TFW CLIENT EVENT SECTION setAction SCRIBE IMPRESSION ACTION builder static EventNamespace getTfwPlayNamespace return new EventNamespace Builder setClient SyndicationClientEvent CLIENT NAME setPage TFW CLIENT EVENT PAGE setSection TFW CLIENT EVENT SECTION setAction SCRIBE PLAY ACTION builderpackage com twitter sdk android tweetui internal import android content Context import android media AudioManager import android media MediaPlayer import android media MediaPlayer OnCompletionListener import android media MediaPlayer OnErrorListener import android media MediaPlayer OnInfoListener import android net Uri import android util AttributeSet import android util Log import android view KeyEvent import android view MotionEvent import android view SurfaceHolder import android view SurfaceView public class VideoView extends SurfaceView implements VideoControlView MediaPlayerControl private String TAG VideoView settable by the client private Uri mUri all possible internal states private static final int STATE ERROR 1 private static final int STATE IDLE 0 private static final int STATE PREPARING 1 private static final int STATE PREPARED 2 private static final int STATE PLAYING 3 private static final int STATE PAUSED 4 private static final int STATE PLAYBACK COMPLETED 5 mCurrentState is a VideoView object s current state mTargetState is the state that a method caller intends to reach For instance regardless the VideoView object s current state calling pause intends to bring the object to a target state of STATE PAUSED private int mCurrentState STATE IDLE private int mTargetState STATE IDLE All the stuff we need for playing and showing a video private SurfaceHolder mSurfaceHolder null private MediaPlayer mMediaPlayer null private int mAudioSession private int mVideoWidth private int mVideoHeight private int mSurfaceWidth private int mSurfaceHeight private VideoControlView mMediaController private OnCompletionListener mOnCompletionListener private MediaPlayer OnPreparedListener mOnPreparedListener private int mCurrentBufferPercentage private OnErrorListener mOnErrorListener private OnInfoListener mOnInfoListener private int mSeekWhenPrepared recording the seek position while preparing private boolean mLooping public VideoView Context context super context initVideoView public VideoView Context context AttributeSet attrs this context attrs 0 public VideoView Context context AttributeSet attrs int defStyleAttr super context attrs defStyleAttr initVideoView Override protected void onMeasure int widthMeasureSpec int heightMeasureSpec Log i onMeasure MeasureSpec toString widthMeasureSpec MeasureSpec toString heightMeasureSpec int width getDefaultSize mVideoWidth widthMeasureSpec int height getDefaultSize mVideoHeight heightMeasureSpec if mVideoWidth 0 mVideoHeight 0 int widthSpecMode MeasureSpec getMode widthMeasureSpec int widthSpecSize MeasureSpec getSize widthMeasureSpec int heightSpecMode MeasureSpec getMode heightMeasureSpec int heightSpecSize MeasureSpec getSize heightMeasureSpec if widthSpecMode MeasureSpec EXACTLY heightSpecMode MeasureSpec EXACTLY the size is fixed width widthSpecSize height heightSpecSize for compatibility we adjust size based on aspect ratio if mVideoWidth height width mVideoHeight Log i image too wide correcting width height mVideoWidth mVideoHeight else if mVideoWidth height width mVideoHeight Log i image too tall correcting height width mVideoHeight mVideoWidth else if widthSpecMode MeasureSpec EXACTLY only the width is fixed adjust the height to match aspect ratio if possible width widthSpecSize height width mVideoHeight mVideoWidth if heightSpecMode MeasureSpec AT MOST height heightSpecSize couldn t match aspect ratio within the constraints height heightSpecSize else if heightSpecMode MeasureSpec EXACTLY only the height is fixed adjust the width to match aspect ratio if possible height heightSpecSize width height mVideoWidth mVideoHeight if widthSpecMode MeasureSpec AT MOST width widthSpecSize couldn t match aspect ratio within the constraints width widthSpecSize else neither the width nor the height are fixed try to use actual video size width mVideoWidth height mVideoHeight if heightSpecMode MeasureSpec AT MOST height heightSpecSize too tall decrease both width and height height heightSpecSize width height mVideoWidth mVideoHeight if widthSpecMode MeasureSpec AT MOST width widthSpecSize too wide decrease both width and height width widthSpecSize height width mVideoHeight mVideoWidth setMeasuredDimension width height private void initVideoView mVideoWidth 0 mVideoHeight 0 getHolder addCallback mSHCallback getHolder setType SurfaceHolder SURFACE TYPE PUSH BUFFERS setFocusable true setFocusableInTouchMode true requestFocus mCurrentState STATE IDLE mTargetState STATE IDLE public void setVideoURI Uri uri boolean looping mUri uri mLooping looping mSeekWhenPrepared 0 openVideo requestLayout invalidate public void stopPlayback if mMediaPlayer null mMediaPlayer stop mMediaPlayer release mMediaPlayer null mCurrentState STATE IDLE mTargetState STATE IDLE private void openVideo if mUri null mSurfaceHolder null not ready for playback just yet will try again later return we shouldn t clear the target state because somebody might have called start previously release false try mMediaPlayer new MediaPlayer if mAudioSession 0 mMediaPlayer setAudioSessionId mAudioSession else mAudioSession mMediaPlayer getAudioSessionId mMediaPlayer setOnPreparedListener mPreparedListener mMediaPlayer setOnVideoSizeChangedListener mSizeChangedListener mMediaPlayer setOnCompletionListener mCompletionListener mMediaPlayer setOnErrorListener mErrorListener mMediaPlayer setOnInfoListener mInfoListener mMediaPlayer setOnBufferingUpdateListener mBufferingUpdateListener mCurrentBufferPercentage 0 mMediaPlayer setLooping mLooping mMediaPlayer setDataSource getContext mUri mMediaPlayer setDisplay mSurfaceHolder mMediaPlayer setAudioStreamType AudioManager STREAM MUSIC mMediaPlayer setScreenOnWhilePlaying true mMediaPlayer prepareAsync we don t set the target state here either but preserve the target state that was there before mCurrentState STATE PREPARING attachMediaController catch Exception ex Log w TAG Unable to open content mUri ex mCurrentState STATE ERROR mTargetState STATE ERROR mErrorListener onError mMediaPlayer MediaPlayer MEDIA ERROR UNKNOWN 0 public void setMediaController VideoControlView controller if mMediaController null mMediaController hide mMediaController controller attachMediaController private void attachMediaController if mMediaPlayer null mMediaController null mMediaController setMediaPlayer this mMediaController setEnabled isInPlaybackState MediaPlayer OnVideoSizeChangedListener mSizeChangedListener new MediaPlayer OnVideoSizeChangedListener public void onVideoSizeChanged MediaPlayer mp int width int height mVideoWidth mp getVideoWidth mVideoHeight mp getVideoHeight if mVideoWidth 0 mVideoHeight 0 getHolder setFixedSize mVideoWidth mVideoHeight requestLayout MediaPlayer OnPreparedListener mPreparedListener new MediaPlayer OnPreparedListener public void onPrepared MediaPlayer mp mCurrentState STATE PREPARED if mOnPreparedListener null mOnPreparedListener onPrepared mMediaPlayer if mMediaController null mMediaController setEnabled true mVideoWidth mp getVideoWidth mVideoHeight mp getVideoHeight int seekToPosition mSeekWhenPrepared mSeekWhenPrepared may be changed after seekTo call if seekToPosition 0 seekTo seekToPosition if mVideoWidth 0 mVideoHeight 0 Log i video size mVideoWidth mVideoHeight getHolder setFixedSize mVideoWidth mVideoHeight if mSurfaceWidth mVideoWidth mSurfaceHeight mVideoHeight We didn t actually change the size it was already at the size we need so we won t get a surface changed callback so start the video here instead of in the callback if mTargetState STATE PLAYING start if mMediaController null mMediaController show else if isPlaying seekToPosition 0 getCurrentPosition 0 if mMediaController null Show the media controls when we re paused into a video and make em stick mMediaController show else We don t know the video size yet but should start anyway The video size might be reported to us later if mTargetState STATE PLAYING start private MediaPlayer OnCompletionListener mCompletionListener new MediaPlayer OnCompletionListener public void onCompletion MediaPlayer mp mCurrentState STATE PLAYBACK COMPLETED mTargetState STATE PLAYBACK COMPLETED if mOnCompletionListener null mOnCompletionListener onCompletion mMediaPlayer private MediaPlayer OnInfoListener mInfoListener new MediaPlayer OnInfoListener public boolean onInfo MediaPlayer mp int arg1 int arg2 if mOnInfoListener null mOnInfoListener onInfo mp arg1 arg2 return true private MediaPlayer OnErrorListener mErrorListener new MediaPlayer OnErrorListener public boolean onError MediaPlayer mp int framework err int impl err Log d TAG Error framework err impl err mCurrentState STATE ERROR mTargetState STATE ERROR if mMediaController null mMediaController hide if mOnErrorListener null if mOnErrorListener onError mMediaPlayer framework err impl err return true return true private MediaPlayer OnBufferingUpdateListener mBufferingUpdateListener new MediaPlayer OnBufferingUpdateListener public void onBufferingUpdate MediaPlayer mp int percent mCurrentBufferPercentage percent public void setOnPreparedListener MediaPlayer OnPreparedListener l mOnPreparedListener l public void setOnCompletionListener OnCompletionListener l mOnCompletionListener l public void setOnErrorListener OnErrorListener l mOnErrorListener l public void setOnInfoListener OnInfoListener l mOnInfoListener l SurfaceHolder Callback mSHCallback new SurfaceHolder Callback public void surfaceChanged SurfaceHolder holder int format int w int h mSurfaceWidth w mSurfaceHeight h boolean isValidState mTargetState STATE PLAYING boolean hasValidSize mVideoWidth w mVideoHeight h if mMediaPlayer null isValidState hasValidSize if mSeekWhenPrepared 0 seekTo mSeekWhenPrepared start if mMediaController null mMediaController show public void surfaceCreated SurfaceHolder holder mSurfaceHolder holder openVideo public void surfaceDestroyed SurfaceHolder holder after we return from this we can t use the surface any more mSurfaceHolder null if mMediaController null mMediaController hide release true private void release boolean cleartargetstate if mMediaPlayer null mMediaPlayer reset mMediaPlayer release mMediaPlayer null mCurrentState STATE IDLE if cleartargetstate mTargetState STATE IDLE Override public boolean onTouchEvent MotionEvent ev if isInPlaybackState mMediaController null toggleMediaControlsVisiblity return super onTouchEvent ev Override public boolean onTrackballEvent MotionEvent ev if isInPlaybackState mMediaController null toggleMediaControlsVisiblity return super onTrackballEvent ev Override public boolean onKeyDown int keyCode KeyEvent event boolean isKeyCodeSupported keyCode KeyEvent KEYCODE BACK keyCode KeyEvent KEYCODE VOLUME UP keyCode KeyEvent KEYCODE VOLUME DOWN keyCode KeyEvent KEYCODE MENU keyCode KeyEvent KEYCODE CALL keyCode KeyEvent KEYCODE ENDCALL if isInPlaybackState isKeyCodeSupported mMediaController null if keyCode KeyEvent KEYCODE HEADSETHOOK keyCode KeyEvent KEYCODE MEDIA PLAY PAUSE if mMediaPlayer isPlaying pause mMediaController show else start mMediaController hide return true else if keyCode KeyEvent KEYCODE MEDIA PLAY if mMediaPlayer isPlaying start mMediaController hide return true else if keyCode KeyEvent KEYCODE MEDIA STOP keyCode KeyEvent KEYCODE MEDIA PAUSE if mMediaPlayer isPlaying pause mMediaController show return true else toggleMediaControlsVisiblity return super onKeyDown keyCode event private void toggleMediaControlsVisiblity if mMediaController isShowing mMediaController hide else mMediaController show Override public void start if isInPlaybackState mMediaPlayer start mCurrentState STATE PLAYING mTargetState STATE PLAYING Override public void pause if isInPlaybackState if mMediaPlayer isPlaying mMediaPlayer pause mCurrentState STATE PAUSED mTargetState STATE PAUSED Override public int getDuration if isInPlaybackState return mMediaPlayer getDuration return 1 Override public int getCurrentPosition if isInPlaybackState return mMediaPlayer getCurrentPosition return 0 Override public void seekTo int msec if isInPlaybackState mMediaPlayer seekTo msec mSeekWhenPrepared 0 else mSeekWhenPrepared msec Override public boolean isPlaying return isInPlaybackState mMediaPlayer isPlaying Override public int getBufferPercentage if mMediaPlayer null return mCurrentBufferPercentage return 0 private boolean isInPlaybackState return mMediaPlayer null mCurrentState STATE ERROR mCurrentState STATE IDLE mCurrentState STATE PREPARINGpackage hudson model import com thoughtworks xstream converters ConversionException import com thoughtworks xstream io StreamException import com thoughtworks xstream io xml Xpp3Driver import hudson DescriptorExtensionList import hudson Extension import hudson ExtensionPoint import hudson Functions import hudson Indenter import hudson Util import hudson model Descriptor FormException import hudson model labels LabelAtomPropertyDescriptor import hudson model listeners ItemListener import hudson scm ChangeLogSet import hudson scm ChangeLogSet Entry import hudson search CollectionSearchIndex import hudson search SearchIndexBuilder import hudson security ACL import hudson security AccessControlled import hudson security Permission import hudson security PermissionGroup import hudson security PermissionScope import hudson tasks UserAvatarResolver import hudson util AlternativeUiTextProvider import hudson util AlternativeUiTextProvider Message import hudson util DescribableList import hudson util DescriptorList import hudson util FormApply import hudson util FormValidation import hudson util RunList import hudson util XStream2 import hudson views ListViewColumn import hudson widgets Widget import jenkins model Jenkins import jenkins model ModelObjectWithChildren import jenkins model item category Categories import jenkins model item category Category import jenkins model item category ItemCategory import jenkins util ProgressiveRendering import jenkins util xml XMLUtils import net sf json JSON import net sf json JSONArray import net sf json JSONObject import org apache commons jelly JellyContext import org apache commons lang StringUtils import org apache tools ant filters StringInputStream import org jenkins ui icon Icon import org jenkins ui icon IconSet import org kohsuke accmod restrictions DoNotUse import org kohsuke stapler HttpResponse import org kohsuke stapler HttpResponses import org kohsuke stapler Stapler import org kohsuke stapler StaplerRequest import org kohsuke stapler StaplerResponse import org kohsuke stapler WebMethod import org kohsuke stapler export Exported import org kohsuke stapler export ExportedBean import org kohsuke stapler interceptor RequirePOST import javax servlet ServletException import javax servlet http HttpServletResponse import javax xml transform Source import javax xml transform TransformerException import javax xml transform stream StreamResult import javax xml transform stream StreamSource import java io BufferedInputStream import java io ByteArrayInputStream import java io IOException import java io InputStream import java io OutputStream import java io Serializable import java io StringWriter import java util ArrayList import java util Arrays import java util Calendar import java util Collection import java util Collections import java util Comparator import java util GregorianCalendar import java util HashMap import java util HashSet import java util LinkedHashSet import java util List import java util Map import java util Set import java util logging Level import java util logging Logger import static javax servlet http HttpServletResponse SC BAD REQUEST import static jenkins model Jenkins import org kohsuke accmod Restricted import org kohsuke accmod restrictions NoExternalUse import org kohsuke stapler QueryParameter import org xml sax SAXException ExportedBean public abstract class View extends AbstractModelObject implements AccessControlled Describable View ExtensionPoint Saveable ModelObjectWithChildren protected ViewGroup owner protected String name protected String description protected boolean filterExecutors protected boolean filterQueue protected transient List Action transientActions private volatile DescribableList ViewProperty ViewPropertyDescriptor properties new PropertyList this protected View String name this name name protected View String name ViewGroup owner this name name this owner owner Exported name jobs public abstract Collection TopLevelItem getItems public Collection TopLevelItem getAllItems if this instanceof ViewGroup final Collection TopLevelItem items new LinkedHashSet TopLevelItem getItems for View view ViewGroup this getViews items addAll view getAllItems return Collections unmodifiableCollection items else return getItems public TopLevelItem getItem String name return getOwnerItemGroup getItem name public final TopLevelItem getJob String name return getItem name public abstract boolean contains TopLevelItem item Exported visibility 2 name name public String getViewName return name public void rename String newName throws Failure FormException if name equals newName return noop checkGoodName newName if owner getView newName null throw new FormException Messages Hudson ViewAlreadyExists newName name String oldName name name newName owner onViewRenamed this oldName newName public ViewGroup getOwner return owner public ItemGroup extends TopLevelItem getOwnerItemGroup try return owner getItemGroup catch AbstractMethodError e return Jenkins getInstance public View getOwnerPrimaryView try return getOwnerPrimaryView catch AbstractMethodError e return null private View getOwnerPrimaryView return owner getPrimaryView public List Action getOwnerViewActions try return getOwnerViewActions catch AbstractMethodError e return Jenkins getInstance getActions private List Action getOwnerViewActions return owner getViewActions Exported public String getDescription return description public DescribableList ViewProperty ViewPropertyDescriptor getProperties readResolve was the best place to do this but for compatibility reasons this class can no longer have readResolve the mechanism itself isn t suitable for class hierarchy see JENKINS 9431 until we have that putting this logic here synchronized PropertyList class if properties null properties new PropertyList this else properties setOwner this return properties public List ViewPropertyDescriptor getApplicablePropertyDescriptors List ViewPropertyDescriptor r new ArrayList ViewPropertyDescriptor for ViewPropertyDescriptor pd ViewProperty all if pd isEnabledFor this r add pd return r public void save throws IOException persistence is a part of the owner due to initialization timing issue it can be null when this method is called if owner null owner save Exported name property inline true public List ViewProperty getAllProperties return getProperties toList public ViewDescriptor getDescriptor return ViewDescriptor Jenkins getInstance getDescriptorOrDie getClass public String getDisplayName return getViewName public String getNewPronoun return AlternativeUiTextProvider get NEW PRONOUN this Messages AbstractItem Pronoun public boolean isEditable return true public boolean isAutomaticRefreshEnabled return true public boolean isFilterExecutors return filterExecutors public boolean isFilterQueue return filterQueue public List Widget getWidgets return Collections unmodifiableList Jenkins getInstance getWidgets public Iterable extends ListViewColumn getColumns return ListViewColumn createDefaultInitialColumnList public Indenter getIndenter return null public boolean isDefault return getOwnerPrimaryView this public List Computer getComputers Computer computers Jenkins getInstance getComputers if isFilterExecutors return Arrays asList computers List Computer result new ArrayList Computer HashSet Label labels new HashSet Label for Item item getItems if item instanceof AbstractProject labels addAll AbstractProject item getRelevantLabels for Computer c computers if isRelevant labels c result add c return result private boolean isRelevant Collection Label labels Computer computer Node node computer getNode if node null return false if labels contains null node getMode Mode NORMAL return true for Label l labels if l null l contains node return true return false private List Queue Item filterQueue List Queue Item base if isFilterQueue return base Collection TopLevelItem items getItems List Queue Item result new ArrayList Queue Item for Queue Item qi base if items contains qi task result add qi else if qi task instanceof AbstractProject AbstractProject project AbstractProject qi task if items contains project getRootProject result add qi return result public List Queue Item getQueueItems return filterQueue Arrays asList Jenkins getInstance getQueue getItems Deprecated public List Queue Item getApproximateQueueItemsQuickly return filterQueue Jenkins getInstance getQueue getApproximateItemsQuickly public String getUrl return isDefault owner null owner getUrl getViewUrl public String getViewUrl return owner null owner getUrl view Util rawEncode getViewName Override public String toString return super toString getViewUrl public String getSearchUrl return getUrl public List Action getActions List Action result new ArrayList Action result addAll getOwnerViewActions synchronized this if transientActions null updateTransientActions result addAll transientActions return result public synchronized void updateTransientActions transientActions TransientViewActionFactory createAllFor this public Object getDynamic String token for Action a getActions String url a getUrlName if url null continue if url equals token return a return null Exported visibility 2 name url public String getAbsoluteUrl return Jenkins getInstance getRootUrl getUrl public Api getApi return new Api this public String getPostConstructLandingPage return configure public ACL getACL return Jenkins getInstance getAuthorizationStrategy getACL this public void checkPermission Permission p getACL checkPermission p public boolean hasPermission Permission p return getACL hasPermission p Deprecated public void onJobRenamed Item item String oldName String newName ExportedBean defaultVisibility 2 public static final class UserInfo implements Comparable UserInfo private final User user private Calendar lastChange private AbstractProject project String avatar UserInfo User user AbstractProject p Calendar lastChange this user user this project p this lastChange lastChange Exported public User getUser return user Exported public Calendar getLastChange return lastChange Exported public AbstractProject getProject return project public String getLastChangeTimeString if lastChange null return N A long duration new GregorianCalendar getTimeInMillis ordinal return Util getTimeSpanString duration public String getTimeSortKey if lastChange null return return Util XS DATETIME FORMATTER format lastChange getTime public int compareTo UserInfo that long rhs that ordinal long lhs this ordinal if rhs lhs return 1 if rhs lhs return 1 return 0 private long ordinal if lastChange null return 0 return lastChange getTimeInMillis Deprecated public boolean hasPeople return People isApplicable getItems public People getPeople return new People this public AsynchPeople getAsynchPeople return new AsynchPeople this ExportedBean public static final class People Exported public final List UserInfo users public final ModelObject parent public People Jenkins parent this parent parent for Hudson really load all users Map User UserInfo users getUserInfo parent getItems User unknown User getUnknown for User u User getAll if u unknown continue skip the special unknown user if users containsKey u users put u new UserInfo u null null this users toList users public People View parent this parent parent this users toList getUserInfo parent getItems private Map User UserInfo getUserInfo Collection extends Item items Map User UserInfo users new HashMap User UserInfo for Item item items for Job job item getAllJobs if job instanceof AbstractProject AbstractProject p AbstractProject job for AbstractBuild build p getBuilds for Entry entry build getChangeSet User user entry getAuthor UserInfo info users get user if info null users put user new UserInfo user p build getTimestamp else if info getLastChange before build getTimestamp info project p info lastChange build getTimestamp return users private List UserInfo toList Map User UserInfo users ArrayList UserInfo list new ArrayList UserInfo list addAll users values Collections sort list return Collections unmodifiableList list public Api getApi return new Api this Deprecated public static boolean isApplicable Collection extends Item items for Item item items for Job job item getAllJobs if job instanceof AbstractProject AbstractProject p AbstractProject job for AbstractBuild build p getBuilds for Entry entry build getChangeSet User user entry getAuthor if user null return true return false public static final class AsynchPeople extends ProgressiveRendering JENKINS 15206 private final Collection TopLevelItem items private final User unknown private final Map User UserInfo users new HashMap User UserInfo private final Set User modified new HashSet User private final String iconSize public final ModelObject parent public AsynchPeople Jenkins parent this parent parent items parent getItems unknown User getUnknown public AsynchPeople View parent this parent parent items parent getItems unknown null StaplerRequest req Stapler getCurrentRequest iconSize req null Functions validateIconSize Functions getCookie req iconSize 32x32 32x32 Override protected void compute throws Exception int itemCount 0 for Item item items for Job job item getAllJobs if job instanceof AbstractProject AbstractProject p AbstractProject job RunList extends AbstractBuild builds p getBuilds int buildCount 0 for AbstractBuild build builds if canceled return for ChangeLogSet Entry entry build getChangeSet User user entry getAuthor UserInfo info users get user if info null UserInfo userInfo new UserInfo user p build getTimestamp userInfo avatar UserAvatarResolver resolveOrNull user iconSize synchronized this users put user userInfo modified add user else if info getLastChange before build getTimestamp synchronized this info project p info lastChange build getTimestamp modified add user TODO consider also adding the user of the UserCause when applicable buildCount TODO this defeats lazy loading Should rather do a breadth first search as in hudson plugins view dashboard builds LatestBuilds though currently there is no quick implementation of RunMap size idOnDisk size which would be needed for proper progress progress itemCount 1 0 buildCount builds size items size 1 itemCount progress 1 0 itemCount items size 1 if unknown null if canceled return for User u User getAll TODO nice to have a method to iterate these lazily if canceled return if u unknown continue if users containsKey u UserInfo userInfo new UserInfo u null null userInfo avatar UserAvatarResolver resolveOrNull u iconSize synchronized this users put u userInfo modified add u Override protected synchronized JSON data JSONArray r new JSONArray for User u modified UserInfo i users get u JSONObject entry new JSONObject accumulate id u getId accumulate fullName u getFullName accumulate url u getUrl accumulate avatar i avatar null i avatar Stapler getCurrentRequest getContextPath Functions getResourcePath images iconSize user png accumulate timeSortKey i getTimeSortKey accumulate lastChangeTimeString i getLastChangeTimeString AbstractProject p i getProject if p null entry accumulate projectUrl p getUrl accumulate projectFullDisplayName p getFullDisplayName r add entry modified clear return r public Api getApi return new Api new People Restricted NoExternalUse class ExportedBean public final class People private View People people Exported public synchronized List UserInfo getUsers if people null people parent instanceof Jenkins new View People Jenkins parent new View People View parent return people users void addDisplayNamesToSearchIndex SearchIndexBuilder sib Collection TopLevelItem items for TopLevelItem item items if LOGGER isLoggable Level FINE LOGGER fine String format Adding url s displayName s item getSearchUrl item getDisplayName sib add item getSearchUrl item getDisplayName Override public SearchIndexBuilder makeSearchIndex SearchIndexBuilder sib super makeSearchIndex sib add new CollectionSearchIndex TopLevelItem for jobs in the view protected TopLevelItem get String key return getItem key protected Collection TopLevelItem all return getItems Override protected String getName TopLevelItem o return the name instead of the display for suggestion searching return o getName add the display name for each item in the search index addDisplayNamesToSearchIndex sib getItems return sib RequirePOST public synchronized void doSubmitDescription StaplerRequest req StaplerResponse rsp throws IOException ServletException checkPermission CONFIGURE description req getParameter description save rsp sendRedirect go to the top page RequirePOST public final synchronized void doConfigSubmit StaplerRequest req StaplerResponse rsp throws IOException ServletException FormException checkPermission CONFIGURE submit req description Util nullify req getParameter description filterExecutors req getParameter filterExecutors null filterQueue req getParameter filterQueue null rename req getParameter name getProperties rebuild req req getSubmittedForm getApplicablePropertyDescriptors updateTransientActions save FormApply success Util rawEncode name generateResponse req rsp this protected abstract void submit StaplerRequest req throws IOException ServletException FormException RequirePOST public synchronized void doDoDelete StaplerRequest req StaplerResponse rsp throws IOException ServletException checkPermission DELETE owner deleteView this rsp sendRedirect2 req getContextPath owner getUrl public abstract Item doCreateItem StaplerRequest req StaplerResponse rsp throws IOException ServletException Restricted DoNotUse class called from newJob view public FormValidation doCheckJobName QueryParameter String value this method can be used to check if a file exists anywhere in the file system so it should be protected getOwner checkPermission Item CREATE if Util fixEmpty value null return FormValidation ok try Jenkins checkGoodName value value value trim why trim after checkGoodName not sure but ItemGroupMixIn createTopLevelItem does the same Jenkins getInstance getProjectNamingStrategy checkName value catch Failure e return FormValidation error e getMessage if getOwnerItemGroup getItem value null return FormValidation error Messages Hudson JobAlreadyExists value looks good return FormValidation ok Restricted DoNotUse class public Categories doItemCategories StaplerRequest req StaplerResponse rsp QueryParameter String iconStyle throws IOException ServletException getOwner checkPermission Item CREATE Categories categories new Categories int order 0 JellyContext ctx if StringUtils isNotBlank iconStyle ctx new JellyContext ctx setVariable resURL req getContextPath Jenkins RESOURCE PATH else ctx null for TopLevelItemDescriptor descriptor DescriptorVisibilityFilter apply getOwnerItemGroup Items all Jenkins getAuthentication getOwnerItemGroup ItemCategory ic ItemCategory getCategory descriptor Map String Serializable metadata new HashMap String Serializable Information about Item metadata put class descriptor getId metadata put order order metadata put displayName descriptor getDisplayName metadata put description descriptor getDescription metadata put iconFilePathPattern descriptor getIconFilePathPattern String iconClassName descriptor getIconClassName if StringUtils isNotBlank iconClassName metadata put iconClassName iconClassName if ctx null Icon icon IconSet icons getIconByClassSpec StringUtils join new String iconClassName iconStyle if icon null metadata put iconQualifiedUrl icon getQualifiedUrl ctx Category category categories getItem ic getId if category null category getItems add metadata else List Map String Serializable temp new ArrayList Map String Serializable temp add metadata category new Category ic getId ic getDisplayName ic getDescription ic getOrder ic getMinToShow temp categories getItems add category return categories public void doRssAll StaplerRequest req StaplerResponse rsp throws IOException ServletException rss req rsp all builds getBuilds public void doRssFailed StaplerRequest req StaplerResponse rsp throws IOException ServletException rss req rsp failed builds getBuilds failureOnly public RunList getBuilds return new RunList this public BuildTimelineWidget getTimeline return new BuildTimelineWidget getBuilds private void rss StaplerRequest req StaplerResponse rsp String suffix RunList runs throws IOException ServletException RSS forwardToRss getDisplayName suffix getUrl runs newBuilds Run FEED ADAPTER req rsp public void doRssLatest StaplerRequest req StaplerResponse rsp throws IOException ServletException List Run lastBuilds new ArrayList Run for TopLevelItem item getItems if item instanceof Job Job job Job item Run lb job getLastBuild if lb null lastBuilds add lb RSS forwardToRss getDisplayName last builds only getUrl lastBuilds Run FEED ADAPTER LATEST req rsp WebMethod name config xml public HttpResponse doConfigDotXml StaplerRequest req throws IOException if req getMethod equals GET read checkPermission READ return new HttpResponse public void generateResponse StaplerRequest req StaplerResponse rsp Object node throws IOException ServletException rsp setContentType application xml View this writeXml rsp getOutputStream if req getMethod equals POST submission updateByXml new StreamSource req getReader return HttpResponses ok huh return HttpResponses error SC BAD REQUEST Unexpected request method req getMethod public void writeXml OutputStream out throws IOException pity we don t have a handy way to clone Jenkins XSTREAM to temp add the omit Field XStream2 xStream2 new XStream2 xStream2 omitField View class owner xStream2 toXMLUTF8 View this out public void updateByXml Source source throws IOException checkPermission CONFIGURE StringWriter out new StringWriter try this allows us to use UTF 8 for storing data plus it checks any well formedness issue in the submitted data XMLUtils safeTransform source new StreamResult out out close catch TransformerException SAXException e throw new IOException Failed to persist configuration xml e try to reflect the changes by reloading try InputStream in new BufferedInputStream new ByteArrayInputStream out toString getBytes UTF 8 Do not allow overwriting view name as it might collide with another view in same ViewGroup and might not satisfy Jenkins checkGoodName String oldname name Jenkins XSTREAM unmarshal new Xpp3Driver createReader in this name oldname catch StreamException ConversionException Error e mostly reflection errors throw new IOException Unable to read e save public ContextMenu doChildrenContextMenu StaplerRequest request StaplerResponse response throws Exception ContextMenu m new ContextMenu for TopLevelItem i getItems m add i getShortUrl i getDisplayName return m Deprecated public static final DescriptorList View LIST new DescriptorList View View class public static DescriptorExtensionList View ViewDescriptor all return Jenkins getInstance View ViewDescriptor getDescriptorList View class public static List ViewDescriptor allInstantiable List ViewDescriptor r new ArrayList ViewDescriptor for ViewDescriptor d all if d isInstantiable r add d return r public static final Comparator View SORTER new Comparator View public int compare View lhs View rhs return lhs getViewName compareTo rhs getViewName public static final PermissionGroup PERMISSIONS new PermissionGroup View class Messages View Permissions Title public static final Permission CREATE new Permission PERMISSIONS Create Messages View CreatePermission Description Permission CREATE PermissionScope ITEM GROUP public static final Permission DELETE new Permission PERMISSIONS Delete Messages View DeletePermission Description Permission DELETE PermissionScope ITEM GROUP public static final Permission CONFIGURE new Permission PERMISSIONS Configure Messages View ConfigurePermission Description Permission CONFIGURE PermissionScope ITEM GROUP public static final Permission READ new Permission PERMISSIONS Read Messages View ReadPermission Description Permission READ PermissionScope ITEM GROUP to simplify access from Jelly public static Permission getItemCreatePermission return Item CREATE public static View create StaplerRequest req StaplerResponse rsp ViewGroup owner throws FormException IOException ServletException String mode req getParameter mode String requestContentType req getContentType if requestContentType null mode null mode equals copy throw new Failure No Content Type header set boolean isXmlSubmission requestContentType null requestContentType startsWith application xml requestContentType startsWith text xml String name req getParameter name checkGoodName name if owner getView name null throw new Failure Messages Hudson ViewAlreadyExists name if mode null mode length 0 if isXmlSubmission View v createViewFromXML name req getInputStream v owner owner rsp setStatus HttpServletResponse SC OK return v else throw new Failure Messages View MissingMode View v if mode null mode equals copy v copy req owner name else ViewDescriptor descriptor all findByName mode if descriptor null throw new Failure No view type mode is known create a view v descriptor newInstance req req getSubmittedForm v owner owner redirect to the config screen rsp sendRedirect2 req getContextPath v getUrl v getPostConstructLandingPage return v private static View copy StaplerRequest req ViewGroup owner String name throws IOException View v String from req getParameter from View src src owner getView from if src null if Util fixEmpty from null throw new Failure Specify which view to copy else throw new Failure No such view from String xml Jenkins XSTREAM toXML src v createViewFromXML name new StringInputStream xml return v public static View createViewFromXML String name InputStream xml throws IOException try InputStream in new BufferedInputStream xml View v View Jenkins XSTREAM fromXML in if name null v name name checkGoodName v name return v catch StreamException ConversionException Error e mostly reflection errors throw new IOException Unable to read e public static class PropertyList extends DescribableList ViewProperty ViewPropertyDescriptor private PropertyList View owner super owner public PropertyList needed for XStream deserialization public View getOwner return View owner Override protected void onModified throws IOException for ViewProperty p this p setView getOwner public static final Message View NEW PRONOUN new Message View private final static Logger LOGGER Logger getLogger View class getNamepackage hudson model import hudson views ListViewColumn import hudson views ListViewColumnDescriptor import hudson views ViewJobFilter import java util Iterator import java util List import jenkins model DirectlyModifiableTopLevelItemGroup import jenkins model Jenkins import org kohsuke accmod Restricted import org kohsuke accmod restrictions DoNotUse import org kohsuke stapler AncestorInPath import org kohsuke stapler QueryParameter public abstract class ViewDescriptor extends Descriptor View Override public String getDisplayName return super getDisplayName public boolean isInstantiable return true public final String getNewViewDetailPage return clazz getName replace replace newViewDetail jelly protected ViewDescriptor Class extends View clazz super clazz protected ViewDescriptor Restricted DoNotUse class public AutoCompletionCandidates doAutoCompleteCopyNewItemFrom QueryParameter final String value AncestorInPath ItemGroup container TODO do we need a permissions check here AutoCompletionCandidates candidates AutoCompletionCandidates ofJobNames TopLevelItem class value container if container instanceof DirectlyModifiableTopLevelItemGroup DirectlyModifiableTopLevelItemGroup modifiableContainer DirectlyModifiableTopLevelItemGroup container Iterator String it candidates getValues iterator while it hasNext TopLevelItem item Jenkins getInstance getItem it next container TopLevelItem class if item null continue if modifiableContainer canAdd item it remove return candidates public List Descriptor ListViewColumn getColumnsDescriptors return ListViewColumn all public List Descriptor ViewJobFilter getJobFiltersDescriptors return ViewJobFilter allpackage hudson model import hudson security AccessControlled import hudson views ViewsTabBar import java io IOException import java util Collection import java util List public interface ViewGroup extends Saveable ModelObject AccessControlled boolean canDelete View view void deleteView View view throws IOException Collection View getViews View getView String name View getPrimaryView String getUrl void onViewRenamed View view String oldName String newName ViewsTabBar getViewsTabBar ItemGroup extends TopLevelItem getItemGroup List Action getViewActionspackage hudson model import hudson model ItemGroupMixIn import hudson model View import hudson model ViewGroup import org kohsuke stapler export Exported import java io IOException import java util ArrayList import java util Collection import java util Collections import java util List public abstract class ViewGroupMixIn private final ViewGroup owner protected abstract List View views protected abstract String primaryView protected abstract void primaryView String newName protected ViewGroupMixIn ViewGroup owner this owner owner public void addView View v throws IOException v owner owner views add v owner save public boolean canDelete View view return view isDefault Cannot delete primary view public synchronized void deleteView View view throws IOException if views size 1 throw new IllegalStateException Cannot delete last view views remove view owner save public View getView String name for View v views if v getViewName equals name return v if name null name equals primaryView Fallback to subview of primary view if it is a ViewGroup View pv getPrimaryView if pv instanceof ViewGroup return ViewGroup pv getView name return null Exported public Collection View getViews List View orig views List View copy new ArrayList View orig size for View v orig if v hasPermission View READ copy add v Collections sort copy View SORTER return copy Exported public View getPrimaryView View v getView primaryView if v null fallback v views get 0 return v public void onViewRenamed View view String oldName String newName If this view was the default view change reference if oldName equals primaryView primaryView newNamepackage hudson model import jenkins util SystemProperties import hudson model Descriptor FormException import java io IOException import java util LinkedHashSet import java util Set import java util SortedMap import java util logging Level import java util logging Logger import javax servlet ServletException import jenkins model Jenkins import org kohsuke stapler StaplerRequest import org kohsuke stapler StaplerResponse public abstract class ViewJob JobT extends ViewJob JobT RunT RunT extends Run JobT RunT extends Job JobT RunT private static final Logger LOGGER Logger getLogger ViewJob class getName private transient long nextUpdate 0 protected transient RunMap RunT runs new RunMap RunT private transient boolean notLoaded true private transient volatile boolean reloadingInProgress private static ReloadThread reloadThread static synchronized void interruptReloadThread if reloadThread null reloadThread interrupt Deprecated protected ViewJob Jenkins parent String name super parent name protected ViewJob ItemGroup parent String name super parent name public boolean isBuildable return false Override public void onLoad ItemGroup extends Item parent String name throws IOException super onLoad parent name notLoaded true protected SortedMap Integer RunT getRuns if notLoaded runs null if none is loaded yet do so immediately synchronized this if runs null runs new RunMap RunT if notLoaded notLoaded false reload if nextUpdate System currentTimeMillis if reloadingInProgress schedule a new reloading operation we don t want to block the current thread so reloading is done asynchronously reloadingInProgress true Set ViewJob reloadQueue synchronized ViewJob class if reloadThread null reloadThread new ReloadThread reloadThread start reloadQueue reloadThread reloadQueue synchronized reloadQueue reloadQueue add this reloadQueue notify return runs public void removeRun RunT run if runs null runs remove run LOGGER log Level WARNING 0 did not contain 1 to begin with new Object this run private void reload try reload finally reloadingInProgress false nextUpdate reloadPeriodically System currentTimeMillis 1000 60 Long MAX VALUE protected abstract void reload Override protected void submit StaplerRequest req StaplerResponse rsp throws IOException ServletException FormException super submit req rsp make sure to reload to reflect this config change nextUpdate 0 private static final class ReloadThread extends Thread final Set ViewJob reloadQueue new LinkedHashSet ViewJob private ReloadThread setName ViewJob reload thread private ViewJob getNext throws InterruptedException synchronized reloadQueue reload operations might eat InterruptException so check the status every so often while reloadQueue isEmpty terminating reloadQueue wait 60 1000 if terminating throw new InterruptedException terminate now ViewJob job reloadQueue iterator next reloadQueue remove job return job private boolean terminating return Jenkins getInstance isTerminating Override public void run while terminating try getNext reload catch InterruptedException e treat this as a death signal return catch Throwable t otherwise ignore any error t printStackTrace private static final Logger logger Logger getLogger ViewJob class getName public static boolean reloadPeriodically SystemProperties getBoolean ViewJob class getName reloadPeriodicallypackage hudson views import hudson DescriptorExtensionList import hudson ExtensionPoint import hudson model Describable import hudson model Descriptor import jenkins model Jenkins import hudson model TopLevelItem import hudson model View import java util List public abstract class ViewJobFilter implements ExtensionPoint Describable ViewJobFilter public static DescriptorExtensionList ViewJobFilter Descriptor ViewJobFilter all return Jenkins getInstance ViewJobFilter Descriptor ViewJobFilter getDescriptorList ViewJobFilter class SuppressWarnings unchecked public Descriptor ViewJobFilter getDescriptor return Jenkins getInstance getDescriptorOrDie getClass abstract public List TopLevelItem filter List TopLevelItem added List TopLevelItem all View filteringViewpackage hudson cli handlers import hudson model ViewGroup import hudson model View import java util StringTokenizer import jenkins model Jenkins import org acegisecurity AccessDeniedException import org kohsuke MetaInfServices import org kohsuke args4j CmdLineException import org kohsuke args4j CmdLineParser import org kohsuke args4j OptionDef import org kohsuke args4j spi OptionHandler import org kohsuke args4j spi Parameters import org kohsuke args4j spi Setter import javax annotation CheckForNull MetaInfServices public class ViewOptionHandler extends OptionHandler View public ViewOptionHandler CmdLineParser parser OptionDef option Setter View setter super parser option setter Override public int parseArguments Parameters params throws CmdLineException setter addValue getView params getParameter 0 return 1 CheckForNull public View getView final String name ViewGroup group Jenkins getActiveInstance View view null final StringTokenizer tok new StringTokenizer name while tok hasMoreTokens String viewName tok nextToken view group getView viewName if view null throw new IllegalArgumentException String format No view named s inside view s viewName group getDisplayName view checkPermission View READ if view instanceof ViewGroup group ViewGroup view else if tok hasMoreTokens throw new IllegalStateException view getViewName view can not contain views return view Override public String getDefaultMetaVariable return VIEWpackage hudson model import hudson DescriptorExtensionList import hudson ExtensionPoint import jenkins model Jenkins import net sf json JSONObject import org kohsuke stapler StaplerRequest public class ViewProperty implements ReconfigurableDescribable ViewProperty ExtensionPoint protected transient View view final void setView View view this view view public ViewPropertyDescriptor getDescriptor return ViewPropertyDescriptor Jenkins getInstance getDescriptorOrDie getClass public static DescriptorExtensionList ViewProperty ViewPropertyDescriptor all return Jenkins getInstance ViewProperty ViewPropertyDescriptor getDescriptorList ViewProperty class public ViewProperty reconfigure StaplerRequest req JSONObject form throws Descriptor FormException return form null null getDescriptor newInstance req formpackage hudson model public abstract class ViewPropertyDescriptor extends Descriptor ViewProperty protected ViewPropertyDescriptor Class extends ViewProperty clazz super clazz protected ViewPropertyDescriptor public ViewProperty newInstance View view return null public boolean isEnabledFor View view return truepackage hudson views import hudson DescriptorExtensionList import hudson Extension import hudson ExtensionPoint import hudson model AbstractDescribableImpl import hudson model Descriptor import hudson model Descriptor FormException import jenkins model GlobalConfiguration import jenkins model Jenkins import hudson model ListView import net sf json JSONObject import org jenkinsci Symbol import org kohsuke stapler StaplerRequest public abstract class ViewsTabBar extends AbstractDescribableImpl ViewsTabBar implements ExtensionPoint public static DescriptorExtensionList ViewsTabBar Descriptor ViewsTabBar all return Jenkins getInstance ViewsTabBar Descriptor ViewsTabBar getDescriptorList ViewsTabBar class Override public ViewsTabBarDescriptor getDescriptor return ViewsTabBarDescriptor super getDescriptor Extension ordinal 310 Symbol viewsTabBar public static class GlobalConfigurationImpl extends GlobalConfiguration public ViewsTabBar getViewsTabBar return Jenkins getInstance getViewsTabBar Override public boolean configure StaplerRequest req JSONObject json throws FormException for compatibility reasons the actual value is stored in Jenkins Jenkins j Jenkins getInstance if json has viewsTabBar j setViewsTabBar req bindJSON ViewsTabBar class json getJSONObject viewsTabBar else j setViewsTabBar new DefaultViewsTabBar return truepackage hudson views import hudson model Descriptor public abstract class ViewsTabBarDescriptor extends Descriptor ViewsTabBar so far nothing different from plain Descriptor but it may prove useful for future expansionpackage com twitter sdk android core internal import com twitter sdk android core models Card import com twitter sdk android core models ImageValue import com twitter sdk android core models UserValue public class VineCardUtils public static final String PLAYER CARD player public static final String VINE CARD vine public static final long VINE USER ID 586671909 private VineCardUtils public static boolean isVine Card card return PLAYER CARD equals card name VINE CARD equals card name isVineUser card private static boolean isVineUser Card card final UserValue user card bindingValues get site try if user null Long parseLong user idStr VINE USER ID return true catch NumberFormatException ex return false return false public static String getPublisherId Card card final UserValue user value card bindingValues get site return user value idStr public static String getStreamUrl Card card return card bindingValues get player stream url public static String getCallToActionUrl Card card return card bindingValues get card url public static ImageValue getImageValue Card card return card bindingValues get player imagepackage jenkins util import hudson FilePath import hudson model DirectoryBrowserSupport import hudson remoting Callable import hudson remoting Channel import hudson remoting VirtualChannel import hudson util DirScanner import hudson util FileVisitor import java io File import java io FileInputStream import java io FileNotFoundException import java io IOException import java io InputStream import java io Serializable import java net URI import java nio file InvalidPathException import java nio file LinkOption import java util ArrayList import java util List import java util logging Level import java util logging Logger import javax annotation Nonnull import jenkins MasterToSlaveFileCallable public abstract class VirtualFile implements Comparable VirtualFile Serializable public abstract Nonnull String getName public abstract URI toURI public abstract VirtualFile getParent public abstract boolean isDirectory throws IOException public abstract boolean isFile throws IOException public abstract boolean exists throws IOException public abstract Nonnull VirtualFile list throws IOException public abstract Nonnull String list String glob throws IOException public abstract Nonnull VirtualFile child Nonnull String name public abstract long length throws IOException public abstract long lastModified throws IOException public abstract boolean canRead throws IOException public abstract InputStream open throws IOException Override public final int compareTo VirtualFile o return getName compareToIgnoreCase o getName Override public final boolean equals Object obj return obj instanceof VirtualFile toURI equals VirtualFile obj toURI Override public final int hashCode return toURI hashCode Override public final String toString return toURI toString public V V run Callable V IOException callable throws IOException return callable call public static VirtualFile forFile final File f return new FileVF f f private static final class FileVF extends VirtualFile private final File f private final File root FileVF File f File root this f f this root root Override public String getName return f getName Override public URI toURI return f toURI Override public VirtualFile getParent return new FileVF f getParentFile root Override public boolean isDirectory throws IOException if isIllegalSymlink return false return f isDirectory Override public boolean isFile throws IOException if isIllegalSymlink return false return f isFile Override public boolean exists throws IOException if isIllegalSymlink return false return f exists Override public VirtualFile list throws IOException if isIllegalSymlink return new VirtualFile 0 File kids f listFiles if kids null return new VirtualFile 0 VirtualFile vfs new VirtualFile kids length for int i 0 i kids length i vfs i new FileVF kids i root return vfs Override public String list String glob throws IOException if isIllegalSymlink return new String 0 return new Scanner glob invoke f null Override public VirtualFile child String name return new FileVF new File f name root Override public long length throws IOException if isIllegalSymlink return 0 return f length Override public long lastModified throws IOException if isIllegalSymlink return 0 return f lastModified Override public boolean canRead throws IOException if isIllegalSymlink return false return f canRead Override public InputStream open throws IOException if isIllegalSymlink throw new FileNotFoundException f getPath return new FileInputStream f private boolean isIllegalSymlink TODO JENKINS 26838 try String myPath f toPath toRealPath new LinkOption 0 toString String rootPath root toPath toRealPath new LinkOption 0 toString if myPath equals rootPath myPath startsWith rootPath File separatorChar return true catch IOException x Logger getLogger VirtualFile class getName log Level FINE could not determine symlink status of f x catch InvalidPathException x2 if this cannot be converted to a path it cannot be an illegal symlink as it cannot exist Logger getLogger VirtualFile class getName log Level FINE Could not convert f to path x2 return false public static VirtualFile forFilePath final FilePath f return new FilePathVF f private static final class FilePathVF extends VirtualFile private final FilePath f FilePathVF FilePath f this f f Override public String getName return f getName Override public URI toURI try return f toURI catch Exception x return URI create f getRemote Override public VirtualFile getParent return f getParent toVirtualFile Override public boolean isDirectory throws IOException try return f isDirectory catch InterruptedException x throw IOException new IOException x toString initCause x Override public boolean isFile throws IOException TODO should probably introduce a method for this purpose return exists isDirectory Override public boolean exists throws IOException try return f exists catch InterruptedException x throw IOException new IOException x toString initCause x Override public VirtualFile list throws IOException try List FilePath kids f list if kids null return new VirtualFile 0 VirtualFile vfs new VirtualFile kids size for int i 0 i vfs length i vfs i forFilePath kids get i return vfs catch InterruptedException x throw IOException new IOException x toString initCause x Override public String list String glob throws IOException try return f act new Scanner glob catch InterruptedException x throw IOException new IOException x toString initCause x Override public VirtualFile child String name return forFilePath f child name Override public long length throws IOException try return f length catch InterruptedException x throw IOException new IOException x toString initCause x Override public long lastModified throws IOException try return f lastModified catch InterruptedException x throw IOException new IOException x toString initCause x Override public boolean canRead throws IOException try return f act new Readable catch InterruptedException x throw IOException new IOException x toString initCause x Override public InputStream open throws IOException try return f read catch InterruptedException x throw IOException new IOException x toString initCause x Override public V V run Callable V IOException callable throws IOException try return f act callable catch InterruptedException x throw IOException new IOException x toString initCause x private static final class Scanner extends MasterToSlaveFileCallable String private final String glob Scanner String glob this glob glob Override public String invoke File f VirtualChannel channel throws IOException final List String paths new ArrayList String new DirScanner Glob glob null scan f new FileVisitor Override public void visit File f String relativePath throws IOException paths add relativePath return paths toArray new String paths size private static final class Readable extends MasterToSlaveFileCallable Boolean Override public Boolean invoke File f VirtualChannel channel throws IOException InterruptedException return f canReadpackage hudson cli import hudson Extension import hudson model Node import org kohsuke args4j Argument Extension public class WaitNodeOfflineCommand extends CLICommand Argument metaVar NODE usage Name of the node required true public Node node Override public String getShortDescription return Messages WaitNodeOfflineCommand ShortDescription Override protected int run throws Exception node toComputer waitUntilOffline return 0package hudson cli import hudson Extension import hudson model Node import org kohsuke args4j Argument Extension public class WaitNodeOnlineCommand extends CLICommand Argument metaVar NODE usage Name of the node required true public Node node Override public String getShortDescription return Messages WaitNodeOnlineCommand ShortDescription Override protected int run throws Exception node toComputer waitUntilOnline return 0package hudson logging import java io UnsupportedEncodingException import java lang ref WeakReference import java util logging ErrorManager import java util logging Filter import java util logging Formatter import java util logging Handler import java util logging Level import java util logging LogRecord import java util logging Logger public final class WeakLogHandler extends Handler private final WeakReference Handler target private final Logger logger public WeakLogHandler Handler target Logger logger this logger logger logger addHandler this this target new WeakReference Handler target public void publish LogRecord record Handler t resolve if t null t publish record public void flush Handler t resolve if t null t flush public void close throws SecurityException Handler t resolve if t null t close private Handler resolve Handler r target get if r null logger removeHandler this return r Override public void setFormatter Formatter newFormatter throws SecurityException super setFormatter newFormatter Handler t resolve if t null t setFormatter newFormatter Override public void setEncoding String encoding throws SecurityException UnsupportedEncodingException super setEncoding encoding Handler t resolve if t null t setEncoding encoding Override public void setFilter Filter newFilter throws SecurityException super setFilter newFilter Handler t resolve if t null t setFilter newFilter Override public void setErrorManager ErrorManager em super setErrorManager em Handler t resolve if t null t setErrorManager em Override public void setLevel Level newLevel throws SecurityException super setLevel newLevel Handler t resolve if t null t setLevel newLevel Override public boolean isLoggable LogRecord record Handler t resolve if t null return t isLoggable record else return super isLoggable recordpackage hudson views import hudson Extension import org jenkinsci Symbol import org kohsuke stapler DataBoundConstructor public class WeatherColumn extends ListViewColumn DataBoundConstructor public WeatherColumn Extension ordinal DEFAULT COLUMNS ORDINAL ICON START 2 Symbol weather public static class DescriptorImpl extends ListViewColumnDescriptor Override public String getDisplayName return Messages WeatherColumn DisplayNamepackage hudson import hudson security ACLContext import jenkins util SystemProperties import com thoughtworks xstream converters reflection PureJavaReflectionProvider import com thoughtworks xstream core JVM import com trilead ssh2 util IOUtils import hudson model Hudson import hudson security ACL import hudson util BootFailure import jenkins model Jenkins import hudson util HudsonIsLoading import hudson util IncompatibleServletVersionDetected import hudson util IncompatibleVMDetected import hudson util InsufficientPermissionDetected import hudson util NoHomeDir import hudson util RingBufferLogHandler import hudson util NoTempDir import hudson util IncompatibleAntVersionDetected import hudson util HudsonFailedToLoad import hudson util ChartUtil import hudson util AWTProblem import jenkins util JenkinsJVM import org jvnet localizer LocaleProvider import org kohsuke stapler jelly JellyFacet import org apache tools ant types FileSet import javax naming Context import javax naming InitialContext import javax naming NamingException import javax servlet ServletContext import javax servlet ServletContextEvent import javax servlet ServletContextListener import javax servlet ServletResponse import javax xml transform TransformerFactory import javax xml transform TransformerFactoryConfigurationError import java io File import java io FileOutputStream import java io IOException import java net URL import java net URLClassLoader import java util Date import java util Locale import java util logging Level import java util logging Logger import java security Security import java util logging LogRecord import static java util logging Level public class WebAppMain implements ServletContextListener use RingBufferLogHandler class name to configure for backward compatibility private static final int DEFAULT RING BUFFER SIZE SystemProperties getInteger RingBufferLogHandler class getName defaultSize 256 private final RingBufferLogHandler handler new RingBufferLogHandler DEFAULT RING BUFFER SIZE Override public synchronized void publish LogRecord record if record getLevel intValue Level INFO intValue super publish record private static final String APP app private boolean terminated private Thread initThread public void contextInitialized ServletContextEvent event JenkinsJVMAccess setJenkinsJVM true final ServletContext context event getServletContext File home null try use the current request to determine the language LocaleProvider setProvider new LocaleProvider public Locale get return Functions getCurrentLocale quick check to see if we seem to have enough permissions to run see 719 JVM jvm try jvm new JVM new URLClassLoader new URL 0 getClass getClassLoader catch SecurityException e throw new InsufficientPermissionDetected e try remove Sun PKCS11 provider if present See http wiki jenkins ci org display JENKINS Solaris Issue 6276483 Security removeProvider SunPKCS11 Solaris catch SecurityException e ignore this error installLogger final FileAndDescription describedHomeDir getHomeDir event home describedHomeDir file getAbsoluteFile home mkdirs System out println Jenkins home directory home found at describedHomeDir description check that home exists as mkdirs could have failed silently otherwise throw a meaningful error if home exists throw new NoHomeDir home recordBootAttempt home make sure that we are using XStream in the enhanced JVM specific mode if jvm bestReflectionProvider getClass PureJavaReflectionProvider class throw new IncompatibleVMDetected nope JNA is no longer a hard requirement It s just nice to have See HUDSON 4820 for more context make sure JNA works this can fail if platform is unsupported JNA is already loaded in another classloader see http wiki jenkins ci org display JENKINS JNA is already loaded TODO or shall we instead modify Hudson to work gracefully without JNA try String valueOf Native POINTER SIZE this meaningless operation forces the classloading and initialization catch LinkageError e if e getMessage contains another classloader context setAttribute APP new JNADoublyLoaded e else context setAttribute APP new HudsonFailedToLoad e make sure this is servlet 2 4 container or above try ServletResponse class getMethod setCharacterEncoding String class catch NoSuchMethodException e throw new IncompatibleServletVersionDetected ServletResponse class make sure that we see Ant 1 7 try FileSet class getMethod getDirectoryScanner catch NoSuchMethodException e throw new IncompatibleAntVersionDetected FileSet class make sure AWT is functioning or else JFreeChart won t even load if ChartUtil awtProblemCause null throw new AWTProblem ChartUtil awtProblemCause some containers in particular Tomcat doesn t abort a launch even if the temp directory doesn t exist check that and report an error try File f File createTempFile test test f delete catch IOException e throw new NoTempDir e Tomcat breaks XSLT with JDK 5 0 and onward Check if that s the case and if so try to correct it try TransformerFactory newInstance if this works we are all happy catch TransformerFactoryConfigurationError x no it didn t LOGGER log WARNING XSLT not configured correctly Hudson will try to fix this See http issues apache org bugzilla show bug cgi id 40895 for more details x System setProperty TransformerFactory class getName com sun org apache xalan internal xsltc trax TransformerFactoryImpl try TransformerFactory newInstance LOGGER info XSLT is set to the JAXP RI in JRE catch TransformerFactoryConfigurationError y LOGGER log SEVERE Failed to correct the problem installExpressionFactory event context setAttribute APP new HudsonIsLoading final File home home initThread new Thread Jenkins initialization thread Override public void run boolean success false try Jenkins instance new Hudson home context one last check to make sure everything is in order before we go live if Thread interrupted throw new InterruptedException context setAttribute APP instance BootFailure getBootFailureFile home delete at this point we are open for business and serving requests normally LOGGER info Jenkins is fully up and running success true catch Error e new HudsonFailedToLoad e publish context home throw e catch Exception e new HudsonFailedToLoad e publish context home finally Jenkins instance Jenkins getInstanceOrNull if success instance null instance cleanUp initThread start catch BootFailure e e publish context home catch Error RuntimeException e LOGGER log SEVERE Failed to initialize Jenkins e throw e public void joinInit throws InterruptedException initThread join private void recordBootAttempt File home FileOutputStream o null try o new FileOutputStream BootFailure getBootFailureFile home true o write new Date toString System getProperty line separator n toString getBytes catch IOException e LOGGER log WARNING Failed to record boot attempts e finally IOUtils closeQuietly o public static void installExpressionFactory ServletContextEvent event JellyFacet setExpressionFactory event new ExpressionFactory2 edu umd cs findbugs annotations SuppressFBWarnings LG LOST LOGGER DUE TO WEAK REFERENCE private void installLogger Jenkins logRecords handler getView Logger getLogger addHandler handler public static class FileAndDescription public final File file public final String description public FileAndDescription File file String description this file file this description description public FileAndDescription getHomeDir ServletContextEvent event check JNDI for the home directory first for String name HOME NAMES try InitialContext iniCtxt new InitialContext Context env Context iniCtxt lookup java comp env String value String env lookup name if value null value trim length 0 return new FileAndDescription new File value trim JNDI java comp env name look at one more place See issue 1314 value String iniCtxt lookup name if value null value trim length 0 return new FileAndDescription new File value trim JNDI name catch NamingException e ignore next the system property for String name HOME NAMES String sysProp SystemProperties getString name if sysProp null return new FileAndDescription new File sysProp trim SystemProperties getProperty name look at the env var next for String name HOME NAMES String env EnvVars masterEnvVars get name if env null return new FileAndDescription new File env trim getAbsoluteFile EnvVars masterEnvVars get name otherwise pick a place by ourselves String root event getServletContext getRealPath WEB INF workspace if root null File ws new File root trim if ws exists Hudson 1 42 used to prefer this before hudson so check the existence and if it s there use it otherwise if this is a new installation prefer hudson return new FileAndDescription ws getServletContext getRealPath WEB INF workspace File legacyHome new File new File System getProperty user home hudson if legacyHome exists return new FileAndDescription legacyHome user home hudson before rename this is where it was stored File newHome new File new File System getProperty user home jenkins return new FileAndDescription newHome user home jenkins public void contextDestroyed ServletContextEvent event try ACLContext old ACL as ACL SYSTEM terminated true Jenkins instance Jenkins getInstanceOrNull if instance null instance cleanUp Thread t initThread if t null t isAlive LOGGER log Level INFO Shutting down a Jenkins instance that was still starting up new Throwable reason t interrupt Logger is in the system classloader so if we don t do this the whole web app will never be undepoyed Logger getLogger removeHandler handler finally JenkinsJVMAccess setJenkinsJVM false private static final Logger LOGGER Logger getLogger WebAppMain class getName private static final class JenkinsJVMAccess extends JenkinsJVM private static void setJenkinsJVM boolean jenkinsJVM JenkinsJVM setJenkinsJVM jenkinsJVM private static final String HOME NAMES JENKINS HOME HUDSON HOMEpackage com twitter sdk android core identity class WebViewException extends Exception private static final long serialVersionUID 7397331487240298819L private final int errorCode private final String failingUrl public WebViewException int errorCode String description String failingUrl super description this errorCode errorCode this failingUrl failingUrl public int getErrorCode return errorCode public String getDescription return getMessage public String getFailingUrl return failingUrlpackage hudson security import hudson Extension import hudson Functions import hudson model Api import hudson model UnprotectedRootAction import java util ArrayList import java util List import jenkins model Jenkins import org acegisecurity Authentication import org acegisecurity GrantedAuthority import org jenkinsci Symbol import org kohsuke stapler export Exported import org kohsuke stapler export ExportedBean Extension Symbol whoAmI ExportedBean public class WhoAmI implements UnprotectedRootAction public Api getApi return new Api this Exported public String getName return auth getName Exported public boolean isAuthenticated return auth isAuthenticated Exported public boolean isAnonymous return Functions isAnonymous Exported public String getDetails return auth getDetails null auth getDetails toString null Exported public String getToString return auth toString private Authentication auth return Jenkins getAuthentication Exported public String getAuthorities if auth getAuthorities null return new String 0 List String authorities new ArrayList String for GrantedAuthority a auth getAuthorities authorities add a getAuthority return String authorities toArray new String authorities size Override public String getIconFileName return null Override public String getDisplayName return Who Am I Override public String getUrlName return whoAmIpackage hudson cli import hudson Extension import jenkins model Jenkins import org acegisecurity Authentication import org acegisecurity GrantedAuthority Extension public class WhoAmICommand extends CLICommand Override public String getShortDescription return Messages WhoAmICommand ShortDescription protected int run Authentication a Jenkins getAuthentication stdout println Authenticated as a getName stdout println Authorities for GrantedAuthority ga a getAuthorities stdout println ga getAuthority return 0package hudson widgets import hudson ExtensionPoint import hudson model View public abstract class Widget implements ExtensionPoint public String getUrlName return getClass getSimpleNamepackage hudson util jna import com sun jna Structure import com sun jna Pointer import java util Arrays import java util List public interface WINBASE class SECURITY ATTRIBUTES extends Structure public int nLength public Pointer lpSecurityDescriptor public boolean bInheritHandle Override protected List getFieldOrder return Arrays asList nLength lpSecurityDescriptor bInheritHandle class FILETIME extends Structure public int dwLowDateTime public int dwHighDateTime Override protected List getFieldOrder return Arrays asList dwLowDateTime dwHighDateTimepackage hudson lifecycle import com sun jna Native import hudson Functions import hudson Launcher LocalLauncher import hudson model ManagementLink import hudson model TaskListener import hudson util jna Kernel32Utils import hudson util jna SHELLEXECUTEINFO import hudson util jna Shell32 import jenkins model Jenkins import hudson AbortException import hudson Extension import jenkins util SystemProperties import hudson util StreamTaskListener import hudson util jna DotNet import org apache commons io IOUtils import org kohsuke stapler QueryParameter import org kohsuke stapler StaplerRequest import org kohsuke stapler StaplerResponse import org apache commons io FileUtils import org apache commons io output ByteArrayOutputStream import org apache tools ant taskdefs Move import org apache tools ant Project import org apache tools ant DefaultLogger import org apache tools ant types FileSet import javax servlet ServletException import java io File import java io FileInputStream import java io IOException import java util logging Logger import java util logging Level import java net URL import static hudson util jna SHELLEXECUTEINFO public class WindowsInstallerLink extends ManagementLink private final File hudsonWar private volatile File installationDir private WindowsInstallerLink File jenkinsWar this hudsonWar jenkinsWar public String getIconFileName return installer gif public String getUrlName return install public String getDisplayName return Messages WindowsInstallerLink DisplayName public String getDescription return Messages WindowsInstallerLink Description public boolean isInstalled return installationDir null public void doDoInstall StaplerRequest req StaplerResponse rsp QueryParameter dir String dir throws IOException ServletException if installationDir null installation already complete sendError Installation is already complete req rsp return if DotNet isInstalled 2 0 sendError NET Framework 2 0 or later is required for this feature req rsp return Jenkins getInstance checkPermission Jenkins ADMINISTER File dir new File dir getAbsoluteFile dir mkdirs if dir exists sendError Failed to create installation directory dir req rsp return try copy files over there copy req rsp dir getClass getResource windows service jenkins exe jenkins exe copy req rsp dir getClass getResource windows service jenkins exe config jenkins exe config copy req rsp dir getClass getResource windows service jenkins xml jenkins xml if hudsonWar getCanonicalFile equals new File dir jenkins war getCanonicalFile copy req rsp dir hudsonWar toURI toURL jenkins war install as a service ByteArrayOutputStream baos new ByteArrayOutputStream StreamTaskListener task new StreamTaskListener baos task getLogger println Installing a service int r runElevated new File dir jenkins exe install task dir if r 0 sendError baos toString req rsp return installation was successful installationDir dir rsp sendRedirect catch AbortException e this exception is used as a signal to terminate processing the error should have been already reported catch InterruptedException e throw new ServletException e private void copy StaplerRequest req StaplerResponse rsp File dir URL src String name throws ServletException IOException try FileUtils copyURLToFile src new File dir name catch IOException e LOGGER log Level SEVERE Failed to copy name e sendError Failed to copy name e getMessage req rsp throw new AbortException public void doRestart StaplerRequest req StaplerResponse rsp throws IOException ServletException if installationDir null if the user reloads the page after Hudson has restarted it comes back here In such a case don t let this restart Hudson so just send them back to the top page rsp sendRedirect req getContextPath return Jenkins getInstance checkPermission Jenkins ADMINISTER rsp forward this restart req final File oldRoot Jenkins getInstance getRootDir initiate an orderly shutdown after we finished serving this request new Thread terminator public void run try Thread sleep 1000 let the service start after we close our sockets to avoid conflicts Runtime getRuntime addShutdownHook new Thread service starter public void run try if oldRoot equals installationDir LOGGER info Moving data Move mv new Move Project p new Project p addBuildListener createLogger mv setProject p FileSet fs new FileSet fs setDir oldRoot fs setExcludes war protected final void sendError Exception e StaplerRequest req StaplerResponse rsp throws ServletException IOException sendError e getMessage req rsp protected final void sendError String message StaplerRequest req StaplerResponse rsp throws ServletException IOException req setAttribute message message req setAttribute pre true rsp forward Jenkins getInstance error req Extension public static WindowsInstallerLink registerIfApplicable if Functions isWindows return null this is a Windows only feature if Lifecycle get instanceof WindowsServiceLifecycle return null already installed as Windows service this system property is set by the launcher when we run java jar jenkins war and this is how we know where is jenkins war String war SystemProperties getString executable war if war null new File war exists WindowsInstallerLink link new WindowsInstallerLink new File war in certain situations where we know the user is just trying Jenkins like when Jenkins is launched from JNLP also put this link on the navigation bar to increase visibility if SystemProperties getString WindowsInstallerLink class getName prominent null Jenkins getInstance getActions add link return link return null static int runElevated File jenkinsExe String command TaskListener out File pwd throws IOException InterruptedException try return new LocalLauncher out launch cmds jenkinsExe command stdout out pwd pwd join catch IOException e if e getMessage contains CreateProcess e getMessage contains 740 fall through else throw e error code 740 is ERROR ELEVATION REQUIRED indicating that we run in UAC enabled Windows and we need to run this in an elevated privilege SHELLEXECUTEINFO sei new SHELLEXECUTEINFO sei fMask SEE MASK NOCLOSEPROCESS sei lpVerb runas sei lpFile jenkinsExe getAbsolutePath sei lpParameters redirect redirect log command sei lpDirectory pwd getAbsolutePath sei nShow SW HIDE if Shell32 INSTANCE ShellExecuteEx sei throw new IOException Failed to shellExecute Native getLastError try return Kernel32Utils waitForExitProcess sei hProcess finally FileInputStream fin new FileInputStream new File pwd redirect log IOUtils copy fin out getLogger fin close private static final Logger LOGGER Logger getLogger WindowsInstallerLink class getNamepackage hudson lifecycle import hudson FilePath import hudson Launcher LocalLauncher import hudson Util import jenkins model Jenkins import hudson util StreamTaskListener import hudson util jna Kernel32 import static hudson util jna Kernel32 MOVEFILE DELAY UNTIL REBOOT import static hudson util jna Kernel32 MOVEFILE REPLACE EXISTING import org apache commons io FileUtils import org apache commons io output ByteArrayOutputStream import java io File import java io IOException import java io FileWriter import java net URL import java util logging Level import java util logging Logger public class WindowsServiceLifecycle extends Lifecycle public WindowsServiceLifecycle updateJenkinsExeIfNeeded private void updateJenkinsExeIfNeeded try File rootDir Jenkins getInstance getRootDir URL exe getClass getResource windows service jenkins exe String ourCopy Util getDigestOf exe openStream for String name new String hudson exe jenkins exe try File currentCopy new File rootDir name if currentCopy exists continue String curCopy new FilePath currentCopy digest if ourCopy equals curCopy continue identical File stage new File rootDir name new FileUtils copyURLToFile exe stage Kernel32 INSTANCE MoveFileExA stage getAbsolutePath currentCopy getAbsolutePath MOVEFILE DELAY UNTIL REBOOT MOVEFILE REPLACE EXISTING LOGGER info Scheduled a replacement of name catch IOException e LOGGER log Level SEVERE Failed to replace name e catch InterruptedException e catch IOException e LOGGER log Level SEVERE Failed to replace jenkins exe e Override public void rewriteHudsonWar File by throws IOException File dest getHudsonWar this should be impossible given the canRewriteHudsonWar method but let s be defensive if dest null throw new IOException jenkins war location is not known backing up the old jenkins war before its lost due to upgrading unless we are trying to rewrite jenkins war by a backup itself File bak new File dest getPath bak if by equals bak FileUtils copyFile dest bak String baseName dest getName baseName baseName substring 0 baseName indexOf File rootDir Jenkins getInstance getRootDir File copyFiles new File rootDir baseName copies try FileWriter w new FileWriter copyFiles true w write by getAbsolutePath getHudsonWar getAbsolutePath n Override public void restart throws IOException InterruptedException File me getHudsonWar File home me getParentFile ByteArrayOutputStream baos new ByteArrayOutputStream StreamTaskListener task new StreamTaskListener baos task getLogger println Restarting a service String exe System getenv WINSW EXECUTABLE File executable if exe null executable new File exe else executable new File home hudson exe if executable exists executable new File home jenkins exe use restart to run hudson jenkins exe restart in a separate process so it doesn t kill itself int r new LocalLauncher task launch cmds executable restart stdout task pwd home join if r 0 throw new IOException baos toString private static final Logger LOGGER Logger getLogger WindowsServiceLifecycle class getNamepackage hudson util jna public interface WINERROR int ERROR SUCCESS 0 int NO ERROR 0 int ERROR FILE NOT FOUND 2 int ERROR MORE DATA 234 int ERROR NO MORE ITEMS 259package hudson util jna import com sun jna Native import hudson Util import java io IOException public class WinIOException extends IOException private final int errorCode Native getLastError public WinIOException public WinIOException String message super message public WinIOException String message Throwable cause super message initCause cause public WinIOException Throwable cause initCause cause Override public String getMessage return super getMessage error errorCode Util getWin32ErrorMessage errorCode public int getErrorCode return errorCodepackage hudson util jna public interface WINNT int DELETE 0x00010000 int READ CONTROL 0x00020000 int WRITE DAC 0x00040000 int WRITE OWNER 0x00080000 int SYNCHRONIZE 0x00100000 int STANDARD RIGHTS REQUIRED 0x000F0000 int STANDARD RIGHTS READ READ CONTROL int STANDARD RIGHTS WRITE READ CONTROL int STANDARD RIGHTS EXECUTE READ CONTROL int STANDARD RIGHTS ALL 0x001F0000 int SPECIFIC RIGHTS ALL 0x0000FFFF int GENERIC EXECUTE 0x20000000 int SERVICE WIN32 OWN PROCESS 0x00000010 int KEY QUERY VALUE 0x0001 int KEY SET VALUE 0x0002 int KEY CREATE SUB KEY 0x0004 int KEY ENUMERATE SUB KEYS 0x0008 int KEY NOTIFY 0x0010 int KEY CREATE LINK 0x0020 int KEY READ STANDARD RIGHTS READ KEY QUERY VALUE KEY ENUMERATE SUB KEYS KEY NOTIFY SYNCHRONIZE int KEY WRITE STANDARD RIGHTS WRITE KEY SET VALUE KEY CREATE SUB KEY SYNCHRONIZE int REG NONE 0 No value type int REG SZ 1 Unicode nul terminated string int REG EXPAND SZ 2 Unicode nul terminated string with environment variable references int REG BINARY 3 Free form binary int REG DWORD 4 32 bit number int REG DWORD LITTLE ENDIAN 4 32 bit number same as REG DWORD int REG DWORD BIG ENDIAN 5 32 bit number int REG LINK 6 Symbolic Link unicode int REG MULTI SZ 7 Multiple Unicode strings int REG RESOURCE LIST 8 Resource list in the resource map int REG FULL RESOURCE DESCRIPTOR 9 Resource list in the hardware description int REG RESOURCE REQUIREMENTS LIST 10 int REG OPTION RESERVED 0x00000000 Parameter is reserved int REG OPTION NON VOLATILE 0x00000000 Key is preserved when system is rebooted int REG OPTION VOLATILE 0x00000001 Key is not preserved when system is rebooted int REG OPTION CREATE LINK 0x00000002 Created key is a symbolic link int REG OPTION BACKUP RESTORE 0x00000004 open for backup or restore special access rules privilege required int REG OPTION OPEN LINK 0x00000008 Open symbolic linkpackage jenkins slaves restarter import hudson Extension import java io ByteArrayOutputStream import java io IOException import java util logging Logger import static java util logging Level import static org apache commons io IOUtils Extension public class WinswSlaveRestarter extends SlaveRestarter private transient String exe Override public boolean canWork try exe System getenv WINSW EXECUTABLE if exe null return false not under winsw return exec status 0 catch InterruptedException e LOGGER log FINE getClass unsuitable e return false catch IOException e LOGGER log FINE getClass unsuitable e return false private int exec String cmd throws InterruptedException IOException ProcessBuilder pb new ProcessBuilder exe cmd pb redirectErrorStream true Process p pb start p getOutputStream close ByteArrayOutputStream baos new ByteArrayOutputStream copy p getInputStream baos int r p waitFor if r 0 LOGGER info exe cmd output n baos return r public void restart throws Exception winsw 1 16 supports this operation this file gets updated via windows slaves plugin so it s possible that we end up in the situation where jenkins slave exe doesn t support this command If that is the case there s nothing we can do about it int r exec restart throw new IOException Restart failure exe restart completed with r but I m still alive See https wiki jenkins ci org display JENKINS Distributed builds Distributedbuilds Windowsslaveserviceupgrades for a possible explanation and solution private static final Logger LOGGER Logger getLogger WinswSlaveRestarter class getName private static final long serialVersionUID 1Lpackage hudson model import hudson ExtensionPoint import hudson FilePath import hudson slaves WorkspaceList import javax annotation CheckForNull public abstract class WorkspaceBrowser implements ExtensionPoint private final WorkspaceList workspaceList new WorkspaceList public abstract CheckForNull FilePath getWorkspace Job job final WorkspaceList getWorkspaceList return workspaceListpackage hudson model import hudson Extension import hudson ExtensionList import hudson FilePath import jenkins util SystemProperties import hudson Util import hudson slaves WorkspaceList import java io IOException import java util ArrayList import java util Date import java util List import java util logging Level import java util logging Logger import javax annotation Nonnull import jenkins model Jenkins import jenkins model ModifiableTopLevelItemGroup import org jenkinsci Symbol Extension Symbol workspaceCleanup public class WorkspaceCleanupThread extends AsyncPeriodicWork public WorkspaceCleanupThread super Workspace clean up Override public long getRecurrencePeriod return recurrencePeriodHours HOUR public static void invoke ExtensionList lookup AsyncPeriodicWork class get WorkspaceCleanupThread class run Override protected void execute TaskListener listener throws InterruptedException IOException if disabled LOGGER fine Disabled Skipping execution return List Node nodes new ArrayList Node Jenkins j Jenkins getInstance nodes add j nodes addAll j getNodes for TopLevelItem item j getAllItems TopLevelItem class if item instanceof ModifiableTopLevelItemGroup no such thing as TopLevelItemGroup and ItemGroup offers no access to its type parameter continue children will typically have their own workspaces as subdirectories probably no real workspace of its own listener getLogger println Checking item getFullDisplayName for Node node nodes FilePath ws node getWorkspaceFor item if ws null continue offline fine boolean check try check shouldBeDeleted item ws node catch IOException x x printStackTrace listener error Failed to check node getDisplayName continue catch InterruptedException x x printStackTrace listener error Failed to check node getDisplayName continue if check listener getLogger println Deleting ws on node getDisplayName try ws deleteRecursive WorkspaceList tempDir ws deleteRecursive catch IOException x x printStackTrace listener error Failed to delete ws on node getDisplayName catch InterruptedException x x printStackTrace listener error Failed to delete ws on node getDisplayName private boolean shouldBeDeleted Nonnull TopLevelItem item FilePath dir Nonnull Node n throws IOException InterruptedException TODO the use of remoting is not optimal One remoting can execute exists lastModified and delete all at once Could even invert master loop so that one FileCallable takes care of all known items if dir exists LOGGER log Level FINE Directory 0 does not exist dir return false if younger than a month keep it long now new Date getTime if dir lastModified retainForDays DAY now LOGGER log Level FINE Directory 0 is only 1 old so not deleting new Object dir Util getTimeSpanString now dir lastModified return false TODO could also be good to add checkbox that lets users configure a workspace to never be auto cleaned TODO check instead for SCMTriggerItem if item instanceof AbstractProject AbstractProject p AbstractProject item Node lb p getLastBuiltOn LOGGER log Level FINER Directory 0 is last built on 1 new Object dir lb if lb null lb equals n this is the active workspace keep it LOGGER log Level FINE Directory 0 is the last workspace for 1 new Object dir p return false if p getScm processWorkspaceBeforeDeletion Job p dir n LOGGER log Level FINE Directory deletion of 0 is vetoed by SCM dir return false LOGGER log Level FINER Going to delete directory 0 dir return true private static final Logger LOGGER Logger getLogger WorkspaceCleanupThread class getName public static boolean disabled SystemProperties getBoolean WorkspaceCleanupThread class getName disabled public static final int recurrencePeriodHours SystemProperties getInteger WorkspaceCleanupThread class getName recurrencePeriodHours 24 public static int retainForDays SystemProperties getInteger WorkspaceCleanupThread class getName retainForDays 30package hudson slaves import hudson FilePath import hudson Functions import jenkins util SystemProperties import hudson model Computer import hudson model DirectoryBrowserSupport import java io Closeable import java util Date import java util HashMap import java util Map import java util concurrent atomic AtomicBoolean import java util logging Level import java util logging Logger import javax annotation Nonnull public final class WorkspaceList private static final class AllocationAt extends Exception Override public String toString return Allocation Point public static final class Entry public final Thread holder Thread currentThread public final long time System currentTimeMillis public final Exception source new AllocationAt public final boolean quick public final Nonnull FilePath path public final Object context public int lockCount 1 private Entry Nonnull FilePath path boolean quick this path quick new Object unique context private Entry Nonnull FilePath path boolean quick Object context this path path this quick quick this context context Override public String toString String s path owned by holder getName from new Date time if quick s quick s n Functions printThrowable source return s public static abstract class Lease implements Closeable public final Nonnull FilePath path protected Lease Nonnull FilePath path path getRemote null check this path path public abstract void release Override public void close release public static Lease createDummyLease Nonnull FilePath p return new Lease p public void release noop public static Lease createLinkedDummyLease Nonnull FilePath p final Lease parent return new Lease p public void release parent release private final Map FilePath Entry inUse new HashMap FilePath Entry public WorkspaceList public synchronized Lease allocate Nonnull FilePath base throws InterruptedException return allocate base new Object public synchronized Lease allocate Nonnull FilePath base Object context throws InterruptedException for int i 1 i FilePath candidate i 1 base base withSuffix COMBINATOR i Entry e inUse get candidate if e null e quick e context context continue return acquire candidate false context public synchronized Lease record Nonnull FilePath p if LOGGER isLoggable Level FINE LOGGER log Level FINE recorded p new Throwable from this Entry old inUse put p new Entry p false if old null throw new AssertionError Tried to record a workspace already owned old return lease p private synchronized void release Nonnull FilePath p Entry old inUse get p if old null throw new AssertionError Releasing unallocated workspace p if LOGGER isLoggable Level FINE LOGGER log Level FINE releasing p with lock count old lockCount new Throwable from this old lockCount if old lockCount 0 inUse remove p notifyAll public synchronized Lease acquire Nonnull FilePath p throws InterruptedException return acquire p false public synchronized Lease acquire Nonnull FilePath p boolean quick throws InterruptedException return acquire p quick new Object public synchronized Lease acquire Nonnull FilePath p boolean quick Object context throws InterruptedException Entry e Thread t Thread currentThread String oldName t getName t setName Waiting to acquire p t getName try while true e inUse get p if e null e context context break wait finally t setName oldName if LOGGER isLoggable Level FINE LOGGER log Level FINE acquired p e null with lock count e lockCount new Throwable from this if e null e lockCount else inUse put p new Entry p quick context return lease p private Lease lease Nonnull FilePath p return new Lease p final AtomicBoolean released new AtomicBoolean public void release release path Override public void close if released compareAndSet false true release public static FilePath tempDir FilePath ws return ws sibling ws getName COMBINATOR tmp private static final Logger LOGGER Logger getLogger WorkspaceList class getName private static final String COMBINATOR SystemProperties getString WorkspaceList class getNamepackage hudson model import hudson ExtensionList import hudson ExtensionPoint import hudson FilePath public abstract class WorkspaceListener implements ExtensionPoint public void afterDelete AbstractProject project public void beforeUse AbstractBuild b FilePath workspace BuildListener listener public static ExtensionList WorkspaceListener all return ExtensionList lookup WorkspaceListener classpackage jenkins slaves import hudson ExtensionList import hudson ExtensionPoint import hudson FilePath import hudson model Node import hudson model TopLevelItem public abstract class WorkspaceLocator implements ExtensionPoint public abstract FilePath locate TopLevelItem item Node node public static ExtensionList WorkspaceLocator all return ExtensionList lookup WorkspaceLocator classpackage hudson import hudson model Action import hudson model TaskListener import hudson model AbstractBuild import java io IOException public abstract class WorkspaceSnapshot implements Action public abstract void restoreTo AbstractBuild owner FilePath dst TaskListener listener throws IOException InterruptedException public String getIconFileName by default hide from the UI return null public String getDisplayName return Workspace public String getUrlName return workspacepackage hudson fsp import hudson scm PollingResult import hudson scm SCM import hudson scm ChangeLogParser import hudson scm SCMDescriptor import hudson scm SCMRevisionState import hudson model AbstractProject import hudson model TaskListener import hudson model AbstractBuild import hudson model BuildListener import jenkins model Jenkins import hudson model Result import hudson model PermalinkProjectAction Permalink import hudson Launcher import hudson FilePath import hudson WorkspaceSnapshot import hudson PermalinkList import java io IOException import java io File import org kohsuke stapler DataBoundConstructor public class WorkspaceSnapshotSCM extends SCM public String jobName public String permalink DataBoundConstructor public WorkspaceSnapshotSCM String jobName String permalink this jobName jobName this permalink permalink private final class ResolvedFailedException extends Exception private ResolvedFailedException String message super message private static class Snapshot final WorkspaceSnapshot snapshot final AbstractBuild owner private Snapshot WorkspaceSnapshot snapshot AbstractBuild owner this snapshot snapshot this owner owner void restoreTo FilePath dst TaskListener listener throws IOException InterruptedException snapshot restoreTo owner dst listener public Snapshot resolve throws ResolvedFailedException Jenkins h Jenkins getInstance AbstractProject job h getItemByFullName jobName AbstractProject class if job null if h getItemByFullName jobName null AbstractProject nearest AbstractProject findNearest jobName throw new ResolvedFailedException Messages WorkspaceSnapshotSCM NoSuchJob jobName nearest getFullName else throw new ResolvedFailedException Messages WorkspaceSnapshotSCM IncorrectJobType jobName PermalinkList permalinks job getPermalinks Permalink p permalinks get permalink if p null throw new ResolvedFailedException Messages WorkspaceSnapshotSCM NoSuchPermalink permalink jobName AbstractBuild b AbstractBuild p resolve job if b null throw new ResolvedFailedException Messages WorkspaceSnapshotSCM NoBuild permalink jobName WorkspaceSnapshot snapshot b getAction WorkspaceSnapshot class if snapshot null throw new ResolvedFailedException Messages WorkspaceSnapshotSCM NoWorkspace jobName permalink return new Snapshot snapshot b Override public SCMRevisionState calcRevisionsFromBuild AbstractBuild build Launcher launcher TaskListener listener throws IOException InterruptedException return null Override protected PollingResult compareRemoteRevisionWith AbstractProject project Launcher launcher FilePath workspace TaskListener listener SCMRevisionState baseline throws IOException InterruptedException return PollingResult NO CHANGES Override public boolean checkout AbstractBuild build Launcher launcher FilePath workspace BuildListener listener File changelogFile throws IOException InterruptedException try resolve restoreTo workspace listener return true catch ResolvedFailedException e listener error e getMessage stack trace is meaningless build setResult Result FAILURE return false Override public ChangeLogParser createChangeLogParser return null Override public SCMDescriptor getDescriptor return nullpackage hudson model queue import hudson model Executor import hudson model Queue import hudson model Queue Executable import hudson model Queue Task import javax annotation CheckForNull import hudson model Run import org kohsuke accmod Restricted import org kohsuke accmod restrictions NoExternalUse import org kohsuke stapler export ExportedBean ExportedBean public final class WorkUnit public final SubTask work public final WorkUnitContext context private volatile Executor executor private Executable executable WorkUnit WorkUnitContext context SubTask work this context context this work work public CheckForNull Executor getExecutor return executor public void setExecutor CheckForNull Executor e executor e if e null context future addExecutor e public Executable getExecutable return executable Restricted NoExternalUse class public void setExecutable Executable executable this executable executable if executable instanceof Run Run executable setQueueId context item getId public boolean isMainWork return context task work Override public String toString if work context task return super toString work context task getFullDisplayName else return super toString work work context task context task getFullDisplayNamepackage hudson model queue import hudson model Action import hudson model Executor import hudson model Queue import hudson model Queue BuildableItem import hudson model Queue Task import java util ArrayList import java util Collections import java util List public final class WorkUnitContext public final BuildableItem item public final Task task public final FutureImpl future public final List Action actions private final Latch startLatch endLatch private List WorkUnit workUnits new ArrayList WorkUnit private volatile Throwable aborted public WorkUnitContext BuildableItem item this item item this task item task this future FutureImpl item getFuture this actions new ArrayList Action item getAllActions 1 for the main task int workUnitSize Tasks getSubTasksOf task size startLatch new Latch workUnitSize Override protected void onCriteriaMet on behalf of the member Executors the one that executes the main thing will send notifications Unclear if this will work with AsynchronousExecution it seems this is only called from synchronize which is only called from synchronizeStart which is only called from an executor thread Executor e Executor currentExecutor if e getCurrentWorkUnit isMainWork e getOwner taskAccepted e task endLatch new Latch workUnitSize public WorkUnit createWorkUnit SubTask execUnit WorkUnit wu new WorkUnit this execUnit workUnits add wu return wu public List WorkUnit getWorkUnits return Collections unmodifiableList workUnits public WorkUnit getPrimaryWorkUnit return workUnits get 0 public void synchronizeStart throws InterruptedException startLatch synchronize the main thread will send a notification Executor e Executor currentExecutor WorkUnit wu e getCurrentWorkUnit if wu isMainWork future start set e getCurrentExecutable Deprecated public void synchronizeEnd Queue Executable executable Throwable problems long duration throws InterruptedException synchronizeEnd Executor currentExecutor executable problems duration public void synchronizeEnd Executor e Queue Executable executable Throwable problems long duration throws InterruptedException endLatch synchronize the main thread will send a notification WorkUnit wu e getCurrentWorkUnit if wu isMainWork if problems null future set executable e getOwner taskCompleted e task duration else future set problems e getOwner taskCompletedWithProblems e task duration problems public synchronized void abort Throwable cause if cause null throw new IllegalArgumentException if aborted null return already aborted aborted cause startLatch abort cause endLatch abort cause Thread c Thread currentThread for WorkUnit wu workUnits Executor e wu getExecutor if e null e c e interruptpackage hudson util import java io OutputStream import java io Writer import java io IOException import java nio charset CharsetDecoder import java nio charset CodingErrorAction import java nio charset CoderResult import java nio charset Charset import java nio charset UnsupportedCharsetException import java nio Deprecated public class WriterOutputStream extends OutputStream private final Writer writer private final CharsetDecoder decoder private java nio ByteBuffer buf java nio ByteBuffer allocate 1024 private CharBuffer out CharBuffer allocate 1024 public WriterOutputStream Writer out this writer out decoder DEFAULT CHARSET newDecoder decoder onMalformedInput CodingErrorAction REPLACE decoder onUnmappableCharacter CodingErrorAction REPLACE public void write int b throws IOException if buf remaining 0 decode false buf put byte b public void write byte b int off int len throws IOException while len 0 if buf remaining 0 decode false int sz Math min buf remaining len buf put b off sz off sz len sz public void flush throws IOException decode false flushOutput writer flush private void flushOutput throws IOException writer write out array 0 out position out clear public void close throws IOException decode true flushOutput writer close buf rewind private void decode boolean last throws IOException buf flip while true CoderResult r decoder decode buf out last if r CoderResult OVERFLOW flushOutput continue if r CoderResult UNDERFLOW buf compact return otherwise treat it as an error r throwException private static final Charset DEFAULT CHARSET getDefaultCharset private static Charset getDefaultCharset try String encoding System getProperty file encoding return Charset forName encoding catch UnsupportedCharsetException e return Charset forName UTF 8package hudson import com thoughtworks xstream XStream import com thoughtworks xstream XStreamException import com thoughtworks xstream converters Converter import com thoughtworks xstream converters UnmarshallingContext import com thoughtworks xstream io StreamException import com thoughtworks xstream io xml Xpp3Driver import hudson diagnosis OldDataMonitor import hudson model Descriptor import hudson util AtomicFileWriter import hudson util XStream2 import org xml sax Attributes import org xml sax InputSource import org xml sax Locator import org xml sax SAXException import org xml sax ext Locator2 import org xml sax helpers DefaultHandler import javax xml parsers ParserConfigurationException import javax xml parsers SAXParserFactory import java io BufferedInputStream import java io File import java io FileInputStream import java io IOException import java io InputStream import java io InputStreamReader import java io Reader import java io Writer import java io StringWriter import java util logging Level import java util logging Logger public final class XmlFile private final XStream xs private final File file public XmlFile File file this DEFAULT XSTREAM file public XmlFile XStream xs File file this xs xs this file file public File getFile return file public XStream getXStream return xs public Object read throws IOException if LOGGER isLoggable Level FINE LOGGER fine Reading file try InputStream in new BufferedInputStream new FileInputStream file return xs fromXML in catch XStreamException Error e throw new IOException Unable to read file e public Object unmarshal Object o throws IOException try InputStream in new BufferedInputStream new FileInputStream file TODO expose XStream the driver from XStream return xs unmarshal DEFAULT DRIVER createReader in o catch XStreamException Error e throw new IOException Unable to read file e public void write Object o throws IOException mkdirs AtomicFileWriter w new AtomicFileWriter file try w write xml version 1 0 encoding UTF 8 n xs toXML o w w commit catch StreamException e throw new IOException e finally w abort public boolean exists return file exists public void delete file delete public void mkdirs file getParentFile mkdirs Override public String toString return file toString public Reader readRaw throws IOException return new InputStreamReader new FileInputStream file sniffEncoding public String asString throws IOException StringWriter w new StringWriter writeRawTo w return w toString public void writeRawTo Writer w throws IOException try Reader r readRaw Util copyStream r w public String sniffEncoding throws IOException class Eureka extends SAXException final String encoding public Eureka String encoding this encoding encoding try InputStream in new FileInputStream file InputSource input new InputSource file toURI toASCIIString input setByteStream in JAXP newSAXParser parse input new DefaultHandler private Locator loc Override public void setDocumentLocator Locator locator this loc locator Override public void startDocument throws SAXException attempt Override public void startElement String uri String localName String qName Attributes attributes throws SAXException attempt if we still haven t found it at the first start element then we are not going to find it throw new Eureka null private void attempt throws Eureka if loc null return if loc instanceof Locator2 Locator2 loc2 Locator2 loc String e loc2 getEncoding if e null throw new Eureka e can t reach here throw new AssertionError catch Eureka e if e encoding null return e encoding the environment can contain old version of Xerces and others that do not support Locator2 in such a case assume UTF 8 rather than fail since Jenkins internally always write XML in UTF 8 return UTF 8 catch SAXException e throw new IOException Failed to detect encoding of file e catch ParserConfigurationException e throw new AssertionError e impossible private static final XStream DEFAULT XSTREAM new XStream2 private static final Logger LOGGER Logger getLogger XmlFile class getName private static final SAXParserFactory JAXP SAXParserFactory newInstance private static final Xpp3Driver DEFAULT DRIVER new Xpp3Driver static JAXP setNamespaceAware truepackage jenkins util xml import jenkins util SystemProperties import org apache commons io IOUtils import org kohsuke accmod Restricted import org kohsuke accmod restrictions NoExternalUse import org w3c dom Document import org xml sax InputSource import org xml sax SAXException import org xml sax XMLReader import org xml sax helpers XMLReaderFactory import java io File import java io FileInputStream import java io IOException import java io InputStreamReader import java io Reader import java nio charset Charset import java util logging Level import java util logging LogManager import java util logging Logger import javax annotation Nonnull import javax xml XMLConstants import javax xml parsers DocumentBuilder import javax xml parsers DocumentBuilderFactory import javax xml parsers ParserConfigurationException import javax xml transform Result import javax xml transform Source import javax xml transform Transformer import javax xml transform TransformerException import javax xml transform TransformerFactory import javax xml transform sax SAXSource import javax xml transform sax SAXTransformerFactory import javax xml xpath XPath import javax xml xpath XPathExpressionException import javax xml xpath XPathFactory Restricted NoExternalUse class public final class XMLUtils private final static Logger LOGGER LogManager getLogManager getLogger XMLUtils class getName private final static String DISABLED PROPERTY NAME XMLUtils class getName disableXXEPrevention private static final String FEATURE HTTP XML ORG SAX FEATURES EXTERNAL GENERAL ENTITIES http xml org sax features external general entities private static final String FEATURE HTTP XML ORG SAX FEATURES EXTERNAL PARAMETER ENTITIES http xml org sax features external parameter entities public static void safeTransform Nonnull Source source Nonnull Result out throws TransformerException SAXException InputSource src SAXSource sourceToInputSource source if src null SAXTransformerFactory stFactory SAXTransformerFactory TransformerFactory newInstance stFactory setFeature XMLConstants FEATURE SECURE PROCESSING true XMLReader xmlReader XMLReaderFactory createXMLReader try xmlReader setFeature FEATURE HTTP XML ORG SAX FEATURES EXTERNAL GENERAL ENTITIES false catch SAXException ignored try xmlReader setFeature FEATURE HTTP XML ORG SAX FEATURES EXTERNAL PARAMETER ENTITIES false catch SAXException ignored defend against XXE the above features should strip out entities however the feature may not be supported depending on the xml implementation used and this is out of our control So add a fallback plan if all else fails xmlReader setEntityResolver RestrictiveEntityResolver INSTANCE SAXSource saxSource new SAXSource xmlReader src transform saxSource out else for some reason we could not convert source this applies to DOMSource and StAXSource and possibly 3rd party implementations a DOMSource can already be compromised as it is parsed by the time it gets to us if SystemProperties getBoolean DISABLED PROPERTY NAME LOGGER log Level WARNING XML external entity XXE prevention has been disabled by the system property 0 true Your system may be vulnerable to XXE attacks DISABLED PROPERTY NAME if LOGGER isLoggable Level FINE LOGGER log Level FINE Caller stack trace new Exception XXE Prevention caller history transform source out else throw new TransformerException Could not convert source of type source getClass and XXEPrevention is enabled public static Nonnull Document parse Nonnull Reader stream throws SAXException IOException DocumentBuilder docBuilder try docBuilder newDocumentBuilderFactory newDocumentBuilder docBuilder setEntityResolver RestrictiveEntityResolver INSTANCE catch ParserConfigurationException e throw new IllegalStateException Unexpected error creating DocumentBuilder e return docBuilder parse new InputSource stream public static Nonnull Document parse Nonnull File file Nonnull String encoding throws SAXException IOException if file exists file isFile throw new IllegalArgumentException String format File s does not exist or is not a normal file file getAbsolutePath FileInputStream fileInputStream new FileInputStream file try InputStreamReader fileReader new InputStreamReader fileInputStream encoding try return parse fileReader finally IOUtils closeQuietly fileReader finally IOUtils closeQuietly fileInputStream public static Nonnull String getValue Nonnull String xpath Nonnull File file throws IOException SAXException XPathExpressionException return getValue xpath file Charset defaultCharset toString public static Nonnull String getValue Nonnull String xpath Nonnull File file Nonnull String fileDataEncoding throws IOException SAXException XPathExpressionException Document document parse file fileDataEncoding return getValue xpath document public static String getValue String xpath Document document throws XPathExpressionException XPath xPathProcessor XPathFactory newInstance newXPath return xPathProcessor compile xpath evaluate document private static void transform Source source Result out throws TransformerException TransformerFactory factory TransformerFactory newInstance factory setFeature XMLConstants FEATURE SECURE PROCESSING true this allows us to use UTF 8 for storing data plus it checks any well formedness issue in the submitted data Transformer t factory newTransformer t transform source out private static DocumentBuilderFactory newDocumentBuilderFactory DocumentBuilderFactory documentBuilderFactory DocumentBuilderFactory newInstance Set parser features to prevent against XXE etc Note setting only the external entity features on DocumentBuilderFactory instance ala how safeTransform does it for SAXTransformerFactory does seem to work was still processing the entities tried Oracle JDK 7 and 8 on OSX Setting seems a bit extreme but looks like there s no other choice documentBuilderFactory setXIncludeAware false documentBuilderFactory setExpandEntityReferences false setDocumentBuilderFactoryFeature documentBuilderFactory XMLConstants FEATURE SECURE PROCESSING true setDocumentBuilderFactoryFeature documentBuilderFactory FEATURE HTTP XML ORG SAX FEATURES EXTERNAL GENERAL ENTITIES false setDocumentBuilderFactoryFeature documentBuilderFactory FEATURE HTTP XML ORG SAX FEATURES EXTERNAL PARAMETER ENTITIES false setDocumentBuilderFactoryFeature documentBuilderFactory http apache org xml features disallow doctype decl true return documentBuilderFactory private static void setDocumentBuilderFactoryFeature DocumentBuilderFactory documentBuilderFactory String feature boolean state try documentBuilderFactory setFeature feature state catch Exception e LOGGER log Level WARNING String format Failed to set the XML Document Builder factory feature s to s feature state epackage hudson util import com google common collect ImmutableList import com google common collect ImmutableMap import com thoughtworks xstream XStream import com thoughtworks xstream mapper AnnotationMapper import com thoughtworks xstream mapper Mapper import com thoughtworks xstream mapper MapperWrapper import com thoughtworks xstream converters ConversionException import com thoughtworks xstream converters Converter import com thoughtworks xstream converters ConverterMatcher import com thoughtworks xstream converters DataHolder import com thoughtworks xstream converters MarshallingContext import com thoughtworks xstream converters SingleValueConverter import com thoughtworks xstream converters SingleValueConverterWrapper import com thoughtworks xstream converters UnmarshallingContext import com thoughtworks xstream converters extended DynamicProxyConverter import com thoughtworks xstream core JVM import com thoughtworks xstream io HierarchicalStreamDriver import com thoughtworks xstream io HierarchicalStreamReader import com thoughtworks xstream io HierarchicalStreamWriter import com thoughtworks xstream mapper CannotResolveClassException import edu umd cs findbugs annotations SuppressFBWarnings import hudson PluginManager import hudson PluginWrapper import hudson diagnosis OldDataMonitor import hudson remoting ClassFilter import hudson util xstream ImmutableSetConverter import hudson util xstream ImmutableSortedSetConverter import jenkins model Jenkins import hudson model Label import hudson model Result import hudson model Saveable import hudson util xstream ImmutableListConverter import hudson util xstream ImmutableMapConverter import hudson util xstream MapperDelegate import java io IOException import java io OutputStream import java io OutputStreamWriter import java io Writer import java lang reflect Constructor import java lang reflect InvocationTargetException import java nio charset Charset import java util Map import java util concurrent ConcurrentHashMap import javax annotation CheckForNull import org kohsuke accmod Restricted import org kohsuke accmod restrictions NoExternalUse public class XStream2 extends XStream private RobustReflectionConverter reflectionConverter private final ThreadLocal Boolean oldData new ThreadLocal Boolean private final CheckForNull ClassOwnership classOwnership private final Map String Class compatibilityAliases new ConcurrentHashMap String Class private MapperInjectionPoint mapperInjectionPoint public XStream2 init classOwnership null public XStream2 HierarchicalStreamDriver hierarchicalStreamDriver super hierarchicalStreamDriver init classOwnership null XStream2 ClassOwnership classOwnership init this classOwnership classOwnership Override public Object unmarshal HierarchicalStreamReader reader Object root DataHolder dataHolder init is too early to do this defensive because some use of XStream happens before plugins are initialized Jenkins h Jenkins getInstanceOrNull if h null h pluginManager null h pluginManager uberClassLoader null setClassLoader h pluginManager uberClassLoader Object o super unmarshal reader root dataHolder if oldData get null oldData remove if o instanceof Saveable OldDataMonitor report Saveable o 1 106 return o Override protected Converter createDefaultConverter replace default reflection converter reflectionConverter new RobustReflectionConverter getMapper new JVM bestReflectionProvider new PluginClassOwnership return reflectionConverter Restricted NoExternalUse class TODO could be opened up later public void addCriticalField Class clazz String field reflectionConverter addCriticalField clazz field static String trimVersion String version TODO seems like there should be some trick with VersionNumber to do this return version replaceFirst private void init list up types that should be marshalled out like a value without referential integrity tracking addImmutableType Result class registerConverter new RobustCollectionConverter getMapper getReflectionProvider 10 registerConverter new RobustMapConverter getMapper 10 registerConverter new ImmutableMapConverter getMapper getReflectionProvider 10 registerConverter new ImmutableSortedSetConverter getMapper getReflectionProvider 10 registerConverter new ImmutableSetConverter getMapper getReflectionProvider 10 registerConverter new ImmutableListConverter getMapper getReflectionProvider 10 registerConverter new CopyOnWriteMap Tree ConverterImpl getMapper 10 needs to override MapConverter registerConverter new DescribableList ConverterImpl getMapper 10 explicitly added to handle subtypes registerConverter new Label ConverterImpl 10 this should come after all the XStream s default simpler converters but before reflection based one kicks in registerConverter new AssociatedConverterImpl this 10 registerConverter new BlacklistedTypesConverter PRIORITY VERY HIGH SECURITY 247 defense registerConverter new DynamicProxyConverter getMapper SECURITY 105 defense Override public boolean canConvert Class type return type null super canConvert type Override public Object unmarshal HierarchicalStreamReader reader UnmarshallingContext context throw new ConversionException dynamic proxy not supported PRIORITY VERY HIGH Override protected MapperWrapper wrapMapper MapperWrapper next Mapper m new CompatibilityMapper new MapperWrapper next Override public String serializedClass Class type if type null ImmutableMap class isAssignableFrom type return super serializedClass ImmutableMap class else if type null ImmutableList class isAssignableFrom type return super serializedClass ImmutableList class else return super serializedClass type AnnotationMapper a new AnnotationMapper m getConverterRegistry getConverterLookup getClassLoader getReflectionProvider getJvm TODO JENKINS 19561 this is unsafe a autodetectAnnotations true mapperInjectionPoint new MapperInjectionPoint a return mapperInjectionPoint public Mapper getMapperInjectionPoint return mapperInjectionPoint getDelegate Deprecated Override public void toXML Object obj OutputStream out super toXML obj out public void toXMLUTF8 Object obj OutputStream out throws IOException Writer w new OutputStreamWriter out Charset forName UTF 8 w write xml version 1 0 encoding UTF 8 n toXML obj w public void setMapper Mapper m mapperInjectionPoint setDelegate m final class MapperInjectionPoint extends MapperDelegate public MapperInjectionPoint Mapper wrapped super wrapped public Mapper getDelegate return delegate public void setDelegate Mapper m delegate m public void addCompatibilityAlias String oldClassName Class newClass compatibilityAliases put oldClassName newClass private class CompatibilityMapper extends MapperWrapper private CompatibilityMapper Mapper wrapped super wrapped Override public Class realClass String elementName Class s compatibilityAliases get elementName if s null return s try return super realClass elementName catch CannotResolveClassException e If a is found retry with mapping this to if elementName indexOf 0 try Class c super realClass elementName replace oldData set Boolean TRUE return c catch CannotResolveClassException e2 Throw original exception throw e private static final class AssociatedConverterImpl implements Converter private final XStream xstream private final ConcurrentHashMap Class Converter cache new ConcurrentHashMap Class Converter private AssociatedConverterImpl XStream xstream this xstream xstream private Converter findConverter Class t Converter result cache get t if result null ConcurrentHashMap does not allow null so use this object to represent null return result this null result try if t null t getClassLoader null return null Class cl t getClassLoader loadClass t getName ConverterImpl Constructor c cl getConstructors 0 Class p c getParameterTypes Object args new Object p length for int i 0 i p length i if p i XStream class p i XStream2 class args i xstream else if p i Mapper class args i xstream getMapper else throw new InstantiationError Unrecognized constructor parameter p i ConverterMatcher cm ConverterMatcher c newInstance args result cm instanceof SingleValueConverter new SingleValueConverterWrapper SingleValueConverter cm Converter cm cache put t result return result catch ClassNotFoundException e cache put t this See above this object in cache represents null return null catch IllegalAccessException e IllegalAccessError x new IllegalAccessError x initCause e throw x catch InstantiationException e InstantiationError x new InstantiationError x initCause e throw x catch InvocationTargetException e InstantiationError x new InstantiationError x initCause e throw x public boolean canConvert Class type return findConverter type null public void marshal Object source HierarchicalStreamWriter writer MarshallingContext context findConverter source getClass marshal source writer context public Object unmarshal HierarchicalStreamReader reader UnmarshallingContext context return findConverter context getRequiredType unmarshal reader context public static abstract class PassthruConverter T implements Converter private Converter converter public PassthruConverter XStream2 xstream converter xstream reflectionConverter public boolean canConvert Class type marshal unmarshal called directly from AssociatedConverterImpl return false public void marshal Object source HierarchicalStreamWriter writer MarshallingContext context converter marshal source writer context public Object unmarshal HierarchicalStreamReader reader UnmarshallingContext context Object obj converter unmarshal reader context callback T obj context return obj protected abstract void callback T obj UnmarshallingContext context interface ClassOwnership CheckForNull String ownerOf Class clazz class PluginClassOwnership implements ClassOwnership private PluginManager pm SuppressFBWarnings NP NULL ON SOME PATH FROM RETURN VALUE classOwnership checked for null so why does FB complain Override public String ownerOf Class clazz if classOwnership null return classOwnership ownerOf clazz if pm null Jenkins j Jenkins getInstanceOrNull if j null pm j getPluginManager if pm null return null TODO possibly recursively scan super class to discover dependencies PluginWrapper p pm whichPlugin clazz return p null p getShortName trimVersion p getVersion null private static class BlacklistedTypesConverter implements Converter Override public void marshal Object source HierarchicalStreamWriter writer MarshallingContext context throw new UnsupportedOperationException Refusing to marshal source getClass getName for security reasons Override public Object unmarshal HierarchicalStreamReader reader UnmarshallingContext context throw new ConversionException Refusing to unmarshal reader getNodeName for security reasons Override public boolean canConvert Class type if type null return false try ClassFilter DEFAULT check type ClassFilter DEFAULT check type getName catch SecurityException se claim we can convert all the scary stuff so we can throw exceptions when attempting to do so return true return falsepackage jenkins util xstream import com thoughtworks xstream XStream import com thoughtworks xstream converters Converter import com thoughtworks xstream converters ErrorWriter import com thoughtworks xstream converters MarshallingContext import com thoughtworks xstream converters UnmarshallingContext import com thoughtworks xstream io AttributeNameIterator import com thoughtworks xstream io HierarchicalStreamReader import com thoughtworks xstream io HierarchicalStreamWriter import com thoughtworks xstream io xml AbstractXmlReader import com thoughtworks xstream io xml AbstractXmlWriter import com thoughtworks xstream io xml DocumentReader import com thoughtworks xstream io xml XmlFriendlyReplacer import com thoughtworks xstream io xml Xpp3Driver import hudson Util import hudson util VariableResolver import java io InputStream import java io OutputStream import java io Reader import java io Writer import java util ArrayList import java util HashMap import java util Iterator import java util List import java util Map import java util Map Entry import java util Stack public class XStreamDOM private final String tagName private final String attributes one of them is non null the other is null private final String value private final List XStreamDOM children public XStreamDOM String tagName Map String String attributes String value this tagName tagName this attributes toAttributeList attributes this value value this children null public XStreamDOM String tagName Map String String attributes List XStreamDOM children this tagName tagName this attributes toAttributeList attributes this value null this children children private XStreamDOM String tagName String attributes List XStreamDOM children String value this tagName tagName this attributes attributes this children children this value value private String toAttributeList Map String String attributes String r new String attributes size 2 int i 0 for Entry String String e attributes entrySet r i e getKey r i e getValue return r public String getTagName return tagName public T T unmarshal XStream xs return T xs unmarshal newReader public T T unmarshal XStream xs T root return T xs unmarshal newReader root public XStreamDOM expandMacro VariableResolver String vars String newAttributes new String attributes length for int i 0 i attributes length i 2 newAttributes i 0 attributes i name newAttributes i 1 Util replaceMacro attributes i 1 vars List XStreamDOM newChildren null if children null newChildren new ArrayList XStreamDOM children size for XStreamDOM d children newChildren add d expandMacro vars return new XStreamDOM tagName newAttributes newChildren Util replaceMacro value vars public String getAttribute String name for int i 0 i attributes length i 2 if attributes i equals name return attributes i 1 return null public int getAttributeCount return attributes length 2 String getAttributeName int index return attributes index 2 public String getAttribute int index return attributes index 2 1 public String getValue return value public List XStreamDOM getChildren return children public HierarchicalStreamReader newReader return new ReaderImpl this public static WriterImpl newWriter return new WriterImpl public void writeTo OutputStream os writeTo new Xpp3Driver createWriter os public void writeTo Writer w writeTo new Xpp3Driver createWriter w public void writeTo HierarchicalStreamWriter w new ConverterImpl marshal this w null public static XStreamDOM from XStream xs Object obj WriterImpl w newWriter xs marshal obj w return w getOutput public static XStreamDOM from InputStream in return from new Xpp3Driver createReader in public static XStreamDOM from Reader in return from new Xpp3Driver createReader in public static XStreamDOM from HierarchicalStreamReader in return new ConverterImpl unmarshalElement in null public Map String String getAttributeMap Map String String r new HashMap String String for int i 0 i attributes length i 2 r put attributes i attributes i 1 return r private static class ReaderImpl extends AbstractXmlReader implements DocumentReader private static class Pointer final XStreamDOM node int pos private Pointer XStreamDOM node this node node public String peekNextChild if hasMoreChildren return node children get pos tagName return null public boolean hasMoreChildren return node children null pos node children size public String xpath XStreamDOM child node children get pos 1 int count 0 for int i 0 i pos 1 i if node children get i tagName equals child tagName count boolean more false for int i pos more i node children size i if node children get i tagName equals child tagName more true if count 0 more return child tagName sole child return child tagName count private final Stack Pointer pointers new Stack Pointer public ReaderImpl XStreamDOM current super new XmlFriendlyReplacer pointers push new Pointer current private Pointer current return pointers peek public Object getCurrent return current node public boolean hasMoreChildren return current hasMoreChildren public HierarchicalStreamReader underlyingReader return this public void moveDown Pointer p current pointers push new Pointer p node children get p pos public void moveUp pointers pop public Iterator getAttributeNames return new AttributeNameIterator this public void appendErrors ErrorWriter errorWriter StringBuilder buf new StringBuilder Pointer parent null for Pointer cur pointers if parent null buf append append parent xpath else buf append cur node tagName parent cur errorWriter add xpath buf toString public void close public String peekNextChild return current peekNextChild public String getNodeName return unescapeXmlName current node tagName public String getValue return Util fixNull current node value public String getAttribute String name return current node getAttribute name public String getAttribute int index return current node getAttribute index public int getAttributeCount return current node getAttributeCount public String getAttributeName int index return unescapeXmlName current node getAttributeName index public static class WriterImpl extends AbstractXmlWriter private static class Pending final String tagName List XStreamDOM children List String attributes new ArrayList String String value private Pending String tagName this tagName tagName void addChild XStreamDOM dom if children null children new ArrayList XStreamDOM children add dom XStreamDOM toDOM return new XStreamDOM tagName attributes toArray new String attributes size children value private final Stack Pending pendings new Stack Pending public WriterImpl pendings push new Pending null to get the final result public void startNode String name pendings push new Pending escapeXmlName name public void endNode XStreamDOM dom pendings pop toDOM pendings peek addChild dom public void addAttribute String name String value List String atts pendings peek attributes atts add escapeXmlName name atts add value public void setValue String text pendings peek value text public void flush public void close public HierarchicalStreamWriter underlyingWriter return this public XStreamDOM getOutput if pendings size 1 throw new IllegalStateException return pendings peek children get 0 public static class ConverterImpl implements Converter public boolean canConvert Class type return type XStreamDOM class TODO ideally we d like to use the contextual HierarchicalStreamWriter to unescape but this object isn t exposed to us private String unescape String s return REPLACER unescapeName s private String escape String s return REPLACER escapeName s public void marshal Object source HierarchicalStreamWriter w MarshallingContext context XStreamDOM dom XStreamDOM source w startNode unescape dom tagName for int i 0 i dom attributes length i 2 w addAttribute unescape dom attributes i dom attributes i 1 if dom value null w setValue dom value else for XStreamDOM c Util fixNull dom children marshal c w context w endNode public XStreamDOM unmarshal HierarchicalStreamReader r UnmarshallingContext context r moveDown XStreamDOM dom unmarshalElement r context r moveUp return dom public XStreamDOM unmarshalElement HierarchicalStreamReader r UnmarshallingContext context String name escape r getNodeName int c r getAttributeCount String attributes new String c 2 for int i 0 i c i attributes i 2 escape r getAttributeName i attributes i 2 1 r getAttribute i List XStreamDOM children null String value null if r hasMoreChildren children new ArrayList XStreamDOM while r hasMoreChildren children add unmarshal r context else value r getValue return new XStreamDOM name attributes children value public static XmlFriendlyReplacer REPLACER new XmlFriendlyReplacerpackage jenkins public enum YesNoMaybe YES NO MAYBE public static Boolean toBoolean YesNoMaybe v if v null return null return v toBool public Boolean toBool switch this case YES return true case NO return false default return nullpackage hudson os solaris import com sun akuma Daemon import com sun akuma JavaVMArguments import hudson Launcher LocalLauncher import hudson Util import hudson Extension import jenkins util SystemProperties import hudson os SU import hudson model AdministrativeMonitor import jenkins model Jenkins import hudson model TaskListener import hudson util ForkOutputStream import hudson util HudsonIsRestarting import hudson util StreamTaskListener import static hudson util jna GNUCLibrary import jenkins security MasterToSlaveCallable import org apache commons io output ByteArrayOutputStream import org jvnet libpam impl CLibrary passwd import org jvnet solaris libzfs ACLBuilder import org jvnet solaris libzfs LibZFS import org jvnet solaris libzfs ZFSException import org jvnet solaris libzfs ZFSFileSystem import org jvnet solaris libzfs ErrorCode import org jvnet solaris mount MountFlags import org kohsuke stapler StaplerRequest import org kohsuke stapler StaplerResponse import org kohsuke stapler QueryParameter import org kohsuke stapler HttpResponse import org kohsuke stapler HttpResponses import org kohsuke stapler HttpRedirect import org kohsuke stapler interceptor RequirePOST import javax servlet ServletException import java io File import java io IOException import java io PrintStream import java io Serializable import java util List import java util logging Level import java util logging Logger public class ZFSInstaller extends AdministrativeMonitor implements Serializable private static final long serialVersionUID 1018007614648118323L private final boolean active shouldBeActive private String prospectiveZfsFileSystemName public boolean isActivated return active public boolean isRoot return LIBC geteuid 0 public String getProspectiveZfsFileSystemName return prospectiveZfsFileSystemName private boolean shouldBeActive if System getProperty os name equals SunOS disabled on systems that don t have ZFS we don t need this monitor return false try LibZFS zfs new LibZFS List ZFSFileSystem roots zfs roots if roots isEmpty return false no active ZFS pool if we don t run on a ZFS file system activate ZFSFileSystem hudsonZfs zfs getFileSystemByMountPoint Jenkins getInstance getRootDir if hudsonZfs null return false already on ZFS decide what file system we ll create ZFSFileSystem pool roots get 0 prospectiveZfsFileSystemName computeHudsonFileSystemName zfs pool return true catch Exception e LOGGER log Level WARNING Failed to detect whether Hudson is on ZFS e return false catch LinkageError e LOGGER info No ZFS available If you believe this is an error increase the logging level to get the stack trace LOGGER log Level FINE Stack trace of failed ZFS load e return false RequirePOST public HttpResponse doAct StaplerRequest req throws ServletException IOException Jenkins getInstance checkPermission Jenkins ADMINISTER if req hasParameter n we ll shut up disable true return HttpResponses redirectViaContextPath manage return new HttpRedirect confirm private String createZfsFileSystem final TaskListener listener String rootUsername String rootPassword throws IOException InterruptedException ZFSException capture the UID that Hudson runs under so that we can allow this user to do everything on this new partition final int uid LIBC geteuid final int gid LIBC getegid passwd pwd LIBC getpwuid uid if pwd null throw new IOException Failed to obtain the current user information for uid final String userName pwd pw name final File home Jenkins getInstance getRootDir this is the actual creation of the file system return true indicating a success return SU execute listener rootUsername rootPassword new MasterToSlaveCallable String IOException private static final long serialVersionUID 7731167233498214301L public String call throws IOException PrintStream out listener getLogger LibZFS zfs new LibZFS ZFSFileSystem existing zfs getFileSystemByMountPoint home if existing null no need for migration out println home is already on ZFS Doing nothing return existing getName String name computeHudsonFileSystemName zfs zfs roots get 0 out println Creating name ZFSFileSystem hudson zfs create name ZFSFileSystem class mount temporarily to set the owner right File dir Util createTempDir hudson setMountPoint dir hudson mount if LIBC chown dir getPath uid gid 0 throw new IOException Failed to chown dir hudson unmount try hudson setProperty hudson managed by hudson mark this file system as managed by Hudson ACLBuilder acl new ACLBuilder acl user userName withEverything hudson allow acl catch ZFSException e revert the file system creation try hudson destory catch Exception but ignore the error and let the original error thrown throw e return hudson getName RequirePOST public void doStart StaplerRequest req StaplerResponse rsp QueryParameter String username QueryParameter String password throws ServletException IOException Jenkins hudson Jenkins getInstance hudson checkPermission Jenkins ADMINISTER final String datasetName ByteArrayOutputStream log new ByteArrayOutputStream StreamTaskListener listener new StreamTaskListener log try datasetName createZfsFileSystem listener username password catch Exception e e printStackTrace listener error e getMessage if e instanceof ZFSException ZFSException ze ZFSException e if ze getCode ErrorCode EZFS PERM permission problem ask the user to give us the root password req setAttribute message log toString rsp forward this askRootPassword req return for other kinds of problems report and bail out req setAttribute pre true sendError log toString req rsp return file system creation successful so restart hudson servletContext setAttribute app new HudsonIsRestarting redirect the user to the manage page rsp sendRedirect2 req getContextPath manage asynchronously restart so that we can give a bit of time to the browser to load restarting screen new Thread restart thread Override public void run try Thread sleep 5000 close all descriptors on exec except stdin out err int sz LIBC getdtablesize for int i 3 i sz i int flags LIBC fcntl i F GETFD if flags 0 continue LIBC fcntl i F SETFD flags FD CLOEXEC re exec with the system property to indicate where to migrate the data to the 2nd phase is implemented in the migrate method JavaVMArguments args JavaVMArguments current args setSystemProperty ZFSInstaller class getName migrate datasetName Daemon selfExec args catch InterruptedException IOException e LOGGER log Level SEVERE Restart failed e start Extension public static AdministrativeMonitor init String migrationTarget SystemProperties getString ZFSInstaller class getName migrate if migrationTarget null ByteArrayOutputStream out new ByteArrayOutputStream StreamTaskListener listener new StreamTaskListener new ForkOutputStream System out out try if migrate listener migrationTarget completed successfully return new MigrationCompleteNotice catch Exception e if we let any exception from here it will prevent Hudson from starting e printStackTrace listener error Migration failed migration failed return new MigrationFailedNotice out install the monitor if applicable ZFSInstaller zi new ZFSInstaller if zi isActivated return zi return null private static boolean migrate TaskListener listener String target throws IOException InterruptedException PrintStream out listener getLogger File home Jenkins getInstance getRootDir do the migration LibZFS zfs new LibZFS ZFSFileSystem existing zfs getFileSystemByMountPoint home if existing null out println home is already on ZFS Doing nothing return true File tmpDir Util createTempDir mount a new file system to a temporary location out println Opening target ZFSFileSystem hudson zfs open target ZFSFileSystem class hudson setMountPoint tmpDir hudson setProperty hudson managed by hudson mark this file system as managed by Hudson hudson mount copy all the files out println Copying all existing data files if system home listener usr bin cp pR tmpDir getAbsolutePath 0 out println Failed to copy home to tmpDir return false unmount out println Unmounting target hudson unmount MountFlags MS FORCE move the original directory to the side File backup new File home getPath backup out println Moving home to backup if backup exists Util deleteRecursive backup if home renameTo backup out println Failed to move your current data home out of the way update the mount point out println Creating a new mount point at home if home mkdir throw new IOException Failed to create mount point home out println Mounting target hudson setMountPoint home hudson mount out println Sharing target try hudson setProperty sharesmb on hudson setProperty sharenfs on hudson share catch ZFSException e listener error Failed to share the file systems e getCode delete back up out println Deleting backup if system new File listener usr bin rm rf backup getAbsolutePath 0 out println Failed to delete backup getAbsolutePath return false out println Migration completed return true private static int system File pwd TaskListener listener String args throws IOException InterruptedException return new LocalLauncher listener launch cmds args stdout System out pwd pwd join private static String computeHudsonFileSystemName LibZFS zfs ZFSFileSystem top if zfs exists top getName hudson return top getName hudson for int i 2 i String name top getName hudson i if zfs exists name return name public static final class MigrationCompleteNotice extends AdministrativeMonitor public boolean isActivated return true public static final class MigrationFailedNotice extends AdministrativeMonitor ByteArrayOutputStream record MigrationFailedNotice ByteArrayOutputStream record this record record public boolean isActivated return true public String getLog return record toString private static final Logger LOGGER Logger getLogger ZFSInstaller class getName public static boolean disabled SystemProperties getBoolean ZFSInstaller class getName disabledpackage hudson os solaris import jenkins MasterToSlaveFileCallable import hudson FileSystemProvisioner import hudson FilePath import hudson WorkspaceSnapshot import hudson FileSystemProvisionerDescriptor import hudson Extension import hudson remoting VirtualChannel import hudson model AbstractBuild import hudson model TaskListener import hudson model AbstractProject import hudson model Node import java io IOException import java io File import java io Serializable import org jenkinsci Symbol import org jvnet solaris libzfs LibZFS import org jvnet solaris libzfs ZFSFileSystem public class ZFSProvisioner extends FileSystemProvisioner implements Serializable private static final LibZFS libzfs new LibZFS private final String rootDataset public ZFSProvisioner Node node throws IOException InterruptedException rootDataset node getRootPath act new MasterToSlaveFileCallable String private static final long serialVersionUID 2142349338699797436L public String invoke File f VirtualChannel channel throws IOException ZFSFileSystem fs libzfs getFileSystemByMountPoint f if fs null return fs getName TODO for now only support agents that are already on ZFS throw new IOException Not on ZFS public void prepareWorkspace AbstractBuild build FilePath ws final TaskListener listener throws IOException InterruptedException final String name build getProject getFullName ws act new MasterToSlaveFileCallable Void private static final long serialVersionUID 2129531727963121198L public Void invoke File f VirtualChannel channel throws IOException ZFSFileSystem fs libzfs getFileSystemByMountPoint f if fs null return null already on ZFS nope create a file system String fullName rootDataset name listener getLogger println Creating a ZFS file system fullName at f fs libzfs create fullName ZFSFileSystem class fs setMountPoint f fs mount return null public void discardWorkspace AbstractProject project FilePath ws throws IOException InterruptedException ws act new MasterToSlaveFileCallable Void private static final long serialVersionUID 1916618107019257530L public Void invoke File f VirtualChannel channel throws IOException ZFSFileSystem fs libzfs getFileSystemByMountPoint f if fs null fs destory true return null Deprecated public WorkspaceSnapshot snapshot AbstractBuild build FilePath ws TaskListener listener throws IOException InterruptedException throw new UnsupportedOperationException public WorkspaceSnapshot snapshot AbstractBuild build FilePath ws String glob TaskListener listener throws IOException InterruptedException throw new UnsupportedOperationException Extension Symbol zfs public static final class DescriptorImpl extends FileSystemProvisionerDescriptor public boolean discard FilePath ws TaskListener listener throws IOException InterruptedException TODO return false public String getDisplayName return ZFS private static final long serialVersionUID 1Lpackage hudson util io import hudson util FileVisitor import hudson util IOUtils import org apache tools zip ZipEntry import org apache tools zip ZipOutputStream import java io File import java io FileInputStream import java io IOException import java io OutputStream final class ZipArchiver extends Archiver private final byte buf new byte 8192 private final ZipOutputStream zip ZipArchiver OutputStream out zip new ZipOutputStream out zip setEncoding System getProperty file encoding public void visit final File f final String relativePath throws IOException int mode IOUtils mode f On Windows the elements of relativePath are separated by back slashes but Zip files need to have their path elements separated by forward slashes String relativePath relativePath replace if f isDirectory ZipEntry dirZipEntry new ZipEntry relativePath Setting this bit explicitly is needed by some unzipping applications see JENKINS 3294 dirZipEntry setExternalAttributes BITMASK IS DIRECTORY if mode 1 dirZipEntry setUnixMode mode dirZipEntry setTime f lastModified zip putNextEntry dirZipEntry zip closeEntry else ZipEntry fileZipEntry new ZipEntry relativePath if mode 1 fileZipEntry setUnixMode mode fileZipEntry setTime f lastModified zip putNextEntry fileZipEntry FileInputStream in new FileInputStream f try int len while len in read buf 0 zip write buf 0 len finally in close zip closeEntry entriesWritten public void close throws IOException zip close Bitmask indicating directories in external attributes of a ZIP archive entry private static final long BITMASK IS DIRECTORY 1 4package hudson tools import hudson Extension import hudson FilePath import jenkins MasterToSlaveFileCallable import hudson ProxyConfiguration import hudson Util import hudson Functions import hudson model Node import hudson model TaskListener import hudson remoting VirtualChannel import hudson util FormValidation import java io File import java io IOException import java net HttpURLConnection import java net MalformedURLException import java net URL import java net URLConnection import org jenkinsci Symbol import org kohsuke stapler DataBoundConstructor import org kohsuke stapler QueryParameter public class ZipExtractionInstaller extends ToolInstaller private final String url private final String subdir DataBoundConstructor public ZipExtractionInstaller String label String url String subdir super label this url url this subdir Util fixEmptyAndTrim subdir public String getUrl return url public String getSubdir return subdir public FilePath performInstallation ToolInstallation tool Node node TaskListener log throws IOException InterruptedException FilePath dir preferredLocation tool node if dir installIfNecessaryFrom new URL url log Unpacking url to dir on node getDisplayName dir act new ChmodRecAPlusX if subdir null return dir else return dir child subdir Extension Symbol zip public static class DescriptorImpl extends ToolInstallerDescriptor ZipExtractionInstaller public String getDisplayName return Messages ZipExtractionInstaller DescriptorImpl displayName public FormValidation doCheckUrl QueryParameter String value try URLConnection conn ProxyConfiguration open new URL value conn connect if conn instanceof HttpURLConnection if HttpURLConnection conn getResponseCode HttpURLConnection HTTP OK return FormValidation error Messages ZipExtractionInstaller bad connection return FormValidation ok catch MalformedURLException x return FormValidation error Messages ZipExtractionInstaller malformed url catch IOException x return FormValidation error x Messages ZipExtractionInstaller could not connect static class ChmodRecAPlusX extends MasterToSlaveFileCallable Void private static final long serialVersionUID 1L public Void invoke File d VirtualChannel channel throws IOException if Functions isWindows process d return null private void process File f if f isFile f setExecutable true false else File kids f listFiles if kids null for File kid kids process kid